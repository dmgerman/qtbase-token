begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2012 Nokia Corporation and/or its subsidiary(-ies). ** All rights reserved. ** Contact: http://www.qt-project.org/ ** ** This file is part of the examples of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:BSD$ ** You may use this file under the terms of the BSD license as follows: ** ** "Redistribution and use in source and binary forms, with or without ** modification, are permitted provided that the following conditions are ** met: **   * Redistributions of source code must retain the above copyright **     notice, this list of conditions and the following disclaimer. **   * Redistributions in binary form must reproduce the above copyright **     notice, this list of conditions and the following disclaimer in **     the documentation and/or other materials provided with the **     distribution. **   * Neither the name of Nokia Corporation and its Subsidiary(-ies) nor **     the names of its contributors may be used to endorse or promote **     products derived from this software without specific prior written **     permission. ** ** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ** "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT ** LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR ** A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT ** OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, ** SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT ** LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, ** DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY ** THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT ** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE ** OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE." ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<stdlib.h>
end_include
begin_include
include|#
directive|include
file|<unistd.h>
end_include
begin_include
include|#
directive|include
file|<stdio.h>
end_include
begin_include
include|#
directive|include
file|<fcntl.h>
end_include
begin_include
include|#
directive|include
file|<linux/fb.h>
end_include
begin_include
include|#
directive|include
file|<linux/kd.h>
end_include
begin_include
include|#
directive|include
file|<sys/mman.h>
end_include
begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include
begin_include
include|#
directive|include
file|<sys/time.h>
end_include
begin_include
include|#
directive|include
file|<string.h>
end_include
begin_include
include|#
directive|include
file|<errno.h>
end_include
begin_decl_stmt
DECL|variable|vinfo
name|struct
name|fb_var_screeninfo
name|vinfo
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|finfo
name|struct
name|fb_fix_screeninfo
name|finfo
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|frameBuffer
name|char
modifier|*
name|frameBuffer
init|=
literal|0
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|fbFd
name|int
name|fbFd
init|=
literal|0
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|ttyFd
name|int
name|ttyFd
init|=
literal|0
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|printFixedInfo
name|void
name|printFixedInfo
parameter_list|()
block|{
name|printf
argument_list|(
literal|"Fixed screen info:\n"
literal|"\tid:          %s\n"
literal|"\tsmem_start:  0x%lx\n"
literal|"\tsmem_len:    %d\n"
literal|"\ttype:        %d\n"
literal|"\ttype_aux:    %d\n"
literal|"\tvisual:      %d\n"
literal|"\txpanstep:    %d\n"
literal|"\typanstep:    %d\n"
literal|"\tywrapstep:   %d\n"
literal|"\tline_length: %d\n"
literal|"\tmmio_start:  0x%lx\n"
literal|"\tmmio_len:    %d\n"
literal|"\taccel:       %d\n"
literal|"\n"
argument_list|,
name|finfo
operator|.
name|id
argument_list|,
name|finfo
operator|.
name|smem_start
argument_list|,
name|finfo
operator|.
name|smem_len
argument_list|,
name|finfo
operator|.
name|type
argument_list|,
name|finfo
operator|.
name|type_aux
argument_list|,
name|finfo
operator|.
name|visual
argument_list|,
name|finfo
operator|.
name|xpanstep
argument_list|,
name|finfo
operator|.
name|ypanstep
argument_list|,
name|finfo
operator|.
name|ywrapstep
argument_list|,
name|finfo
operator|.
name|line_length
argument_list|,
name|finfo
operator|.
name|mmio_start
argument_list|,
name|finfo
operator|.
name|mmio_len
argument_list|,
name|finfo
operator|.
name|accel
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|printVariableInfo
name|void
name|printVariableInfo
parameter_list|()
block|{
name|printf
argument_list|(
literal|"Variable screen info:\n"
literal|"\txres:           %d\n"
literal|"\tyres:           %d\n"
literal|"\txres_virtual:   %d\n"
literal|"\tyres_virtual:   %d\n"
literal|"\tyoffset:        %d\n"
literal|"\txoffset:        %d\n"
literal|"\tbits_per_pixel: %d\n"
literal|"\tgrayscale: %d\n"
literal|"\tred:    offset: %2d, length: %2d, msb_right: %2d\n"
literal|"\tgreen:  offset: %2d, length: %2d, msb_right: %2d\n"
literal|"\tblue:   offset: %2d, length: %2d, msb_right: %2d\n"
literal|"\ttransp: offset: %2d, length: %2d, msb_right: %2d\n"
literal|"\tnonstd:       %d\n"
literal|"\tactivate:     %d\n"
literal|"\theight:       %d\n"
literal|"\twidth:        %d\n"
literal|"\taccel_flags:  0x%x\n"
literal|"\tpixclock:     %d\n"
literal|"\tleft_margin:  %d\n"
literal|"\tright_margin: %d\n"
literal|"\tupper_margin: %d\n"
literal|"\tlower_margin: %d\n"
literal|"\thsync_len:    %d\n"
literal|"\tvsync_len:    %d\n"
literal|"\tsync:         %d\n"
literal|"\tvmode:        %d\n"
literal|"\n"
argument_list|,
name|vinfo
operator|.
name|xres
argument_list|,
name|vinfo
operator|.
name|yres
argument_list|,
name|vinfo
operator|.
name|xres_virtual
argument_list|,
name|vinfo
operator|.
name|yres_virtual
argument_list|,
name|vinfo
operator|.
name|xoffset
argument_list|,
name|vinfo
operator|.
name|yoffset
argument_list|,
name|vinfo
operator|.
name|bits_per_pixel
argument_list|,
name|vinfo
operator|.
name|grayscale
argument_list|,
name|vinfo
operator|.
name|red
operator|.
name|offset
argument_list|,
name|vinfo
operator|.
name|red
operator|.
name|length
argument_list|,
name|vinfo
operator|.
name|red
operator|.
name|msb_right
argument_list|,
name|vinfo
operator|.
name|green
operator|.
name|offset
argument_list|,
name|vinfo
operator|.
name|green
operator|.
name|length
argument_list|,
name|vinfo
operator|.
name|green
operator|.
name|msb_right
argument_list|,
name|vinfo
operator|.
name|blue
operator|.
name|offset
argument_list|,
name|vinfo
operator|.
name|blue
operator|.
name|length
argument_list|,
name|vinfo
operator|.
name|blue
operator|.
name|msb_right
argument_list|,
name|vinfo
operator|.
name|transp
operator|.
name|offset
argument_list|,
name|vinfo
operator|.
name|transp
operator|.
name|length
argument_list|,
name|vinfo
operator|.
name|transp
operator|.
name|msb_right
argument_list|,
name|vinfo
operator|.
name|nonstd
argument_list|,
name|vinfo
operator|.
name|activate
argument_list|,
name|vinfo
operator|.
name|height
argument_list|,
name|vinfo
operator|.
name|width
argument_list|,
name|vinfo
operator|.
name|accel_flags
argument_list|,
name|vinfo
operator|.
name|pixclock
argument_list|,
name|vinfo
operator|.
name|left_margin
argument_list|,
name|vinfo
operator|.
name|right_margin
argument_list|,
name|vinfo
operator|.
name|upper_margin
argument_list|,
name|vinfo
operator|.
name|lower_margin
argument_list|,
name|vinfo
operator|.
name|hsync_len
argument_list|,
name|vinfo
operator|.
name|vsync_len
argument_list|,
name|vinfo
operator|.
name|sync
argument_list|,
name|vinfo
operator|.
name|vmode
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|switchToGraphicsMode
name|long
name|switchToGraphicsMode
parameter_list|()
block|{
specifier|const
name|char
modifier|*
specifier|const
name|devs
index|[]
init|=
block|{
literal|"/dev/tty0"
block|,
literal|"/dev/tty"
block|,
literal|"/dev/console"
block|,
literal|0
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|dev
decl_stmt|;
name|long
name|oldMode
init|=
name|KD_TEXT
decl_stmt|;
for|for
control|(
name|dev
operator|=
name|devs
init|;
operator|*
name|dev
condition|;
operator|++
name|dev
control|)
block|{
name|ttyFd
operator|=
name|open
argument_list|(
operator|*
name|dev
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttyFd
operator|!=
operator|-
literal|1
condition|)
break|break;
name|printf
argument_list|(
literal|"Opening tty device %s failed: %s\n"
argument_list|,
operator|*
name|dev
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ioctl
argument_list|(
name|ttyFd
argument_list|,
name|KDGETMODE
argument_list|,
operator|&
name|oldMode
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldMode
operator|==
name|KD_GRAPHICS
condition|)
block|{
name|printf
argument_list|(
literal|"Was in graphics mode already. Skipping\n"
argument_list|)
expr_stmt|;
return|return
name|oldMode
return|;
block|}
name|int
name|ret
init|=
name|ioctl
argument_list|(
name|ttyFd
argument_list|,
name|KDSETMODE
argument_list|,
name|KD_GRAPHICS
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Switch to graphics mode failed: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|oldMode
return|;
block|}
name|printf
argument_list|(
literal|"Successfully switched to graphics mode.\n\n"
argument_list|)
expr_stmt|;
return|return
name|oldMode
return|;
block|}
end_function
begin_function
DECL|function|restoreTextMode
name|void
name|restoreTextMode
parameter_list|(
name|long
name|oldMode
parameter_list|)
block|{
if|if
condition|(
name|ttyFd
operator|==
operator|-
literal|1
condition|)
return|return;
name|ioctl
argument_list|(
name|ttyFd
argument_list|,
name|KDSETMODE
argument_list|,
name|oldMode
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ttyFd
argument_list|)
expr_stmt|;
block|}
end_function
begin_decl_stmt
DECL|variable|oldPalette
name|struct
name|fb_cmap
name|oldPalette
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|palette
name|struct
name|fb_cmap
name|palette
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|paletteSize
name|int
name|paletteSize
init|=
literal|0
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|initPalette_16
name|void
name|initPalette_16
parameter_list|()
block|{
if|if
condition|(
name|finfo
operator|.
name|type
operator|==
name|FB_TYPE_PACKED_PIXELS
condition|)
block|{
comment|// We'll setup a grayscale map for 4bpp linear
name|int
name|val
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
name|palette
operator|.
name|red
index|[
name|i
index|]
operator|=
operator|(
name|val
operator|<<
literal|8
operator|)
operator||
name|val
expr_stmt|;
name|palette
operator|.
name|green
index|[
name|i
index|]
operator|=
operator|(
name|val
operator|<<
literal|8
operator|)
operator||
name|val
expr_stmt|;
name|palette
operator|.
name|blue
index|[
name|i
index|]
operator|=
operator|(
name|val
operator|<<
literal|8
operator|)
operator||
name|val
expr_stmt|;
name|val
operator|+=
literal|17
expr_stmt|;
block|}
return|return;
block|}
comment|// Default 16 colour palette
name|unsigned
name|char
name|reds
index|[
literal|16
index|]
init|=
block|{
literal|0x00
block|,
literal|0x7F
block|,
literal|0xBF
block|,
literal|0xFF
block|,
literal|0xFF
block|,
literal|0xA2
block|,
literal|0x00
block|,
literal|0xFF
block|,
literal|0xFF
block|,
literal|0x00
block|,
literal|0x7F
block|,
literal|0x7F
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x82
block|}
decl_stmt|;
name|unsigned
name|char
name|greens
index|[
literal|16
index|]
init|=
block|{
literal|0x00
block|,
literal|0x7F
block|,
literal|0xBF
block|,
literal|0xFF
block|,
literal|0x00
block|,
literal|0xC5
block|,
literal|0x00
block|,
literal|0xFF
block|,
literal|0x00
block|,
literal|0xFF
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x7F
block|,
literal|0x7F
block|,
literal|0x7F
block|}
decl_stmt|;
name|unsigned
name|char
name|blues
index|[
literal|16
index|]
init|=
block|{
literal|0x00
block|,
literal|0x7F
block|,
literal|0xBF
block|,
literal|0xFF
block|,
literal|0x00
block|,
literal|0x11
block|,
literal|0xFF
block|,
literal|0x00
block|,
literal|0xFF
block|,
literal|0xFF
block|,
literal|0x00
block|,
literal|0x7F
block|,
literal|0x7F
block|,
literal|0x7F
block|,
literal|0x00
block|,
literal|0x00
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
name|palette
operator|.
name|red
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|reds
index|[
name|i
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
name|reds
index|[
name|i
index|]
expr_stmt|;
name|palette
operator|.
name|green
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|greens
index|[
name|i
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
name|greens
index|[
name|i
index|]
expr_stmt|;
name|palette
operator|.
name|blue
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|blues
index|[
name|i
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
name|blues
index|[
name|i
index|]
expr_stmt|;
name|palette
operator|.
name|transp
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|initPalette_256
name|void
name|initPalette_256
parameter_list|()
block|{
if|if
condition|(
name|vinfo
operator|.
name|grayscale
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
operator|++
name|i
control|)
block|{
name|unsigned
name|short
name|c
init|=
operator|(
name|i
operator|<<
literal|8
operator|)
operator||
name|i
decl_stmt|;
name|palette
operator|.
name|red
index|[
name|i
index|]
operator|=
name|c
expr_stmt|;
name|palette
operator|.
name|green
index|[
name|i
index|]
operator|=
name|c
expr_stmt|;
name|palette
operator|.
name|blue
index|[
name|i
index|]
operator|=
name|c
expr_stmt|;
name|palette
operator|.
name|transp
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
return|return;
block|}
comment|// 6x6x6 216 color cube
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|ir
decl_stmt|,
name|ig
decl_stmt|,
name|ib
decl_stmt|;
for|for
control|(
name|ir
operator|=
literal|0x0
init|;
name|ir
operator|<=
literal|0xff
condition|;
name|ir
operator|+=
literal|0x33
control|)
block|{
for|for
control|(
name|ig
operator|=
literal|0x0
init|;
name|ig
operator|<=
literal|0xff
condition|;
name|ig
operator|+=
literal|0x33
control|)
block|{
for|for
control|(
name|ib
operator|=
literal|0x0
init|;
name|ib
operator|<=
literal|0xff
condition|;
name|ib
operator|+=
literal|0x33
control|)
block|{
name|palette
operator|.
name|red
index|[
name|i
index|]
operator|=
operator|(
name|ir
operator|<<
literal|8
operator|)
operator||
name|ir
expr_stmt|;
name|palette
operator|.
name|green
index|[
name|i
index|]
operator|=
operator|(
name|ig
operator|<<
literal|8
operator|)
operator||
name|ig
expr_stmt|;
name|palette
operator|.
name|blue
index|[
name|i
index|]
operator|=
operator|(
name|ib
operator|<<
literal|8
operator|)
operator||
name|ib
expr_stmt|;
name|palette
operator|.
name|transp
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
operator|++
name|i
expr_stmt|;
block|}
block|}
block|}
block|}
end_function
begin_function
DECL|function|initPalette
name|void
name|initPalette
parameter_list|()
block|{
switch|switch
condition|(
name|vinfo
operator|.
name|bits_per_pixel
condition|)
block|{
case|case
literal|8
case|:
name|paletteSize
operator|=
literal|256
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|paletteSize
operator|=
literal|16
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
operator|!
name|paletteSize
condition|)
return|return;
comment|/* not using a palette */
comment|/* read old palette */
name|oldPalette
operator|.
name|start
operator|=
literal|0
expr_stmt|;
name|oldPalette
operator|.
name|len
operator|=
name|paletteSize
expr_stmt|;
name|oldPalette
operator|.
name|red
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|malloc
argument_list|(
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|*
name|paletteSize
argument_list|)
expr_stmt|;
name|oldPalette
operator|.
name|green
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|malloc
argument_list|(
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|*
name|paletteSize
argument_list|)
expr_stmt|;
name|oldPalette
operator|.
name|blue
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|malloc
argument_list|(
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|*
name|paletteSize
argument_list|)
expr_stmt|;
name|oldPalette
operator|.
name|transp
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|malloc
argument_list|(
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|*
name|paletteSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|ttyFd
argument_list|,
name|FBIOGETCMAP
argument_list|,
operator|&
name|oldPalette
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"initPalette: error reading palette"
argument_list|)
expr_stmt|;
comment|/* create new palette */
name|palette
operator|.
name|start
operator|=
literal|0
expr_stmt|;
name|palette
operator|.
name|len
operator|=
name|paletteSize
expr_stmt|;
name|palette
operator|.
name|red
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|malloc
argument_list|(
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|*
name|paletteSize
argument_list|)
expr_stmt|;
name|palette
operator|.
name|green
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|malloc
argument_list|(
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|*
name|paletteSize
argument_list|)
expr_stmt|;
name|palette
operator|.
name|blue
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|malloc
argument_list|(
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|*
name|paletteSize
argument_list|)
expr_stmt|;
name|palette
operator|.
name|transp
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|malloc
argument_list|(
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|*
name|paletteSize
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|paletteSize
condition|)
block|{
case|case
literal|16
case|:
name|initPalette_16
argument_list|()
expr_stmt|;
break|break;
case|case
literal|256
case|:
name|initPalette_256
argument_list|()
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* set new palette */
if|if
condition|(
name|ioctl
argument_list|(
name|ttyFd
argument_list|,
name|FBIOPUTCMAP
argument_list|,
operator|&
name|palette
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"initPalette: error setting palette"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|resetPalette
name|void
name|resetPalette
parameter_list|()
block|{
if|if
condition|(
name|paletteSize
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|ioctl
argument_list|(
name|ttyFd
argument_list|,
name|FBIOPUTCMAP
argument_list|,
operator|&
name|oldPalette
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"resetPalette"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|oldPalette
operator|.
name|red
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|oldPalette
operator|.
name|green
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|oldPalette
operator|.
name|blue
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|oldPalette
operator|.
name|transp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|palette
operator|.
name|red
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|palette
operator|.
name|green
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|palette
operator|.
name|blue
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|palette
operator|.
name|transp
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawRect_rgb32
name|void
name|drawRect_rgb32
parameter_list|(
name|int
name|x0
parameter_list|,
name|int
name|y0
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|color
parameter_list|)
block|{
specifier|const
name|int
name|bytesPerPixel
init|=
literal|4
decl_stmt|;
specifier|const
name|int
name|stride
init|=
name|finfo
operator|.
name|line_length
operator|/
name|bytesPerPixel
decl_stmt|;
name|int
modifier|*
name|dest
init|=
operator|(
name|int
operator|*
operator|)
operator|(
name|frameBuffer
operator|)
operator|+
operator|(
name|y0
operator|+
name|vinfo
operator|.
name|yoffset
operator|)
operator|*
name|stride
operator|+
operator|(
name|x0
operator|+
name|vinfo
operator|.
name|xoffset
operator|)
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
operator|++
name|x
control|)
block|{
name|dest
index|[
name|x
index|]
operator|=
name|color
expr_stmt|;
block|}
name|dest
operator|+=
name|stride
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|drawRect_rgb18
name|void
name|drawRect_rgb18
parameter_list|(
name|int
name|x0
parameter_list|,
name|int
name|y0
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|color
parameter_list|)
block|{
specifier|const
name|int
name|bytesPerPixel
init|=
literal|3
decl_stmt|;
specifier|const
name|int
name|stride
init|=
name|finfo
operator|.
name|line_length
operator|-
name|width
operator|*
name|bytesPerPixel
decl_stmt|;
specifier|const
name|int
name|red
init|=
operator|(
name|color
operator|&
literal|0xff0000
operator|)
operator|>>
literal|16
decl_stmt|;
specifier|const
name|int
name|green
init|=
operator|(
name|color
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
decl_stmt|;
specifier|const
name|int
name|blue
init|=
operator|(
name|color
operator|&
literal|0xff
operator|)
decl_stmt|;
specifier|const
name|unsigned
name|int
name|packed
init|=
operator|(
name|blue
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
name|green
operator|>>
literal|2
operator|)
operator|<<
literal|6
operator|)
operator||
operator|(
operator|(
name|red
operator|>>
literal|2
operator|)
operator|<<
literal|12
operator|)
decl_stmt|;
specifier|const
name|char
name|color18
index|[
literal|3
index|]
init|=
block|{
name|packed
operator|&
literal|0xff
block|,
operator|(
name|packed
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
block|,
operator|(
name|packed
operator|&
literal|0xff0000
operator|)
operator|>>
literal|16
block|}
decl_stmt|;
name|char
modifier|*
name|dest
init|=
operator|(
name|char
operator|*
operator|)
operator|(
name|frameBuffer
operator|)
operator|+
operator|(
name|y0
operator|+
name|vinfo
operator|.
name|yoffset
operator|)
operator|*
name|stride
operator|+
operator|(
name|x0
operator|+
name|vinfo
operator|.
name|xoffset
operator|)
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
operator|++
name|x
control|)
block|{
operator|*
name|dest
operator|++
operator|=
name|color18
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|dest
operator|++
operator|=
name|color18
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|dest
operator|++
operator|=
name|color18
index|[
literal|2
index|]
expr_stmt|;
block|}
name|dest
operator|+=
name|stride
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|drawRect_rgb16
name|void
name|drawRect_rgb16
parameter_list|(
name|int
name|x0
parameter_list|,
name|int
name|y0
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|color
parameter_list|)
block|{
specifier|const
name|int
name|bytesPerPixel
init|=
literal|2
decl_stmt|;
specifier|const
name|int
name|stride
init|=
name|finfo
operator|.
name|line_length
operator|/
name|bytesPerPixel
decl_stmt|;
specifier|const
name|int
name|red
init|=
operator|(
name|color
operator|&
literal|0xff0000
operator|)
operator|>>
operator|(
literal|16
operator|+
literal|3
operator|)
decl_stmt|;
specifier|const
name|int
name|green
init|=
operator|(
name|color
operator|&
literal|0xff00
operator|)
operator|>>
operator|(
literal|8
operator|+
literal|2
operator|)
decl_stmt|;
specifier|const
name|int
name|blue
init|=
operator|(
name|color
operator|&
literal|0xff
operator|)
operator|>>
literal|3
decl_stmt|;
specifier|const
name|short
name|color16
init|=
name|blue
operator||
operator|(
name|green
operator|<<
literal|5
operator|)
operator||
operator|(
name|red
operator|<<
operator|(
literal|5
operator|+
literal|6
operator|)
operator|)
decl_stmt|;
name|short
modifier|*
name|dest
init|=
operator|(
name|short
operator|*
operator|)
operator|(
name|frameBuffer
operator|)
operator|+
operator|(
name|y0
operator|+
name|vinfo
operator|.
name|yoffset
operator|)
operator|*
name|stride
operator|+
operator|(
name|x0
operator|+
name|vinfo
operator|.
name|xoffset
operator|)
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
operator|++
name|x
control|)
block|{
name|dest
index|[
name|x
index|]
operator|=
name|color16
expr_stmt|;
block|}
name|dest
operator|+=
name|stride
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|drawRect_rgb15
name|void
name|drawRect_rgb15
parameter_list|(
name|int
name|x0
parameter_list|,
name|int
name|y0
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|color
parameter_list|)
block|{
specifier|const
name|int
name|bytesPerPixel
init|=
literal|2
decl_stmt|;
specifier|const
name|int
name|stride
init|=
name|finfo
operator|.
name|line_length
operator|/
name|bytesPerPixel
decl_stmt|;
specifier|const
name|int
name|red
init|=
operator|(
name|color
operator|&
literal|0xff0000
operator|)
operator|>>
operator|(
literal|16
operator|+
literal|3
operator|)
decl_stmt|;
specifier|const
name|int
name|green
init|=
operator|(
name|color
operator|&
literal|0xff00
operator|)
operator|>>
operator|(
literal|8
operator|+
literal|3
operator|)
decl_stmt|;
specifier|const
name|int
name|blue
init|=
operator|(
name|color
operator|&
literal|0xff
operator|)
operator|>>
literal|3
decl_stmt|;
specifier|const
name|short
name|color15
init|=
name|blue
operator||
operator|(
name|green
operator|<<
literal|5
operator|)
operator||
operator|(
name|red
operator|<<
operator|(
literal|5
operator|+
literal|5
operator|)
operator|)
decl_stmt|;
name|short
modifier|*
name|dest
init|=
operator|(
name|short
operator|*
operator|)
operator|(
name|frameBuffer
operator|)
operator|+
operator|(
name|y0
operator|+
name|vinfo
operator|.
name|yoffset
operator|)
operator|*
name|stride
operator|+
operator|(
name|x0
operator|+
name|vinfo
operator|.
name|xoffset
operator|)
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
operator|++
name|x
control|)
block|{
name|dest
index|[
name|x
index|]
operator|=
name|color15
expr_stmt|;
block|}
name|dest
operator|+=
name|stride
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|drawRect_palette
name|void
name|drawRect_palette
parameter_list|(
name|int
name|x0
parameter_list|,
name|int
name|y0
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|color
parameter_list|)
block|{
specifier|const
name|int
name|bytesPerPixel
init|=
literal|1
decl_stmt|;
specifier|const
name|int
name|stride
init|=
name|finfo
operator|.
name|line_length
operator|/
name|bytesPerPixel
decl_stmt|;
specifier|const
name|unsigned
name|char
name|color8
init|=
name|color
decl_stmt|;
name|unsigned
name|char
modifier|*
name|dest
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|frameBuffer
operator|)
operator|+
operator|(
name|y0
operator|+
name|vinfo
operator|.
name|yoffset
operator|)
operator|*
name|stride
operator|+
operator|(
name|x0
operator|+
name|vinfo
operator|.
name|xoffset
operator|)
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
operator|++
name|x
control|)
block|{
name|dest
index|[
name|x
index|]
operator|=
name|color8
expr_stmt|;
block|}
name|dest
operator|+=
name|stride
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|drawRect
name|void
name|drawRect
parameter_list|(
name|int
name|x0
parameter_list|,
name|int
name|y0
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|color
parameter_list|)
block|{
switch|switch
condition|(
name|vinfo
operator|.
name|bits_per_pixel
condition|)
block|{
case|case
literal|32
case|:
name|drawRect_rgb32
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|color
argument_list|)
expr_stmt|;
break|break;
case|case
literal|18
case|:
name|drawRect_rgb18
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|color
argument_list|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
name|drawRect_rgb16
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|color
argument_list|)
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|drawRect_rgb15
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|color
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|drawRect_palette
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|color
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|drawRect_palette
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|color
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Warning: drawRect() not implemented for color depth %i\n"
argument_list|,
name|vinfo
operator|.
name|bits_per_pixel
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function
begin_define
DECL|macro|PERFORMANCE_RUN_COUNT
define|#
directive|define
name|PERFORMANCE_RUN_COUNT
value|5
end_define
begin_function
DECL|function|performSpeedTest
name|void
name|performSpeedTest
parameter_list|(
name|void
modifier|*
name|fb
parameter_list|,
name|int
name|fbSize
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|run
decl_stmt|;
name|struct
name|timeval
name|startTime
decl_stmt|,
name|endTime
decl_stmt|;
name|unsigned
name|long
name|long
name|results
index|[
name|PERFORMANCE_RUN_COUNT
index|]
decl_stmt|;
name|unsigned
name|long
name|long
name|average
decl_stmt|;
name|unsigned
name|int
modifier|*
name|testImage
decl_stmt|;
name|unsigned
name|int
name|randData
index|[
literal|17
index|]
init|=
block|{
literal|0x3A428472
block|,
literal|0x724B84D3
block|,
literal|0x26B898AB
block|,
literal|0x7D980E3C
block|,
literal|0x5345A084
block|,
literal|0x6779B66B
block|,
literal|0x791EE4B4
block|,
literal|0x6E8EE3CC
block|,
literal|0x63AF504A
block|,
literal|0x18A21B33
block|,
literal|0x0E26EB73
block|,
literal|0x022F708E
block|,
literal|0x1740F3B0
block|,
literal|0x7E2C699D
block|,
literal|0x0E8A570B
block|,
literal|0x5F2C22FB
block|,
literal|0x6A742130
block|}
decl_stmt|;
name|printf
argument_list|(
literal|"Frame Buffer Performance test...\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|run
operator|=
literal|0
init|;
name|run
operator|<
name|PERFORMANCE_RUN_COUNT
condition|;
operator|++
name|run
control|)
block|{
comment|/* Generate test image with random(ish) data: */
name|testImage
operator|=
operator|(
name|unsigned
name|int
operator|*
operator|)
name|malloc
argument_list|(
name|fbSize
argument_list|)
expr_stmt|;
name|j
operator|=
name|run
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
call|(
name|int
call|)
argument_list|(
name|fbSize
operator|/
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|testImage
index|[
name|i
index|]
operator|=
name|randData
index|[
name|j
index|]
expr_stmt|;
name|j
operator|++
expr_stmt|;
if|if
condition|(
name|j
operator|>=
literal|17
condition|)
name|j
operator|=
literal|0
expr_stmt|;
block|}
name|gettimeofday
argument_list|(
operator|&
name|startTime
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|fb
argument_list|,
name|testImage
argument_list|,
name|fbSize
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|endTime
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|long
name|secsDiff
init|=
name|endTime
operator|.
name|tv_sec
operator|-
name|startTime
operator|.
name|tv_sec
decl_stmt|;
name|results
index|[
name|run
index|]
operator|=
name|secsDiff
operator|*
literal|1000000
operator|+
operator|(
name|endTime
operator|.
name|tv_usec
operator|-
name|startTime
operator|.
name|tv_usec
operator|)
expr_stmt|;
name|free
argument_list|(
name|testImage
argument_list|)
expr_stmt|;
block|}
name|average
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PERFORMANCE_RUN_COUNT
condition|;
operator|++
name|i
control|)
name|average
operator|+=
name|results
index|[
name|i
index|]
expr_stmt|;
name|average
operator|=
name|average
operator|/
name|PERFORMANCE_RUN_COUNT
expr_stmt|;
name|printf
argument_list|(
literal|"        Average:   %llu usecs\n"
argument_list|,
name|average
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"        Bandwidth: %.03f MByte/Sec\n"
argument_list|,
operator|(
name|fbSize
operator|/
literal|1048576.0
operator|)
operator|/
operator|(
operator|(
name|double
operator|)
name|average
operator|/
literal|1000000.0
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"        Max. FPS:  %.03f fps\n\n"
argument_list|,
literal|1000000.0
operator|/
operator|(
name|double
operator|)
name|average
argument_list|)
expr_stmt|;
comment|/* Clear the framebuffer back to black again: */
name|memset
argument_list|(
name|fb
argument_list|,
literal|0
argument_list|,
name|fbSize
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|main
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|long
name|int
name|screensize
init|=
literal|0
decl_stmt|;
name|int
name|doGraphicsMode
init|=
literal|1
decl_stmt|;
name|long
name|oldKdMode
init|=
name|KD_TEXT
decl_stmt|;
specifier|const
name|char
modifier|*
name|devfile
init|=
literal|"/dev/fb0"
decl_stmt|;
name|int
name|nextArg
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|nextArg
operator|<
name|argc
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
literal|"nographicsmodeswitch"
argument_list|,
name|argv
index|[
name|nextArg
index|]
argument_list|,
name|strlen
argument_list|(
literal|"nographicsmodeswitch"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|++
name|nextArg
expr_stmt|;
name|doGraphicsMode
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nextArg
operator|<
name|argc
condition|)
name|devfile
operator|=
name|argv
index|[
name|nextArg
operator|++
index|]
expr_stmt|;
comment|/* Open the file for reading and writing */
name|fbFd
operator|=
name|open
argument_list|(
name|devfile
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fbFd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"Error: cannot open framebuffer device"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"The framebuffer device was opened successfully.\n\n"
argument_list|)
expr_stmt|;
comment|/* Get fixed screen information */
if|if
condition|(
name|ioctl
argument_list|(
name|fbFd
argument_list|,
name|FBIOGET_FSCREENINFO
argument_list|,
operator|&
name|finfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"Error reading fixed information"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|printFixedInfo
argument_list|()
expr_stmt|;
comment|/* Figure out the size of the screen in bytes */
name|screensize
operator|=
name|finfo
operator|.
name|smem_len
expr_stmt|;
comment|/* Map the device to memory */
name|frameBuffer
operator|=
operator|(
name|char
operator|*
operator|)
name|mmap
argument_list|(
literal|0
argument_list|,
name|screensize
argument_list|,
name|PROT_READ
operator||
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|fbFd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|frameBuffer
operator|==
name|MAP_FAILED
condition|)
block|{
name|perror
argument_list|(
literal|"Error: Failed to map framebuffer device to memory"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"The framebuffer device was mapped to memory successfully.\n"
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|doGraphicsMode
condition|)
name|oldKdMode
operator|=
name|switchToGraphicsMode
argument_list|()
expr_stmt|;
comment|/* Get variable screen information */
if|if
condition|(
name|ioctl
argument_list|(
name|fbFd
argument_list|,
name|FBIOGET_VSCREENINFO
argument_list|,
operator|&
name|vinfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"Error reading variable information"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
name|printVariableInfo
argument_list|()
expr_stmt|;
name|performSpeedTest
argument_list|(
name|frameBuffer
argument_list|,
name|screensize
argument_list|)
expr_stmt|;
name|initPalette
argument_list|()
expr_stmt|;
if|if
condition|(
name|paletteSize
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Will draw 3 rectangles on the screen,\n"
literal|"they should be colored red, green and blue (in that order).\n"
argument_list|)
expr_stmt|;
name|drawRect
argument_list|(
name|vinfo
operator|.
name|xres
operator|/
literal|8
argument_list|,
name|vinfo
operator|.
name|yres
operator|/
literal|8
argument_list|,
name|vinfo
operator|.
name|xres
operator|/
literal|4
argument_list|,
name|vinfo
operator|.
name|yres
operator|/
literal|4
argument_list|,
literal|0xffff0000
argument_list|)
expr_stmt|;
name|drawRect
argument_list|(
name|vinfo
operator|.
name|xres
operator|*
literal|3
operator|/
literal|8
argument_list|,
name|vinfo
operator|.
name|yres
operator|*
literal|3
operator|/
literal|8
argument_list|,
name|vinfo
operator|.
name|xres
operator|/
literal|4
argument_list|,
name|vinfo
operator|.
name|yres
operator|/
literal|4
argument_list|,
literal|0xff00ff00
argument_list|)
expr_stmt|;
name|drawRect
argument_list|(
name|vinfo
operator|.
name|xres
operator|*
literal|5
operator|/
literal|8
argument_list|,
name|vinfo
operator|.
name|yres
operator|*
literal|5
operator|/
literal|8
argument_list|,
name|vinfo
operator|.
name|xres
operator|/
literal|4
argument_list|,
name|vinfo
operator|.
name|yres
operator|/
literal|4
argument_list|,
literal|0xff0000ff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Will rectangles from the 16 first entries in the color palette"
literal|" on the screen\n"
argument_list|)
expr_stmt|;
name|int
name|y
decl_stmt|;
name|int
name|x
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
literal|4
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
literal|4
condition|;
operator|++
name|x
control|)
block|{
name|drawRect
argument_list|(
name|vinfo
operator|.
name|xres
operator|/
literal|4
operator|*
name|x
argument_list|,
name|vinfo
operator|.
name|yres
operator|/
literal|4
operator|*
name|y
argument_list|,
name|vinfo
operator|.
name|xres
operator|/
literal|4
argument_list|,
name|vinfo
operator|.
name|yres
operator|/
literal|4
argument_list|,
literal|4
operator|*
name|y
operator|+
name|x
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|resetPalette
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"  Done.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|doGraphicsMode
condition|)
name|restoreTextMode
argument_list|(
name|oldKdMode
argument_list|)
expr_stmt|;
name|munmap
argument_list|(
name|frameBuffer
argument_list|,
name|screensize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fbFd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function
end_unit
