begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2012 Digia Plc and/or its subsidiary(-ies). ** Contact: http://www.qt-project.org/legal ** ** This file is part of the qmake application of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** Commercial License Usage ** Licensees holding valid commercial Qt licenses may use this file in ** accordance with the commercial license agreement provided with the ** Software or, alternatively, in accordance with the terms contained in ** a written agreement between you and Digia.  For licensing terms and ** conditions see http://qt.digia.com/licensing.  For further information ** use the contact form at http://qt.digia.com/contact-us. ** ** GNU Lesser General Public License Usage ** Alternatively, this file may be used under the terms of the GNU Lesser ** General Public License version 2.1 as published by the Free Software ** Foundation and appearing in the file LICENSE.LGPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU Lesser General Public License version 2.1 requirements ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Digia gives you certain additional ** rights.  These rights are described in the Digia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU ** General Public License version 3.0 as published by the Free Software ** Foundation and appearing in the file LICENSE.GPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU General Public License version 3.0 requirements will be ** met: http://www.gnu.org/copyleft/gpl.html. ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"winmakefile.h"
end_include
begin_include
include|#
directive|include
file|"option.h"
end_include
begin_include
include|#
directive|include
file|"project.h"
end_include
begin_include
include|#
directive|include
file|"meta.h"
end_include
begin_include
include|#
directive|include
file|<qtextstream.h>
end_include
begin_include
include|#
directive|include
file|<qstring.h>
end_include
begin_include
include|#
directive|include
file|<qhash.h>
end_include
begin_include
include|#
directive|include
file|<qregexp.h>
end_include
begin_include
include|#
directive|include
file|<qstringlist.h>
end_include
begin_include
include|#
directive|include
file|<qdir.h>
end_include
begin_include
include|#
directive|include
file|<stdlib.h>
end_include
begin_macro
name|QT_BEGIN_NAMESPACE
end_macro
begin_constructor
DECL|function|Win32MakefileGenerator
name|Win32MakefileGenerator
operator|::
name|Win32MakefileGenerator
parameter_list|()
member_init_list|:
name|MakefileGenerator
argument_list|()
block|{ }
end_constructor
begin_function
name|int
DECL|function|findHighestVersion
name|Win32MakefileGenerator
operator|::
name|findHighestVersion
parameter_list|(
specifier|const
name|QString
modifier|&
name|d
parameter_list|,
specifier|const
name|QString
modifier|&
name|stem
parameter_list|,
specifier|const
name|QString
modifier|&
name|ext
parameter_list|)
block|{
name|QString
name|bd
init|=
name|Option
operator|::
name|fixPathToLocalOS
argument_list|(
name|d
argument_list|,
literal|true
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|exists
argument_list|(
name|bd
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|QMakeMetaInfo
name|libinfo
argument_list|(
name|project
argument_list|)
decl_stmt|;
name|bool
name|libInfoRead
init|=
name|libinfo
operator|.
name|readLib
argument_list|(
name|bd
operator|+
name|Option
operator|::
name|dir_sep
operator|+
name|stem
argument_list|)
decl_stmt|;
comment|// If the library, for which we're trying to find the highest version
comment|// number, is a static library
if|if
condition|(
name|libInfoRead
operator|&&
name|libinfo
operator|.
name|values
argument_list|(
literal|"QMAKE_PRL_CONFIG"
argument_list|)
operator|.
name|contains
argument_list|(
literal|"staticlib"
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
specifier|const
name|ProStringList
modifier|&
name|vover
init|=
name|project
operator|->
name|values
argument_list|(
name|ProKey
argument_list|(
literal|"QMAKE_"
operator|+
name|stem
operator|.
name|toUpper
argument_list|()
operator|+
literal|"_VERSION_OVERRIDE"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|vover
operator|.
name|isEmpty
argument_list|()
condition|)
return|return
name|vover
operator|.
name|first
argument_list|()
operator|.
name|toInt
argument_list|()
return|;
name|int
name|biggest
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"no_versionlink"
argument_list|)
condition|)
block|{
specifier|static
name|QHash
argument_list|<
name|QString
argument_list|,
name|QStringList
argument_list|>
name|dirEntryListCache
decl_stmt|;
name|QStringList
name|entries
init|=
name|dirEntryListCache
operator|.
name|value
argument_list|(
name|bd
argument_list|)
decl_stmt|;
if|if
condition|(
name|entries
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|QDir
name|dir
argument_list|(
name|bd
argument_list|)
decl_stmt|;
name|entries
operator|=
name|dir
operator|.
name|entryList
argument_list|()
expr_stmt|;
name|dirEntryListCache
operator|.
name|insert
argument_list|(
name|bd
argument_list|,
name|entries
argument_list|)
expr_stmt|;
block|}
name|QRegExp
name|regx
argument_list|(
name|QString
argument_list|(
literal|"((lib)?%1([0-9]*)).(%2|prl)$"
argument_list|)
operator|.
name|arg
argument_list|(
name|stem
argument_list|)
operator|.
name|arg
argument_list|(
name|ext
argument_list|)
argument_list|,
name|Qt
operator|::
name|CaseInsensitive
argument_list|)
decl_stmt|;
for|for
control|(
name|QStringList
operator|::
name|Iterator
name|it
init|=
name|entries
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|entries
operator|.
name|end
argument_list|()
condition|;
operator|++
name|it
control|)
block|{
if|if
condition|(
name|regx
operator|.
name|exactMatch
argument_list|(
operator|(
operator|*
name|it
operator|)
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|regx
operator|.
name|cap
argument_list|(
literal|3
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|bool
name|ok
init|=
literal|true
decl_stmt|;
name|int
name|num
init|=
name|regx
operator|.
name|cap
argument_list|(
literal|3
argument_list|)
operator|.
name|toInt
argument_list|(
operator|&
name|ok
argument_list|)
decl_stmt|;
name|biggest
operator|=
name|qMax
argument_list|(
name|biggest
argument_list|,
operator|(
operator|!
name|ok
condition|?
operator|-
literal|1
else|:
name|num
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|libInfoRead
operator|&&
operator|!
name|libinfo
operator|.
name|values
argument_list|(
literal|"QMAKE_PRL_CONFIG"
argument_list|)
operator|.
name|contains
argument_list|(
literal|"staticlib"
argument_list|)
operator|&&
operator|!
name|libinfo
operator|.
name|isEmpty
argument_list|(
literal|"QMAKE_PRL_VERSION"
argument_list|)
condition|)
name|biggest
operator|=
name|qMax
argument_list|(
name|biggest
argument_list|,
name|libinfo
operator|.
name|first
argument_list|(
literal|"QMAKE_PRL_VERSION"
argument_list|)
operator|.
name|toQString
argument_list|()
operator|.
name|replace
argument_list|(
literal|"."
argument_list|,
literal|""
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|biggest
return|;
block|}
end_function
begin_function
name|bool
DECL|function|findLibraries
name|Win32MakefileGenerator
operator|::
name|findLibraries
parameter_list|()
block|{
name|QList
argument_list|<
name|QMakeLocalFileName
argument_list|>
name|dirs
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|lflags
index|[]
init|=
block|{
literal|"QMAKE_LIBS"
block|,
literal|"QMAKE_LIBS_PRIVATE"
block|,
literal|0
block|}
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|lflags
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|ProStringList
modifier|&
name|l
init|=
name|project
operator|->
name|values
argument_list|(
name|lflags
index|[
name|i
index|]
argument_list|)
decl_stmt|;
for|for
control|(
name|ProStringList
operator|::
name|Iterator
name|it
init|=
name|l
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|l
operator|.
name|end
argument_list|()
condition|;
control|)
block|{
name|QChar
name|quote
decl_stmt|;
name|bool
name|modified_opt
init|=
literal|false
decl_stmt|,
name|remove
init|=
literal|false
decl_stmt|;
name|QString
name|opt
init|=
operator|(
operator|*
name|it
operator|)
operator|.
name|trimmed
argument_list|()
operator|.
name|toQString
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|opt
index|[
literal|0
index|]
operator|==
literal|'\''
operator|||
name|opt
index|[
literal|0
index|]
operator|==
literal|'"'
operator|)
operator|&&
name|opt
index|[
operator|(
name|int
operator|)
name|opt
operator|.
name|length
argument_list|()
operator|-
literal|1
index|]
operator|==
name|opt
index|[
literal|0
index|]
condition|)
block|{
name|quote
operator|=
name|opt
index|[
literal|0
index|]
expr_stmt|;
name|opt
operator|=
name|opt
operator|.
name|mid
argument_list|(
literal|1
argument_list|,
name|opt
operator|.
name|length
argument_list|()
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|.
name|startsWith
argument_list|(
literal|"/LIBPATH:"
argument_list|)
condition|)
block|{
name|dirs
operator|.
name|append
argument_list|(
name|QMakeLocalFileName
argument_list|(
name|opt
operator|.
name|mid
argument_list|(
literal|9
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opt
operator|.
name|startsWith
argument_list|(
literal|"-L"
argument_list|)
operator|||
name|opt
operator|.
name|startsWith
argument_list|(
literal|"/L"
argument_list|)
condition|)
block|{
name|QString
name|libpath
init|=
name|opt
operator|.
name|mid
argument_list|(
literal|2
argument_list|)
decl_stmt|;
name|QMakeLocalFileName
name|l
argument_list|(
name|libpath
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|dirs
operator|.
name|contains
argument_list|(
name|l
argument_list|)
condition|)
block|{
name|dirs
operator|.
name|append
argument_list|(
name|l
argument_list|)
expr_stmt|;
name|modified_opt
operator|=
literal|true
expr_stmt|;
if|if
condition|(
operator|!
name|quote
operator|.
name|isNull
argument_list|()
condition|)
block|{
name|libpath
operator|=
name|quote
operator|+
name|libpath
operator|+
name|quote
expr_stmt|;
name|quote
operator|=
name|QChar
argument_list|()
expr_stmt|;
block|}
operator|(
operator|*
name|it
operator|)
operator|=
literal|"/LIBPATH:"
operator|+
name|libpath
expr_stmt|;
block|}
else|else
block|{
name|remove
operator|=
literal|true
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|opt
operator|.
name|startsWith
argument_list|(
literal|"-l"
argument_list|)
operator|||
name|opt
operator|.
name|startsWith
argument_list|(
literal|"/l"
argument_list|)
condition|)
block|{
name|QString
name|lib
init|=
name|opt
operator|.
name|right
argument_list|(
name|opt
operator|.
name|length
argument_list|()
operator|-
literal|2
argument_list|)
decl_stmt|,
name|out
decl_stmt|;
if|if
condition|(
operator|!
name|lib
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ProString
name|suffix
init|=
name|project
operator|->
name|first
argument_list|(
name|ProKey
argument_list|(
literal|"QMAKE_"
operator|+
name|lib
operator|.
name|toUpper
argument_list|()
operator|+
literal|"_SUFFIX"
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|QList
argument_list|<
name|QMakeLocalFileName
argument_list|>
operator|::
name|Iterator
name|it
init|=
name|dirs
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|dirs
operator|.
name|end
argument_list|()
condition|;
operator|++
name|it
control|)
block|{
name|QString
name|extension
decl_stmt|;
name|int
name|ver
init|=
name|findHighestVersion
argument_list|(
operator|(
operator|*
name|it
operator|)
operator|.
name|local
argument_list|()
argument_list|,
name|lib
argument_list|)
decl_stmt|;
if|if
condition|(
name|ver
operator|>
literal|0
condition|)
name|extension
operator|+=
name|QString
operator|::
name|number
argument_list|(
name|ver
argument_list|)
expr_stmt|;
name|extension
operator|+=
name|suffix
expr_stmt|;
name|extension
operator|+=
literal|".lib"
expr_stmt|;
if|if
condition|(
name|QMakeMetaInfo
operator|::
name|libExists
argument_list|(
operator|(
operator|*
name|it
operator|)
operator|.
name|local
argument_list|()
operator|+
name|Option
operator|::
name|dir_sep
operator|+
name|lib
argument_list|)
operator|||
name|exists
argument_list|(
operator|(
operator|*
name|it
operator|)
operator|.
name|local
argument_list|()
operator|+
name|Option
operator|::
name|dir_sep
operator|+
name|lib
operator|+
name|extension
argument_list|)
condition|)
block|{
name|out
operator|=
operator|(
operator|*
name|it
operator|)
operator|.
name|real
argument_list|()
operator|+
name|Option
operator|::
name|dir_sep
operator|+
name|lib
operator|+
name|extension
expr_stmt|;
if|if
condition|(
name|out
operator|.
name|contains
argument_list|(
name|QLatin1Char
argument_list|(
literal|' '
argument_list|)
argument_list|)
condition|)
block|{
name|out
operator|.
name|prepend
argument_list|(
name|QLatin1Char
argument_list|(
literal|'\"'
argument_list|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|append
argument_list|(
name|QLatin1Char
argument_list|(
literal|'\"'
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
block|}
if|if
condition|(
name|out
operator|.
name|isEmpty
argument_list|()
condition|)
name|out
operator|=
name|lib
operator|+
literal|".lib"
expr_stmt|;
name|modified_opt
operator|=
literal|true
expr_stmt|;
operator|(
operator|*
name|it
operator|)
operator|=
name|out
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|exists
argument_list|(
name|Option
operator|::
name|fixPathToLocalOS
argument_list|(
name|opt
argument_list|)
argument_list|)
condition|)
block|{
name|QList
argument_list|<
name|QMakeLocalFileName
argument_list|>
name|lib_dirs
decl_stmt|;
name|QString
name|file
init|=
name|opt
decl_stmt|;
name|int
name|slsh
init|=
name|file
operator|.
name|lastIndexOf
argument_list|(
name|Option
operator|::
name|dir_sep
argument_list|)
decl_stmt|;
if|if
condition|(
name|slsh
operator|!=
operator|-
literal|1
condition|)
block|{
name|lib_dirs
operator|.
name|append
argument_list|(
name|QMakeLocalFileName
argument_list|(
name|file
operator|.
name|left
argument_list|(
name|slsh
operator|+
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|file
operator|=
name|file
operator|.
name|right
argument_list|(
name|file
operator|.
name|length
argument_list|()
operator|-
name|slsh
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lib_dirs
operator|=
name|dirs
expr_stmt|;
block|}
if|if
condition|(
name|file
operator|.
name|endsWith
argument_list|(
literal|".lib"
argument_list|)
condition|)
block|{
name|file
operator|=
name|file
operator|.
name|left
argument_list|(
name|file
operator|.
name|length
argument_list|()
operator|-
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|file
operator|.
name|at
argument_list|(
name|file
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
operator|.
name|isNumber
argument_list|()
condition|)
block|{
name|ProString
name|suffix
init|=
name|project
operator|->
name|first
argument_list|(
name|ProKey
argument_list|(
literal|"QMAKE_"
operator|+
name|file
operator|.
name|section
argument_list|(
name|Option
operator|::
name|dir_sep
argument_list|,
operator|-
literal|1
argument_list|)
operator|.
name|toUpper
argument_list|()
operator|+
literal|"_SUFFIX"
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|QList
argument_list|<
name|QMakeLocalFileName
argument_list|>
operator|::
name|Iterator
name|dep_it
init|=
name|lib_dirs
operator|.
name|begin
argument_list|()
init|;
name|dep_it
operator|!=
name|lib_dirs
operator|.
name|end
argument_list|()
condition|;
operator|++
name|dep_it
control|)
block|{
name|QString
name|lib_tmpl
argument_list|(
name|file
operator|+
literal|"%1"
operator|+
name|suffix
operator|+
literal|".lib"
argument_list|)
decl_stmt|;
name|int
name|ver
init|=
name|findHighestVersion
argument_list|(
operator|(
operator|*
name|dep_it
operator|)
operator|.
name|local
argument_list|()
argument_list|,
name|file
argument_list|)
decl_stmt|;
if|if
condition|(
name|ver
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ver
condition|)
name|lib_tmpl
operator|=
name|lib_tmpl
operator|.
name|arg
argument_list|(
name|ver
argument_list|)
expr_stmt|;
else|else
name|lib_tmpl
operator|=
name|lib_tmpl
operator|.
name|arg
argument_list|(
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|slsh
operator|!=
operator|-
literal|1
condition|)
block|{
name|QString
name|dir
init|=
operator|(
operator|*
name|dep_it
operator|)
operator|.
name|real
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|dir
operator|.
name|endsWith
argument_list|(
name|Option
operator|::
name|dir_sep
argument_list|)
condition|)
name|dir
operator|+=
name|Option
operator|::
name|dir_sep
expr_stmt|;
name|lib_tmpl
operator|.
name|prepend
argument_list|(
name|dir
argument_list|)
expr_stmt|;
block|}
name|modified_opt
operator|=
literal|true
expr_stmt|;
operator|(
operator|*
name|it
operator|)
operator|=
name|lib_tmpl
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
if|if
condition|(
name|remove
condition|)
block|{
name|it
operator|=
name|l
operator|.
name|erase
argument_list|(
name|it
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|quote
operator|.
name|isNull
argument_list|()
operator|&&
name|modified_opt
condition|)
operator|(
operator|*
name|it
operator|)
operator|=
name|quote
operator|+
operator|(
operator|*
name|it
operator|)
operator|+
name|quote
expr_stmt|;
operator|++
name|it
expr_stmt|;
block|}
block|}
block|}
return|return
literal|true
return|;
block|}
end_function
begin_function
name|void
DECL|function|processPrlFiles
name|Win32MakefileGenerator
operator|::
name|processPrlFiles
parameter_list|()
block|{
specifier|const
name|QString
name|libArg
init|=
name|project
operator|->
name|first
argument_list|(
literal|"QMAKE_L_FLAG"
argument_list|)
operator|.
name|toQString
argument_list|()
decl_stmt|;
name|QList
argument_list|<
name|QMakeLocalFileName
argument_list|>
name|libdirs
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|lflags
index|[]
init|=
block|{
literal|"QMAKE_LIBS"
block|,
literal|"QMAKE_LIBS_PRIVATE"
block|,
literal|0
block|}
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|lflags
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|ProStringList
modifier|&
name|l
init|=
name|project
operator|->
name|values
argument_list|(
name|lflags
index|[
name|i
index|]
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|lit
init|=
literal|0
init|;
name|lit
operator|<
name|l
operator|.
name|size
argument_list|()
condition|;
operator|++
name|lit
control|)
block|{
name|QString
name|opt
init|=
name|l
operator|.
name|at
argument_list|(
name|lit
argument_list|)
operator|.
name|trimmed
argument_list|()
operator|.
name|toQString
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|opt
index|[
literal|0
index|]
operator|==
literal|'\''
operator|||
name|opt
index|[
literal|0
index|]
operator|==
literal|'"'
operator|)
operator|&&
name|opt
index|[
operator|(
name|int
operator|)
name|opt
operator|.
name|length
argument_list|()
operator|-
literal|1
index|]
operator|==
name|opt
index|[
literal|0
index|]
condition|)
name|opt
operator|=
name|opt
operator|.
name|mid
argument_list|(
literal|1
argument_list|,
name|opt
operator|.
name|length
argument_list|()
operator|-
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|.
name|startsWith
argument_list|(
name|libArg
argument_list|)
condition|)
block|{
name|QMakeLocalFileName
name|l
argument_list|(
name|opt
operator|.
name|mid
argument_list|(
name|libArg
operator|.
name|length
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|libdirs
operator|.
name|contains
argument_list|(
name|l
argument_list|)
condition|)
name|libdirs
operator|.
name|append
argument_list|(
name|l
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|opt
operator|.
name|startsWith
argument_list|(
literal|"/"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|processPrlFile
argument_list|(
name|opt
argument_list|)
operator|&&
operator|(
name|QDir
operator|::
name|isRelativePath
argument_list|(
name|opt
argument_list|)
operator|||
name|opt
operator|.
name|startsWith
argument_list|(
literal|"-l"
argument_list|)
operator|)
condition|)
block|{
name|QString
name|tmp
decl_stmt|;
if|if
condition|(
name|opt
operator|.
name|startsWith
argument_list|(
literal|"-l"
argument_list|)
condition|)
name|tmp
operator|=
name|opt
operator|.
name|mid
argument_list|(
literal|2
argument_list|)
expr_stmt|;
else|else
name|tmp
operator|=
name|opt
expr_stmt|;
for|for
control|(
name|QList
argument_list|<
name|QMakeLocalFileName
argument_list|>
operator|::
name|Iterator
name|it
init|=
name|libdirs
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|libdirs
operator|.
name|end
argument_list|()
condition|;
operator|++
name|it
control|)
block|{
name|QString
name|prl
init|=
operator|(
operator|*
name|it
operator|)
operator|.
name|local
argument_list|()
operator|+
name|Option
operator|::
name|dir_sep
operator|+
name|tmp
decl_stmt|;
if|if
condition|(
name|processPrlFile
argument_list|(
name|prl
argument_list|)
condition|)
break|break;
block|}
block|}
block|}
name|ProStringList
modifier|&
name|prl_libs
init|=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CURRENT_PRL_LIBS"
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|prl
init|=
literal|0
init|;
name|prl
operator|<
name|prl_libs
operator|.
name|size
argument_list|()
condition|;
operator|++
name|prl
control|)
name|l
operator|.
name|insert
argument_list|(
name|lit
operator|+
name|prl
operator|+
literal|1
argument_list|,
name|prl_libs
operator|.
name|at
argument_list|(
name|prl
argument_list|)
argument_list|)
expr_stmt|;
name|prl_libs
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
comment|// Merge them into a logical order
if|if
condition|(
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"no_smart_library_merge"
argument_list|)
operator|&&
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"no_lflags_merge"
argument_list|)
condition|)
block|{
name|ProStringList
name|lflags
decl_stmt|;
for|for
control|(
name|int
name|lit
init|=
literal|0
init|;
name|lit
operator|<
name|l
operator|.
name|size
argument_list|()
condition|;
operator|++
name|lit
control|)
block|{
name|ProString
name|opt
init|=
name|l
operator|.
name|at
argument_list|(
name|lit
argument_list|)
operator|.
name|trimmed
argument_list|()
decl_stmt|;
if|if
condition|(
name|opt
operator|.
name|startsWith
argument_list|(
name|libArg
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|lflags
operator|.
name|contains
argument_list|(
name|opt
argument_list|)
condition|)
name|lflags
operator|.
name|append
argument_list|(
name|opt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Make sure we keep the dependency-order of libraries
name|lflags
operator|.
name|removeAll
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|lflags
operator|.
name|append
argument_list|(
name|opt
argument_list|)
expr_stmt|;
block|}
block|}
name|l
operator|=
name|lflags
expr_stmt|;
block|}
block|}
block|}
end_function
begin_function
DECL|function|processVars
name|void
name|Win32MakefileGenerator
operator|::
name|processVars
parameter_list|()
block|{
comment|//If the TARGET looks like a path split it into DESTDIR and the resulting TARGET
if|if
condition|(
operator|!
name|project
operator|->
name|isEmpty
argument_list|(
literal|"TARGET"
argument_list|)
condition|)
block|{
name|ProString
name|targ
init|=
name|project
operator|->
name|first
argument_list|(
literal|"TARGET"
argument_list|)
decl_stmt|;
name|int
name|slsh
init|=
name|qMax
argument_list|(
name|targ
operator|.
name|lastIndexOf
argument_list|(
literal|'/'
argument_list|)
argument_list|,
name|targ
operator|.
name|lastIndexOf
argument_list|(
name|Option
operator|::
name|dir_sep
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|slsh
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"DESTDIR"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"DESTDIR"
argument_list|)
operator|.
name|append
argument_list|(
literal|""
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|project
operator|->
name|first
argument_list|(
literal|"DESTDIR"
argument_list|)
operator|.
name|right
argument_list|(
literal|1
argument_list|)
operator|!=
name|Option
operator|::
name|dir_sep
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"DESTDIR"
argument_list|)
operator|=
name|ProStringList
argument_list|(
name|project
operator|->
name|first
argument_list|(
literal|"DESTDIR"
argument_list|)
operator|+
name|Option
operator|::
name|dir_sep
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"DESTDIR"
argument_list|)
operator|=
name|ProStringList
argument_list|(
name|project
operator|->
name|first
argument_list|(
literal|"DESTDIR"
argument_list|)
operator|+
name|targ
operator|.
name|left
argument_list|(
name|slsh
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"TARGET"
argument_list|)
operator|=
name|ProStringList
argument_list|(
name|targ
operator|.
name|mid
argument_list|(
name|slsh
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_ORIG_TARGET"
argument_list|)
operator|=
name|project
operator|->
name|values
argument_list|(
literal|"TARGET"
argument_list|)
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_PROJECT_NAME"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_PROJECT_NAME"
argument_list|)
operator|=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_ORIG_TARGET"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|project
operator|->
name|first
argument_list|(
literal|"TEMPLATE"
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"vc"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"MAKEFILE"
argument_list|)
operator|=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_PROJECT_NAME"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_INCDIR"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"INCLUDEPATH"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_INCDIR"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"VERSION"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|QStringList
name|l
init|=
name|project
operator|->
name|first
argument_list|(
literal|"VERSION"
argument_list|)
operator|.
name|toQString
argument_list|()
operator|.
name|split
argument_list|(
literal|'.'
argument_list|)
decl_stmt|;
if|if
condition|(
name|l
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"VER_MAJ"
argument_list|)
operator|.
name|append
argument_list|(
name|l
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|.
name|size
argument_list|()
operator|>
literal|1
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"VER_MIN"
argument_list|)
operator|.
name|append
argument_list|(
name|l
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
comment|// TARGET_VERSION_EXT will be used to add a version number onto the target name
if|if
condition|(
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"skip_target_version_ext"
argument_list|)
operator|&&
name|project
operator|->
name|values
argument_list|(
literal|"TARGET_VERSION_EXT"
argument_list|)
operator|.
name|isEmpty
argument_list|()
operator|&&
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"VER_MAJ"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"TARGET_VERSION_EXT"
argument_list|)
operator|.
name|append
argument_list|(
name|project
operator|->
name|values
argument_list|(
literal|"VER_MAJ"
argument_list|)
operator|.
name|first
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_COPY_FILE"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_COPY_FILE"
argument_list|)
operator|.
name|append
argument_list|(
literal|"$(COPY)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_COPY_DIR"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_COPY_DIR"
argument_list|)
operator|.
name|append
argument_list|(
literal|"xcopy /s /q /y /i"
argument_list|)
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_INSTALL_FILE"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_INSTALL_FILE"
argument_list|)
operator|.
name|append
argument_list|(
literal|"$(COPY_FILE)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_INSTALL_PROGRAM"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_INSTALL_PROGRAM"
argument_list|)
operator|.
name|append
argument_list|(
literal|"$(COPY_FILE)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_INSTALL_DIR"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_INSTALL_DIR"
argument_list|)
operator|.
name|append
argument_list|(
literal|"$(COPY_DIR)"
argument_list|)
expr_stmt|;
name|fixTargetExt
argument_list|()
expr_stmt|;
name|processRcFileVar
argument_list|()
expr_stmt|;
name|ProStringList
modifier|&
name|incDir
init|=
name|project
operator|->
name|values
argument_list|(
literal|"INCLUDEPATH"
argument_list|)
decl_stmt|;
for|for
control|(
name|ProStringList
operator|::
name|Iterator
name|incDir_it
init|=
name|incDir
operator|.
name|begin
argument_list|()
init|;
name|incDir_it
operator|!=
name|incDir
operator|.
name|end
argument_list|()
condition|;
operator|++
name|incDir_it
control|)
if|if
condition|(
operator|!
operator|(
operator|*
name|incDir_it
operator|)
operator|.
name|isEmpty
argument_list|()
condition|)
operator|(
operator|*
name|incDir_it
operator|)
operator|=
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
operator|(
operator|*
name|incDir_it
operator|)
operator|.
name|toQString
argument_list|()
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|ProString
name|libArg
init|=
name|project
operator|->
name|first
argument_list|(
literal|"QMAKE_L_FLAG"
argument_list|)
decl_stmt|;
name|ProStringList
name|libs
decl_stmt|;
name|ProStringList
modifier|&
name|libDir
init|=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_LIBDIR"
argument_list|)
decl_stmt|;
for|for
control|(
name|ProStringList
operator|::
name|Iterator
name|libDir_it
init|=
name|libDir
operator|.
name|begin
argument_list|()
init|;
name|libDir_it
operator|!=
name|libDir
operator|.
name|end
argument_list|()
condition|;
operator|++
name|libDir_it
control|)
block|{
name|QString
name|lib
init|=
operator|(
operator|*
name|libDir_it
operator|)
operator|.
name|toQString
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|lib
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|lib
operator|.
name|remove
argument_list|(
literal|'"'
argument_list|)
expr_stmt|;
if|if
condition|(
name|lib
operator|.
name|endsWith
argument_list|(
literal|'\\'
argument_list|)
condition|)
name|lib
operator|.
name|chop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|libs
operator|<<
name|libArg
operator|+
name|escapeFilePath
argument_list|(
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
name|lib
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_LIBS"
argument_list|)
operator|+=
name|libs
operator|+
name|escapeFilePaths
argument_list|(
name|project
operator|->
name|values
argument_list|(
literal|"LIBS"
argument_list|)
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_LIBS_PRIVATE"
argument_list|)
operator|+=
name|escapeFilePaths
argument_list|(
name|project
operator|->
name|values
argument_list|(
literal|"LIBS_PRIVATE"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|values
argument_list|(
literal|"TEMPLATE"
argument_list|)
operator|.
name|contains
argument_list|(
literal|"app"
argument_list|)
condition|)
block|{
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CFLAGS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CFLAGS_APP"
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CXXFLAGS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CXXFLAGS_APP"
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_LFLAGS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_LFLAGS_APP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|project
operator|->
name|values
argument_list|(
literal|"TEMPLATE"
argument_list|)
operator|.
name|contains
argument_list|(
literal|"lib"
argument_list|)
operator|&&
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"dll"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"plugin"
argument_list|)
operator|||
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"plugin_no_share_shlib_cflags"
argument_list|)
condition|)
block|{
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CFLAGS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CFLAGS_SHLIB"
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CXXFLAGS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CXXFLAGS_SHLIB"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"plugin"
argument_list|)
condition|)
block|{
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CFLAGS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CFLAGS_PLUGIN"
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CXXFLAGS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_CXXFLAGS_PLUGIN"
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_LFLAGS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_LFLAGS_PLUGIN"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_LFLAGS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_LFLAGS_SHLIB"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function
begin_function
DECL|function|fixTargetExt
name|void
name|Win32MakefileGenerator
operator|::
name|fixTargetExt
parameter_list|()
block|{
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_EXTENSION_STATICLIB"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_EXTENSION_STATICLIB"
argument_list|)
operator|.
name|append
argument_list|(
literal|"lib"
argument_list|)
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_EXTENSION_SHLIB"
argument_list|)
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_EXTENSION_SHLIB"
argument_list|)
operator|.
name|append
argument_list|(
literal|"dll"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_APP_FLAG"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|project
operator|->
name|values
argument_list|(
literal|"TARGET_EXT"
argument_list|)
operator|.
name|append
argument_list|(
literal|".exe"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"shared"
argument_list|)
condition|)
block|{
name|project
operator|->
name|values
argument_list|(
literal|"TARGET_EXT"
argument_list|)
operator|.
name|append
argument_list|(
name|project
operator|->
name|first
argument_list|(
literal|"TARGET_VERSION_EXT"
argument_list|)
operator|+
literal|"."
operator|+
name|project
operator|->
name|first
argument_list|(
literal|"QMAKE_EXTENSION_SHLIB"
argument_list|)
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"TARGET"
argument_list|)
operator|.
name|first
argument_list|()
operator|=
name|project
operator|->
name|first
argument_list|(
literal|"QMAKE_PREFIX_SHLIB"
argument_list|)
operator|+
name|project
operator|->
name|first
argument_list|(
literal|"TARGET"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|project
operator|->
name|values
argument_list|(
literal|"TARGET_EXT"
argument_list|)
operator|.
name|append
argument_list|(
literal|"."
operator|+
name|project
operator|->
name|first
argument_list|(
literal|"QMAKE_EXTENSION_STATICLIB"
argument_list|)
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"TARGET"
argument_list|)
operator|.
name|first
argument_list|()
operator|=
name|project
operator|->
name|first
argument_list|(
literal|"QMAKE_PREFIX_STATICLIB"
argument_list|)
operator|+
name|project
operator|->
name|first
argument_list|(
literal|"TARGET"
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|processRcFileVar
name|void
name|Win32MakefileGenerator
operator|::
name|processRcFileVar
parameter_list|()
block|{
if|if
condition|(
name|Option
operator|::
name|qmake_mode
operator|==
name|Option
operator|::
name|QMAKE_GENERATE_NOTHING
condition|)
return|return;
if|if
condition|(
operator|(
operator|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"VERSION"
argument_list|)
operator|.
name|isEmpty
argument_list|()
operator|)
operator|&&
name|project
operator|->
name|values
argument_list|(
literal|"RC_FILE"
argument_list|)
operator|.
name|isEmpty
argument_list|()
operator|&&
name|project
operator|->
name|values
argument_list|(
literal|"RES_FILE"
argument_list|)
operator|.
name|isEmpty
argument_list|()
operator|&&
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"no_generated_target_info"
argument_list|)
operator|&&
operator|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"shared"
argument_list|)
operator|||
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_APP_FLAG"
argument_list|)
operator|.
name|isEmpty
argument_list|()
operator|)
operator|)
operator|||
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_WRITE_DEFAULT_RC"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|QByteArray
name|rcString
decl_stmt|;
name|QTextStream
name|ts
argument_list|(
operator|&
name|rcString
argument_list|,
name|QFile
operator|::
name|WriteOnly
argument_list|)
decl_stmt|;
name|QStringList
name|vers
init|=
name|project
operator|->
name|first
argument_list|(
literal|"VERSION"
argument_list|)
operator|.
name|toQString
argument_list|()
operator|.
name|split
argument_list|(
literal|"."
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
name|vers
operator|.
name|size
argument_list|()
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|vers
operator|+=
literal|"0"
expr_stmt|;
name|QString
name|versionString
init|=
name|vers
operator|.
name|join
argument_list|(
literal|'.'
argument_list|)
decl_stmt|;
name|QString
name|companyName
decl_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_TARGET_COMPANY"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
name|companyName
operator|=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_TARGET_COMPANY"
argument_list|)
operator|.
name|join
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|QString
name|description
decl_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_TARGET_DESCRIPTION"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
name|description
operator|=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_TARGET_DESCRIPTION"
argument_list|)
operator|.
name|join
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|QString
name|copyright
decl_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_TARGET_COPYRIGHT"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
name|copyright
operator|=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_TARGET_COPYRIGHT"
argument_list|)
operator|.
name|join
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|QString
name|productName
decl_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_TARGET_PRODUCT"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
name|productName
operator|=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_TARGET_PRODUCT"
argument_list|)
operator|.
name|join
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
else|else
name|productName
operator|=
name|project
operator|->
name|first
argument_list|(
literal|"TARGET"
argument_list|)
operator|.
name|toQString
argument_list|()
expr_stmt|;
name|QString
name|originalName
init|=
name|project
operator|->
name|values
argument_list|(
literal|"TARGET"
argument_list|)
operator|.
name|first
argument_list|()
operator|+
name|project
operator|->
name|values
argument_list|(
literal|"TARGET_EXT"
argument_list|)
operator|.
name|first
argument_list|()
decl_stmt|;
name|int
name|rcLang
init|=
name|project
operator|->
name|intValue
argument_list|(
literal|"RC_LANG"
argument_list|,
literal|1033
argument_list|)
decl_stmt|;
comment|// default: English(USA)
name|int
name|rcCodePage
init|=
name|project
operator|->
name|intValue
argument_list|(
literal|"RC_CODEPAGE"
argument_list|,
literal|1200
argument_list|)
decl_stmt|;
comment|// default: Unicode
name|ts
operator|<<
literal|"# if defined(UNDER_CE)"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"#  include<winbase.h>"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"# else"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"#  include<winver.h>"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"# endif"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"VS_VERSION_INFO VERSIONINFO"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\tFILEVERSION "
operator|<<
name|QString
argument_list|(
name|versionString
argument_list|)
operator|.
name|replace
argument_list|(
literal|"."
argument_list|,
literal|","
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\tPRODUCTVERSION "
operator|<<
name|QString
argument_list|(
name|versionString
argument_list|)
operator|.
name|replace
argument_list|(
literal|"."
argument_list|,
literal|","
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\tFILEFLAGSMASK 0x3fL"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"#ifdef _DEBUG"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\tFILEFLAGS VS_FF_DEBUG"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"#else"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\tFILEFLAGS 0x0L"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"#endif"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\tFILEOS VOS__WINDOWS32"
operator|<<
name|endl
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"shared"
argument_list|)
condition|)
name|ts
operator|<<
literal|"\tFILETYPE VFT_DLL"
operator|<<
name|endl
expr_stmt|;
else|else
name|ts
operator|<<
literal|"\tFILETYPE VFT_APP"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\tFILESUBTYPE 0x0L"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\tBEGIN"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\tBLOCK \"StringFileInfo\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\tBEGIN"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\tBLOCK \""
operator|<<
name|QString
argument_list|(
literal|"%1%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|rcLang
argument_list|,
literal|4
argument_list|,
literal|16
argument_list|,
name|QLatin1Char
argument_list|(
literal|'0'
argument_list|)
argument_list|)
operator|.
name|arg
argument_list|(
name|rcCodePage
argument_list|,
literal|4
argument_list|,
literal|16
argument_list|,
name|QLatin1Char
argument_list|(
literal|'0'
argument_list|)
argument_list|)
operator|<<
literal|"\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\tBEGIN"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\t\tVALUE \"CompanyName\", \""
operator|<<
name|companyName
operator|<<
literal|"\\0\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\t\tVALUE \"FileDescription\", \""
operator|<<
name|description
operator|<<
literal|"\\0\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\t\tVALUE \"FileVersion\", \""
operator|<<
name|versionString
operator|<<
literal|"\\0\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\t\tVALUE \"LegalCopyright\", \""
operator|<<
name|copyright
operator|<<
literal|"\\0\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\t\tVALUE \"OriginalFilename\", \""
operator|<<
name|originalName
operator|<<
literal|"\\0\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\t\tVALUE \"ProductName\", \""
operator|<<
name|productName
operator|<<
literal|"\\0\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\t\tVALUE \"ProductVersion\", \""
operator|<<
name|versionString
operator|<<
literal|"\\0\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\tEND"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\tEND"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\tBLOCK \"VarFileInfo\""
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\tBEGIN"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\t\tVALUE \"Translation\", "
operator|<<
name|QString
argument_list|(
literal|"0x%1"
argument_list|)
operator|.
name|arg
argument_list|(
name|rcLang
argument_list|,
literal|4
argument_list|,
literal|16
argument_list|,
name|QLatin1Char
argument_list|(
literal|'0'
argument_list|)
argument_list|)
operator|<<
literal|", "
operator|<<
name|QString
argument_list|(
literal|"%1"
argument_list|)
operator|.
name|arg
argument_list|(
name|rcCodePage
argument_list|,
literal|4
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\t\tEND"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"\tEND"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
literal|"/* End of Version info */"
operator|<<
name|endl
expr_stmt|;
name|ts
operator|<<
name|endl
expr_stmt|;
name|ts
operator|.
name|flush
argument_list|()
expr_stmt|;
name|QString
name|rcFilename
init|=
name|project
operator|->
name|values
argument_list|(
literal|"OUT_PWD"
argument_list|)
operator|.
name|first
argument_list|()
operator|+
literal|"/"
operator|+
name|project
operator|->
name|values
argument_list|(
literal|"TARGET"
argument_list|)
operator|.
name|first
argument_list|()
operator|+
literal|"_resource"
operator|+
literal|".rc"
decl_stmt|;
name|QFile
name|rcFile
argument_list|(
name|QDir
operator|::
name|cleanPath
argument_list|(
name|rcFilename
argument_list|)
argument_list|)
decl_stmt|;
name|bool
name|writeRcFile
init|=
literal|true
decl_stmt|;
if|if
condition|(
name|rcFile
operator|.
name|exists
argument_list|()
operator|&&
name|rcFile
operator|.
name|open
argument_list|(
name|QFile
operator|::
name|ReadOnly
argument_list|)
condition|)
block|{
name|writeRcFile
operator|=
name|rcFile
operator|.
name|readAll
argument_list|()
operator|!=
name|rcString
expr_stmt|;
name|rcFile
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|writeRcFile
condition|)
block|{
name|bool
name|ok
decl_stmt|;
name|ok
operator|=
name|rcFile
operator|.
name|open
argument_list|(
name|QFile
operator|::
name|WriteOnly
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ok
condition|)
block|{
comment|// The file can't be opened... try creating the containing
comment|// directory first (needed for clean shadow builds)
name|QDir
argument_list|()
operator|.
name|mkpath
argument_list|(
name|QFileInfo
argument_list|(
name|rcFile
argument_list|)
operator|.
name|path
argument_list|()
argument_list|)
expr_stmt|;
name|ok
operator|=
name|rcFile
operator|.
name|open
argument_list|(
name|QFile
operator|::
name|WriteOnly
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ok
condition|)
block|{
operator|::
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open for writing: %s"
argument_list|,
name|rcFile
operator|.
name|fileName
argument_list|()
operator|.
name|toLatin1
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|)
expr_stmt|;
operator|::
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|rcFile
operator|.
name|write
argument_list|(
name|rcString
argument_list|)
expr_stmt|;
name|rcFile
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_WRITE_DEFAULT_RC"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
name|project
operator|->
name|values
argument_list|(
literal|"RC_FILE"
argument_list|)
operator|.
name|insert
argument_list|(
literal|0
argument_list|,
name|rcFile
operator|.
name|fileName
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"RC_FILE"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"RES_FILE"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Both rc and res file specified.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Please specify one of them, not both."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|QString
name|resFile
init|=
name|project
operator|->
name|first
argument_list|(
literal|"RC_FILE"
argument_list|)
operator|.
name|toQString
argument_list|()
decl_stmt|;
comment|// if this is a shadow build then use the absolute path of the rc file
if|if
condition|(
name|Option
operator|::
name|output_dir
operator|!=
name|qmake_getpwd
argument_list|()
condition|)
block|{
name|QFileInfo
name|fi
argument_list|(
name|resFile
argument_list|)
decl_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"RC_FILE"
argument_list|)
operator|.
name|first
argument_list|()
operator|=
name|fi
operator|.
name|absoluteFilePath
argument_list|()
expr_stmt|;
block|}
name|resFile
operator|.
name|replace
argument_list|(
literal|".rc"
argument_list|,
name|Option
operator|::
name|res_ext
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"RES_FILE"
argument_list|)
operator|.
name|prepend
argument_list|(
name|fileInfo
argument_list|(
name|resFile
argument_list|)
operator|.
name|fileName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"OBJECTS_DIR"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|QString
name|resDestDir
decl_stmt|;
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"staticlib"
argument_list|)
condition|)
name|resDestDir
operator|=
name|fileInfo
argument_list|(
name|project
operator|->
name|first
argument_list|(
literal|"DESTDIR"
argument_list|)
operator|.
name|toQString
argument_list|()
argument_list|)
operator|.
name|absoluteFilePath
argument_list|()
expr_stmt|;
else|else
name|resDestDir
operator|=
name|project
operator|->
name|first
argument_list|(
literal|"OBJECTS_DIR"
argument_list|)
operator|.
name|toQString
argument_list|()
expr_stmt|;
name|resDestDir
operator|.
name|append
argument_list|(
name|Option
operator|::
name|dir_sep
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"RES_FILE"
argument_list|)
operator|.
name|first
argument_list|()
operator|.
name|prepend
argument_list|(
name|resDestDir
argument_list|)
expr_stmt|;
block|}
name|project
operator|->
name|values
argument_list|(
literal|"RES_FILE"
argument_list|)
operator|.
name|first
argument_list|()
operator|=
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
name|project
operator|->
name|values
argument_list|(
literal|"RES_FILE"
argument_list|)
operator|.
name|first
argument_list|()
operator|.
name|toQString
argument_list|()
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"POST_TARGETDEPS"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"RES_FILE"
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"CLEAN_FILES"
argument_list|)
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"RES_FILE"
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|writeCleanParts
name|void
name|Win32MakefileGenerator
operator|::
name|writeCleanParts
parameter_list|(
name|QTextStream
modifier|&
name|t
parameter_list|)
block|{
name|t
operator|<<
literal|"clean: compiler_clean "
operator|<<
name|var
argument_list|(
literal|"CLEAN_DEPS"
argument_list|)
expr_stmt|;
block|{
specifier|const
name|char
modifier|*
name|clean_targets
index|[]
init|=
block|{
literal|"OBJECTS"
block|,
literal|"QMAKE_CLEAN"
block|,
literal|"CLEAN_FILES"
block|,
literal|0
block|}
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|clean_targets
index|[
name|i
index|]
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|ProStringList
modifier|&
name|list
init|=
name|project
operator|->
name|values
argument_list|(
name|clean_targets
index|[
name|i
index|]
argument_list|)
decl_stmt|;
specifier|const
name|QString
name|del_statement
argument_list|(
literal|"-$(DEL_FILE)"
argument_list|)
decl_stmt|;
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"no_delete_multiple_files"
argument_list|)
condition|)
block|{
for|for
control|(
name|ProStringList
operator|::
name|ConstIterator
name|it
init|=
name|list
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|list
operator|.
name|end
argument_list|()
condition|;
operator|++
name|it
control|)
name|t
operator|<<
literal|"\n\t"
operator|<<
name|del_statement
operator|<<
literal|" "
operator|<<
name|escapeFilePath
argument_list|(
operator|(
operator|*
name|it
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QString
name|files
decl_stmt|,
name|file
decl_stmt|;
specifier|const
name|int
name|commandlineLimit
init|=
literal|2047
decl_stmt|;
comment|// NT limit, expanded
for|for
control|(
name|ProStringList
operator|::
name|ConstIterator
name|it
init|=
name|list
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|list
operator|.
name|end
argument_list|()
condition|;
operator|++
name|it
control|)
block|{
name|file
operator|=
literal|" "
operator|+
name|escapeFilePath
argument_list|(
operator|(
operator|*
name|it
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|del_statement
operator|.
name|length
argument_list|()
operator|+
name|files
operator|.
name|length
argument_list|()
operator|+
name|qMax
argument_list|(
name|fixEnvVariables
argument_list|(
name|file
argument_list|)
operator|.
name|length
argument_list|()
argument_list|,
name|file
operator|.
name|length
argument_list|()
argument_list|)
operator|>
name|commandlineLimit
condition|)
block|{
name|t
operator|<<
literal|"\n\t"
operator|<<
name|del_statement
operator|<<
name|files
expr_stmt|;
name|files
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
name|files
operator|+=
name|file
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|files
operator|.
name|isEmpty
argument_list|()
condition|)
name|t
operator|<<
literal|"\n\t"
operator|<<
name|del_statement
operator|<<
name|files
expr_stmt|;
block|}
block|}
block|}
name|t
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"distclean: clean"
expr_stmt|;
block|{
specifier|const
name|char
modifier|*
name|clean_targets
index|[]
init|=
block|{
literal|"QMAKE_DISTCLEAN"
block|,
literal|0
block|}
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|clean_targets
index|[
name|i
index|]
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|ProStringList
modifier|&
name|list
init|=
name|project
operator|->
name|values
argument_list|(
name|clean_targets
index|[
name|i
index|]
argument_list|)
decl_stmt|;
specifier|const
name|QString
name|del_statement
argument_list|(
literal|"-$(DEL_FILE)"
argument_list|)
decl_stmt|;
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"no_delete_multiple_files"
argument_list|)
condition|)
block|{
for|for
control|(
name|ProStringList
operator|::
name|ConstIterator
name|it
init|=
name|list
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|list
operator|.
name|end
argument_list|()
condition|;
operator|++
name|it
control|)
name|t
operator|<<
literal|"\n\t"
operator|<<
name|del_statement
operator|<<
literal|" "
operator|<<
name|escapeFilePath
argument_list|(
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
operator|(
operator|*
name|it
operator|)
operator|.
name|toQString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QString
name|files
decl_stmt|,
name|file
decl_stmt|;
specifier|const
name|int
name|commandlineLimit
init|=
literal|2047
decl_stmt|;
comment|// NT limit, expanded
for|for
control|(
name|ProStringList
operator|::
name|ConstIterator
name|it
init|=
name|list
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|list
operator|.
name|end
argument_list|()
condition|;
operator|++
name|it
control|)
block|{
name|file
operator|=
literal|" "
operator|+
name|escapeFilePath
argument_list|(
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
operator|(
operator|*
name|it
operator|)
operator|.
name|toQString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|del_statement
operator|.
name|length
argument_list|()
operator|+
name|files
operator|.
name|length
argument_list|()
operator|+
name|qMax
argument_list|(
name|fixEnvVariables
argument_list|(
name|file
argument_list|)
operator|.
name|length
argument_list|()
argument_list|,
name|file
operator|.
name|length
argument_list|()
argument_list|)
operator|>
name|commandlineLimit
condition|)
block|{
name|t
operator|<<
literal|"\n\t"
operator|<<
name|del_statement
operator|<<
name|files
expr_stmt|;
name|files
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
name|files
operator|+=
name|file
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|files
operator|.
name|isEmpty
argument_list|()
condition|)
name|t
operator|<<
literal|"\n\t"
operator|<<
name|del_statement
operator|<<
name|files
expr_stmt|;
block|}
block|}
block|}
name|t
operator|<<
literal|"\n\t-$(DEL_FILE) $(DESTDIR_TARGET)"
operator|<<
name|endl
expr_stmt|;
block|{
name|QString
name|ofile
init|=
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
name|fileFixify
argument_list|(
name|Option
operator|::
name|output
operator|.
name|fileName
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ofile
operator|.
name|isEmpty
argument_list|()
condition|)
name|t
operator|<<
literal|"\t-$(DEL_FILE) "
operator|<<
name|ofile
operator|<<
name|endl
expr_stmt|;
block|}
name|t
operator|<<
name|endl
expr_stmt|;
block|}
end_function
begin_function
DECL|function|writeIncPart
name|void
name|Win32MakefileGenerator
operator|::
name|writeIncPart
parameter_list|(
name|QTextStream
modifier|&
name|t
parameter_list|)
block|{
name|t
operator|<<
literal|"INCPATH       = "
expr_stmt|;
specifier|const
name|ProStringList
modifier|&
name|incs
init|=
name|project
operator|->
name|values
argument_list|(
literal|"INCLUDEPATH"
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|incs
operator|.
name|size
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
name|QString
name|inc
init|=
name|incs
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|toQString
argument_list|()
decl_stmt|;
name|inc
operator|.
name|replace
argument_list|(
name|QRegExp
argument_list|(
literal|"\\\\$"
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|inc
operator|.
name|replace
argument_list|(
name|QRegExp
argument_list|(
literal|"\""
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|inc
operator|.
name|isEmpty
argument_list|()
condition|)
name|t
operator|<<
literal|"-I"
operator|<<
literal|"\""
operator|<<
name|inc
operator|<<
literal|"\" "
expr_stmt|;
block|}
name|t
operator|<<
literal|"-I\""
operator|<<
name|specdir
argument_list|()
operator|<<
literal|"\""
operator|<<
name|endl
expr_stmt|;
block|}
end_function
begin_function
DECL|function|writeStandardParts
name|void
name|Win32MakefileGenerator
operator|::
name|writeStandardParts
parameter_list|(
name|QTextStream
modifier|&
name|t
parameter_list|)
block|{
name|t
operator|<<
literal|"####### Compiler, tools and options"
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"CC            = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_CC"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"CXX           = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_CXX"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"DEFINES       = "
operator|<<
name|varGlue
argument_list|(
literal|"PRL_EXPORT_DEFINES"
argument_list|,
literal|"-D"
argument_list|,
literal|" -D"
argument_list|,
literal|" "
argument_list|)
operator|<<
name|varGlue
argument_list|(
literal|"DEFINES"
argument_list|,
literal|"-D"
argument_list|,
literal|" -D"
argument_list|,
literal|""
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"CFLAGS        = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_CFLAGS"
argument_list|)
operator|<<
literal|" $(DEFINES)"
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"CXXFLAGS      = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_CXXFLAGS"
argument_list|)
operator|<<
literal|" $(DEFINES)"
operator|<<
name|endl
expr_stmt|;
name|writeIncPart
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|writeLibsPart
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|t
operator|<<
literal|"QMAKE         = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_QMAKE"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"IDC           = "
operator|<<
operator|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_IDC"
argument_list|)
condition|?
name|QString
argument_list|(
literal|"idc"
argument_list|)
else|:
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
name|var
argument_list|(
literal|"QMAKE_IDC"
argument_list|)
argument_list|,
literal|false
argument_list|)
operator|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"IDL           = "
operator|<<
operator|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_IDL"
argument_list|)
condition|?
name|QString
argument_list|(
literal|"midl"
argument_list|)
else|:
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
name|var
argument_list|(
literal|"QMAKE_IDL"
argument_list|)
argument_list|,
literal|false
argument_list|)
operator|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"ZIP           = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_ZIP"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"DEF_FILE      = "
operator|<<
name|varList
argument_list|(
literal|"DEF_FILE"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"RES_FILE      = "
operator|<<
name|varList
argument_list|(
literal|"RES_FILE"
argument_list|)
operator|<<
name|endl
expr_stmt|;
comment|// Not on mingw, can't see why not though...
name|t
operator|<<
literal|"COPY          = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_COPY"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"SED           = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_STREAM_EDITOR"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"COPY_FILE     = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_COPY_FILE"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"COPY_DIR      = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_COPY_DIR"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"DEL_FILE      = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_DEL_FILE"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"DEL_DIR       = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_DEL_DIR"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"MOVE          = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_MOVE"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"CHK_DIR_EXISTS= "
operator|<<
name|var
argument_list|(
literal|"QMAKE_CHK_DIR_EXISTS"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"MKDIR         = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_MKDIR"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"INSTALL_FILE    = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_INSTALL_FILE"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"INSTALL_PROGRAM = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_INSTALL_PROGRAM"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"INSTALL_DIR     = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_INSTALL_DIR"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"####### Output directory"
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"OBJECTS_DIR"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
name|t
operator|<<
literal|"OBJECTS_DIR   = "
operator|<<
name|var
argument_list|(
literal|"OBJECTS_DIR"
argument_list|)
operator|.
name|replace
argument_list|(
name|QRegExp
argument_list|(
literal|"\\\\$"
argument_list|)
argument_list|,
literal|""
argument_list|)
operator|<<
name|endl
expr_stmt|;
else|else
name|t
operator|<<
literal|"OBJECTS_DIR   = . "
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"####### Files"
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"SOURCES       = "
operator|<<
name|valList
argument_list|(
name|escapeFilePaths
argument_list|(
name|project
operator|->
name|values
argument_list|(
literal|"SOURCES"
argument_list|)
argument_list|)
argument_list|)
operator|<<
literal|" "
operator|<<
name|valList
argument_list|(
name|escapeFilePaths
argument_list|(
name|project
operator|->
name|values
argument_list|(
literal|"GENERATED_SOURCES"
argument_list|)
argument_list|)
argument_list|)
operator|<<
name|endl
expr_stmt|;
comment|// do this here so we can set DEST_TARGET to be the complete path to the final target if it is needed.
name|QString
name|orgDestDir
init|=
name|var
argument_list|(
literal|"DESTDIR"
argument_list|)
decl_stmt|;
name|QString
name|destDir
init|=
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
name|orgDestDir
argument_list|,
literal|false
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|destDir
operator|.
name|isEmpty
argument_list|()
operator|&&
operator|(
name|orgDestDir
operator|.
name|endsWith
argument_list|(
literal|'/'
argument_list|)
operator|||
name|orgDestDir
operator|.
name|endsWith
argument_list|(
name|Option
operator|::
name|dir_sep
argument_list|)
operator|)
condition|)
name|destDir
operator|+=
name|Option
operator|::
name|dir_sep
expr_stmt|;
name|QString
name|target
init|=
name|QString
argument_list|(
name|project
operator|->
name|first
argument_list|(
literal|"TARGET"
argument_list|)
operator|+
name|project
operator|->
name|first
argument_list|(
literal|"TARGET_EXT"
argument_list|)
argument_list|)
decl_stmt|;
name|target
operator|.
name|remove
argument_list|(
literal|"\""
argument_list|)
expr_stmt|;
name|project
operator|->
name|values
argument_list|(
literal|"DEST_TARGET"
argument_list|)
operator|.
name|prepend
argument_list|(
name|destDir
operator|+
name|target
argument_list|)
expr_stmt|;
name|writeObjectsPart
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|writeExtraCompilerVariables
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|writeExtraVariables
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|t
operator|<<
literal|"DIST          = "
operator|<<
name|varList
argument_list|(
literal|"DISTFILES"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"QMAKE_TARGET  = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_ORIG_TARGET"
argument_list|)
operator|<<
name|endl
expr_stmt|;
comment|// The comment is important to maintain variable compatibility with Unix
comment|// Makefiles, while not interpreting a trailing-slash as a linebreak
name|t
operator|<<
literal|"DESTDIR        = "
operator|<<
name|escapeFilePath
argument_list|(
name|destDir
argument_list|)
operator|<<
literal|" #avoid trailing-slash linebreak"
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"TARGET         = "
operator|<<
name|escapeFilePath
argument_list|(
name|target
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"DESTDIR_TARGET = "
operator|<<
name|escapeFilePath
argument_list|(
name|var
argument_list|(
literal|"DEST_TARGET"
argument_list|)
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"####### Implicit rules"
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
name|writeImplicitRulesPart
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|t
operator|<<
literal|"####### Build rules"
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
name|writeBuildRulesPart
argument_list|(
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"shared"
argument_list|)
operator|&&
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"DLLDESTDIR"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
specifier|const
name|ProStringList
modifier|&
name|dlldirs
init|=
name|project
operator|->
name|values
argument_list|(
literal|"DLLDESTDIR"
argument_list|)
decl_stmt|;
for|for
control|(
name|ProStringList
operator|::
name|ConstIterator
name|dlldir
init|=
name|dlldirs
operator|.
name|begin
argument_list|()
init|;
name|dlldir
operator|!=
name|dlldirs
operator|.
name|end
argument_list|()
condition|;
operator|++
name|dlldir
control|)
block|{
name|t
operator|<<
literal|"\t"
operator|<<
literal|"-$(COPY_FILE) \"$(DESTDIR_TARGET)\" "
operator|<<
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
operator|(
operator|*
name|dlldir
operator|)
operator|.
name|toQString
argument_list|()
argument_list|,
literal|false
argument_list|)
operator|<<
name|endl
expr_stmt|;
block|}
block|}
name|t
operator|<<
name|endl
expr_stmt|;
name|writeRcFilePart
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|writeMakeQmake
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|QStringList
name|dist_files
init|=
name|fileFixify
argument_list|(
name|Option
operator|::
name|mkfile
operator|::
name|project_files
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_INTERNAL_INCLUDED_FILES"
argument_list|)
condition|)
name|dist_files
operator|+=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_INTERNAL_INCLUDED_FILES"
argument_list|)
operator|.
name|toQStringList
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|isEmpty
argument_list|(
literal|"TRANSLATIONS"
argument_list|)
condition|)
name|dist_files
operator|<<
name|var
argument_list|(
literal|"TRANSLATIONS"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|isEmpty
argument_list|(
literal|"FORMS"
argument_list|)
condition|)
block|{
specifier|const
name|ProStringList
modifier|&
name|forms
init|=
name|project
operator|->
name|values
argument_list|(
literal|"FORMS"
argument_list|)
decl_stmt|;
for|for
control|(
name|ProStringList
operator|::
name|ConstIterator
name|formit
init|=
name|forms
operator|.
name|begin
argument_list|()
init|;
name|formit
operator|!=
name|forms
operator|.
name|end
argument_list|()
condition|;
operator|++
name|formit
control|)
block|{
name|QString
name|ui_h
init|=
name|fileFixify
argument_list|(
operator|(
operator|*
name|formit
operator|)
operator|+
name|Option
operator|::
name|h_ext
operator|.
name|first
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|exists
argument_list|(
name|ui_h
argument_list|)
condition|)
name|dist_files
operator|<<
name|ui_h
expr_stmt|;
block|}
block|}
name|t
operator|<<
literal|"dist:"
operator|<<
literal|"\n\t"
operator|<<
literal|"$(ZIP) "
operator|<<
name|var
argument_list|(
literal|"QMAKE_ORIG_TARGET"
argument_list|)
operator|<<
literal|".zip "
operator|<<
literal|"$(SOURCES) $(DIST) "
operator|<<
name|dist_files
operator|.
name|join
argument_list|(
literal|' '
argument_list|)
operator|<<
literal|" "
operator|<<
name|var
argument_list|(
literal|"TRANSLATIONS"
argument_list|)
operator|<<
literal|" "
expr_stmt|;
if|if
condition|(
operator|!
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_EXTRA_COMPILERS"
argument_list|)
condition|)
block|{
specifier|const
name|ProStringList
modifier|&
name|quc
init|=
name|project
operator|->
name|values
argument_list|(
literal|"QMAKE_EXTRA_COMPILERS"
argument_list|)
decl_stmt|;
for|for
control|(
name|ProStringList
operator|::
name|ConstIterator
name|it
init|=
name|quc
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|quc
operator|.
name|end
argument_list|()
condition|;
operator|++
name|it
control|)
block|{
specifier|const
name|ProStringList
modifier|&
name|inputs
init|=
name|project
operator|->
name|values
argument_list|(
name|ProKey
argument_list|(
operator|*
name|it
operator|+
literal|".input"
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|ProStringList
operator|::
name|ConstIterator
name|input
init|=
name|inputs
operator|.
name|begin
argument_list|()
init|;
name|input
operator|!=
name|inputs
operator|.
name|end
argument_list|()
condition|;
operator|++
name|input
control|)
name|t
operator|<<
operator|(
operator|*
name|input
operator|)
operator|<<
literal|" "
expr_stmt|;
block|}
block|}
name|t
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
name|writeCleanParts
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|writeExtraTargets
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|writeExtraCompilerTargets
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|t
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
block|}
end_function
begin_function
DECL|function|writeLibsPart
name|void
name|Win32MakefileGenerator
operator|::
name|writeLibsPart
parameter_list|(
name|QTextStream
modifier|&
name|t
parameter_list|)
block|{
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"staticlib"
argument_list|)
operator|&&
name|project
operator|->
name|first
argument_list|(
literal|"TEMPLATE"
argument_list|)
operator|==
literal|"lib"
condition|)
block|{
name|t
operator|<<
literal|"LIBAPP        = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_LIB"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"LIBFLAGS      = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_LIBFLAGS"
argument_list|)
operator|<<
name|endl
expr_stmt|;
block|}
else|else
block|{
name|t
operator|<<
literal|"LINKER        = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_LINK"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"LFLAGS        = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_LFLAGS"
argument_list|)
operator|<<
name|endl
expr_stmt|;
name|t
operator|<<
literal|"LIBS          = "
operator|<<
name|var
argument_list|(
literal|"QMAKE_LIBS"
argument_list|)
operator|<<
literal|" "
operator|<<
name|var
argument_list|(
literal|"QMAKE_LIBS_PRIVATE"
argument_list|)
operator|<<
name|endl
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|writeObjectsPart
name|void
name|Win32MakefileGenerator
operator|::
name|writeObjectsPart
parameter_list|(
name|QTextStream
modifier|&
name|t
parameter_list|)
block|{
name|t
operator|<<
literal|"OBJECTS       = "
operator|<<
name|valList
argument_list|(
name|escapeDependencyPaths
argument_list|(
name|project
operator|->
name|values
argument_list|(
literal|"OBJECTS"
argument_list|)
argument_list|)
argument_list|)
operator|<<
name|endl
expr_stmt|;
block|}
end_function
begin_function
DECL|function|writeImplicitRulesPart
name|void
name|Win32MakefileGenerator
operator|::
name|writeImplicitRulesPart
parameter_list|(
name|QTextStream
modifier|&
name|t
parameter_list|)
block|{
name|t
operator|<<
literal|".SUFFIXES:"
expr_stmt|;
for|for
control|(
name|QStringList
operator|::
name|Iterator
name|cppit
init|=
name|Option
operator|::
name|cpp_ext
operator|.
name|begin
argument_list|()
init|;
name|cppit
operator|!=
name|Option
operator|::
name|cpp_ext
operator|.
name|end
argument_list|()
condition|;
operator|++
name|cppit
control|)
name|t
operator|<<
literal|" "
operator|<<
operator|(
operator|*
name|cppit
operator|)
expr_stmt|;
for|for
control|(
name|QStringList
operator|::
name|Iterator
name|cit
init|=
name|Option
operator|::
name|c_ext
operator|.
name|begin
argument_list|()
init|;
name|cit
operator|!=
name|Option
operator|::
name|c_ext
operator|.
name|end
argument_list|()
condition|;
operator|++
name|cit
control|)
name|t
operator|<<
literal|" "
operator|<<
operator|(
operator|*
name|cit
operator|)
expr_stmt|;
name|t
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
for|for
control|(
name|QStringList
operator|::
name|Iterator
name|cppit
init|=
name|Option
operator|::
name|cpp_ext
operator|.
name|begin
argument_list|()
init|;
name|cppit
operator|!=
name|Option
operator|::
name|cpp_ext
operator|.
name|end
argument_list|()
condition|;
operator|++
name|cppit
control|)
name|t
operator|<<
operator|(
operator|*
name|cppit
operator|)
operator|<<
name|Option
operator|::
name|obj_ext
operator|<<
literal|":\n\t"
operator|<<
name|var
argument_list|(
literal|"QMAKE_RUN_CXX_IMP"
argument_list|)
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
for|for
control|(
name|QStringList
operator|::
name|Iterator
name|cit
init|=
name|Option
operator|::
name|c_ext
operator|.
name|begin
argument_list|()
init|;
name|cit
operator|!=
name|Option
operator|::
name|c_ext
operator|.
name|end
argument_list|()
condition|;
operator|++
name|cit
control|)
name|t
operator|<<
operator|(
operator|*
name|cit
operator|)
operator|<<
name|Option
operator|::
name|obj_ext
operator|<<
literal|":\n\t"
operator|<<
name|var
argument_list|(
literal|"QMAKE_RUN_CC_IMP"
argument_list|)
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
block|}
end_function
begin_function
DECL|function|writeBuildRulesPart
name|void
name|Win32MakefileGenerator
operator|::
name|writeBuildRulesPart
parameter_list|(
name|QTextStream
modifier|&
parameter_list|)
block|{ }
end_function
begin_function
DECL|function|writeRcFilePart
name|void
name|Win32MakefileGenerator
operator|::
name|writeRcFilePart
parameter_list|(
name|QTextStream
modifier|&
name|t
parameter_list|)
block|{
if|if
condition|(
operator|!
name|project
operator|->
name|values
argument_list|(
literal|"RC_FILE"
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
specifier|const
name|ProString
name|res_file
init|=
name|project
operator|->
name|first
argument_list|(
literal|"RES_FILE"
argument_list|)
decl_stmt|;
specifier|const
name|QString
name|rc_file
init|=
name|fileFixify
argument_list|(
name|project
operator|->
name|first
argument_list|(
literal|"RC_FILE"
argument_list|)
operator|.
name|toQString
argument_list|()
argument_list|)
decl_stmt|;
comment|// The resource tool needs to have the same defines passed in as the compiler, since you may
comment|// use these defines in the .rc file itself. Also, we need to add the _DEBUG define manually
comment|// since the compiler defines this symbol by itself, and we use it in the automatically
comment|// created rc file when VERSION is define the .pro file.
specifier|const
name|ProStringList
name|rcIncPaths
init|=
name|project
operator|->
name|values
argument_list|(
literal|"RC_INCLUDEPATH"
argument_list|)
decl_stmt|;
name|QString
name|incPathStr
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|rcIncPaths
operator|.
name|count
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|ProString
modifier|&
name|path
init|=
name|rcIncPaths
operator|.
name|at
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|path
operator|.
name|isEmpty
argument_list|()
condition|)
continue|continue;
name|incPathStr
operator|+=
name|QStringLiteral
argument_list|(
literal|" /i "
argument_list|)
expr_stmt|;
name|incPathStr
operator|+=
name|escapeFilePath
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
name|t
operator|<<
name|res_file
operator|<<
literal|": "
operator|<<
name|rc_file
operator|<<
literal|"\n\t"
operator|<<
name|var
argument_list|(
literal|"QMAKE_RC"
argument_list|)
operator|<<
operator|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"debug"
argument_list|)
condition|?
literal|" -D_DEBUG"
else|:
literal|""
operator|)
operator|<<
literal|" $(DEFINES)"
operator|<<
name|incPathStr
operator|<<
literal|" -fo "
operator|<<
name|res_file
operator|<<
literal|" "
operator|<<
name|rc_file
expr_stmt|;
name|t
operator|<<
name|endl
operator|<<
name|endl
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|getLibTarget
name|QString
name|Win32MakefileGenerator
operator|::
name|getLibTarget
parameter_list|()
block|{
return|return
name|QString
argument_list|(
name|project
operator|->
name|first
argument_list|(
literal|"TARGET"
argument_list|)
operator|+
name|project
operator|->
name|first
argument_list|(
literal|"TARGET_VERSION_EXT"
argument_list|)
operator|+
literal|".lib"
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|defaultInstall
name|QString
name|Win32MakefileGenerator
operator|::
name|defaultInstall
parameter_list|(
specifier|const
name|QString
modifier|&
name|t
parameter_list|)
block|{
if|if
condition|(
operator|(
name|t
operator|!=
literal|"target"
operator|&&
name|t
operator|!=
literal|"dlltarget"
operator|)
operator|||
operator|(
name|t
operator|==
literal|"dlltarget"
operator|&&
operator|(
name|project
operator|->
name|first
argument_list|(
literal|"TEMPLATE"
argument_list|)
operator|!=
literal|"lib"
operator|||
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"shared"
argument_list|)
operator|)
operator|)
operator|||
name|project
operator|->
name|first
argument_list|(
literal|"TEMPLATE"
argument_list|)
operator|==
literal|"subdirs"
condition|)
return|return
name|QString
argument_list|()
return|;
specifier|const
name|QString
name|root
init|=
literal|"$(INSTALL_ROOT)"
decl_stmt|;
name|ProStringList
modifier|&
name|uninst
init|=
name|project
operator|->
name|values
argument_list|(
name|ProKey
argument_list|(
name|t
operator|+
literal|".uninstall"
argument_list|)
argument_list|)
decl_stmt|;
name|QString
name|ret
decl_stmt|;
name|QString
name|targetdir
init|=
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
name|project
operator|->
name|first
argument_list|(
name|ProKey
argument_list|(
name|t
operator|+
literal|".path"
argument_list|)
argument_list|)
operator|.
name|toQString
argument_list|()
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|targetdir
operator|=
name|fileFixify
argument_list|(
name|targetdir
argument_list|,
name|FileFixifyAbsolute
argument_list|)
expr_stmt|;
if|if
condition|(
name|targetdir
operator|.
name|right
argument_list|(
literal|1
argument_list|)
operator|!=
name|Option
operator|::
name|dir_sep
condition|)
name|targetdir
operator|+=
name|Option
operator|::
name|dir_sep
expr_stmt|;
if|if
condition|(
name|t
operator|==
literal|"target"
operator|&&
name|project
operator|->
name|first
argument_list|(
literal|"TEMPLATE"
argument_list|)
operator|==
literal|"lib"
condition|)
block|{
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"create_prl"
argument_list|)
operator|&&
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"no_install_prl"
argument_list|)
operator|&&
operator|!
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_INTERNAL_PRL_FILE"
argument_list|)
condition|)
block|{
name|QString
name|dst_prl
init|=
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
name|project
operator|->
name|first
argument_list|(
literal|"QMAKE_INTERNAL_PRL_FILE"
argument_list|)
operator|.
name|toQString
argument_list|()
argument_list|)
decl_stmt|;
name|int
name|slsh
init|=
name|dst_prl
operator|.
name|lastIndexOf
argument_list|(
name|Option
operator|::
name|dir_sep
argument_list|)
decl_stmt|;
if|if
condition|(
name|slsh
operator|!=
operator|-
literal|1
condition|)
name|dst_prl
operator|=
name|dst_prl
operator|.
name|right
argument_list|(
name|dst_prl
operator|.
name|length
argument_list|()
operator|-
name|slsh
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dst_prl
operator|=
name|filePrefixRoot
argument_list|(
name|root
argument_list|,
name|targetdir
operator|+
name|dst_prl
argument_list|)
expr_stmt|;
name|ret
operator|+=
literal|"-$(INSTALL_FILE) \""
operator|+
name|project
operator|->
name|first
argument_list|(
literal|"QMAKE_INTERNAL_PRL_FILE"
argument_list|)
operator|+
literal|"\" \""
operator|+
name|dst_prl
operator|+
literal|"\""
expr_stmt|;
if|if
condition|(
operator|!
name|uninst
operator|.
name|isEmpty
argument_list|()
condition|)
name|uninst
operator|.
name|append
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
name|uninst
operator|.
name|append
argument_list|(
literal|"-$(DEL_FILE) \""
operator|+
name|dst_prl
operator|+
literal|"\""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"create_pc"
argument_list|)
condition|)
block|{
name|QString
name|dst_pc
init|=
name|pkgConfigFileName
argument_list|(
literal|false
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|dst_pc
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|dst_pc
operator|=
name|filePrefixRoot
argument_list|(
name|root
argument_list|,
name|targetdir
operator|+
name|dst_pc
argument_list|)
expr_stmt|;
specifier|const
name|QString
name|dst_pc_dir
init|=
name|Option
operator|::
name|fixPathToTargetOS
argument_list|(
name|fileInfo
argument_list|(
name|dst_pc
argument_list|)
operator|.
name|path
argument_list|()
argument_list|,
literal|false
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|dst_pc_dir
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|ret
operator|.
name|isEmpty
argument_list|()
condition|)
name|ret
operator|+=
literal|"\n\t"
expr_stmt|;
name|ret
operator|+=
name|mkdir_p_asstring
argument_list|(
name|dst_pc_dir
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ret
operator|.
name|isEmpty
argument_list|()
condition|)
name|ret
operator|+=
literal|"\n\t"
expr_stmt|;
specifier|const
name|ProKey
name|replace_rule
argument_list|(
literal|"QMAKE_PKGCONFIG_INSTALL_REPLACE"
argument_list|)
decl_stmt|;
if|if
condition|(
name|project
operator|->
name|isEmpty
argument_list|(
name|replace_rule
argument_list|)
operator|||
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"no_sed_meta_install"
argument_list|)
operator|||
name|project
operator|->
name|isEmpty
argument_list|(
literal|"QMAKE_STREAM_EDITOR"
argument_list|)
condition|)
block|{
name|ret
operator|+=
literal|"-$(INSTALL_FILE) \""
operator|+
name|pkgConfigFileName
argument_list|(
literal|true
argument_list|)
operator|+
literal|"\" \""
operator|+
name|dst_pc
operator|+
literal|"\""
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|+=
literal|"-$(SED)"
expr_stmt|;
specifier|const
name|ProStringList
modifier|&
name|replace_rules
init|=
name|project
operator|->
name|values
argument_list|(
name|replace_rule
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|r
init|=
literal|0
init|;
name|r
operator|<
name|replace_rules
operator|.
name|size
argument_list|()
condition|;
operator|++
name|r
control|)
block|{
specifier|const
name|ProString
name|match
init|=
name|project
operator|->
name|first
argument_list|(
name|ProKey
argument_list|(
name|replace_rules
operator|.
name|at
argument_list|(
name|r
argument_list|)
operator|+
literal|".match"
argument_list|)
argument_list|)
decl_stmt|,
name|replace
init|=
name|project
operator|->
name|first
argument_list|(
name|ProKey
argument_list|(
name|replace_rules
operator|.
name|at
argument_list|(
name|r
argument_list|)
operator|+
literal|".replace"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|match
operator|.
name|isEmpty
argument_list|()
comment|/*&& match != replace*/
condition|)
name|ret
operator|+=
literal|" -e \"s,"
operator|+
name|match
operator|+
literal|","
operator|+
name|replace
operator|+
literal|",g\""
expr_stmt|;
block|}
name|ret
operator|+=
literal|" \""
operator|+
name|pkgConfigFileName
argument_list|(
literal|true
argument_list|)
operator|+
literal|"\">\""
operator|+
name|dst_pc
operator|+
literal|"\""
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|uninst
operator|.
name|isEmpty
argument_list|()
condition|)
name|uninst
operator|.
name|append
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
name|uninst
operator|.
name|append
argument_list|(
literal|"-$(DEL_FILE) \""
operator|+
name|dst_pc
operator|+
literal|"\""
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"shared"
argument_list|)
operator|&&
operator|!
name|project
operator|->
name|isActiveConfig
argument_list|(
literal|"plugin"
argument_list|)
condition|)
block|{
name|QString
name|lib_target
init|=
name|getLibTarget
argument_list|()
decl_stmt|;
name|lib_target
operator|.
name|remove
argument_list|(
literal|'"'
argument_list|)
expr_stmt|;
name|QString
name|src_targ
init|=
operator|(
name|project
operator|->
name|isEmpty
argument_list|(
literal|"DESTDIR"
argument_list|)
condition|?
name|QString
argument_list|(
literal|"$(DESTDIR)"
argument_list|)
else|:
name|project
operator|->
name|first
argument_list|(
literal|"DESTDIR"
argument_list|)
operator|)
operator|+
name|lib_target
decl_stmt|;
name|QString
name|dst_targ
init|=
name|filePrefixRoot
argument_list|(
name|root
argument_list|,
name|fileFixify
argument_list|(
name|targetdir
operator|+
name|lib_target
argument_list|,
name|FileFixifyAbsolute
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ret
operator|.
name|isEmpty
argument_list|()
condition|)
name|ret
operator|+=
literal|"\n\t"
expr_stmt|;
name|ret
operator|+=
name|QString
argument_list|(
literal|"-$(INSTALL_FILE)"
argument_list|)
operator|+
literal|" \""
operator|+
name|src_targ
operator|+
literal|"\" \""
operator|+
name|dst_targ
operator|+
literal|"\""
expr_stmt|;
if|if
condition|(
operator|!
name|uninst
operator|.
name|isEmpty
argument_list|()
condition|)
name|uninst
operator|.
name|append
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
name|uninst
operator|.
name|append
argument_list|(
literal|"-$(DEL_FILE) \""
operator|+
name|dst_targ
operator|+
literal|"\""
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|t
operator|==
literal|"dlltarget"
operator|||
name|project
operator|->
name|values
argument_list|(
name|ProKey
argument_list|(
name|t
operator|+
literal|".CONFIG"
argument_list|)
argument_list|)
operator|.
name|indexOf
argument_list|(
literal|"no_dll"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|QString
name|src_targ
init|=
literal|"$(DESTDIR_TARGET)"
decl_stmt|;
name|QString
name|dst_targ
init|=
name|filePrefixRoot
argument_list|(
name|root
argument_list|,
name|fileFixify
argument_list|(
name|targetdir
operator|+
literal|"$(TARGET)"
argument_list|,
name|FileFixifyAbsolute
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ret
operator|.
name|isEmpty
argument_list|()
condition|)
name|ret
operator|+=
literal|"\n\t"
expr_stmt|;
name|ret
operator|+=
name|QString
argument_list|(
literal|"-$(INSTALL_FILE)"
argument_list|)
operator|+
literal|" \""
operator|+
name|src_targ
operator|+
literal|"\" \""
operator|+
name|dst_targ
operator|+
literal|"\""
expr_stmt|;
if|if
condition|(
operator|!
name|uninst
operator|.
name|isEmpty
argument_list|()
condition|)
name|uninst
operator|.
name|append
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
name|uninst
operator|.
name|append
argument_list|(
literal|"-$(DEL_FILE) \""
operator|+
name|dst_targ
operator|+
literal|"\""
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function
begin_function
DECL|function|escapeFilePath
name|QString
name|Win32MakefileGenerator
operator|::
name|escapeFilePath
parameter_list|(
specifier|const
name|QString
modifier|&
name|path
parameter_list|)
specifier|const
block|{
name|QString
name|ret
init|=
name|path
decl_stmt|;
if|if
condition|(
operator|!
name|ret
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ret
operator|=
name|unescapeFilePath
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|.
name|contains
argument_list|(
literal|" "
argument_list|)
condition|)
name|ret
operator|=
literal|"\""
operator|+
name|ret
operator|+
literal|"\""
expr_stmt|;
name|debug_msg
argument_list|(
literal|2
argument_list|,
literal|"EscapeFilePath: %s -> %s"
argument_list|,
name|path
operator|.
name|toLatin1
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|,
name|ret
operator|.
name|toLatin1
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function
begin_macro
name|QT_END_NAMESPACE
end_macro
end_unit
