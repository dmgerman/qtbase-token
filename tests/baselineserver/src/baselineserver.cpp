begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2013 Digia Plc and/or its subsidiary(-ies). ** Contact: http://www.qt-project.org/legal ** ** This file is part of the test suite of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** Commercial License Usage ** Licensees holding valid commercial Qt licenses may use this file in ** accordance with the commercial license agreement provided with the ** Software or, alternatively, in accordance with the terms contained in ** a written agreement between you and Digia.  For licensing terms and ** conditions see http://qt.digia.com/licensing.  For further information ** use the contact form at http://qt.digia.com/contact-us. ** ** GNU Lesser General Public License Usage ** Alternatively, this file may be used under the terms of the GNU Lesser ** General Public License version 2.1 as published by the Free Software ** Foundation and appearing in the file LICENSE.LGPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU Lesser General Public License version 2.1 requirements ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Digia gives you certain additional ** rights.  These rights are described in the Digia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU ** General Public License version 3.0 as published by the Free Software ** Foundation and appearing in the file LICENSE.GPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU General Public License version 3.0 requirements will be ** met: http://www.gnu.org/copyleft/gpl.html. ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_define
DECL|macro|QT_USE_FAST_CONCATENATION
define|#
directive|define
name|QT_USE_FAST_CONCATENATION
end_define
begin_define
DECL|macro|QT_USE_FAST_OPERATOR_PLUS
define|#
directive|define
name|QT_USE_FAST_OPERATOR_PLUS
end_define
begin_include
include|#
directive|include
file|"baselineserver.h"
end_include
begin_include
include|#
directive|include
file|<QBuffer>
end_include
begin_include
include|#
directive|include
file|<QFile>
end_include
begin_include
include|#
directive|include
file|<QDir>
end_include
begin_include
include|#
directive|include
file|<QCoreApplication>
end_include
begin_include
include|#
directive|include
file|<QFileInfo>
end_include
begin_include
include|#
directive|include
file|<QHostInfo>
end_include
begin_include
include|#
directive|include
file|<QTextStream>
end_include
begin_include
include|#
directive|include
file|<QProcess>
end_include
begin_include
include|#
directive|include
file|<QDirIterator>
end_include
begin_include
include|#
directive|include
file|<QUrl>
end_include
begin_comment
comment|// extra fields, for use in image metadata storage
end_comment
begin_decl_stmt
specifier|const
name|QString
name|PI_ImageChecksum
argument_list|(
name|QLS
argument_list|(
literal|"ImageChecksum"
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt
begin_decl_stmt
specifier|const
name|QString
name|PI_RunId
argument_list|(
name|QLS
argument_list|(
literal|"RunId"
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt
begin_decl_stmt
specifier|const
name|QString
name|PI_CreationDate
argument_list|(
name|QLS
argument_list|(
literal|"CreationDate"
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|member|storage
name|QString
name|BaselineServer
operator|::
name|storage
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|member|url
name|QString
name|BaselineServer
operator|::
name|url
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|member|pathKeys
name|QStringList
name|BaselineServer
operator|::
name|pathKeys
decl_stmt|;
end_decl_stmt
begin_constructor
DECL|function|BaselineServer
name|BaselineServer
operator|::
name|BaselineServer
parameter_list|(
name|QObject
modifier|*
name|parent
parameter_list|)
member_init_list|:
name|QTcpServer
argument_list|(
name|parent
argument_list|)
member_init_list|,
name|lastRunIdIdx
argument_list|(
literal|0
argument_list|)
block|{
name|QFileInfo
name|me
argument_list|(
name|QCoreApplication
operator|::
name|applicationFilePath
argument_list|()
argument_list|)
decl_stmt|;
name|meLastMod
operator|=
name|me
operator|.
name|lastModified
argument_list|()
expr_stmt|;
name|heartbeatTimer
operator|=
operator|new
name|QTimer
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|heartbeatTimer
argument_list|,
name|SIGNAL
argument_list|(
name|timeout
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|heartbeat
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|heartbeatTimer
operator|->
name|start
argument_list|(
name|HEARTBEAT
operator|*
literal|1000
argument_list|)
expr_stmt|;
block|}
end_constructor
begin_function
DECL|function|storagePath
name|QString
name|BaselineServer
operator|::
name|storagePath
parameter_list|()
block|{
if|if
condition|(
name|storage
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|storage
operator|=
name|QLS
argument_list|(
name|qgetenv
argument_list|(
literal|"QT_LANCELOT_DIR"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|storage
operator|.
name|isEmpty
argument_list|()
condition|)
name|storage
operator|=
name|QLS
argument_list|(
literal|"/var/www"
argument_list|)
expr_stmt|;
block|}
return|return
name|storage
return|;
block|}
end_function
begin_function
DECL|function|baseUrl
name|QString
name|BaselineServer
operator|::
name|baseUrl
parameter_list|()
block|{
if|if
condition|(
name|url
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|url
operator|=
name|QLS
argument_list|(
literal|"http://"
argument_list|)
operator|+
name|QHostInfo
operator|::
name|localHostName
argument_list|()
operator|.
name|toLatin1
argument_list|()
operator|+
literal|'.'
operator|+
name|QHostInfo
operator|::
name|localDomainName
argument_list|()
operator|.
name|toLatin1
argument_list|()
operator|+
literal|'/'
expr_stmt|;
block|}
return|return
name|url
return|;
block|}
end_function
begin_function
DECL|function|defaultPathKeys
name|QStringList
name|BaselineServer
operator|::
name|defaultPathKeys
parameter_list|()
block|{
if|if
condition|(
name|pathKeys
operator|.
name|isEmpty
argument_list|()
condition|)
name|pathKeys
operator|<<
name|PI_QtVersion
operator|<<
name|PI_QMakeSpec
operator|<<
name|PI_HostName
expr_stmt|;
return|return
name|pathKeys
return|;
block|}
end_function
begin_function
DECL|function|incomingConnection
name|void
name|BaselineServer
operator|::
name|incomingConnection
parameter_list|(
name|qintptr
name|socketDescriptor
parameter_list|)
block|{
name|QString
name|runId
init|=
name|QDateTime
operator|::
name|currentDateTime
argument_list|()
operator|.
name|toString
argument_list|(
name|QLS
argument_list|(
literal|"MMMdd-hhmmss"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|runId
operator|==
name|lastRunId
condition|)
block|{
name|runId
operator|+=
name|QLC
argument_list|(
literal|'-'
argument_list|)
operator|+
name|QString
operator|::
name|number
argument_list|(
operator|++
name|lastRunIdIdx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lastRunId
operator|=
name|runId
expr_stmt|;
name|lastRunIdIdx
operator|=
literal|0
expr_stmt|;
block|}
name|qDebug
argument_list|()
operator|<<
literal|"Server: New connection! RunId:"
operator|<<
name|runId
expr_stmt|;
name|BaselineThread
modifier|*
name|thread
init|=
operator|new
name|BaselineThread
argument_list|(
name|runId
argument_list|,
name|socketDescriptor
argument_list|,
name|this
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|thread
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|thread
argument_list|,
name|SLOT
argument_list|(
name|deleteLater
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|thread
operator|->
name|start
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|heartbeat
name|void
name|BaselineServer
operator|::
name|heartbeat
parameter_list|()
block|{
comment|// The idea is to exit to be restarted when modified, as soon as not actually serving
name|QFileInfo
name|me
argument_list|(
name|QCoreApplication
operator|::
name|applicationFilePath
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|me
operator|.
name|lastModified
argument_list|()
operator|==
name|meLastMod
condition|)
return|return;
if|if
condition|(
operator|!
name|me
operator|.
name|exists
argument_list|()
operator|||
operator|!
name|me
operator|.
name|isExecutable
argument_list|()
condition|)
return|return;
comment|//# (could close() here to avoid accepting new connections, to avoid livelock)
comment|//# also, could check for a timeout to force exit, to avoid hung threads blocking
name|bool
name|isServing
init|=
literal|false
decl_stmt|;
foreach|foreach
control|(
name|BaselineThread
modifier|*
name|thread
decl|,
name|findChildren
argument_list|<
name|BaselineThread
operator|*
argument_list|>
argument_list|()
control|)
block|{
if|if
condition|(
name|thread
operator|->
name|isRunning
argument_list|()
condition|)
block|{
name|isServing
operator|=
literal|true
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|isServing
condition|)
name|QCoreApplication
operator|::
name|exit
argument_list|()
expr_stmt|;
block|}
end_function
begin_constructor
DECL|function|BaselineThread
name|BaselineThread
operator|::
name|BaselineThread
parameter_list|(
specifier|const
name|QString
modifier|&
name|runId
parameter_list|,
name|int
name|socketDescriptor
parameter_list|,
name|QObject
modifier|*
name|parent
parameter_list|)
member_init_list|:
name|QThread
argument_list|(
name|parent
argument_list|)
member_init_list|,
name|runId
argument_list|(
name|runId
argument_list|)
member_init_list|,
name|socketDescriptor
argument_list|(
name|socketDescriptor
argument_list|)
block|{ }
end_constructor
begin_function
DECL|function|run
name|void
name|BaselineThread
operator|::
name|run
parameter_list|()
block|{
name|BaselineHandler
name|handler
argument_list|(
name|runId
argument_list|,
name|socketDescriptor
argument_list|)
decl_stmt|;
name|exec
argument_list|()
expr_stmt|;
block|}
end_function
begin_constructor
DECL|function|BaselineHandler
name|BaselineHandler
operator|::
name|BaselineHandler
parameter_list|(
specifier|const
name|QString
modifier|&
name|runId
parameter_list|,
name|int
name|socketDescriptor
parameter_list|)
member_init_list|:
name|QObject
argument_list|()
member_init_list|,
name|runId
argument_list|(
name|runId
argument_list|)
member_init_list|,
name|connectionEstablished
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|settings
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|fuzzLevel
argument_list|(
literal|0
argument_list|)
block|{
name|idleTimer
operator|=
operator|new
name|QTimer
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|idleTimer
operator|->
name|setSingleShot
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|idleTimer
operator|->
name|setInterval
argument_list|(
name|IDLE_CLIENT_TIMEOUT
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|idleTimer
argument_list|,
name|SIGNAL
argument_list|(
name|timeout
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|idleClientTimeout
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|idleTimer
operator|->
name|start
argument_list|()
expr_stmt|;
if|if
condition|(
name|socketDescriptor
operator|==
operator|-
literal|1
condition|)
return|return;
name|connect
argument_list|(
operator|&
name|proto
operator|.
name|socket
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|receiveRequest
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
operator|&
name|proto
operator|.
name|socket
argument_list|,
name|SIGNAL
argument_list|(
name|disconnected
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|receiveDisconnect
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|proto
operator|.
name|socket
operator|.
name|setSocketDescriptor
argument_list|(
name|socketDescriptor
argument_list|)
expr_stmt|;
name|proto
operator|.
name|socket
operator|.
name|setSocketOption
argument_list|(
name|QAbstractSocket
operator|::
name|KeepAliveOption
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_constructor
begin_function
DECL|function|logtime
specifier|const
name|char
modifier|*
name|BaselineHandler
operator|::
name|logtime
parameter_list|()
block|{
return|return
literal|0
return|;
comment|//return QTime::currentTime().toString(QLS("mm:ss.zzz"));
block|}
end_function
begin_function
DECL|function|projectPath
name|QString
name|BaselineHandler
operator|::
name|projectPath
parameter_list|(
name|bool
name|absolute
parameter_list|)
specifier|const
block|{
name|QString
name|p
init|=
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_Project
argument_list|)
decl_stmt|;
return|return
name|absolute
condition|?
name|BaselineServer
operator|::
name|storagePath
argument_list|()
operator|+
name|QLC
argument_list|(
literal|'/'
argument_list|)
operator|+
name|p
else|:
name|p
return|;
block|}
end_function
begin_function
DECL|function|checkClient
name|bool
name|BaselineHandler
operator|::
name|checkClient
parameter_list|(
name|QByteArray
modifier|*
name|errMsg
parameter_list|,
name|bool
modifier|*
name|dryRunMode
parameter_list|)
block|{
if|if
condition|(
operator|!
name|errMsg
condition|)
return|return
literal|false
return|;
if|if
condition|(
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_Project
argument_list|)
operator|.
name|isEmpty
argument_list|()
operator|||
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_TestCase
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
operator|*
name|errMsg
operator|=
literal|"No Project and/or TestCase specified in client info."
expr_stmt|;
return|return
literal|false
return|;
block|}
comment|// Determine ad-hoc state ### hardcoded for now
if|if
condition|(
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_TestCase
argument_list|)
operator|==
name|QLS
argument_list|(
literal|"tst_Lancelot"
argument_list|)
condition|)
block|{
comment|//### Todo: push this stuff out in a script
if|if
condition|(
operator|!
name|clientInfo
operator|.
name|isAdHocRun
argument_list|()
condition|)
block|{
comment|// ### comp. with earlier versions still running (4.8) (?)
name|clientInfo
operator|.
name|setAdHocRun
argument_list|(
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_PulseGitBranch
argument_list|)
operator|.
name|isEmpty
argument_list|()
operator|&&
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_PulseTestrBranch
argument_list|)
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// TBD
block|}
if|if
condition|(
name|clientInfo
operator|.
name|isAdHocRun
argument_list|()
condition|)
block|{
if|if
condition|(
name|dryRunMode
condition|)
operator|*
name|dryRunMode
operator|=
literal|false
expr_stmt|;
return|return
literal|true
return|;
block|}
comment|// Not ad hoc: filter the client
name|settings
operator|->
name|beginGroup
argument_list|(
literal|"ClientFilters"
argument_list|)
expr_stmt|;
name|bool
name|matched
init|=
literal|false
decl_stmt|;
name|bool
name|dryRunReq
init|=
literal|false
decl_stmt|;
foreach|foreach
control|(
specifier|const
name|QString
modifier|&
name|rule
decl|,
name|settings
operator|->
name|childKeys
argument_list|()
control|)
block|{
comment|//qDebug()<< "> RULE"<< rule;
name|dryRunReq
operator|=
literal|false
expr_stmt|;
name|QString
name|ruleMode
init|=
name|settings
operator|->
name|value
argument_list|(
name|rule
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|toLower
argument_list|()
decl_stmt|;
if|if
condition|(
name|ruleMode
operator|==
name|QLS
argument_list|(
literal|"dryrun"
argument_list|)
condition|)
name|dryRunReq
operator|=
literal|true
expr_stmt|;
elseif|else
if|if
condition|(
name|ruleMode
operator|!=
name|QLS
argument_list|(
literal|"enabled"
argument_list|)
condition|)
continue|continue;
name|settings
operator|->
name|beginGroup
argument_list|(
name|rule
argument_list|)
expr_stmt|;
name|bool
name|ruleMatched
init|=
literal|true
decl_stmt|;
foreach|foreach
control|(
specifier|const
name|QString
modifier|&
name|filterKey
decl|,
name|settings
operator|->
name|childKeys
argument_list|()
control|)
block|{
comment|//qDebug()<< "> FILTER"<< filterKey;
name|QString
name|filter
init|=
name|settings
operator|->
name|value
argument_list|(
name|filterKey
argument_list|)
operator|.
name|toString
argument_list|()
decl_stmt|;
if|if
condition|(
name|filter
operator|.
name|isEmpty
argument_list|()
condition|)
continue|continue;
name|QString
name|platVal
init|=
name|clientInfo
operator|.
name|value
argument_list|(
name|filterKey
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|platVal
operator|.
name|contains
argument_list|(
name|filter
argument_list|)
condition|)
block|{
name|ruleMatched
operator|=
literal|false
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ruleMatched
condition|)
block|{
name|ruleName
operator|=
name|rule
expr_stmt|;
name|matched
operator|=
literal|true
expr_stmt|;
break|break;
block|}
name|settings
operator|->
name|endGroup
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|matched
operator|&&
name|errMsg
condition|)
operator|*
name|errMsg
operator|=
literal|"Non-adhoc client did not match any filter rule in "
operator|+
name|settings
operator|->
name|fileName
argument_list|()
operator|.
name|toLatin1
argument_list|()
expr_stmt|;
if|if
condition|(
name|matched
operator|&&
name|dryRunMode
condition|)
operator|*
name|dryRunMode
operator|=
name|dryRunReq
expr_stmt|;
comment|// NB! Must reset the settings object before returning
while|while
condition|(
operator|!
name|settings
operator|->
name|group
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
name|settings
operator|->
name|endGroup
argument_list|()
expr_stmt|;
return|return
name|matched
return|;
block|}
end_function
begin_function
DECL|function|establishConnection
name|bool
name|BaselineHandler
operator|::
name|establishConnection
parameter_list|()
block|{
if|if
condition|(
operator|!
name|proto
operator|.
name|acceptConnection
argument_list|(
operator|&
name|clientInfo
argument_list|)
condition|)
block|{
name|qWarning
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Accepting new connection from"
operator|<<
name|proto
operator|.
name|socket
operator|.
name|peerAddress
argument_list|()
operator|.
name|toString
argument_list|()
operator|<<
literal|"failed."
operator|<<
name|proto
operator|.
name|errorMessage
argument_list|()
expr_stmt|;
name|proto
operator|.
name|sendBlock
argument_list|(
name|BaselineProtocol
operator|::
name|Abort
argument_list|,
name|proto
operator|.
name|errorMessage
argument_list|()
operator|.
name|toLatin1
argument_list|()
argument_list|)
expr_stmt|;
comment|// In case the client can hear us, tell it what's wrong.
name|proto
operator|.
name|socket
operator|.
name|disconnectFromHost
argument_list|()
expr_stmt|;
return|return
literal|false
return|;
block|}
name|QString
name|logMsg
decl_stmt|;
foreach|foreach
control|(
name|QString
name|key
decl|,
name|clientInfo
operator|.
name|keys
argument_list|()
control|)
block|{
if|if
condition|(
name|key
operator|!=
name|PI_HostName
operator|&&
name|key
operator|!=
name|PI_HostAddress
condition|)
name|logMsg
operator|+=
name|key
operator|+
name|QLS
argument_list|(
literal|": '"
argument_list|)
operator|+
name|clientInfo
operator|.
name|value
argument_list|(
name|key
argument_list|)
operator|+
name|QLS
argument_list|(
literal|"', "
argument_list|)
expr_stmt|;
block|}
name|qDebug
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Connection established with"
operator|<<
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_HostName
argument_list|)
operator|<<
literal|"["
operator|<<
name|qPrintable
argument_list|(
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_HostAddress
argument_list|)
argument_list|)
operator|<<
literal|"]"
operator|<<
name|logMsg
operator|<<
literal|"Overrides:"
operator|<<
name|clientInfo
operator|.
name|overrides
argument_list|()
operator|<<
literal|"AdHoc-Run:"
operator|<<
name|clientInfo
operator|.
name|isAdHocRun
argument_list|()
expr_stmt|;
comment|// ### Hardcoded backwards compatibility: add project field for certain existing clients that lack it
if|if
condition|(
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_Project
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|QString
name|tc
init|=
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_TestCase
argument_list|)
decl_stmt|;
if|if
condition|(
name|tc
operator|==
name|QLS
argument_list|(
literal|"tst_Lancelot"
argument_list|)
condition|)
name|clientInfo
operator|.
name|insert
argument_list|(
name|PI_Project
argument_list|,
name|QLS
argument_list|(
literal|"Raster"
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tc
operator|==
name|QLS
argument_list|(
literal|"tst_Scenegraph"
argument_list|)
condition|)
name|clientInfo
operator|.
name|insert
argument_list|(
name|PI_Project
argument_list|,
name|QLS
argument_list|(
literal|"SceneGraph"
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|clientInfo
operator|.
name|insert
argument_list|(
name|PI_Project
argument_list|,
name|QLS
argument_list|(
literal|"Other"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|QString
name|settingsFile
init|=
name|projectPath
argument_list|()
operator|+
name|QLS
argument_list|(
literal|"/config.ini"
argument_list|)
decl_stmt|;
name|settings
operator|=
operator|new
name|QSettings
argument_list|(
name|settingsFile
argument_list|,
name|QSettings
operator|::
name|IniFormat
argument_list|,
name|this
argument_list|)
expr_stmt|;
name|QByteArray
name|errMsg
decl_stmt|;
name|bool
name|dryRunMode
init|=
literal|false
decl_stmt|;
if|if
condition|(
operator|!
name|checkClient
argument_list|(
operator|&
name|errMsg
argument_list|,
operator|&
name|dryRunMode
argument_list|)
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Rejecting connection:"
operator|<<
name|errMsg
expr_stmt|;
name|proto
operator|.
name|sendBlock
argument_list|(
name|BaselineProtocol
operator|::
name|Abort
argument_list|,
name|errMsg
argument_list|)
expr_stmt|;
name|proto
operator|.
name|socket
operator|.
name|disconnectFromHost
argument_list|()
expr_stmt|;
return|return
literal|false
return|;
block|}
name|fuzzLevel
operator|=
name|qBound
argument_list|(
literal|0
argument_list|,
name|settings
operator|->
name|value
argument_list|(
literal|"FuzzLevel"
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|clientInfo
operator|.
name|isAdHocRun
argument_list|()
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Client matches filter rule"
operator|<<
name|ruleName
operator|<<
literal|"Dryrun:"
operator|<<
name|dryRunMode
operator|<<
literal|"FuzzLevel:"
operator|<<
name|fuzzLevel
operator|<<
literal|"ReportMissingResults:"
operator|<<
name|settings
operator|->
name|value
argument_list|(
literal|"ReportMissingResults"
argument_list|)
operator|.
name|toBool
argument_list|()
expr_stmt|;
block|}
name|proto
operator|.
name|sendBlock
argument_list|(
name|dryRunMode
condition|?
name|BaselineProtocol
operator|::
name|DoDryRun
else|:
name|BaselineProtocol
operator|::
name|Ack
argument_list|,
name|QByteArray
argument_list|()
argument_list|)
expr_stmt|;
name|report
operator|.
name|init
argument_list|(
name|this
argument_list|,
name|runId
argument_list|,
name|clientInfo
argument_list|,
name|settings
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|receiveRequest
name|void
name|BaselineHandler
operator|::
name|receiveRequest
parameter_list|()
block|{
name|idleTimer
operator|->
name|start
argument_list|()
expr_stmt|;
comment|// Restart idle client timeout
if|if
condition|(
operator|!
name|connectionEstablished
condition|)
block|{
name|connectionEstablished
operator|=
name|establishConnection
argument_list|()
expr_stmt|;
return|return;
block|}
name|QByteArray
name|block
decl_stmt|;
name|BaselineProtocol
operator|::
name|Command
name|cmd
decl_stmt|;
if|if
condition|(
operator|!
name|proto
operator|.
name|receiveBlock
argument_list|(
operator|&
name|cmd
argument_list|,
operator|&
name|block
argument_list|)
condition|)
block|{
name|qWarning
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Command reception failed. "
operator|<<
name|proto
operator|.
name|errorMessage
argument_list|()
expr_stmt|;
name|QThread
operator|::
name|currentThread
argument_list|()
operator|->
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|BaselineProtocol
operator|::
name|RequestBaselineChecksums
case|:
name|provideBaselineChecksums
argument_list|(
name|block
argument_list|)
expr_stmt|;
break|break;
case|case
name|BaselineProtocol
operator|::
name|AcceptMatch
case|:
name|recordMatch
argument_list|(
name|block
argument_list|)
expr_stmt|;
break|break;
case|case
name|BaselineProtocol
operator|::
name|AcceptNewBaseline
case|:
name|storeImage
argument_list|(
name|block
argument_list|,
literal|true
argument_list|)
expr_stmt|;
break|break;
case|case
name|BaselineProtocol
operator|::
name|AcceptMismatch
case|:
name|storeImage
argument_list|(
name|block
argument_list|,
literal|false
argument_list|)
expr_stmt|;
break|break;
default|default:
name|qWarning
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Unknown command received. "
operator|<<
name|proto
operator|.
name|errorMessage
argument_list|()
expr_stmt|;
name|proto
operator|.
name|sendBlock
argument_list|(
name|BaselineProtocol
operator|::
name|UnknownError
argument_list|,
name|QByteArray
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|provideBaselineChecksums
name|void
name|BaselineHandler
operator|::
name|provideBaselineChecksums
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|itemListBlock
parameter_list|)
block|{
name|ImageItemList
name|itemList
decl_stmt|;
name|QDataStream
name|ds
argument_list|(
name|itemListBlock
argument_list|)
decl_stmt|;
name|ds
operator|>>
name|itemList
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Received request for checksums for"
operator|<<
name|itemList
operator|.
name|count
argument_list|()
operator|<<
literal|"items in test function"
operator|<<
name|itemList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|testFunction
expr_stmt|;
for|for
control|(
name|ImageItemList
operator|::
name|iterator
name|i
init|=
name|itemList
operator|.
name|begin
argument_list|()
init|;
name|i
operator|!=
name|itemList
operator|.
name|end
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
name|i
operator|->
name|imageChecksums
operator|.
name|clear
argument_list|()
expr_stmt|;
name|i
operator|->
name|status
operator|=
name|ImageItem
operator|::
name|BaselineNotFound
expr_stmt|;
name|QString
name|prefix
init|=
name|pathForItem
argument_list|(
operator|*
name|i
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|PlatformInfo
name|itemData
init|=
name|fetchItemMetadata
argument_list|(
name|prefix
argument_list|)
decl_stmt|;
if|if
condition|(
name|itemData
operator|.
name|contains
argument_list|(
name|PI_ImageChecksum
argument_list|)
condition|)
block|{
name|bool
name|ok
init|=
literal|false
decl_stmt|;
name|quint64
name|checksum
init|=
name|itemData
operator|.
name|value
argument_list|(
name|PI_ImageChecksum
argument_list|)
operator|.
name|toULongLong
argument_list|(
operator|&
name|ok
argument_list|,
literal|16
argument_list|)
decl_stmt|;
if|if
condition|(
name|ok
condition|)
block|{
name|i
operator|->
name|imageChecksums
operator|.
name|prepend
argument_list|(
name|checksum
argument_list|)
expr_stmt|;
name|i
operator|->
name|status
operator|=
name|ImageItem
operator|::
name|Ok
expr_stmt|;
block|}
block|}
block|}
comment|// Find and mark blacklisted items
name|QString
name|context
init|=
name|pathForItem
argument_list|(
name|itemList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
operator|.
name|section
argument_list|(
name|QLC
argument_list|(
literal|'/'
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|2
argument_list|)
decl_stmt|;
if|if
condition|(
name|itemList
operator|.
name|count
argument_list|()
operator|>
literal|0
condition|)
block|{
name|QFile
name|file
argument_list|(
name|BaselineServer
operator|::
name|storagePath
argument_list|()
operator|+
name|QLC
argument_list|(
literal|'/'
argument_list|)
operator|+
name|context
operator|+
name|QLS
argument_list|(
literal|"/BLACKLIST"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|file
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
condition|)
block|{
name|QTextStream
name|in
argument_list|(
operator|&
name|file
argument_list|)
decl_stmt|;
do|do
block|{
name|QString
name|itemName
init|=
name|in
operator|.
name|readLine
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|itemName
operator|.
name|isNull
argument_list|()
condition|)
block|{
for|for
control|(
name|ImageItemList
operator|::
name|iterator
name|i
init|=
name|itemList
operator|.
name|begin
argument_list|()
init|;
name|i
operator|!=
name|itemList
operator|.
name|end
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|i
operator|->
name|itemName
operator|==
name|itemName
condition|)
name|i
operator|->
name|status
operator|=
name|ImageItem
operator|::
name|IgnoreItem
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
operator|!
name|in
operator|.
name|atEnd
argument_list|()
condition|)
do|;
block|}
block|}
name|QByteArray
name|block
decl_stmt|;
name|QDataStream
name|ods
argument_list|(
operator|&
name|block
argument_list|,
name|QIODevice
operator|::
name|WriteOnly
argument_list|)
decl_stmt|;
name|ods
operator|<<
name|itemList
expr_stmt|;
name|proto
operator|.
name|sendBlock
argument_list|(
name|BaselineProtocol
operator|::
name|Ack
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|report
operator|.
name|addItems
argument_list|(
name|itemList
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|recordMatch
name|void
name|BaselineHandler
operator|::
name|recordMatch
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|itemBlock
parameter_list|)
block|{
name|QDataStream
name|ds
argument_list|(
name|itemBlock
argument_list|)
decl_stmt|;
name|ImageItem
name|item
decl_stmt|;
name|ds
operator|>>
name|item
expr_stmt|;
name|report
operator|.
name|addResult
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|proto
operator|.
name|sendBlock
argument_list|(
name|BaselineProtocol
operator|::
name|Ack
argument_list|,
name|QByteArray
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|storeImage
name|void
name|BaselineHandler
operator|::
name|storeImage
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|itemBlock
parameter_list|,
name|bool
name|isBaseline
parameter_list|)
block|{
name|QDataStream
name|ds
argument_list|(
name|itemBlock
argument_list|)
decl_stmt|;
name|ImageItem
name|item
decl_stmt|;
name|ds
operator|>>
name|item
expr_stmt|;
if|if
condition|(
name|isBaseline
operator|&&
operator|!
name|clientInfo
operator|.
name|overrides
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Received baseline from client with override info, ignoring. Item:"
operator|<<
name|item
operator|.
name|itemName
expr_stmt|;
name|proto
operator|.
name|sendBlock
argument_list|(
name|BaselineProtocol
operator|::
name|UnknownError
argument_list|,
literal|"New baselines not accepted from client with override info."
argument_list|)
expr_stmt|;
return|return;
block|}
name|QString
name|blPrefix
init|=
name|pathForItem
argument_list|(
name|item
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|QString
name|mmPrefix
init|=
name|pathForItem
argument_list|(
name|item
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|QString
name|prefix
init|=
name|isBaseline
condition|?
name|blPrefix
else|:
name|mmPrefix
decl_stmt|;
name|qDebug
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Received"
operator|<<
operator|(
name|isBaseline
condition|?
literal|"baseline"
else|:
literal|"mismatched"
operator|)
operator|<<
literal|"image for:"
operator|<<
name|item
operator|.
name|itemName
operator|<<
literal|"Storing in"
operator|<<
name|prefix
expr_stmt|;
comment|// Reply to the client
name|QString
name|msg
decl_stmt|;
if|if
condition|(
name|isBaseline
condition|)
name|msg
operator|=
name|QLS
argument_list|(
literal|"New baseline image stored: "
argument_list|)
operator|+
name|blPrefix
operator|+
name|QLS
argument_list|(
name|FileFormat
argument_list|)
expr_stmt|;
else|else
name|msg
operator|=
name|BaselineServer
operator|::
name|baseUrl
argument_list|()
operator|+
name|report
operator|.
name|filePath
argument_list|()
expr_stmt|;
if|if
condition|(
name|isBaseline
operator|||
operator|!
name|fuzzLevel
condition|)
name|proto
operator|.
name|sendBlock
argument_list|(
name|BaselineProtocol
operator|::
name|Ack
argument_list|,
name|msg
operator|.
name|toLatin1
argument_list|()
argument_list|)
expr_stmt|;
comment|// Do early reply if possible: don't make the client wait longer than necessary
comment|// Store the image
name|QString
name|dir
init|=
name|prefix
operator|.
name|section
argument_list|(
name|QLC
argument_list|(
literal|'/'
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|2
argument_list|)
decl_stmt|;
name|QDir
name|cwd
decl_stmt|;
if|if
condition|(
operator|!
name|cwd
operator|.
name|exists
argument_list|(
name|dir
argument_list|)
condition|)
name|cwd
operator|.
name|mkpath
argument_list|(
name|dir
argument_list|)
expr_stmt|;
name|item
operator|.
name|image
operator|.
name|save
argument_list|(
name|prefix
operator|+
name|QLS
argument_list|(
name|FileFormat
argument_list|)
argument_list|,
name|FileFormat
argument_list|)
expr_stmt|;
name|PlatformInfo
name|itemData
init|=
name|clientInfo
decl_stmt|;
name|itemData
operator|.
name|insert
argument_list|(
name|PI_ImageChecksum
argument_list|,
name|QString
operator|::
name|number
argument_list|(
name|item
operator|.
name|imageChecksums
operator|.
name|at
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
comment|//# Only the first is stored. TBD: get rid of list
name|itemData
operator|.
name|insert
argument_list|(
name|PI_RunId
argument_list|,
name|runId
argument_list|)
expr_stmt|;
name|itemData
operator|.
name|insert
argument_list|(
name|PI_CreationDate
argument_list|,
name|QDateTime
operator|::
name|currentDateTime
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|storeItemMetadata
argument_list|(
name|itemData
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isBaseline
condition|)
block|{
comment|// Do fuzzy matching
name|bool
name|fuzzyMatch
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|fuzzLevel
condition|)
block|{
name|BaselineProtocol
operator|::
name|Command
name|cmd
init|=
name|BaselineProtocol
operator|::
name|Ack
decl_stmt|;
name|fuzzyMatch
operator|=
name|fuzzyCompare
argument_list|(
name|blPrefix
argument_list|,
name|mmPrefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|fuzzyMatch
condition|)
block|{
name|msg
operator|.
name|prepend
argument_list|(
name|QString
argument_list|(
literal|"Fuzzy match at fuzzlevel %1%. Report: "
argument_list|)
operator|.
name|arg
argument_list|(
name|fuzzLevel
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|BaselineProtocol
operator|::
name|FuzzyMatch
expr_stmt|;
block|}
name|proto
operator|.
name|sendBlock
argument_list|(
name|cmd
argument_list|,
name|msg
operator|.
name|toLatin1
argument_list|()
argument_list|)
expr_stmt|;
comment|// We didn't reply earlier
block|}
comment|// Add to report
name|item
operator|.
name|status
operator|=
name|fuzzyMatch
condition|?
name|ImageItem
operator|::
name|FuzzyMatch
else|:
name|ImageItem
operator|::
name|Mismatch
expr_stmt|;
name|report
operator|.
name|addResult
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|storeItemMetadata
name|void
name|BaselineHandler
operator|::
name|storeItemMetadata
parameter_list|(
specifier|const
name|PlatformInfo
modifier|&
name|metadata
parameter_list|,
specifier|const
name|QString
modifier|&
name|path
parameter_list|)
block|{
name|QFile
name|file
argument_list|(
name|path
operator|+
name|QLS
argument_list|(
name|MetadataFileExt
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|file
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|WriteOnly
operator||
name|QIODevice
operator|::
name|Truncate
argument_list|)
condition|)
block|{
name|qWarning
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"ERROR: could not write to file"
operator|<<
name|file
operator|.
name|fileName
argument_list|()
expr_stmt|;
return|return;
block|}
name|QTextStream
name|out
argument_list|(
operator|&
name|file
argument_list|)
decl_stmt|;
name|PlatformInfo
operator|::
name|const_iterator
name|it
init|=
name|metadata
operator|.
name|constBegin
argument_list|()
decl_stmt|;
while|while
condition|(
name|it
operator|!=
name|metadata
operator|.
name|constEnd
argument_list|()
condition|)
block|{
name|out
operator|<<
name|it
operator|.
name|key
argument_list|()
operator|<<
literal|": "
operator|<<
name|it
operator|.
name|value
argument_list|()
operator|<<
name|endl
expr_stmt|;
operator|++
name|it
expr_stmt|;
block|}
name|file
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|fetchItemMetadata
name|PlatformInfo
name|BaselineHandler
operator|::
name|fetchItemMetadata
parameter_list|(
specifier|const
name|QString
modifier|&
name|path
parameter_list|)
block|{
name|PlatformInfo
name|res
decl_stmt|;
name|QFile
name|file
argument_list|(
name|path
operator|+
name|QLS
argument_list|(
name|MetadataFileExt
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|file
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
operator|||
operator|!
name|QFile
operator|::
name|exists
argument_list|(
name|path
operator|+
name|QLS
argument_list|(
name|FileFormat
argument_list|)
argument_list|)
condition|)
return|return
name|res
return|;
name|QTextStream
name|in
argument_list|(
operator|&
name|file
argument_list|)
decl_stmt|;
do|do
block|{
name|QString
name|line
init|=
name|in
operator|.
name|readLine
argument_list|()
decl_stmt|;
name|int
name|idx
init|=
name|line
operator|.
name|indexOf
argument_list|(
name|QLS
argument_list|(
literal|": "
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|idx
operator|>
literal|0
condition|)
name|res
operator|.
name|insert
argument_list|(
name|line
operator|.
name|left
argument_list|(
name|idx
argument_list|)
argument_list|,
name|line
operator|.
name|mid
argument_list|(
name|idx
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|in
operator|.
name|atEnd
argument_list|()
condition|)
do|;
return|return
name|res
return|;
block|}
end_function
begin_function
DECL|function|idleClientTimeout
name|void
name|BaselineHandler
operator|::
name|idleClientTimeout
parameter_list|()
block|{
name|qWarning
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Idle client timeout: no request received for"
operator|<<
name|IDLE_CLIENT_TIMEOUT
operator|<<
literal|"seconds, terminating connection."
expr_stmt|;
name|proto
operator|.
name|socket
operator|.
name|disconnectFromHost
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|receiveDisconnect
name|void
name|BaselineHandler
operator|::
name|receiveDisconnect
parameter_list|()
block|{
name|qDebug
argument_list|()
operator|<<
name|runId
operator|<<
name|logtime
argument_list|()
operator|<<
literal|"Client disconnected."
expr_stmt|;
name|report
operator|.
name|end
argument_list|()
expr_stmt|;
if|if
condition|(
name|report
operator|.
name|reportProduced
argument_list|()
operator|&&
operator|!
name|clientInfo
operator|.
name|isAdHocRun
argument_list|()
condition|)
name|issueMismatchNotification
argument_list|()
expr_stmt|;
if|if
condition|(
name|settings
operator|&&
name|settings
operator|->
name|value
argument_list|(
literal|"ProcessXmlResults"
argument_list|)
operator|.
name|toBool
argument_list|()
operator|&&
operator|!
name|clientInfo
operator|.
name|isAdHocRun
argument_list|()
condition|)
block|{
comment|// ### TBD: actually execute the processing command. For now, just generate the xml files.
name|QString
name|xmlDir
init|=
name|report
operator|.
name|writeResultsXmlFiles
argument_list|()
decl_stmt|;
block|}
name|QThread
operator|::
name|currentThread
argument_list|()
operator|->
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|mapPlatformInfo
name|PlatformInfo
name|BaselineHandler
operator|::
name|mapPlatformInfo
parameter_list|(
specifier|const
name|PlatformInfo
modifier|&
name|orig
parameter_list|)
specifier|const
block|{
name|PlatformInfo
name|mapped
decl_stmt|;
foreach|foreach
control|(
specifier|const
name|QString
modifier|&
name|key
decl|,
name|orig
operator|.
name|uniqueKeys
argument_list|()
control|)
block|{
name|QString
name|val
init|=
name|orig
operator|.
name|value
argument_list|(
name|key
argument_list|)
operator|.
name|simplified
argument_list|()
decl_stmt|;
name|val
operator|.
name|replace
argument_list|(
name|QLC
argument_list|(
literal|'/'
argument_list|)
argument_list|,
name|QLC
argument_list|(
literal|'_'
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|.
name|replace
argument_list|(
name|QLC
argument_list|(
literal|' '
argument_list|)
argument_list|,
name|QLC
argument_list|(
literal|'_'
argument_list|)
argument_list|)
expr_stmt|;
name|mapped
operator|.
name|insert
argument_list|(
name|key
argument_list|,
name|QUrl
operator|::
name|toPercentEncoding
argument_list|(
name|val
argument_list|,
literal|"+"
argument_list|)
argument_list|)
expr_stmt|;
comment|//qDebug()<< "MAPPED"<< key<< "FROM"<< orig.value(key)<< "TO"<< mapped.value(key);
block|}
comment|// Special fixup for OS version
if|if
condition|(
name|mapped
operator|.
name|value
argument_list|(
name|PI_OSName
argument_list|)
operator|==
name|QLS
argument_list|(
literal|"MacOS"
argument_list|)
condition|)
block|{
name|int
name|ver
init|=
name|mapped
operator|.
name|value
argument_list|(
name|PI_OSVersion
argument_list|)
operator|.
name|toInt
argument_list|()
decl_stmt|;
if|if
condition|(
name|ver
operator|>
literal|1
condition|)
name|mapped
operator|.
name|insert
argument_list|(
name|PI_OSVersion
argument_list|,
name|QString
argument_list|(
literal|"MV_10_%1"
argument_list|)
operator|.
name|arg
argument_list|(
name|ver
operator|-
literal|2
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mapped
operator|.
name|value
argument_list|(
name|PI_OSName
argument_list|)
operator|==
name|QLS
argument_list|(
literal|"Windows"
argument_list|)
condition|)
block|{
comment|// TBD: map windows version numbers to names
block|}
comment|// Special fixup for hostname
name|QString
name|host
init|=
name|mapped
operator|.
name|value
argument_list|(
name|PI_HostName
argument_list|)
operator|.
name|section
argument_list|(
name|QLC
argument_list|(
literal|'.'
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
comment|// Filter away domain, if any
if|if
condition|(
name|host
operator|.
name|isEmpty
argument_list|()
operator|||
name|host
operator|==
name|QLS
argument_list|(
literal|"localhost"
argument_list|)
condition|)
block|{
name|host
operator|=
name|orig
operator|.
name|value
argument_list|(
name|PI_HostAddress
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|orig
operator|.
name|isAdHocRun
argument_list|()
condition|)
block|{
comment|// i.e. CI system run, so remove index postfix typical of vm hostnames
name|host
operator|.
name|remove
argument_list|(
name|QRegExp
argument_list|(
name|QLS
argument_list|(
literal|"\\d+$"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|host
operator|.
name|endsWith
argument_list|(
name|QLC
argument_list|(
literal|'-'
argument_list|)
argument_list|)
condition|)
name|host
operator|.
name|chop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|host
operator|.
name|isEmpty
argument_list|()
condition|)
name|host
operator|=
name|QLS
argument_list|(
literal|"UNKNOWN-HOST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mapped
operator|.
name|value
argument_list|(
name|PI_OSName
argument_list|)
operator|==
name|QLS
argument_list|(
literal|"MacOS"
argument_list|)
condition|)
comment|// handle multiple os versions on same host
name|host
operator|+=
name|QLC
argument_list|(
literal|'-'
argument_list|)
operator|+
name|mapped
operator|.
name|value
argument_list|(
name|PI_OSVersion
argument_list|)
expr_stmt|;
name|mapped
operator|.
name|insert
argument_list|(
name|PI_HostName
argument_list|,
name|host
argument_list|)
expr_stmt|;
comment|// Special fixup for Qt version
name|QString
name|ver
init|=
name|mapped
operator|.
name|value
argument_list|(
name|PI_QtVersion
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ver
operator|.
name|isEmpty
argument_list|()
condition|)
name|mapped
operator|.
name|insert
argument_list|(
name|PI_QtVersion
argument_list|,
name|ver
operator|.
name|prepend
argument_list|(
name|QLS
argument_list|(
literal|"Qt-"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|mapped
return|;
block|}
end_function
begin_function
DECL|function|pathForItem
name|QString
name|BaselineHandler
operator|::
name|pathForItem
parameter_list|(
specifier|const
name|ImageItem
modifier|&
name|item
parameter_list|,
name|bool
name|isBaseline
parameter_list|,
name|bool
name|absolute
parameter_list|)
specifier|const
block|{
if|if
condition|(
name|mappedClientInfo
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|mappedClientInfo
operator|=
name|mapPlatformInfo
argument_list|(
name|clientInfo
argument_list|)
expr_stmt|;
name|PlatformInfo
name|oraw
init|=
name|clientInfo
decl_stmt|;
comment|// ### simplify: don't map if no overrides!
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|clientInfo
operator|.
name|overrides
argument_list|()
operator|.
name|size
argument_list|()
operator|-
literal|1
condition|;
name|i
operator|+=
literal|2
control|)
name|oraw
operator|.
name|insert
argument_list|(
name|clientInfo
operator|.
name|overrides
argument_list|()
operator|.
name|at
argument_list|(
name|i
argument_list|)
argument_list|,
name|clientInfo
operator|.
name|overrides
argument_list|()
operator|.
name|at
argument_list|(
name|i
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|overriddenMappedClientInfo
operator|=
name|mapPlatformInfo
argument_list|(
name|oraw
argument_list|)
expr_stmt|;
block|}
specifier|const
name|PlatformInfo
modifier|&
name|mapped
init|=
name|isBaseline
condition|?
name|overriddenMappedClientInfo
else|:
name|mappedClientInfo
decl_stmt|;
name|QString
name|itemName
init|=
name|safeName
argument_list|(
name|item
operator|.
name|itemName
argument_list|)
decl_stmt|;
name|itemName
operator|.
name|append
argument_list|(
name|QLC
argument_list|(
literal|'_'
argument_list|)
operator|+
name|QString
operator|::
name|number
argument_list|(
name|item
operator|.
name|itemChecksum
argument_list|,
literal|16
argument_list|)
operator|.
name|rightJustified
argument_list|(
literal|4
argument_list|,
name|QLC
argument_list|(
literal|'0'
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QStringList
name|path
decl_stmt|;
name|path
operator|+=
name|projectPath
argument_list|(
name|absolute
argument_list|)
expr_stmt|;
name|path
operator|+=
name|mapped
operator|.
name|value
argument_list|(
name|PI_TestCase
argument_list|)
expr_stmt|;
name|path
operator|+=
name|QLS
argument_list|(
name|isBaseline
condition|?
literal|"baselines"
else|:
literal|"mismatches"
argument_list|)
expr_stmt|;
name|path
operator|+=
name|item
operator|.
name|testFunction
expr_stmt|;
name|QStringList
name|itemPathKeys
decl_stmt|;
if|if
condition|(
name|settings
condition|)
name|itemPathKeys
operator|=
name|settings
operator|->
name|value
argument_list|(
literal|"ItemPathKeys"
argument_list|)
operator|.
name|toStringList
argument_list|()
expr_stmt|;
if|if
condition|(
name|itemPathKeys
operator|.
name|isEmpty
argument_list|()
condition|)
name|itemPathKeys
operator|=
name|BaselineServer
operator|::
name|defaultPathKeys
argument_list|()
expr_stmt|;
foreach|foreach
control|(
specifier|const
name|QString
modifier|&
name|key
decl|,
name|itemPathKeys
control|)
name|path
operator|+=
name|mapped
operator|.
name|value
argument_list|(
name|key
argument_list|,
name|QLS
argument_list|(
literal|"UNSET-"
argument_list|)
operator|+
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isBaseline
condition|)
name|path
operator|+=
name|runId
expr_stmt|;
name|path
operator|+=
name|itemName
operator|+
name|QLC
argument_list|(
literal|'.'
argument_list|)
expr_stmt|;
return|return
name|path
operator|.
name|join
argument_list|(
name|QLS
argument_list|(
literal|"/"
argument_list|)
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|view
name|QString
name|BaselineHandler
operator|::
name|view
parameter_list|(
specifier|const
name|QString
modifier|&
name|baseline
parameter_list|,
specifier|const
name|QString
modifier|&
name|rendered
parameter_list|,
specifier|const
name|QString
modifier|&
name|compared
parameter_list|)
block|{
name|QFile
name|f
argument_list|(
literal|":/templates/view.html"
argument_list|)
decl_stmt|;
name|f
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
return|return
name|QString
operator|::
name|fromLatin1
argument_list|(
name|f
operator|.
name|readAll
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
literal|'/'
operator|+
name|baseline
argument_list|,
literal|'/'
operator|+
name|rendered
argument_list|,
literal|'/'
operator|+
name|compared
argument_list|,
name|diffstats
argument_list|(
name|baseline
argument_list|,
name|rendered
argument_list|)
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|diffstats
name|QString
name|BaselineHandler
operator|::
name|diffstats
parameter_list|(
specifier|const
name|QString
modifier|&
name|baseline
parameter_list|,
specifier|const
name|QString
modifier|&
name|rendered
parameter_list|)
block|{
name|QImage
name|blImg
argument_list|(
name|BaselineServer
operator|::
name|storagePath
argument_list|()
operator|+
name|QLC
argument_list|(
literal|'/'
argument_list|)
operator|+
name|baseline
argument_list|)
decl_stmt|;
name|QImage
name|mmImg
argument_list|(
name|BaselineServer
operator|::
name|storagePath
argument_list|()
operator|+
name|QLC
argument_list|(
literal|'/'
argument_list|)
operator|+
name|rendered
argument_list|)
decl_stmt|;
if|if
condition|(
name|blImg
operator|.
name|isNull
argument_list|()
operator|||
name|mmImg
operator|.
name|isNull
argument_list|()
condition|)
return|return
name|QLS
argument_list|(
literal|"Could not compute diffstats: image loading failed."
argument_list|)
return|;
comment|// ### TBD: cache the results
return|return
name|computeMismatchScore
argument_list|(
name|blImg
argument_list|,
name|mmImg
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|clearAllBaselines
name|QString
name|BaselineHandler
operator|::
name|clearAllBaselines
parameter_list|(
specifier|const
name|QString
modifier|&
name|context
parameter_list|)
block|{
name|int
name|tot
init|=
literal|0
decl_stmt|;
name|int
name|failed
init|=
literal|0
decl_stmt|;
name|QDirIterator
name|it
argument_list|(
name|BaselineServer
operator|::
name|storagePath
argument_list|()
operator|+
name|QLC
argument_list|(
literal|'/'
argument_list|)
operator|+
name|context
argument_list|,
name|QStringList
argument_list|()
operator|<<
name|QLS
argument_list|(
literal|"*."
argument_list|)
operator|+
name|QLS
argument_list|(
name|FileFormat
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"*."
argument_list|)
operator|+
name|QLS
argument_list|(
name|MetadataFileExt
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"*."
argument_list|)
operator|+
name|QLS
argument_list|(
name|ThumbnailExt
argument_list|)
argument_list|)
decl_stmt|;
while|while
condition|(
name|it
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|bool
name|counting
init|=
operator|!
name|it
operator|.
name|next
argument_list|()
operator|.
name|endsWith
argument_list|(
name|QLS
argument_list|(
name|ThumbnailExt
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|counting
condition|)
name|tot
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|QFile
operator|::
name|remove
argument_list|(
name|it
operator|.
name|filePath
argument_list|()
argument_list|)
operator|&&
name|counting
condition|)
name|failed
operator|++
expr_stmt|;
block|}
return|return
name|QString
argument_list|(
name|QLS
argument_list|(
literal|"%1 of %2 baselines cleared from context "
argument_list|)
argument_list|)
operator|.
name|arg
argument_list|(
operator|(
name|tot
operator|-
name|failed
operator|)
operator|/
literal|2
argument_list|)
operator|.
name|arg
argument_list|(
name|tot
operator|/
literal|2
argument_list|)
operator|+
name|context
return|;
block|}
end_function
begin_function
DECL|function|updateBaselines
name|QString
name|BaselineHandler
operator|::
name|updateBaselines
parameter_list|(
specifier|const
name|QString
modifier|&
name|context
parameter_list|,
specifier|const
name|QString
modifier|&
name|mismatchContext
parameter_list|,
specifier|const
name|QString
modifier|&
name|itemFile
parameter_list|)
block|{
name|int
name|tot
init|=
literal|0
decl_stmt|;
name|int
name|failed
init|=
literal|0
decl_stmt|;
name|QString
name|storagePrefix
init|=
name|BaselineServer
operator|::
name|storagePath
argument_list|()
operator|+
name|QLC
argument_list|(
literal|'/'
argument_list|)
decl_stmt|;
comment|// If itemId is set, update just that one, otherwise, update all:
name|QString
name|filter
init|=
name|itemFile
operator|.
name|isEmpty
argument_list|()
condition|?
name|QLS
argument_list|(
literal|"*_????."
argument_list|)
else|:
name|itemFile
decl_stmt|;
name|QDirIterator
name|it
argument_list|(
name|storagePrefix
operator|+
name|mismatchContext
argument_list|,
name|QStringList
argument_list|()
operator|<<
name|filter
operator|+
name|QLS
argument_list|(
name|FileFormat
argument_list|)
operator|<<
name|filter
operator|+
name|QLS
argument_list|(
name|MetadataFileExt
argument_list|)
operator|<<
name|filter
operator|+
name|QLS
argument_list|(
name|ThumbnailExt
argument_list|)
argument_list|)
decl_stmt|;
while|while
condition|(
name|it
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|bool
name|counting
init|=
operator|!
name|it
operator|.
name|next
argument_list|()
operator|.
name|endsWith
argument_list|(
name|QLS
argument_list|(
name|ThumbnailExt
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|counting
condition|)
name|tot
operator|++
expr_stmt|;
name|QString
name|oldFile
init|=
name|storagePrefix
operator|+
name|context
operator|+
name|QLC
argument_list|(
literal|'/'
argument_list|)
operator|+
name|it
operator|.
name|fileName
argument_list|()
decl_stmt|;
name|QFile
operator|::
name|remove
argument_list|(
name|oldFile
argument_list|)
expr_stmt|;
comment|// Remove existing baseline file
if|if
condition|(
operator|!
name|QFile
operator|::
name|copy
argument_list|(
name|it
operator|.
name|filePath
argument_list|()
argument_list|,
name|oldFile
argument_list|)
operator|&&
name|counting
condition|)
comment|// and replace it with the mismatch
name|failed
operator|++
expr_stmt|;
block|}
return|return
name|QString
argument_list|(
name|QLS
argument_list|(
literal|"%1 of %2 baselines updated in context %3 from context %4"
argument_list|)
argument_list|)
operator|.
name|arg
argument_list|(
operator|(
name|tot
operator|-
name|failed
operator|)
operator|/
literal|2
argument_list|)
operator|.
name|arg
argument_list|(
name|tot
operator|/
literal|2
argument_list|)
operator|.
name|arg
argument_list|(
name|context
argument_list|,
name|mismatchContext
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|blacklistTest
name|QString
name|BaselineHandler
operator|::
name|blacklistTest
parameter_list|(
specifier|const
name|QString
modifier|&
name|context
parameter_list|,
specifier|const
name|QString
modifier|&
name|itemId
parameter_list|,
name|bool
name|removeFromBlacklist
parameter_list|)
block|{
name|QFile
name|file
argument_list|(
name|BaselineServer
operator|::
name|storagePath
argument_list|()
operator|+
name|QLC
argument_list|(
literal|'/'
argument_list|)
operator|+
name|context
operator|+
name|QLS
argument_list|(
literal|"/BLACKLIST"
argument_list|)
argument_list|)
decl_stmt|;
name|QStringList
name|blackList
decl_stmt|;
if|if
condition|(
name|file
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadWrite
argument_list|)
condition|)
block|{
while|while
condition|(
operator|!
name|file
operator|.
name|atEnd
argument_list|()
condition|)
name|blackList
operator|.
name|append
argument_list|(
name|file
operator|.
name|readLine
argument_list|()
operator|.
name|trimmed
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|removeFromBlacklist
condition|)
name|blackList
operator|.
name|removeAll
argument_list|(
name|itemId
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|blackList
operator|.
name|contains
argument_list|(
name|itemId
argument_list|)
condition|)
name|blackList
operator|.
name|append
argument_list|(
name|itemId
argument_list|)
expr_stmt|;
name|file
operator|.
name|resize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
foreach|foreach
control|(
name|QString
name|id
decl|,
name|blackList
control|)
name|file
operator|.
name|write
argument_list|(
name|id
operator|.
name|toLatin1
argument_list|()
operator|+
literal|'\n'
argument_list|)
expr_stmt|;
name|file
operator|.
name|close
argument_list|()
expr_stmt|;
return|return
name|QLS
argument_list|(
name|removeFromBlacklist
condition|?
literal|"Whitelisted "
else|:
literal|"Blacklisted "
argument_list|)
operator|+
name|itemId
operator|+
name|QLS
argument_list|(
literal|" in context "
argument_list|)
operator|+
name|context
return|;
block|}
else|else
block|{
return|return
name|QLS
argument_list|(
literal|"Unable to update blacklisted tests, failed to open "
argument_list|)
operator|+
name|file
operator|.
name|fileName
argument_list|()
return|;
block|}
block|}
end_function
begin_function
DECL|function|testPathMapping
name|void
name|BaselineHandler
operator|::
name|testPathMapping
parameter_list|()
block|{
name|qDebug
argument_list|()
operator|<<
literal|"Storage prefix:"
operator|<<
name|BaselineServer
operator|::
name|storagePath
argument_list|()
expr_stmt|;
name|QStringList
name|hosts
decl_stmt|;
name|hosts
operator|<<
name|QLS
argument_list|(
literal|"bq-ubuntu910-x86-01"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"bq-ubuntu910-x86-15"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"osl-mac-master-5.test.qt-project.org"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"osl-mac-master-6.test.qt-project.org"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"sv-xp-vs-010"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"sv-xp-vs-011"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"sv-solaris-sparc-008"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"macbuilder-02.test.troll.no"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"bqvm1164"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"chimera"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|"localhost"
argument_list|)
operator|<<
name|QLS
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|ImageItem
name|item
decl_stmt|;
name|item
operator|.
name|testFunction
operator|=
name|QLS
argument_list|(
literal|"testPathMapping"
argument_list|)
expr_stmt|;
name|item
operator|.
name|itemName
operator|=
name|QLS
argument_list|(
literal|"arcs.qps"
argument_list|)
expr_stmt|;
name|item
operator|.
name|imageChecksums
operator|<<
literal|0x0123456789abcdefULL
expr_stmt|;
name|item
operator|.
name|itemChecksum
operator|=
literal|0x0123
expr_stmt|;
name|clientInfo
operator|.
name|insert
argument_list|(
name|PI_QtVersion
argument_list|,
name|QLS
argument_list|(
literal|"5.0.0"
argument_list|)
argument_list|)
expr_stmt|;
name|clientInfo
operator|.
name|insert
argument_list|(
name|PI_QMakeSpec
argument_list|,
name|QLS
argument_list|(
literal|"linux-g++"
argument_list|)
argument_list|)
expr_stmt|;
name|clientInfo
operator|.
name|insert
argument_list|(
name|PI_PulseGitBranch
argument_list|,
name|QLS
argument_list|(
literal|"somebranch"
argument_list|)
argument_list|)
expr_stmt|;
name|clientInfo
operator|.
name|setAdHocRun
argument_list|(
literal|false
argument_list|)
expr_stmt|;
foreach|foreach
control|(
specifier|const
name|QString
modifier|&
name|host
decl|,
name|hosts
control|)
block|{
name|mappedClientInfo
operator|.
name|clear
argument_list|()
expr_stmt|;
name|clientInfo
operator|.
name|insert
argument_list|(
name|PI_HostName
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"Baseline from"
operator|<<
name|host
operator|<<
literal|"->"
operator|<<
name|pathForItem
argument_list|(
name|item
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"Mismatch from"
operator|<<
name|host
operator|<<
literal|"->"
operator|<<
name|pathForItem
argument_list|(
name|item
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|computeMismatchScore
name|QString
name|BaselineHandler
operator|::
name|computeMismatchScore
parameter_list|(
specifier|const
name|QImage
modifier|&
name|baseline
parameter_list|,
specifier|const
name|QImage
modifier|&
name|rendered
parameter_list|)
block|{
if|if
condition|(
name|baseline
operator|.
name|size
argument_list|()
operator|!=
name|rendered
operator|.
name|size
argument_list|()
operator|||
name|baseline
operator|.
name|format
argument_list|()
operator|!=
name|rendered
operator|.
name|format
argument_list|()
condition|)
return|return
name|QLS
argument_list|(
literal|"[No diffstats, incomparable images.]"
argument_list|)
return|;
if|if
condition|(
name|baseline
operator|.
name|depth
argument_list|()
operator|!=
literal|32
condition|)
return|return
name|QLS
argument_list|(
literal|"[Diffstats computation not implemented for format.]"
argument_list|)
return|;
name|int
name|w
init|=
name|baseline
operator|.
name|width
argument_list|()
decl_stmt|;
name|int
name|h
init|=
name|baseline
operator|.
name|height
argument_list|()
decl_stmt|;
name|uint
name|ncd
init|=
literal|0
decl_stmt|;
comment|// number of differing color pixels
name|uint
name|nad
init|=
literal|0
decl_stmt|;
comment|// number of differing alpha pixels
name|uint
name|scd
init|=
literal|0
decl_stmt|;
comment|// sum of color pixel difference
name|uint
name|sad
init|=
literal|0
decl_stmt|;
comment|// sum of alpha pixel difference
name|uint
name|mind
init|=
literal|0
decl_stmt|;
comment|// minimum difference
name|uint
name|maxd
init|=
literal|0
decl_stmt|;
comment|// maximum difference
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|h
condition|;
operator|++
name|y
control|)
block|{
specifier|const
name|QRgb
modifier|*
name|bl
init|=
operator|(
specifier|const
name|QRgb
operator|*
operator|)
name|baseline
operator|.
name|constScanLine
argument_list|(
name|y
argument_list|)
decl_stmt|;
specifier|const
name|QRgb
modifier|*
name|rl
init|=
operator|(
specifier|const
name|QRgb
operator|*
operator|)
name|rendered
operator|.
name|constScanLine
argument_list|(
name|y
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|w
condition|;
operator|++
name|x
control|)
block|{
name|QRgb
name|b
init|=
name|bl
index|[
name|x
index|]
decl_stmt|;
name|QRgb
name|r
init|=
name|rl
index|[
name|x
index|]
decl_stmt|;
if|if
condition|(
name|r
operator|!=
name|b
condition|)
block|{
name|uint
name|dr
init|=
name|qAbs
argument_list|(
name|qRed
argument_list|(
name|b
argument_list|)
operator|-
name|qRed
argument_list|(
name|r
argument_list|)
argument_list|)
decl_stmt|;
name|uint
name|dg
init|=
name|qAbs
argument_list|(
name|qGreen
argument_list|(
name|b
argument_list|)
operator|-
name|qGreen
argument_list|(
name|r
argument_list|)
argument_list|)
decl_stmt|;
name|uint
name|db
init|=
name|qAbs
argument_list|(
name|qBlue
argument_list|(
name|b
argument_list|)
operator|-
name|qBlue
argument_list|(
name|r
argument_list|)
argument_list|)
decl_stmt|;
name|uint
name|ds
init|=
operator|(
name|dr
operator|+
name|dg
operator|+
name|db
operator|)
operator|/
literal|3
decl_stmt|;
name|uint
name|da
init|=
name|qAbs
argument_list|(
name|qAlpha
argument_list|(
name|b
argument_list|)
operator|-
name|qAlpha
argument_list|(
name|r
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|ds
condition|)
block|{
name|ncd
operator|++
expr_stmt|;
name|scd
operator|+=
name|ds
expr_stmt|;
if|if
condition|(
operator|!
name|mind
operator|||
name|ds
operator|<
name|mind
condition|)
name|mind
operator|=
name|ds
expr_stmt|;
if|if
condition|(
name|ds
operator|>
name|maxd
condition|)
name|maxd
operator|=
name|ds
expr_stmt|;
block|}
if|if
condition|(
name|da
condition|)
block|{
name|nad
operator|++
expr_stmt|;
name|sad
operator|+=
name|da
expr_stmt|;
block|}
block|}
block|}
block|}
name|double
name|pcd
init|=
literal|100.0
operator|*
name|ncd
operator|/
operator|(
name|w
operator|*
name|h
operator|)
decl_stmt|;
comment|// percent of pixels that differ
name|double
name|acd
init|=
name|ncd
condition|?
name|double
argument_list|(
name|scd
argument_list|)
operator|/
operator|(
name|ncd
operator|)
else|:
literal|0
decl_stmt|;
comment|// avg. difference
comment|/*     if (baseline.hasAlphaChannel()) {         double pad = 100.0 * nad / (w*h);  // percent of pixels that differ         double aad = nad ? double(sad) / (3*nad) : 0;         // avg. difference     } */
name|QString
name|res
init|=
literal|"<table>\n"
decl_stmt|;
name|QString
name|item
init|=
literal|"<tr><td>%1</td><td align=right>%2</td></tr>\n"
decl_stmt|;
name|res
operator|+=
name|item
operator|.
name|arg
argument_list|(
literal|"Number of mismatching pixels"
argument_list|)
operator|.
name|arg
argument_list|(
name|ncd
argument_list|)
expr_stmt|;
name|res
operator|+=
name|item
operator|.
name|arg
argument_list|(
literal|"Percentage mismatching pixels"
argument_list|)
operator|.
name|arg
argument_list|(
name|pcd
argument_list|,
literal|0
argument_list|,
literal|'g'
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|res
operator|+=
name|item
operator|.
name|arg
argument_list|(
literal|"Minimum pixel distance"
argument_list|)
operator|.
name|arg
argument_list|(
name|mind
argument_list|)
expr_stmt|;
name|res
operator|+=
name|item
operator|.
name|arg
argument_list|(
literal|"Maximum pixel distance"
argument_list|)
operator|.
name|arg
argument_list|(
name|maxd
argument_list|)
expr_stmt|;
if|if
condition|(
name|acd
operator|>=
literal|10.0
condition|)
name|res
operator|+=
name|item
operator|.
name|arg
argument_list|(
literal|"Average pixel distance"
argument_list|)
operator|.
name|arg
argument_list|(
name|qRound
argument_list|(
name|acd
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|res
operator|+=
name|item
operator|.
name|arg
argument_list|(
literal|"Average pixel distance"
argument_list|)
operator|.
name|arg
argument_list|(
name|acd
argument_list|,
literal|0
argument_list|,
literal|'g'
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|baseline
operator|.
name|hasAlphaChannel
argument_list|()
condition|)
name|res
operator|+=
name|item
operator|.
name|arg
argument_list|(
literal|"Number of mismatching alpha values"
argument_list|)
operator|.
name|arg
argument_list|(
name|nad
argument_list|)
expr_stmt|;
name|res
operator|+=
literal|"</table>\n"
expr_stmt|;
name|res
operator|+=
literal|"<p>(Distances are normalized to the range 0-255)</p>\n"
expr_stmt|;
return|return
name|res
return|;
block|}
end_function
begin_function
DECL|function|fuzzyCompare
name|bool
name|BaselineHandler
operator|::
name|fuzzyCompare
parameter_list|(
specifier|const
name|QString
modifier|&
name|baselinePath
parameter_list|,
specifier|const
name|QString
modifier|&
name|mismatchPath
parameter_list|)
block|{
name|QProcess
name|compareProc
decl_stmt|;
name|QStringList
name|args
decl_stmt|;
name|args
operator|<<
literal|"-fuzz"
operator|<<
name|QString
argument_list|(
literal|"%1%"
argument_list|)
operator|.
name|arg
argument_list|(
name|fuzzLevel
argument_list|)
operator|<<
literal|"-metric"
operator|<<
literal|"AE"
expr_stmt|;
name|args
operator|<<
name|baselinePath
operator|+
name|QLS
argument_list|(
name|FileFormat
argument_list|)
operator|<<
name|mismatchPath
operator|+
name|QLS
argument_list|(
name|FileFormat
argument_list|)
operator|<<
literal|"/dev/null"
expr_stmt|;
comment|// TBD: Should save output image, so report won't have to regenerate it
name|compareProc
operator|.
name|setProcessChannelMode
argument_list|(
name|QProcess
operator|::
name|MergedChannels
argument_list|)
expr_stmt|;
name|compareProc
operator|.
name|start
argument_list|(
literal|"compare"
argument_list|,
name|args
argument_list|,
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
if|if
condition|(
name|compareProc
operator|.
name|waitForFinished
argument_list|(
literal|3000
argument_list|)
operator|&&
name|compareProc
operator|.
name|error
argument_list|()
operator|==
name|QProcess
operator|::
name|UnknownError
condition|)
block|{
name|bool
name|ok
init|=
literal|false
decl_stmt|;
name|int
name|metric
init|=
name|compareProc
operator|.
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
operator|.
name|toInt
argument_list|(
operator|&
name|ok
argument_list|)
decl_stmt|;
if|if
condition|(
name|ok
operator|&&
name|metric
operator|==
literal|0
condition|)
return|return
literal|true
return|;
block|}
return|return
literal|false
return|;
block|}
end_function
begin_function
DECL|function|issueMismatchNotification
name|void
name|BaselineHandler
operator|::
name|issueMismatchNotification
parameter_list|()
block|{
comment|// KISS: hardcoded use of the "sendemail" utility. Make this configurable if and when demand arises.
if|if
condition|(
operator|!
name|settings
condition|)
return|return;
name|settings
operator|->
name|beginGroup
argument_list|(
literal|"Notification"
argument_list|)
expr_stmt|;
name|QStringList
name|receivers
init|=
name|settings
operator|->
name|value
argument_list|(
literal|"Receivers"
argument_list|)
operator|.
name|toStringList
argument_list|()
decl_stmt|;
name|QString
name|sender
init|=
name|settings
operator|->
name|value
argument_list|(
literal|"Sender"
argument_list|)
operator|.
name|toString
argument_list|()
decl_stmt|;
name|QString
name|server
init|=
name|settings
operator|->
name|value
argument_list|(
literal|"SMTPserver"
argument_list|)
operator|.
name|toString
argument_list|()
decl_stmt|;
name|settings
operator|->
name|endGroup
argument_list|()
expr_stmt|;
if|if
condition|(
name|receivers
operator|.
name|isEmpty
argument_list|()
operator|||
name|sender
operator|.
name|isEmpty
argument_list|()
operator|||
name|server
operator|.
name|isEmpty
argument_list|()
condition|)
return|return;
name|QString
name|msg
init|=
name|QString
argument_list|(
literal|"\nResult summary for test run %1:\n"
argument_list|)
operator|.
name|arg
argument_list|(
name|runId
argument_list|)
decl_stmt|;
name|msg
operator|+=
name|report
operator|.
name|summary
argument_list|()
expr_stmt|;
name|msg
operator|+=
literal|"\nReport: "
operator|+
name|BaselineServer
operator|::
name|baseUrl
argument_list|()
operator|+
name|report
operator|.
name|filePath
argument_list|()
operator|+
literal|"\n"
expr_stmt|;
name|msg
operator|+=
literal|"\nTest run platform properties:\n------------------\n"
expr_stmt|;
foreach|foreach
control|(
specifier|const
name|QString
modifier|&
name|key
decl|,
name|clientInfo
operator|.
name|keys
argument_list|()
control|)
name|msg
operator|+=
name|key
operator|+
literal|":  "
operator|+
name|clientInfo
operator|.
name|value
argument_list|(
name|key
argument_list|)
operator|+
literal|'\n'
expr_stmt|;
name|msg
operator|+=
literal|"\nCheers,\n- Your friendly Lancelot Baseline Server\n"
expr_stmt|;
name|QProcess
name|proc
decl_stmt|;
name|QString
name|cmd
init|=
literal|"sendemail"
decl_stmt|;
name|QStringList
name|args
decl_stmt|;
name|args
operator|<<
literal|"-s"
operator|<<
name|server
operator|<<
literal|"-f"
operator|<<
name|sender
operator|<<
literal|"-t"
operator|<<
name|receivers
expr_stmt|;
name|args
operator|<<
literal|"-u"
operator|<<
literal|"[Lancelot] Mismatch report for project "
operator|+
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_Project
argument_list|)
operator|+
literal|", test case "
operator|+
name|clientInfo
operator|.
name|value
argument_list|(
name|PI_TestCase
argument_list|)
expr_stmt|;
name|args
operator|<<
literal|"-m"
operator|<<
name|msg
expr_stmt|;
comment|//proc.setProcessChannelMode(QProcess::MergedChannels);
name|proc
operator|.
name|start
argument_list|(
name|cmd
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|proc
operator|.
name|waitForFinished
argument_list|(
literal|10
operator|*
literal|1000
argument_list|)
operator|||
operator|(
name|proc
operator|.
name|exitStatus
argument_list|()
operator|!=
name|QProcess
operator|::
name|NormalExit
operator|)
operator|||
name|proc
operator|.
name|exitCode
argument_list|()
condition|)
block|{
name|qWarning
argument_list|()
operator|<<
literal|"FAILED to issue notification. Command:"
operator|<<
name|cmd
operator|<<
name|args
operator|.
name|mid
argument_list|(
literal|0
argument_list|,
name|args
operator|.
name|size
argument_list|()
operator|-
literal|2
argument_list|)
expr_stmt|;
name|qWarning
argument_list|()
operator|<<
literal|"    Command standard output:"
operator|<<
name|proc
operator|.
name|readAllStandardOutput
argument_list|()
expr_stmt|;
name|qWarning
argument_list|()
operator|<<
literal|"    Command error output:"
operator|<<
name|proc
operator|.
name|readAllStandardError
argument_list|()
expr_stmt|;
block|}
block|}
end_function
begin_comment
comment|// Make an identifer safer for use as filename and URL
end_comment
begin_function
DECL|function|safeName
name|QString
name|safeName
parameter_list|(
specifier|const
name|QString
modifier|&
name|name
parameter_list|)
block|{
name|QString
name|res
init|=
name|name
operator|.
name|simplified
argument_list|()
decl_stmt|;
name|res
operator|.
name|replace
argument_list|(
name|QLC
argument_list|(
literal|' '
argument_list|)
argument_list|,
name|QLC
argument_list|(
literal|'_'
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|.
name|replace
argument_list|(
name|QLC
argument_list|(
literal|'.'
argument_list|)
argument_list|,
name|QLC
argument_list|(
literal|'_'
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|.
name|replace
argument_list|(
name|QLC
argument_list|(
literal|'/'
argument_list|)
argument_list|,
name|QLC
argument_list|(
literal|'^'
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function
end_unit
