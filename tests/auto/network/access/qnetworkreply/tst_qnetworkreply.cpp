begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2014 Digia Plc and/or its subsidiary(-ies). ** Contact: http://www.qt-project.org/legal ** ** This file is part of the test suite of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL21$ ** Commercial License Usage ** Licensees holding valid commercial Qt licenses may use this file in ** accordance with the commercial license agreement provided with the ** Software or, alternatively, in accordance with the terms contained in ** a written agreement between you and Digia. For licensing terms and ** conditions see http://qt.digia.com/licensing. For further information ** use the contact form at http://qt.digia.com/contact-us. ** ** GNU Lesser General Public License Usage ** Alternatively, this file may be used under the terms of the GNU Lesser ** General Public License version 2.1 or version 3 as published by the Free ** Software Foundation and appearing in the file LICENSE.LGPLv21 and ** LICENSE.LGPLv3 included in the packaging of this file. Please review the ** following information to ensure the GNU Lesser General Public License ** requirements will be met: https://www.gnu.org/licenses/lgpl.html and ** http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Digia gives you certain additional ** rights. These rights are described in the Digia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<QtTest/QtTest>
end_include
begin_include
include|#
directive|include
file|<QtCore/QCryptographicHash>
end_include
begin_include
include|#
directive|include
file|<QtCore/QDataStream>
end_include
begin_include
include|#
directive|include
file|<QtCore/QUrl>
end_include
begin_include
include|#
directive|include
file|<QtCore/QEventLoop>
end_include
begin_include
include|#
directive|include
file|<QtCore/QFile>
end_include
begin_include
include|#
directive|include
file|<QtCore/QSharedPointer>
end_include
begin_include
include|#
directive|include
file|<QtCore/QScopedPointer>
end_include
begin_include
include|#
directive|include
file|<QtCore/QTemporaryFile>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QTcpServer>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QTcpSocket>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QLocalSocket>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QLocalServer>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QHostInfo>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QNetworkAccessManager>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QNetworkRequest>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QNetworkReply>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QAbstractNetworkCache>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/qauthenticator.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/qnetworkaccessmanager.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/qnetworkdiskcache.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/qnetworkrequest.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/qnetworkreply.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/qnetworkcookie.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QNetworkCookieJar>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QHttpPart>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QHttpMultiPart>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/QNetworkProxyQuery>
end_include
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_SSL
end_ifndef
begin_include
include|#
directive|include
file|<QtNetwork/qsslerror.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/qsslconfiguration.h>
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_include
include|#
directive|include
file|<QtNetwork/private/qsslconfiguration_p.h>
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_BEARERMANAGEMENT
end_ifndef
begin_include
include|#
directive|include
file|<QtNetwork/qnetworkconfigmanager.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/qnetworkconfiguration.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/qnetworksession.h>
end_include
begin_include
include|#
directive|include
file|<QtNetwork/private/qnetworksession_p.h>
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_include
include|#
directive|include
file|<QtNetwork/private/qnetworkreplyimpl_p.h>
end_include
begin_comment
comment|// implicitly included by qnetworkaccessmanager_p.h currently, but don't rely on that being true forever
end_comment
begin_include
include|#
directive|include
file|<QtNetwork/private/qnetworkaccessmanager_p.h>
end_include
begin_else
else|#
directive|else
end_else
begin_macro
name|Q_DECLARE_METATYPE
argument_list|(
argument|QSharedPointer<char>
argument_list|)
end_macro
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|Q_OS_UNIX
end_ifdef
begin_include
include|#
directive|include
file|<sys/types.h>
end_include
begin_include
include|#
directive|include
file|<unistd.h>
end_include
begin_comment
comment|// for getuid()
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|<time.h>
end_include
begin_include
include|#
directive|include
file|"../../../network-settings.h"
end_include
begin_macro
name|Q_DECLARE_METATYPE
argument_list|(
argument|QAuthenticator*
argument_list|)
end_macro
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
end_ifndef
begin_macro
name|Q_DECLARE_METATYPE
argument_list|(
argument|QNetworkProxyQuery
argument_list|)
end_macro
begin_endif
endif|#
directive|endif
end_endif
begin_typedef
DECL|typedef|QNetworkReplyPtr
typedef|typedef
name|QSharedPointer
argument_list|<
name|QNetworkReply
argument_list|>
name|QNetworkReplyPtr
typedef|;
end_typedef
begin_class_decl
class_decl|class
name|MyCookieJar
class_decl|;
end_class_decl
begin_class
DECL|class|tst_QNetworkReply
class|class
name|tst_QNetworkReply
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
DECL|struct|ProxyData
struct|struct
name|ProxyData
block|{
DECL|function|ProxyData
name|ProxyData
parameter_list|(
specifier|const
name|QNetworkProxy
modifier|&
name|p
parameter_list|,
specifier|const
name|QByteArray
modifier|&
name|t
parameter_list|,
name|bool
name|auth
parameter_list|)
member_init_list|:
name|tag
argument_list|(
name|t
argument_list|)
member_init_list|,
name|proxy
argument_list|(
name|p
argument_list|)
member_init_list|,
name|requiresAuthentication
argument_list|(
name|auth
argument_list|)
block|{ }
DECL|member|tag
name|QByteArray
name|tag
decl_stmt|;
DECL|member|proxy
name|QNetworkProxy
name|proxy
decl_stmt|;
DECL|member|requiresAuthentication
name|bool
name|requiresAuthentication
decl_stmt|;
block|}
struct|;
endif|#
directive|endif
comment|// !QT_NO_NETWORKPROXY
DECL|member|seedCreated
specifier|static
name|bool
name|seedCreated
decl_stmt|;
DECL|function|createUniqueExtension
specifier|static
name|QString
name|createUniqueExtension
parameter_list|()
block|{
if|if
condition|(
operator|!
name|seedCreated
condition|)
block|{
name|qsrand
argument_list|(
name|QTime
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|.
name|msecsTo
argument_list|(
name|QTime
operator|::
name|currentTime
argument_list|()
argument_list|)
operator|+
name|QCoreApplication
operator|::
name|applicationPid
argument_list|()
argument_list|)
expr_stmt|;
name|seedCreated
operator|=
literal|true
expr_stmt|;
comment|// not thread-safe, but who cares
block|}
name|QString
name|s
init|=
name|QString
argument_list|(
literal|"%1-%2-%3"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTime
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|.
name|msecsTo
argument_list|(
name|QTime
operator|::
name|currentTime
argument_list|()
argument_list|)
argument_list|)
operator|.
name|arg
argument_list|(
name|QCoreApplication
operator|::
name|applicationPid
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|qrand
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|s
return|;
block|}
empty_stmt|;
DECL|member|loop
name|QEventLoop
modifier|*
name|loop
decl_stmt|;
DECL|enum|RunSimpleRequestReturn
DECL|enumerator|Timeout
DECL|enumerator|Success
DECL|enumerator|Failure
enum|enum
name|RunSimpleRequestReturn
block|{
name|Timeout
init|=
literal|0
block|,
name|Success
block|,
name|Failure
block|}
enum|;
DECL|member|returnCode
name|int
name|returnCode
decl_stmt|;
DECL|member|testFileName
name|QString
name|testFileName
decl_stmt|;
DECL|member|echoProcessDir
name|QString
name|echoProcessDir
decl_stmt|;
if|#
directive|if
operator|!
name|defined
name|Q_OS_WIN
DECL|member|wronlyFileName
name|QString
name|wronlyFileName
decl_stmt|;
endif|#
directive|endif
DECL|member|uniqueExtension
name|QString
name|uniqueExtension
decl_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
DECL|member|proxies
name|QList
argument_list|<
name|ProxyData
argument_list|>
name|proxies
decl_stmt|;
endif|#
directive|endif
DECL|member|manager
name|QNetworkAccessManager
name|manager
decl_stmt|;
DECL|member|cookieJar
name|MyCookieJar
modifier|*
name|cookieJar
decl_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
DECL|member|storedSslConfiguration
name|QSslConfiguration
name|storedSslConfiguration
decl_stmt|;
DECL|member|storedExpectedSslErrors
name|QList
argument_list|<
name|QSslError
argument_list|>
name|storedExpectedSslErrors
decl_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|QT_NO_BEARERMANAGEMENT
DECL|member|netConfMan
name|QNetworkConfigurationManager
modifier|*
name|netConfMan
decl_stmt|;
DECL|member|networkConfiguration
name|QNetworkConfiguration
name|networkConfiguration
decl_stmt|;
DECL|member|networkSession
name|QScopedPointer
argument_list|<
name|QNetworkSession
argument_list|>
name|networkSession
decl_stmt|;
endif|#
directive|endif
using|using
name|QObject
operator|::
name|connect
using|;
DECL|function|connect
specifier|static
name|bool
name|connect
parameter_list|(
specifier|const
name|QNetworkReplyPtr
modifier|&
name|ptr
parameter_list|,
specifier|const
name|char
modifier|*
name|signal
parameter_list|,
specifier|const
name|QObject
modifier|*
name|receiver
parameter_list|,
specifier|const
name|char
modifier|*
name|slot
parameter_list|,
name|Qt
operator|::
name|ConnectionType
name|ct
init|=
name|Qt
operator|::
name|AutoConnection
parameter_list|)
block|{
return|return
name|connect
argument_list|(
name|ptr
operator|.
name|data
argument_list|()
argument_list|,
name|signal
argument_list|,
name|receiver
argument_list|,
name|slot
argument_list|,
name|ct
argument_list|)
return|;
block|}
DECL|function|connect
name|bool
name|connect
parameter_list|(
specifier|const
name|QNetworkReplyPtr
modifier|&
name|ptr
parameter_list|,
specifier|const
name|char
modifier|*
name|signal
parameter_list|,
specifier|const
name|char
modifier|*
name|slot
parameter_list|,
name|Qt
operator|::
name|ConnectionType
name|ct
init|=
name|Qt
operator|::
name|AutoConnection
parameter_list|)
block|{
return|return
name|connect
argument_list|(
name|ptr
operator|.
name|data
argument_list|()
argument_list|,
name|signal
argument_list|,
name|slot
argument_list|,
name|ct
argument_list|)
return|;
block|}
public|public:
name|tst_QNetworkReply
parameter_list|()
constructor_decl|;
name|~
name|tst_QNetworkReply
parameter_list|()
destructor_decl|;
name|QString
name|runSimpleRequest
parameter_list|(
name|QNetworkAccessManager
operator|::
name|Operation
name|op
parameter_list|,
specifier|const
name|QNetworkRequest
modifier|&
name|request
parameter_list|,
name|QNetworkReplyPtr
modifier|&
name|reply
parameter_list|,
specifier|const
name|QByteArray
modifier|&
name|data
init|=
name|QByteArray
argument_list|()
parameter_list|)
function_decl|;
name|QString
name|runMultipartRequest
parameter_list|(
specifier|const
name|QNetworkRequest
modifier|&
name|request
parameter_list|,
name|QNetworkReplyPtr
modifier|&
name|reply
parameter_list|,
name|QHttpMultiPart
modifier|*
name|multiPart
parameter_list|,
specifier|const
name|QByteArray
modifier|&
name|verb
parameter_list|)
function_decl|;
name|QString
name|runCustomRequest
parameter_list|(
specifier|const
name|QNetworkRequest
modifier|&
name|request
parameter_list|,
name|QNetworkReplyPtr
modifier|&
name|reply
parameter_list|,
specifier|const
name|QByteArray
modifier|&
name|verb
parameter_list|,
name|QIODevice
modifier|*
name|data
parameter_list|)
function_decl|;
name|int
name|waitForFinish
parameter_list|(
name|QNetworkReplyPtr
modifier|&
name|reply
parameter_list|)
function_decl|;
public|public
name|Q_SLOTS
public|:
name|void
name|finished
parameter_list|()
function_decl|;
name|void
name|gotError
parameter_list|()
function_decl|;
name|void
name|authenticationRequired
parameter_list|(
name|QNetworkReply
modifier|*
parameter_list|,
name|QAuthenticator
modifier|*
parameter_list|)
function_decl|;
name|void
name|proxyAuthenticationRequired
parameter_list|(
specifier|const
name|QNetworkProxy
modifier|&
parameter_list|,
name|QAuthenticator
modifier|*
parameter_list|)
function_decl|;
name|void
name|pipeliningHelperSlot
parameter_list|()
function_decl|;
name|void
name|emitErrorForAllRepliesSlot
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|void
name|sslErrors
parameter_list|(
name|QNetworkReply
modifier|*
parameter_list|,
specifier|const
name|QList
argument_list|<
name|QSslError
argument_list|>
modifier|&
parameter_list|)
function_decl|;
name|void
name|storeSslConfiguration
parameter_list|()
function_decl|;
name|void
name|ignoreSslErrorListSlot
parameter_list|(
name|QNetworkReply
modifier|*
name|reply
parameter_list|,
specifier|const
name|QList
argument_list|<
name|QSslError
argument_list|>
modifier|&
parameter_list|)
function_decl|;
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
name|void
name|sslSessionSharingHelperSlot
parameter_list|()
function_decl|;
endif|#
directive|endif
endif|#
directive|endif
protected|protected
name|Q_SLOTS
protected|:
name|void
name|nestedEventLoops_slot
parameter_list|()
function_decl|;
private|private
name|Q_SLOTS
private|:
name|void
name|init
parameter_list|()
function_decl|;
name|void
name|cleanup
parameter_list|()
function_decl|;
name|void
name|initTestCase
parameter_list|()
function_decl|;
name|void
name|cleanupTestCase
parameter_list|()
function_decl|;
name|void
name|stateChecking
parameter_list|()
function_decl|;
name|void
name|invalidProtocol
parameter_list|()
function_decl|;
name|void
name|getFromData_data
parameter_list|()
function_decl|;
name|void
name|getFromData
parameter_list|()
function_decl|;
name|void
name|getFromFile
parameter_list|()
function_decl|;
name|void
name|getFromFileSpecial_data
parameter_list|()
function_decl|;
name|void
name|getFromFileSpecial
parameter_list|()
function_decl|;
name|void
name|getFromFtp_data
parameter_list|()
function_decl|;
name|void
name|getFromFtp
parameter_list|()
function_decl|;
name|void
name|getFromFtpAfterError
parameter_list|()
function_decl|;
comment|// QTBUG-40797
name|void
name|getFromHttp_data
parameter_list|()
function_decl|;
name|void
name|getFromHttp
parameter_list|()
function_decl|;
name|void
name|getErrors_data
parameter_list|()
function_decl|;
name|void
name|getErrors
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
name|void
name|headFromHttp_data
parameter_list|()
function_decl|;
name|void
name|headFromHttp
parameter_list|()
function_decl|;
endif|#
directive|endif
comment|// !QT_NO_NETWORKPROXY
name|void
name|putToFile_data
parameter_list|()
function_decl|;
name|void
name|putToFile
parameter_list|()
function_decl|;
name|void
name|putToFtp_data
parameter_list|()
function_decl|;
name|void
name|putToFtp
parameter_list|()
function_decl|;
name|void
name|putToFtpWithInvalidCredentials
parameter_list|()
function_decl|;
comment|// QTBUG-40622
name|void
name|putToHttp_data
parameter_list|()
function_decl|;
name|void
name|putToHttp
parameter_list|()
function_decl|;
name|void
name|putToHttpSynchronous_data
parameter_list|()
function_decl|;
name|void
name|putToHttpSynchronous
parameter_list|()
function_decl|;
name|void
name|putToHttpMultipart_data
parameter_list|()
function_decl|;
name|void
name|putToHttpMultipart
parameter_list|()
function_decl|;
name|void
name|postToHttp_data
parameter_list|()
function_decl|;
name|void
name|postToHttp
parameter_list|()
function_decl|;
name|void
name|postToHttpSynchronous_data
parameter_list|()
function_decl|;
name|void
name|postToHttpSynchronous
parameter_list|()
function_decl|;
name|void
name|postToHttpMultipart_data
parameter_list|()
function_decl|;
name|void
name|postToHttpMultipart
parameter_list|()
function_decl|;
name|void
name|multipartSkipIndices
parameter_list|()
function_decl|;
comment|// QTBUG-32534
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|void
name|putToHttps_data
parameter_list|()
function_decl|;
name|void
name|putToHttps
parameter_list|()
function_decl|;
name|void
name|putToHttpsSynchronous_data
parameter_list|()
function_decl|;
name|void
name|putToHttpsSynchronous
parameter_list|()
function_decl|;
name|void
name|postToHttps_data
parameter_list|()
function_decl|;
name|void
name|postToHttps
parameter_list|()
function_decl|;
name|void
name|postToHttpsSynchronous_data
parameter_list|()
function_decl|;
name|void
name|postToHttpsSynchronous
parameter_list|()
function_decl|;
name|void
name|postToHttpsMultipart_data
parameter_list|()
function_decl|;
name|void
name|postToHttpsMultipart
parameter_list|()
function_decl|;
endif|#
directive|endif
name|void
name|deleteFromHttp_data
parameter_list|()
function_decl|;
name|void
name|deleteFromHttp
parameter_list|()
function_decl|;
name|void
name|putGetDeleteGetFromHttp_data
parameter_list|()
function_decl|;
name|void
name|putGetDeleteGetFromHttp
parameter_list|()
function_decl|;
name|void
name|sendCustomRequestToHttp_data
parameter_list|()
function_decl|;
name|void
name|sendCustomRequestToHttp
parameter_list|()
function_decl|;
name|void
name|connectToIPv6Address_data
parameter_list|()
function_decl|;
name|void
name|connectToIPv6Address
parameter_list|()
function_decl|;
name|void
name|ioGetFromData_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromData
parameter_list|()
function_decl|;
name|void
name|ioGetFromFileSpecial_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromFileSpecial
parameter_list|()
function_decl|;
name|void
name|ioGetFromFile_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromFile
parameter_list|()
function_decl|;
name|void
name|ioGetFromFtp_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromFtp
parameter_list|()
function_decl|;
name|void
name|ioGetFromFtpWithReuse
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttp
parameter_list|()
function_decl|;
name|void
name|ioGetFromBuiltinHttp_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromBuiltinHttp
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithReuseParallel
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithReuseSequential
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithAuth_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithAuth
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithAuthSynchronous
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
name|void
name|ioGetFromHttpWithProxyAuth
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithProxyAuthSynchronous
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithSocksProxy
parameter_list|()
function_decl|;
endif|#
directive|endif
comment|// !QT_NO_NETWORKPROXY
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|void
name|ioGetFromHttpsWithSslErrors
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpsWithIgnoreSslErrors
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpsWithSslHandshakeError
parameter_list|()
function_decl|;
endif|#
directive|endif
name|void
name|ioGetFromHttpBrokenServer_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpBrokenServer
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpStatus100_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpStatus100
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpNoHeaders_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpNoHeaders
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithCache_data
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithCache
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
name|void
name|ioGetWithManyProxies_data
parameter_list|()
function_decl|;
name|void
name|ioGetWithManyProxies
parameter_list|()
function_decl|;
endif|#
directive|endif
comment|// !QT_NO_NETWORKPROXY
name|void
name|ioPutToFileFromFile_data
parameter_list|()
function_decl|;
name|void
name|ioPutToFileFromFile
parameter_list|()
function_decl|;
name|void
name|ioPutToFileFromSocket_data
parameter_list|()
function_decl|;
name|void
name|ioPutToFileFromSocket
parameter_list|()
function_decl|;
name|void
name|ioPutToFileFromLocalSocket_data
parameter_list|()
function_decl|;
name|void
name|ioPutToFileFromLocalSocket
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_PROCESS
name|void
name|ioPutToFileFromProcess_data
parameter_list|()
function_decl|;
name|void
name|ioPutToFileFromProcess
parameter_list|()
function_decl|;
endif|#
directive|endif
name|void
name|ioPutToFtpFromFile_data
parameter_list|()
function_decl|;
name|void
name|ioPutToFtpFromFile
parameter_list|()
function_decl|;
name|void
name|ioPutToHttpFromFile_data
parameter_list|()
function_decl|;
name|void
name|ioPutToHttpFromFile
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpFromFile_data
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpFromFile
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
name|void
name|ioPostToHttpFromSocket_data
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpFromSocket
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpFromSocketSynchronous
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpFromSocketSynchronous_data
parameter_list|()
function_decl|;
endif|#
directive|endif
comment|// !QT_NO_NETWORKPROXY
name|void
name|ioPostToHttpFromMiddleOfFileToEnd
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpFromMiddleOfFileFiveBytes
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpFromMiddleOfQBufferFiveBytes
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpNoBufferFlag
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpUploadProgress
parameter_list|()
function_decl|;
name|void
name|ioPostToHttpEmptyUploadProgress
parameter_list|()
function_decl|;
name|void
name|lastModifiedHeaderForFile
parameter_list|()
function_decl|;
name|void
name|lastModifiedHeaderForHttp
parameter_list|()
function_decl|;
name|void
name|httpCanReadLine
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
name|void
name|rateControl_data
parameter_list|()
function_decl|;
name|void
name|rateControl
parameter_list|()
function_decl|;
endif|#
directive|endif
name|void
name|downloadProgress_data
parameter_list|()
function_decl|;
name|void
name|downloadProgress
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
name|void
name|uploadProgress_data
parameter_list|()
function_decl|;
name|void
name|uploadProgress
parameter_list|()
function_decl|;
endif|#
directive|endif
name|void
name|chaining_data
parameter_list|()
function_decl|;
name|void
name|chaining
parameter_list|()
function_decl|;
name|void
name|receiveCookiesFromHttp_data
parameter_list|()
function_decl|;
name|void
name|receiveCookiesFromHttp
parameter_list|()
function_decl|;
name|void
name|receiveCookiesFromHttpSynchronous_data
parameter_list|()
function_decl|;
name|void
name|receiveCookiesFromHttpSynchronous
parameter_list|()
function_decl|;
name|void
name|sendCookies_data
parameter_list|()
function_decl|;
name|void
name|sendCookies
parameter_list|()
function_decl|;
name|void
name|sendCookiesSynchronous_data
parameter_list|()
function_decl|;
name|void
name|sendCookiesSynchronous
parameter_list|()
function_decl|;
name|void
name|nestedEventLoops
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
name|void
name|httpProxyCommands_data
parameter_list|()
function_decl|;
name|void
name|httpProxyCommands
parameter_list|()
function_decl|;
name|void
name|httpProxyCommandsSynchronous_data
parameter_list|()
function_decl|;
name|void
name|httpProxyCommandsSynchronous
parameter_list|()
function_decl|;
name|void
name|proxyChange
parameter_list|()
function_decl|;
endif|#
directive|endif
comment|// !QT_NO_NETWORKPROXY
name|void
name|authorizationError_data
parameter_list|()
function_decl|;
name|void
name|authorizationError
parameter_list|()
function_decl|;
name|void
name|httpConnectionCount
parameter_list|()
function_decl|;
name|void
name|httpReUsingConnectionSequential_data
parameter_list|()
function_decl|;
name|void
name|httpReUsingConnectionSequential
parameter_list|()
function_decl|;
name|void
name|httpReUsingConnectionFromFinishedSlot_data
parameter_list|()
function_decl|;
name|void
name|httpReUsingConnectionFromFinishedSlot
parameter_list|()
function_decl|;
name|void
name|httpRecursiveCreation
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|void
name|ioPostToHttpsUploadProgress
parameter_list|()
function_decl|;
name|void
name|ignoreSslErrorsList_data
parameter_list|()
function_decl|;
name|void
name|ignoreSslErrorsList
parameter_list|()
function_decl|;
name|void
name|ignoreSslErrorsListWithSlot_data
parameter_list|()
function_decl|;
name|void
name|ignoreSslErrorsListWithSlot
parameter_list|()
function_decl|;
name|void
name|encrypted
parameter_list|()
function_decl|;
name|void
name|sslConfiguration_data
parameter_list|()
function_decl|;
name|void
name|sslConfiguration
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
name|void
name|sslSessionSharing_data
parameter_list|()
function_decl|;
name|void
name|sslSessionSharing
parameter_list|()
function_decl|;
name|void
name|sslSessionSharingFromPersistentSession_data
parameter_list|()
function_decl|;
name|void
name|sslSessionSharingFromPersistentSession
parameter_list|()
function_decl|;
endif|#
directive|endif
endif|#
directive|endif
name|void
name|getAndThenDeleteObject_data
parameter_list|()
function_decl|;
name|void
name|getAndThenDeleteObject
parameter_list|()
function_decl|;
name|void
name|symbianOpenCDataUrlCrash
parameter_list|()
function_decl|;
name|void
name|getFromHttpIntoBuffer_data
parameter_list|()
function_decl|;
name|void
name|getFromHttpIntoBuffer
parameter_list|()
function_decl|;
name|void
name|getFromHttpIntoBuffer2_data
parameter_list|()
function_decl|;
name|void
name|getFromHttpIntoBuffer2
parameter_list|()
function_decl|;
name|void
name|getFromHttpIntoBufferCanReadLine
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpWithoutContentLength
parameter_list|()
function_decl|;
name|void
name|ioGetFromHttpBrokenChunkedEncoding
parameter_list|()
function_decl|;
name|void
name|qtbug12908compressedHttpReply
parameter_list|()
function_decl|;
name|void
name|compressedHttpReplyBrokenGzip
parameter_list|()
function_decl|;
name|void
name|getFromUnreachableIp
parameter_list|()
function_decl|;
name|void
name|qtbug4121unknownAuthentication
parameter_list|()
function_decl|;
name|void
name|qtbug13431replyThrottling
parameter_list|()
function_decl|;
name|void
name|httpWithNoCredentialUsage
parameter_list|()
function_decl|;
name|void
name|qtbug15311doubleContentLength
parameter_list|()
function_decl|;
name|void
name|qtbug18232gzipContentLengthZero
parameter_list|()
function_decl|;
name|void
name|qtbug22660gzipNoContentLengthEmptyContent
parameter_list|()
function_decl|;
name|void
name|qtbug27161httpHeaderMayBeDamaged_data
parameter_list|()
function_decl|;
name|void
name|qtbug27161httpHeaderMayBeDamaged
parameter_list|()
function_decl|;
name|void
name|qtbug28035browserDoesNotLoadQtProjectOrgCorrectly
parameter_list|()
function_decl|;
name|void
name|synchronousRequest_data
parameter_list|()
function_decl|;
name|void
name|synchronousRequest
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|void
name|synchronousRequestSslFailure
parameter_list|()
function_decl|;
endif|#
directive|endif
name|void
name|httpAbort
parameter_list|()
function_decl|;
name|void
name|dontInsertPartialContentIntoTheCache
parameter_list|()
function_decl|;
name|void
name|httpUserAgent
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
name|void
name|authenticationCacheAfterCancel_data
parameter_list|()
function_decl|;
name|void
name|authenticationCacheAfterCancel
parameter_list|()
function_decl|;
name|void
name|authenticationWithDifferentRealm
parameter_list|()
function_decl|;
endif|#
directive|endif
comment|// !QT_NO_NETWORKPROXY
name|void
name|synchronousAuthenticationCache
parameter_list|()
function_decl|;
name|void
name|pipelining
parameter_list|()
function_decl|;
name|void
name|closeDuringDownload_data
parameter_list|()
function_decl|;
name|void
name|closeDuringDownload
parameter_list|()
function_decl|;
name|void
name|ftpAuthentication_data
parameter_list|()
function_decl|;
name|void
name|ftpAuthentication
parameter_list|()
function_decl|;
name|void
name|emitErrorForAllReplies
parameter_list|()
function_decl|;
comment|// QTBUG-36890
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
name|void
name|backgroundRequest_data
parameter_list|()
function_decl|;
name|void
name|backgroundRequest
parameter_list|()
function_decl|;
name|void
name|backgroundRequestInterruption_data
parameter_list|()
function_decl|;
name|void
name|backgroundRequestInterruption
parameter_list|()
function_decl|;
name|void
name|backgroundRequestConnectInBackground_data
parameter_list|()
function_decl|;
name|void
name|backgroundRequestConnectInBackground
parameter_list|()
function_decl|;
endif|#
directive|endif
name|void
name|putWithRateLimiting
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|void
name|putWithServerClosingConnectionImmediately
parameter_list|()
function_decl|;
endif|#
directive|endif
comment|// NOTE: This test must be last!
name|void
name|parentingRepliesToTheApp
parameter_list|()
function_decl|;
private|private:
DECL|member|testDataDir
name|QString
name|testDataDir
decl_stmt|;
block|}
class|;
end_class
begin_decl_stmt
DECL|member|seedCreated
name|bool
name|tst_QNetworkReply
operator|::
name|seedCreated
init|=
literal|false
decl_stmt|;
end_decl_stmt
begin_macro
name|QT_BEGIN_NAMESPACE
end_macro
begin_namespace
DECL|namespace|QTest
namespace|namespace
name|QTest
block|{
template|template
parameter_list|<>
DECL|function|toString
name|char
modifier|*
name|toString
parameter_list|(
specifier|const
name|QNetworkReply
operator|::
name|NetworkError
modifier|&
name|code
parameter_list|)
block|{
specifier|const
name|QMetaObject
modifier|*
name|mo
init|=
operator|&
name|QNetworkReply
operator|::
name|staticMetaObject
decl_stmt|;
name|int
name|index
init|=
name|mo
operator|->
name|indexOfEnumerator
argument_list|(
literal|"NetworkError"
argument_list|)
decl_stmt|;
if|if
condition|(
name|index
operator|==
operator|-
literal|1
condition|)
return|return
name|qstrdup
argument_list|(
literal|""
argument_list|)
return|;
name|QMetaEnum
name|qme
init|=
name|mo
operator|->
name|enumerator
argument_list|(
name|index
argument_list|)
decl_stmt|;
return|return
name|qstrdup
argument_list|(
name|qme
operator|.
name|valueToKey
argument_list|(
name|code
argument_list|)
argument_list|)
return|;
block|}
template|template
parameter_list|<>
DECL|function|toString
name|char
modifier|*
name|toString
parameter_list|(
specifier|const
name|QNetworkCookie
modifier|&
name|cookie
parameter_list|)
block|{
return|return
name|qstrdup
argument_list|(
name|cookie
operator|.
name|toRawForm
argument_list|()
argument_list|)
return|;
block|}
template|template
parameter_list|<>
DECL|function|toString
name|char
modifier|*
name|toString
parameter_list|(
specifier|const
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
modifier|&
name|list
parameter_list|)
block|{
name|QString
name|result
init|=
literal|"QList("
decl_stmt|;
name|bool
name|first
init|=
literal|true
decl_stmt|;
foreach|foreach
control|(
name|QNetworkCookie
name|cookie
decl|,
name|list
control|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
name|result
operator|+=
literal|", "
expr_stmt|;
name|first
operator|=
literal|false
expr_stmt|;
name|result
operator|+=
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"QNetworkCookie(%1)"
argument_list|)
operator|.
name|arg
argument_list|(
name|QLatin1String
argument_list|(
name|cookie
operator|.
name|toRawForm
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|qstrdup
argument_list|(
name|result
operator|.
name|append
argument_list|(
literal|')'
argument_list|)
operator|.
name|toLocal8Bit
argument_list|()
argument_list|)
return|;
block|}
block|}
end_namespace
begin_function
name|QT_END_NAMESPACE
DECL|macro|RUN_REQUEST
define|#
directive|define
name|RUN_REQUEST
parameter_list|(
name|call
parameter_list|)
define|\
value|do {                                        \         QString errorMsg = call;                \         if (!errorMsg.isEmpty())                \             QFAIL(qPrintable(errorMsg));        \     } while (0);
ifndef|#
directive|ifndef
name|QT_NO_SSL
DECL|function|setupSslServer
specifier|static
name|void
name|setupSslServer
parameter_list|(
name|QSslSocket
modifier|*
name|serverSocket
parameter_list|)
block|{
name|QString
name|testDataDir
init|=
name|QFileInfo
argument_list|(
name|QFINDTESTDATA
argument_list|(
literal|"rfc3252.txt"
argument_list|)
argument_list|)
operator|.
name|absolutePath
argument_list|()
decl_stmt|;
if|if
condition|(
name|testDataDir
operator|.
name|isEmpty
argument_list|()
condition|)
name|testDataDir
operator|=
name|QCoreApplication
operator|::
name|applicationDirPath
argument_list|()
expr_stmt|;
name|serverSocket
operator|->
name|setProtocol
argument_list|(
name|QSsl
operator|::
name|AnyProtocol
argument_list|)
expr_stmt|;
name|serverSocket
operator|->
name|setLocalCertificate
argument_list|(
name|testDataDir
operator|+
literal|"/certs/server.pem"
argument_list|)
expr_stmt|;
name|serverSocket
operator|->
name|setPrivateKey
argument_list|(
name|testDataDir
operator|+
literal|"/certs/server.key"
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// Does not work for POST/PUT!
end_comment
begin_class
DECL|class|MiniHttpServer
class|class
name|MiniHttpServer
super|:
specifier|public
name|QTcpServer
block|{
name|Q_OBJECT
public|public:
DECL|member|client
name|QPointer
argument_list|<
name|QTcpSocket
argument_list|>
name|client
decl_stmt|;
comment|// always the last one that was received
DECL|member|dataToTransmit
name|QByteArray
name|dataToTransmit
decl_stmt|;
DECL|member|receivedData
name|QByteArray
name|receivedData
decl_stmt|;
DECL|member|ready
name|QSemaphore
name|ready
decl_stmt|;
DECL|member|doClose
name|bool
name|doClose
decl_stmt|;
DECL|member|doSsl
name|bool
name|doSsl
decl_stmt|;
DECL|member|ipv6
name|bool
name|ipv6
decl_stmt|;
DECL|member|multiple
name|bool
name|multiple
decl_stmt|;
DECL|member|totalConnections
name|int
name|totalConnections
decl_stmt|;
DECL|function|MiniHttpServer
name|MiniHttpServer
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|data
parameter_list|,
name|bool
name|ssl
init|=
literal|false
parameter_list|,
name|QThread
modifier|*
name|thread
init|=
literal|0
parameter_list|,
name|bool
name|useipv6
init|=
literal|false
parameter_list|)
member_init_list|:
name|dataToTransmit
argument_list|(
name|data
argument_list|)
member_init_list|,
name|doClose
argument_list|(
literal|true
argument_list|)
member_init_list|,
name|doSsl
argument_list|(
name|ssl
argument_list|)
member_init_list|,
name|ipv6
argument_list|(
name|useipv6
argument_list|)
member_init_list|,
name|multiple
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|totalConnections
argument_list|(
literal|0
argument_list|)
block|{
if|if
condition|(
name|useipv6
condition|)
block|{
if|if
condition|(
operator|!
name|listen
argument_list|(
name|QHostAddress
operator|::
name|AnyIPv6
argument_list|)
condition|)
name|qWarning
argument_list|()
operator|<<
literal|"listen() IPv6 failed"
operator|<<
name|errorString
argument_list|()
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|listen
argument_list|(
name|QHostAddress
operator|::
name|AnyIPv4
argument_list|)
condition|)
name|qWarning
argument_list|()
operator|<<
literal|"listen() IPv4 failed"
operator|<<
name|errorString
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|thread
condition|)
block|{
name|connect
argument_list|(
name|thread
argument_list|,
name|SIGNAL
argument_list|(
name|started
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|threadStartedSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|moveToThread
argument_list|(
name|thread
argument_list|)
expr_stmt|;
name|thread
operator|->
name|start
argument_list|()
expr_stmt|;
name|ready
operator|.
name|acquire
argument_list|()
expr_stmt|;
block|}
block|}
DECL|function|setDataToTransmit
name|void
name|setDataToTransmit
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|data
parameter_list|)
block|{
name|dataToTransmit
operator|=
name|data
expr_stmt|;
block|}
protected|protected:
DECL|function|incomingConnection
name|void
name|incomingConnection
parameter_list|(
name|qintptr
name|socketDescriptor
parameter_list|)
block|{
comment|//qDebug()<< "incomingConnection"<< socketDescriptor<< "doSsl:"<< doSsl<< "ipv6:"<< ipv6;
if|if
condition|(
operator|!
name|doSsl
condition|)
block|{
name|client
operator|=
operator|new
name|QTcpSocket
expr_stmt|;
name|client
operator|->
name|setSocketDescriptor
argument_list|(
name|socketDescriptor
argument_list|)
expr_stmt|;
name|connectSocketSignals
argument_list|()
expr_stmt|;
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|QSslSocket
modifier|*
name|serverSocket
init|=
operator|new
name|QSslSocket
decl_stmt|;
name|serverSocket
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
if|if
condition|(
name|serverSocket
operator|->
name|setSocketDescriptor
argument_list|(
name|socketDescriptor
argument_list|)
condition|)
block|{
name|connect
argument_list|(
name|serverSocket
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|slotSslErrors
argument_list|(
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|setupSslServer
argument_list|(
name|serverSocket
argument_list|)
expr_stmt|;
name|serverSocket
operator|->
name|startServerEncryption
argument_list|()
expr_stmt|;
name|client
operator|=
name|serverSocket
expr_stmt|;
name|connectSocketSignals
argument_list|()
expr_stmt|;
block|}
else|else
block|{
operator|delete
name|serverSocket
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
block|}
name|client
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
operator|++
name|totalConnections
expr_stmt|;
block|}
DECL|function|reply
specifier|virtual
name|void
name|reply
parameter_list|()
block|{
name|Q_ASSERT
argument_list|(
operator|!
name|client
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
comment|// we need to emulate the bytesWrittenSlot call if the data is empty.
if|if
condition|(
name|dataToTransmit
operator|.
name|size
argument_list|()
operator|==
literal|0
condition|)
name|QMetaObject
operator|::
name|invokeMethod
argument_list|(
name|this
argument_list|,
literal|"bytesWrittenSlot"
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
else|else
name|client
operator|->
name|write
argument_list|(
name|dataToTransmit
argument_list|)
expr_stmt|;
block|}
private|private:
DECL|function|connectSocketSignals
name|void
name|connectSocketSignals
parameter_list|()
block|{
name|Q_ASSERT
argument_list|(
operator|!
name|client
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
comment|//qDebug()<< "connectSocketSignals"<< client;
name|connect
argument_list|(
name|client
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|readyReadSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|client
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|bytesWritten
argument_list|(
name|qint64
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|bytesWrittenSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|client
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QAbstractSocket
operator|::
name|SocketError
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|slotError
argument_list|(
name|QAbstractSocket
operator|::
name|SocketError
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
private|private
name|slots
private|:
ifndef|#
directive|ifndef
name|QT_NO_SSL
DECL|function|slotSslErrors
name|void
name|slotSslErrors
parameter_list|(
specifier|const
name|QList
argument_list|<
name|QSslError
argument_list|>
modifier|&
name|errors
parameter_list|)
block|{
name|Q_ASSERT
argument_list|(
operator|!
name|client
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"slotSslErrors"
operator|<<
name|client
operator|->
name|errorString
argument_list|()
operator|<<
name|errors
expr_stmt|;
block|}
endif|#
directive|endif
DECL|function|slotError
name|void
name|slotError
parameter_list|(
name|QAbstractSocket
operator|::
name|SocketError
name|err
parameter_list|)
block|{
name|Q_ASSERT
argument_list|(
operator|!
name|client
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"slotError"
operator|<<
name|err
operator|<<
name|client
operator|->
name|errorString
argument_list|()
expr_stmt|;
block|}
public|public
name|slots
public|:
DECL|function|readyReadSlot
name|void
name|readyReadSlot
parameter_list|()
block|{
name|Q_ASSERT
argument_list|(
operator|!
name|client
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
name|receivedData
operator|+=
name|client
operator|->
name|readAll
argument_list|()
expr_stmt|;
name|int
name|doubleEndlPos
init|=
name|receivedData
operator|.
name|indexOf
argument_list|(
literal|"\r\n\r\n"
argument_list|)
decl_stmt|;
if|if
condition|(
name|doubleEndlPos
operator|!=
operator|-
literal|1
condition|)
block|{
comment|// multiple requests incoming. remove the bytes of the current one
if|if
condition|(
name|multiple
condition|)
name|receivedData
operator|.
name|remove
argument_list|(
literal|0
argument_list|,
name|doubleEndlPos
operator|+
literal|4
argument_list|)
expr_stmt|;
name|reply
argument_list|()
expr_stmt|;
block|}
block|}
DECL|function|bytesWrittenSlot
name|void
name|bytesWrittenSlot
parameter_list|()
block|{
name|Q_ASSERT
argument_list|(
operator|!
name|client
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
comment|// Disconnect and delete in next cycle (else Windows clients will fail with RemoteHostClosedError).
if|if
condition|(
name|doClose
operator|&&
name|client
operator|->
name|bytesToWrite
argument_list|()
operator|==
literal|0
condition|)
block|{
name|disconnect
argument_list|(
name|client
argument_list|,
literal|0
argument_list|,
name|this
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|client
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
block|}
block|}
DECL|function|threadStartedSlot
name|void
name|threadStartedSlot
parameter_list|()
block|{
name|ready
operator|.
name|release
argument_list|()
expr_stmt|;
block|}
block|}
class|;
end_class
begin_class
DECL|class|MyCookieJar
class|class
name|MyCookieJar
super|:
specifier|public
name|QNetworkCookieJar
block|{
public|public:
DECL|function|allCookies
specifier|inline
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
name|allCookies
parameter_list|()
specifier|const
block|{
return|return
name|QNetworkCookieJar
operator|::
name|allCookies
argument_list|()
return|;
block|}
DECL|function|setAllCookies
specifier|inline
name|void
name|setAllCookies
parameter_list|(
specifier|const
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
modifier|&
name|cookieList
parameter_list|)
block|{
name|QNetworkCookieJar
operator|::
name|setAllCookies
argument_list|(
name|cookieList
argument_list|)
expr_stmt|;
block|}
block|}
class|;
end_class
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
end_ifndef
begin_class
DECL|class|MyProxyFactory
class|class
name|MyProxyFactory
super|:
specifier|public
name|QNetworkProxyFactory
block|{
public|public:
DECL|member|callCount
name|int
name|callCount
decl_stmt|;
DECL|member|toReturn
name|QList
argument_list|<
name|QNetworkProxy
argument_list|>
name|toReturn
decl_stmt|;
DECL|member|lastQuery
name|QNetworkProxyQuery
name|lastQuery
decl_stmt|;
DECL|function|MyProxyFactory
specifier|inline
name|MyProxyFactory
parameter_list|()
block|{
name|clear
argument_list|()
expr_stmt|;
block|}
DECL|function|clear
specifier|inline
name|void
name|clear
parameter_list|()
block|{
name|callCount
operator|=
literal|0
expr_stmt|;
name|toReturn
operator|=
name|QList
argument_list|<
name|QNetworkProxy
argument_list|>
argument_list|()
operator|<<
name|QNetworkProxy
operator|::
name|DefaultProxy
expr_stmt|;
name|lastQuery
operator|=
name|QNetworkProxyQuery
argument_list|()
expr_stmt|;
block|}
DECL|function|queryProxy
specifier|virtual
name|QList
argument_list|<
name|QNetworkProxy
argument_list|>
name|queryProxy
parameter_list|(
specifier|const
name|QNetworkProxyQuery
modifier|&
name|query
parameter_list|)
block|{
name|lastQuery
operator|=
name|query
expr_stmt|;
operator|++
name|callCount
expr_stmt|;
return|return
name|toReturn
return|;
block|}
block|}
class|;
end_class
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !QT_NO_NETWORKPROXY
end_comment
begin_class
DECL|class|MyMemoryCache
class|class
name|MyMemoryCache
super|:
specifier|public
name|QAbstractNetworkCache
block|{
public|public:
DECL|typedef|CachedContent
typedef|typedef
name|QPair
argument_list|<
name|QNetworkCacheMetaData
argument_list|,
name|QByteArray
argument_list|>
name|CachedContent
typedef|;
DECL|typedef|CacheData
typedef|typedef
name|QHash
argument_list|<
name|QByteArray
argument_list|,
name|CachedContent
argument_list|>
name|CacheData
typedef|;
DECL|member|cache
name|CacheData
name|cache
decl_stmt|;
DECL|function|MyMemoryCache
name|MyMemoryCache
parameter_list|(
name|QObject
modifier|*
name|parent
parameter_list|)
member_init_list|:
name|QAbstractNetworkCache
argument_list|(
name|parent
argument_list|)
block|{}
DECL|function|metaData
name|QNetworkCacheMetaData
name|metaData
parameter_list|(
specifier|const
name|QUrl
modifier|&
name|url
parameter_list|)
block|{
return|return
name|cache
operator|.
name|value
argument_list|(
name|url
operator|.
name|toEncoded
argument_list|()
argument_list|)
operator|.
name|first
return|;
block|}
DECL|function|updateMetaData
name|void
name|updateMetaData
parameter_list|(
specifier|const
name|QNetworkCacheMetaData
modifier|&
name|metaData
parameter_list|)
block|{
name|cache
index|[
name|metaData
operator|.
name|url
argument_list|()
operator|.
name|toEncoded
argument_list|()
index|]
operator|.
name|first
operator|=
name|metaData
expr_stmt|;
block|}
DECL|function|data
name|QIODevice
modifier|*
name|data
parameter_list|(
specifier|const
name|QUrl
modifier|&
name|url
parameter_list|)
block|{
name|CacheData
operator|::
name|ConstIterator
name|it
init|=
name|cache
operator|.
name|find
argument_list|(
name|url
operator|.
name|toEncoded
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|it
operator|==
name|cache
operator|.
name|constEnd
argument_list|()
condition|)
return|return
literal|0
return|;
name|QBuffer
modifier|*
name|io
init|=
operator|new
name|QBuffer
argument_list|(
name|this
argument_list|)
decl_stmt|;
name|io
operator|->
name|setData
argument_list|(
name|it
operator|->
name|second
argument_list|)
expr_stmt|;
name|io
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|io
operator|->
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|io
return|;
block|}
DECL|function|remove
name|bool
name|remove
parameter_list|(
specifier|const
name|QUrl
modifier|&
name|url
parameter_list|)
block|{
name|cache
operator|.
name|remove
argument_list|(
name|url
operator|.
name|toEncoded
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
DECL|function|cacheSize
name|qint64
name|cacheSize
parameter_list|()
specifier|const
block|{
name|qint64
name|total
init|=
literal|0
decl_stmt|;
foreach|foreach
control|(
specifier|const
name|CachedContent
modifier|&
name|entry
decl|,
name|cache
control|)
name|total
operator|+=
name|entry
operator|.
name|second
operator|.
name|size
argument_list|()
expr_stmt|;
return|return
name|total
return|;
block|}
DECL|function|prepare
name|QIODevice
modifier|*
name|prepare
parameter_list|(
specifier|const
name|QNetworkCacheMetaData
modifier|&
parameter_list|)
block|{
name|qFatal
argument_list|(
literal|"%s: Should not have tried to add to the cache"
argument_list|,
name|Q_FUNC_INFO
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
DECL|function|insert
name|void
name|insert
parameter_list|(
name|QIODevice
modifier|*
parameter_list|)
block|{
name|qFatal
argument_list|(
literal|"%s: Should not have tried to add to the cache"
argument_list|,
name|Q_FUNC_INFO
argument_list|)
expr_stmt|;
block|}
DECL|function|clear
name|void
name|clear
parameter_list|()
block|{
name|cache
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
block|}
class|;
end_class
begin_macro
name|Q_DECLARE_METATYPE
argument_list|(
argument|MyMemoryCache::CachedContent
argument_list|)
end_macro
begin_macro
name|Q_DECLARE_METATYPE
argument_list|(
argument|MyMemoryCache::CacheData
argument_list|)
end_macro
begin_class
DECL|class|MySpyMemoryCache
class|class
name|MySpyMemoryCache
super|:
specifier|public
name|QAbstractNetworkCache
block|{
public|public:
DECL|function|MySpyMemoryCache
name|MySpyMemoryCache
parameter_list|(
name|QObject
modifier|*
name|parent
parameter_list|)
member_init_list|:
name|QAbstractNetworkCache
argument_list|(
name|parent
argument_list|)
block|{}
DECL|function|~MySpyMemoryCache
name|~
name|MySpyMemoryCache
parameter_list|()
block|{
name|qDeleteAll
argument_list|(
name|m_buffers
argument_list|)
expr_stmt|;
name|m_buffers
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
DECL|member|m_buffers
name|QHash
argument_list|<
name|QUrl
argument_list|,
name|QIODevice
modifier|*
argument_list|>
name|m_buffers
decl_stmt|;
DECL|member|m_insertedUrls
name|QList
argument_list|<
name|QUrl
argument_list|>
name|m_insertedUrls
decl_stmt|;
DECL|function|metaData
name|QNetworkCacheMetaData
name|metaData
parameter_list|(
specifier|const
name|QUrl
modifier|&
parameter_list|)
block|{
return|return
name|QNetworkCacheMetaData
argument_list|()
return|;
block|}
DECL|function|updateMetaData
name|void
name|updateMetaData
parameter_list|(
specifier|const
name|QNetworkCacheMetaData
modifier|&
parameter_list|)
block|{     }
DECL|function|data
name|QIODevice
modifier|*
name|data
parameter_list|(
specifier|const
name|QUrl
modifier|&
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
DECL|function|remove
name|bool
name|remove
parameter_list|(
specifier|const
name|QUrl
modifier|&
name|url
parameter_list|)
block|{
operator|delete
name|m_buffers
operator|.
name|take
argument_list|(
name|url
argument_list|)
expr_stmt|;
return|return
name|m_insertedUrls
operator|.
name|removeAll
argument_list|(
name|url
argument_list|)
operator|>
literal|0
return|;
block|}
DECL|function|cacheSize
name|qint64
name|cacheSize
parameter_list|()
specifier|const
block|{
return|return
literal|0
return|;
block|}
DECL|function|prepare
name|QIODevice
modifier|*
name|prepare
parameter_list|(
specifier|const
name|QNetworkCacheMetaData
modifier|&
name|metaData
parameter_list|)
block|{
name|QBuffer
modifier|*
name|buffer
init|=
operator|new
name|QBuffer
decl_stmt|;
name|buffer
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadWrite
argument_list|)
expr_stmt|;
name|buffer
operator|->
name|setProperty
argument_list|(
literal|"url"
argument_list|,
name|metaData
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|m_buffers
operator|.
name|insert
argument_list|(
name|metaData
operator|.
name|url
argument_list|()
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
DECL|function|insert
name|void
name|insert
parameter_list|(
name|QIODevice
modifier|*
name|buffer
parameter_list|)
block|{
name|QUrl
name|url
init|=
name|buffer
operator|->
name|property
argument_list|(
literal|"url"
argument_list|)
operator|.
name|toUrl
argument_list|()
decl_stmt|;
name|m_insertedUrls
operator|<<
name|url
expr_stmt|;
operator|delete
name|m_buffers
operator|.
name|take
argument_list|(
name|url
argument_list|)
expr_stmt|;
block|}
DECL|function|clear
name|void
name|clear
parameter_list|()
block|{
name|m_insertedUrls
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
block|}
class|;
end_class
begin_class
DECL|class|DataReader
class|class
name|DataReader
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|member|totalBytes
name|qint64
name|totalBytes
decl_stmt|;
DECL|member|data
name|QByteArray
name|data
decl_stmt|;
DECL|member|device
name|QIODevice
modifier|*
name|device
decl_stmt|;
DECL|member|accumulate
name|bool
name|accumulate
decl_stmt|;
DECL|function|DataReader
name|DataReader
parameter_list|(
specifier|const
name|QNetworkReplyPtr
modifier|&
name|dev
parameter_list|,
name|bool
name|acc
init|=
literal|true
parameter_list|)
member_init_list|:
name|totalBytes
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|device
argument_list|(
name|dev
operator|.
name|data
argument_list|()
argument_list|)
member_init_list|,
name|accumulate
argument_list|(
name|acc
argument_list|)
block|{
name|connect
argument_list|(
name|device
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|doRead
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|function|DataReader
name|DataReader
parameter_list|(
name|QIODevice
modifier|*
name|dev
parameter_list|,
name|bool
name|acc
init|=
literal|true
parameter_list|)
member_init_list|:
name|totalBytes
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|device
argument_list|(
name|dev
argument_list|)
member_init_list|,
name|accumulate
argument_list|(
name|acc
argument_list|)
block|{
name|connect
argument_list|(
name|device
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|doRead
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
public|public
name|slots
public|:
DECL|function|doRead
name|void
name|doRead
parameter_list|()
block|{
name|QByteArray
name|buffer
decl_stmt|;
name|buffer
operator|.
name|resize
argument_list|(
name|device
operator|->
name|bytesAvailable
argument_list|()
argument_list|)
expr_stmt|;
name|qint64
name|bytesRead
init|=
name|device
operator|->
name|read
argument_list|(
name|buffer
operator|.
name|data
argument_list|()
argument_list|,
name|device
operator|->
name|bytesAvailable
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|bytesRead
operator|==
operator|-
literal|1
condition|)
block|{
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|exitLoop
argument_list|()
expr_stmt|;
return|return;
block|}
name|buffer
operator|.
name|truncate
argument_list|(
name|bytesRead
argument_list|)
expr_stmt|;
name|totalBytes
operator|+=
name|bytesRead
expr_stmt|;
if|if
condition|(
name|accumulate
condition|)
name|data
operator|+=
name|buffer
expr_stmt|;
block|}
block|}
class|;
end_class
begin_class
DECL|class|SocketPair
class|class
name|SocketPair
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|member|endPoints
name|QIODevice
modifier|*
name|endPoints
index|[
literal|2
index|]
decl_stmt|;
DECL|function|SocketPair
name|SocketPair
parameter_list|(
name|QObject
modifier|*
name|parent
init|=
literal|0
parameter_list|)
member_init_list|:
name|QObject
argument_list|(
name|parent
argument_list|)
block|{
name|endPoints
index|[
literal|0
index|]
operator|=
name|endPoints
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
DECL|function|create
name|bool
name|create
parameter_list|()
block|{
name|QTcpServer
name|server
decl_stmt|;
name|server
operator|.
name|listen
argument_list|()
expr_stmt|;
name|QTcpSocket
modifier|*
name|active
init|=
operator|new
name|QTcpSocket
argument_list|(
name|this
argument_list|)
decl_stmt|;
name|active
operator|->
name|connectToHost
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
expr_stmt|;
comment|// need more time as working with embedded
comment|// device and testing from emualtor
comment|// things tend to get slower
if|if
condition|(
operator|!
name|active
operator|->
name|waitForConnected
argument_list|(
literal|1000
argument_list|)
condition|)
return|return
literal|false
return|;
if|if
condition|(
operator|!
name|server
operator|.
name|waitForNewConnection
argument_list|(
literal|1000
argument_list|)
condition|)
return|return
literal|false
return|;
name|QTcpSocket
modifier|*
name|passive
init|=
name|server
operator|.
name|nextPendingConnection
argument_list|()
decl_stmt|;
name|passive
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|endPoints
index|[
literal|0
index|]
operator|=
name|active
expr_stmt|;
name|endPoints
index|[
literal|1
index|]
operator|=
name|passive
expr_stmt|;
return|return
literal|true
return|;
block|}
block|}
class|;
end_class
begin_comment
comment|// A blocking tcp server (must be used in a thread) which supports SSL.
end_comment
begin_class
DECL|class|BlockingTcpServer
class|class
name|BlockingTcpServer
super|:
specifier|public
name|QTcpServer
block|{
name|Q_OBJECT
public|public:
DECL|function|BlockingTcpServer
name|BlockingTcpServer
parameter_list|(
name|bool
name|ssl
parameter_list|)
member_init_list|:
name|doSsl
argument_list|(
name|ssl
argument_list|)
member_init_list|,
name|sslSocket
argument_list|(
literal|0
argument_list|)
block|{}
DECL|function|waitForNextConnectionSocket
name|QTcpSocket
modifier|*
name|waitForNextConnectionSocket
parameter_list|()
block|{
name|waitForNewConnection
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|doSsl
condition|)
block|{
if|if
condition|(
operator|!
name|sslSocket
condition|)
name|qFatal
argument_list|(
literal|"%s: sslSocket should not be null after calling waitForNewConnection()"
argument_list|,
name|Q_FUNC_INFO
argument_list|)
expr_stmt|;
return|return
name|sslSocket
return|;
block|}
else|else
block|{
comment|//qDebug()<< "returning nextPendingConnection";
return|return
name|nextPendingConnection
argument_list|()
return|;
block|}
block|}
DECL|function|incomingConnection
specifier|virtual
name|void
name|incomingConnection
parameter_list|(
name|qintptr
name|socketDescriptor
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|QT_NO_SSL
if|if
condition|(
name|doSsl
condition|)
block|{
name|QSslSocket
modifier|*
name|serverSocket
init|=
operator|new
name|QSslSocket
decl_stmt|;
name|serverSocket
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|serverSocket
operator|->
name|setSocketDescriptor
argument_list|(
name|socketDescriptor
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|serverSocket
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|slotSslErrors
argument_list|(
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|setupSslServer
argument_list|(
name|serverSocket
argument_list|)
expr_stmt|;
name|serverSocket
operator|->
name|startServerEncryption
argument_list|()
expr_stmt|;
name|sslSocket
operator|=
name|serverSocket
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|QTcpServer
operator|::
name|incomingConnection
argument_list|(
name|socketDescriptor
argument_list|)
expr_stmt|;
block|}
block|}
private|private
name|slots
private|:
ifndef|#
directive|ifndef
name|QT_NO_SSL
DECL|function|slotSslErrors
name|void
name|slotSslErrors
parameter_list|(
specifier|const
name|QList
argument_list|<
name|QSslError
argument_list|>
modifier|&
name|errors
parameter_list|)
block|{
name|qDebug
argument_list|()
operator|<<
literal|"slotSslErrors"
operator|<<
name|sslSocket
operator|->
name|errorString
argument_list|()
operator|<<
name|errors
expr_stmt|;
block|}
endif|#
directive|endif
private|private:
DECL|member|doSsl
specifier|const
name|bool
name|doSsl
decl_stmt|;
DECL|member|sslSocket
name|QTcpSocket
modifier|*
name|sslSocket
decl_stmt|;
block|}
class|;
end_class
begin_comment
comment|// This server tries to send data as fast as possible (like most servers)
end_comment
begin_comment
comment|// but it measures how fast it was able to send it, which shows at which
end_comment
begin_comment
comment|// rate the reader is processing the data.
end_comment
begin_class
DECL|class|FastSender
class|class
name|FastSender
super|:
specifier|public
name|QThread
block|{
name|Q_OBJECT
DECL|member|ready
name|QSemaphore
name|ready
decl_stmt|;
DECL|member|wantedSize
name|qint64
name|wantedSize
decl_stmt|;
DECL|member|port
name|int
name|port
decl_stmt|;
DECL|enum|Protocol
DECL|enumerator|DebugPipe
DECL|enumerator|ProvidedData
enum|enum
name|Protocol
block|{
name|DebugPipe
block|,
name|ProvidedData
block|}
enum|;
DECL|member|protocol
specifier|const
name|Protocol
name|protocol
decl_stmt|;
DECL|member|doSsl
specifier|const
name|bool
name|doSsl
decl_stmt|;
DECL|member|fillKernelBuffer
specifier|const
name|bool
name|fillKernelBuffer
decl_stmt|;
public|public:
DECL|member|transferRate
name|int
name|transferRate
decl_stmt|;
DECL|member|cond
name|QWaitCondition
name|cond
decl_stmt|;
DECL|member|dataToTransmit
name|QByteArray
name|dataToTransmit
decl_stmt|;
DECL|member|dataIndex
name|int
name|dataIndex
decl_stmt|;
comment|// a server that sends debugpipe data
DECL|function|FastSender
name|FastSender
parameter_list|(
name|qint64
name|size
parameter_list|)
member_init_list|:
name|wantedSize
argument_list|(
name|size
argument_list|)
member_init_list|,
name|port
argument_list|(
operator|-
literal|1
argument_list|)
member_init_list|,
name|protocol
argument_list|(
name|DebugPipe
argument_list|)
member_init_list|,
name|doSsl
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|fillKernelBuffer
argument_list|(
literal|true
argument_list|)
member_init_list|,
name|transferRate
argument_list|(
operator|-
literal|1
argument_list|)
member_init_list|,
name|dataIndex
argument_list|(
literal|0
argument_list|)
block|{
name|start
argument_list|()
expr_stmt|;
name|ready
operator|.
name|acquire
argument_list|()
expr_stmt|;
block|}
comment|// a server that sends the data provided at construction time, useful for HTTP
DECL|function|FastSender
name|FastSender
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|data
parameter_list|,
name|bool
name|https
parameter_list|,
name|bool
name|fillBuffer
parameter_list|)
member_init_list|:
name|wantedSize
argument_list|(
name|data
operator|.
name|size
argument_list|()
argument_list|)
member_init_list|,
name|port
argument_list|(
operator|-
literal|1
argument_list|)
member_init_list|,
name|protocol
argument_list|(
name|ProvidedData
argument_list|)
member_init_list|,
name|doSsl
argument_list|(
name|https
argument_list|)
member_init_list|,
name|fillKernelBuffer
argument_list|(
name|fillBuffer
argument_list|)
member_init_list|,
name|transferRate
argument_list|(
operator|-
literal|1
argument_list|)
member_init_list|,
name|dataToTransmit
argument_list|(
name|data
argument_list|)
member_init_list|,
name|dataIndex
argument_list|(
literal|0
argument_list|)
block|{
name|start
argument_list|()
expr_stmt|;
name|ready
operator|.
name|acquire
argument_list|()
expr_stmt|;
block|}
DECL|function|serverPort
specifier|inline
name|int
name|serverPort
parameter_list|()
specifier|const
block|{
return|return
name|port
return|;
block|}
DECL|function|writeNextData
name|int
name|writeNextData
parameter_list|(
name|QTcpSocket
modifier|*
name|socket
parameter_list|,
name|qint32
name|size
parameter_list|)
block|{
if|if
condition|(
name|protocol
operator|==
name|DebugPipe
condition|)
block|{
name|QByteArray
name|data
decl_stmt|;
name|QDataStream
name|stream
argument_list|(
operator|&
name|data
argument_list|,
name|QIODevice
operator|::
name|WriteOnly
argument_list|)
decl_stmt|;
name|stream
operator|<<
name|QVariantMap
argument_list|()
operator|<<
name|QByteArray
argument_list|(
name|size
argument_list|,
literal|'a'
argument_list|)
expr_stmt|;
name|socket
operator|->
name|write
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|size
argument_list|,
sizeof|sizeof
name|size
argument_list|)
expr_stmt|;
name|socket
operator|->
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|dataIndex
operator|+=
name|size
expr_stmt|;
return|return
name|size
return|;
block|}
else|else
block|{
specifier|const
name|QByteArray
name|data
init|=
name|dataToTransmit
operator|.
name|mid
argument_list|(
name|dataIndex
argument_list|,
name|size
argument_list|)
decl_stmt|;
name|socket
operator|->
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|dataIndex
operator|+=
name|data
operator|.
name|size
argument_list|()
expr_stmt|;
comment|//qDebug()<< "wrote"<< dataIndex<< "/"<< dataToTransmit.size();
return|return
name|data
operator|.
name|size
argument_list|()
return|;
block|}
block|}
DECL|function|writeLastData
name|void
name|writeLastData
parameter_list|(
name|QTcpSocket
modifier|*
name|socket
parameter_list|)
block|{
if|if
condition|(
name|protocol
operator|==
name|DebugPipe
condition|)
block|{
name|QByteArray
name|data
decl_stmt|;
name|QDataStream
name|stream
argument_list|(
operator|&
name|data
argument_list|,
name|QIODevice
operator|::
name|WriteOnly
argument_list|)
decl_stmt|;
name|stream
operator|<<
name|QVariantMap
argument_list|()
operator|<<
name|QByteArray
argument_list|()
expr_stmt|;
specifier|const
name|qint32
name|size
init|=
name|data
operator|.
name|size
argument_list|()
decl_stmt|;
name|socket
operator|->
name|write
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|size
argument_list|,
sizeof|sizeof
name|size
argument_list|)
expr_stmt|;
name|socket
operator|->
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
block|}
protected|protected:
DECL|function|run
name|void
name|run
parameter_list|()
block|{
name|BlockingTcpServer
name|server
argument_list|(
name|doSsl
argument_list|)
decl_stmt|;
name|server
operator|.
name|listen
argument_list|()
expr_stmt|;
name|port
operator|=
name|server
operator|.
name|serverPort
argument_list|()
expr_stmt|;
name|ready
operator|.
name|release
argument_list|()
expr_stmt|;
name|QTcpSocket
modifier|*
name|client
init|=
name|server
operator|.
name|waitForNextConnectionSocket
argument_list|()
decl_stmt|;
comment|// get the "request" packet
if|if
condition|(
operator|!
name|client
operator|->
name|waitForReadyRead
argument_list|(
literal|2000
argument_list|)
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
literal|"FastSender:"
operator|<<
name|client
operator|->
name|error
argument_list|()
operator|<<
literal|"waiting for \"request\" packet"
expr_stmt|;
return|return;
block|}
name|client
operator|->
name|readAll
argument_list|()
expr_stmt|;
comment|// we're not interested in the actual contents (e.g. HTTP request)
enum|enum
block|{
name|BlockSize
init|=
literal|1024
block|}
enum|;
if|if
condition|(
name|fillKernelBuffer
condition|)
block|{
comment|// write a bunch of bytes to fill up the buffers
name|bool
name|done
init|=
literal|false
decl_stmt|;
do|do
block|{
if|if
condition|(
name|writeNextData
argument_list|(
name|client
argument_list|,
name|BlockSize
argument_list|)
operator|<
name|BlockSize
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
literal|"ERROR: FastSender: not enough data to write in order to fill buffers; or client is reading too fast"
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|client
operator|->
name|bytesToWrite
argument_list|()
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|client
operator|->
name|waitForBytesWritten
argument_list|(
literal|0
argument_list|)
condition|)
block|{
name|done
operator|=
literal|true
expr_stmt|;
break|break;
block|}
block|}
comment|//qDebug()<< "Filling kernel buffer: wrote"<< dataIndex<< "bytes";
block|}
do|while
condition|(
operator|!
name|done
condition|)
do|;
name|qDebug
argument_list|()
operator|<<
literal|"FastSender: ok, kernel buffer is full after writing"
operator|<<
name|dataIndex
operator|<<
literal|"bytes"
expr_stmt|;
block|}
comment|// Tell the client to start reading
emit|emit
name|dataReady
argument_list|()
emit|;
comment|// the kernel buffer is full
comment|// clean up QAbstractSocket's residue:
while|while
condition|(
name|client
operator|->
name|bytesToWrite
argument_list|()
operator|>
literal|0
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
literal|"Still having"
operator|<<
name|client
operator|->
name|bytesToWrite
argument_list|()
operator|<<
literal|"bytes to write, doing that now"
expr_stmt|;
if|if
condition|(
operator|!
name|client
operator|->
name|waitForBytesWritten
argument_list|(
literal|10000
argument_list|)
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
literal|"ERROR: FastSender:"
operator|<<
name|client
operator|->
name|error
argument_list|()
operator|<<
literal|"cleaning up residue"
expr_stmt|;
return|return;
block|}
block|}
comment|// now write in "blocking mode", this is where the rate measuring starts
name|QTime
name|timer
decl_stmt|;
name|timer
operator|.
name|start
argument_list|()
expr_stmt|;
comment|//const qint64 writtenBefore = dataIndex;
comment|//qint64 measuredTotalBytes = wantedSize - writtenBefore;
name|qint64
name|measuredSentBytes
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|dataIndex
operator|<
name|wantedSize
condition|)
block|{
specifier|const
name|int
name|remainingBytes
init|=
name|wantedSize
operator|-
name|measuredSentBytes
decl_stmt|;
specifier|const
name|int
name|bytesToWrite
init|=
name|qMin
argument_list|(
name|remainingBytes
argument_list|,
cast|static_cast
argument_list|<
name|int
argument_list|>
argument_list|(
name|BlockSize
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|bytesToWrite
operator|<=
literal|0
condition|)
name|qFatal
argument_list|(
literal|"%s: attempt to write %d bytes"
argument_list|,
name|Q_FUNC_INFO
argument_list|,
name|bytesToWrite
argument_list|)
expr_stmt|;
name|measuredSentBytes
operator|+=
name|writeNextData
argument_list|(
name|client
argument_list|,
name|bytesToWrite
argument_list|)
expr_stmt|;
while|while
condition|(
name|client
operator|->
name|bytesToWrite
argument_list|()
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|client
operator|->
name|waitForBytesWritten
argument_list|(
literal|10000
argument_list|)
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
literal|"ERROR: FastSender:"
operator|<<
name|client
operator|->
name|error
argument_list|()
operator|<<
literal|"during blocking write"
expr_stmt|;
return|return;
block|}
block|}
comment|/*qDebug()<< "FastSender:"<< bytesToWrite<< "bytes written now;"<< measuredSentBytes<< "measured bytes"<< measuredSentBytes + writtenBefore<< "total ("<< measuredSentBytes*100/measuredTotalBytes<< "% complete);"<< timer.elapsed()<< "ms elapsed";*/
block|}
name|transferRate
operator|=
name|measuredSentBytes
operator|*
literal|1000
operator|/
name|timer
operator|.
name|elapsed
argument_list|()
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"FastSender: flushed"
operator|<<
name|measuredSentBytes
operator|<<
literal|"bytes in"
operator|<<
name|timer
operator|.
name|elapsed
argument_list|()
operator|<<
literal|"ms: rate ="
operator|<<
name|transferRate
operator|<<
literal|"B/s"
expr_stmt|;
comment|// write a "close connection" packet, if the protocol needs it
name|writeLastData
argument_list|(
name|client
argument_list|)
expr_stmt|;
block|}
signals|signals:
name|void
name|dataReady
parameter_list|()
function_decl|;
block|}
class|;
end_class
begin_class
DECL|class|RateControlledReader
class|class
name|RateControlledReader
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
DECL|member|device
name|QIODevice
modifier|*
name|device
decl_stmt|;
DECL|member|bytesToRead
name|int
name|bytesToRead
decl_stmt|;
DECL|member|interval
name|int
name|interval
decl_stmt|;
DECL|member|readBufferSize
name|int
name|readBufferSize
decl_stmt|;
public|public:
DECL|member|data
name|QByteArray
name|data
decl_stmt|;
DECL|member|totalBytesRead
name|qint64
name|totalBytesRead
decl_stmt|;
DECL|function|RateControlledReader
name|RateControlledReader
parameter_list|(
name|QObject
modifier|&
name|senderObj
parameter_list|,
name|QIODevice
modifier|*
name|dev
parameter_list|,
name|int
name|kbPerSec
parameter_list|,
name|int
name|maxBufferSize
init|=
literal|0
parameter_list|)
member_init_list|:
name|device
argument_list|(
name|dev
argument_list|)
member_init_list|,
name|readBufferSize
argument_list|(
name|maxBufferSize
argument_list|)
member_init_list|,
name|totalBytesRead
argument_list|(
literal|0
argument_list|)
block|{
comment|// determine how often we have to wake up
name|int
name|timesPerSecond
decl_stmt|;
if|if
condition|(
name|readBufferSize
operator|==
literal|0
condition|)
block|{
comment|// The requirement is simply "N KB per seconds"
name|timesPerSecond
operator|=
literal|20
expr_stmt|;
name|bytesToRead
operator|=
name|kbPerSec
operator|*
literal|1024
operator|/
name|timesPerSecond
expr_stmt|;
block|}
else|else
block|{
comment|// The requirement also includes "<readBufferSize> bytes at a time"
name|bytesToRead
operator|=
name|readBufferSize
expr_stmt|;
name|timesPerSecond
operator|=
name|kbPerSec
operator|*
literal|1024
operator|/
name|readBufferSize
expr_stmt|;
block|}
name|interval
operator|=
literal|1000
operator|/
name|timesPerSecond
expr_stmt|;
comment|// in ms
name|qDebug
argument_list|()
operator|<<
literal|"RateControlledReader: going to read"
operator|<<
name|bytesToRead
operator|<<
literal|"bytes every"
operator|<<
name|interval
operator|<<
literal|"ms"
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"actual read rate will be"
operator|<<
operator|(
name|bytesToRead
operator|*
literal|1000
operator|/
name|interval
operator|)
operator|<<
literal|"bytes/sec (wanted"
operator|<<
name|kbPerSec
operator|*
literal|1024
operator|<<
literal|"bytes/sec)"
expr_stmt|;
comment|// Wait for data to be readyRead
name|bool
name|ok
init|=
name|connect
argument_list|(
operator|&
name|senderObj
argument_list|,
name|SIGNAL
argument_list|(
name|dataReady
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|slotDataReady
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ok
condition|)
name|qFatal
argument_list|(
literal|"%s: Cannot connect dataReady signal"
argument_list|,
name|Q_FUNC_INFO
argument_list|)
expr_stmt|;
block|}
DECL|function|wrapUp
name|void
name|wrapUp
parameter_list|()
block|{
name|QByteArray
name|someData
init|=
name|device
operator|->
name|read
argument_list|(
name|device
operator|->
name|bytesAvailable
argument_list|()
argument_list|)
decl_stmt|;
name|data
operator|+=
name|someData
expr_stmt|;
name|totalBytesRead
operator|+=
name|someData
operator|.
name|size
argument_list|()
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"wrapUp: found"
operator|<<
name|someData
operator|.
name|size
argument_list|()
operator|<<
literal|"bytes left. progress"
operator|<<
name|data
operator|.
name|size
argument_list|()
expr_stmt|;
comment|//qDebug()<< "wrapUp: now bytesAvailable="<< device->bytesAvailable();
block|}
private|private
name|slots
private|:
DECL|function|slotDataReady
name|void
name|slotDataReady
parameter_list|()
block|{
comment|//qDebug()<< "RateControlledReader: ready to go";
name|startTimer
argument_list|(
name|interval
argument_list|)
expr_stmt|;
block|}
protected|protected:
DECL|function|timerEvent
name|void
name|timerEvent
parameter_list|(
name|QTimerEvent
modifier|*
parameter_list|)
block|{
comment|//qDebug()<< "RateControlledReader: timerEvent bytesAvailable="<< device->bytesAvailable();
if|if
condition|(
name|readBufferSize
operator|>
literal|0
operator|&&
name|device
operator|->
name|bytesAvailable
argument_list|()
operator|>
name|readBufferSize
condition|)
block|{
comment|// This passes all the time, except in the final flush.
comment|//qFatal("%s: Too many bytes available", Q_FUNC_INFO);
block|}
name|qint64
name|bytesRead
init|=
literal|0
decl_stmt|;
name|QTime
name|stopWatch
decl_stmt|;
name|stopWatch
operator|.
name|start
argument_list|()
expr_stmt|;
do|do
block|{
if|if
condition|(
name|device
operator|->
name|bytesAvailable
argument_list|()
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|stopWatch
operator|.
name|elapsed
argument_list|()
operator|>
literal|20
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
literal|"RateControlledReader: Not enough data available for reading, waited too much, timing out"
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|device
operator|->
name|waitForReadyRead
argument_list|(
literal|5
argument_list|)
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
literal|"RateControlledReader: Not enough data available for reading, even after waiting 5ms, bailing out"
expr_stmt|;
break|break;
block|}
block|}
name|QByteArray
name|someData
init|=
name|device
operator|->
name|read
argument_list|(
name|bytesToRead
operator|-
name|bytesRead
argument_list|)
decl_stmt|;
name|data
operator|+=
name|someData
expr_stmt|;
name|bytesRead
operator|+=
name|someData
operator|.
name|size
argument_list|()
expr_stmt|;
comment|//qDebug()<< "RateControlledReader: successfully read"<< someData.size()<< "progress:"<< data.size();
block|}
do|while
condition|(
name|bytesRead
operator|<
name|bytesToRead
condition|)
do|;
name|totalBytesRead
operator|+=
name|bytesRead
expr_stmt|;
if|if
condition|(
name|bytesRead
operator|<
name|bytesToRead
condition|)
name|qWarning
argument_list|()
operator|<<
literal|"RateControlledReader: WARNING:"
operator|<<
name|bytesToRead
operator|-
name|bytesRead
operator|<<
literal|"bytes not read"
expr_stmt|;
block|}
block|}
class|;
end_class
begin_constructor
DECL|function|tst_QNetworkReply
name|tst_QNetworkReply
operator|::
name|tst_QNetworkReply
parameter_list|()
block|{
name|qRegisterMetaType
argument_list|<
name|QNetworkReply
operator|*
argument_list|>
argument_list|()
expr_stmt|;
comment|// for QSignalSpy
name|qRegisterMetaType
argument_list|<
name|QAuthenticator
operator|*
argument_list|>
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
name|qRegisterMetaType
argument_list|<
name|QNetworkProxy
argument_list|>
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|qRegisterMetaType
argument_list|<
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|>
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|qRegisterMetaType
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|()
expr_stmt|;
name|uniqueExtension
operator|=
name|createUniqueExtension
argument_list|()
expr_stmt|;
name|testFileName
operator|=
name|QDir
operator|::
name|currentPath
argument_list|()
operator|+
literal|"/testfile"
operator|+
name|uniqueExtension
expr_stmt|;
name|cookieJar
operator|=
operator|new
name|MyCookieJar
expr_stmt|;
name|manager
operator|.
name|setCookieJar
argument_list|(
name|cookieJar
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
name|QHostInfo
name|hostInfo
init|=
name|QHostInfo
operator|::
name|fromName
argument_list|(
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|proxies
operator|<<
name|ProxyData
argument_list|(
name|QNetworkProxy
operator|::
name|NoProxy
argument_list|,
literal|""
argument_list|,
literal|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostInfo
operator|.
name|error
argument_list|()
operator|==
name|QHostInfo
operator|::
name|NoError
operator|&&
operator|!
name|hostInfo
operator|.
name|addresses
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|QString
name|proxyserver
init|=
name|hostInfo
operator|.
name|addresses
argument_list|()
operator|.
name|first
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|proxies
operator|<<
name|ProxyData
argument_list|(
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpProxy
argument_list|,
name|proxyserver
argument_list|,
literal|3128
argument_list|)
argument_list|,
literal|"+proxy"
argument_list|,
literal|false
argument_list|)
operator|<<
name|ProxyData
argument_list|(
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpProxy
argument_list|,
name|proxyserver
argument_list|,
literal|3129
argument_list|)
argument_list|,
literal|"+proxyauth"
argument_list|,
literal|true
argument_list|)
comment|// currently unsupported
comment|//<< ProxyData(QNetworkProxy(QNetworkProxy::HttpProxy, proxyserver, 3130), "+proxyauth-ntlm", true);
operator|<<
name|ProxyData
argument_list|(
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|Socks5Proxy
argument_list|,
name|proxyserver
argument_list|,
literal|1080
argument_list|)
argument_list|,
literal|"+socks"
argument_list|,
literal|false
argument_list|)
operator|<<
name|ProxyData
argument_list|(
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|Socks5Proxy
argument_list|,
name|proxyserver
argument_list|,
literal|1081
argument_list|)
argument_list|,
literal|"+socksauth"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
comment|// !QT_NO_NETWORKPROXY
name|printf
argument_list|(
literal|"==================================================================\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Proxy could not be looked up. No proxy will be used while testing!\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"==================================================================\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
block|}
endif|#
directive|endif
comment|// !QT_NO_NETWORKPROXY
block|}
end_constructor
begin_destructor
DECL|function|~tst_QNetworkReply
name|tst_QNetworkReply
operator|::
name|~
name|tst_QNetworkReply
parameter_list|()
block|{ }
end_destructor
begin_function
DECL|function|authenticationRequired
name|void
name|tst_QNetworkReply
operator|::
name|authenticationRequired
parameter_list|(
name|QNetworkReply
modifier|*
parameter_list|,
name|QAuthenticator
modifier|*
name|auth
parameter_list|)
block|{
name|auth
operator|->
name|setUser
argument_list|(
literal|"httptest"
argument_list|)
expr_stmt|;
name|auth
operator|->
name|setPassword
argument_list|(
literal|"httptest"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|proxyAuthenticationRequired
name|void
name|tst_QNetworkReply
operator|::
name|proxyAuthenticationRequired
parameter_list|(
specifier|const
name|QNetworkProxy
modifier|&
parameter_list|,
name|QAuthenticator
modifier|*
name|auth
parameter_list|)
block|{
name|auth
operator|->
name|setUser
argument_list|(
literal|"qsockstest"
argument_list|)
expr_stmt|;
name|auth
operator|->
name|setPassword
argument_list|(
literal|"password"
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_SSL
end_ifndef
begin_function
DECL|function|sslErrors
name|void
name|tst_QNetworkReply
operator|::
name|sslErrors
parameter_list|(
name|QNetworkReply
modifier|*
name|reply
parameter_list|,
specifier|const
name|QList
argument_list|<
name|QSslError
argument_list|>
modifier|&
name|errors
parameter_list|)
block|{
name|reply
operator|->
name|ignoreSslErrors
argument_list|()
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|errors
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|sslConfiguration
argument_list|()
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|storeSslConfiguration
name|void
name|tst_QNetworkReply
operator|::
name|storeSslConfiguration
parameter_list|()
block|{
name|storedSslConfiguration
operator|=
name|QSslConfiguration
argument_list|()
expr_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|qobject_cast
argument_list|<
name|QNetworkReply
operator|*
argument_list|>
argument_list|(
name|sender
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|reply
condition|)
name|storedSslConfiguration
operator|=
name|reply
operator|->
name|sslConfiguration
argument_list|()
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_function
DECL|function|runMultipartRequest
name|QString
name|tst_QNetworkReply
operator|::
name|runMultipartRequest
parameter_list|(
specifier|const
name|QNetworkRequest
modifier|&
name|request
parameter_list|,
name|QNetworkReplyPtr
modifier|&
name|reply
parameter_list|,
name|QHttpMultiPart
modifier|*
name|multiPart
parameter_list|,
specifier|const
name|QByteArray
modifier|&
name|verb
parameter_list|)
block|{
if|if
condition|(
name|verb
operator|==
literal|"POST"
condition|)
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
name|multiPart
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|request
argument_list|,
name|multiPart
argument_list|)
argument_list|)
expr_stmt|;
comment|// the code below is copied from tst_QNetworkReply::runSimpleRequest, see below
name|reply
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|gotError
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|multiPart
operator|->
name|setParent
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|Timeout
expr_stmt|;
name|loop
operator|=
operator|new
name|QEventLoop
expr_stmt|;
name|QTimer
operator|::
name|singleShot
argument_list|(
literal|25000
argument_list|,
name|loop
argument_list|,
name|SLOT
argument_list|(
name|quit
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|code
init|=
name|returnCode
operator|==
name|Timeout
condition|?
name|loop
operator|->
name|exec
argument_list|()
else|:
name|returnCode
decl_stmt|;
operator|delete
name|loop
expr_stmt|;
name|loop
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|Failure
case|:
return|return
literal|"Request failed: "
operator|+
name|reply
operator|->
name|errorString
argument_list|()
return|;
case|case
name|Timeout
case|:
return|return
literal|"Network timeout"
return|;
block|}
return|return
name|QString
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|runSimpleRequest
name|QString
name|tst_QNetworkReply
operator|::
name|runSimpleRequest
parameter_list|(
name|QNetworkAccessManager
operator|::
name|Operation
name|op
parameter_list|,
specifier|const
name|QNetworkRequest
modifier|&
name|request
parameter_list|,
name|QNetworkReplyPtr
modifier|&
name|reply
parameter_list|,
specifier|const
name|QByteArray
modifier|&
name|data
parameter_list|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|QNetworkAccessManager
operator|::
name|HeadOperation
case|:
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|head
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|QNetworkAccessManager
operator|::
name|GetOperation
case|:
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|QNetworkAccessManager
operator|::
name|PutOperation
case|:
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|request
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|QNetworkAccessManager
operator|::
name|PostOperation
case|:
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|QNetworkAccessManager
operator|::
name|DeleteOperation
case|:
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|deleteResource
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|qFatal
argument_list|(
literal|"%s: Invalid/unknown operation requested"
argument_list|,
name|Q_FUNC_INFO
argument_list|)
expr_stmt|;
block|}
name|reply
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|Timeout
expr_stmt|;
name|int
name|code
init|=
name|Success
decl_stmt|;
if|if
condition|(
name|request
operator|.
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
condition|)
block|{
if|if
condition|(
name|reply
operator|->
name|isFinished
argument_list|()
condition|)
name|code
operator|=
name|reply
operator|->
name|error
argument_list|()
operator|!=
name|QNetworkReply
operator|::
name|NoError
condition|?
name|Failure
else|:
name|Success
expr_stmt|;
else|else
name|code
operator|=
name|Failure
expr_stmt|;
block|}
else|else
block|{
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|gotError
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|loop
operator|=
operator|new
name|QEventLoop
expr_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|downloadProgress
argument_list|(
name|qint64
argument_list|,
name|qint64
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
while|while
condition|(
operator|!
name|reply
operator|->
name|isFinished
argument_list|()
condition|)
block|{
name|QTimer
operator|::
name|singleShot
argument_list|(
literal|20000
argument_list|,
name|loop
argument_list|,
name|SLOT
argument_list|(
name|quit
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|loop
operator|->
name|exec
argument_list|()
expr_stmt|;
if|if
condition|(
name|count
operator|==
name|spy
operator|.
name|count
argument_list|()
operator|&&
operator|!
name|reply
operator|->
name|isFinished
argument_list|()
condition|)
block|{
name|code
operator|=
name|Timeout
expr_stmt|;
break|break;
block|}
name|count
operator|=
name|spy
operator|.
name|count
argument_list|()
expr_stmt|;
block|}
operator|delete
name|loop
expr_stmt|;
name|loop
operator|=
literal|0
expr_stmt|;
block|}
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|Failure
case|:
return|return
literal|"Request failed: "
operator|+
name|reply
operator|->
name|errorString
argument_list|()
return|;
case|case
name|Timeout
case|:
return|return
literal|"Network timeout"
return|;
block|}
return|return
name|QString
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|runCustomRequest
name|QString
name|tst_QNetworkReply
operator|::
name|runCustomRequest
parameter_list|(
specifier|const
name|QNetworkRequest
modifier|&
name|request
parameter_list|,
name|QNetworkReplyPtr
modifier|&
name|reply
parameter_list|,
specifier|const
name|QByteArray
modifier|&
name|verb
parameter_list|,
name|QIODevice
modifier|*
name|data
parameter_list|)
block|{
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|sendCustomRequest
argument_list|(
name|request
argument_list|,
name|verb
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|reply
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|gotError
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|Timeout
expr_stmt|;
name|loop
operator|=
operator|new
name|QEventLoop
expr_stmt|;
name|QTimer
operator|::
name|singleShot
argument_list|(
literal|20000
argument_list|,
name|loop
argument_list|,
name|SLOT
argument_list|(
name|quit
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|code
init|=
name|returnCode
operator|==
name|Timeout
condition|?
name|loop
operator|->
name|exec
argument_list|()
else|:
name|returnCode
decl_stmt|;
operator|delete
name|loop
expr_stmt|;
name|loop
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|Failure
case|:
return|return
literal|"Request failed: "
operator|+
name|reply
operator|->
name|errorString
argument_list|()
return|;
case|case
name|Timeout
case|:
return|return
literal|"Network timeout"
return|;
block|}
return|return
name|QString
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|msgWaitForFinished
specifier|static
name|QByteArray
name|msgWaitForFinished
parameter_list|(
name|QNetworkReplyPtr
modifier|&
name|reply
parameter_list|)
block|{
name|QString
name|result
decl_stmt|;
name|QDebug
name|debug
argument_list|(
operator|&
name|result
argument_list|)
decl_stmt|;
name|debug
operator|<<
name|reply
operator|->
name|url
argument_list|()
expr_stmt|;
if|if
condition|(
name|reply
operator|->
name|isFinished
argument_list|()
condition|)
block|{
if|if
condition|(
name|reply
operator|->
name|error
argument_list|()
operator|==
name|QNetworkReply
operator|::
name|NoError
condition|)
name|debug
operator|<<
literal|"finished."
expr_stmt|;
else|else
name|debug
operator|<<
literal|"failed: #"
operator|<<
name|reply
operator|->
name|error
argument_list|()
operator|<<
name|reply
operator|->
name|errorString
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|debug
operator|<<
literal|"timed out."
expr_stmt|;
block|}
return|return
name|result
operator|.
name|toLocal8Bit
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|waitForFinish
name|int
name|tst_QNetworkReply
operator|::
name|waitForFinish
parameter_list|(
name|QNetworkReplyPtr
modifier|&
name|reply
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|gotError
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|Success
expr_stmt|;
name|loop
operator|=
operator|new
name|QEventLoop
expr_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|downloadProgress
argument_list|(
name|qint64
argument_list|,
name|qint64
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
while|while
condition|(
operator|!
name|reply
operator|->
name|isFinished
argument_list|()
condition|)
block|{
name|QTimer
operator|::
name|singleShot
argument_list|(
literal|5000
argument_list|,
name|loop
argument_list|,
name|SLOT
argument_list|(
name|quit
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|loop
operator|->
name|exec
argument_list|()
operator|==
name|Timeout
operator|&&
name|count
operator|==
name|spy
operator|.
name|count
argument_list|()
operator|&&
operator|!
name|reply
operator|->
name|isFinished
argument_list|()
condition|)
block|{
name|returnCode
operator|=
name|Timeout
expr_stmt|;
break|break;
block|}
name|count
operator|=
name|spy
operator|.
name|count
argument_list|()
expr_stmt|;
block|}
operator|delete
name|loop
expr_stmt|;
name|loop
operator|=
literal|0
expr_stmt|;
return|return
name|returnCode
return|;
block|}
end_function
begin_function
DECL|function|finished
name|void
name|tst_QNetworkReply
operator|::
name|finished
parameter_list|()
block|{
name|loop
operator|->
name|exit
argument_list|(
name|returnCode
operator|=
name|Success
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|gotError
name|void
name|tst_QNetworkReply
operator|::
name|gotError
parameter_list|()
block|{
name|loop
operator|->
name|exit
argument_list|(
name|returnCode
operator|=
name|Failure
argument_list|)
expr_stmt|;
name|disconnect
argument_list|(
name|QObject
operator|::
name|sender
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|initTestCase
name|void
name|tst_QNetworkReply
operator|::
name|initTestCase
parameter_list|()
block|{
name|testDataDir
operator|=
name|QFileInfo
argument_list|(
name|QFINDTESTDATA
argument_list|(
literal|"rfc3252.txt"
argument_list|)
argument_list|)
operator|.
name|absolutePath
argument_list|()
expr_stmt|;
if|if
condition|(
name|testDataDir
operator|.
name|isEmpty
argument_list|()
condition|)
name|testDataDir
operator|=
name|QCoreApplication
operator|::
name|applicationDirPath
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|QtNetworkSettings
operator|::
name|verifyTestNetworkSettings
argument_list|()
condition|)
name|QSKIP
argument_list|(
literal|"No network test server available"
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
name|Q_OS_WIN
name|wronlyFileName
operator|=
name|testDataDir
operator|+
literal|"/write-only"
operator|+
name|uniqueExtension
expr_stmt|;
name|QFile
name|wr
argument_list|(
name|wronlyFileName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|wr
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|WriteOnly
operator||
name|QIODevice
operator|::
name|Truncate
argument_list|)
argument_list|)
expr_stmt|;
name|wr
operator|.
name|setPermissions
argument_list|(
name|QFile
operator|::
name|WriteOwner
operator||
name|QFile
operator|::
name|WriteUser
argument_list|)
expr_stmt|;
name|wr
operator|.
name|close
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|QDir
operator|::
name|setSearchPaths
argument_list|(
literal|"testdata"
argument_list|,
name|QStringList
argument_list|()
operator|<<
name|testDataDir
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|QSslSocket
operator|::
name|defaultCaCertificates
argument_list|()
expr_stmt|;
comment|//preload certificates
endif|#
directive|endif
ifndef|#
directive|ifndef
name|QT_NO_BEARERMANAGEMENT
name|netConfMan
operator|=
operator|new
name|QNetworkConfigurationManager
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|networkConfiguration
operator|=
name|netConfMan
operator|->
name|defaultConfiguration
argument_list|()
expr_stmt|;
name|networkSession
operator|.
name|reset
argument_list|(
operator|new
name|QNetworkSession
argument_list|(
name|networkConfiguration
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|networkSession
operator|->
name|isOpen
argument_list|()
condition|)
block|{
name|networkSession
operator|->
name|open
argument_list|()
expr_stmt|;
name|QVERIFY
argument_list|(
name|networkSession
operator|->
name|waitForOpened
argument_list|(
literal|30000
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|echoProcessDir
operator|=
name|QFINDTESTDATA
argument_list|(
literal|"echo"
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
operator|!
name|echoProcessDir
operator|.
name|isEmpty
argument_list|()
argument_list|,
name|qPrintable
argument_list|(
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"Couldn't find echo dir starting from %1."
argument_list|)
operator|.
name|arg
argument_list|(
name|QDir
operator|::
name|currentPath
argument_list|()
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|cleanupTestCase
name|void
name|tst_QNetworkReply
operator|::
name|cleanupTestCase
parameter_list|()
block|{
if|#
directive|if
operator|!
name|defined
name|Q_OS_WIN
if|if
condition|(
operator|!
name|wronlyFileName
operator|.
name|isNull
argument_list|()
condition|)
name|QFile
operator|::
name|remove
argument_list|(
name|wronlyFileName
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|QT_NO_BEARERMANAGEMENT
if|if
condition|(
name|networkSession
operator|&&
name|networkSession
operator|->
name|isOpen
argument_list|()
condition|)
block|{
name|networkSession
operator|->
name|close
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|init
name|void
name|tst_QNetworkReply
operator|::
name|init
parameter_list|()
block|{
name|cleanup
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|cleanup
name|void
name|tst_QNetworkReply
operator|::
name|cleanup
parameter_list|()
block|{
name|QFile
name|file
argument_list|(
name|testFileName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|file
operator|.
name|exists
argument_list|()
operator|||
name|file
operator|.
name|remove
argument_list|()
argument_list|)
expr_stmt|;
comment|// clear the internal cache
name|manager
operator|.
name|clearAccessCache
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
name|manager
operator|.
name|setProxy
argument_list|(
name|QNetworkProxy
argument_list|()
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|manager
operator|.
name|setCache
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// clear cookies
name|cookieJar
operator|->
name|setAllCookies
argument_list|(
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|()
argument_list|)
expr_stmt|;
comment|// disconnect manager signals
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|stateChecking
name|void
name|tst_QNetworkReply
operator|::
name|stateChecking
parameter_list|()
block|{
name|QUrl
name|url
init|=
name|QUrl
argument_list|(
literal|"file:///"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|req
argument_list|(
name|url
argument_list|)
decl_stmt|;
comment|// you can't open this file, I know
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|req
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isOpen
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isReadable
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|isWritable
argument_list|()
argument_list|)
expr_stmt|;
comment|// both behaviours are OK since we might change underlying behaviour again
if|if
condition|(
operator|!
name|reply
operator|->
name|isFinished
argument_list|()
condition|)
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|errorString
argument_list|()
argument_list|,
name|QString
argument_list|(
literal|"Unknown error"
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|errorString
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|manager
argument_list|()
argument_list|,
operator|&
name|manager
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|request
argument_list|()
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|int
argument_list|(
name|reply
operator|->
name|operation
argument_list|()
argument_list|)
argument_list|,
name|int
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|)
argument_list|)
expr_stmt|;
comment|// error and not error are OK since we might change underlying behaviour again
if|if
condition|(
operator|!
name|reply
operator|->
name|isFinished
argument_list|()
condition|)
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|reply
operator|->
name|abort
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|invalidProtocol
name|void
name|tst_QNetworkReply
operator|::
name|invalidProtocol
parameter_list|()
block|{
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromEncoded
argument_list|(
literal|"not-a-known-protocol://foo/bar"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|req
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QString
name|errorMsg
init|=
literal|"Request failed: Protocol \"not-a-known-protocol\" is unknown"
decl_stmt|;
name|QString
name|result
init|=
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|req
argument_list|,
name|reply
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|result
argument_list|,
name|errorMsg
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|ProtocolUnknownError
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromData_data
name|void
name|tst_QNetworkReply
operator|::
name|getFromData_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"request"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"expected"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"mimeType"
argument_list|)
expr_stmt|;
specifier|const
name|QString
name|defaultMimeType
argument_list|(
literal|"text/plain;charset=US-ASCII"
argument_list|)
decl_stmt|;
comment|//QTest::newRow("empty")<< "data:"<< QByteArray()<< defaultMimeType;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty2"
argument_list|)
operator|<<
literal|"data:,"
operator|<<
name|QByteArray
argument_list|()
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"just-charset_1"
argument_list|)
operator|<<
literal|"data:charset=iso-8859-1,"
operator|<<
name|QByteArray
argument_list|()
operator|<<
literal|"text/plain;charset=iso-8859-1"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"just-charset_2"
argument_list|)
operator|<<
literal|"data:charset = iso-8859-1 ,"
operator|<<
name|QByteArray
argument_list|()
operator|<<
literal|"text/plain;charset = iso-8859-1"
expr_stmt|;
comment|//QTest::newRow("just-media")<< "data:text/xml"<< QByteArray()<< "text/xml";
name|QTest
operator|::
name|newRow
argument_list|(
literal|"just-media2"
argument_list|)
operator|<<
literal|"data:text/xml,"
operator|<<
name|QByteArray
argument_list|()
operator|<<
literal|"text/xml"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"plain_1"
argument_list|)
operator|<<
literal|"data:,foo"
operator|<<
name|QByteArray
argument_list|(
literal|"foo"
argument_list|)
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"plain_2"
argument_list|)
operator|<<
literal|"data:text/html,Hello World"
operator|<<
name|QByteArray
argument_list|(
literal|"Hello World"
argument_list|)
operator|<<
literal|"text/html"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"plain_3"
argument_list|)
operator|<<
literal|"data:text/html;charset=utf-8,Hello World"
operator|<<
name|QByteArray
argument_list|(
literal|"Hello World"
argument_list|)
operator|<<
literal|"text/html;charset=utf-8"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"pct_1"
argument_list|)
operator|<<
literal|"data:,%3Cbody%20contentEditable%3Dtrue%3E%0D%0A"
operator|<<
name|QByteArray
argument_list|(
literal|"<body contentEditable=true>\r\n"
argument_list|)
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"pct_2"
argument_list|)
operator|<<
literal|"data:text/html;charset=utf-8,%3Cbody%20contentEditable%3Dtrue%3E%0D%0A"
operator|<<
name|QByteArray
argument_list|(
literal|"<body contentEditable=true>\r\n"
argument_list|)
operator|<<
literal|"text/html;charset=utf-8"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"base64-empty_1"
argument_list|)
operator|<<
literal|"data:;base64,"
operator|<<
name|QByteArray
argument_list|()
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"base64-empty_2"
argument_list|)
operator|<<
literal|"data:charset=utf-8;base64,"
operator|<<
name|QByteArray
argument_list|()
operator|<<
literal|"text/plain;charset=utf-8"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"base64-empty_3"
argument_list|)
operator|<<
literal|"data:text/html;charset=utf-8;base64,"
operator|<<
name|QByteArray
argument_list|()
operator|<<
literal|"text/html;charset=utf-8"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"base64_1"
argument_list|)
operator|<<
literal|"data:;base64,UXQgaXMgZ3JlYXQh"
operator|<<
name|QByteArray
argument_list|(
literal|"Qt is great!"
argument_list|)
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"base64_2"
argument_list|)
operator|<<
literal|"data:charset=utf-8;base64,UXQgaXMgZ3JlYXQh"
operator|<<
name|QByteArray
argument_list|(
literal|"Qt is great!"
argument_list|)
operator|<<
literal|"text/plain;charset=utf-8"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"base64_3"
argument_list|)
operator|<<
literal|"data:text/html;charset=utf-8;base64,UXQgaXMgZ3JlYXQh"
operator|<<
name|QByteArray
argument_list|(
literal|"Qt is great!"
argument_list|)
operator|<<
literal|"text/html;charset=utf-8"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"pct-nul"
argument_list|)
operator|<<
literal|"data:,a%00g"
operator|<<
name|QByteArray
argument_list|(
literal|"a\0g"
argument_list|,
literal|3
argument_list|)
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"base64-nul"
argument_list|)
operator|<<
literal|"data:;base64,YQBn"
operator|<<
name|QByteArray
argument_list|(
literal|"a\0g"
argument_list|,
literal|3
argument_list|)
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"pct-nonutf8"
argument_list|)
operator|<<
literal|"data:,a%E1g"
operator|<<
name|QByteArray
argument_list|(
literal|"a\xE1g"
argument_list|,
literal|3
argument_list|)
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"base64"
argument_list|)
operator|<<
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"data:application/xml;base64,PGUvPg=="
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"<e/>"
argument_list|)
operator|<<
literal|"application/xml"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"base64, no media type"
argument_list|)
operator|<<
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"data:;base64,PGUvPg=="
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"<e/>"
argument_list|)
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"Percent encoding"
argument_list|)
operator|<<
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"data:application/xml,%3Ce%2F%3E"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"<e/>"
argument_list|)
operator|<<
literal|"application/xml"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"Percent encoding, no media type"
argument_list|)
operator|<<
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"data:,%3Ce%2F%3E"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"<e/>"
argument_list|)
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"querychars"
argument_list|)
operator|<<
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"data:,foo?x=0&y=0"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"foo?x=0&y=0"
argument_list|)
operator|<<
name|defaultMimeType
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"css"
argument_list|)
operator|<<
literal|"data:text/css,div%20{%20border-right:%20solid;%20}"
operator|<<
name|QByteArray
argument_list|(
literal|"div { border-right: solid; }"
argument_list|)
operator|<<
literal|"text/css"
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromData
name|void
name|tst_QNetworkReply
operator|::
name|getFromData
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|expected
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|mimeType
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromEncoded
argument_list|(
name|request
operator|.
name|toLatin1
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|req
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|req
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|,
name|mimeType
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|expected
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|expected
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromFile
name|void
name|tst_QNetworkReply
operator|::
name|getFromFile
parameter_list|()
block|{
comment|// create the file:
name|QTemporaryFile
name|file
argument_list|(
name|QDir
operator|::
name|currentPath
argument_list|()
operator|+
literal|"/temp-XXXXXX"
argument_list|)
decl_stmt|;
name|file
operator|.
name|setAutoRemove
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|file
operator|.
name|open
argument_list|()
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|file
operator|.
name|fileName
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
specifier|static
specifier|const
name|char
name|fileData
index|[]
init|=
literal|"This is some data that is in the file.\r\n"
decl_stmt|;
name|QByteArray
name|data
init|=
name|QByteArray
operator|::
name|fromRawData
argument_list|(
name|fileData
argument_list|,
sizeof|sizeof
name|fileData
operator|-
literal|1
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|file
operator|.
name|write
argument_list|(
name|data
argument_list|)
operator|==
name|data
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|file
operator|.
name|flush
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|file
operator|.
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|file
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|data
argument_list|)
expr_stmt|;
comment|// make the file bigger
name|file
operator|.
name|resize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
specifier|const
name|int
name|multiply
init|=
operator|(
literal|128
operator|*
literal|1024
operator|)
operator|/
operator|(
sizeof|sizeof
name|fileData
operator|-
literal|1
operator|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|multiply
condition|;
operator|++
name|i
control|)
name|file
operator|.
name|write
argument_list|(
name|fileData
argument_list|,
sizeof|sizeof
name|fileData
operator|-
literal|1
argument_list|)
expr_stmt|;
name|file
operator|.
name|flush
argument_list|()
expr_stmt|;
comment|// run again
name|reply
operator|.
name|clear
argument_list|()
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|file
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|file
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromFileSpecial_data
name|void
name|tst_QNetworkReply
operator|::
name|getFromFileSpecial_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"fileName"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"resource"
argument_list|)
operator|<<
literal|":/resource"
operator|<<
literal|"qrc:/resource"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"search-path"
argument_list|)
operator|<<
literal|"testdata:/rfc3252.txt"
operator|<<
literal|"testdata:/rfc3252.txt"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"bigfile-path"
argument_list|)
operator|<<
literal|"testdata:/bigfile"
operator|<<
literal|"testdata:/bigfile"
expr_stmt|;
ifdef|#
directive|ifdef
name|Q_OS_WIN
name|QTest
operator|::
name|newRow
argument_list|(
literal|"smb-path"
argument_list|)
operator|<<
literal|"testdata:/smb-file.txt"
operator|<<
literal|"file://"
operator|+
name|QtNetworkSettings
operator|::
name|winServerName
argument_list|()
operator|+
literal|"/testshare/test.pri"
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|getFromFileSpecial
name|void
name|tst_QNetworkReply
operator|::
name|getFromFileSpecial
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|fileName
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
comment|// open the resource so we can find out its size
name|QFile
name|resource
argument_list|(
name|fileName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|resource
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|request
operator|.
name|setUrl
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|resource
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|resource
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromFtp_data
name|void
name|tst_QNetworkReply
operator|::
name|getFromFtp_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"referenceName"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"rfc3252.txt"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
operator|)
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"bigfile"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/bigfile"
operator|)
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromFtp
name|void
name|tst_QNetworkReply
operator|::
name|getFromFtp
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|referenceName
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFile
name|reference
argument_list|(
name|referenceName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromFtpAfterError
name|void
name|tst_QNetworkReply
operator|::
name|getFromFtpAfterError
parameter_list|()
block|{
name|QNetworkRequest
name|invalidRequest
argument_list|(
name|QUrl
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/invalid.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|invalidReply
decl_stmt|;
name|invalidReply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|invalidRequest
argument_list|)
argument_list|)
expr_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|invalidReply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|spy
operator|.
name|wait
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|invalidReply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|ContentNotFoundError
argument_list|)
expr_stmt|;
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|validRequest
argument_list|(
name|QUrl
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|validReply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|validRequest
argument_list|,
name|validReply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|validReply
operator|->
name|url
argument_list|()
argument_list|,
name|validRequest
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|validReply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|validReply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|validReply
operator|->
name|readAll
argument_list|()
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromHttp_data
name|void
name|tst_QNetworkReply
operator|::
name|getFromHttp_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"referenceName"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"success-internal"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
operator|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"success-external"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
operator|)
operator|<<
literal|"http://www.ietf.org/rfc/rfc3252.txt"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"bigfile-internal"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/bigfile"
operator|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromHttp
name|void
name|tst_QNetworkReply
operator|::
name|getFromHttp
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|referenceName
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFile
name|reference
argument_list|(
name|referenceName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|size
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// only compare when the header is set.
if|if
condition|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|isValid
argument_list|()
condition|)
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// We know our internal server is apache..
if|if
condition|(
name|qstrcmp
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|,
literal|"success-internal"
argument_list|)
operator|==
literal|0
condition|)
name|QVERIFY
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ServerHeader
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|contains
argument_list|(
literal|"Apache"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
end_ifndef
begin_function
DECL|function|headFromHttp_data
name|void
name|tst_QNetworkReply
operator|::
name|headFromHttp_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|qint64
argument_list|>
argument_list|(
literal|"referenceSize"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"contentType"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkProxy
argument_list|>
argument_list|(
literal|"proxy"
argument_list|)
expr_stmt|;
name|qint64
name|rfcsize
init|=
name|QFileInfo
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
operator|.
name|size
argument_list|()
decl_stmt|;
name|qint64
name|bigfilesize
init|=
name|QFileInfo
argument_list|(
name|testDataDir
operator|+
literal|"/bigfile"
argument_list|)
operator|.
name|size
argument_list|()
decl_stmt|;
name|qint64
name|indexsize
init|=
name|QFileInfo
argument_list|(
name|testDataDir
operator|+
literal|"/index.html"
argument_list|)
operator|.
name|size
argument_list|()
decl_stmt|;
comment|//testing proxies, mainly for the 407 response from http proxy
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|proxies
operator|.
name|count
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
name|QTest
operator|::
name|newRow
argument_list|(
literal|"rfc"
operator|+
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|tag
argument_list|)
operator|<<
name|rfcsize
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
operator|<<
literal|"text/plain"
operator|<<
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|proxy
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"bigfile"
operator|+
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|tag
argument_list|)
operator|<<
name|bigfilesize
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
argument_list|)
operator|<<
literal|"text/plain"
operator|<<
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|proxy
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"index"
operator|+
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|tag
argument_list|)
operator|<<
name|indexsize
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/"
argument_list|)
operator|<<
literal|"text/html"
operator|<<
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|proxy
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-authentication"
operator|+
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|tag
argument_list|)
operator|<<
name|rfcsize
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth/rfc3252.txt"
argument_list|)
operator|<<
literal|"text/plain"
operator|<<
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|proxy
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"cgi"
operator|+
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|tag
argument_list|)
operator|<<
operator|(
name|qint64
operator|)
operator|-
literal|1
operator|<<
name|QUrl
argument_list|(
literal|"http://qt-test-server/qtest/cgi-bin/httpcachetest_expires500.cgi"
argument_list|)
operator|<<
literal|"text/html"
operator|<<
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|proxy
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|headFromHttp
name|void
name|tst_QNetworkReply
operator|::
name|headFromHttp
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|qint64
argument_list|,
name|referenceSize
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|contentType
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkProxy
argument_list|,
name|proxy
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QElapsedTimer
name|time
decl_stmt|;
name|time
operator|.
name|start
argument_list|()
expr_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|HeadOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|time
operator|.
name|elapsed
argument_list|()
operator|<
literal|8000
argument_list|)
expr_stmt|;
comment|//check authentication didn't wait for the server to timeout the http connection (15s on qt test server)
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// only compare when the header is set.
if|if
condition|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|isValid
argument_list|()
operator|&&
name|referenceSize
operator|>=
literal|0
condition|)
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|referenceSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|)
operator|.
name|isValid
argument_list|()
condition|)
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|,
name|contentType
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !QT_NO_NETWORKPROXY
end_comment
begin_function
DECL|function|getErrors_data
name|void
name|tst_QNetworkReply
operator|::
name|getErrors_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"error"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"httpStatusCode"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"dataIsEmpty"
argument_list|)
expr_stmt|;
comment|// empties
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty-url"
argument_list|)
operator|<<
name|QString
argument_list|()
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ProtocolUnknownError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty-scheme-host"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
operator|)
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ProtocolUnknownError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty-scheme"
argument_list|)
operator|<<
literal|"//"
operator|+
name|QtNetworkSettings
operator|::
name|winServerName
argument_list|()
operator|+
literal|"/testshare/test.pri"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ProtocolUnknownError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
comment|// file: errors
name|QTest
operator|::
name|newRow
argument_list|(
literal|"file-host"
argument_list|)
operator|<<
literal|"file://invalid.test.qt-project.org/foo.txt"
if|#
directive|if
operator|!
name|defined
name|Q_OS_WIN
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ProtocolInvalidOperationError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
else|#
directive|else
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentNotFoundError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
endif|#
directive|endif
name|QTest
operator|::
name|newRow
argument_list|(
literal|"file-no-path"
argument_list|)
operator|<<
literal|"file://localhost"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentOperationNotPermittedError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"file-is-dir"
argument_list|)
operator|<<
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|QDir
operator|::
name|currentPath
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentOperationNotPermittedError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"file-exist"
argument_list|)
operator|<<
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|QDir
operator|::
name|currentPath
argument_list|()
operator|+
literal|"/this-file-doesnt-exist.txt"
argument_list|)
operator|.
name|toString
argument_list|()
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentNotFoundError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
if|#
directive|if
operator|!
name|defined
name|Q_OS_WIN
name|QTest
operator|::
name|newRow
argument_list|(
literal|"file-is-wronly"
argument_list|)
operator|<<
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|wronlyFileName
argument_list|)
operator|.
name|toString
argument_list|()
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentAccessDenied
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|QFile
operator|::
name|exists
argument_list|(
literal|"/etc/shadow"
argument_list|)
condition|)
name|QTest
operator|::
name|newRow
argument_list|(
literal|"file-permissions"
argument_list|)
operator|<<
literal|"file:/etc/shadow"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentAccessDenied
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
comment|// ftp: errors
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-host"
argument_list|)
operator|<<
literal|"ftp://invalid.test.qt-project.org/foo.txt"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|HostNotFoundError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-no-path"
argument_list|)
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentOperationNotPermittedError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-is-dir"
argument_list|)
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentOperationNotPermittedError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-dir-not-readable"
argument_list|)
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/pub/dir-not-readable/foo.txt"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentAccessDenied
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-file-not-readable"
argument_list|)
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/pub/file-not-readable.txt"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentAccessDenied
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-exist"
argument_list|)
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/pub/this-file-doesnt-exist.txt"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentNotFoundError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
comment|// http: errors
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-host"
argument_list|)
operator|<<
literal|"http://invalid.test.qt-project.org/"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|HostNotFoundError
argument_list|)
operator|<<
literal|0
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-exist"
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/this-file-doesnt-exist.txt"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ContentNotFoundError
argument_list|)
operator|<<
literal|404
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-authentication"
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
operator|<<
literal|401
operator|<<
literal|false
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getErrors
name|void
name|tst_QNetworkReply
operator|::
name|getErrors
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|Q_OS_UNIX
if|if
condition|(
operator|(
name|qstrcmp
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|,
literal|"file-is-wronly"
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|qstrcmp
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|,
literal|"file-permissions"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
operator|::
name|getuid
argument_list|()
operator|==
literal|0
condition|)
name|QSKIP
argument_list|(
literal|"Running this test as root doesn't make sense"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|reply
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
comment|// we have expect-fails
if|if
condition|(
operator|!
name|reply
operator|->
name|isFinished
argument_list|()
condition|)
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
comment|// now run the request:
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QEXPECT_FAIL
argument_list|(
literal|"ftp-is-dir"
argument_list|,
literal|"QFtp cannot provide enough detail"
argument_list|,
name|Abort
argument_list|)
expr_stmt|;
comment|// the line below is not necessary
name|QEXPECT_FAIL
argument_list|(
literal|"ftp-dir-not-readable"
argument_list|,
literal|"QFtp cannot provide enough detail"
argument_list|,
name|Abort
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NetworkError
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|QTEST
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|,
literal|"dataIsEmpty"
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|isRunning
argument_list|()
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|httpStatusCode
argument_list|)
expr_stmt|;
if|if
condition|(
name|httpStatusCode
operator|!=
literal|0
condition|)
block|{
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|httpStatusCode
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|md5sum
specifier|static
specifier|inline
name|QByteArray
name|md5sum
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|data
parameter_list|)
block|{
return|return
name|QCryptographicHash
operator|::
name|hash
argument_list|(
name|data
argument_list|,
name|QCryptographicHash
operator|::
name|Md5
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|putToFile_data
name|void
name|tst_QNetworkReply
operator|::
name|putToFile_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"md5sum"
argument_list|)
expr_stmt|;
name|QByteArray
name|data
decl_stmt|;
name|data
operator|=
literal|""
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
literal|"This is a normal message."
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"generic"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
literal|"This is a message to show that Qt rocks!\r\n\n"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"small"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|"abcd\0\1\2\abcd"
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-nul"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|4097
argument_list|,
literal|'\4'
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"4k+1"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|128
operator|*
literal|1024
operator|+
literal|1
argument_list|,
literal|'\177'
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"128k+1"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|2
operator|*
literal|1024
operator|*
literal|1024
operator|+
literal|1
argument_list|,
literal|'\177'
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"2MB+1"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToFile
name|void
name|tst_QNetworkReply
operator|::
name|putToFile
parameter_list|()
block|{
name|QFile
name|file
argument_list|(
name|testFileName
argument_list|)
decl_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|file
operator|.
name|fileName
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PutOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|Q_INT64_C
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|file
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|file
operator|.
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QByteArray
name|contents
init|=
name|file
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|contents
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToFtp_data
name|void
name|tst_QNetworkReply
operator|::
name|putToFtp_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToFtp
name|void
name|tst_QNetworkReply
operator|::
name|putToFtp
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|url
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/qtest/upload/qnetworkaccess-putToFtp-%1-%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|uniqueExtension
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PutOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|Q_INT64_C
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
comment|// download the file again from FTP to make sure it was uploaded
comment|// correctly
name|QNetworkAccessManager
name|qnam
decl_stmt|;
name|QNetworkRequest
name|req
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|r
init|=
name|qnam
operator|.
name|get
argument_list|(
name|req
argument_list|)
decl_stmt|;
name|QObject
operator|::
name|connect
argument_list|(
name|r
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|r
argument_list|,
name|SIGNAL
argument_list|(
name|downloadProgress
argument_list|(
name|qint64
argument_list|,
name|qint64
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
while|while
condition|(
operator|!
name|r
operator|->
name|isFinished
argument_list|()
condition|)
block|{
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
name|spy
operator|.
name|count
argument_list|()
operator|&&
operator|!
name|r
operator|->
name|isFinished
argument_list|()
condition|)
break|break;
name|count
operator|=
name|spy
operator|.
name|count
argument_list|()
expr_stmt|;
block|}
name|QObject
operator|::
name|disconnect
argument_list|(
name|r
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QByteArray
name|uploaded
init|=
name|r
operator|->
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploaded
operator|.
name|size
argument_list|()
argument_list|,
name|data
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|uploaded
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|r
operator|->
name|close
argument_list|()
expr_stmt|;
name|QObject
operator|::
name|connect
argument_list|(
name|r
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QObject
operator|::
name|disconnect
argument_list|(
name|r
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToFtpWithInvalidCredentials
name|void
name|tst_QNetworkReply
operator|::
name|putToFtpWithInvalidCredentials
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|url
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/qtest/upload/qnetworkaccess-putToFtp-%1-%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|uniqueExtension
argument_list|)
argument_list|)
expr_stmt|;
name|url
operator|.
name|setUserName
argument_list|(
literal|"invalidUser"
argument_list|)
expr_stmt|;
name|url
operator|.
name|setPassword
argument_list|(
literal|"InvalidPassword"
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|req
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|r
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PutOperation
argument_list|,
name|req
argument_list|,
name|r
argument_list|,
name|QByteArray
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|r
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|r
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|r
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
name|r
operator|->
name|close
argument_list|()
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|putToHttp_data
name|void
name|tst_QNetworkReply
operator|::
name|putToHttp_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToHttp
name|void
name|tst_QNetworkReply
operator|::
name|putToHttp
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|url
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/dav/qnetworkaccess-putToHttp-%1-%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|uniqueExtension
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PutOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|201
argument_list|)
expr_stmt|;
comment|// 201 Created
comment|// download the file again from HTTP to make sure it was uploaded
comment|// correctly. HTTP/0.9 is enough
name|QTcpSocket
name|socket
decl_stmt|;
name|socket
operator|.
name|connectToHost
argument_list|(
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|80
argument_list|)
expr_stmt|;
name|socket
operator|.
name|write
argument_list|(
literal|"GET "
operator|+
name|url
operator|.
name|toEncoded
argument_list|(
name|QUrl
operator|::
name|RemoveScheme
operator||
name|QUrl
operator|::
name|RemoveAuthority
argument_list|)
operator|+
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|socket
operator|.
name|waitForDisconnected
argument_list|(
literal|10000
argument_list|)
condition|)
name|QFAIL
argument_list|(
literal|"Network timeout"
argument_list|)
expr_stmt|;
name|QByteArray
name|uploadedData
init|=
name|socket
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToHttpSynchronous_data
name|void
name|tst_QNetworkReply
operator|::
name|putToHttpSynchronous_data
parameter_list|()
block|{
name|uniqueExtension
operator|=
name|createUniqueExtension
argument_list|()
expr_stmt|;
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToHttpSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|putToHttpSynchronous
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|url
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/dav/qnetworkaccess-putToHttp-%1-%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|uniqueExtension
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PutOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|201
argument_list|)
expr_stmt|;
comment|// 201 Created
comment|// download the file again from HTTP to make sure it was uploaded
comment|// correctly. HTTP/0.9 is enough
name|QTcpSocket
name|socket
decl_stmt|;
name|socket
operator|.
name|connectToHost
argument_list|(
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|80
argument_list|)
expr_stmt|;
name|socket
operator|.
name|write
argument_list|(
literal|"GET "
operator|+
name|url
operator|.
name|toEncoded
argument_list|(
name|QUrl
operator|::
name|RemoveScheme
operator||
name|QUrl
operator|::
name|RemoveAuthority
argument_list|)
operator|+
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|socket
operator|.
name|waitForDisconnected
argument_list|(
literal|10000
argument_list|)
condition|)
name|QFAIL
argument_list|(
literal|"Network timeout"
argument_list|)
expr_stmt|;
name|QByteArray
name|uploadedData
init|=
name|socket
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttp_data
name|void
name|tst_QNetworkReply
operator|::
name|postToHttp_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttp
name|void
name|tst_QNetworkReply
operator|::
name|postToHttp
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/md5sum.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PostOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|md5sum
argument_list|)
expr_stmt|;
name|QByteArray
name|uploadedData
init|=
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
argument_list|,
name|md5sum
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttpSynchronous_data
name|void
name|tst_QNetworkReply
operator|::
name|postToHttpSynchronous_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttpSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|postToHttpSynchronous
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/md5sum.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PostOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|md5sum
argument_list|)
expr_stmt|;
name|QByteArray
name|uploadedData
init|=
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
argument_list|,
name|md5sum
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttpMultipart_data
name|void
name|tst_QNetworkReply
operator|::
name|postToHttpMultipart_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QHttpMultiPart
operator|*
argument_list|>
argument_list|(
literal|"multiPart"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"expectedReplyData"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"contentType"
argument_list|)
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/multipart.cgi"
argument_list|)
decl_stmt|;
name|QByteArray
name|expectedData
decl_stmt|;
comment|// empty parts
name|QHttpMultiPart
modifier|*
name|emptyMultiPart
init|=
operator|new
name|QHttpMultiPart
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty"
argument_list|)
operator|<<
name|url
operator|<<
name|emptyMultiPart
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"mixed"
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|emptyRelatedMultiPart
init|=
operator|new
name|QHttpMultiPart
decl_stmt|;
name|emptyRelatedMultiPart
operator|->
name|setContentType
argument_list|(
name|QHttpMultiPart
operator|::
name|RelatedType
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty-related"
argument_list|)
operator|<<
name|url
operator|<<
name|emptyRelatedMultiPart
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"related"
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|emptyAlternativeMultiPart
init|=
operator|new
name|QHttpMultiPart
decl_stmt|;
name|emptyAlternativeMultiPart
operator|->
name|setContentType
argument_list|(
name|QHttpMultiPart
operator|::
name|AlternativeType
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty-alternative"
argument_list|)
operator|<<
name|url
operator|<<
name|emptyAlternativeMultiPart
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"alternative"
argument_list|)
expr_stmt|;
comment|// text-only parts
name|QHttpPart
name|textPart
decl_stmt|;
name|textPart
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"text/plain"
argument_list|)
argument_list|)
expr_stmt|;
name|textPart
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"text\""
argument_list|)
argument_list|)
expr_stmt|;
name|textPart
operator|.
name|setBody
argument_list|(
literal|"7 bytes"
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|multiPart1
init|=
operator|new
name|QHttpMultiPart
decl_stmt|;
name|multiPart1
operator|->
name|setContentType
argument_list|(
name|QHttpMultiPart
operator|::
name|FormDataType
argument_list|)
expr_stmt|;
name|multiPart1
operator|->
name|append
argument_list|(
name|textPart
argument_list|)
expr_stmt|;
name|expectedData
operator|=
literal|"key: text, value: 7 bytes\n"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"text"
argument_list|)
operator|<<
name|url
operator|<<
name|multiPart1
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"form-data"
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|customMultiPart
init|=
operator|new
name|QHttpMultiPart
decl_stmt|;
name|customMultiPart
operator|->
name|append
argument_list|(
name|textPart
argument_list|)
expr_stmt|;
name|expectedData
operator|=
literal|"header: Content-Type, value: 'text/plain'\n"
literal|"header: Content-Disposition, value: 'form-data; name=\"text\"'\n"
literal|"content: 7 bytes\n"
literal|"\n"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"text-custom"
argument_list|)
operator|<<
name|url
operator|<<
name|customMultiPart
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"custom"
argument_list|)
expr_stmt|;
name|QHttpPart
name|textPart2
decl_stmt|;
name|textPart2
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"text/plain"
argument_list|)
argument_list|)
expr_stmt|;
name|textPart2
operator|.
name|setRawHeader
argument_list|(
literal|"myRawHeader"
argument_list|,
literal|"myValue"
argument_list|)
expr_stmt|;
name|textPart2
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"text2\""
argument_list|)
argument_list|)
expr_stmt|;
name|textPart2
operator|.
name|setBody
argument_list|(
literal|"some more bytes"
argument_list|)
expr_stmt|;
name|textPart2
operator|.
name|setBodyDevice
argument_list|(
operator|(
name|QIODevice
operator|*
operator|)
literal|1
argument_list|)
expr_stmt|;
comment|// test whether setting and unsetting of the device works
name|textPart2
operator|.
name|setBodyDevice
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|multiPart2
init|=
operator|new
name|QHttpMultiPart
decl_stmt|;
name|multiPart2
operator|->
name|setContentType
argument_list|(
name|QHttpMultiPart
operator|::
name|FormDataType
argument_list|)
expr_stmt|;
name|multiPart2
operator|->
name|append
argument_list|(
name|textPart
argument_list|)
expr_stmt|;
name|multiPart2
operator|->
name|append
argument_list|(
name|textPart2
argument_list|)
expr_stmt|;
name|expectedData
operator|=
literal|"key: text2, value: some more bytes\n"
literal|"key: text, value: 7 bytes\n"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"text-text"
argument_list|)
operator|<<
name|url
operator|<<
name|multiPart2
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"form-data"
argument_list|)
expr_stmt|;
name|QHttpPart
name|textPart3
decl_stmt|;
name|textPart3
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"text/plain"
argument_list|)
argument_list|)
expr_stmt|;
name|textPart3
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"text3\""
argument_list|)
argument_list|)
expr_stmt|;
name|textPart3
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Location"
argument_list|,
literal|"http://my.test.location.tld"
argument_list|)
expr_stmt|;
name|textPart3
operator|.
name|setBody
argument_list|(
literal|"even more bytes"
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|multiPart3
init|=
operator|new
name|QHttpMultiPart
decl_stmt|;
name|multiPart3
operator|->
name|setContentType
argument_list|(
name|QHttpMultiPart
operator|::
name|AlternativeType
argument_list|)
expr_stmt|;
name|multiPart3
operator|->
name|append
argument_list|(
name|textPart
argument_list|)
expr_stmt|;
name|multiPart3
operator|->
name|append
argument_list|(
name|textPart2
argument_list|)
expr_stmt|;
name|multiPart3
operator|->
name|append
argument_list|(
name|textPart3
argument_list|)
expr_stmt|;
name|expectedData
operator|=
literal|"header: Content-Type, value: 'text/plain'\n"
literal|"header: Content-Disposition, value: 'form-data; name=\"text\"'\n"
literal|"content: 7 bytes\n"
literal|"\n"
literal|"header: Content-Type, value: 'text/plain'\n"
literal|"header: myRawHeader, value: 'myValue'\n"
literal|"header: Content-Disposition, value: 'form-data; name=\"text2\"'\n"
literal|"content: some more bytes\n"
literal|"\n"
literal|"header: Content-Type, value: 'text/plain'\n"
literal|"header: Content-Disposition, value: 'form-data; name=\"text3\"'\n"
literal|"header: Content-Location, value: 'http://my.test.location.tld'\n"
literal|"content: even more bytes\n\n"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"text-text-text"
argument_list|)
operator|<<
name|url
operator|<<
name|multiPart3
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"alternative"
argument_list|)
expr_stmt|;
comment|// text and image parts
name|QHttpPart
name|imagePart11
decl_stmt|;
name|imagePart11
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"image/jpeg"
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart11
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"testImage\""
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart11
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Location"
argument_list|,
literal|"http://my.test.location.tld"
argument_list|)
expr_stmt|;
name|imagePart11
operator|.
name|setRawHeader
argument_list|(
literal|"Content-ID"
argument_list|,
literal|"my@id.tld"
argument_list|)
expr_stmt|;
name|QFile
modifier|*
name|file11
init|=
operator|new
name|QFile
argument_list|(
name|testDataDir
operator|+
literal|"/image1.jpg"
argument_list|)
decl_stmt|;
name|file11
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|imagePart11
operator|.
name|setBodyDevice
argument_list|(
name|file11
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|imageMultiPart1
init|=
operator|new
name|QHttpMultiPart
argument_list|(
name|QHttpMultiPart
operator|::
name|FormDataType
argument_list|)
decl_stmt|;
name|imageMultiPart1
operator|->
name|append
argument_list|(
name|imagePart11
argument_list|)
expr_stmt|;
name|file11
operator|->
name|setParent
argument_list|(
name|imageMultiPart1
argument_list|)
expr_stmt|;
name|expectedData
operator|=
literal|"key: testImage, value: 87ef3bb319b004ba9e5e9c9fa713776e\n"
expr_stmt|;
comment|// md5 sum of file
name|QTest
operator|::
name|newRow
argument_list|(
literal|"image"
argument_list|)
operator|<<
name|url
operator|<<
name|imageMultiPart1
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"form-data"
argument_list|)
expr_stmt|;
name|QHttpPart
name|imagePart21
decl_stmt|;
name|imagePart21
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"image/jpeg"
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart21
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"testImage1\""
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart21
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Location"
argument_list|,
literal|"http://my.test.location.tld"
argument_list|)
expr_stmt|;
name|imagePart21
operator|.
name|setRawHeader
argument_list|(
literal|"Content-ID"
argument_list|,
literal|"my@id.tld"
argument_list|)
expr_stmt|;
name|QFile
modifier|*
name|file21
init|=
operator|new
name|QFile
argument_list|(
name|testDataDir
operator|+
literal|"/image1.jpg"
argument_list|)
decl_stmt|;
name|file21
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|imagePart21
operator|.
name|setBodyDevice
argument_list|(
name|file21
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|imageMultiPart2
init|=
operator|new
name|QHttpMultiPart
argument_list|()
decl_stmt|;
name|imageMultiPart2
operator|->
name|setContentType
argument_list|(
name|QHttpMultiPart
operator|::
name|FormDataType
argument_list|)
expr_stmt|;
name|imageMultiPart2
operator|->
name|append
argument_list|(
name|textPart
argument_list|)
expr_stmt|;
name|imageMultiPart2
operator|->
name|append
argument_list|(
name|imagePart21
argument_list|)
expr_stmt|;
name|file21
operator|->
name|setParent
argument_list|(
name|imageMultiPart2
argument_list|)
expr_stmt|;
name|QHttpPart
name|imagePart22
decl_stmt|;
name|imagePart22
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"image/jpeg"
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart22
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"testImage2\""
argument_list|)
argument_list|)
expr_stmt|;
name|QFile
modifier|*
name|file22
init|=
operator|new
name|QFile
argument_list|(
name|testDataDir
operator|+
literal|"/image2.jpg"
argument_list|)
decl_stmt|;
name|file22
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|imagePart22
operator|.
name|setBodyDevice
argument_list|(
name|file22
argument_list|)
expr_stmt|;
name|imageMultiPart2
operator|->
name|append
argument_list|(
name|imagePart22
argument_list|)
expr_stmt|;
name|file22
operator|->
name|setParent
argument_list|(
name|imageMultiPart2
argument_list|)
expr_stmt|;
name|expectedData
operator|=
literal|"key: testImage1, value: 87ef3bb319b004ba9e5e9c9fa713776e\n"
literal|"key: text, value: 7 bytes\n"
literal|"key: testImage2, value: 483761b893f7fb1bd2414344cd1f3dfb\n"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"text-image-image"
argument_list|)
operator|<<
name|url
operator|<<
name|imageMultiPart2
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"form-data"
argument_list|)
expr_stmt|;
name|QHttpPart
name|imagePart31
decl_stmt|;
name|imagePart31
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"image/jpeg"
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart31
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"testImage1\""
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart31
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Location"
argument_list|,
literal|"http://my.test.location.tld"
argument_list|)
expr_stmt|;
name|imagePart31
operator|.
name|setRawHeader
argument_list|(
literal|"Content-ID"
argument_list|,
literal|"my@id.tld"
argument_list|)
expr_stmt|;
name|QFile
modifier|*
name|file31
init|=
operator|new
name|QFile
argument_list|(
name|testDataDir
operator|+
literal|"/image1.jpg"
argument_list|)
decl_stmt|;
name|file31
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|imagePart31
operator|.
name|setBodyDevice
argument_list|(
name|file31
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|imageMultiPart3
init|=
operator|new
name|QHttpMultiPart
argument_list|(
name|QHttpMultiPart
operator|::
name|FormDataType
argument_list|)
decl_stmt|;
name|imageMultiPart3
operator|->
name|append
argument_list|(
name|imagePart31
argument_list|)
expr_stmt|;
name|file31
operator|->
name|setParent
argument_list|(
name|imageMultiPart3
argument_list|)
expr_stmt|;
name|QHttpPart
name|imagePart32
decl_stmt|;
name|imagePart32
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"image/jpeg"
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart32
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"testImage2\""
argument_list|)
argument_list|)
expr_stmt|;
name|QFile
modifier|*
name|file32
init|=
operator|new
name|QFile
argument_list|(
name|testDataDir
operator|+
literal|"/image2.jpg"
argument_list|)
decl_stmt|;
name|file32
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|imagePart32
operator|.
name|setBodyDevice
argument_list|(
name|file31
argument_list|)
expr_stmt|;
comment|// check that resetting works
name|imagePart32
operator|.
name|setBodyDevice
argument_list|(
name|file32
argument_list|)
expr_stmt|;
name|imageMultiPart3
operator|->
name|append
argument_list|(
name|imagePart32
argument_list|)
expr_stmt|;
name|file32
operator|->
name|setParent
argument_list|(
name|imageMultiPart3
argument_list|)
expr_stmt|;
name|QHttpPart
name|imagePart33
decl_stmt|;
name|imagePart33
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"image/jpeg"
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart33
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"testImage3\""
argument_list|)
argument_list|)
expr_stmt|;
name|QFile
modifier|*
name|file33
init|=
operator|new
name|QFile
argument_list|(
name|testDataDir
operator|+
literal|"/image3.jpg"
argument_list|)
decl_stmt|;
name|file33
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|imagePart33
operator|.
name|setBodyDevice
argument_list|(
name|file33
argument_list|)
expr_stmt|;
name|imageMultiPart3
operator|->
name|append
argument_list|(
name|imagePart33
argument_list|)
expr_stmt|;
name|file33
operator|->
name|setParent
argument_list|(
name|imageMultiPart3
argument_list|)
expr_stmt|;
name|expectedData
operator|=
literal|"key: testImage1, value: 87ef3bb319b004ba9e5e9c9fa713776e\n"
literal|"key: testImage2, value: 483761b893f7fb1bd2414344cd1f3dfb\n"
literal|"key: testImage3, value: ab0eb6fd4fcf8b4436254870b4513033\n"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"3-images"
argument_list|)
operator|<<
name|url
operator|<<
name|imageMultiPart3
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"form-data"
argument_list|)
expr_stmt|;
comment|// note: nesting multiparts is not working currently; for that, the outputDevice would need to be public
comment|//    QHttpPart imagePart41;
comment|//    imagePart41.setHeader(QNetworkRequest::ContentTypeHeader, QVariant("image/jpeg"));
comment|//    QFile *file41 = new QFile(testDataDir + "/image1.jpg");
comment|//    file41->open(QIODevice::ReadOnly);
comment|//    imagePart41.setBodyDevice(file41);
comment|//
comment|//    QHttpMultiPart *innerMultiPart = new QHttpMultiPart();
comment|//    innerMultiPart->setContentType(QHttpMultiPart::FormDataType);
comment|//    textPart.setHeader(QNetworkRequest::ContentDispositionHeader, QVariant());
comment|//    innerMultiPart->append(textPart);
comment|//    innerMultiPart->append(imagePart41);
comment|//    textPart2.setHeader(QNetworkRequest::ContentDispositionHeader, QVariant());
comment|//    innerMultiPart->append(textPart2);
comment|//
comment|//    QHttpPart nestedPart;
comment|//    nestedPart.setHeader(QNetworkRequest::ContentDispositionHeader, QVariant("form-data; name=\"nestedMessage"));
comment|//    nestedPart.setHeader(QNetworkRequest::ContentTypeHeader, QVariant("multipart/alternative; boundary=\"" + innerMultiPart->boundary() + "\""));
comment|//    innerMultiPart->outputDevice()->open(QIODevice::ReadOnly);
comment|//    nestedPart.setBodyDevice(innerMultiPart->outputDevice());
comment|//
comment|//    QHttpMultiPart *outerMultiPart = new QHttpMultiPart;
comment|//    outerMultiPart->setContentType(QHttpMultiPart::FormDataType);
comment|//    outerMultiPart->append(textPart);
comment|//    outerMultiPart->append(nestedPart);
comment|//    outerMultiPart->append(textPart2);
comment|//    expectedData = "nothing"; // the CGI.pm module running on the test server does not understand nested multiparts
comment|//    openFiles.clear();
comment|//    openFiles<< file41;
comment|//    QTest::newRow("nested")<< url<< outerMultiPart<< expectedData<< openFiles;
comment|// test setting large chunks of content with a byte array instead of a device (DISCOURAGED because of high memory consumption,
comment|// but we need to test that the behavior is correct)
name|QHttpPart
name|imagePart51
decl_stmt|;
name|imagePart51
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|QVariant
argument_list|(
literal|"image/jpeg"
argument_list|)
argument_list|)
expr_stmt|;
name|imagePart51
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
name|QVariant
argument_list|(
literal|"form-data; name=\"testImage\""
argument_list|)
argument_list|)
expr_stmt|;
name|QFile
modifier|*
name|file51
init|=
operator|new
name|QFile
argument_list|(
name|testDataDir
operator|+
literal|"/image1.jpg"
argument_list|)
decl_stmt|;
name|file51
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|QByteArray
name|imageData
init|=
name|file51
operator|->
name|readAll
argument_list|()
decl_stmt|;
name|file51
operator|->
name|close
argument_list|()
expr_stmt|;
operator|delete
name|file51
expr_stmt|;
name|imagePart51
operator|.
name|setBody
argument_list|(
literal|"7 bytes"
argument_list|)
expr_stmt|;
comment|// check that resetting works
name|imagePart51
operator|.
name|setBody
argument_list|(
name|imageData
argument_list|)
expr_stmt|;
name|QHttpMultiPart
modifier|*
name|imageMultiPart5
init|=
operator|new
name|QHttpMultiPart
decl_stmt|;
name|imageMultiPart5
operator|->
name|setContentType
argument_list|(
name|QHttpMultiPart
operator|::
name|FormDataType
argument_list|)
expr_stmt|;
name|imageMultiPart5
operator|->
name|append
argument_list|(
name|imagePart51
argument_list|)
expr_stmt|;
name|expectedData
operator|=
literal|"key: testImage, value: 87ef3bb319b004ba9e5e9c9fa713776e\n"
expr_stmt|;
comment|// md5 sum of file
name|QTest
operator|::
name|newRow
argument_list|(
literal|"image-as-content"
argument_list|)
operator|<<
name|url
operator|<<
name|imageMultiPart5
operator|<<
name|expectedData
operator|<<
name|QByteArray
argument_list|(
literal|"form-data"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttpMultipart
name|void
name|tst_QNetworkReply
operator|::
name|postToHttpMultipart
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
specifier|static
name|QSet
argument_list|<
name|QByteArray
argument_list|>
name|boundaries
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QHttpMultiPart
operator|*
argument_list|,
name|multiPart
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|expectedReplyData
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|contentType
argument_list|)
expr_stmt|;
comment|// hack for testing the setting of the content-type header by hand:
if|if
condition|(
name|contentType
operator|==
literal|"custom"
condition|)
block|{
name|QByteArray
name|contentType
argument_list|(
literal|"multipart/custom; boundary=\""
operator|+
name|multiPart
operator|->
name|boundary
argument_list|()
operator|+
literal|"\""
argument_list|)
decl_stmt|;
name|request
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|contentType
argument_list|)
expr_stmt|;
block|}
name|QVERIFY2
argument_list|(
operator|!
name|boundaries
operator|.
name|contains
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
argument_list|)
argument_list|,
literal|"boundary '"
operator|+
name|multiPart
operator|->
name|boundary
argument_list|()
operator|+
literal|"' has been created twice"
argument_list|)
expr_stmt|;
name|boundaries
operator|.
name|insert
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runMultipartRequest
argument_list|(
name|request
argument_list|,
name|reply
argument_list|,
name|multiPart
argument_list|,
literal|"POST"
argument_list|)
argument_list|)
expr_stmt|;
name|multiPart
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QVERIFY
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
operator|.
name|count
argument_list|()
operator|>
literal|20
argument_list|)
expr_stmt|;
comment|// check that there is randomness after the "boundary_.oOo._" string
name|QVERIFY
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
operator|.
name|count
argument_list|()
operator|<
literal|70
argument_list|)
expr_stmt|;
name|QByteArray
name|replyData
init|=
name|reply
operator|->
name|readAll
argument_list|()
decl_stmt|;
name|expectedReplyData
operator|.
name|prepend
argument_list|(
literal|"content type: multipart/"
operator|+
name|contentType
operator|+
literal|"; boundary=\""
operator|+
name|multiPart
operator|->
name|boundary
argument_list|()
operator|+
literal|"\"\n"
argument_list|)
expr_stmt|;
comment|//    QEXPECT_FAIL("nested", "the server does not understand nested multipart messages", Continue); // see above
name|QCOMPARE
argument_list|(
name|replyData
argument_list|,
name|expectedReplyData
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|multipartSkipIndices
name|void
name|tst_QNetworkReply
operator|::
name|multipartSkipIndices
parameter_list|()
comment|// QTBUG-32534
block|{
name|QHttpMultiPart
modifier|*
name|multiPart
init|=
operator|new
name|QHttpMultiPart
argument_list|(
name|QHttpMultiPart
operator|::
name|MixedType
argument_list|)
decl_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/multipart.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QList
argument_list|<
name|QByteArray
argument_list|>
name|parts
decl_stmt|;
name|parts
operator|<<
name|QByteArray
argument_list|(
literal|56083
argument_list|,
literal|'X'
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|468
argument_list|,
literal|'X'
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|24952
argument_list|,
literal|'X'
argument_list|)
expr_stmt|;
name|QHttpPart
name|part1
decl_stmt|;
name|part1
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
literal|"form-data; name=\"field1\"; filename=\"aaaa.bin\""
argument_list|)
expr_stmt|;
name|part1
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|part1
operator|.
name|setBody
argument_list|(
name|parts
operator|.
name|at
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|multiPart
operator|->
name|append
argument_list|(
name|part1
argument_list|)
expr_stmt|;
name|QHttpPart
name|part2
decl_stmt|;
name|part2
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
literal|"form-data; name=\"field2\"; filename=\"bbbb.txt\""
argument_list|)
expr_stmt|;
name|part2
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
literal|"text/plain"
argument_list|)
expr_stmt|;
name|part2
operator|.
name|setBody
argument_list|(
name|parts
operator|.
name|at
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|multiPart
operator|->
name|append
argument_list|(
name|part2
argument_list|)
expr_stmt|;
name|QHttpPart
name|part3
decl_stmt|;
name|part3
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentDispositionHeader
argument_list|,
literal|"form-data; name=\"text-3\"; filename=\"cccc.txt\""
argument_list|)
expr_stmt|;
name|part3
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
literal|"text/plain"
argument_list|)
expr_stmt|;
name|part3
operator|.
name|setBody
argument_list|(
name|parts
operator|.
name|at
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|multiPart
operator|->
name|append
argument_list|(
name|part3
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runMultipartRequest
argument_list|(
name|request
argument_list|,
name|reply
argument_list|,
name|multiPart
argument_list|,
literal|"POST"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QByteArray
name|line
decl_stmt|;
name|int
name|partIndex
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|line
operator|=
name|reply
operator|->
name|readLine
argument_list|()
operator|)
operator|!=
name|QByteArray
argument_list|(
literal|""
argument_list|)
condition|)
block|{
if|if
condition|(
name|line
operator|.
name|startsWith
argument_list|(
literal|"content:"
argument_list|)
condition|)
block|{
comment|// before, the 3rd part would return garbled output at the end
name|QCOMPARE
argument_list|(
literal|"content: "
operator|+
name|parts
index|[
name|partIndex
operator|++
index|]
operator|+
literal|"\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
block|}
name|multiPart
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToHttpMultipart_data
name|void
name|tst_QNetworkReply
operator|::
name|putToHttpMultipart_data
parameter_list|()
block|{
name|postToHttpMultipart_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToHttpMultipart
name|void
name|tst_QNetworkReply
operator|::
name|putToHttpMultipart
parameter_list|()
block|{
name|QSKIP
argument_list|(
literal|"test server script cannot handle PUT data yet"
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
specifier|static
name|QSet
argument_list|<
name|QByteArray
argument_list|>
name|boundaries
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QHttpMultiPart
operator|*
argument_list|,
name|multiPart
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|expectedReplyData
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|contentType
argument_list|)
expr_stmt|;
comment|// hack for testing the setting of the content-type header by hand:
if|if
condition|(
name|contentType
operator|==
literal|"custom"
condition|)
block|{
name|QByteArray
name|contentType
argument_list|(
literal|"multipart/custom; boundary=\""
operator|+
name|multiPart
operator|->
name|boundary
argument_list|()
operator|+
literal|"\""
argument_list|)
decl_stmt|;
name|request
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|contentType
argument_list|)
expr_stmt|;
block|}
name|QVERIFY2
argument_list|(
operator|!
name|boundaries
operator|.
name|contains
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
argument_list|)
argument_list|,
literal|"boundary '"
operator|+
name|multiPart
operator|->
name|boundary
argument_list|()
operator|+
literal|"' has been created twice"
argument_list|)
expr_stmt|;
name|boundaries
operator|.
name|insert
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runMultipartRequest
argument_list|(
name|request
argument_list|,
name|reply
argument_list|,
name|multiPart
argument_list|,
literal|"PUT"
argument_list|)
argument_list|)
expr_stmt|;
name|multiPart
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QVERIFY
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
operator|.
name|count
argument_list|()
operator|>
literal|20
argument_list|)
expr_stmt|;
comment|// check that there is randomness after the "boundary_.oOo._" string
name|QVERIFY
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
operator|.
name|count
argument_list|()
operator|<
literal|70
argument_list|)
expr_stmt|;
name|QByteArray
name|replyData
init|=
name|reply
operator|->
name|readAll
argument_list|()
decl_stmt|;
name|expectedReplyData
operator|.
name|prepend
argument_list|(
literal|"content type: multipart/"
operator|+
name|contentType
operator|+
literal|"; boundary=\""
operator|+
name|multiPart
operator|->
name|boundary
argument_list|()
operator|+
literal|"\"\n"
argument_list|)
expr_stmt|;
comment|//    QEXPECT_FAIL("nested", "the server does not understand nested multipart messages", Continue); // see above
name|QCOMPARE
argument_list|(
name|replyData
argument_list|,
name|expectedReplyData
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_SSL
end_ifndef
begin_function
DECL|function|putToHttps_data
name|void
name|tst_QNetworkReply
operator|::
name|putToHttps_data
parameter_list|()
block|{
name|uniqueExtension
operator|=
name|createUniqueExtension
argument_list|()
expr_stmt|;
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToHttps
name|void
name|tst_QNetworkReply
operator|::
name|putToHttps
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|url
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/dav/qnetworkaccess-putToHttp-%1-%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|uniqueExtension
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QList
argument_list|<
name|QSslCertificate
argument_list|>
name|certs
init|=
name|QSslCertificate
operator|::
name|fromPath
argument_list|(
name|testDataDir
operator|+
literal|"/certs/qt-test-server-cacert.pem"
argument_list|)
decl_stmt|;
name|QSslConfiguration
name|conf
decl_stmt|;
name|conf
operator|.
name|setCaCertificates
argument_list|(
name|certs
argument_list|)
expr_stmt|;
name|request
operator|.
name|setSslConfiguration
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PutOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|201
argument_list|)
expr_stmt|;
comment|// 201 Created
comment|// download the file again from HTTP to make sure it was uploaded
comment|// correctly. HTTP/0.9 is enough
name|QTcpSocket
name|socket
decl_stmt|;
name|socket
operator|.
name|connectToHost
argument_list|(
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|80
argument_list|)
expr_stmt|;
name|socket
operator|.
name|write
argument_list|(
literal|"GET "
operator|+
name|url
operator|.
name|toEncoded
argument_list|(
name|QUrl
operator|::
name|RemoveScheme
operator||
name|QUrl
operator|::
name|RemoveAuthority
argument_list|)
operator|+
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|socket
operator|.
name|waitForDisconnected
argument_list|(
literal|10000
argument_list|)
condition|)
name|QFAIL
argument_list|(
literal|"Network timeout"
argument_list|)
expr_stmt|;
name|QByteArray
name|uploadedData
init|=
name|socket
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToHttpsSynchronous_data
name|void
name|tst_QNetworkReply
operator|::
name|putToHttpsSynchronous_data
parameter_list|()
block|{
name|uniqueExtension
operator|=
name|createUniqueExtension
argument_list|()
expr_stmt|;
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putToHttpsSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|putToHttpsSynchronous
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|url
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/dav/qnetworkaccess-putToHttp-%1-%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|uniqueExtension
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QList
argument_list|<
name|QSslCertificate
argument_list|>
name|certs
init|=
name|QSslCertificate
operator|::
name|fromPath
argument_list|(
name|testDataDir
operator|+
literal|"/certs/qt-test-server-cacert.pem"
argument_list|)
decl_stmt|;
name|QSslConfiguration
name|conf
decl_stmt|;
name|conf
operator|.
name|setCaCertificates
argument_list|(
name|certs
argument_list|)
expr_stmt|;
name|request
operator|.
name|setSslConfiguration
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PutOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|201
argument_list|)
expr_stmt|;
comment|// 201 Created
comment|// download the file again from HTTP to make sure it was uploaded
comment|// correctly. HTTP/0.9 is enough
name|QTcpSocket
name|socket
decl_stmt|;
name|socket
operator|.
name|connectToHost
argument_list|(
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|80
argument_list|)
expr_stmt|;
name|socket
operator|.
name|write
argument_list|(
literal|"GET "
operator|+
name|url
operator|.
name|toEncoded
argument_list|(
name|QUrl
operator|::
name|RemoveScheme
operator||
name|QUrl
operator|::
name|RemoveAuthority
argument_list|)
operator|+
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|socket
operator|.
name|waitForDisconnected
argument_list|(
literal|10000
argument_list|)
condition|)
name|QFAIL
argument_list|(
literal|"Network timeout"
argument_list|)
expr_stmt|;
name|QByteArray
name|uploadedData
init|=
name|socket
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttps_data
name|void
name|tst_QNetworkReply
operator|::
name|postToHttps_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttps
name|void
name|tst_QNetworkReply
operator|::
name|postToHttps
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/md5sum.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QList
argument_list|<
name|QSslCertificate
argument_list|>
name|certs
init|=
name|QSslCertificate
operator|::
name|fromPath
argument_list|(
name|testDataDir
operator|+
literal|"/certs/qt-test-server-cacert.pem"
argument_list|)
decl_stmt|;
name|QSslConfiguration
name|conf
decl_stmt|;
name|conf
operator|.
name|setCaCertificates
argument_list|(
name|certs
argument_list|)
expr_stmt|;
name|request
operator|.
name|setSslConfiguration
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PostOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|md5sum
argument_list|)
expr_stmt|;
name|QByteArray
name|uploadedData
init|=
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
argument_list|,
name|md5sum
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttpsSynchronous_data
name|void
name|tst_QNetworkReply
operator|::
name|postToHttpsSynchronous_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttpsSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|postToHttpsSynchronous
parameter_list|()
block|{
name|QUrl
name|url
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/md5sum.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QList
argument_list|<
name|QSslCertificate
argument_list|>
name|certs
init|=
name|QSslCertificate
operator|::
name|fromPath
argument_list|(
name|testDataDir
operator|+
literal|"/certs/qt-test-server-cacert.pem"
argument_list|)
decl_stmt|;
name|QSslConfiguration
name|conf
decl_stmt|;
name|conf
operator|.
name|setCaCertificates
argument_list|(
name|certs
argument_list|)
expr_stmt|;
name|request
operator|.
name|setSslConfiguration
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PostOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|md5sum
argument_list|)
expr_stmt|;
name|QByteArray
name|uploadedData
init|=
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
argument_list|,
name|md5sum
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttpsMultipart_data
name|void
name|tst_QNetworkReply
operator|::
name|postToHttpsMultipart_data
parameter_list|()
block|{
name|postToHttpMultipart_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|postToHttpsMultipart
name|void
name|tst_QNetworkReply
operator|::
name|postToHttpsMultipart
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|url
operator|.
name|setScheme
argument_list|(
literal|"https"
argument_list|)
expr_stmt|;
specifier|static
name|QSet
argument_list|<
name|QByteArray
argument_list|>
name|boundaries
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QList
argument_list|<
name|QSslCertificate
argument_list|>
name|certs
init|=
name|QSslCertificate
operator|::
name|fromPath
argument_list|(
name|testDataDir
operator|+
literal|"/certs/qt-test-server-cacert.pem"
argument_list|)
decl_stmt|;
name|QSslConfiguration
name|conf
decl_stmt|;
name|conf
operator|.
name|setCaCertificates
argument_list|(
name|certs
argument_list|)
expr_stmt|;
name|request
operator|.
name|setSslConfiguration
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QHttpMultiPart
operator|*
argument_list|,
name|multiPart
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|expectedReplyData
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|contentType
argument_list|)
expr_stmt|;
comment|// hack for testing the setting of the content-type header by hand:
if|if
condition|(
name|contentType
operator|==
literal|"custom"
condition|)
block|{
name|QByteArray
name|contentType
argument_list|(
literal|"multipart/custom; boundary=\""
operator|+
name|multiPart
operator|->
name|boundary
argument_list|()
operator|+
literal|"\""
argument_list|)
decl_stmt|;
name|request
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|,
name|contentType
argument_list|)
expr_stmt|;
block|}
name|QVERIFY2
argument_list|(
operator|!
name|boundaries
operator|.
name|contains
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
argument_list|)
argument_list|,
literal|"boundary '"
operator|+
name|multiPart
operator|->
name|boundary
argument_list|()
operator|+
literal|"' has been created twice"
argument_list|)
expr_stmt|;
name|boundaries
operator|.
name|insert
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runMultipartRequest
argument_list|(
name|request
argument_list|,
name|reply
argument_list|,
name|multiPart
argument_list|,
literal|"POST"
argument_list|)
argument_list|)
expr_stmt|;
name|multiPart
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QVERIFY
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
operator|.
name|count
argument_list|()
operator|>
literal|20
argument_list|)
expr_stmt|;
comment|// check that there is randomness after the "boundary_.oOo._" string
name|QVERIFY
argument_list|(
name|multiPart
operator|->
name|boundary
argument_list|()
operator|.
name|count
argument_list|()
operator|<
literal|70
argument_list|)
expr_stmt|;
name|QByteArray
name|replyData
init|=
name|reply
operator|->
name|readAll
argument_list|()
decl_stmt|;
name|expectedReplyData
operator|.
name|prepend
argument_list|(
literal|"content type: multipart/"
operator|+
name|contentType
operator|+
literal|"; boundary=\""
operator|+
name|multiPart
operator|->
name|boundary
argument_list|()
operator|+
literal|"\"\n"
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|replyData
argument_list|,
name|expectedReplyData
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// QT_NO_SSL
end_comment
begin_function
DECL|function|deleteFromHttp_data
name|void
name|tst_QNetworkReply
operator|::
name|deleteFromHttp_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"resultCode"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"error"
argument_list|)
expr_stmt|;
comment|// for status codes to expect, see http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html
name|QTest
operator|::
name|newRow
argument_list|(
literal|"405-method-not-allowed"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/index.html"
argument_list|)
operator|<<
literal|405
operator|<<
name|QNetworkReply
operator|::
name|ContentOperationNotPermittedError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"200-ok"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/http-delete.cgi?200-ok"
argument_list|)
operator|<<
literal|200
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"202-accepted"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/http-delete.cgi?202-accepted"
argument_list|)
operator|<<
literal|202
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"204-no-content"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/http-delete.cgi?204-no-content"
argument_list|)
operator|<<
literal|204
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"404-not-found"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/http-delete.cgi?404-not-found"
argument_list|)
operator|<<
literal|404
operator|<<
name|QNetworkReply
operator|::
name|ContentNotFoundError
expr_stmt|;
block|}
end_function
begin_function
DECL|function|deleteFromHttp
name|void
name|tst_QNetworkReply
operator|::
name|deleteFromHttp
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|resultCode
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|DeleteOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|resultCode
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putGetDeleteGetFromHttp_data
name|void
name|tst_QNetworkReply
operator|::
name|putGetDeleteGetFromHttp_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"putUrl"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"putResultCode"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"putError"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"deleteUrl"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"deleteResultCode"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"deleteError"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"get2Url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"get2ResultCode"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"get2Error"
argument_list|)
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|url
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/dav/qnetworkaccess-putToHttp-%1-%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|uniqueExtension
argument_list|)
argument_list|)
expr_stmt|;
comment|// first use case: put, get (to check it is there), delete, get (to check it is not there anymore)
name|QTest
operator|::
name|newRow
argument_list|(
literal|"success"
argument_list|)
operator|<<
name|url
operator|<<
literal|201
operator|<<
name|QNetworkReply
operator|::
name|NoError
operator|<<
name|url
operator|<<
literal|204
operator|<<
name|QNetworkReply
operator|::
name|NoError
operator|<<
name|url
operator|<<
literal|404
operator|<<
name|QNetworkReply
operator|::
name|ContentNotFoundError
expr_stmt|;
name|QUrl
name|wrongUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|wrongUrl
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/dav/qnetworkaccess-thisURLisNotAvailable"
argument_list|)
argument_list|)
expr_stmt|;
comment|// second use case: put, get (to check it is there), delete wrong URL, get (to check it is still there)
name|QTest
operator|::
name|newRow
argument_list|(
literal|"delete-error"
argument_list|)
operator|<<
name|url
operator|<<
literal|201
operator|<<
name|QNetworkReply
operator|::
name|NoError
operator|<<
name|wrongUrl
operator|<<
literal|404
operator|<<
name|QNetworkReply
operator|::
name|ContentNotFoundError
operator|<<
name|url
operator|<<
literal|200
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
block|}
end_function
begin_function
DECL|function|putGetDeleteGetFromHttp
name|void
name|tst_QNetworkReply
operator|::
name|putGetDeleteGetFromHttp
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|putUrl
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|putResultCode
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|putError
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|deleteUrl
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|deleteResultCode
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|deleteError
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|get2Url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|get2ResultCode
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|get2Error
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|putRequest
argument_list|(
name|putUrl
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|deleteRequest
argument_list|(
name|deleteUrl
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|get2Request
argument_list|(
name|get2Url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PutOperation
argument_list|,
name|putRequest
argument_list|,
name|reply
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|putError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|putResultCode
argument_list|)
expr_stmt|;
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|putRequest
argument_list|,
name|reply
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|DeleteOperation
argument_list|,
name|deleteRequest
argument_list|,
name|reply
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|deleteError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|deleteResultCode
argument_list|)
expr_stmt|;
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|get2Request
argument_list|,
name|reply
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|get2Error
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|get2ResultCode
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|connectToIPv6Address_data
name|void
name|tst_QNetworkReply
operator|::
name|connectToIPv6Address_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"error"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"dataToSend"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"hostfield"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"localhost"
argument_list|)
operator|<<
name|QUrl
argument_list|(
name|QByteArray
argument_list|(
literal|"http://[::1]"
argument_list|)
argument_list|)
operator|<<
name|QNetworkReply
operator|::
name|NoError
operator|<<
name|QByteArray
argument_list|(
literal|"localhost"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"[::1]"
argument_list|)
expr_stmt|;
comment|//QTest::newRow("ipv4localhost")<< QUrl(QByteArray("http://127.0.0.1"))<< QNetworkReply::NoError<< QByteArray("ipv4localhost")<< QByteArray("127.0.0.1");
comment|//to add more test data here
block|}
end_function
begin_function
DECL|function|connectToIPv6Address
name|void
name|tst_QNetworkReply
operator|::
name|connectToIPv6Address
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|dataToSend
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|hostfield
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|QtNetworkSettings
operator|::
name|hasIPv6
argument_list|()
condition|)
name|QSKIP
argument_list|(
literal|"system doesn't support ipv6!"
argument_list|)
expr_stmt|;
name|QByteArray
name|httpResponse
init|=
name|QByteArray
argument_list|(
literal|"HTTP/1.0 200 OK\r\nContent-Length: "
argument_list|)
decl_stmt|;
name|httpResponse
operator|+=
name|QByteArray
operator|::
name|number
argument_list|(
name|dataToSend
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|httpResponse
operator|+=
literal|"\r\n\r\n"
expr_stmt|;
name|httpResponse
operator|+=
name|dataToSend
expr_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|httpResponse
argument_list|,
literal|false
argument_list|,
name|NULL
comment|/*thread*/
argument_list|,
literal|true
comment|/*useipv6*/
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|url
operator|.
name|setPort
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QByteArray
name|content
init|=
name|reply
operator|->
name|readAll
argument_list|()
decl_stmt|;
comment|//qDebug()<< server.receivedData;
name|QByteArray
name|hostinfo
init|=
literal|"\r\nHost: "
operator|+
name|hostfield
operator|+
literal|":"
operator|+
name|QByteArray
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
operator|+
literal|"\r\n"
decl_stmt|;
name|QVERIFY
argument_list|(
name|server
operator|.
name|receivedData
operator|.
name|contains
argument_list|(
name|hostinfo
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|content
operator|==
name|dataToSend
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|error
argument_list|()
operator|==
name|error
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sendCustomRequestToHttp_data
name|void
name|tst_QNetworkReply
operator|::
name|sendCustomRequestToHttp_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"verb"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QBuffer
operator|*
argument_list|>
argument_list|(
literal|"device"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"resultCode"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"error"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"expectedContent"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"options"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"OPTIONS"
argument_list|)
operator|<<
operator|(
name|QBuffer
operator|*
operator|)
literal|0
operator|<<
literal|200
operator|<<
name|QNetworkReply
operator|::
name|NoError
operator|<<
name|QByteArray
argument_list|()
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"trace"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"TRACE"
argument_list|)
operator|<<
operator|(
name|QBuffer
operator|*
operator|)
literal|0
operator|<<
literal|200
operator|<<
name|QNetworkReply
operator|::
name|NoError
operator|<<
name|QByteArray
argument_list|()
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"connect"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"CONNECT"
argument_list|)
operator|<<
operator|(
name|QBuffer
operator|*
operator|)
literal|0
operator|<<
literal|400
operator|<<
name|QNetworkReply
operator|::
name|ProtocolInvalidOperationError
operator|<<
name|QByteArray
argument_list|()
expr_stmt|;
comment|// 400 = Bad Request
name|QTest
operator|::
name|newRow
argument_list|(
literal|"nonsense"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"NONSENSE"
argument_list|)
operator|<<
operator|(
name|QBuffer
operator|*
operator|)
literal|0
operator|<<
literal|501
operator|<<
name|QNetworkReply
operator|::
name|OperationNotImplementedError
operator|<<
name|QByteArray
argument_list|()
expr_stmt|;
comment|// 501 = Method Not Implemented
name|QByteArray
name|ba
argument_list|(
literal|"test"
argument_list|)
decl_stmt|;
name|QBuffer
modifier|*
name|buffer
init|=
operator|new
name|QBuffer
decl_stmt|;
name|buffer
operator|->
name|setData
argument_list|(
name|ba
argument_list|)
expr_stmt|;
name|buffer
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"post"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/md5sum.cgi"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"POST"
argument_list|)
operator|<<
name|buffer
operator|<<
literal|200
operator|<<
name|QNetworkReply
operator|::
name|NoError
operator|<<
name|QByteArray
argument_list|(
literal|"098f6bcd4621d373cade4e832627b4f6\n"
argument_list|)
expr_stmt|;
name|QByteArray
name|ba2
argument_list|(
literal|"test"
argument_list|)
decl_stmt|;
name|QBuffer
modifier|*
name|buffer2
init|=
operator|new
name|QBuffer
decl_stmt|;
name|buffer2
operator|->
name|setData
argument_list|(
name|ba2
argument_list|)
expr_stmt|;
name|buffer2
operator|->
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"put"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/md5sum.cgi"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"PUT"
argument_list|)
operator|<<
name|buffer2
operator|<<
literal|200
operator|<<
name|QNetworkReply
operator|::
name|NoError
operator|<<
name|QByteArray
argument_list|(
literal|"098f6bcd4621d373cade4e832627b4f6\n"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sendCustomRequestToHttp
name|void
name|tst_QNetworkReply
operator|::
name|sendCustomRequestToHttp
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|verb
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QBuffer
operator|*
argument_list|,
name|device
argument_list|)
expr_stmt|;
name|runCustomRequest
argument_list|(
name|request
argument_list|,
name|reply
argument_list|,
name|verb
argument_list|,
name|device
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|resultCode
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|resultCode
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|expectedContent
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|expectedContent
operator|.
name|isEmpty
argument_list|()
condition|)
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|expectedContent
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromData_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromData_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"urlStr"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"data-empty"
argument_list|)
operator|<<
literal|"data:,"
operator|<<
name|QByteArray
argument_list|()
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"data-literal"
argument_list|)
operator|<<
literal|"data:,foo"
operator|<<
name|QByteArray
argument_list|(
literal|"foo"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"data-pct"
argument_list|)
operator|<<
literal|"data:,%3Cbody%20contentEditable%3Dtrue%3E%0D%0A"
operator|<<
name|QByteArray
argument_list|(
literal|"<body contentEditable=true>\r\n"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"data-base64"
argument_list|)
operator|<<
literal|"data:;base64,UXQgaXMgZ3JlYXQh"
operator|<<
name|QByteArray
argument_list|(
literal|"Qt is great!"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromData
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromData
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|urlStr
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromEncoded
argument_list|(
name|urlStr
operator|.
name|toLatin1
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|data
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|,
name|data
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromFileSpecial_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromFileSpecial_data
parameter_list|()
block|{
name|getFromFileSpecial_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromFileSpecial
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromFileSpecial
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|fileName
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFile
name|resource
argument_list|(
name|fileName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|resource
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
decl_stmt|;
name|request
operator|.
name|setUrl
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|resource
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|resource
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|resource
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromFile_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromFile_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromFile
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromFile
parameter_list|()
block|{
name|QTemporaryFile
name|file
argument_list|(
name|QDir
operator|::
name|currentPath
argument_list|()
operator|+
literal|"/temp-XXXXXX"
argument_list|)
decl_stmt|;
name|file
operator|.
name|setAutoRemove
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|file
operator|.
name|open
argument_list|()
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|file
operator|.
name|write
argument_list|(
name|data
argument_list|)
operator|==
name|data
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|file
operator|.
name|flush
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|file
operator|.
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|file
operator|.
name|fileName
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// a file should immediately be done
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|file
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|file
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromFtp_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromFtp_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"fileName"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|qint64
argument_list|>
argument_list|(
literal|"expectedSize"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"bigfile"
argument_list|)
operator|<<
literal|"bigfile"
operator|<<
name|Q_INT64_C
argument_list|(
literal|519240
argument_list|)
expr_stmt|;
name|QFile
name|file
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"rfc3252.txt"
argument_list|)
operator|<<
literal|"rfc3252.txt"
operator|<<
name|file
operator|.
name|size
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromFtp
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromFtp
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|fileName
argument_list|)
expr_stmt|;
name|QFile
name|reference
argument_list|(
name|fileName
argument_list|)
decl_stmt|;
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
comment|// will fail for bigfile
name|QNetworkRequest
name|request
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/"
operator|+
name|fileName
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|qint64
argument_list|,
name|expectedSize
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|expectedSize
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|expectedSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|reference
operator|.
name|isOpen
argument_list|()
condition|)
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromFtpWithReuse
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromFtpWithReuse
parameter_list|()
block|{
name|QString
name|fileName
init|=
name|testDataDir
operator|+
literal|"/rfc3252.txt"
decl_stmt|;
name|QFile
name|reference
argument_list|(
name|fileName
argument_list|)
decl_stmt|;
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
comment|// two concurrent (actually, consecutive) gets:
name|QNetworkReplyPtr
name|reply1
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader1
argument_list|(
name|reply1
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply2
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader2
argument_list|(
name|reply2
argument_list|)
decl_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply1
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply1
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply2
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader1
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader2
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QByteArray
name|referenceData
init|=
name|reference
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|reader1
operator|.
name|data
argument_list|,
name|referenceData
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader2
operator|.
name|data
argument_list|,
name|referenceData
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttp
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttp
parameter_list|()
block|{
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpWithReuseParallel
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithReuseParallel
parameter_list|()
block|{
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply1
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply2
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader1
argument_list|(
name|reply1
argument_list|)
decl_stmt|;
name|DataReader
name|reader2
argument_list|(
name|reply2
argument_list|)
decl_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply1
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply2
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply1
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader1
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader2
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QByteArray
name|referenceData
init|=
name|reference
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|reader1
operator|.
name|data
argument_list|,
name|referenceData
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader2
operator|.
name|data
argument_list|,
name|referenceData
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpWithReuseSequential
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithReuseSequential
parameter_list|()
block|{
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
block|{
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|reference
operator|.
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// rinse and repeat:
block|{
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|ioGetFromHttpWithAuth_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithAuth_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"expectedData"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"expectedAuth"
argument_list|)
expr_stmt|;
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|QByteArray
name|referenceData
init|=
name|reference
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"basic"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth/rfc3252.txt"
argument_list|)
operator|<<
name|referenceData
operator|<<
literal|1
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"digest"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/auth-digest/"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"digest authentication successful\n"
argument_list|)
operator|<<
literal|1
expr_stmt|;
comment|//if url contains username& password, then it should be used
name|QTest
operator|::
name|newRow
argument_list|(
literal|"basic-in-url"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://httptest:httptest@"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth/rfc3252.txt"
argument_list|)
operator|<<
name|referenceData
operator|<<
literal|0
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"digest-in-url"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://httptest:httptest@"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/auth-digest/"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"digest authentication successful\n"
argument_list|)
operator|<<
literal|0
expr_stmt|;
comment|// if url contains incorrect credentials, expect QNAM to ask for good ones (even if cached - matches behaviour of browsers)
name|QTest
operator|::
name|newRow
argument_list|(
literal|"basic-bad-user-in-url"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://baduser:httptest@"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth/rfc3252.txt"
argument_list|)
operator|<<
name|referenceData
operator|<<
literal|3
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"basic-bad-password-in-url"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://httptest:wrong@"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth/rfc3252.txt"
argument_list|)
operator|<<
name|referenceData
operator|<<
literal|3
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"digest-bad-user-in-url"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://baduser:httptest@"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/auth-digest/"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"digest authentication successful\n"
argument_list|)
operator|<<
literal|3
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"digest-bad-password-in-url"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://httptest:wrong@"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/auth-digest/"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"digest authentication successful\n"
argument_list|)
operator|<<
literal|3
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpWithAuth
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithAuth
parameter_list|()
block|{
comment|// This test sends three requests
comment|// The first two in parallel
comment|// The third after the first two finished
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|expectedData
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|expectedAuth
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
block|{
name|QNetworkReplyPtr
name|reply1
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply2
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader1
argument_list|(
name|reply1
argument_list|)
decl_stmt|;
name|DataReader
name|reader2
argument_list|(
name|reply2
argument_list|)
decl_stmt|;
name|QSignalSpy
name|finishedspy
argument_list|(
name|reply1
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply2
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply1
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader1
operator|.
name|data
argument_list|,
name|expectedData
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader2
operator|.
name|data
argument_list|,
name|expectedData
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
operator|(
name|expectedAuth
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|expectedAuth
operator|=
name|qMax
argument_list|(
literal|0
argument_list|,
name|expectedAuth
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// rinse and repeat:
block|{
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|expectedData
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
operator|(
name|expectedAuth
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|expectedAuth
operator|=
name|qMax
argument_list|(
literal|0
argument_list|,
name|expectedAuth
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// now check with synchronous calls:
block|{
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|replySync
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|replySync
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// synchronous
if|if
condition|(
name|expectedAuth
condition|)
block|{
comment|// bad credentials in a synchronous request should just fail
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// we cannot use a data reader here, since that connects to the readyRead signal,
comment|// just use readAll()
comment|// the only thing we check here is that the auth cache was used when using synchronous requests
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|readAll
argument_list|()
argument_list|,
name|expectedData
argument_list|)
expr_stmt|;
block|}
block|}
comment|// check that credentials are used from cache if the same url is requested without credentials
block|{
name|url
operator|.
name|setUserInfo
argument_list|(
name|QString
argument_list|()
argument_list|)
expr_stmt|;
name|request
operator|.
name|setUrl
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|replySync
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|replySync
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// synchronous
if|if
condition|(
name|expectedAuth
condition|)
block|{
comment|// bad credentials in a synchronous request should just fail
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// we cannot use a data reader here, since that connects to the readyRead signal,
comment|// just use readAll()
comment|// the only thing we check here is that the auth cache was used when using synchronous requests
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|readAll
argument_list|()
argument_list|,
name|expectedData
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function
begin_function
DECL|function|ioGetFromHttpWithAuthSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithAuthSynchronous
parameter_list|()
block|{
comment|// verify that we do not enter an endless loop with synchronous calls and wrong credentials
comment|// the case when we succeed with the login is tested in ioGetFromHttpWithAuth()
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|replySync
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|replySync
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// synchronous
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|401
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
end_ifndef
begin_function
DECL|function|ioGetFromHttpWithProxyAuth
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithProxyAuth
parameter_list|()
block|{
comment|// This test sends three requests
comment|// The first two in parallel
comment|// The third after the first two finished
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkProxy
name|proxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
block|{
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply1
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply2
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|QNetworkProxy
argument_list|()
argument_list|)
expr_stmt|;
name|DataReader
name|reader1
argument_list|(
name|reply1
argument_list|)
decl_stmt|;
name|DataReader
name|reader2
argument_list|(
name|reply2
argument_list|)
decl_stmt|;
name|QSignalSpy
name|finishedspy
argument_list|(
name|reply1
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply2
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply1
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QByteArray
name|referenceData
init|=
name|reference
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|reader1
operator|.
name|data
argument_list|,
name|referenceData
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader2
operator|.
name|data
argument_list|,
name|referenceData
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|reference
operator|.
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// rinse and repeat:
block|{
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|QNetworkProxy
argument_list|()
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|// now check with synchronous calls:
name|reference
operator|.
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|{
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|replySync
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|replySync
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// synchronous
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// we cannot use a data reader here, since that connects to the readyRead signal,
comment|// just use readAll()
comment|// the only thing we check here is that the proxy auth cache was used when using synchronous requests
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|readAll
argument_list|()
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|ioGetFromHttpWithProxyAuthSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithProxyAuthSynchronous
parameter_list|()
block|{
comment|// verify that we do not enter an endless loop with synchronous calls and wrong credentials
comment|// the case when we succeed with the login is tested in ioGetFromHttpWithAuth()
name|QNetworkProxy
name|proxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|replySync
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|QNetworkProxy
argument_list|()
argument_list|)
expr_stmt|;
comment|// reset
name|QVERIFY
argument_list|(
name|replySync
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// synchronous
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|ProxyAuthenticationRequiredError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|replySync
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|407
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpWithSocksProxy
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithSocksProxy
parameter_list|()
block|{
comment|// HTTP caching proxies are tested by the above function
comment|// test SOCKSv5 proxies too
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkProxy
name|proxy
argument_list|(
name|QNetworkProxy
operator|::
name|Socks5Proxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|1080
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
block|{
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|QNetworkProxy
argument_list|()
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|// set an invalid proxy just to make sure that we can't load
name|proxy
operator|=
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|Socks5Proxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|1079
argument_list|)
expr_stmt|;
block|{
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|QNetworkProxy
argument_list|()
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Failure
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|isValid
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reader
operator|.
name|data
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|int
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|QEXPECT_FAIL
argument_list|(
literal|""
argument_list|,
literal|"QTcpSocket doesn't return enough information yet"
argument_list|,
name|Continue
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|int
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|)
argument_list|,
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ProxyConnectionRefusedError
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !QT_NO_NETWORKPROXY
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_SSL
end_ifndef
begin_function
DECL|function|ioGetFromHttpsWithSslErrors
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpsWithSslErrors
parameter_list|()
block|{
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|QSignalSpy
name|sslspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|metaDataChanged
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|storeSslConfiguration
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|sslspy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|storedSslConfiguration
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|sslConfiguration
argument_list|()
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpsWithIgnoreSslErrors
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpsWithIgnoreSslErrors
parameter_list|()
block|{
comment|// same as above, except that we call ignoreSslErrors and don't connect
comment|// to the sslErrors() signal (which is *still* emitted)
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|reply
operator|->
name|ignoreSslErrors
argument_list|()
expr_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|QSignalSpy
name|sslspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|metaDataChanged
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|storeSslConfiguration
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|sslspy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|storedSslConfiguration
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|sslConfiguration
argument_list|()
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpsWithSslHandshakeError
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpsWithSslHandshakeError
parameter_list|()
block|{
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|":80"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|reply
operator|->
name|ignoreSslErrors
argument_list|()
expr_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|QSignalSpy
name|sslspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|metaDataChanged
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|storeSslConfiguration
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Failure
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|SslHandshakeFailedError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|sslspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_function
DECL|function|ioGetFromHttpBrokenServer_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpBrokenServer_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"dataToSend"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"doDisconnect"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"no-newline"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"Hello World"
argument_list|)
operator|<<
literal|false
expr_stmt|;
comment|// these are OK now, we just eat the lonely newlines
comment|//QTest::newRow("just-newline")<< QByteArray("\r\n")<< false;
comment|//QTest::newRow("just-2newline")<< QByteArray("\r\n\r\n")<< false;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-newlines"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"Long first line\r\nLong second line"
argument_list|)
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-newlines2"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"\r\nSecond line"
argument_list|)
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-newlines3"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"ICY\r\nSecond line"
argument_list|)
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalid-version"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/123 200 \r\n"
argument_list|)
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalid-version2"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/a.\033 200 \r\n"
argument_list|)
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalid-reply-code"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.0 fuu \r\n"
argument_list|)
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|()
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"no-newline+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"Hello World"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"just-newline+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"\r\n"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"just-2newline+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"\r\n\r\n"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-newlines+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"Long first line\r\nLong second line"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-newlines2+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"\r\nSecond line"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-newlines3+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"ICY\r\nSecond line"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalid-version+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/123 200 "
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalid-version2+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/a.\033 200 "
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalid-reply-code+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.0 fuu "
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"immediate disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|""
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"justHalfStatus+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"justStatus+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 200 OK\r\n"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"justStatusAndHalfHeaders+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 200 OK\r\nContent-L"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"halfContent+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 200 OK\r\nContent-Length: 4\r\n\r\nAB"
argument_list|)
operator|<<
literal|true
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpBrokenServer
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpBrokenServer
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|dataToSend
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|doDisconnect
argument_list|)
expr_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|dataToSend
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
name|doDisconnect
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Failure
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|spy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|error
argument_list|()
operator|!=
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpStatus100_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpStatus100_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"dataToSend"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"statusCode"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"normal"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 100 Continue\r\n\r\nHTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n"
argument_list|)
operator|<<
literal|200
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"minimal"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 100 Continue\n\nHTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n"
argument_list|)
operator|<<
literal|200
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"minimal2"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 100 Continue\n\nHTTP/1.0 200 OK\r\n\r\n"
argument_list|)
operator|<<
literal|200
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"minimal3"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 100 Continue\n\nHTTP/1.0 200 OK\n\n"
argument_list|)
operator|<<
literal|200
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"minimal+404"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 100 Continue\n\nHTTP/1.0 204 No Content\r\n\r\n"
argument_list|)
operator|<<
literal|204
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with_headers"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 100 Continue\r\nBla: x\r\n\r\nHTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n"
argument_list|)
operator|<<
literal|200
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with_headers2"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.1 100 Continue\nBla: x\n\nHTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n"
argument_list|)
operator|<<
literal|200
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpStatus100
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpStatus100
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|dataToSend
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|statusCode
argument_list|)
expr_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|dataToSend
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|statusCode
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|rawHeader
argument_list|(
literal|"bla"
argument_list|)
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpNoHeaders_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpNoHeaders_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"dataToSend"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"justStatus+noheaders+disconnect"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.0 200 OK\r\n\r\n"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpNoHeaders
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpNoHeaders
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|dataToSend
argument_list|)
expr_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|dataToSend
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpWithCache_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithCache_data
parameter_list|()
block|{
name|qRegisterMetaType
argument_list|<
name|MyMemoryCache
operator|::
name|CachedContent
argument_list|>
argument_list|()
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"dataToSend"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"body"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|MyMemoryCache
operator|::
name|CachedContent
argument_list|>
argument_list|(
literal|"cachedReply"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"cacheMode"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QStringList
argument_list|>
argument_list|(
literal|"extraHttpHeaders"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"loadedFromCache"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"networkUsed"
argument_list|)
expr_stmt|;
name|QByteArray
name|reply200
init|=
literal|"HTTP/1.0 200\r\n"
literal|"Connection: keep-alive\r\n"
literal|"Content-Type: text/plain\r\n"
literal|"Cache-control: no-cache\r\n"
literal|"Content-length: 8\r\n"
literal|"\r\n"
literal|"Reloaded"
decl_stmt|;
name|QByteArray
name|reply304
init|=
literal|"HTTP/1.0 304 Use Cache\r\n"
literal|"Connection: keep-alive\r\n"
literal|"\r\n"
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-cached,always-network"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Reloaded"
operator|<<
name|MyMemoryCache
operator|::
name|CachedContent
argument_list|()
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|AlwaysNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-cached,prefer-network"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Reloaded"
operator|<<
name|MyMemoryCache
operator|::
name|CachedContent
argument_list|()
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-cached,prefer-cache"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Reloaded"
operator|<<
name|MyMemoryCache
operator|::
name|CachedContent
argument_list|()
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
name|QDateTime
name|present
init|=
name|QDateTime
operator|::
name|currentDateTime
argument_list|()
operator|.
name|toUTC
argument_list|()
decl_stmt|;
name|QDateTime
name|past
init|=
name|present
operator|.
name|addSecs
argument_list|(
operator|-
literal|3600
argument_list|)
decl_stmt|;
name|QDateTime
name|future
init|=
name|present
operator|.
name|addSecs
argument_list|(
literal|3600
argument_list|)
decl_stmt|;
specifier|static
specifier|const
name|char
name|dateFormat
index|[]
init|=
literal|"ddd, dd MMM yyyy hh:mm:ss 'GMT'"
decl_stmt|;
name|QNetworkCacheMetaData
operator|::
name|RawHeaderList
name|rawHeaders
decl_stmt|;
name|MyMemoryCache
operator|::
name|CachedContent
name|content
decl_stmt|;
name|content
operator|.
name|second
operator|=
literal|"Not-reloaded"
expr_stmt|;
name|content
operator|.
name|first
operator|.
name|setLastModified
argument_list|(
name|past
argument_list|)
expr_stmt|;
comment|//
comment|// Set to expired
comment|//
name|rawHeaders
operator|.
name|clear
argument_list|()
expr_stmt|;
name|rawHeaders
operator|<<
name|QNetworkCacheMetaData
operator|::
name|RawHeader
argument_list|(
literal|"Date"
argument_list|,
name|QLocale
operator|::
name|c
argument_list|()
operator|.
name|toString
argument_list|(
name|past
argument_list|,
name|dateFormat
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
operator|<<
name|QNetworkCacheMetaData
operator|::
name|RawHeader
argument_list|(
literal|"Cache-control"
argument_list|,
literal|"max-age=0"
argument_list|)
expr_stmt|;
comment|// isn't used in cache loading
name|content
operator|.
name|first
operator|.
name|setRawHeaders
argument_list|(
name|rawHeaders
argument_list|)
expr_stmt|;
name|content
operator|.
name|first
operator|.
name|setLastModified
argument_list|(
name|past
argument_list|)
expr_stmt|;
name|content
operator|.
name|first
operator|.
name|setExpirationDate
argument_list|(
name|past
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"expired,200,prefer-network"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"expired,200,prefer-cache"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"expired,304,prefer-network"
argument_list|)
operator|<<
name|reply304
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"expired,304,prefer-cache"
argument_list|)
operator|<<
name|reply304
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|true
expr_stmt|;
comment|//
comment|// Set to not-expired
comment|//
name|rawHeaders
operator|.
name|clear
argument_list|()
expr_stmt|;
name|rawHeaders
operator|<<
name|QNetworkCacheMetaData
operator|::
name|RawHeader
argument_list|(
literal|"Date"
argument_list|,
name|QLocale
operator|::
name|c
argument_list|()
operator|.
name|toString
argument_list|(
name|past
argument_list|,
name|dateFormat
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
operator|<<
name|QNetworkCacheMetaData
operator|::
name|RawHeader
argument_list|(
literal|"Cache-control"
argument_list|,
literal|"max-age=7200"
argument_list|)
expr_stmt|;
comment|// isn't used in cache loading
name|content
operator|.
name|first
operator|.
name|setRawHeaders
argument_list|(
name|rawHeaders
argument_list|)
expr_stmt|;
name|content
operator|.
name|first
operator|.
name|setExpirationDate
argument_list|(
name|future
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-expired,200,always-network"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|AlwaysNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-expired,200,prefer-network"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-expired,200,prefer-cache"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-expired,200,always-cache"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|AlwaysCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-expired,304,prefer-network"
argument_list|)
operator|<<
name|reply304
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-expired,304,prefer-cache"
argument_list|)
operator|<<
name|reply304
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"not-expired,304,always-cache"
argument_list|)
operator|<<
name|reply304
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|AlwaysCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|false
expr_stmt|;
comment|//
comment|// Set must-revalidate now
comment|//
name|rawHeaders
operator|.
name|clear
argument_list|()
expr_stmt|;
name|rawHeaders
operator|<<
name|QNetworkCacheMetaData
operator|::
name|RawHeader
argument_list|(
literal|"Date"
argument_list|,
name|QLocale
operator|::
name|c
argument_list|()
operator|.
name|toString
argument_list|(
name|past
argument_list|,
name|dateFormat
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
operator|<<
name|QNetworkCacheMetaData
operator|::
name|RawHeader
argument_list|(
literal|"Cache-control"
argument_list|,
literal|"max-age=7200, must-revalidate"
argument_list|)
expr_stmt|;
comment|// must-revalidate is used
name|content
operator|.
name|first
operator|.
name|setRawHeaders
argument_list|(
name|rawHeaders
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"must-revalidate,200,always-network"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|AlwaysNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"must-revalidate,200,prefer-network"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"must-revalidate,200,prefer-cache"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|"Reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"must-revalidate,200,always-cache"
argument_list|)
operator|<<
name|reply200
operator|<<
literal|""
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|AlwaysCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"must-revalidate,304,prefer-network"
argument_list|)
operator|<<
name|reply304
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferNetwork
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"must-revalidate,304,prefer-cache"
argument_list|)
operator|<<
name|reply304
operator|<<
literal|"Not-reloaded"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|true
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"must-revalidate,304,always-cache"
argument_list|)
operator|<<
name|reply304
operator|<<
literal|""
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|AlwaysCache
argument_list|)
operator|<<
name|QStringList
argument_list|()
operator|<<
literal|false
operator|<<
literal|false
expr_stmt|;
comment|//
comment|// Partial content
comment|//
name|rawHeaders
operator|.
name|clear
argument_list|()
expr_stmt|;
name|rawHeaders
operator|<<
name|QNetworkCacheMetaData
operator|::
name|RawHeader
argument_list|(
literal|"Date"
argument_list|,
name|QLocale
operator|::
name|c
argument_list|()
operator|.
name|toString
argument_list|(
name|past
argument_list|,
name|dateFormat
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
operator|<<
name|QNetworkCacheMetaData
operator|::
name|RawHeader
argument_list|(
literal|"Cache-control"
argument_list|,
literal|"max-age=7200"
argument_list|)
expr_stmt|;
comment|// isn't used in cache loading
name|content
operator|.
name|first
operator|.
name|setRawHeaders
argument_list|(
name|rawHeaders
argument_list|)
expr_stmt|;
name|content
operator|.
name|first
operator|.
name|setExpirationDate
argument_list|(
name|future
argument_list|)
expr_stmt|;
name|QByteArray
name|reply206
init|=
literal|"HTTP/1.0 206\r\n"
literal|"Connection: keep-alive\r\n"
literal|"Content-Type: text/plain\r\n"
literal|"Cache-control: no-cache\r\n"
literal|"Content-Range: bytes 2-6/8\r\n"
literal|"Content-length: 4\r\n"
literal|"\r\n"
literal|"load"
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"partial,dontuse-cache"
argument_list|)
operator|<<
name|reply206
operator|<<
literal|"load"
operator|<<
name|content
operator|<<
name|int
argument_list|(
name|QNetworkRequest
operator|::
name|PreferCache
argument_list|)
operator|<<
operator|(
name|QStringList
argument_list|()
operator|<<
literal|"Range"
operator|<<
literal|"bytes=2-6"
operator|)
operator|<<
literal|false
operator|<<
literal|true
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioGetFromHttpWithCache
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithCache
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|dataToSend
argument_list|)
expr_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|dataToSend
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|false
expr_stmt|;
name|MyMemoryCache
modifier|*
name|memoryCache
init|=
operator|new
name|MyMemoryCache
argument_list|(
operator|&
name|manager
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setCache
argument_list|(
name|memoryCache
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|MyMemoryCache
operator|::
name|CachedContent
argument_list|,
name|cachedReply
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
decl_stmt|;
name|cachedReply
operator|.
name|first
operator|.
name|setUrl
argument_list|(
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cachedReply
operator|.
name|second
operator|.
name|isNull
argument_list|()
condition|)
name|memoryCache
operator|->
name|cache
operator|.
name|insert
argument_list|(
name|url
operator|.
name|toEncoded
argument_list|()
argument_list|,
name|cachedReply
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|cacheMode
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|CacheLoadControlAttribute
argument_list|,
name|cacheMode
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|CacheSaveControlAttribute
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QStringList
argument_list|,
name|extraHttpHeaders
argument_list|)
expr_stmt|;
name|QStringListIterator
name|it
argument_list|(
name|extraHttpHeaders
argument_list|)
decl_stmt|;
while|while
condition|(
name|it
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|QString
name|header
init|=
name|it
operator|.
name|next
argument_list|()
decl_stmt|;
name|QString
name|value
init|=
name|it
operator|.
name|next
argument_list|()
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
name|header
operator|.
name|toLatin1
argument_list|()
argument_list|,
name|value
operator|.
name|toLatin1
argument_list|()
argument_list|)
expr_stmt|;
comment|// To latin1? Deal with it!
block|}
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
name|QTEST
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SourceIsFromCacheAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
argument_list|,
literal|"loadedFromCache"
argument_list|)
expr_stmt|;
name|QTEST
argument_list|(
name|server
operator|.
name|totalConnections
operator|>
literal|0
argument_list|,
literal|"networkUsed"
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|body
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|,
name|qPrintable
argument_list|(
name|body
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
end_ifndef
begin_function
DECL|function|ioGetWithManyProxies_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetWithManyProxies_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QList
argument_list|<
name|QNetworkProxy
argument_list|>
argument_list|>
argument_list|(
literal|"proxyList"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkProxy
argument_list|>
argument_list|(
literal|"proxyUsed"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"expectedError"
argument_list|)
expr_stmt|;
name|QList
argument_list|<
name|QNetworkProxy
argument_list|>
name|proxyList
decl_stmt|;
comment|// All of the other functions test DefaultProxy
comment|// So let's test something else
comment|// Simple tests that work:
comment|// HTTP request with HTTP caching proxy
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-on-http"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// HTTP request with HTTP transparent proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-on-http2"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// HTTP request with SOCKS transparent proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|Socks5Proxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|1081
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-on-socks"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// FTP request with FTP caching proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|FtpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|2121
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-on-ftp"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// The following test doesn't work because QFtp is too limited
comment|// It can only talk to its own kind of proxies
comment|// FTP request with SOCKSv5 transparent proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|Socks5Proxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|1081
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-on-socks"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
comment|// HTTPS with HTTP transparent proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https-on-http"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// HTTPS request with SOCKS transparent proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|Socks5Proxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|1081
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https-on-socks"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
endif|#
directive|endif
comment|// Tests that fail:
comment|// HTTP request with FTP caching proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|FtpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|2121
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-on-ftp"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|()
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|ProxyNotFoundError
expr_stmt|;
comment|// FTP request with HTTP caching proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-on-http"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|()
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|ProxyNotFoundError
expr_stmt|;
comment|// FTP request with HTTP caching proxies
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3130
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-on-multiple-http"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|()
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|ProxyNotFoundError
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
comment|// HTTPS with HTTP caching proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https-on-httptransparent"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|()
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|ProxyNotFoundError
expr_stmt|;
comment|// HTTPS with FTP caching proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|FtpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|2121
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https-on-ftp"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|()
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|ProxyNotFoundError
expr_stmt|;
endif|#
directive|endif
comment|// Complex requests:
comment|// HTTP request with more than one HTTP proxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3130
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-on-multiple-http"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// HTTP request with HTTP + SOCKS
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|Socks5Proxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|1081
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-on-http+socks"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// HTTP request with FTP + HTTP + SOCKS
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|FtpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|2121
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|Socks5Proxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|1081
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-on-ftp+http+socks"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|1
argument_list|)
comment|// second proxy should be used
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// HTTP request with NoProxy + HTTP
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|NoProxy
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-on-noproxy+http"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// HTTP request with FTP + NoProxy
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|FtpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|2121
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|NoProxy
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-on-ftp+noproxy"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|1
argument_list|)
comment|// second proxy should be used
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// FTP request with HTTP Caching + FTP
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|FtpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|2121
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp-on-http+ftp"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|1
argument_list|)
comment|// second proxy should be used
operator|<<
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
comment|// HTTPS request with HTTP Caching + HTTP transparent
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https-on-httpcaching+http"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|1
argument_list|)
comment|// second proxy should be used
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
comment|// HTTPS request with FTP + HTTP C + HTTP T
name|proxyList
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyList
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|FtpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|2121
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpCachingProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
operator|<<
name|QNetworkProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpProxy
argument_list|,
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|,
literal|3129
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https-on-ftp+httpcaching+http"
argument_list|)
operator|<<
name|proxyList
operator|<<
name|proxyList
operator|.
name|at
argument_list|(
literal|2
argument_list|)
comment|// skip the first two
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|ioGetWithManyProxies
name|void
name|tst_QNetworkReply
operator|::
name|ioGetWithManyProxies
parameter_list|()
block|{
comment|// Test proxy factories
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
comment|// set the proxy factory:
name|QFETCH
argument_list|(
name|QList
argument_list|<
name|QNetworkProxy
argument_list|>
argument_list|,
name|proxyList
argument_list|)
expr_stmt|;
name|MyProxyFactory
modifier|*
name|proxyFactory
init|=
operator|new
name|MyProxyFactory
decl_stmt|;
name|proxyFactory
operator|->
name|toReturn
operator|=
name|proxyList
expr_stmt|;
name|manager
operator|.
name|setProxyFactory
argument_list|(
name|proxyFactory
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QUrl
name|theUrl
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|theUrl
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|DataReader
name|reader
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|QSignalSpy
name|authspy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|manager
operator|.
name|disconnect
argument_list|(
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|expectedError
argument_list|)
expr_stmt|;
name|QEXPECT_FAIL
argument_list|(
literal|"ftp-on-socks"
argument_list|,
literal|"QFtp is too limited and won't accept non-FTP proxies"
argument_list|,
name|Abort
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|expectedError
argument_list|)
expr_stmt|;
comment|// Verify that the factory was called properly
name|QCOMPARE
argument_list|(
name|proxyFactory
operator|->
name|callCount
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|proxyFactory
operator|->
name|lastQuery
argument_list|,
name|QNetworkProxyQuery
argument_list|(
name|theUrl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|expectedError
operator|==
name|QNetworkReply
operator|::
name|NoError
condition|)
block|{
comment|// request succeeded
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
comment|// now verify that the proxies worked:
name|QFETCH
argument_list|(
name|QNetworkProxy
argument_list|,
name|proxyUsed
argument_list|)
expr_stmt|;
if|if
condition|(
name|proxyUsed
operator|.
name|type
argument_list|()
operator|==
name|QNetworkProxy
operator|::
name|NoProxy
condition|)
block|{
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|QByteArray
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"ftp-"
argument_list|)
condition|)
return|return;
comment|// No authentication with current FTP or with FTP proxies
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qvariant_cast
argument_list|<
name|QNetworkProxy
argument_list|>
argument_list|(
name|authspy
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|at
argument_list|(
literal|0
argument_list|)
argument_list|)
argument_list|,
name|proxyUsed
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// request failed
name|QCOMPARE
argument_list|(
name|authspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !QT_NO_NETWORKPROXY
end_comment
begin_function
DECL|function|ioPutToFileFromFile_data
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFileFromFile_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"fileName"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/empty"
operator|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"real-file"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
operator|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"resource"
argument_list|)
operator|<<
literal|":/resource"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"search-path"
argument_list|)
operator|<<
literal|"testdata:/rfc3252.txt"
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPutToFileFromFile
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFileFromFile
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|fileName
argument_list|)
expr_stmt|;
name|QFile
name|sourceFile
argument_list|(
name|fileName
argument_list|)
decl_stmt|;
name|QFile
name|targetFile
argument_list|(
name|testFileName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|targetFile
operator|.
name|fileName
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|request
argument_list|,
operator|&
name|sourceFile
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|Q_INT64_C
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|atEnd
argument_list|()
argument_list|)
expr_stmt|;
name|sourceFile
operator|.
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// reset it to the beginning
name|QVERIFY
argument_list|(
name|targetFile
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|targetFile
operator|.
name|size
argument_list|()
argument_list|,
name|sourceFile
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|targetFile
operator|.
name|readAll
argument_list|()
argument_list|,
name|sourceFile
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPutToFileFromSocket_data
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFileFromSocket_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPutToFileFromSocket
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFileFromSocket
parameter_list|()
block|{
name|QFile
name|file
argument_list|(
name|testFileName
argument_list|)
decl_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|file
operator|.
name|fileName
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|SocketPair
name|socketpair
decl_stmt|;
name|QTRY_VERIFY
argument_list|(
name|socketpair
operator|.
name|create
argument_list|()
argument_list|)
expr_stmt|;
comment|//QTRY_VERIFY as a workaround for QTBUG-24451
name|socketpair
operator|.
name|endPoints
index|[
literal|0
index|]
operator|->
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|QNetworkRequest
argument_list|(
name|url
argument_list|)
argument_list|,
name|socketpair
operator|.
name|endPoints
index|[
literal|1
index|]
argument_list|)
argument_list|)
decl_stmt|;
name|socketpair
operator|.
name|endPoints
index|[
literal|0
index|]
operator|->
name|close
argument_list|()
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|Q_INT64_C
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|file
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|file
operator|.
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QByteArray
name|contents
init|=
name|file
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|contents
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPutToFileFromLocalSocket_data
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFileFromLocalSocket_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPutToFileFromLocalSocket
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFileFromLocalSocket
parameter_list|()
block|{
name|QString
name|socketname
init|=
literal|"networkreplytest"
decl_stmt|;
name|QLocalServer
name|server
decl_stmt|;
if|if
condition|(
operator|!
name|server
operator|.
name|listen
argument_list|(
name|socketname
argument_list|)
condition|)
block|{
name|QLocalServer
operator|::
name|removeServer
argument_list|(
name|socketname
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|server
operator|.
name|listen
argument_list|(
name|socketname
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|QLocalSocket
name|active
decl_stmt|;
name|active
operator|.
name|connectToServer
argument_list|(
name|socketname
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|server
operator|.
name|waitForNewConnection
argument_list|(
literal|10
argument_list|)
argument_list|,
name|server
operator|.
name|errorString
argument_list|()
operator|.
name|toLatin1
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|active
operator|.
name|waitForConnected
argument_list|(
literal|10
argument_list|)
argument_list|,
name|active
operator|.
name|errorString
argument_list|()
operator|.
name|toLatin1
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|server
operator|.
name|hasPendingConnections
argument_list|()
argument_list|,
name|server
operator|.
name|errorString
argument_list|()
operator|.
name|toLatin1
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|)
expr_stmt|;
name|QLocalSocket
modifier|*
name|passive
init|=
name|server
operator|.
name|nextPendingConnection
argument_list|()
decl_stmt|;
name|QFile
name|file
argument_list|(
name|testFileName
argument_list|)
decl_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|file
operator|.
name|fileName
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|active
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|active
operator|.
name|close
argument_list|()
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|QNetworkRequest
argument_list|(
name|url
argument_list|)
argument_list|,
name|passive
argument_list|)
argument_list|)
decl_stmt|;
name|passive
operator|->
name|setParent
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|Q_OS_WIN
if|if
condition|(
operator|!
name|data
operator|.
name|isEmpty
argument_list|()
condition|)
name|QEXPECT_FAIL
argument_list|(
literal|""
argument_list|,
literal|"QTBUG-18385"
argument_list|,
name|Abort
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|Q_INT64_C
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|file
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|file
operator|.
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QByteArray
name|contents
init|=
name|file
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|contents
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// Currently no stdin/out supported for Windows CE.
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_PROCESS
end_ifndef
begin_function
DECL|function|ioPutToFileFromProcess_data
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFileFromProcess_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPutToFileFromProcess
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFileFromProcess
parameter_list|()
block|{
if|#
directive|if
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
name|QSKIP
argument_list|(
literal|"Currently no stdin/out supported for Windows CE"
argument_list|)
expr_stmt|;
else|#
directive|else
ifdef|#
directive|ifdef
name|Q_OS_WIN
if|if
condition|(
name|qstrcmp
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|,
literal|"small"
argument_list|)
operator|==
literal|0
condition|)
name|QSKIP
argument_list|(
literal|"When passing a CR-LF-LF sequence through Windows stdio, it gets converted, "
literal|"so this test fails. Disabled on Windows"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|QFile
name|file
argument_list|(
name|testFileName
argument_list|)
decl_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|file
operator|.
name|fileName
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|QProcess
name|process
decl_stmt|;
name|QString
name|echoExe
init|=
name|echoProcessDir
operator|+
literal|"/echo"
decl_stmt|;
name|process
operator|.
name|start
argument_list|(
name|echoExe
argument_list|,
name|QStringList
argument_list|(
literal|"all"
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|process
operator|.
name|waitForStarted
argument_list|()
argument_list|,
name|qPrintable
argument_list|(
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"Could not start %1: %2"
argument_list|)
operator|.
name|arg
argument_list|(
name|echoExe
argument_list|,
name|process
operator|.
name|errorString
argument_list|()
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|process
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|process
operator|.
name|closeWriteChannel
argument_list|()
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|QNetworkRequest
argument_list|(
name|url
argument_list|)
argument_list|,
operator|&
name|process
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|Q_INT64_C
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|file
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|file
operator|.
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QByteArray
name|contents
init|=
name|file
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|contents
argument_list|,
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_function
DECL|function|ioPutToFtpFromFile_data
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFtpFromFile_data
parameter_list|()
block|{
name|ioPutToFileFromFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPutToFtpFromFile
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToFtpFromFile
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|fileName
argument_list|)
expr_stmt|;
name|QFile
name|sourceFile
argument_list|(
name|fileName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|url
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/qtest/upload/qnetworkaccess-ioPutToFtpFromFile-%1-%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|uniqueExtension
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|request
argument_list|,
operator|&
name|sourceFile
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|Q_INT64_C
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|atEnd
argument_list|()
argument_list|)
expr_stmt|;
name|sourceFile
operator|.
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// reset it to the beginning
comment|// download the file again from FTP to make sure it was uploaded
comment|// correctly
name|QNetworkAccessManager
name|qnam
decl_stmt|;
name|QNetworkRequest
name|req
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|r
init|=
name|qnam
operator|.
name|get
argument_list|(
name|req
argument_list|)
decl_stmt|;
name|QObject
operator|::
name|connect
argument_list|(
name|r
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|QObject
operator|::
name|disconnect
argument_list|(
name|r
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QByteArray
name|uploaded
init|=
name|r
operator|->
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|uploaded
operator|.
name|size
argument_list|()
argument_list|)
argument_list|,
name|sourceFile
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|uploaded
argument_list|,
name|sourceFile
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
name|r
operator|->
name|close
argument_list|()
expr_stmt|;
name|QObject
operator|::
name|connect
argument_list|(
name|r
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QObject
operator|::
name|disconnect
argument_list|(
name|r
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPutToHttpFromFile_data
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToHttpFromFile_data
parameter_list|()
block|{
name|ioPutToFileFromFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPutToHttpFromFile
name|void
name|tst_QNetworkReply
operator|::
name|ioPutToHttpFromFile
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|fileName
argument_list|)
expr_stmt|;
name|QFile
name|sourceFile
argument_list|(
name|fileName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|url
operator|.
name|setPath
argument_list|(
name|QString
argument_list|(
literal|"/dav/qnetworkaccess-ioPutToHttpFromFile-%1-%2"
argument_list|)
operator|.
name|arg
argument_list|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|uniqueExtension
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|request
argument_list|,
operator|&
name|sourceFile
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
comment|// verify that the HTTP status code is 201 Created
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|201
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|atEnd
argument_list|()
argument_list|)
expr_stmt|;
name|sourceFile
operator|.
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// reset it to the beginning
comment|// download the file again from HTTP to make sure it was uploaded
comment|// correctly
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|sourceFile
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPostToHttpFromFile_data
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpFromFile_data
parameter_list|()
block|{
name|ioPutToFileFromFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPostToHttpFromFile
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpFromFile
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|fileName
argument_list|)
expr_stmt|;
name|QFile
name|sourceFile
argument_list|(
name|fileName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/md5sum.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
operator|&
name|sourceFile
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
comment|// verify that the HTTP status code is 200 Ok
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|atEnd
argument_list|()
argument_list|)
expr_stmt|;
name|sourceFile
operator|.
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// reset it to the beginning
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
argument_list|,
name|md5sum
argument_list|(
name|sourceFile
operator|.
name|readAll
argument_list|()
argument_list|)
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
end_ifndef
begin_function
DECL|function|ioPostToHttpFromSocket_data
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpFromSocket_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"md5sum"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkProxy
argument_list|>
argument_list|(
literal|"proxy"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"authenticationRequiredCount"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"proxyAuthenticationRequiredCount"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|proxies
operator|.
name|count
argument_list|()
condition|;
operator|++
name|i
control|)
for|for
control|(
name|int
name|auth
init|=
literal|0
init|;
name|auth
operator|<
literal|2
condition|;
operator|++
name|auth
control|)
block|{
name|QUrl
name|url
decl_stmt|;
if|if
condition|(
name|auth
condition|)
name|url
operator|=
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/protected/cgi-bin/md5sum.cgi"
expr_stmt|;
else|else
name|url
operator|=
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/md5sum.cgi"
expr_stmt|;
name|QNetworkProxy
name|proxy
init|=
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|proxy
decl_stmt|;
name|QByteArray
name|testsuffix
init|=
name|QByteArray
argument_list|(
name|auth
condition|?
literal|"+auth"
else|:
literal|""
argument_list|)
operator|+
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|tag
decl_stmt|;
name|int
name|proxyauthcount
init|=
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|requiresAuthentication
decl_stmt|;
name|QByteArray
name|data
decl_stmt|;
name|data
operator|=
literal|""
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty"
operator|+
name|testsuffix
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
operator|<<
name|url
operator|<<
name|proxy
operator|<<
name|auth
operator|<<
name|proxyauthcount
expr_stmt|;
name|data
operator|=
literal|"This is a normal message."
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"generic"
operator|+
name|testsuffix
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
operator|<<
name|url
operator|<<
name|proxy
operator|<<
name|auth
operator|<<
name|proxyauthcount
expr_stmt|;
name|data
operator|=
literal|"This is a message to show that Qt rocks!\r\n\n"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"small"
operator|+
name|testsuffix
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
operator|<<
name|url
operator|<<
name|proxy
operator|<<
name|auth
operator|<<
name|proxyauthcount
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|"abcd\0\1\2\abcd"
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-nul"
operator|+
name|testsuffix
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
operator|<<
name|url
operator|<<
name|proxy
operator|<<
name|auth
operator|<<
name|proxyauthcount
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|4097
argument_list|,
literal|'\4'
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"4k+1"
operator|+
name|testsuffix
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
operator|<<
name|url
operator|<<
name|proxy
operator|<<
name|auth
operator|<<
name|proxyauthcount
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|128
operator|*
literal|1024
operator|+
literal|1
argument_list|,
literal|'\177'
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"128k+1"
operator|+
name|testsuffix
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
operator|<<
name|url
operator|<<
name|proxy
operator|<<
name|auth
operator|<<
name|proxyauthcount
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|ioPostToHttpFromSocket
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpFromSocket
parameter_list|()
block|{
if|if
condition|(
name|QTest
operator|::
name|currentDataTag
argument_list|()
operator|==
name|QByteArray
argument_list|(
literal|"128k+1+proxyauth"
argument_list|)
operator|||
name|QTest
operator|::
name|currentDataTag
argument_list|()
operator|==
name|QByteArray
argument_list|(
literal|"128k+1+auth+proxyauth"
argument_list|)
condition|)
name|QSKIP
argument_list|(
literal|"Squid cannot handle authentication with POST data>= 64K (QTBUG-33180)"
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkProxy
argument_list|,
name|proxy
argument_list|)
expr_stmt|;
name|SocketPair
name|socketpair
decl_stmt|;
name|QTRY_VERIFY
argument_list|(
name|socketpair
operator|.
name|create
argument_list|()
argument_list|)
expr_stmt|;
comment|//QTRY_VERIFY as a workaround for QTBUG-24451
name|socketpair
operator|.
name|endPoints
index|[
literal|0
index|]
operator|->
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
name|socketpair
operator|.
name|endPoints
index|[
literal|1
index|]
argument_list|)
argument_list|)
decl_stmt|;
name|socketpair
operator|.
name|endPoints
index|[
literal|0
index|]
operator|->
name|close
argument_list|()
expr_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authenticationRequiredSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|proxyAuthenticationRequiredSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|disconnect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|disconnect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
comment|// verify that the HTTP status code is 200 Ok
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
argument_list|,
name|md5sum
argument_list|(
name|data
argument_list|)
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
name|QTEST
argument_list|(
name|authenticationRequiredSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|"authenticationRequiredCount"
argument_list|)
expr_stmt|;
name|QTEST
argument_list|(
name|proxyAuthenticationRequiredSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|"proxyAuthenticationRequiredCount"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPostToHttpFromSocketSynchronous_data
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpFromSocketSynchronous_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"md5sum"
argument_list|)
expr_stmt|;
name|QByteArray
name|data
decl_stmt|;
name|data
operator|=
literal|""
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
literal|"This is a normal message."
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"generic"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
literal|"This is a message to show that Qt rocks!\r\n\n"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"small"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|"abcd\0\1\2\abcd"
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"with-nul"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|4097
argument_list|,
literal|'\4'
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"4k+1"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|128
operator|*
literal|1024
operator|+
literal|1
argument_list|,
literal|'\177'
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"128k+1"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|QByteArray
argument_list|(
literal|2
operator|*
literal|1024
operator|*
literal|1024
operator|+
literal|1
argument_list|,
literal|'\177'
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"2MB+1"
argument_list|)
operator|<<
name|data
operator|<<
name|md5sum
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPostToHttpFromSocketSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpFromSocketSynchronous
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|SocketPair
name|socketpair
decl_stmt|;
name|QTRY_VERIFY
argument_list|(
name|socketpair
operator|.
name|create
argument_list|()
argument_list|)
expr_stmt|;
comment|//QTRY_VERIFY as a workaround for QTBUG-24451
name|socketpair
operator|.
name|endPoints
index|[
literal|0
index|]
operator|->
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|socketpair
operator|.
name|endPoints
index|[
literal|0
index|]
operator|->
name|waitForBytesWritten
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
comment|// ### for 4.8: make the socket pair unbuffered, to not read everything in one go in QNetworkReplyImplPrivate::setup()
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/md5sum.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
name|socketpair
operator|.
name|endPoints
index|[
literal|1
index|]
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|socketpair
operator|.
name|endPoints
index|[
literal|0
index|]
operator|->
name|close
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
comment|// verify that the HTTP status code is 200 Ok
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
argument_list|,
name|md5sum
argument_list|(
name|data
argument_list|)
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !QT_NO_NETWORKPROXY
end_comment
begin_comment
comment|// this tests checks if rewinding the POST-data to some place in the middle
end_comment
begin_comment
comment|// worked.
end_comment
begin_function
DECL|function|ioPostToHttpFromMiddleOfFileToEnd
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpFromMiddleOfFileToEnd
parameter_list|()
block|{
name|QFile
name|sourceFile
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
comment|// seeking to the middle
name|sourceFile
operator|.
name|seek
argument_list|(
name|sourceFile
operator|.
name|size
argument_list|()
operator|/
literal|2
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/protected/cgi-bin/md5sum.cgi"
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
operator|&
name|sourceFile
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|disconnect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|// compare half data
name|sourceFile
operator|.
name|seek
argument_list|(
name|sourceFile
operator|.
name|size
argument_list|()
operator|/
literal|2
argument_list|)
expr_stmt|;
name|QByteArray
name|data
init|=
name|sourceFile
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
argument_list|,
name|md5sum
argument_list|(
name|data
argument_list|)
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPostToHttpFromMiddleOfFileFiveBytes
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpFromMiddleOfFileFiveBytes
parameter_list|()
block|{
name|QFile
name|sourceFile
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
comment|// seeking to the middle
name|sourceFile
operator|.
name|seek
argument_list|(
name|sourceFile
operator|.
name|size
argument_list|()
operator|/
literal|2
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/protected/cgi-bin/md5sum.cgi"
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
comment|// only send 5 bytes
name|request
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|request
operator|.
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|isValid
argument_list|()
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
operator|&
name|sourceFile
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|disconnect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|// compare half data
name|sourceFile
operator|.
name|seek
argument_list|(
name|sourceFile
operator|.
name|size
argument_list|()
operator|/
literal|2
argument_list|)
expr_stmt|;
name|QByteArray
name|data
init|=
name|sourceFile
operator|.
name|read
argument_list|(
literal|5
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
argument_list|,
name|md5sum
argument_list|(
name|data
argument_list|)
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPostToHttpFromMiddleOfQBufferFiveBytes
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpFromMiddleOfQBufferFiveBytes
parameter_list|()
block|{
comment|// test needed since a QBuffer goes with a different codepath than the QFile
comment|// tested in ioPostToHttpFromMiddleOfFileFiveBytes
name|QBuffer
name|uploadBuffer
decl_stmt|;
name|uploadBuffer
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadWrite
argument_list|)
expr_stmt|;
name|uploadBuffer
operator|.
name|write
argument_list|(
literal|"1234567890"
argument_list|)
expr_stmt|;
name|uploadBuffer
operator|.
name|seek
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/protected/cgi-bin/md5sum.cgi"
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
operator|&
name|uploadBuffer
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|disconnect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|// compare half data
name|uploadBuffer
operator|.
name|seek
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|QByteArray
name|data
init|=
name|uploadBuffer
operator|.
name|read
argument_list|(
literal|5
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|trimmed
argument_list|()
argument_list|,
name|md5sum
argument_list|(
name|data
argument_list|)
operator|.
name|toHex
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPostToHttpNoBufferFlag
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpNoBufferFlag
parameter_list|()
block|{
name|QByteArray
name|data
init|=
name|QByteArray
argument_list|(
literal|"daaaaaaataaaaaaa"
argument_list|)
decl_stmt|;
comment|// create a sequential QIODevice by feeding the data into a local TCP server
name|SocketPair
name|socketpair
decl_stmt|;
name|QTRY_VERIFY
argument_list|(
name|socketpair
operator|.
name|create
argument_list|()
argument_list|)
expr_stmt|;
comment|//QTRY_VERIFY as a workaround for QTBUG-24451
name|socketpair
operator|.
name|endPoints
index|[
literal|0
index|]
operator|->
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/protected/cgi-bin/md5sum.cgi"
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
comment|// disallow buffering
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|DoNotBufferUploadDataAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|request
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|,
name|data
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
name|socketpair
operator|.
name|endPoints
index|[
literal|1
index|]
argument_list|)
argument_list|)
decl_stmt|;
name|socketpair
operator|.
name|endPoints
index|[
literal|0
index|]
operator|->
name|close
argument_list|()
expr_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Failure
argument_list|)
expr_stmt|;
name|disconnect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|// verify: error code is QNetworkReply::ContentReSendError
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|ContentReSendError
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_SSL
end_ifndef
begin_class
DECL|class|SslServer
class|class
name|SslServer
super|:
specifier|public
name|QTcpServer
block|{
name|Q_OBJECT
public|public:
DECL|function|SslServer
name|SslServer
parameter_list|()
member_init_list|:
name|socket
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|m_ssl
argument_list|(
literal|true
argument_list|)
block|{}
DECL|function|incomingConnection
name|void
name|incomingConnection
parameter_list|(
name|qintptr
name|socketDescriptor
parameter_list|)
block|{
name|QSslSocket
modifier|*
name|serverSocket
init|=
operator|new
name|QSslSocket
decl_stmt|;
name|serverSocket
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
if|if
condition|(
name|serverSocket
operator|->
name|setSocketDescriptor
argument_list|(
name|socketDescriptor
argument_list|)
condition|)
block|{
name|connect
argument_list|(
name|serverSocket
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|readyReadSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m_ssl
condition|)
block|{
emit|emit
name|newPlainConnection
argument_list|(
name|serverSocket
argument_list|)
emit|;
return|return;
block|}
name|QString
name|testDataDir
init|=
name|QFileInfo
argument_list|(
name|QFINDTESTDATA
argument_list|(
literal|"rfc3252.txt"
argument_list|)
argument_list|)
operator|.
name|absolutePath
argument_list|()
decl_stmt|;
if|if
condition|(
name|testDataDir
operator|.
name|isEmpty
argument_list|()
condition|)
name|testDataDir
operator|=
name|QCoreApplication
operator|::
name|applicationDirPath
argument_list|()
expr_stmt|;
name|connect
argument_list|(
name|serverSocket
argument_list|,
name|SIGNAL
argument_list|(
name|encrypted
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|encryptedSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|serverSocket
operator|->
name|setProtocol
argument_list|(
name|QSsl
operator|::
name|AnyProtocol
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|serverSocket
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|serverSocket
argument_list|,
name|SLOT
argument_list|(
name|ignoreSslErrors
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|serverSocket
operator|->
name|setLocalCertificate
argument_list|(
name|testDataDir
operator|+
literal|"/certs/server.pem"
argument_list|)
expr_stmt|;
name|serverSocket
operator|->
name|setPrivateKey
argument_list|(
name|testDataDir
operator|+
literal|"/certs/server.key"
argument_list|)
expr_stmt|;
name|serverSocket
operator|->
name|startServerEncryption
argument_list|()
expr_stmt|;
block|}
else|else
block|{
operator|delete
name|serverSocket
expr_stmt|;
block|}
block|}
signals|signals:
name|void
name|newEncryptedConnection
parameter_list|(
name|QSslSocket
modifier|*
name|s
parameter_list|)
function_decl|;
name|void
name|newPlainConnection
parameter_list|(
name|QSslSocket
modifier|*
name|s
parameter_list|)
function_decl|;
public|public
name|slots
public|:
DECL|function|encryptedSlot
name|void
name|encryptedSlot
parameter_list|()
block|{
name|socket
operator|=
operator|(
name|QSslSocket
operator|*
operator|)
name|sender
argument_list|()
expr_stmt|;
emit|emit
name|newEncryptedConnection
argument_list|(
name|socket
argument_list|)
emit|;
block|}
DECL|function|readyReadSlot
name|void
name|readyReadSlot
parameter_list|()
block|{
comment|// for the incoming sockets, not the server socket
comment|//qDebug()<< static_cast<QSslSocket*>(sender())->bytesAvailable()<< static_cast<QSslSocket*>(sender())->encryptedBytesAvailable();
block|}
public|public:
DECL|member|socket
name|QSslSocket
modifier|*
name|socket
decl_stmt|;
DECL|member|m_ssl
name|bool
name|m_ssl
decl_stmt|;
block|}
class|;
end_class
begin_comment
comment|// very similar to ioPostToHttpUploadProgress but for SSL
end_comment
begin_function
DECL|function|ioPostToHttpsUploadProgress
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpsUploadProgress
parameter_list|()
block|{
comment|//QFile sourceFile(testDataDir + "/bigfile");
comment|//QVERIFY(sourceFile.open(QIODevice::ReadOnly));
name|qint64
name|wantedSize
init|=
literal|2
operator|*
literal|1024
operator|*
literal|1024
decl_stmt|;
comment|// 2 MB
name|QByteArray
name|sourceFile
decl_stmt|;
comment|// And in the case of SSL, the compression can fool us and let the
comment|// server send the data much faster than expected.
comment|// So better provide random data that cannot be compressed.
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|wantedSize
condition|;
operator|++
name|i
control|)
name|sourceFile
operator|+=
operator|(
name|char
operator|)
name|qrand
argument_list|()
expr_stmt|;
comment|// emulate a minimal https server
name|SslServer
name|server
decl_stmt|;
name|server
operator|.
name|listen
argument_list|(
name|QHostAddress
argument_list|(
name|QHostAddress
operator|::
name|LocalHost
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// create the request
name|QUrl
name|url
init|=
name|QUrl
argument_list|(
name|QString
argument_list|(
literal|"https://127.0.0.1:%1/"
argument_list|)
operator|.
name|arg
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
name|sourceFile
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|uploadProgress
argument_list|(
name|qint64
argument_list|,
name|qint64
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|server
argument_list|,
name|SIGNAL
argument_list|(
name|newEncryptedConnection
argument_list|(
name|QSslSocket
operator|*
argument_list|)
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|ignoreSslErrors
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// get the request started and the incoming socket connected
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QTcpSocket
modifier|*
name|incomingSocket
init|=
name|server
operator|.
name|socket
decl_stmt|;
name|QVERIFY
argument_list|(
name|incomingSocket
argument_list|)
expr_stmt|;
name|disconnect
argument_list|(
operator|&
name|server
argument_list|,
name|SIGNAL
argument_list|(
name|newEncryptedConnection
argument_list|(
name|QSslSocket
operator|*
argument_list|)
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|setReadBufferSize
argument_list|(
literal|1
operator|*
literal|1024
argument_list|)
expr_stmt|;
comment|// some progress should have been made
name|QTRY_VERIFY
argument_list|(
operator|!
name|spy
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QList
argument_list|<
name|QVariant
argument_list|>
name|args
init|=
name|spy
operator|.
name|last
argument_list|()
decl_stmt|;
name|QVERIFY
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toLongLong
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// but not everything!
name|QVERIFY
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toLongLong
argument_list|()
operator|!=
name|sourceFile
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// set the read buffer to unlimited
name|incomingSocket
operator|->
name|setReadBufferSize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|// progress should be finished
name|QVERIFY
argument_list|(
operator|!
name|spy
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QList
argument_list|<
name|QVariant
argument_list|>
name|args3
init|=
name|spy
operator|.
name|last
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|args3
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|args3
operator|.
name|at
argument_list|(
literal|1
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|args3
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|sourceFile
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// after sending this, the QNAM should emit finished()
name|incomingSocket
operator|->
name|write
argument_list|(
literal|"HTTP/1.0 200 OK\r\n"
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|write
argument_list|(
literal|"Content-Length: 0\r\n"
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|write
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|close
argument_list|()
expr_stmt|;
name|server
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_function
DECL|function|ioGetFromBuiltinHttp_data
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromBuiltinHttp_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"https"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"bufferSize"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http+unlimited"
argument_list|)
operator|<<
literal|false
operator|<<
literal|0
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http+limited"
argument_list|)
operator|<<
literal|false
operator|<<
literal|4096
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https+unlimited"
argument_list|)
operator|<<
literal|true
operator|<<
literal|0
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https+limited"
argument_list|)
operator|<<
literal|true
operator|<<
literal|4096
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|ioGetFromBuiltinHttp
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromBuiltinHttp
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|https
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|bufferSize
argument_list|)
expr_stmt|;
name|QByteArray
name|testData
decl_stmt|;
comment|// Make the data big enough so that it can fill the kernel buffer
comment|// (which seems to hold 202 KB here)
specifier|const
name|int
name|wantedSize
init|=
literal|1200
operator|*
literal|1000
decl_stmt|;
name|testData
operator|.
name|reserve
argument_list|(
name|wantedSize
argument_list|)
expr_stmt|;
comment|// And in the case of SSL, the compression can fool us and let the
comment|// server send the data much faster than expected.
comment|// So better provide random data that cannot be compressed.
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|wantedSize
condition|;
operator|++
name|i
control|)
name|testData
operator|+=
operator|(
name|char
operator|)
name|qrand
argument_list|()
expr_stmt|;
name|QByteArray
name|httpResponse
init|=
name|QByteArray
argument_list|(
literal|"HTTP/1.0 200 OK\r\nContent-Length: "
argument_list|)
decl_stmt|;
name|httpResponse
operator|+=
name|QByteArray
operator|::
name|number
argument_list|(
name|testData
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|httpResponse
operator|+=
literal|"\r\n\r\n"
expr_stmt|;
name|httpResponse
operator|+=
name|testData
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"Server will send"
operator|<<
operator|(
name|httpResponse
operator|.
name|size
argument_list|()
operator|-
name|testData
operator|.
name|size
argument_list|()
operator|)
operator|<<
literal|"bytes of header and"
operator|<<
name|testData
operator|.
name|size
argument_list|()
operator|<<
literal|"bytes of data"
expr_stmt|;
specifier|const
name|bool
name|fillKernelBuffer
init|=
name|bufferSize
operator|>
literal|0
decl_stmt|;
name|FastSender
name|server
argument_list|(
name|httpResponse
argument_list|,
name|https
argument_list|,
name|fillKernelBuffer
argument_list|)
decl_stmt|;
name|QUrl
name|url
argument_list|(
name|QString
argument_list|(
literal|"%1://127.0.0.1:%2/qtest/rfc3252.txt"
argument_list|)
operator|.
name|arg
argument_list|(
name|https
condition|?
literal|"https"
else|:
literal|"http"
argument_list|)
operator|.
name|arg
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|reply
operator|->
name|setReadBufferSize
argument_list|(
name|bufferSize
argument_list|)
expr_stmt|;
name|reply
operator|->
name|ignoreSslErrors
argument_list|()
expr_stmt|;
specifier|const
name|int
name|rate
init|=
literal|200
decl_stmt|;
comment|// in kB per sec
name|RateControlledReader
name|reader
argument_list|(
name|server
argument_list|,
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|rate
argument_list|,
name|bufferSize
argument_list|)
decl_stmt|;
name|QTime
name|loopTime
decl_stmt|;
name|loopTime
operator|.
name|start
argument_list|()
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
specifier|const
name|int
name|elapsedTime
init|=
name|loopTime
operator|.
name|elapsed
argument_list|()
decl_stmt|;
name|server
operator|.
name|wait
argument_list|()
expr_stmt|;
name|reader
operator|.
name|wrapUp
argument_list|()
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"send rate:"
operator|<<
name|server
operator|.
name|transferRate
operator|<<
literal|"B/s"
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"receive rate:"
operator|<<
name|reader
operator|.
name|totalBytesRead
operator|*
literal|1000
operator|/
name|elapsedTime
operator|<<
literal|"(it received"
operator|<<
name|reader
operator|.
name|totalBytesRead
operator|<<
literal|"bytes in"
operator|<<
name|elapsedTime
operator|<<
literal|"ms)"
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
operator|(
name|qint64
operator|)
name|testData
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
operator|<
name|testData
operator|.
name|size
argument_list|()
condition|)
block|{
comment|// oops?
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|testData
operator|.
name|mid
argument_list|(
literal|0
argument_list|,
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"The data is incomplete, the last"
operator|<<
name|testData
operator|.
name|size
argument_list|()
operator|-
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
operator|<<
literal|"bytes are missing"
expr_stmt|;
block|}
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
operator|.
name|size
argument_list|()
argument_list|,
name|testData
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reader
operator|.
name|data
argument_list|,
name|testData
argument_list|)
expr_stmt|;
comment|// OK we got the file alright, but did setReadBufferSize work?
name|QVERIFY
argument_list|(
name|server
operator|.
name|transferRate
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bufferSize
operator|>
literal|0
condition|)
block|{
specifier|const
name|int
name|allowedDeviation
init|=
literal|16
decl_stmt|;
comment|// TODO find out why the send rate is 13% faster currently
specifier|const
name|int
name|minRate
init|=
name|rate
operator|*
literal|1024
operator|*
operator|(
literal|100
operator|-
name|allowedDeviation
operator|)
operator|/
literal|100
decl_stmt|;
specifier|const
name|int
name|maxRate
init|=
name|rate
operator|*
literal|1024
operator|*
operator|(
literal|100
operator|+
name|allowedDeviation
operator|)
operator|/
literal|100
decl_stmt|;
name|qDebug
argument_list|()
operator|<<
name|minRate
operator|<<
literal|"<="
operator|<<
name|server
operator|.
name|transferRate
operator|<<
literal|"<="
operator|<<
name|maxRate
operator|<<
literal|"?"
expr_stmt|;
comment|// The test takes too long to run if sending enough data to overwhelm the
comment|// reciever's kernel buffers.
comment|//QEXPECT_FAIL("http+limited", "Limiting is broken right now, check QTBUG-15065", Continue);
comment|//QEXPECT_FAIL("https+limited", "Limiting is broken right now, check QTBUG-15065", Continue);
comment|//QVERIFY(server.transferRate>= minRate&& server.transferRate<= maxRate);
block|}
block|}
end_function
begin_function
DECL|function|ioPostToHttpUploadProgress
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpUploadProgress
parameter_list|()
block|{
comment|//test file must be larger than OS socket buffers (~830kB on MacOS 10.6)
name|QFile
name|sourceFile
argument_list|(
name|testDataDir
operator|+
literal|"/image1.jpg"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
specifier|const
name|qint64
name|sourceFileSize
init|=
name|sourceFile
operator|.
name|size
argument_list|()
decl_stmt|;
comment|// emulate a minimal http server
name|QTcpServer
name|server
decl_stmt|;
name|server
operator|.
name|listen
argument_list|(
name|QHostAddress
argument_list|(
name|QHostAddress
operator|::
name|LocalHost
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// create the request
name|QUrl
name|url
init|=
name|QUrl
argument_list|(
name|QString
argument_list|(
literal|"http://127.0.0.1:%1/"
argument_list|)
operator|.
name|arg
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
operator|&
name|sourceFile
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|uploadProgress
argument_list|(
name|qint64
argument_list|,
name|qint64
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|server
argument_list|,
name|SIGNAL
argument_list|(
name|newConnection
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// get the request started and the incoming socket connected
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QTcpSocket
modifier|*
name|incomingSocket
init|=
name|server
operator|.
name|nextPendingConnection
argument_list|()
decl_stmt|;
name|QVERIFY
argument_list|(
name|incomingSocket
argument_list|)
expr_stmt|;
name|disconnect
argument_list|(
operator|&
name|server
argument_list|,
name|SIGNAL
argument_list|(
name|newConnection
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|setReadBufferSize
argument_list|(
literal|1
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|5
argument_list|)
expr_stmt|;
comment|// some progress should have been made
name|QVERIFY
argument_list|(
operator|!
name|spy
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
specifier|const
name|QList
argument_list|<
name|QVariant
argument_list|>
name|args
init|=
name|spy
operator|.
name|last
argument_list|()
decl_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|args
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
specifier|const
name|qint64
name|bufferedUploadProgress
init|=
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toLongLong
argument_list|()
decl_stmt|;
name|QVERIFY
argument_list|(
name|bufferedUploadProgress
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// but not everything? - Note however, that under CI virtualization,
comment|// particularly on Windows, it frequently happens that the whole file
comment|// is uploaded in one chunk.
if|if
condition|(
name|bufferedUploadProgress
operator|==
name|sourceFileSize
condition|)
block|{
name|qWarning
argument_list|()
operator|<<
name|QDir
operator|::
name|toNativeSeparators
argument_list|(
name|sourceFile
operator|.
name|fileName
argument_list|()
argument_list|)
operator|<<
literal|"of"
operator|<<
name|sourceFileSize
operator|<<
literal|"bytes was uploaded in one go."
expr_stmt|;
block|}
comment|// set the read buffer to unlimited
name|incomingSocket
operator|->
name|setReadBufferSize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|// progress should be finished
name|QVERIFY
argument_list|(
operator|!
name|spy
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
specifier|const
name|QList
argument_list|<
name|QVariant
argument_list|>
name|args3
init|=
name|spy
operator|.
name|last
argument_list|()
decl_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|args3
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
comment|// More progress than before
specifier|const
name|qint64
name|unbufferedUploadProgress
init|=
name|args3
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toLongLong
argument_list|()
decl_stmt|;
if|if
condition|(
name|bufferedUploadProgress
operator|<
name|sourceFileSize
condition|)
name|QVERIFY
argument_list|(
name|unbufferedUploadProgress
operator|>
name|bufferedUploadProgress
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|unbufferedUploadProgress
argument_list|,
name|args3
operator|.
name|at
argument_list|(
literal|1
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|)
expr_stmt|;
comment|// And actually finished..
name|QCOMPARE
argument_list|(
name|unbufferedUploadProgress
argument_list|,
name|sourceFileSize
argument_list|)
expr_stmt|;
comment|// after sending this, the QNAM should emit finished()
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|write
argument_list|(
literal|"HTTP/1.0 200 OK\r\n"
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|write
argument_list|(
literal|"Content-Length: 0\r\n"
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|write
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|// not timeouted -> finished() was emitted
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|close
argument_list|()
expr_stmt|;
name|server
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ioPostToHttpEmptyUploadProgress
name|void
name|tst_QNetworkReply
operator|::
name|ioPostToHttpEmptyUploadProgress
parameter_list|()
block|{
name|QByteArray
name|ba
decl_stmt|;
name|ba
operator|.
name|resize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|QBuffer
name|buffer
argument_list|(
operator|&
name|ba
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|buffer
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
comment|// emulate a minimal http server
name|QTcpServer
name|server
decl_stmt|;
name|server
operator|.
name|listen
argument_list|(
name|QHostAddress
argument_list|(
name|QHostAddress
operator|::
name|LocalHost
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// create the request
name|QUrl
name|url
init|=
name|QUrl
argument_list|(
name|QString
argument_list|(
literal|"http://127.0.0.1:%1/"
argument_list|)
operator|.
name|arg
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
operator|&
name|buffer
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|uploadProgress
argument_list|(
name|qint64
argument_list|,
name|qint64
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
operator|&
name|server
argument_list|,
name|SIGNAL
argument_list|(
name|newConnection
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// get the request started and the incoming socket connected
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QTcpSocket
modifier|*
name|incomingSocket
init|=
name|server
operator|.
name|nextPendingConnection
argument_list|()
decl_stmt|;
name|QVERIFY
argument_list|(
name|incomingSocket
argument_list|)
expr_stmt|;
comment|// after sending this, the QNAM should emit finished()
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|write
argument_list|(
literal|"HTTP/1.0 200 OK\r\n"
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|write
argument_list|(
literal|"Content-Length: 0\r\n"
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|write
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|flush
argument_list|()
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|// not timeouted -> finished() was emitted
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
comment|// final check: only 1 uploadProgress has been emitted
name|QVERIFY
argument_list|(
name|spy
operator|.
name|length
argument_list|()
operator|==
literal|1
argument_list|)
expr_stmt|;
name|QList
argument_list|<
name|QVariant
argument_list|>
name|args
init|=
name|spy
operator|.
name|last
argument_list|()
decl_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|args
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|buffer
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|buffer
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|incomingSocket
operator|->
name|close
argument_list|()
expr_stmt|;
name|server
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|lastModifiedHeaderForFile
name|void
name|tst_QNetworkReply
operator|::
name|lastModifiedHeaderForFile
parameter_list|()
block|{
name|QFileInfo
name|fileInfo
argument_list|(
name|testDataDir
operator|+
literal|"/bigfile"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|fileInfo
operator|.
name|exists
argument_list|()
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|fileInfo
operator|.
name|filePath
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|head
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QDateTime
name|header
init|=
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|LastModifiedHeader
argument_list|)
operator|.
name|toDateTime
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|header
argument_list|,
name|fileInfo
operator|.
name|lastModified
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|lastModifiedHeaderForHttp
name|void
name|tst_QNetworkReply
operator|::
name|lastModifiedHeaderForHttp
parameter_list|()
block|{
comment|// Tue, 22 May 2007 12:04:57 GMT according to webserver
name|QUrl
name|url
init|=
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/fluke.gif"
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|head
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QDateTime
name|header
init|=
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|LastModifiedHeader
argument_list|)
operator|.
name|toDateTime
argument_list|()
decl_stmt|;
name|QDateTime
name|realDate
init|=
name|QDateTime
operator|::
name|fromString
argument_list|(
literal|"2007-05-22T12:04:57"
argument_list|,
name|Qt
operator|::
name|ISODate
argument_list|)
decl_stmt|;
name|realDate
operator|.
name|setTimeSpec
argument_list|(
name|Qt
operator|::
name|UTC
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|header
argument_list|,
name|realDate
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|httpCanReadLine
name|void
name|tst_QNetworkReply
operator|::
name|httpCanReadLine
parameter_list|()
block|{
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|canReadLine
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|canReadLine
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|rateControl_data
name|void
name|tst_QNetworkReply
operator|::
name|rateControl_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"rate"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"15"
argument_list|)
operator|<<
literal|15
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"40"
argument_list|)
operator|<<
literal|40
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"73"
argument_list|)
operator|<<
literal|73
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"80"
argument_list|)
operator|<<
literal|80
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"125"
argument_list|)
operator|<<
literal|125
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"250"
argument_list|)
operator|<<
literal|250
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"1024"
argument_list|)
operator|<<
literal|1024
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|rateControl
name|void
name|tst_QNetworkReply
operator|::
name|rateControl
parameter_list|()
block|{
name|QSKIP
argument_list|(
literal|"Test disabled -- only for manual purposes"
argument_list|)
expr_stmt|;
comment|// this function tests that we aren't reading from the network
comment|// faster than the data is being consumed.
name|QFETCH
argument_list|(
name|int
argument_list|,
name|rate
argument_list|)
expr_stmt|;
comment|// ask for 20 seconds worth of data
name|FastSender
name|sender
argument_list|(
literal|20
operator|*
name|rate
operator|*
literal|1024
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
literal|"debugpipe://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|sender
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|reply
operator|->
name|setReadBufferSize
argument_list|(
literal|32768
argument_list|)
expr_stmt|;
name|QSignalSpy
name|errorSpy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|RateControlledReader
name|reader
argument_list|(
name|sender
argument_list|,
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|rate
argument_list|,
literal|20
argument_list|)
decl_stmt|;
comment|// this test is designed to run for 25 seconds at most
name|QTime
name|loopTime
decl_stmt|;
name|loopTime
operator|.
name|start
argument_list|()
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|elapsedTime
init|=
name|loopTime
operator|.
name|elapsed
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|errorSpy
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|qDebug
argument_list|()
operator|<<
literal|"ERROR!"
operator|<<
name|errorSpy
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|<<
name|reply
operator|->
name|errorString
argument_list|()
expr_stmt|;
block|}
name|qDebug
argument_list|()
operator|<<
literal|"tst_QNetworkReply::rateControl"
operator|<<
literal|"send rate:"
operator|<<
name|sender
operator|.
name|transferRate
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"tst_QNetworkReply::rateControl"
operator|<<
literal|"receive rate:"
operator|<<
name|reader
operator|.
name|totalBytesRead
operator|*
literal|1000
operator|/
name|elapsedTime
operator|<<
literal|"(it received"
operator|<<
name|reader
operator|.
name|totalBytesRead
operator|<<
literal|"bytes in"
operator|<<
name|elapsedTime
operator|<<
literal|"ms)"
expr_stmt|;
name|sender
operator|.
name|wait
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|sender
operator|.
name|transferRate
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|int
name|minRate
init|=
name|rate
operator|*
literal|1024
operator|*
literal|9
operator|/
literal|10
decl_stmt|;
name|int
name|maxRate
init|=
name|rate
operator|*
literal|1024
operator|*
literal|11
operator|/
literal|10
decl_stmt|;
name|QVERIFY
argument_list|(
name|sender
operator|.
name|transferRate
operator|>=
name|minRate
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|sender
operator|.
name|transferRate
operator|<=
name|maxRate
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_function
DECL|function|downloadProgress_data
name|void
name|tst_QNetworkReply
operator|::
name|downloadProgress_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"expectedSize"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty"
argument_list|)
operator|<<
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|QFINDTESTDATA
argument_list|(
literal|"empty"
argument_list|)
argument_list|)
operator|<<
literal|0
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http:small"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
operator|<<
literal|25962
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http:big"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
argument_list|)
operator|<<
literal|519240
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http:no-length"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/deflate/rfc2616.html"
argument_list|)
operator|<<
operator|-
literal|1
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp:small"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
operator|<<
literal|25962
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp:big"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
argument_list|)
operator|<<
literal|519240
expr_stmt|;
block|}
end_function
begin_class
DECL|class|SlowReader
class|class
name|SlowReader
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|function|SlowReader
name|SlowReader
parameter_list|(
name|QIODevice
modifier|*
name|dev
parameter_list|)
member_init_list|:
name|device
argument_list|(
name|dev
argument_list|)
block|{
name|connect
argument_list|(
name|device
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|deviceReady
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
private|private
name|slots
private|:
DECL|function|deviceReady
name|void
name|deviceReady
parameter_list|()
block|{
name|QTimer
operator|::
name|singleShot
argument_list|(
literal|100
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|doRead
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|function|doRead
name|void
name|doRead
parameter_list|()
block|{
name|device
operator|->
name|readAll
argument_list|()
expr_stmt|;
block|}
private|private:
DECL|member|device
name|QIODevice
modifier|*
name|device
decl_stmt|;
block|}
class|;
end_class
begin_function
DECL|function|downloadProgress
name|void
name|tst_QNetworkReply
operator|::
name|downloadProgress
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|expectedSize
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
comment|//artificially slow down the test, otherwise only the final signal is emitted
name|reply
operator|->
name|setReadBufferSize
argument_list|(
name|qMax
argument_list|(
literal|20000
argument_list|,
name|expectedSize
operator|/
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|SlowReader
name|reader
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|)
decl_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|downloadProgress
argument_list|(
name|qint64
argument_list|,
name|qint64
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|30
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|spy
operator|.
name|count
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|//final progress should have equal current& total
name|QList
argument_list|<
name|QVariant
argument_list|>
name|args
init|=
name|spy
operator|.
name|takeLast
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|args
operator|.
name|at
argument_list|(
literal|1
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|)
expr_stmt|;
name|qint64
name|current
init|=
literal|0
decl_stmt|;
comment|//intermediate progress ascending and has expected total
while|while
condition|(
operator|!
name|spy
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|args
operator|=
name|spy
operator|.
name|takeFirst
argument_list|()
expr_stmt|;
name|QVERIFY
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toInt
argument_list|()
operator|>=
name|current
argument_list|)
expr_stmt|;
if|if
condition|(
name|expectedSize
operator|>=
literal|0
condition|)
name|QCOMPARE
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|1
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|expectedSize
argument_list|)
expr_stmt|;
else|else
name|QVERIFY
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|1
argument_list|)
operator|.
name|toInt
argument_list|()
operator|==
name|expectedSize
operator|||
name|args
operator|.
name|at
argument_list|(
literal|1
argument_list|)
operator|.
name|toInt
argument_list|()
operator|==
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|)
expr_stmt|;
name|current
operator|=
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toInt
argument_list|()
expr_stmt|;
block|}
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|uploadProgress_data
name|void
name|tst_QNetworkReply
operator|::
name|uploadProgress_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|uploadProgress
name|void
name|tst_QNetworkReply
operator|::
name|uploadProgress
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|QTcpServer
name|server
decl_stmt|;
name|QVERIFY
argument_list|(
name|server
operator|.
name|listen
argument_list|()
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
literal|"debugpipe://127.0.0.1:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
operator|+
literal|"/?bare=1"
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|request
argument_list|,
name|data
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|uploadProgress
argument_list|(
name|qint64
argument_list|,
name|qint64
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|finished
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|spy
operator|.
name|isValid
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|finished
operator|.
name|isValid
argument_list|()
argument_list|)
expr_stmt|;
name|QCoreApplication
operator|::
name|instance
argument_list|()
operator|->
name|processEvents
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|server
operator|.
name|hasPendingConnections
argument_list|()
condition|)
name|server
operator|.
name|waitForNewConnection
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|server
operator|.
name|hasPendingConnections
argument_list|()
argument_list|)
expr_stmt|;
name|QTcpSocket
modifier|*
name|receiver
init|=
name|server
operator|.
name|nextPendingConnection
argument_list|()
decl_stmt|;
if|if
condition|(
name|finished
operator|.
name|count
argument_list|()
operator|==
literal|0
condition|)
block|{
comment|// it's not finished yet, so wait for it to be
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|delete
name|receiver
expr_stmt|;
name|QVERIFY
argument_list|(
name|finished
operator|.
name|count
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|spy
operator|.
name|count
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
name|QList
argument_list|<
name|QVariant
argument_list|>
name|args
init|=
name|spy
operator|.
name|last
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|data
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|args
operator|.
name|at
argument_list|(
literal|1
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|data
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_function
DECL|function|chaining_data
name|void
name|tst_QNetworkReply
operator|::
name|chaining_data
parameter_list|()
block|{
name|putToFile_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|chaining
name|void
name|tst_QNetworkReply
operator|::
name|chaining
parameter_list|()
block|{
name|QTemporaryFile
name|sourceFile
argument_list|(
name|QDir
operator|::
name|currentPath
argument_list|()
operator|+
literal|"/temp-XXXXXX"
argument_list|)
decl_stmt|;
name|sourceFile
operator|.
name|setAutoRemove
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|open
argument_list|()
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|write
argument_list|(
name|data
argument_list|)
operator|==
name|data
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|sourceFile
operator|.
name|flush
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|sourceFile
operator|.
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|data
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|sourceFile
operator|.
name|fileName
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|getReply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QFile
name|targetFile
argument_list|(
name|testFileName
argument_list|)
decl_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|targetFile
operator|.
name|fileName
argument_list|()
argument_list|)
decl_stmt|;
name|request
operator|.
name|setUrl
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|putReply
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|request
argument_list|,
name|getReply
operator|.
name|data
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|putReply
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|getReply
operator|->
name|url
argument_list|()
argument_list|,
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|sourceFile
operator|.
name|fileName
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|getReply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|getReply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|sourceFile
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|putReply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|putReply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|putReply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|Q_INT64_C
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|putReply
operator|->
name|readAll
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|sourceFile
operator|.
name|atEnd
argument_list|()
argument_list|)
expr_stmt|;
name|sourceFile
operator|.
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// reset it to the beginning
name|QVERIFY
argument_list|(
name|targetFile
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|targetFile
operator|.
name|size
argument_list|()
argument_list|,
name|sourceFile
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|targetFile
operator|.
name|readAll
argument_list|()
argument_list|,
name|sourceFile
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|receiveCookiesFromHttp_data
name|void
name|tst_QNetworkReply
operator|::
name|receiveCookiesFromHttp_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"cookieString"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|>
argument_list|(
literal|"expectedCookiesFromHttp"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|>
argument_list|(
literal|"expectedCookiesInJar"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty"
argument_list|)
operator|<<
literal|""
operator|<<
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|()
operator|<<
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|()
expr_stmt|;
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
name|header
decl_stmt|,
name|jar
decl_stmt|;
name|QNetworkCookie
name|cookie
argument_list|(
literal|"a"
argument_list|,
literal|"b"
argument_list|)
decl_stmt|;
name|header
operator|<<
name|cookie
expr_stmt|;
name|cookie
operator|.
name|setDomain
argument_list|(
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setPath
argument_list|(
literal|"/qtest/cgi-bin/"
argument_list|)
expr_stmt|;
name|jar
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"simple-cookie"
argument_list|)
operator|<<
literal|"a=b"
operator|<<
name|header
operator|<<
name|jar
expr_stmt|;
name|header
operator|<<
name|QNetworkCookie
argument_list|(
literal|"c"
argument_list|,
literal|"d"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setName
argument_list|(
literal|"c"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setValue
argument_list|(
literal|"d"
argument_list|)
expr_stmt|;
name|jar
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"two-cookies"
argument_list|)
operator|<<
literal|"a=b\nc=d"
operator|<<
name|header
operator|<<
name|jar
expr_stmt|;
name|header
operator|.
name|clear
argument_list|()
expr_stmt|;
name|jar
operator|.
name|clear
argument_list|()
expr_stmt|;
name|header
operator|<<
name|QNetworkCookie
argument_list|(
literal|"a"
argument_list|,
literal|"b, c=d"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setName
argument_list|(
literal|"a"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setValue
argument_list|(
literal|"b, c=d"
argument_list|)
expr_stmt|;
name|jar
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalid-two-cookies"
argument_list|)
operator|<<
literal|"a=b, c=d"
operator|<<
name|header
operator|<<
name|jar
expr_stmt|;
name|header
operator|.
name|clear
argument_list|()
expr_stmt|;
name|jar
operator|.
name|clear
argument_list|()
expr_stmt|;
name|cookie
operator|=
name|QNetworkCookie
argument_list|(
literal|"a"
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setPath
argument_list|(
literal|"/not/part-of-path"
argument_list|)
expr_stmt|;
name|header
operator|<<
name|cookie
expr_stmt|;
name|cookie
operator|.
name|setDomain
argument_list|(
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
expr_stmt|;
name|jar
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalid-cookie-path"
argument_list|)
operator|<<
literal|"a=b; path=/not/part-of-path"
operator|<<
name|header
operator|<<
name|jar
expr_stmt|;
name|jar
operator|.
name|clear
argument_list|()
expr_stmt|;
name|cookie
operator|=
name|QNetworkCookie
argument_list|(
literal|"a"
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setDomain
argument_list|(
literal|".example.com"
argument_list|)
expr_stmt|;
name|header
operator|.
name|clear
argument_list|()
expr_stmt|;
name|header
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalid-cookie-domain"
argument_list|)
operator|<<
literal|"a=b; domain=.example.com"
operator|<<
name|header
operator|<<
name|jar
expr_stmt|;
block|}
end_function
begin_function
DECL|function|receiveCookiesFromHttp
name|void
name|tst_QNetworkReply
operator|::
name|receiveCookiesFromHttp
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|cookieString
argument_list|)
expr_stmt|;
name|QByteArray
name|data
init|=
name|cookieString
operator|.
name|toLatin1
argument_list|()
operator|+
literal|'\n'
decl_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/set-cookie.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PostOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
name|setCookies
init|=
name|qvariant_cast
argument_list|<
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|>
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|SetCookieHeader
argument_list|)
argument_list|)
decl_stmt|;
name|QTEST
argument_list|(
name|setCookies
argument_list|,
literal|"expectedCookiesFromHttp"
argument_list|)
expr_stmt|;
name|QTEST
argument_list|(
name|cookieJar
operator|->
name|allCookies
argument_list|()
argument_list|,
literal|"expectedCookiesInJar"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|receiveCookiesFromHttpSynchronous_data
name|void
name|tst_QNetworkReply
operator|::
name|receiveCookiesFromHttpSynchronous_data
parameter_list|()
block|{
name|tst_QNetworkReply
operator|::
name|receiveCookiesFromHttp_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|receiveCookiesFromHttpSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|receiveCookiesFromHttpSynchronous
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|cookieString
argument_list|)
expr_stmt|;
name|QByteArray
name|data
init|=
name|cookieString
operator|.
name|toLatin1
argument_list|()
operator|+
literal|'\n'
decl_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/set-cookie.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|PostOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
name|setCookies
init|=
name|qvariant_cast
argument_list|<
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|>
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|SetCookieHeader
argument_list|)
argument_list|)
decl_stmt|;
name|QTEST
argument_list|(
name|setCookies
argument_list|,
literal|"expectedCookiesFromHttp"
argument_list|)
expr_stmt|;
name|QTEST
argument_list|(
name|cookieJar
operator|->
name|allCookies
argument_list|()
argument_list|,
literal|"expectedCookiesInJar"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sendCookies_data
name|void
name|tst_QNetworkReply
operator|::
name|sendCookies_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|>
argument_list|(
literal|"cookiesToSet"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"expectedCookieString"
argument_list|)
expr_stmt|;
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
name|list
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty"
argument_list|)
operator|<<
name|list
operator|<<
literal|""
expr_stmt|;
name|QNetworkCookie
name|cookie
argument_list|(
literal|"a"
argument_list|,
literal|"b"
argument_list|)
decl_stmt|;
name|cookie
operator|.
name|setPath
argument_list|(
literal|"/"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setDomain
argument_list|(
literal|"example.com"
argument_list|)
expr_stmt|;
name|list
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"no-match-domain"
argument_list|)
operator|<<
name|list
operator|<<
literal|""
expr_stmt|;
name|cookie
operator|.
name|setDomain
argument_list|(
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setPath
argument_list|(
literal|"/something/else"
argument_list|)
expr_stmt|;
name|list
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"no-match-path"
argument_list|)
operator|<<
name|list
operator|<<
literal|""
expr_stmt|;
name|cookie
operator|.
name|setPath
argument_list|(
literal|"/"
argument_list|)
expr_stmt|;
name|list
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"simple-cookie"
argument_list|)
operator|<<
name|list
operator|<<
literal|"a=b"
expr_stmt|;
name|cookie
operator|.
name|setPath
argument_list|(
literal|"/qtest"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setValue
argument_list|(
literal|"longer"
argument_list|)
expr_stmt|;
name|list
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"two-cookies"
argument_list|)
operator|<<
name|list
operator|<<
literal|"a=longer; a=b"
expr_stmt|;
name|list
operator|.
name|clear
argument_list|()
expr_stmt|;
name|cookie
operator|=
name|QNetworkCookie
argument_list|(
literal|"a"
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setPath
argument_list|(
literal|"/"
argument_list|)
expr_stmt|;
name|cookie
operator|.
name|setDomain
argument_list|(
literal|"."
operator|+
name|QtNetworkSettings
operator|::
name|serverDomainName
argument_list|()
argument_list|)
expr_stmt|;
name|list
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"domain-match"
argument_list|)
operator|<<
name|list
operator|<<
literal|"a=b"
expr_stmt|;
comment|// but it shouldn't match this:
name|cookie
operator|.
name|setDomain
argument_list|(
name|QtNetworkSettings
operator|::
name|serverDomainName
argument_list|()
argument_list|)
expr_stmt|;
name|list
operator|<<
name|cookie
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"domain-match-2"
argument_list|)
operator|<<
name|list
operator|<<
literal|"a=b"
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sendCookies
name|void
name|tst_QNetworkReply
operator|::
name|sendCookies
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|expectedCookieString
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|,
name|cookiesToSet
argument_list|)
expr_stmt|;
name|cookieJar
operator|->
name|setAllCookies
argument_list|(
name|cookiesToSet
argument_list|)
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/get-cookie.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QCOMPARE
argument_list|(
name|QString
operator|::
name|fromLatin1
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|)
operator|.
name|trimmed
argument_list|()
argument_list|,
name|expectedCookieString
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sendCookiesSynchronous_data
name|void
name|tst_QNetworkReply
operator|::
name|sendCookiesSynchronous_data
parameter_list|()
block|{
name|tst_QNetworkReply
operator|::
name|sendCookies_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sendCookiesSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|sendCookiesSynchronous
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|expectedCookieString
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QList
argument_list|<
name|QNetworkCookie
argument_list|>
argument_list|,
name|cookiesToSet
argument_list|)
expr_stmt|;
name|cookieJar
operator|->
name|setAllCookies
argument_list|(
name|cookiesToSet
argument_list|)
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/get-cookie.cgi"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
comment|// 200 Ok
name|QCOMPARE
argument_list|(
name|QString
operator|::
name|fromLatin1
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|)
operator|.
name|trimmed
argument_list|()
argument_list|,
name|expectedCookieString
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|nestedEventLoops_slot
name|void
name|tst_QNetworkReply
operator|::
name|nestedEventLoops_slot
parameter_list|()
block|{
name|QEventLoop
name|subloop
decl_stmt|;
comment|// 16 seconds: fluke times out in 15 seconds, which triggers a QTcpSocket error
name|QTimer
operator|::
name|singleShot
argument_list|(
literal|16000
argument_list|,
operator|&
name|subloop
argument_list|,
name|SLOT
argument_list|(
name|quit
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|subloop
operator|.
name|exec
argument_list|()
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|exitLoop
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|nestedEventLoops
name|void
name|tst_QNetworkReply
operator|::
name|nestedEventLoops
parameter_list|()
block|{
comment|// Slightly fragile test, it may not be testing anything
comment|// This is certifying that we're not running into the same issue
comment|// that QHttp had (task 200432): the QTcpSocket connection is
comment|// closed by the remote end because of the kept-alive HTTP
comment|// connection timed out.
comment|//
comment|// The exact time required for this to happen is not exactly
comment|// defined. Our server (Apache httpd) times out after 15
comment|// seconds. (see above)
name|qDebug
argument_list|(
literal|"Takes 16 seconds to run, please wait"
argument_list|)
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|finishedspy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|errorspy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|nestedEventLoops_slot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|,
literal|"Network timeout"
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|finishedspy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|errorspy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
end_ifndef
begin_function
DECL|function|httpProxyCommands_data
name|void
name|tst_QNetworkReply
operator|::
name|httpProxyCommands_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"responseToSend"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"expectedCommand"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://0.0.0.0:4443/http-request"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.0 200 OK\r\nProxy-Connection: close\r\nContent-Length: 1\r\n\r\n1"
argument_list|)
operator|<<
literal|"GET http://0.0.0.0:4443/http-request HTTP/1."
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"https://0.0.0.0:4443/https-request"
argument_list|)
operator|<<
name|QByteArray
argument_list|(
literal|"HTTP/1.0 200 Connection Established\r\n\r\n"
argument_list|)
operator|<<
literal|"CONNECT 0.0.0.0:4443 HTTP/1."
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|httpProxyCommands
name|void
name|tst_QNetworkReply
operator|::
name|httpProxyCommands
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|responseToSend
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|expectedCommand
argument_list|)
expr_stmt|;
name|MiniHttpServer
name|proxyServer
argument_list|(
name|responseToSend
argument_list|)
decl_stmt|;
name|QNetworkProxy
name|proxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpProxy
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|proxyServer
operator|.
name|serverPort
argument_list|()
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"User-Agent"
argument_list|,
literal|"QNetworkReplyAutoTest/1.0"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
comment|//clearing the proxy here causes the test to fail.
comment|//the proxy isn't used until after the bearer has been started
comment|//which is correct in general, because system proxy isn't known until that time.
comment|//removing this line is safe, as the proxy is also reset by the cleanup() function
comment|//manager.setProxy(QNetworkProxy());
comment|// wait for the finished signal
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
comment|//qDebug()<< reply->error()<< reply->errorString();
comment|//qDebug()<< proxyServer.receivedData;
comment|// we don't really care if the request succeeded
comment|// especially since it won't succeed in the HTTPS case
comment|// so just check that the command was correct
name|QString
name|receivedHeader
init|=
name|proxyServer
operator|.
name|receivedData
operator|.
name|left
argument_list|(
name|expectedCommand
operator|.
name|length
argument_list|()
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|receivedHeader
argument_list|,
name|expectedCommand
argument_list|)
expr_stmt|;
comment|//QTBUG-17223 - make sure the user agent from the request is sent to proxy server even for CONNECT
name|int
name|uapos
init|=
name|proxyServer
operator|.
name|receivedData
operator|.
name|indexOf
argument_list|(
literal|"User-Agent"
argument_list|)
decl_stmt|;
name|int
name|uaend
init|=
name|proxyServer
operator|.
name|receivedData
operator|.
name|indexOf
argument_list|(
literal|"\r\n"
argument_list|,
name|uapos
argument_list|)
decl_stmt|;
name|QByteArray
name|uaheader
init|=
name|proxyServer
operator|.
name|receivedData
operator|.
name|mid
argument_list|(
name|uapos
argument_list|,
name|uaend
operator|-
name|uapos
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uaheader
argument_list|,
name|QByteArray
argument_list|(
literal|"User-Agent: QNetworkReplyAutoTest/1.0"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_class
DECL|class|ProxyChangeHelper
class|class
name|ProxyChangeHelper
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|function|ProxyChangeHelper
name|ProxyChangeHelper
parameter_list|()
member_init_list|:
name|QObject
argument_list|()
member_init_list|,
name|signalCount
argument_list|(
literal|0
argument_list|)
block|{}
empty_stmt|;
public|public
name|slots
public|:
DECL|function|finishedSlot
name|void
name|finishedSlot
parameter_list|()
block|{
name|signalCount
operator|++
expr_stmt|;
if|if
condition|(
name|signalCount
operator|==
literal|2
condition|)
name|QMetaObject
operator|::
name|invokeMethod
argument_list|(
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
literal|"exitLoop"
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
block|}
private|private:
DECL|member|signalCount
name|int
name|signalCount
decl_stmt|;
block|}
class|;
end_class
begin_function
DECL|function|httpProxyCommandsSynchronous_data
name|void
name|tst_QNetworkReply
operator|::
name|httpProxyCommandsSynchronous_data
parameter_list|()
block|{
name|httpProxyCommands_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !QT_NO_NETWORKPROXY
end_comment
begin_struct
DECL|struct|QThreadCleanup
struct|struct
name|QThreadCleanup
block|{
DECL|function|cleanup
specifier|static
specifier|inline
name|void
name|cleanup
parameter_list|(
name|QThread
modifier|*
name|thread
parameter_list|)
block|{
name|thread
operator|->
name|quit
argument_list|()
expr_stmt|;
if|if
condition|(
name|thread
operator|->
name|wait
argument_list|(
literal|3000
argument_list|)
condition|)
operator|delete
name|thread
expr_stmt|;
else|else
name|qWarning
argument_list|(
literal|"thread hung, leaking memory so test can finish"
argument_list|)
expr_stmt|;
block|}
block|}
struct|;
end_struct
begin_struct
DECL|struct|QDeleteLaterCleanup
struct|struct
name|QDeleteLaterCleanup
block|{
DECL|function|cleanup
specifier|static
specifier|inline
name|void
name|cleanup
parameter_list|(
name|QObject
modifier|*
name|o
parameter_list|)
block|{
name|o
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
block|}
block|}
struct|;
end_struct
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
end_ifndef
begin_function
DECL|function|httpProxyCommandsSynchronous
name|void
name|tst_QNetworkReply
operator|::
name|httpProxyCommandsSynchronous
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|responseToSend
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|expectedCommand
argument_list|)
expr_stmt|;
comment|// when using synchronous commands, we need a different event loop for
comment|// the server thread, because the client is never returning to the
comment|// event loop
name|QScopedPointer
argument_list|<
name|QThread
argument_list|,
name|QThreadCleanup
argument_list|>
name|serverThread
argument_list|(
operator|new
name|QThread
argument_list|)
decl_stmt|;
name|QScopedPointer
argument_list|<
name|MiniHttpServer
argument_list|,
name|QDeleteLaterCleanup
argument_list|>
name|proxyServer
argument_list|(
operator|new
name|MiniHttpServer
argument_list|(
name|responseToSend
argument_list|,
literal|false
argument_list|,
name|serverThread
operator|.
name|data
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkProxy
name|proxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpProxy
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|proxyServer
operator|->
name|serverPort
argument_list|()
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
comment|// send synchronous request
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// synchronous
name|manager
operator|.
name|setProxy
argument_list|(
name|QNetworkProxy
argument_list|()
argument_list|)
expr_stmt|;
comment|//qDebug()<< reply->error()<< reply->errorString();
comment|// we don't really care if the request succeeded
comment|// especially since it won't succeed in the HTTPS case
comment|// so just check that the command was correct
name|QString
name|receivedHeader
init|=
name|proxyServer
operator|->
name|receivedData
operator|.
name|left
argument_list|(
name|expectedCommand
operator|.
name|length
argument_list|()
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|receivedHeader
argument_list|,
name|expectedCommand
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|proxyChange
name|void
name|tst_QNetworkReply
operator|::
name|proxyChange
parameter_list|()
block|{
name|ProxyChangeHelper
name|helper
decl_stmt|;
name|MiniHttpServer
name|proxyServer
argument_list|(
literal|"HTTP/1.0 200 OK\r\nProxy-Connection: keep-alive\r\n"
literal|"Content-Length: 1\r\n\r\n1"
argument_list|)
decl_stmt|;
name|QNetworkProxy
name|dummyProxy
argument_list|(
name|QNetworkProxy
operator|::
name|HttpProxy
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|proxyServer
operator|.
name|serverPort
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|req
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|proxyServer
operator|.
name|doClose
operator|=
literal|false
expr_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|dummyProxy
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply1
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|req
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply1
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|helper
argument_list|,
name|SLOT
argument_list|(
name|finishedSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|QNetworkProxy
argument_list|()
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply2
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|req
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply2
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|helper
argument_list|,
name|SLOT
argument_list|(
name|finishedSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
comment|// verify that the replies succeeded
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply1
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply1
operator|->
name|size
argument_list|()
operator|==
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply2
operator|->
name|size
argument_list|()
operator|>
literal|1
argument_list|)
expr_stmt|;
comment|// now try again and get an error
comment|// this verifies that we reuse the already-open connection
name|proxyServer
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|proxyServer
operator|.
name|dataToTransmit
operator|=
literal|"HTTP/1.0 403 Forbidden\r\nProxy-Connection: close\r\n"
literal|"Content-Length: 1\r\n\r\n1"
expr_stmt|;
name|manager
operator|.
name|setProxy
argument_list|(
name|dummyProxy
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply3
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|req
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply3
argument_list|)
operator|==
name|Failure
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|int
argument_list|(
name|reply3
operator|->
name|error
argument_list|()
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !QT_NO_NETWORKPROXY
end_comment
begin_function
DECL|function|authorizationError_data
name|void
name|tst_QNetworkReply
operator|::
name|authorizationError_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"errorSignalCount"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"finishedSignalCount"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"error"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"httpStatusCode"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"httpBody"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"unknown-authorization-method"
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/http-unknown-authentication-method.cgi?401-authorization-required"
operator|<<
literal|1
operator|<<
literal|1
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
operator|<<
literal|401
operator|<<
literal|"authorization required"
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"unknown-proxy-authorization-method"
argument_list|)
operator|<<
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/http-unknown-authentication-method.cgi?407-proxy-authorization-required"
operator|<<
literal|1
operator|<<
literal|1
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|ProxyAuthenticationRequiredError
argument_list|)
operator|<<
literal|407
operator|<<
literal|"authorization required"
expr_stmt|;
block|}
end_function
begin_function
DECL|function|authorizationError
name|void
name|tst_QNetworkReply
operator|::
name|authorizationError
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QSignalSpy
name|errorSpy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|finishedSpy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
comment|// now run the request:
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Failure
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|errorSignalCount
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|errorSpy
operator|.
name|count
argument_list|()
argument_list|,
name|errorSignalCount
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|finishedSignalCount
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|finishedSpy
operator|.
name|count
argument_list|()
argument_list|,
name|finishedSignalCount
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NetworkError
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|httpStatusCode
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
name|httpStatusCode
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|httpBody
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|qint64
argument_list|(
name|reply
operator|->
name|size
argument_list|()
argument_list|)
argument_list|,
name|qint64
argument_list|(
name|httpBody
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|QString
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|)
argument_list|,
name|httpBody
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|httpConnectionCount
name|void
name|tst_QNetworkReply
operator|::
name|httpConnectionCount
parameter_list|()
block|{
name|QTcpServer
name|server
decl_stmt|;
name|QVERIFY
argument_list|(
name|server
operator|.
name|listen
argument_list|()
argument_list|)
expr_stmt|;
name|QCoreApplication
operator|::
name|instance
argument_list|()
operator|->
name|processEvents
argument_list|()
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://127.0.0.1:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
operator|+
literal|"/"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|i
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|reply
operator|->
name|setParent
argument_list|(
operator|&
name|server
argument_list|)
expr_stmt|;
block|}
name|int
name|pendingConnectionCount
init|=
literal|0
decl_stmt|;
name|QTime
name|time
decl_stmt|;
name|time
operator|.
name|start
argument_list|()
expr_stmt|;
while|while
condition|(
name|pendingConnectionCount
operator|<=
literal|20
condition|)
block|{
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|QTcpSocket
modifier|*
name|socket
init|=
name|server
operator|.
name|nextPendingConnection
argument_list|()
decl_stmt|;
while|while
condition|(
name|socket
operator|!=
literal|0
condition|)
block|{
name|pendingConnectionCount
operator|++
expr_stmt|;
name|socket
operator|->
name|setParent
argument_list|(
operator|&
name|server
argument_list|)
expr_stmt|;
name|socket
operator|=
name|server
operator|.
name|nextPendingConnection
argument_list|()
expr_stmt|;
block|}
comment|// at max. wait 10 sec
if|if
condition|(
name|time
operator|.
name|elapsed
argument_list|()
operator|>
literal|10000
condition|)
break|break;
block|}
name|QCOMPARE
argument_list|(
name|pendingConnectionCount
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|httpReUsingConnectionSequential_data
name|void
name|tst_QNetworkReply
operator|::
name|httpReUsingConnectionSequential_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"doDeleteLater"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"deleteLater"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"noDeleteLater"
argument_list|)
operator|<<
literal|false
expr_stmt|;
block|}
end_function
begin_function
DECL|function|httpReUsingConnectionSequential
name|void
name|tst_QNetworkReply
operator|::
name|httpReUsingConnectionSequential
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|doDeleteLater
argument_list|)
expr_stmt|;
name|QByteArray
name|response
argument_list|(
literal|"HTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n"
argument_list|)
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|response
argument_list|)
decl_stmt|;
name|server
operator|.
name|multiple
operator|=
literal|true
expr_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|false
expr_stmt|;
name|QUrl
name|url
decl_stmt|;
name|url
operator|.
name|setScheme
argument_list|(
literal|"http"
argument_list|)
expr_stmt|;
name|url
operator|.
name|setPort
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
expr_stmt|;
name|url
operator|.
name|setHost
argument_list|(
literal|"127.0.0.1"
argument_list|)
expr_stmt|;
comment|// first request
name|QNetworkReply
modifier|*
name|reply1
init|=
name|manager
operator|.
name|get
argument_list|(
name|QNetworkRequest
argument_list|(
name|url
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply1
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply1
operator|->
name|error
argument_list|()
argument_list|)
expr_stmt|;
name|int
name|reply1port
init|=
name|server
operator|.
name|client
operator|->
name|peerPort
argument_list|()
decl_stmt|;
if|if
condition|(
name|doDeleteLater
condition|)
name|reply1
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
comment|// finished received, send the next one
name|QNetworkReply
modifier|*
name|reply2
init|=
name|manager
operator|.
name|get
argument_list|(
name|QNetworkRequest
argument_list|(
name|url
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply2
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply2
operator|->
name|error
argument_list|()
argument_list|)
expr_stmt|;
name|int
name|reply2port
init|=
name|server
operator|.
name|client
operator|->
name|peerPort
argument_list|()
decl_stmt|;
comment|// should still be the same object
name|QVERIFY
argument_list|(
name|reply1port
operator|>
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|server
operator|.
name|totalConnections
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2port
argument_list|,
name|reply1port
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|doDeleteLater
condition|)
name|reply1
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
comment|// only do it if it was not done earlier
name|reply2
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
block|}
end_function
begin_class
DECL|class|HttpReUsingConnectionFromFinishedSlot
class|class
name|HttpReUsingConnectionFromFinishedSlot
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|member|reply1
name|QNetworkReply
modifier|*
name|reply1
decl_stmt|;
DECL|member|reply2
name|QNetworkReply
modifier|*
name|reply2
decl_stmt|;
DECL|member|url
name|QUrl
name|url
decl_stmt|;
DECL|member|manager
name|QNetworkAccessManager
name|manager
decl_stmt|;
public|public
name|slots
public|:
DECL|function|finishedSlot
name|void
name|finishedSlot
parameter_list|()
block|{
name|QVERIFY
argument_list|(
operator|!
name|reply1
operator|->
name|error
argument_list|()
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|doDeleteLater
argument_list|)
expr_stmt|;
if|if
condition|(
name|doDeleteLater
condition|)
block|{
name|reply1
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
name|reply1
operator|=
literal|0
expr_stmt|;
block|}
comment|// kick off 2nd request and exit the loop when it is done
name|reply2
operator|=
name|manager
operator|.
name|get
argument_list|(
name|QNetworkRequest
argument_list|(
name|url
argument_list|)
argument_list|)
expr_stmt|;
name|reply2
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply2
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
class|;
end_class
begin_function
DECL|function|httpReUsingConnectionFromFinishedSlot_data
name|void
name|tst_QNetworkReply
operator|::
name|httpReUsingConnectionFromFinishedSlot_data
parameter_list|()
block|{
name|httpReUsingConnectionSequential_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|httpReUsingConnectionFromFinishedSlot
name|void
name|tst_QNetworkReply
operator|::
name|httpReUsingConnectionFromFinishedSlot
parameter_list|()
block|{
name|QByteArray
name|response
argument_list|(
literal|"HTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n"
argument_list|)
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|response
argument_list|)
decl_stmt|;
name|server
operator|.
name|multiple
operator|=
literal|true
expr_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|false
expr_stmt|;
name|HttpReUsingConnectionFromFinishedSlot
name|helper
decl_stmt|;
name|helper
operator|.
name|reply1
operator|=
literal|0
expr_stmt|;
name|helper
operator|.
name|reply2
operator|=
literal|0
expr_stmt|;
name|helper
operator|.
name|url
operator|.
name|setScheme
argument_list|(
literal|"http"
argument_list|)
expr_stmt|;
name|helper
operator|.
name|url
operator|.
name|setPort
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
expr_stmt|;
name|helper
operator|.
name|url
operator|.
name|setHost
argument_list|(
literal|"127.0.0.1"
argument_list|)
expr_stmt|;
comment|// first request
name|helper
operator|.
name|reply1
operator|=
name|helper
operator|.
name|manager
operator|.
name|get
argument_list|(
name|QNetworkRequest
argument_list|(
name|helper
operator|.
name|url
argument_list|)
argument_list|)
expr_stmt|;
name|helper
operator|.
name|reply1
operator|->
name|setParent
argument_list|(
operator|&
name|helper
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|helper
operator|.
name|reply1
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|helper
argument_list|,
name|SLOT
argument_list|(
name|finishedSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|helper
operator|.
name|reply2
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|helper
operator|.
name|reply2
operator|->
name|error
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|server
operator|.
name|totalConnections
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function
begin_class
DECL|class|HttpRecursiveCreationHelper
class|class
name|HttpRecursiveCreationHelper
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|function|HttpRecursiveCreationHelper
name|HttpRecursiveCreationHelper
parameter_list|()
member_init_list|:
name|QObject
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|requestsStartedCount_finished
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|requestsStartedCount_readyRead
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|requestsFinishedCount
argument_list|(
literal|0
argument_list|)
block|{     }
DECL|member|manager
name|QNetworkAccessManager
name|manager
decl_stmt|;
DECL|member|requestsStartedCount_finished
name|int
name|requestsStartedCount_finished
decl_stmt|;
DECL|member|requestsStartedCount_readyRead
name|int
name|requestsStartedCount_readyRead
decl_stmt|;
DECL|member|requestsFinishedCount
name|int
name|requestsFinishedCount
decl_stmt|;
public|public
name|slots
public|:
DECL|function|finishedSlot
name|void
name|finishedSlot
parameter_list|()
block|{
name|requestsFinishedCount
operator|++
expr_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|qobject_cast
argument_list|<
name|QNetworkReply
operator|*
argument_list|>
argument_list|(
name|sender
argument_list|()
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|error
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|bytesAvailable
argument_list|()
operator|==
literal|27906
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestsFinishedCount
operator|==
literal|60
condition|)
block|{
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|exitLoop
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|requestsStartedCount_finished
operator|<
literal|30
condition|)
block|{
name|startOne
argument_list|()
expr_stmt|;
name|requestsStartedCount_finished
operator|++
expr_stmt|;
block|}
name|reply
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
block|}
DECL|function|readyReadSlot
name|void
name|readyReadSlot
parameter_list|()
block|{
name|QNetworkReply
modifier|*
name|reply
init|=
name|qobject_cast
argument_list|<
name|QNetworkReply
operator|*
argument_list|>
argument_list|(
name|sender
argument_list|()
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|error
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestsStartedCount_readyRead
argument_list|<
literal|30
operator|&&
name|reply
operator|->
name|bytesAvailable
operator|(
operator|)
argument_list|>
literal|27906
operator|/
literal|2
condition|)
block|{
name|startOne
argument_list|()
expr_stmt|;
name|requestsStartedCount_readyRead
operator|++
expr_stmt|;
block|}
block|}
DECL|function|startOne
name|void
name|startOne
parameter_list|()
block|{
name|QUrl
name|url
init|=
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/fluke.gif"
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|reply
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|finishedSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|readyReadSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
class|;
end_class
begin_function
DECL|function|httpRecursiveCreation
name|void
name|tst_QNetworkReply
operator|::
name|httpRecursiveCreation
parameter_list|()
block|{
comment|// this test checks if creation of new requests to the same host properly works
comment|// from readyRead() and finished() signals
name|HttpRecursiveCreationHelper
name|helper
decl_stmt|;
name|helper
operator|.
name|startOne
argument_list|()
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|30
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_SSL
end_ifndef
begin_function
DECL|function|ignoreSslErrorsList_data
name|void
name|tst_QNetworkReply
operator|::
name|ignoreSslErrorsList_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|>
argument_list|(
literal|"expectedSslErrors"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"expectedNetworkError"
argument_list|)
expr_stmt|;
name|QList
argument_list|<
name|QSslError
argument_list|>
name|expectedSslErrors
decl_stmt|;
name|QList
argument_list|<
name|QSslCertificate
argument_list|>
name|certs
init|=
name|QSslCertificate
operator|::
name|fromPath
argument_list|(
name|testDataDir
operator|+
literal|"/certs/qt-test-server-cacert.pem"
argument_list|)
decl_stmt|;
name|QSslError
name|rightError
argument_list|(
name|QSslError
operator|::
name|SelfSignedCertificate
argument_list|,
name|certs
operator|.
name|at
argument_list|(
literal|0
argument_list|)
argument_list|)
decl_stmt|;
name|QSslError
name|wrongError
argument_list|(
name|QSslError
operator|::
name|SelfSignedCertificate
argument_list|)
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"SSL-failure-empty-list"
argument_list|)
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/index.html"
operator|<<
name|expectedSslErrors
operator|<<
name|QNetworkReply
operator|::
name|SslHandshakeFailedError
expr_stmt|;
name|expectedSslErrors
operator|.
name|append
argument_list|(
name|wrongError
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"SSL-failure-wrong-error"
argument_list|)
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/index.html"
operator|<<
name|expectedSslErrors
operator|<<
name|QNetworkReply
operator|::
name|SslHandshakeFailedError
expr_stmt|;
name|expectedSslErrors
operator|.
name|append
argument_list|(
name|rightError
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"allErrorsInExpectedList1"
argument_list|)
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/index.html"
operator|<<
name|expectedSslErrors
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|expectedSslErrors
operator|.
name|removeAll
argument_list|(
name|wrongError
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"allErrorsInExpectedList2"
argument_list|)
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/index.html"
operator|<<
name|expectedSslErrors
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|expectedSslErrors
operator|.
name|removeAll
argument_list|(
name|rightError
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"SSL-failure-empty-list-again"
argument_list|)
operator|<<
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/index.html"
operator|<<
name|expectedSslErrors
operator|<<
name|QNetworkReply
operator|::
name|SslHandshakeFailedError
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ignoreSslErrorsList
name|void
name|tst_QNetworkReply
operator|::
name|ignoreSslErrorsList
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QFETCH
argument_list|(
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|,
name|expectedSslErrors
argument_list|)
expr_stmt|;
name|reply
operator|->
name|ignoreSslErrors
argument_list|(
name|expectedSslErrors
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|expectedNetworkError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|expectedNetworkError
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ignoreSslErrorsListWithSlot_data
name|void
name|tst_QNetworkReply
operator|::
name|ignoreSslErrorsListWithSlot_data
parameter_list|()
block|{
name|ignoreSslErrorsList_data
argument_list|()
expr_stmt|;
block|}
end_function
begin_comment
comment|// this is not a test, just a slot called in the test below
end_comment
begin_function
DECL|function|ignoreSslErrorListSlot
name|void
name|tst_QNetworkReply
operator|::
name|ignoreSslErrorListSlot
parameter_list|(
name|QNetworkReply
modifier|*
name|reply
parameter_list|,
specifier|const
name|QList
argument_list|<
name|QSslError
argument_list|>
modifier|&
parameter_list|)
block|{
name|reply
operator|->
name|ignoreSslErrors
argument_list|(
name|storedExpectedSslErrors
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// do the same as in ignoreSslErrorsList, but ignore the errors in the slot
end_comment
begin_function
DECL|function|ignoreSslErrorsListWithSlot
name|void
name|tst_QNetworkReply
operator|::
name|ignoreSslErrorsListWithSlot
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QFETCH
argument_list|(
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|,
name|expectedSslErrors
argument_list|)
expr_stmt|;
comment|// store the errors to ignore them later in the slot connected below
name|storedExpectedSslErrors
operator|=
name|expectedSslErrors
expr_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|ignoreSslErrorListSlot
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|expectedNetworkError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|expectedNetworkError
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sslConfiguration_data
name|void
name|tst_QNetworkReply
operator|::
name|sslConfiguration_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QSslConfiguration
argument_list|>
argument_list|(
literal|"configuration"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"works"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"empty"
argument_list|)
operator|<<
name|QSslConfiguration
argument_list|()
operator|<<
literal|false
expr_stmt|;
name|QSslConfiguration
name|conf
init|=
name|QSslConfiguration
operator|::
name|defaultConfiguration
argument_list|()
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"default"
argument_list|)
operator|<<
name|conf
operator|<<
literal|false
expr_stmt|;
comment|// does not contain test server cert
name|QList
argument_list|<
name|QSslCertificate
argument_list|>
name|testServerCert
init|=
name|QSslCertificate
operator|::
name|fromPath
argument_list|(
name|testDataDir
operator|+
literal|"/certs/qt-test-server-cacert.pem"
argument_list|)
decl_stmt|;
name|conf
operator|.
name|setCaCertificates
argument_list|(
name|testServerCert
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"set-root-cert"
argument_list|)
operator|<<
name|conf
operator|<<
literal|true
expr_stmt|;
name|conf
operator|.
name|setProtocol
argument_list|(
name|QSsl
operator|::
name|SecureProtocols
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"secure"
argument_list|)
operator|<<
name|conf
operator|<<
literal|true
expr_stmt|;
block|}
end_function
begin_function
DECL|function|encrypted
name|void
name|tst_QNetworkReply
operator|::
name|encrypted
parameter_list|()
block|{
name|qDebug
argument_list|()
operator|<<
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
expr_stmt|;
name|QUrl
name|url
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|reply
operator|->
name|ignoreSslErrors
argument_list|()
expr_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|encrypted
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|spy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|reply
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sslConfiguration
name|void
name|tst_QNetworkReply
operator|::
name|sslConfiguration
parameter_list|()
block|{
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/index.html"
argument_list|)
argument_list|)
decl_stmt|;
name|QFETCH
argument_list|(
name|QSslConfiguration
argument_list|,
name|configuration
argument_list|)
expr_stmt|;
name|request
operator|.
name|setSslConfiguration
argument_list|(
name|configuration
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|works
argument_list|)
expr_stmt|;
name|QNetworkReply
operator|::
name|NetworkError
name|expectedError
init|=
name|works
condition|?
name|QNetworkReply
operator|::
name|NoError
else|:
name|QNetworkReply
operator|::
name|SslHandshakeFailedError
decl_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|expectedError
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|sslSessionSharing_data
name|void
name|tst_QNetworkReply
operator|::
name|sslSessionSharing_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"sessionSharingEnabled"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"enabled"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"disabled"
argument_list|)
operator|<<
literal|false
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sslSessionSharing
name|void
name|tst_QNetworkReply
operator|::
name|sslSessionSharing
parameter_list|()
block|{
name|QString
name|urlString
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|QList
argument_list|<
name|QNetworkReplyPtr
argument_list|>
name|replies
decl_stmt|;
comment|// warm up SSL session cache
name|QNetworkRequest
name|warmupRequest
argument_list|(
name|urlString
argument_list|)
decl_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|sessionSharingEnabled
argument_list|)
expr_stmt|;
name|warmupRequest
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|User
argument_list|,
name|sessionSharingEnabled
argument_list|)
expr_stmt|;
comment|// so we can read it from the slot
if|if
condition|(
operator|!
name|sessionSharingEnabled
condition|)
block|{
name|QSslConfiguration
name|configuration
argument_list|(
name|QSslConfiguration
operator|::
name|defaultConfiguration
argument_list|()
argument_list|)
decl_stmt|;
name|configuration
operator|.
name|setSslOption
argument_list|(
name|QSsl
operator|::
name|SslOptionDisableSessionSharing
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|warmupRequest
operator|.
name|setSslConfiguration
argument_list|(
name|configuration
argument_list|)
expr_stmt|;
block|}
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|.
name|get
argument_list|(
name|warmupRequest
argument_list|)
decl_stmt|;
name|reply
operator|->
name|ignoreSslErrors
argument_list|()
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|reply
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
comment|// now send several requests at the same time, so we open more sockets and reuse the SSL session
for|for
control|(
name|int
name|a
init|=
literal|0
init|;
name|a
operator|<
literal|6
condition|;
name|a
operator|++
control|)
block|{
name|QNetworkRequest
name|request
argument_list|(
name|warmupRequest
argument_list|)
decl_stmt|;
name|replies
operator|.
name|append
argument_list|(
name|QNetworkReplyPtr
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|replies
operator|.
name|at
argument_list|(
name|a
argument_list|)
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|sslSessionSharingHelperSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sslSessionSharingHelperSlot
name|void
name|tst_QNetworkReply
operator|::
name|sslSessionSharingHelperSlot
parameter_list|()
block|{
specifier|static
name|int
name|count
init|=
literal|0
decl_stmt|;
comment|// check that SSL session sharing was used in at least one of the replies
specifier|static
name|bool
name|sslSessionSharingWasUsed
init|=
literal|false
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|qobject_cast
argument_list|<
name|QNetworkReply
operator|*
argument_list|>
argument_list|(
name|sender
argument_list|()
argument_list|)
decl_stmt|;
name|bool
name|sslSessionSharingWasUsedInReply
init|=
name|QSslConfigurationPrivate
operator|::
name|peerSessionWasShared
argument_list|(
name|reply
operator|->
name|sslConfiguration
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|sslSessionSharingWasUsedInReply
condition|)
name|sslSessionSharingWasUsed
operator|=
literal|true
expr_stmt|;
name|QString
name|urlQueryString
init|=
name|reply
operator|->
name|url
argument_list|()
operator|.
name|query
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|6
condition|)
block|{
comment|// all replies have finished
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|exitLoop
argument_list|()
expr_stmt|;
name|bool
name|sessionSharingWasEnabled
init|=
name|reply
operator|->
name|request
argument_list|()
operator|.
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|User
argument_list|)
operator|.
name|toBool
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|sslSessionSharingWasUsed
argument_list|,
name|sessionSharingWasEnabled
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
comment|// reset for next row
name|sslSessionSharingWasUsed
operator|=
literal|false
expr_stmt|;
comment|// reset for next row
block|}
block|}
end_function
begin_function
DECL|function|sslSessionSharingFromPersistentSession_data
name|void
name|tst_QNetworkReply
operator|::
name|sslSessionSharingFromPersistentSession_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"sessionPersistenceEnabled"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"enabled"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"disabled"
argument_list|)
operator|<<
literal|false
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sslSessionSharingFromPersistentSession
name|void
name|tst_QNetworkReply
operator|::
name|sslSessionSharingFromPersistentSession
parameter_list|()
block|{
name|QString
name|urlString
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
comment|// warm up SSL session cache to get a working session
name|QNetworkRequest
name|warmupRequest
argument_list|(
name|urlString
argument_list|)
decl_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|sessionPersistenceEnabled
argument_list|)
expr_stmt|;
if|if
condition|(
name|sessionPersistenceEnabled
condition|)
block|{
name|QSslConfiguration
name|warmupConfiguration
argument_list|(
name|QSslConfiguration
operator|::
name|defaultConfiguration
argument_list|()
argument_list|)
decl_stmt|;
name|warmupConfiguration
operator|.
name|setSslOption
argument_list|(
name|QSsl
operator|::
name|SslOptionDisableSessionPersistence
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|warmupRequest
operator|.
name|setSslConfiguration
argument_list|(
name|warmupConfiguration
argument_list|)
expr_stmt|;
block|}
name|QNetworkReply
modifier|*
name|warmupReply
init|=
name|manager
operator|.
name|get
argument_list|(
name|warmupRequest
argument_list|)
decl_stmt|;
name|warmupReply
operator|->
name|ignoreSslErrors
argument_list|()
expr_stmt|;
name|connect
argument_list|(
name|warmupReply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|warmupReply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QByteArray
name|sslSession
init|=
name|warmupReply
operator|->
name|sslConfiguration
argument_list|()
operator|.
name|sessionTicket
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
operator|!
name|sslSession
operator|.
name|isEmpty
argument_list|()
argument_list|,
name|sessionPersistenceEnabled
argument_list|)
expr_stmt|;
comment|// test server sends a life time hint of 0 (old server) or 300 (new server),
comment|// without session ticket we get -1
name|QList
argument_list|<
name|int
argument_list|>
name|expectedSessionTicketLifeTimeHint
init|=
name|sessionPersistenceEnabled
condition|?
name|QList
argument_list|<
name|int
argument_list|>
argument_list|()
operator|<<
literal|0
operator|<<
literal|300
else|:
name|QList
argument_list|<
name|int
argument_list|>
argument_list|()
operator|<<
operator|-
literal|1
decl_stmt|;
name|QVERIFY2
argument_list|(
name|expectedSessionTicketLifeTimeHint
operator|.
name|contains
argument_list|(
name|warmupReply
operator|->
name|sslConfiguration
argument_list|()
operator|.
name|sessionTicketLifeTimeHint
argument_list|()
argument_list|)
argument_list|,
literal|"server did not send expected session life time hint"
argument_list|)
expr_stmt|;
name|warmupReply
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
comment|// now send another request with a new QNAM and the persisted session,
comment|// to verify it can be resumed without any internal state
name|QNetworkRequest
name|request
argument_list|(
name|warmupRequest
argument_list|)
decl_stmt|;
if|if
condition|(
name|sessionPersistenceEnabled
condition|)
block|{
name|QSslConfiguration
name|configuration
init|=
name|request
operator|.
name|sslConfiguration
argument_list|()
decl_stmt|;
name|configuration
operator|.
name|setSessionTicket
argument_list|(
name|sslSession
argument_list|)
expr_stmt|;
name|request
operator|.
name|setSslConfiguration
argument_list|(
name|configuration
argument_list|)
expr_stmt|;
block|}
name|QNetworkAccessManager
name|newManager
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|newManager
operator|.
name|get
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|reply
operator|->
name|ignoreSslErrors
argument_list|()
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|bool
name|sslSessionSharingWasUsedInReply
init|=
name|QSslConfigurationPrivate
operator|::
name|peerSessionWasShared
argument_list|(
name|reply
operator|->
name|sslConfiguration
argument_list|()
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|sessionPersistenceEnabled
argument_list|,
name|sslSessionSharingWasUsedInReply
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// QT_BUILD_INTERNAL
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// QT_NO_SSL
end_comment
begin_function
DECL|function|getAndThenDeleteObject_data
name|void
name|tst_QNetworkReply
operator|::
name|getAndThenDeleteObject_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"replyFirst"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"delete-reply-first"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"delete-qnam-first"
argument_list|)
operator|<<
literal|false
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getAndThenDeleteObject
name|void
name|tst_QNetworkReply
operator|::
name|getAndThenDeleteObject
parameter_list|()
block|{
name|QSKIP
argument_list|(
literal|"unstable test - reply may be finished too early"
argument_list|)
expr_stmt|;
comment|// yes, this will leak if the testcase fails. I don't care. It must not fail then :P
name|QNetworkAccessManager
modifier|*
name|manager
init|=
operator|new
name|QNetworkAccessManager
argument_list|()
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|->
name|get
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|reply
operator|->
name|setReadBufferSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|reply
operator|->
name|setParent
argument_list|(
operator|(
name|QObject
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|// must be 0 because else it is the manager
name|QTime
name|stopWatch
decl_stmt|;
name|stopWatch
operator|.
name|start
argument_list|()
expr_stmt|;
forever|forever
block|{
name|QCoreApplication
operator|::
name|instance
argument_list|()
operator|->
name|processEvents
argument_list|()
expr_stmt|;
if|if
condition|(
name|reply
operator|->
name|bytesAvailable
argument_list|()
condition|)
break|break;
if|if
condition|(
name|stopWatch
operator|.
name|elapsed
argument_list|()
operator|>=
literal|30000
condition|)
break|break;
block|}
name|QVERIFY
argument_list|(
name|reply
operator|->
name|bytesAvailable
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// must not be finished
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|replyFirst
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyFirst
condition|)
block|{
operator|delete
name|reply
expr_stmt|;
operator|delete
name|manager
expr_stmt|;
block|}
else|else
block|{
operator|delete
name|manager
expr_stmt|;
operator|delete
name|reply
expr_stmt|;
block|}
block|}
end_function
begin_comment
comment|// see https://bugs.webkit.org/show_bug.cgi?id=38935
end_comment
begin_function
DECL|function|symbianOpenCDataUrlCrash
name|void
name|tst_QNetworkReply
operator|::
name|symbianOpenCDataUrlCrash
parameter_list|()
block|{
name|QString
name|requestUrl
argument_list|(
literal|"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAWCAYAAAA1vze2AAAAB3RJTUUH2AUSEgolrgBvVQAAAAlwSFlzAAALEwAACxMBAJqcGAAAAARnQU1BAACxjwv8YQUAAAHlSURBVHja5VbNShxBEK6ZaXtnHTebQPA1gngNmfaeq+QNPIlIXkC9iQdJxJNvEHLN3VkxhxxE8gTmEhAVddXZ6Z3f9Ndriz89/sHmkBQUVVT1fB9d9c3uOERUKTunIdn3HzstxGpYBDS4wZk7TAJj/wlJ90J+jnuygqs8svSj+/rGHBos3rE18XBvfU3no7NzlJfUaY/5whAwl8Lr/WDUv4ODxTMb+P5xLExe5LmO559WqTX/MQR4WZYEAtSePS4pE0qSnuhnRUcBU5Gm2k9XljU4Z26I3NRxBrd80rj2fh+KNE0FY4xevRgTjREvPFpasAK8Xli6MUbbuKw3afAGgSBXozo5u4hkmncAlkl5wx8iMGbdyQjnCFEiEwGiosj1UQA/x2rVddiVoi+l4IxE0PTDnx+mrQBvvnx9cFz3krhVvuhzFn579/aq/n5rW8fbtTqiWhIQZEo17YBvbkxOXNVndnYpTvod7AtiuN2re0+siwcB9oH8VxxrNwQQAhzyRs30n7wTI2HIN2g2QtQwjjhJIQatOq7E8bIVCLwzpl83Lvtvl+NohWWlE8UZTWEMAGCcR77fHKhPnZF5tYie6dfdxCphACmLPM+j8bYfmTryg64kV9Vh3mV8jP0b/4wO/YUPiT/8i0MLf55lSQAAAABJRU5ErkJggg=="
argument_list|)
decl_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromEncoded
argument_list|(
name|requestUrl
operator|.
name|toLatin1
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|req
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|req
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|qint64
argument_list|(
literal|598
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromHttpIntoBuffer_data
name|void
name|tst_QNetworkReply
operator|::
name|getFromHttpIntoBuffer_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"rfc-internal"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// Please note that the whole "zero copy" download buffer API is private right now. Do not use it.
end_comment
begin_function
DECL|function|getFromHttpIntoBuffer
name|void
name|tst_QNetworkReply
operator|::
name|getFromHttpIntoBuffer
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|MaximumDownloadBufferSizeAttribute
argument_list|,
literal|1024
operator|*
literal|128
argument_list|)
expr_stmt|;
comment|// 128 kB
name|QNetworkAccessManager
name|manager
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reference
operator|.
name|bytesAvailable
argument_list|()
argument_list|,
name|reply
operator|->
name|bytesAvailable
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reference
operator|.
name|size
argument_list|()
argument_list|,
name|reply
operator|->
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// Compare the memory buffer
name|QVariant
name|downloadBufferAttribute
init|=
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|DownloadBufferAttribute
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|downloadBufferAttribute
operator|.
name|isValid
argument_list|()
argument_list|)
expr_stmt|;
name|QSharedPointer
argument_list|<
name|char
argument_list|>
name|sharedPointer
init|=
name|downloadBufferAttribute
operator|.
name|value
argument_list|<
name|QSharedPointer
argument_list|<
name|char
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
name|bool
name|memoryComparison
init|=
operator|(
literal|0
operator|==
name|memcmp
argument_list|(
cast|static_cast
argument_list|<
name|void
operator|*
argument_list|>
argument_list|(
name|reference
operator|.
name|readAll
argument_list|()
operator|.
name|data
argument_list|()
argument_list|)
argument_list|,
name|sharedPointer
operator|.
name|data
argument_list|()
argument_list|,
name|reference
operator|.
name|size
argument_list|()
argument_list|)
operator|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|memoryComparison
argument_list|)
expr_stmt|;
comment|// Make sure the normal reading works
name|reference
operator|.
name|seek
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|read
argument_list|(
literal|42
argument_list|)
argument_list|,
name|reference
operator|.
name|read
argument_list|(
literal|42
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|getChar
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reference
operator|.
name|getChar
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|peek
argument_list|(
literal|23
argument_list|)
argument_list|,
name|reference
operator|.
name|peek
argument_list|(
literal|23
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readLine
argument_list|()
argument_list|,
name|reference
operator|.
name|readLine
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reference
operator|.
name|bytesAvailable
argument_list|()
argument_list|,
name|reply
operator|->
name|bytesAvailable
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|reference
operator|.
name|readAll
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|atEnd
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// FIXME we really need to consolidate all those server implementations
end_comment
begin_class
DECL|class|GetFromHttpIntoBuffer2Server
class|class
name|GetFromHttpIntoBuffer2Server
super|:
name|QObject
block|{
name|Q_OBJECT
DECL|member|dataSize
name|qint64
name|dataSize
decl_stmt|;
DECL|member|dataSent
name|qint64
name|dataSent
decl_stmt|;
DECL|member|server
name|QTcpServer
name|server
decl_stmt|;
DECL|member|client
name|QTcpSocket
modifier|*
name|client
decl_stmt|;
DECL|member|serverSendsContentLength
name|bool
name|serverSendsContentLength
decl_stmt|;
DECL|member|chunkedEncoding
name|bool
name|chunkedEncoding
decl_stmt|;
public|public:
DECL|function|GetFromHttpIntoBuffer2Server
name|GetFromHttpIntoBuffer2Server
parameter_list|(
name|qint64
name|ds
parameter_list|,
name|bool
name|sscl
parameter_list|,
name|bool
name|ce
parameter_list|)
member_init_list|:
name|dataSize
argument_list|(
name|ds
argument_list|)
member_init_list|,
name|dataSent
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|client
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|serverSendsContentLength
argument_list|(
name|sscl
argument_list|)
member_init_list|,
name|chunkedEncoding
argument_list|(
name|ce
argument_list|)
block|{
name|server
operator|.
name|listen
argument_list|()
expr_stmt|;
name|connect
argument_list|(
operator|&
name|server
argument_list|,
name|SIGNAL
argument_list|(
name|newConnection
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|newConnectionSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|function|serverPort
name|int
name|serverPort
parameter_list|()
block|{
return|return
name|server
operator|.
name|serverPort
argument_list|()
return|;
block|}
public|public
name|slots
public|:
DECL|function|newConnectionSlot
name|void
name|newConnectionSlot
parameter_list|()
block|{
name|client
operator|=
name|server
operator|.
name|nextPendingConnection
argument_list|()
expr_stmt|;
name|client
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|client
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|readyReadSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|client
argument_list|,
name|SIGNAL
argument_list|(
name|bytesWritten
argument_list|(
name|qint64
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|bytesWrittenSlot
argument_list|(
name|qint64
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|function|readyReadSlot
name|void
name|readyReadSlot
parameter_list|()
block|{
name|client
operator|->
name|readAll
argument_list|()
expr_stmt|;
name|client
operator|->
name|write
argument_list|(
literal|"HTTP/1.0 200 OK\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|serverSendsContentLength
condition|)
name|client
operator|->
name|write
argument_list|(
name|QString
argument_list|(
literal|"Content-Length: "
operator|+
name|QString
operator|::
name|number
argument_list|(
name|dataSize
argument_list|)
operator|+
literal|"\n"
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|chunkedEncoding
condition|)
name|client
operator|->
name|write
argument_list|(
name|QString
argument_list|(
literal|"Transfer-Encoding: chunked\n"
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
expr_stmt|;
name|client
operator|->
name|write
argument_list|(
literal|"Connection: close\n\n"
argument_list|)
expr_stmt|;
block|}
DECL|function|bytesWrittenSlot
name|void
name|bytesWrittenSlot
parameter_list|(
name|qint64
name|amount
parameter_list|)
block|{
name|Q_UNUSED
argument_list|(
name|amount
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataSent
operator|==
name|dataSize
operator|&&
name|client
condition|)
block|{
comment|// close eventually
comment|// chunked encoding: we have to send a last "empty" chunk
if|if
condition|(
name|chunkedEncoding
condition|)
name|client
operator|->
name|write
argument_list|(
name|QString
argument_list|(
literal|"0\r\n\r\n"
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
expr_stmt|;
name|client
operator|->
name|disconnectFromHost
argument_list|()
expr_stmt|;
name|server
operator|.
name|close
argument_list|()
expr_stmt|;
name|client
operator|=
literal|0
expr_stmt|;
return|return;
block|}
comment|// send data
if|if
condition|(
name|client
operator|&&
name|client
operator|->
name|bytesToWrite
argument_list|()
operator|<
literal|100
operator|*
literal|1024
operator|&&
name|dataSent
operator|<
name|dataSize
condition|)
block|{
name|qint64
name|amount
init|=
name|qMin
argument_list|(
name|qint64
argument_list|(
literal|16
operator|*
literal|1024
argument_list|)
argument_list|,
name|dataSize
operator|-
name|dataSent
argument_list|)
decl_stmt|;
name|QByteArray
name|data
argument_list|(
name|amount
argument_list|,
literal|'@'
argument_list|)
decl_stmt|;
if|if
condition|(
name|chunkedEncoding
condition|)
block|{
name|client
operator|->
name|write
argument_list|(
name|QString
argument_list|(
name|QString
argument_list|(
literal|"%1"
argument_list|)
operator|.
name|arg
argument_list|(
name|amount
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
operator|.
name|toUpper
argument_list|()
operator|+
literal|"\r\n"
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
expr_stmt|;
name|client
operator|->
name|write
argument_list|(
name|data
operator|.
name|constData
argument_list|()
argument_list|,
name|amount
argument_list|)
expr_stmt|;
name|client
operator|->
name|write
argument_list|(
name|QString
argument_list|(
literal|"\r\n"
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|client
operator|->
name|write
argument_list|(
name|data
operator|.
name|constData
argument_list|()
argument_list|,
name|amount
argument_list|)
expr_stmt|;
block|}
name|dataSent
operator|+=
name|amount
expr_stmt|;
block|}
block|}
block|}
class|;
end_class
begin_class
DECL|class|GetFromHttpIntoBuffer2Client
class|class
name|GetFromHttpIntoBuffer2Client
super|:
name|QObject
block|{
name|Q_OBJECT
private|private:
DECL|member|useDownloadBuffer
name|bool
name|useDownloadBuffer
decl_stmt|;
DECL|member|reply
name|QNetworkReply
modifier|*
name|reply
decl_stmt|;
DECL|member|uploadSize
name|qint64
name|uploadSize
decl_stmt|;
DECL|member|bytesAvailableList
name|QList
argument_list|<
name|qint64
argument_list|>
name|bytesAvailableList
decl_stmt|;
public|public:
DECL|function|GetFromHttpIntoBuffer2Client
name|GetFromHttpIntoBuffer2Client
parameter_list|(
name|QNetworkReply
modifier|*
name|reply
parameter_list|,
name|bool
name|useDownloadBuffer
parameter_list|,
name|qint64
name|uploadSize
parameter_list|)
member_init_list|:
name|useDownloadBuffer
argument_list|(
name|useDownloadBuffer
argument_list|)
member_init_list|,
name|reply
argument_list|(
name|reply
argument_list|)
member_init_list|,
name|uploadSize
argument_list|(
name|uploadSize
argument_list|)
block|{
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|metaDataChanged
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|metaDataChangedSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|readyReadSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|finishedSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
public|public
name|slots
public|:
DECL|function|metaDataChangedSlot
name|void
name|metaDataChangedSlot
parameter_list|()
block|{
if|if
condition|(
name|useDownloadBuffer
condition|)
block|{
name|QSharedPointer
argument_list|<
name|char
argument_list|>
name|sharedPointer
init|=
name|qvariant_cast
argument_list|<
name|QSharedPointer
argument_list|<
name|char
argument_list|>
argument_list|>
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|DownloadBufferAttribute
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|sharedPointer
operator|.
name|isNull
argument_list|()
argument_list|)
expr_stmt|;
comment|// It will be 0 if it failed
block|}
comment|// metaDataChanged needs to come before everything else
name|QVERIFY
argument_list|(
name|bytesAvailableList
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|function|readyReadSlot
name|void
name|readyReadSlot
parameter_list|()
block|{
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|qint64
name|bytesAvailable
init|=
name|reply
operator|->
name|bytesAvailable
argument_list|()
decl_stmt|;
comment|// bytesAvailable must never be 0
name|QVERIFY
argument_list|(
name|bytesAvailable
operator|!=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytesAvailableList
operator|.
name|length
argument_list|()
operator|<
literal|5
condition|)
block|{
comment|// We assume that the first few times the bytes available must be less than the complete size, e.g.
comment|// the bytesAvailable() function works correctly in case of a downloadBuffer.
name|QVERIFY
argument_list|(
name|bytesAvailable
operator|<
name|uploadSize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bytesAvailableList
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// Also check that the same bytesAvailable is not coming twice in a row
name|QVERIFY
argument_list|(
name|bytesAvailableList
operator|.
name|last
argument_list|()
operator|!=
name|bytesAvailable
argument_list|)
expr_stmt|;
block|}
name|bytesAvailableList
operator|.
name|append
argument_list|(
name|bytesAvailable
argument_list|)
expr_stmt|;
comment|// Add bytesAvailable to a list an parse
block|}
DECL|function|finishedSlot
name|void
name|finishedSlot
parameter_list|()
block|{
comment|// We should have already received all readyRead
name|QVERIFY
argument_list|(
operator|!
name|bytesAvailableList
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|bytesAvailableList
operator|.
name|last
argument_list|()
operator|==
name|uploadSize
argument_list|)
expr_stmt|;
block|}
block|}
class|;
end_class
begin_function
DECL|function|getFromHttpIntoBuffer2_data
name|void
name|tst_QNetworkReply
operator|::
name|getFromHttpIntoBuffer2_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"useDownloadBuffer"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"use-download-buffer"
argument_list|)
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"do-not-use-download-buffer"
argument_list|)
operator|<<
literal|false
expr_stmt|;
block|}
end_function
begin_comment
comment|// This test checks mostly that signal emissions are in correct order
end_comment
begin_comment
comment|// Please note that the whole "zero copy" download buffer API is private right now. Do not use it.
end_comment
begin_function
DECL|function|getFromHttpIntoBuffer2
name|void
name|tst_QNetworkReply
operator|::
name|getFromHttpIntoBuffer2
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|useDownloadBuffer
argument_list|)
expr_stmt|;
comment|// On my Linux Desktop the results are already visible with 128 kB, however we use this to have good results.
if|#
directive|if
name|defined
argument_list|(
name|Q_OS_WINCE_WM
argument_list|)
comment|// Show some mercy to non-desktop platform/s
enum|enum
block|{
name|UploadSize
init|=
literal|4
operator|*
literal|1024
operator|*
literal|1024
block|}
enum|;
comment|// 4 MB
else|#
directive|else
enum|enum
block|{
name|UploadSize
init|=
literal|32
operator|*
literal|1024
operator|*
literal|1024
block|}
enum|;
comment|// 32 MB
endif|#
directive|endif
name|GetFromHttpIntoBuffer2Server
name|server
argument_list|(
name|UploadSize
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://127.0.0.1:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
operator|+
literal|"/?bare=1"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|useDownloadBuffer
condition|)
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|MaximumDownloadBufferSizeAttribute
argument_list|,
literal|1024
operator|*
literal|1024
operator|*
literal|128
argument_list|)
expr_stmt|;
comment|// 128 MB is max allowed
name|QNetworkAccessManager
name|manager
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|GetFromHttpIntoBuffer2Client
name|client
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|useDownloadBuffer
argument_list|,
name|UploadSize
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|40
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|getFromHttpIntoBufferCanReadLine
name|void
name|tst_QNetworkReply
operator|::
name|getFromHttpIntoBufferCanReadLine
parameter_list|()
block|{
name|QString
name|header
argument_list|(
literal|"HTTP/1.0 200 OK\r\nContent-Length: 7\r\n\r\nxxx\nxxx"
argument_list|)
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|header
operator|.
name|toLatin1
argument_list|()
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|MaximumDownloadBufferSizeAttribute
argument_list|,
literal|1024
operator|*
literal|1024
operator|*
literal|128
argument_list|)
expr_stmt|;
comment|// 128 MB is max allowed
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|canReadLine
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|read
argument_list|(
literal|1
argument_list|)
argument_list|,
name|QByteArray
argument_list|(
literal|"x"
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|canReadLine
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|read
argument_list|(
literal|3
argument_list|)
argument_list|,
name|QByteArray
argument_list|(
literal|"xx\n"
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|canReadLine
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"xxx"
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|canReadLine
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// Is handled somewhere else too, introduced this special test to have it more accessible
end_comment
begin_function
DECL|function|ioGetFromHttpWithoutContentLength
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpWithoutContentLength
parameter_list|()
block|{
name|QByteArray
name|dataToSend
argument_list|(
literal|"HTTP/1.0 200 OK\r\n\r\nHALLO! 123!"
argument_list|)
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|dataToSend
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|error
argument_list|()
operator|==
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// Is handled somewhere else too, introduced this special test to have it more accessible
end_comment
begin_function
DECL|function|ioGetFromHttpBrokenChunkedEncoding
name|void
name|tst_QNetworkReply
operator|::
name|ioGetFromHttpBrokenChunkedEncoding
parameter_list|()
block|{
comment|// This is wrong chunked encoding because of the X. What actually has to follow is \r\n
comment|// and then the declaration of the final 0 chunk
name|QByteArray
name|dataToSend
argument_list|(
literal|"HTTP/1.0 200 OK\r\nTransfer-Encoding: chunked\r\n\r\n3\r\nABCX"
argument_list|)
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|dataToSend
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|false
expr_stmt|;
comment|// FIXME
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QEXPECT_FAIL
argument_list|(
literal|0
argument_list|,
literal|"We should close the socket and not just do nothing"
argument_list|,
name|Continue
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QEXPECT_FAIL
argument_list|(
literal|0
argument_list|,
literal|"We should close the socket and not just do nothing"
argument_list|,
name|Continue
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// TODO:
end_comment
begin_comment
comment|// Prepare a gzip that has one chunk that expands to the size mentioned in the bugreport.
end_comment
begin_comment
comment|// Then have a custom HTTP server that waits after this chunk so the returning gets
end_comment
begin_comment
comment|// triggered.
end_comment
begin_function
DECL|function|qtbug12908compressedHttpReply
name|void
name|tst_QNetworkReply
operator|::
name|qtbug12908compressedHttpReply
parameter_list|()
block|{
name|QString
name|header
argument_list|(
literal|"HTTP/1.0 200 OK\r\nContent-Encoding: gzip\r\nContent-Length: 63\r\n\r\n"
argument_list|)
decl_stmt|;
comment|// dd if=/dev/zero of=qtbug-12908 bs=16384  count=1&& gzip qtbug-12908&& base64 -w 0 qtbug-12908.gz
name|QString
name|encodedFile
argument_list|(
literal|"H4sICDdDaUwAA3F0YnVnLTEyOTA4AO3BMQEAAADCoPVPbQwfoAAAAAAAAAAAAAAAAAAAAIC3AYbSVKsAQAAA"
argument_list|)
decl_stmt|;
name|QByteArray
name|decodedFile
init|=
name|QByteArray
operator|::
name|fromBase64
argument_list|(
name|encodedFile
operator|.
name|toLatin1
argument_list|()
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|decodedFile
operator|.
name|size
argument_list|()
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|header
operator|.
name|toLatin1
argument_list|()
operator|+
name|decodedFile
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
literal|16384
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|16384
argument_list|,
literal|'\0'
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|compressedHttpReplyBrokenGzip
name|void
name|tst_QNetworkReply
operator|::
name|compressedHttpReplyBrokenGzip
parameter_list|()
block|{
name|QString
name|header
argument_list|(
literal|"HTTP/1.0 200 OK\r\nContent-Encoding: gzip\r\nContent-Length: 63\r\n\r\n"
argument_list|)
decl_stmt|;
comment|// dd if=/dev/zero of=qtbug-12908 bs=16384  count=1&& gzip qtbug-12908&& base64 -w 0 qtbug-12908.gz
comment|// Then change "BMQ" to "BMX"
name|QString
name|encodedFile
argument_list|(
literal|"H4sICDdDaUwAA3F0YnVnLTEyOTA4AO3BMXEAAADCoPVPbQwfoAAAAAAAAAAAAAAAAAAAAIC3AYbSVKsAQAAA"
argument_list|)
decl_stmt|;
name|QByteArray
name|decodedFile
init|=
name|QByteArray
operator|::
name|fromBase64
argument_list|(
name|encodedFile
operator|.
name|toLatin1
argument_list|()
argument_list|)
decl_stmt|;
name|QCOMPARE
argument_list|(
name|decodedFile
operator|.
name|size
argument_list|()
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|header
operator|.
name|toLatin1
argument_list|()
operator|+
name|decodedFile
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Failure
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|ProtocolFailure
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// TODO add similar test for FTP
end_comment
begin_function
DECL|function|getFromUnreachableIp
name|void
name|tst_QNetworkReply
operator|::
name|getFromUnreachableIp
parameter_list|()
block|{
name|QNetworkAccessManager
name|manager
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://255.255.255.255/42/23/narf/narf/narf"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Failure
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|error
argument_list|()
operator|!=
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|qtbug4121unknownAuthentication
name|void
name|tst_QNetworkReply
operator|::
name|qtbug4121unknownAuthentication
parameter_list|()
block|{
name|MiniHttpServer
name|server
argument_list|(
name|QByteArray
argument_list|(
literal|"HTTP/1.1 401 bla\r\nWWW-Authenticate: crap\r\nContent-Length: 0\r\n\r\n"
argument_list|)
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|false
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkAccessManager
name|manager
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|authSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|finishedSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|(
name|QNetworkReply
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|errorSpy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|finishedSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|errorSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_NETWORKPROXY
end_ifndef
begin_function
DECL|function|authenticationCacheAfterCancel_data
name|void
name|tst_QNetworkReply
operator|::
name|authenticationCacheAfterCancel_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkProxy
argument_list|>
argument_list|(
literal|"proxy"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"proxyAuth"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|proxies
operator|.
name|count
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http"
operator|+
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|tag
argument_list|)
operator|<<
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|proxy
operator|<<
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|requiresAuthentication
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth/rfc3252.txt"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https"
operator|+
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|tag
argument_list|)
operator|<<
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|proxy
operator|<<
name|proxies
operator|.
name|at
argument_list|(
name|i
argument_list|)
operator|.
name|requiresAuthentication
operator|<<
name|QUrl
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth/rfc3252.txt"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function
begin_class
DECL|class|AuthenticationCacheHelper
class|class
name|AuthenticationCacheHelper
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|function|AuthenticationCacheHelper
name|AuthenticationCacheHelper
parameter_list|()
block|{}
public|public
name|slots
public|:
DECL|function|proxyAuthenticationRequired
name|void
name|proxyAuthenticationRequired
parameter_list|(
specifier|const
name|QNetworkProxy
modifier|&
parameter_list|,
name|QAuthenticator
modifier|*
name|auth
parameter_list|)
block|{
if|if
condition|(
operator|!
name|proxyPassword
operator|.
name|isNull
argument_list|()
condition|)
block|{
name|auth
operator|->
name|setUser
argument_list|(
name|proxyUserName
argument_list|)
expr_stmt|;
name|auth
operator|->
name|setPassword
argument_list|(
name|proxyPassword
argument_list|)
expr_stmt|;
comment|//clear credentials, if they are asked again, they were bad
name|proxyUserName
operator|.
name|clear
argument_list|()
expr_stmt|;
name|proxyPassword
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
block|}
DECL|function|authenticationRequired
name|void
name|authenticationRequired
parameter_list|(
name|QNetworkReply
modifier|*
parameter_list|,
name|QAuthenticator
modifier|*
name|auth
parameter_list|)
block|{
if|if
condition|(
operator|!
name|httpPassword
operator|.
name|isNull
argument_list|()
condition|)
block|{
name|auth
operator|->
name|setUser
argument_list|(
name|httpUserName
argument_list|)
expr_stmt|;
name|auth
operator|->
name|setPassword
argument_list|(
name|httpPassword
argument_list|)
expr_stmt|;
comment|//clear credentials, if they are asked again, they were bad
name|httpUserName
operator|.
name|clear
argument_list|()
expr_stmt|;
name|httpPassword
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
block|}
public|public:
DECL|member|httpUserName
name|QString
name|httpUserName
decl_stmt|;
DECL|member|httpPassword
name|QString
name|httpPassword
decl_stmt|;
DECL|member|proxyUserName
name|QString
name|proxyUserName
decl_stmt|;
DECL|member|proxyPassword
name|QString
name|proxyPassword
decl_stmt|;
block|}
class|;
end_class
begin_comment
comment|/* Purpose of this test is to check credentials are cached correctly.  - If user cancels authentication dialog (i.e. nothing is set to the QAuthenticator by the callback) then this is not cached  - if user supplies a wrong password, then this is not cached  - if user supplies a correct user/password combination then this is cached   Test is checking both the proxyAuthenticationRequired and authenticationRequired signals.  */
end_comment
begin_function
DECL|function|authenticationCacheAfterCancel
name|void
name|tst_QNetworkReply
operator|::
name|authenticationCacheAfterCancel
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QNetworkProxy
argument_list|,
name|proxy
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|proxyAuth
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QNetworkAccessManager
name|manager
decl_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|manager
operator|.
name|setProxy
argument_list|(
name|proxy
argument_list|)
expr_stmt|;
name|QSignalSpy
name|authSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|proxyAuthSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|AuthenticationCacheHelper
name|helper
decl_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
operator|&
name|helper
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
operator|&
name|helper
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
if|if
condition|(
name|proxyAuth
condition|)
block|{
comment|//should fail due to no credentials
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|ProxyAuthenticationRequiredError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|proxyAuthSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|proxyAuthSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
comment|//should fail due to bad credentials
name|helper
operator|.
name|proxyUserName
operator|=
literal|"qsockstest"
expr_stmt|;
name|helper
operator|.
name|proxyPassword
operator|=
literal|"badpassword"
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|->
name|error
argument_list|()
operator|==
name|QNetworkReply
operator|::
name|HostNotFoundError
condition|)
name|QSKIP
argument_list|(
literal|"skip because of quirk in the old test server"
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|ProxyAuthenticationRequiredError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|proxyAuthSpy
operator|.
name|count
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
name|proxyAuthSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
comment|//QTBUG-23136 workaround
if|if
condition|(
name|proxy
operator|.
name|port
argument_list|()
operator|==
literal|1081
condition|)
block|{
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
name|QNetworkAccessManagerPrivate
operator|::
name|clearCache
argument_list|(
operator|&
name|manager
argument_list|)
expr_stmt|;
else|#
directive|else
return|return;
comment|//XFAIL result above
endif|#
directive|endif
block|}
comment|//next proxy auth should succeed, due to correct credentials
name|helper
operator|.
name|proxyUserName
operator|=
literal|"qsockstest"
expr_stmt|;
name|helper
operator|.
name|proxyPassword
operator|=
literal|"password"
expr_stmt|;
block|}
comment|//should fail due to no credentials
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
name|authSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|proxyAuth
condition|)
block|{
name|QVERIFY
argument_list|(
name|proxyAuthSpy
operator|.
name|count
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
name|proxyAuthSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
comment|//should fail due to bad credentials
name|helper
operator|.
name|httpUserName
operator|=
literal|"baduser"
expr_stmt|;
name|helper
operator|.
name|httpPassword
operator|=
literal|"badpassword"
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
name|authSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|proxyAuth
condition|)
block|{
comment|//should be supplied from cache
name|QCOMPARE
argument_list|(
name|proxyAuthSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|proxyAuthSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
comment|//next auth should succeed, due to correct credentials
name|helper
operator|.
name|httpUserName
operator|=
literal|"httptest"
expr_stmt|;
name|helper
operator|.
name|httpPassword
operator|=
literal|"httptest"
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
name|authSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|proxyAuth
condition|)
block|{
comment|//should be supplied from cache
name|QCOMPARE
argument_list|(
name|proxyAuthSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|proxyAuthSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
comment|//next auth should use cached credentials
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
comment|//should be supplied from cache
name|QCOMPARE
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|authSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|proxyAuth
condition|)
block|{
comment|//should be supplied from cache
name|QCOMPARE
argument_list|(
name|proxyAuthSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|proxyAuthSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|authenticationWithDifferentRealm
name|void
name|tst_QNetworkReply
operator|::
name|authenticationWithDifferentRealm
parameter_list|()
block|{
name|AuthenticationCacheHelper
name|helper
decl_stmt|;
name|QNetworkAccessManager
name|manager
decl_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
operator|&
name|helper
argument_list|,
name|SLOT
argument_list|(
name|proxyAuthenticationRequired
argument_list|(
name|QNetworkProxy
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|,
operator|&
name|helper
argument_list|,
name|SLOT
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|helper
operator|.
name|httpUserName
operator|=
literal|"httptest"
expr_stmt|;
name|helper
operator|.
name|httpPassword
operator|=
literal|"httptest"
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfcs-auth/rfc3252.txt"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|helper
operator|.
name|httpUserName
operator|=
literal|"httptest"
expr_stmt|;
name|helper
operator|.
name|httpPassword
operator|=
literal|"httptest"
expr_stmt|;
name|request
operator|.
name|setUrl
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/auth-digest/"
argument_list|)
argument_list|)
expr_stmt|;
name|reply
operator|=
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !QT_NO_NETWORKPROXY
end_comment
begin_class
DECL|class|QtBug13431Helper
class|class
name|QtBug13431Helper
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|member|m_reply
name|QNetworkReply
modifier|*
name|m_reply
decl_stmt|;
DECL|member|m_dlTimer
name|QTimer
name|m_dlTimer
decl_stmt|;
public|public
name|slots
public|:
DECL|function|replyFinished
name|void
name|replyFinished
parameter_list|(
name|QNetworkReply
modifier|*
parameter_list|)
block|{
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|exitLoop
argument_list|()
expr_stmt|;
block|}
DECL|function|onReadAndReschedule
name|void
name|onReadAndReschedule
parameter_list|()
block|{
specifier|const
name|qint64
name|bytesReceived
init|=
name|m_reply
operator|->
name|bytesAvailable
argument_list|()
decl_stmt|;
if|if
condition|(
name|bytesReceived
operator|&&
name|m_reply
operator|->
name|readBufferSize
argument_list|()
condition|)
block|{
name|QByteArray
name|data
init|=
name|m_reply
operator|->
name|read
argument_list|(
name|bytesReceived
argument_list|)
decl_stmt|;
comment|// reschedule read
specifier|const
name|int
name|millisecDelay
init|=
cast|static_cast
argument_list|<
name|int
argument_list|>
argument_list|(
name|bytesReceived
operator|*
literal|1000
operator|/
name|m_reply
operator|->
name|readBufferSize
argument_list|()
argument_list|)
decl_stmt|;
name|m_dlTimer
operator|.
name|start
argument_list|(
name|millisecDelay
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// reschedule read
name|m_dlTimer
operator|.
name|start
argument_list|(
literal|200
argument_list|)
expr_stmt|;
block|}
block|}
block|}
class|;
end_class
begin_function
DECL|function|qtbug13431replyThrottling
name|void
name|tst_QNetworkReply
operator|::
name|qtbug13431replyThrottling
parameter_list|()
block|{
name|QtBug13431Helper
name|helper
decl_stmt|;
name|QNetworkAccessManager
name|nam
decl_stmt|;
name|connect
argument_list|(
operator|&
name|nam
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|(
name|QNetworkReply
operator|*
argument_list|)
argument_list|)
argument_list|,
operator|&
name|helper
argument_list|,
name|SLOT
argument_list|(
name|replyFinished
argument_list|(
name|QNetworkReply
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|// Download a bigger file
name|QNetworkRequest
name|netRequest
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
argument_list|)
argument_list|)
decl_stmt|;
name|helper
operator|.
name|m_reply
operator|=
name|nam
operator|.
name|get
argument_list|(
name|netRequest
argument_list|)
expr_stmt|;
comment|// Set the throttle
name|helper
operator|.
name|m_reply
operator|->
name|setReadBufferSize
argument_list|(
literal|36000
argument_list|)
expr_stmt|;
comment|// Schedule a timer that tries to read
name|connect
argument_list|(
operator|&
name|helper
operator|.
name|m_dlTimer
argument_list|,
name|SIGNAL
argument_list|(
name|timeout
argument_list|()
argument_list|)
argument_list|,
operator|&
name|helper
argument_list|,
name|SLOT
argument_list|(
name|onReadAndReschedule
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|helper
operator|.
name|m_dlTimer
operator|.
name|setSingleShot
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|helper
operator|.
name|m_dlTimer
operator|.
name|start
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|30
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|helper
operator|.
name|m_reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|helper
operator|.
name|m_reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|httpWithNoCredentialUsage
name|void
name|tst_QNetworkReply
operator|::
name|httpWithNoCredentialUsage
parameter_list|()
block|{
name|QNetworkAccessManager
name|manager
decl_stmt|;
name|QSignalSpy
name|authSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|authenticationRequired
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QAuthenticator
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|finishedSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|(
name|QNetworkReply
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
comment|// Get with credentials, to preload authentication cache
block|{
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://httptest:httptest@"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/protected/cgi-bin/md5sum.cgi"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
comment|// credentials in URL, so don't expect authentication signal
name|QCOMPARE
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|finishedSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|finishedSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
comment|// Get with cached credentials (normal usage)
block|{
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/protected/cgi-bin/md5sum.cgi"
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
comment|// credentials in cache, so don't expect authentication signal
name|QCOMPARE
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|finishedSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|finishedSpy
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
comment|// Do not use cached credentials (webkit cross origin usage)
block|{
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/protected/cgi-bin/md5sum.cgi"
argument_list|)
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|AuthenticationReuseAttribute
argument_list|,
name|QNetworkRequest
operator|::
name|Manual
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|errorSpy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
comment|// We check if authenticationRequired was emitted, however we do not anything in it so it should be 401
name|QCOMPARE
argument_list|(
name|authSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|finishedSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|errorSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|qtbug15311doubleContentLength
name|void
name|tst_QNetworkReply
operator|::
name|qtbug15311doubleContentLength
parameter_list|()
block|{
name|QByteArray
name|response
argument_list|(
literal|"HTTP/1.0 200 OK\r\nContent-Length: 3\r\nServer: bogus\r\nContent-Length: 3\r\n\r\nABC"
argument_list|)
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|response
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|qint64
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|rawHeader
argument_list|(
literal|"Content-length"
argument_list|)
argument_list|,
name|QByteArray
argument_list|(
literal|"3, 3"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"ABC"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|qtbug18232gzipContentLengthZero
name|void
name|tst_QNetworkReply
operator|::
name|qtbug18232gzipContentLengthZero
parameter_list|()
block|{
name|QByteArray
name|response
argument_list|(
literal|"HTTP/1.0 200 OK\r\nContent-Encoding: gzip\r\nContent-Length: 0\r\n\r\n"
argument_list|)
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|response
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|qint64
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// Reproduced a crash in QHttpNetworkReplyPrivate::gunzipBodyPartiallyEnd
end_comment
begin_comment
comment|// where zlib inflateEnd was called for uninitialized zlib stream
end_comment
begin_function
DECL|function|qtbug22660gzipNoContentLengthEmptyContent
name|void
name|tst_QNetworkReply
operator|::
name|qtbug22660gzipNoContentLengthEmptyContent
parameter_list|()
block|{
comment|// Response with no Content-Length in header and empty content
name|QByteArray
name|response
argument_list|(
literal|"HTTP/1.0 200 OK\r\nContent-Encoding: gzip\r\n\r\n"
argument_list|)
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|response
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|isValid
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_class
DECL|class|QtBug27161Helper
class|class
name|QtBug27161Helper
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|function|QtBug27161Helper
name|QtBug27161Helper
parameter_list|(
name|MiniHttpServer
modifier|&
name|server
parameter_list|,
specifier|const
name|QByteArray
modifier|&
name|data
parameter_list|)
member_init_list|:
name|m_server
argument_list|(
name|server
argument_list|)
member_init_list|,
name|m_data
argument_list|(
name|data
argument_list|)
block|{
name|connect
argument_list|(
operator|&
name|m_server
argument_list|,
name|SIGNAL
argument_list|(
name|newConnection
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|newConnectionSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
public|public
name|slots
public|:
DECL|function|newConnectionSlot
name|void
name|newConnectionSlot
parameter_list|()
block|{
name|connect
argument_list|(
name|m_server
operator|.
name|client
argument_list|,
name|SIGNAL
argument_list|(
name|bytesWritten
argument_list|(
name|qint64
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|bytesWrittenSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|function|bytesWrittenSlot
name|void
name|bytesWrittenSlot
parameter_list|()
block|{
name|disconnect
argument_list|(
name|m_server
operator|.
name|client
argument_list|,
name|SIGNAL
argument_list|(
name|bytesWritten
argument_list|(
name|qint64
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|bytesWrittenSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|m_Timer
operator|.
name|singleShot
argument_list|(
literal|100
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|timeoutSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|function|timeoutSlot
name|void
name|timeoutSlot
parameter_list|()
block|{
name|m_server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
comment|// we need to emulate the bytesWrittenSlot call if the data is empty.
if|if
condition|(
name|m_data
operator|.
name|size
argument_list|()
operator|==
literal|0
condition|)
name|QMetaObject
operator|::
name|invokeMethod
argument_list|(
operator|&
name|m_server
argument_list|,
literal|"bytesWrittenSlot"
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
else|else
name|m_server
operator|.
name|client
operator|->
name|write
argument_list|(
name|m_data
argument_list|)
expr_stmt|;
block|}
private|private:
DECL|member|m_server
name|MiniHttpServer
modifier|&
name|m_server
decl_stmt|;
DECL|member|m_data
name|QByteArray
name|m_data
decl_stmt|;
DECL|member|m_Timer
name|QTimer
name|m_Timer
decl_stmt|;
block|}
class|;
end_class
begin_function
DECL|function|qtbug27161httpHeaderMayBeDamaged_data
name|void
name|tst_QNetworkReply
operator|::
name|qtbug27161httpHeaderMayBeDamaged_data
parameter_list|()
block|{
name|QByteArray
name|response
argument_list|(
literal|"HTTP/1.0 200 OK\r\nServer: bogus\r\nContent-Length: 3\r\n\r\nABC"
argument_list|)
decl_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"firstPacket"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QByteArray
argument_list|>
argument_list|(
literal|"secondPacket"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|response
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|QByteArray
name|dataTag
argument_list|(
literal|"Iteration: "
argument_list|)
decl_stmt|;
name|dataTag
operator|.
name|append
argument_list|(
name|QByteArray
operator|::
name|number
argument_list|(
name|i
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
name|dataTag
operator|.
name|constData
argument_list|()
argument_list|)
operator|<<
name|response
operator|.
name|left
argument_list|(
name|i
argument_list|)
operator|<<
name|response
operator|.
name|mid
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_comment
comment|/*  * Purpose of this test is to check whether a content from server is parsed correctly  * if it is split into two parts.  */
end_comment
begin_function
DECL|function|qtbug27161httpHeaderMayBeDamaged
name|void
name|tst_QNetworkReply
operator|::
name|qtbug27161httpHeaderMayBeDamaged
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|firstPacket
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QByteArray
argument_list|,
name|secondPacket
argument_list|)
expr_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|firstPacket
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|false
expr_stmt|;
name|QtBug27161Helper
name|helper
argument_list|(
name|server
argument_list|,
name|secondPacket
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|size
argument_list|()
argument_list|,
name|qint64
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|qint64
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|rawHeader
argument_list|(
literal|"Content-length"
argument_list|)
argument_list|,
name|QByteArray
argument_list|(
literal|"3"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|rawHeader
argument_list|(
literal|"Server"
argument_list|)
argument_list|,
name|QByteArray
argument_list|(
literal|"bogus"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"ABC"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|qtbug28035browserDoesNotLoadQtProjectOrgCorrectly
name|void
name|tst_QNetworkReply
operator|::
name|qtbug28035browserDoesNotLoadQtProjectOrgCorrectly
parameter_list|()
block|{
name|QByteArray
name|getReply
init|=
literal|"HTTP/1.1 200\r\n"
literal|"Connection: keep-alive\r\n"
literal|"Content-Type: text/plain\r\n"
literal|"Cache-control: max-age = 6000\r\n"
literal|"\r\n"
literal|"GET"
decl_stmt|;
name|QByteArray
name|postReply
init|=
literal|"HTTP/1.1 200\r\n"
literal|"Connection: keep-alive\r\n"
literal|"Content-Type: text/plain\r\n"
literal|"Cache-control: max-age = 6000\r\n"
literal|"Content-length: 4\r\n"
literal|"\r\n"
literal|"POST"
decl_stmt|;
name|QByteArray
name|putReply
init|=
literal|"HTTP/1.1 201\r\n"
literal|"Connection: keep-alive\r\n"
literal|"Content-Type: text/plain\r\n"
literal|"Cache-control: max-age = 6000\r\n"
literal|"\r\n"
decl_stmt|;
name|QByteArray
name|postData
init|=
literal|"ACT=100"
decl_stmt|;
name|QTemporaryDir
name|tempDir
argument_list|(
name|QDir
operator|::
name|tempPath
argument_list|()
operator|+
literal|"/tmp_cache_28035"
argument_list|)
decl_stmt|;
name|tempDir
operator|.
name|setAutoRemove
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|QNetworkDiskCache
modifier|*
name|diskCache
init|=
operator|new
name|QNetworkDiskCache
argument_list|()
decl_stmt|;
name|diskCache
operator|->
name|setCacheDirectory
argument_list|(
name|tempDir
operator|.
name|path
argument_list|()
argument_list|)
expr_stmt|;
name|manager
operator|.
name|setCache
argument_list|(
name|diskCache
argument_list|)
expr_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|getReply
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"GET"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SourceIsFromCacheAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|server
operator|.
name|setDataToTransmit
argument_list|(
name|getReply
argument_list|)
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"GET"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SourceIsFromCacheAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|server
operator|.
name|setDataToTransmit
argument_list|(
name|postReply
argument_list|)
expr_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Content-Type"
argument_list|,
literal|"text/plain"
argument_list|)
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|post
argument_list|(
name|request
argument_list|,
name|postData
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|rawHeader
argument_list|(
literal|"Content-length"
argument_list|)
argument_list|,
name|QByteArray
argument_list|(
literal|"4"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"POST"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SourceIsFromCacheAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|server
operator|.
name|setDataToTransmit
argument_list|(
name|getReply
argument_list|)
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"GET"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SourceIsFromCacheAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|server
operator|.
name|setDataToTransmit
argument_list|(
name|getReply
argument_list|)
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"GET"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SourceIsFromCacheAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|server
operator|.
name|setDataToTransmit
argument_list|(
name|putReply
argument_list|)
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|put
argument_list|(
name|request
argument_list|,
name|postData
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SourceIsFromCacheAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|server
operator|.
name|setDataToTransmit
argument_list|(
name|getReply
argument_list|)
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"GET"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SourceIsFromCacheAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|server
operator|.
name|setDataToTransmit
argument_list|(
name|getReply
argument_list|)
expr_stmt|;
name|reply
operator|.
name|reset
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|QByteArray
argument_list|(
literal|"GET"
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|SourceIsFromCacheAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|synchronousRequest_data
name|void
name|tst_QNetworkReply
operator|::
name|synchronousRequest_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"expected"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"checkContentLength"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"mimeType"
argument_list|)
expr_stmt|;
comment|// ### cache, auth, proxies
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
operator|<<
name|QString
argument_list|(
literal|"file:"
operator|+
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
operator|<<
literal|true
operator|<<
name|QString
argument_list|(
literal|"text/plain"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http-gzip"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/deflate/rfc3252.txt"
argument_list|)
operator|<<
name|QString
argument_list|(
literal|"file:"
operator|+
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
operator|<<
literal|false
comment|// don't check content length, because it's gzip encoded
comment|//  ### we would need to enflate (un-deflate) the file content and compare the sizes
operator|<<
name|QString
argument_list|(
literal|"text/plain"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
operator|<<
name|QString
argument_list|(
literal|"file:"
operator|+
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
operator|<<
literal|true
operator|<<
name|QString
argument_list|(
literal|"text/plain"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|QTest
operator|::
name|newRow
argument_list|(
literal|"data"
argument_list|)
operator|<<
name|QUrl
argument_list|(
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"data:text/plain,hello world"
argument_list|)
argument_list|)
operator|<<
name|QString
argument_list|(
literal|"data:hello world"
argument_list|)
operator|<<
literal|true
comment|// check content length
operator|<<
name|QString
argument_list|(
literal|"text/plain"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"simple-file"
argument_list|)
operator|<<
name|QUrl
operator|::
name|fromLocalFile
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
operator|<<
name|QString
argument_list|(
literal|"file:"
operator|+
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
operator|<<
literal|true
operator|<<
name|QString
argument_list|()
expr_stmt|;
block|}
end_function
begin_comment
comment|// FIXME add testcase for failing network etc
end_comment
begin_function
DECL|function|synchronousRequest
name|void
name|tst_QNetworkReply
operator|::
name|synchronousRequest
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|expected
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|checkContentLength
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|mimeType
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
comment|// workaround for HTTPS requests: add self-signed server cert to list of CA certs,
comment|// since we cannot react to the sslErrors() signal
comment|// to fix this properly we would need to have an ignoreSslErrors() method in the
comment|// QNetworkRequest, see QTBUG-14774
if|if
condition|(
name|url
operator|.
name|scheme
argument_list|()
operator|==
literal|"https"
condition|)
block|{
name|QSslConfiguration
name|sslConf
decl_stmt|;
name|QList
argument_list|<
name|QSslCertificate
argument_list|>
name|certs
init|=
name|QSslCertificate
operator|::
name|fromPath
argument_list|(
name|testDataDir
operator|+
literal|"/certs/qt-test-server-cacert.pem"
argument_list|)
decl_stmt|;
name|sslConf
operator|.
name|setCaCertificates
argument_list|(
name|certs
argument_list|)
expr_stmt|;
name|request
operator|.
name|setSslConfiguration
argument_list|(
name|sslConf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QSignalSpy
name|finishedSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|(
name|QNetworkReply
operator|*
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|QSignalSpy
name|sslErrorsSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|RUN_REQUEST
argument_list|(
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|finishedSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|sslErrorsSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentTypeHeader
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|,
name|mimeType
argument_list|)
expr_stmt|;
name|QByteArray
name|expectedContent
decl_stmt|;
if|if
condition|(
name|expected
operator|.
name|startsWith
argument_list|(
literal|"file:"
argument_list|)
condition|)
block|{
name|QString
name|path
init|=
name|expected
operator|.
name|mid
argument_list|(
literal|5
argument_list|)
decl_stmt|;
name|QFile
name|file
argument_list|(
name|path
argument_list|)
decl_stmt|;
name|file
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|expectedContent
operator|=
name|file
operator|.
name|readAll
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|expected
operator|.
name|startsWith
argument_list|(
literal|"data:"
argument_list|)
condition|)
block|{
name|expectedContent
operator|=
name|expected
operator|.
name|mid
argument_list|(
literal|5
argument_list|)
operator|.
name|toUtf8
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|checkContentLength
condition|)
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|header
argument_list|(
name|QNetworkRequest
operator|::
name|ContentLengthHeader
argument_list|)
operator|.
name|toLongLong
argument_list|()
argument_list|,
name|qint64
argument_list|(
name|expectedContent
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
argument_list|,
name|expectedContent
argument_list|)
expr_stmt|;
name|reply
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_SSL
end_ifndef
begin_function
DECL|function|synchronousRequestSslFailure
name|void
name|tst_QNetworkReply
operator|::
name|synchronousRequestSslFailure
parameter_list|()
block|{
comment|// test that SSL won't be accepted with self-signed certificate,
comment|// and that we do not emit the sslError signal (in the manager that is,
comment|// in the reply we don't care)
name|QUrl
name|url
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|QSignalSpy
name|sslErrorsSpy
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|SslHandshakeFailedError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|sslErrorsSpy
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_class
DECL|class|HttpAbortHelper
class|class
name|HttpAbortHelper
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|function|HttpAbortHelper
name|HttpAbortHelper
parameter_list|(
name|QNetworkReply
modifier|*
name|parent
parameter_list|)
member_init_list|:
name|QObject
argument_list|(
name|parent
argument_list|)
block|{
name|mReply
operator|=
name|parent
expr_stmt|;
name|connect
argument_list|(
name|parent
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|function|~HttpAbortHelper
name|~
name|HttpAbortHelper
parameter_list|()
block|{     }
public|public
name|slots
public|:
DECL|function|readyRead
name|void
name|readyRead
parameter_list|()
block|{
name|mReply
operator|->
name|abort
argument_list|()
expr_stmt|;
name|QMetaObject
operator|::
name|invokeMethod
argument_list|(
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
literal|"exitLoop"
argument_list|,
name|Qt
operator|::
name|QueuedConnection
argument_list|)
expr_stmt|;
block|}
private|private:
DECL|member|mReply
name|QNetworkReply
modifier|*
name|mReply
decl_stmt|;
block|}
class|;
end_class
begin_function
DECL|function|httpAbort
name|void
name|tst_QNetworkReply
operator|::
name|httpAbort
parameter_list|()
block|{
comment|// FIXME Also implement one where we do a big upload and then abort().
comment|// It must not crash either.
comment|// Abort after the first readyRead()
name|QNetworkRequest
name|request
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|HttpAbortHelper
name|replyHolder
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|)
decl_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|OperationCanceledError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// Abort immediately after the get()
name|QNetworkReplyPtr
name|reply2
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply2
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|reply2
operator|->
name|abort
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply2
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|OperationCanceledError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply2
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
comment|// Abort after the finished()
name|QNetworkRequest
name|request3
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply3
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request3
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply3
argument_list|)
operator|==
name|Success
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply3
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|reply3
operator|->
name|abort
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply3
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|dontInsertPartialContentIntoTheCache
name|void
name|tst_QNetworkReply
operator|::
name|dontInsertPartialContentIntoTheCache
parameter_list|()
block|{
name|QByteArray
name|reply206
init|=
literal|"HTTP/1.0 206\r\n"
literal|"Connection: keep-alive\r\n"
literal|"Content-Type: text/plain\r\n"
literal|"Cache-control: no-cache\r\n"
literal|"Content-Range: bytes 2-6/8\r\n"
literal|"Content-length: 4\r\n"
literal|"\r\n"
literal|"load"
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|reply206
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|false
expr_stmt|;
name|MySpyMemoryCache
modifier|*
name|memoryCache
init|=
operator|new
name|MySpyMemoryCache
argument_list|(
operator|&
name|manager
argument_list|)
decl_stmt|;
name|manager
operator|.
name|setCache
argument_list|(
name|memoryCache
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setRawHeader
argument_list|(
literal|"Range"
argument_list|,
literal|"bytes=2-6"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|server
operator|.
name|totalConnections
operator|>
literal|0
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|,
literal|"load"
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|memoryCache
operator|->
name|m_insertedUrls
operator|.
name|count
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|httpUserAgent
name|void
name|tst_QNetworkReply
operator|::
name|httpUserAgent
parameter_list|()
block|{
name|QByteArray
name|response
argument_list|(
literal|"HTTP/1.0 200 OK\r\n\r\n"
argument_list|)
decl_stmt|;
name|MiniHttpServer
name|server
argument_list|(
name|response
argument_list|)
decl_stmt|;
name|server
operator|.
name|doClose
operator|=
literal|true
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|request
operator|.
name|setHeader
argument_list|(
name|QNetworkRequest
operator|::
name|UserAgentHeader
argument_list|,
literal|"abcDEFghi"
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY2
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|==
name|Success
argument_list|,
name|msgWaitForFinished
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|server
operator|.
name|receivedData
operator|.
name|contains
argument_list|(
literal|"\r\nUser-Agent: abcDEFghi\r\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|synchronousAuthenticationCache
name|void
name|tst_QNetworkReply
operator|::
name|synchronousAuthenticationCache
parameter_list|()
block|{
class|class
name|MiniAuthServer
super|:
specifier|public
name|MiniHttpServer
block|{
public|public:
name|MiniAuthServer
parameter_list|(
name|QThread
modifier|*
name|thread
parameter_list|)
member_init_list|:
name|MiniHttpServer
argument_list|(
name|QByteArray
argument_list|()
argument_list|,
literal|false
argument_list|,
name|thread
argument_list|)
block|{}
empty_stmt|;
specifier|virtual
name|void
name|reply
parameter_list|()
block|{
name|dataToTransmit
operator|=
literal|"HTTP/1.0 401 Unauthorized\r\n"
literal|"WWW-Authenticate: Basic realm=\"QNetworkAccessManager Test Realm\"\r\n"
literal|"Content-Length: 4\r\n"
literal|"Connection: close\r\n"
literal|"Content-Type: text/plain\r\n"
literal|"\r\n"
literal|"auth"
expr_stmt|;
name|QRegExp
name|rx
argument_list|(
literal|"Authorization: Basic ([^\r\n]*)\r\n"
argument_list|)
decl_stmt|;
if|if
condition|(
name|rx
operator|.
name|indexIn
argument_list|(
name|receivedData
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|QByteArray
operator|::
name|fromBase64
argument_list|(
name|rx
operator|.
name|cap
argument_list|(
literal|1
argument_list|)
operator|.
name|toLatin1
argument_list|()
argument_list|)
operator|==
literal|"login:password"
condition|)
block|{
name|dataToTransmit
operator|=
literal|"HTTP/1.0 200 OK\r\n"
literal|"Content-Type: text/plain\r\n"
literal|"Content-Length: 2\r\n"
literal|"\r\n"
literal|"OK"
expr_stmt|;
block|}
block|}
name|receivedData
operator|.
name|clear
argument_list|()
expr_stmt|;
name|MiniHttpServer
operator|::
name|reply
argument_list|()
expr_stmt|;
block|}
block|}
class|;
comment|// when using synchronous commands, we need a different event loop for
comment|// the server thread, because the client is never returning to the
comment|// event loop
name|QScopedPointer
argument_list|<
name|QThread
argument_list|,
name|QThreadCleanup
argument_list|>
name|serverThread
argument_list|(
operator|new
name|QThread
argument_list|)
decl_stmt|;
name|QScopedPointer
argument_list|<
name|MiniHttpServer
argument_list|,
name|QDeleteLaterCleanup
argument_list|>
name|server
argument_list|(
operator|new
name|MiniAuthServer
argument_list|(
name|serverThread
operator|.
name|data
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|server
operator|->
name|doClose
operator|=
literal|true
expr_stmt|;
comment|//1)  URL without credentials, we are not authenticated
block|{
name|QUrl
name|url
init|=
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|->
name|serverPort
argument_list|()
argument_list|)
operator|+
literal|"/path"
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
block|}
comment|//2)  URL with credentials, we are authenticated
block|{
name|QUrl
name|url
init|=
literal|"http://login:password@localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|->
name|serverPort
argument_list|()
argument_list|)
operator|+
literal|"/path2"
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|,
literal|"OK"
argument_list|)
expr_stmt|;
block|}
comment|//3)  URL without credentials, we are authenticated because they are cached
block|{
name|QUrl
name|url
init|=
literal|"http://localhost:"
operator|+
name|QString
operator|::
name|number
argument_list|(
name|server
operator|->
name|serverPort
argument_list|()
argument_list|)
operator|+
literal|"/path3"
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|SynchronousRequestAttribute
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|readAll
argument_list|()
operator|.
name|constData
argument_list|()
argument_list|,
literal|"OK"
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|pipelining
name|void
name|tst_QNetworkReply
operator|::
name|pipelining
parameter_list|()
block|{
name|QString
name|urlString
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/echo.cgi?"
argument_list|)
decl_stmt|;
name|QList
argument_list|<
name|QNetworkReplyPtr
argument_list|>
name|replies
decl_stmt|;
for|for
control|(
name|int
name|a
init|=
literal|0
init|;
name|a
operator|<
literal|20
condition|;
name|a
operator|++
control|)
block|{
name|QNetworkRequest
name|request
argument_list|(
name|urlString
operator|+
name|QString
operator|::
name|number
argument_list|(
name|a
argument_list|)
argument_list|)
decl_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpPipeliningAllowedAttribute
argument_list|,
name|QVariant
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|replies
operator|.
name|append
argument_list|(
name|QNetworkReplyPtr
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|replies
operator|.
name|at
argument_list|(
name|a
argument_list|)
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|pipeliningHelperSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pipeliningHelperSlot
name|void
name|tst_QNetworkReply
operator|::
name|pipeliningHelperSlot
parameter_list|()
block|{
specifier|static
name|int
name|a
init|=
literal|0
decl_stmt|;
comment|// check that pipelining was used in at least one of the replies
specifier|static
name|bool
name|pipeliningWasUsed
init|=
literal|false
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|qobject_cast
argument_list|<
name|QNetworkReply
operator|*
argument_list|>
argument_list|(
name|sender
argument_list|()
argument_list|)
decl_stmt|;
name|bool
name|pipeliningWasUsedInReply
init|=
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpPipeliningWasUsedAttribute
argument_list|)
operator|.
name|toBool
argument_list|()
decl_stmt|;
if|if
condition|(
name|pipeliningWasUsedInReply
condition|)
name|pipeliningWasUsed
operator|=
literal|true
expr_stmt|;
comment|// check that the contents match (the response to echo.cgi?3 should return 3 etc.)
name|QString
name|urlQueryString
init|=
name|reply
operator|->
name|url
argument_list|()
operator|.
name|query
argument_list|()
decl_stmt|;
name|QString
name|content
init|=
name|reply
operator|->
name|readAll
argument_list|()
decl_stmt|;
name|QVERIFY2
argument_list|(
name|urlQueryString
operator|==
name|content
argument_list|,
literal|"data corruption with pipelining detected"
argument_list|)
expr_stmt|;
name|a
operator|++
expr_stmt|;
if|if
condition|(
name|a
operator|==
literal|20
condition|)
block|{
comment|// all replies have finished
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|exitLoop
argument_list|()
expr_stmt|;
name|QVERIFY2
argument_list|(
name|pipeliningWasUsed
argument_list|,
literal|"pipelining was not used in any of the replies when trying to test pipelining"
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|emitErrorForAllRepliesSlot
name|void
name|tst_QNetworkReply
operator|::
name|emitErrorForAllRepliesSlot
parameter_list|()
block|{
specifier|static
name|int
name|a
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|++
name|a
operator|==
literal|3
condition|)
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|exitLoop
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|closeDuringDownload_data
name|void
name|tst_QNetworkReply
operator|::
name|closeDuringDownload_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/bigfile"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|closeDuringDownload
name|void
name|tst_QNetworkReply
operator|::
name|closeDuringDownload
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|QTestEventLoop
operator|::
name|instance
argument_list|()
argument_list|,
name|SLOT
argument_list|(
name|exitLoop
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|reply
operator|->
name|close
argument_list|()
expr_stmt|;
name|reply
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
name|QTest
operator|::
name|qWait
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|//cancelling ftp takes some time, this avoids a warning caused by test's cleanup() destroying the connection cache before the abort is finished
block|}
end_function
begin_function
DECL|function|ftpAuthentication_data
name|void
name|tst_QNetworkReply
operator|::
name|ftpAuthentication_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"referenceName"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QString
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"error"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"invalidPassword"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
operator|)
operator|<<
literal|"ftp://ftptest:invalid@"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/home/qt-test-server/ftp/qtest/rfc3252.txt"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|AuthenticationRequiredError
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"validPassword"
argument_list|)
operator|<<
operator|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
operator|)
operator|<<
literal|"ftp://ftptest:password@"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/home/qt-test-server/ftp/qtest/rfc3252.txt"
operator|<<
name|int
argument_list|(
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ftpAuthentication
name|void
name|tst_QNetworkReply
operator|::
name|ftpAuthentication
parameter_list|()
block|{
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|referenceName
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QString
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QFile
name|reference
argument_list|(
name|referenceName
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|runSimpleRequest
argument_list|(
name|QNetworkAccessManager
operator|::
name|GetOperation
argument_list|,
name|request
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|url
argument_list|()
argument_list|,
name|request
operator|.
name|url
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NetworkError
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|emitErrorForAllReplies
name|void
name|tst_QNetworkReply
operator|::
name|emitErrorForAllReplies
parameter_list|()
comment|// QTBUG-36890
block|{
comment|// port 100 is not well-known and should be closed
name|QList
argument_list|<
name|QUrl
argument_list|>
name|urls
init|=
name|QList
argument_list|<
name|QUrl
argument_list|>
argument_list|()
operator|<<
name|QUrl
argument_list|(
literal|"http://localhost:100/request1"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://localhost:100/request2"
argument_list|)
operator|<<
name|QUrl
argument_list|(
literal|"http://localhost:100/request3"
argument_list|)
decl_stmt|;
name|QList
argument_list|<
name|QNetworkReply
modifier|*
argument_list|>
name|replies
decl_stmt|;
name|QList
argument_list|<
name|QSignalSpy
modifier|*
argument_list|>
name|errorSpies
decl_stmt|;
name|QList
argument_list|<
name|QSignalSpy
modifier|*
argument_list|>
name|finishedSpies
decl_stmt|;
for|for
control|(
name|int
name|a
init|=
literal|0
init|;
name|a
operator|<
name|urls
operator|.
name|count
argument_list|()
condition|;
operator|++
name|a
control|)
block|{
name|QNetworkRequest
name|request
argument_list|(
name|urls
operator|.
name|at
argument_list|(
name|a
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|replies
operator|.
name|append
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|QSignalSpy
modifier|*
name|errorSpy
init|=
operator|new
name|QSignalSpy
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|error
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|errorSpies
operator|.
name|append
argument_list|(
name|errorSpy
argument_list|)
expr_stmt|;
name|QSignalSpy
modifier|*
name|finishedSpy
init|=
operator|new
name|QSignalSpy
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|finishedSpies
operator|.
name|append
argument_list|(
name|finishedSpy
argument_list|)
expr_stmt|;
name|QObject
operator|::
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|emitErrorForAllRepliesSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|a
init|=
literal|0
init|;
name|a
operator|<
name|urls
operator|.
name|count
argument_list|()
condition|;
operator|++
name|a
control|)
block|{
name|QVERIFY
argument_list|(
name|replies
operator|.
name|at
argument_list|(
name|a
argument_list|)
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|errorSpies
operator|.
name|at
argument_list|(
name|a
argument_list|)
operator|->
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|errorSpies
operator|.
name|at
argument_list|(
name|a
argument_list|)
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
name|QCOMPARE
argument_list|(
name|finishedSpies
operator|.
name|at
argument_list|(
name|a
argument_list|)
operator|->
name|count
argument_list|()
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|finishedSpies
operator|.
name|at
argument_list|(
name|a
argument_list|)
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
name|replies
operator|.
name|at
argument_list|(
name|a
argument_list|)
operator|->
name|deleteLater
argument_list|()
expr_stmt|;
block|}
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|backgroundRequest_data
name|void
name|tst_QNetworkReply
operator|::
name|backgroundRequest_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"background"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|int
argument_list|>
argument_list|(
literal|"policy"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"error"
argument_list|)
expr_stmt|;
name|QUrl
name|httpurl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|QUrl
name|httpsurl
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|QUrl
name|ftpurl
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http, fg, normal"
argument_list|)
operator|<<
name|httpurl
operator|<<
literal|false
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoPolicy
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http, bg, normal"
argument_list|)
operator|<<
name|httpurl
operator|<<
literal|true
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoPolicy
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http, fg, nobg"
argument_list|)
operator|<<
name|httpurl
operator|<<
literal|false
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoBackgroundTrafficPolicy
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http, bg, nobg"
argument_list|)
operator|<<
name|httpurl
operator|<<
literal|true
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoBackgroundTrafficPolicy
operator|<<
name|QNetworkReply
operator|::
name|BackgroundRequestNotAllowedError
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https, fg, normal"
argument_list|)
operator|<<
name|httpsurl
operator|<<
literal|false
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoPolicy
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https, bg, normal"
argument_list|)
operator|<<
name|httpsurl
operator|<<
literal|true
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoPolicy
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https, fg, nobg"
argument_list|)
operator|<<
name|httpsurl
operator|<<
literal|false
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoBackgroundTrafficPolicy
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https, bg, nobg"
argument_list|)
operator|<<
name|httpsurl
operator|<<
literal|true
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoBackgroundTrafficPolicy
operator|<<
name|QNetworkReply
operator|::
name|BackgroundRequestNotAllowedError
expr_stmt|;
endif|#
directive|endif
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp, fg, normal"
argument_list|)
operator|<<
name|ftpurl
operator|<<
literal|false
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoPolicy
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp, bg, normal"
argument_list|)
operator|<<
name|ftpurl
operator|<<
literal|true
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoPolicy
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp, fg, nobg"
argument_list|)
operator|<<
name|ftpurl
operator|<<
literal|false
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoBackgroundTrafficPolicy
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp, bg, nobg"
argument_list|)
operator|<<
name|ftpurl
operator|<<
literal|true
operator|<<
operator|(
name|int
operator|)
name|QNetworkSession
operator|::
name|NoBackgroundTrafficPolicy
operator|<<
name|QNetworkReply
operator|::
name|BackgroundRequestNotAllowedError
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|//test purpose: background requests can't be started when not allowed
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|backgroundRequest
name|void
name|tst_QNetworkReply
operator|::
name|backgroundRequest
parameter_list|()
block|{
ifndef|#
directive|ifndef
name|QT_NO_BEARERMANAGEMENT
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|background
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|int
argument_list|,
name|policy
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
if|if
condition|(
name|background
condition|)
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|BackgroundRequestAttribute
argument_list|,
name|QVariant
operator|::
name|fromValue
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
comment|//this preconstructs the session so we can change policies in advance
name|manager
operator|.
name|setConfiguration
argument_list|(
name|networkConfiguration
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
specifier|const
name|QWeakPointer
argument_list|<
specifier|const
name|QNetworkSession
argument_list|>
name|session
init|=
name|QNetworkAccessManagerPrivate
operator|::
name|getNetworkSession
argument_list|(
operator|&
name|manager
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|session
argument_list|)
expr_stmt|;
name|QNetworkSession
operator|::
name|UsagePolicies
name|original
init|=
name|session
operator|.
name|data
argument_list|()
operator|->
name|usagePolicies
argument_list|()
decl_stmt|;
name|QNetworkSessionPrivate
operator|::
name|setUsagePolicies
argument_list|(
operator|*
cast|const_cast
argument_list|<
name|QNetworkSession
operator|*
argument_list|>
argument_list|(
name|session
operator|.
name|data
argument_list|()
argument_list|)
argument_list|,
name|QNetworkSession
operator|::
name|UsagePolicies
argument_list|(
name|policy
argument_list|)
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|session
condition|)
name|QNetworkSessionPrivate
operator|::
name|setUsagePolicies
argument_list|(
operator|*
cast|const_cast
argument_list|<
name|QNetworkSession
operator|*
argument_list|>
argument_list|(
name|session
operator|.
name|data
argument_list|()
argument_list|)
argument_list|,
name|original
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|error
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|backgroundRequestInterruption_data
name|void
name|tst_QNetworkReply
operator|::
name|backgroundRequestInterruption_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"background"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|QNetworkReply
operator|::
name|NetworkError
argument_list|>
argument_list|(
literal|"error"
argument_list|)
expr_stmt|;
name|QUrl
name|httpurl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/mediumfile"
argument_list|)
decl_stmt|;
name|QUrl
name|httpsurl
argument_list|(
literal|"https://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/mediumfile"
argument_list|)
decl_stmt|;
name|QUrl
name|ftpurl
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/bigfile"
argument_list|)
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http, fg, nobg"
argument_list|)
operator|<<
name|httpurl
operator|<<
literal|false
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http, bg, nobg"
argument_list|)
operator|<<
name|httpurl
operator|<<
literal|true
operator|<<
name|QNetworkReply
operator|::
name|BackgroundRequestNotAllowedError
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https, fg, nobg"
argument_list|)
operator|<<
name|httpsurl
operator|<<
literal|false
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"https, bg, nobg"
argument_list|)
operator|<<
name|httpsurl
operator|<<
literal|true
operator|<<
name|QNetworkReply
operator|::
name|BackgroundRequestNotAllowedError
expr_stmt|;
endif|#
directive|endif
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp, fg, nobg"
argument_list|)
operator|<<
name|ftpurl
operator|<<
literal|false
operator|<<
name|QNetworkReply
operator|::
name|NoError
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp, bg, nobg"
argument_list|)
operator|<<
name|ftpurl
operator|<<
literal|true
operator|<<
name|QNetworkReply
operator|::
name|BackgroundRequestNotAllowedError
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|//test purpose: background requests in progress are aborted when policy changes to disallow them
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|backgroundRequestInterruption
name|void
name|tst_QNetworkReply
operator|::
name|backgroundRequestInterruption
parameter_list|()
block|{
ifndef|#
directive|ifndef
name|QT_NO_BEARERMANAGEMENT
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|background
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|QNetworkReply
operator|::
name|NetworkError
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
if|if
condition|(
name|background
condition|)
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|BackgroundRequestAttribute
argument_list|,
name|QVariant
operator|::
name|fromValue
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
comment|//this preconstructs the session so we can change policies in advance
name|manager
operator|.
name|setConfiguration
argument_list|(
name|networkConfiguration
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|QT_NO_SSL
name|connect
argument_list|(
operator|&
name|manager
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|sslErrors
argument_list|(
name|QNetworkReply
operator|*
argument_list|,
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
specifier|const
name|QWeakPointer
argument_list|<
specifier|const
name|QNetworkSession
argument_list|>
name|session
init|=
name|QNetworkAccessManagerPrivate
operator|::
name|getNetworkSession
argument_list|(
operator|&
name|manager
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|session
argument_list|)
expr_stmt|;
name|QNetworkSession
operator|::
name|UsagePolicies
name|original
init|=
name|session
operator|.
name|data
argument_list|()
operator|->
name|usagePolicies
argument_list|()
decl_stmt|;
name|QNetworkSessionPrivate
operator|::
name|setUsagePolicies
argument_list|(
operator|*
cast|const_cast
argument_list|<
name|QNetworkSession
operator|*
argument_list|>
argument_list|(
name|session
operator|.
name|data
argument_list|()
argument_list|)
argument_list|,
name|QNetworkSession
operator|::
name|NoPolicy
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|MaximumDownloadBufferSizeAttribute
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|reply
operator|->
name|setReadBufferSize
argument_list|(
literal|1024
argument_list|)
expr_stmt|;
name|QSignalSpy
name|spy
argument_list|(
name|reply
operator|.
name|data
argument_list|()
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|QTRY_VERIFY
argument_list|(
name|spy
operator|.
name|count
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
name|QNetworkSessionPrivate
operator|::
name|setUsagePolicies
argument_list|(
operator|*
cast|const_cast
argument_list|<
name|QNetworkSession
operator|*
argument_list|>
argument_list|(
name|session
operator|.
name|data
argument_list|()
argument_list|)
argument_list|,
name|QNetworkSession
operator|::
name|NoBackgroundTrafficPolicy
argument_list|)
expr_stmt|;
comment|// After we have changed the policy we can download at full speed.
name|reply
operator|->
name|setReadBufferSize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|session
condition|)
name|QNetworkSessionPrivate
operator|::
name|setUsagePolicies
argument_list|(
operator|*
cast|const_cast
argument_list|<
name|QNetworkSession
operator|*
argument_list|>
argument_list|(
name|session
operator|.
name|data
argument_list|()
argument_list|)
argument_list|,
name|original
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|Q_OS_OSX
if|if
condition|(
name|QSysInfo
operator|::
name|MacintoshVersion
operator|==
name|QSysInfo
operator|::
name|MV_10_8
condition|)
name|QEXPECT_FAIL
argument_list|(
literal|"ftp, bg, nobg"
argument_list|,
literal|"See QTBUG-32435"
argument_list|,
name|Abort
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|error
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|backgroundRequestConnectInBackground_data
name|void
name|tst_QNetworkReply
operator|::
name|backgroundRequestConnectInBackground_data
parameter_list|()
block|{
name|QTest
operator|::
name|addColumn
argument_list|<
name|QUrl
argument_list|>
argument_list|(
literal|"url"
argument_list|)
expr_stmt|;
name|QTest
operator|::
name|addColumn
argument_list|<
name|bool
argument_list|>
argument_list|(
literal|"background"
argument_list|)
expr_stmt|;
name|QUrl
name|httpurl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
decl_stmt|;
name|QUrl
name|ftpurl
argument_list|(
literal|"ftp://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/rfc3252.txt"
argument_list|)
decl_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http, fg"
argument_list|)
operator|<<
name|httpurl
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"http, bg"
argument_list|)
operator|<<
name|httpurl
operator|<<
literal|true
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp, fg"
argument_list|)
operator|<<
name|ftpurl
operator|<<
literal|false
expr_stmt|;
name|QTest
operator|::
name|newRow
argument_list|(
literal|"ftp, bg"
argument_list|)
operator|<<
name|ftpurl
operator|<<
literal|true
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|//test purpose: check that backgroundness is propagated to the network session
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|QT_BUILD_INTERNAL
end_ifdef
begin_function
DECL|function|backgroundRequestConnectInBackground
name|void
name|tst_QNetworkReply
operator|::
name|backgroundRequestConnectInBackground
parameter_list|()
block|{
ifndef|#
directive|ifndef
name|QT_NO_BEARERMANAGEMENT
name|QFETCH
argument_list|(
name|QUrl
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|QFETCH
argument_list|(
name|bool
argument_list|,
name|background
argument_list|)
expr_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
if|if
condition|(
name|background
condition|)
name|request
operator|.
name|setAttribute
argument_list|(
name|QNetworkRequest
operator|::
name|BackgroundRequestAttribute
argument_list|,
name|QVariant
operator|::
name|fromValue
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|QWeakPointer
argument_list|<
specifier|const
name|QNetworkSession
argument_list|>
name|session
init|=
name|QNetworkAccessManagerPrivate
operator|::
name|getNetworkSession
argument_list|(
operator|&
name|manager
argument_list|)
decl_stmt|;
comment|//force QNAM to reopen the session.
if|if
condition|(
name|session
operator|&&
name|session
operator|.
name|data
argument_list|()
operator|->
name|isOpen
argument_list|()
condition|)
block|{
cast|const_cast
argument_list|<
name|QNetworkSession
operator|*
argument_list|>
argument_list|(
name|session
operator|.
name|data
argument_list|()
argument_list|)
operator|->
name|close
argument_list|()
expr_stmt|;
name|QCoreApplication
operator|::
name|processEvents
argument_list|()
expr_stmt|;
comment|//let signals propagate inside QNAM
block|}
comment|//this preconstructs the session so we can change policies in advance
name|manager
operator|.
name|setConfiguration
argument_list|(
name|networkConfiguration
argument_list|)
expr_stmt|;
name|session
operator|=
name|QNetworkAccessManagerPrivate
operator|::
name|getNetworkSession
argument_list|(
operator|&
name|manager
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
name|session
argument_list|)
expr_stmt|;
name|QNetworkSession
operator|::
name|UsagePolicies
name|original
init|=
name|session
operator|.
name|data
argument_list|()
operator|->
name|usagePolicies
argument_list|()
decl_stmt|;
name|QNetworkSessionPrivate
operator|::
name|setUsagePolicies
argument_list|(
operator|*
cast|const_cast
argument_list|<
name|QNetworkSession
operator|*
argument_list|>
argument_list|(
name|session
operator|.
name|data
argument_list|()
argument_list|)
argument_list|,
name|QNetworkSession
operator|::
name|NoPolicy
argument_list|)
expr_stmt|;
name|QNetworkReplyPtr
name|reply
argument_list|(
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
argument_list|)
decl_stmt|;
name|QVERIFY
argument_list|(
name|waitForFinish
argument_list|(
name|reply
argument_list|)
operator|!=
name|Timeout
argument_list|)
expr_stmt|;
name|session
operator|=
name|QNetworkAccessManagerPrivate
operator|::
name|getNetworkSession
argument_list|(
operator|&
name|manager
argument_list|)
expr_stmt|;
if|if
condition|(
name|session
condition|)
block|{
name|QVariant
name|cib
init|=
name|session
operator|.
name|data
argument_list|()
operator|->
name|sessionProperty
argument_list|(
name|QStringLiteral
argument_list|(
literal|"ConnectInBackground"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|cib
operator|.
name|isValid
argument_list|()
condition|)
name|QSKIP
argument_list|(
literal|"inconclusive - ConnectInBackground session property not supported by the bearer plugin"
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|cib
operator|.
name|toBool
argument_list|()
argument_list|,
name|background
argument_list|)
expr_stmt|;
name|QNetworkSessionPrivate
operator|::
name|setUsagePolicies
argument_list|(
operator|*
cast|const_cast
argument_list|<
name|QNetworkSession
operator|*
argument_list|>
argument_list|(
name|session
operator|.
name|data
argument_list|()
argument_list|)
argument_list|,
name|original
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QSKIP
argument_list|(
literal|"inconclusive - network session has been destroyed"
argument_list|)
expr_stmt|;
block|}
name|QVERIFY
argument_list|(
name|reply
operator|->
name|isFinished
argument_list|()
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_class
DECL|class|RateLimitedUploadDevice
class|class
name|RateLimitedUploadDevice
super|:
specifier|public
name|QIODevice
block|{
name|Q_OBJECT
public|public:
DECL|member|data
name|QByteArray
name|data
decl_stmt|;
DECL|member|buffer
name|QBuffer
name|buffer
decl_stmt|;
DECL|member|read
name|qint64
name|read
decl_stmt|;
DECL|member|bandwidthQuota
name|qint64
name|bandwidthQuota
decl_stmt|;
DECL|member|timer
name|QTimer
name|timer
decl_stmt|;
DECL|function|RateLimitedUploadDevice
name|RateLimitedUploadDevice
parameter_list|(
name|QByteArray
name|d
parameter_list|)
member_init_list|:
name|QIODevice
argument_list|()
member_init_list|,
name|data
argument_list|(
name|d
argument_list|)
member_init_list|,
name|read
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|bandwidthQuota
argument_list|(
literal|0
argument_list|)
block|{
name|buffer
operator|.
name|setData
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|buffer
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|timer
operator|.
name|setInterval
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|QObject
operator|::
name|connect
argument_list|(
operator|&
name|timer
argument_list|,
name|SIGNAL
argument_list|(
name|timeout
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|timeoutSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|timer
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
DECL|function|writeData
specifier|virtual
name|qint64
name|writeData
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|qint64
parameter_list|)
block|{
name|Q_ASSERT
argument_list|(
literal|false
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
DECL|function|readData
specifier|virtual
name|qint64
name|readData
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|qint64
name|maxlen
parameter_list|)
block|{
comment|//qDebug()<< Q_FUNC_INFO<< maxlen<< bandwidthQuota;
name|maxlen
operator|=
name|qMin
argument_list|(
name|maxlen
argument_list|,
name|buffer
operator|.
name|bytesAvailable
argument_list|()
argument_list|)
expr_stmt|;
name|maxlen
operator|=
name|qMin
argument_list|(
name|maxlen
argument_list|,
name|bandwidthQuota
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxlen
operator|<=
literal|0
condition|)
block|{
comment|// no quota or at end
return|return
literal|0
return|;
block|}
name|bandwidthQuota
operator|-=
name|maxlen
expr_stmt|;
comment|// reduce quota
name|qint64
name|ret
init|=
name|buffer
operator|.
name|read
argument_list|(
name|data
argument_list|,
name|maxlen
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|read
operator|+=
name|ret
expr_stmt|;
comment|//qDebug()<< Q_FUNC_INFO<< maxlen<< bandwidthQuota<< read<< ret<< buffer.bytesAvailable();
return|return
name|ret
return|;
block|}
DECL|function|atEnd
specifier|virtual
name|bool
name|atEnd
parameter_list|()
specifier|const
block|{
return|return
name|buffer
operator|.
name|atEnd
argument_list|()
return|;
block|}
DECL|function|size
specifier|virtual
name|qint64
name|size
parameter_list|()
specifier|const
block|{
return|return
name|data
operator|.
name|length
argument_list|()
return|;
block|}
DECL|function|bytesAvailable
name|qint64
name|bytesAvailable
parameter_list|()
specifier|const
block|{
return|return
name|buffer
operator|.
name|bytesAvailable
argument_list|()
operator|+
name|QIODevice
operator|::
name|bytesAvailable
argument_list|()
return|;
block|}
DECL|function|isSequential
specifier|virtual
name|bool
name|isSequential
parameter_list|()
specifier|const
block|{
comment|// random access, we can seek
return|return
literal|false
return|;
block|}
DECL|function|seek
specifier|virtual
name|bool
name|seek
parameter_list|(
name|qint64
name|pos
parameter_list|)
block|{
return|return
name|buffer
operator|.
name|seek
argument_list|(
name|pos
argument_list|)
return|;
block|}
protected|protected
name|slots
protected|:
DECL|function|timeoutSlot
name|void
name|timeoutSlot
parameter_list|()
block|{
comment|//qDebug()<< Q_FUNC_INFO;
name|bandwidthQuota
operator|=
literal|8
operator|*
literal|1024
expr_stmt|;
comment|// fill quota
emit|emit
name|readyRead
argument_list|()
emit|;
comment|// Emitting readyRead() several times triggers a bug ("QIODevice::read: Called with maxSize< 0") we fix with this commit
emit|emit
name|readyRead
argument_list|()
emit|;
block|}
block|}
class|;
end_class
begin_function
DECL|function|putWithRateLimiting
name|void
name|tst_QNetworkReply
operator|::
name|putWithRateLimiting
parameter_list|()
block|{
name|QFile
name|reference
argument_list|(
name|testDataDir
operator|+
literal|"/rfc3252.txt"
argument_list|)
decl_stmt|;
name|reference
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|QByteArray
name|data
init|=
name|reference
operator|.
name|readAll
argument_list|()
decl_stmt|;
name|QVERIFY
argument_list|(
name|data
operator|.
name|length
argument_list|()
operator|>
literal|0
argument_list|)
expr_stmt|;
name|QUrl
name|url
init|=
name|QUrl
operator|::
name|fromUserInput
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
operator|+
literal|"/qtest/cgi-bin/echo.cgi?"
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReplyPtr
name|reply
decl_stmt|;
name|RateLimitedUploadDevice
name|rateLimitedUploadDevice
argument_list|(
name|data
argument_list|)
decl_stmt|;
name|rateLimitedUploadDevice
operator|.
name|open
argument_list|(
name|QIODevice
operator|::
name|ReadOnly
argument_list|)
expr_stmt|;
name|RUN_REQUEST
argument_list|(
name|runCustomRequest
argument_list|(
name|request
argument_list|,
name|reply
argument_list|,
name|QByteArray
argument_list|(
literal|"POST"
argument_list|)
argument_list|,
operator|&
name|rateLimitedUploadDevice
argument_list|)
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|error
argument_list|()
argument_list|,
name|QNetworkReply
operator|::
name|NoError
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|reply
operator|->
name|attribute
argument_list|(
name|QNetworkRequest
operator|::
name|HttpStatusCodeAttribute
argument_list|)
operator|.
name|toInt
argument_list|()
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|QByteArray
name|uploadedData
init|=
name|reply
operator|->
name|readAll
argument_list|()
decl_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
operator|.
name|length
argument_list|()
argument_list|,
name|data
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|QCOMPARE
argument_list|(
name|uploadedData
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_SSL
end_ifndef
begin_class
DECL|class|PutWithServerClosingConnectionImmediatelyHandler
class|class
name|PutWithServerClosingConnectionImmediatelyHandler
super|:
specifier|public
name|QObject
block|{
name|Q_OBJECT
public|public:
DECL|member|m_parsedHeaders
name|bool
name|m_parsedHeaders
decl_stmt|;
DECL|member|m_receivedData
name|QByteArray
name|m_receivedData
decl_stmt|;
DECL|member|m_expectedData
name|QByteArray
name|m_expectedData
decl_stmt|;
DECL|member|m_socket
name|QSslSocket
modifier|*
name|m_socket
decl_stmt|;
DECL|function|PutWithServerClosingConnectionImmediatelyHandler
name|PutWithServerClosingConnectionImmediatelyHandler
parameter_list|(
name|QSslSocket
modifier|*
name|s
parameter_list|,
name|QByteArray
name|expected
parameter_list|)
member_init_list|:
name|m_parsedHeaders
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|m_expectedData
argument_list|(
name|expected
argument_list|)
member_init_list|,
name|m_socket
argument_list|(
name|s
argument_list|)
block|{
name|m_socket
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|m_socket
argument_list|,
name|SIGNAL
argument_list|(
name|readyRead
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|readyReadSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|m_socket
argument_list|,
name|SIGNAL
argument_list|(
name|disconnected
argument_list|()
argument_list|)
argument_list|,
name|SLOT
argument_list|(
name|disconnectedSlot
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
signals|signals:
name|void
name|correctFileUploadReceived
parameter_list|()
function_decl|;
name|void
name|corruptFileUploadReceived
parameter_list|()
function_decl|;
public|public
name|slots
public|:
DECL|function|closeDelayed
name|void
name|closeDelayed
parameter_list|()
block|{
name|m_socket
operator|->
name|close
argument_list|()
expr_stmt|;
block|}
DECL|function|readyReadSlot
name|void
name|readyReadSlot
parameter_list|()
block|{
name|QByteArray
name|data
init|=
name|m_socket
operator|->
name|readAll
argument_list|()
decl_stmt|;
name|m_receivedData
operator|+=
name|data
expr_stmt|;
if|if
condition|(
operator|!
name|m_parsedHeaders
operator|&&
name|m_receivedData
operator|.
name|contains
argument_list|(
literal|"\r\n\r\n"
argument_list|)
condition|)
block|{
name|m_parsedHeaders
operator|=
literal|true
expr_stmt|;
name|QTimer
operator|::
name|singleShot
argument_list|(
name|qrand
argument_list|()
operator|%
literal|60
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|closeDelayed
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// simulate random network latency
comment|// This server simulates a web server connection closing, e.g. because of Apaches MaxKeepAliveRequests or KeepAliveTimeout
comment|// In this case QNAM needs to re-send the upload data but it had a bug which then corrupts the upload
comment|// This test catches that.
block|}
block|}
DECL|function|disconnectedSlot
name|void
name|disconnectedSlot
parameter_list|()
block|{
if|if
condition|(
name|m_parsedHeaders
condition|)
block|{
comment|//qDebug()<< m_receivedData.left(m_receivedData.indexOf("\r\n\r\n"));
name|m_receivedData
operator|=
name|m_receivedData
operator|.
name|mid
argument_list|(
name|m_receivedData
operator|.
name|indexOf
argument_list|(
literal|"\r\n\r\n"
argument_list|)
operator|+
literal|4
argument_list|)
expr_stmt|;
comment|// check only actual data
block|}
if|if
condition|(
name|m_receivedData
operator|.
name|length
argument_list|()
operator|>
literal|0
operator|&&
operator|!
name|m_expectedData
operator|.
name|startsWith
argument_list|(
name|m_receivedData
argument_list|)
condition|)
block|{
comment|// We had received some data but it is corrupt!
name|qDebug
argument_list|()
operator|<<
literal|"CORRUPT"
operator|<<
name|m_receivedData
operator|.
name|count
argument_list|()
expr_stmt|;
comment|// Use this to track down the pattern of the corruption and conclude the source
comment|//            QFile a("/tmp/corrupt");
comment|//            a.open(QIODevice::WriteOnly);
comment|//            a.write(m_receivedData);
comment|//            a.close();
comment|//            QFile b("/tmp/correct");
comment|//            b.open(QIODevice::WriteOnly);
comment|//            b.write(m_expectedData);
comment|//            b.close();
comment|//exit(1);
emit|emit
name|corruptFileUploadReceived
argument_list|()
emit|;
block|}
else|else
block|{
emit|emit
name|correctFileUploadReceived
argument_list|()
emit|;
block|}
block|}
block|}
class|;
end_class
begin_class
DECL|class|PutWithServerClosingConnectionImmediatelyServer
class|class
name|PutWithServerClosingConnectionImmediatelyServer
super|:
specifier|public
name|SslServer
block|{
name|Q_OBJECT
public|public:
DECL|member|m_correctUploads
name|int
name|m_correctUploads
decl_stmt|;
DECL|member|m_corruptUploads
name|int
name|m_corruptUploads
decl_stmt|;
DECL|member|m_repliesFinished
name|int
name|m_repliesFinished
decl_stmt|;
DECL|member|m_expectedReplies
name|int
name|m_expectedReplies
decl_stmt|;
DECL|member|m_expectedData
name|QByteArray
name|m_expectedData
decl_stmt|;
DECL|function|PutWithServerClosingConnectionImmediatelyServer
name|PutWithServerClosingConnectionImmediatelyServer
parameter_list|()
member_init_list|:
name|SslServer
argument_list|()
member_init_list|,
name|m_correctUploads
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|m_corruptUploads
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|m_repliesFinished
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|m_expectedReplies
argument_list|(
literal|0
argument_list|)
block|{
name|QObject
operator|::
name|connect
argument_list|(
name|this
argument_list|,
name|SIGNAL
argument_list|(
name|newEncryptedConnection
argument_list|(
name|QSslSocket
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|createHandlerForConnection
argument_list|(
name|QSslSocket
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|QObject
operator|::
name|connect
argument_list|(
name|this
argument_list|,
name|SIGNAL
argument_list|(
name|newPlainConnection
argument_list|(
name|QSslSocket
operator|*
argument_list|)
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|createHandlerForConnection
argument_list|(
name|QSslSocket
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
public|public
name|slots
public|:
DECL|function|createHandlerForConnection
name|void
name|createHandlerForConnection
parameter_list|(
name|QSslSocket
modifier|*
name|s
parameter_list|)
block|{
name|PutWithServerClosingConnectionImmediatelyHandler
modifier|*
name|handler
init|=
operator|new
name|PutWithServerClosingConnectionImmediatelyHandler
argument_list|(
name|s
argument_list|,
name|m_expectedData
argument_list|)
decl_stmt|;
name|handler
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|QObject
operator|::
name|connect
argument_list|(
name|handler
argument_list|,
name|SIGNAL
argument_list|(
name|correctFileUploadReceived
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|increaseCorrect
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|QObject
operator|::
name|connect
argument_list|(
name|handler
argument_list|,
name|SIGNAL
argument_list|(
name|corruptFileUploadReceived
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|,
name|SLOT
argument_list|(
name|increaseCorrupt
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|function|increaseCorrect
name|void
name|increaseCorrect
parameter_list|()
block|{
name|m_correctUploads
operator|++
expr_stmt|;
block|}
DECL|function|increaseCorrupt
name|void
name|increaseCorrupt
parameter_list|()
block|{
name|m_corruptUploads
operator|++
expr_stmt|;
block|}
DECL|function|replyFinished
name|void
name|replyFinished
parameter_list|()
block|{
name|m_repliesFinished
operator|++
expr_stmt|;
if|if
condition|(
name|m_repliesFinished
operator|==
name|m_expectedReplies
condition|)
block|{
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|exitLoop
argument_list|()
expr_stmt|;
block|}
block|}
block|}
class|;
end_class
begin_function
DECL|function|putWithServerClosingConnectionImmediately
name|void
name|tst_QNetworkReply
operator|::
name|putWithServerClosingConnectionImmediately
parameter_list|()
block|{
specifier|const
name|int
name|numUploads
init|=
literal|40
decl_stmt|;
name|qint64
name|wantedSize
init|=
literal|512
operator|*
literal|1024
decl_stmt|;
comment|// 512 kB
name|QByteArray
name|sourceFile
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|wantedSize
condition|;
operator|++
name|i
control|)
block|{
name|sourceFile
operator|+=
operator|(
name|char
operator|)
literal|'a'
operator|+
operator|(
name|i
operator|%
literal|26
operator|)
expr_stmt|;
block|}
name|bool
name|withSsl
init|=
literal|false
decl_stmt|;
for|for
control|(
name|int
name|s
init|=
literal|0
init|;
name|s
operator|<=
literal|1
condition|;
name|s
operator|++
control|)
block|{
name|withSsl
operator|=
operator|(
name|s
operator|==
literal|1
operator|)
expr_stmt|;
comment|// Test also needs to run several times because of 9c2ecf89
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|j
operator|<
literal|20
condition|;
name|j
operator|++
control|)
block|{
comment|// emulate a minimal https server
name|PutWithServerClosingConnectionImmediatelyServer
name|server
decl_stmt|;
name|server
operator|.
name|m_ssl
operator|=
name|withSsl
expr_stmt|;
name|server
operator|.
name|m_expectedData
operator|=
name|sourceFile
expr_stmt|;
name|server
operator|.
name|m_expectedReplies
operator|=
name|numUploads
expr_stmt|;
name|server
operator|.
name|listen
argument_list|(
name|QHostAddress
argument_list|(
name|QHostAddress
operator|::
name|LocalHost
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numUploads
condition|;
name|i
operator|++
control|)
block|{
comment|// create the request
name|QUrl
name|url
init|=
name|QUrl
argument_list|(
name|QString
argument_list|(
literal|"http%1://127.0.0.1:%2/file=%3"
argument_list|)
operator|.
name|arg
argument_list|(
name|withSsl
condition|?
literal|"s"
else|:
literal|""
argument_list|)
operator|.
name|arg
argument_list|(
name|server
operator|.
name|serverPort
argument_list|()
argument_list|)
operator|.
name|arg
argument_list|(
name|i
argument_list|)
argument_list|)
decl_stmt|;
name|QNetworkRequest
name|request
argument_list|(
name|url
argument_list|)
decl_stmt|;
name|QNetworkReply
modifier|*
name|reply
init|=
name|manager
operator|.
name|put
argument_list|(
name|request
argument_list|,
name|sourceFile
argument_list|)
decl_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|sslErrors
argument_list|(
name|QList
argument_list|<
name|QSslError
argument_list|>
argument_list|)
argument_list|)
argument_list|,
name|reply
argument_list|,
name|SLOT
argument_list|(
name|ignoreSslErrors
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|reply
argument_list|,
name|SIGNAL
argument_list|(
name|finished
argument_list|()
argument_list|)
argument_list|,
operator|&
name|server
argument_list|,
name|SLOT
argument_list|(
name|replyFinished
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|reply
operator|->
name|setParent
argument_list|(
operator|&
name|server
argument_list|)
expr_stmt|;
block|}
comment|// get the request started and the incoming socket connected
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|enterLoop
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|QVERIFY
argument_list|(
operator|!
name|QTestEventLoop
operator|::
name|instance
argument_list|()
operator|.
name|timeout
argument_list|()
argument_list|)
expr_stmt|;
comment|//qDebug()<< "correct="<< server.m_correctUploads<< "corrupt="<< server.m_corruptUploads<< "expected="<<numUploads;
comment|// Sanity check because ecause of 9c2ecf89 most replies will error out but we want to make sure at least some of them worked
name|QVERIFY
argument_list|(
name|server
operator|.
name|m_correctUploads
operator|>
literal|2
argument_list|)
expr_stmt|;
comment|// Because actually important is that we don't get any corruption:
name|QCOMPARE
argument_list|(
name|server
operator|.
name|m_corruptUploads
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|server
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// NOTE: This test must be last testcase in tst_qnetworkreply!
end_comment
begin_function
DECL|function|parentingRepliesToTheApp
name|void
name|tst_QNetworkReply
operator|::
name|parentingRepliesToTheApp
parameter_list|()
block|{
name|QNetworkRequest
name|request
argument_list|(
name|QUrl
argument_list|(
literal|"http://"
operator|+
name|QtNetworkSettings
operator|::
name|serverName
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
operator|->
name|setParent
argument_list|(
name|this
argument_list|)
expr_stmt|;
comment|// parent to this object
name|manager
operator|.
name|get
argument_list|(
name|request
argument_list|)
operator|->
name|setParent
argument_list|(
name|qApp
argument_list|)
expr_stmt|;
comment|// parent to the app
block|}
end_function
begin_macro
name|QTEST_MAIN
argument_list|(
argument|tst_QNetworkReply
argument_list|)
end_macro
begin_include
include|#
directive|include
file|"tst_qnetworkreply.moc"
end_include
end_unit
