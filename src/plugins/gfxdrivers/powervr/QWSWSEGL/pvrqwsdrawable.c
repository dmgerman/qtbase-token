begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2011 Nokia Corporation and/or its subsidiary(-ies). ** All rights reserved. ** Contact: Nokia Corporation (qt-info@nokia.com) ** ** This file is part of the plugins of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** GNU Lesser General Public License Usage ** This file may be used under the terms of the GNU Lesser General Public ** License version 2.1 as published by the Free Software Foundation and ** appearing in the file LICENSE.LGPL included in the packaging of this ** file. Please review the following information to ensure the GNU Lesser ** General Public License version 2.1 requirements will be met: ** http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Nokia gives you certain additional ** rights. These rights are described in the Nokia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU General ** Public License version 3.0 as published by the Free Software Foundation ** and appearing in the file LICENSE.GPL included in the packaging of this ** file. Please review the following information to ensure the GNU General ** Public License version 3.0 requirements will be met: ** http://www.gnu.org/copyleft/gpl.html. ** ** Other Usage ** Alternatively, this file may be used in accordance with the terms and ** conditions contained in a signed written agreement between you and Nokia. ** ** ** ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"pvrqwsdrawable_p.h"
end_include
begin_include
include|#
directive|include
file|<stdio.h>
end_include
begin_include
include|#
directive|include
file|<stdlib.h>
end_include
begin_include
include|#
directive|include
file|<string.h>
end_include
begin_include
include|#
directive|include
file|<sys/types.h>
end_include
begin_include
include|#
directive|include
file|<sys/mman.h>
end_include
begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include
begin_include
include|#
directive|include
file|<linux/fb.h>
end_include
begin_include
include|#
directive|include
file|<fcntl.h>
end_include
begin_include
include|#
directive|include
file|<unistd.h>
end_include
begin_decl_stmt
DECL|variable|pvrQwsDisplay
name|PvrQwsDisplay
name|pvrQwsDisplay
decl_stmt|;
end_decl_stmt
begin_function_decl
specifier|static
name|void
name|pvrQwsDestroyDrawableForced
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
function_decl|;
end_function_decl
begin_comment
comment|/* Initialize the /dev/fbN device for a specific screen */
end_comment
begin_function
DECL|function|pvrQwsInitFbScreen
specifier|static
name|int
name|pvrQwsInitFbScreen
parameter_list|(
name|int
name|screen
parameter_list|)
block|{
name|struct
name|fb_var_screeninfo
name|var
decl_stmt|;
name|struct
name|fb_fix_screeninfo
name|fix
decl_stmt|;
name|unsigned
name|long
name|start
decl_stmt|;
name|unsigned
name|long
name|length
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|,
name|stride
decl_stmt|;
name|PVR2DFORMAT
name|format
decl_stmt|;
name|void
modifier|*
name|mapped
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|bytesPerPixel
decl_stmt|;
name|char
name|name
index|[
literal|64
index|]
decl_stmt|;
name|PVR2DMEMINFO
modifier|*
name|memInfo
decl_stmt|;
name|unsigned
name|long
name|pageAddresses
index|[
literal|2
index|]
decl_stmt|;
comment|/* Bail out if already initialized, or the number is incorrect */
if|if
condition|(
name|screen
operator|<
literal|0
operator|||
name|screen
operator|>=
name|PVRQWS_MAX_SCREENS
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|initialized
condition|)
return|return
literal|1
return|;
comment|/* Open the framebuffer and fetch its properties */
name|sprintf
argument_list|(
name|name
argument_list|,
literal|"/dev/fb%d"
argument_list|,
name|screen
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|name
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|FBIOGET_VSCREENINFO
argument_list|,
operator|&
name|var
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"FBIOGET_VSCREENINFO"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|FBIOGET_FSCREENINFO
argument_list|,
operator|&
name|fix
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"FBIOGET_FSCREENINFO"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|width
operator|=
name|var
operator|.
name|xres
expr_stmt|;
name|height
operator|=
name|var
operator|.
name|yres
expr_stmt|;
name|bytesPerPixel
operator|=
name|var
operator|.
name|bits_per_pixel
operator|/
literal|8
expr_stmt|;
name|stride
operator|=
name|fix
operator|.
name|line_length
expr_stmt|;
name|format
operator|=
name|PVR2D_1BPP
expr_stmt|;
if|if
condition|(
name|var
operator|.
name|bits_per_pixel
operator|==
literal|16
condition|)
block|{
if|if
condition|(
name|var
operator|.
name|red
operator|.
name|length
operator|==
literal|5
operator|&&
name|var
operator|.
name|green
operator|.
name|length
operator|==
literal|6
operator|&&
name|var
operator|.
name|blue
operator|.
name|length
operator|==
literal|5
operator|&&
name|var
operator|.
name|red
operator|.
name|offset
operator|==
literal|11
operator|&&
name|var
operator|.
name|green
operator|.
name|offset
operator|==
literal|5
operator|&&
name|var
operator|.
name|blue
operator|.
name|offset
operator|==
literal|0
condition|)
block|{
name|format
operator|=
name|PVR2D_RGB565
expr_stmt|;
block|}
if|if
condition|(
name|var
operator|.
name|red
operator|.
name|length
operator|==
literal|4
operator|&&
name|var
operator|.
name|green
operator|.
name|length
operator|==
literal|4
operator|&&
name|var
operator|.
name|blue
operator|.
name|length
operator|==
literal|4
operator|&&
name|var
operator|.
name|transp
operator|.
name|length
operator|==
literal|4
operator|&&
name|var
operator|.
name|red
operator|.
name|offset
operator|==
literal|8
operator|&&
name|var
operator|.
name|green
operator|.
name|offset
operator|==
literal|4
operator|&&
name|var
operator|.
name|blue
operator|.
name|offset
operator|==
literal|0
operator|&&
name|var
operator|.
name|transp
operator|.
name|offset
operator|==
literal|12
condition|)
block|{
name|format
operator|=
name|PVR2D_ARGB4444
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|var
operator|.
name|bits_per_pixel
operator|==
literal|32
condition|)
block|{
if|if
condition|(
name|var
operator|.
name|red
operator|.
name|length
operator|==
literal|8
operator|&&
name|var
operator|.
name|green
operator|.
name|length
operator|==
literal|8
operator|&&
name|var
operator|.
name|blue
operator|.
name|length
operator|==
literal|8
operator|&&
name|var
operator|.
name|transp
operator|.
name|length
operator|==
literal|8
operator|&&
name|var
operator|.
name|red
operator|.
name|offset
operator|==
literal|16
operator|&&
name|var
operator|.
name|green
operator|.
name|offset
operator|==
literal|8
operator|&&
name|var
operator|.
name|blue
operator|.
name|offset
operator|==
literal|0
operator|&&
name|var
operator|.
name|transp
operator|.
name|offset
operator|==
literal|24
condition|)
block|{
name|format
operator|=
name|PVR2D_ARGB8888
expr_stmt|;
block|}
block|}
if|if
condition|(
name|format
operator|==
name|PVR2D_1BPP
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: could not find a suitable PVR2D pixel format\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|start
operator|=
name|fix
operator|.
name|smem_start
expr_stmt|;
name|length
operator|=
name|var
operator|.
name|xres_virtual
operator|*
name|var
operator|.
name|yres_virtual
operator|*
name|bytesPerPixel
expr_stmt|;
if|if
condition|(
name|screen
operator|==
literal|0
condition|)
block|{
comment|/* We use PVR2DGetFrameBuffer to map the first screen.            On some chipsets it is more reliable than using PVR2DMemWrap */
name|mapped
operator|=
literal|0
expr_stmt|;
name|memInfo
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* Other screens: map the framebuffer region into memory */
name|mapped
operator|=
name|mmap
argument_list|(
literal|0
argument_list|,
name|length
argument_list|,
name|PROT_READ
operator||
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mapped
operator|||
name|mapped
operator|==
operator|(
name|void
operator|*
operator|)
operator|(
operator|-
literal|1
operator|)
condition|)
block|{
name|perror
argument_list|(
literal|"mmap"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Allocate a PVR2D memory region for the framebuffer */
name|memInfo
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|context
condition|)
block|{
name|pageAddresses
index|[
literal|0
index|]
operator|=
name|start
operator|&
literal|0xFFFFF000
expr_stmt|;
name|pageAddresses
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|PVR2DMemWrap
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|mapped
argument_list|,
name|PVR2D_WRAPFLAG_CONTIGUOUS
argument_list|,
name|length
argument_list|,
name|pageAddresses
argument_list|,
operator|&
name|memInfo
argument_list|)
operator|!=
name|PVR2D_OK
condition|)
block|{
name|munmap
argument_list|(
name|mapped
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
comment|/* We don't need the file descriptor any more */
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
comment|/* The framebuffer is ready, so initialize the PvrQwsScreenInfo */
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenRect
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenRect
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenRect
operator|.
name|width
operator|=
name|width
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenRect
operator|.
name|height
operator|=
name|height
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenStride
operator|=
name|stride
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|pixelFormat
operator|=
name|format
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|bytesPerPixel
operator|=
name|bytesPerPixel
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenDrawable
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mapped
condition|)
block|{
comment|/* Don't set these fields if mapped is 0, because PVR2DGetFrameBuffer            may have already been called and set them */
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|frameBuffer
operator|=
name|memInfo
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|mapped
operator|=
name|mapped
expr_stmt|;
block|}
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|mappedLength
operator|=
name|length
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenStart
operator|=
name|start
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|needsUnmap
operator|=
operator|(
name|mapped
operator|!=
literal|0
operator|)
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|initialized
operator|=
literal|1
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function
begin_comment
comment|/* Called when a new drawable is added to ensure that we have a    PVR2D context and framebuffer PVR2DMEMINFO blocks */
end_comment
begin_function
DECL|function|pvrQwsAddDrawable
specifier|static
name|int
name|pvrQwsAddDrawable
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|numDevs
decl_stmt|,
name|screen
decl_stmt|;
name|PVR2DDEVICEINFO
modifier|*
name|devs
decl_stmt|;
name|unsigned
name|long
name|devId
decl_stmt|;
name|unsigned
name|long
name|pageAddresses
index|[
literal|2
index|]
decl_stmt|;
name|PVR2DMEMINFO
modifier|*
name|memInfo
decl_stmt|;
name|PVR2DDISPLAYINFO
name|displayInfo
decl_stmt|;
comment|/* Bail out early if this is not the first drawable */
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|numDrawables
operator|>
literal|0
condition|)
block|{
operator|++
operator|(
name|pvrQwsDisplay
operator|.
name|numDrawables
operator|)
expr_stmt|;
return|return
literal|1
return|;
block|}
comment|/* Find the first PVR2D device in the system and open it */
name|numDevs
operator|=
name|PVR2DEnumerateDevices
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|numDevs
operator|<=
literal|0
condition|)
return|return
literal|0
return|;
name|devs
operator|=
operator|(
name|PVR2DDEVICEINFO
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|PVR2DDEVICEINFO
argument_list|)
operator|*
name|numDevs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|devs
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|PVR2DEnumerateDevices
argument_list|(
name|devs
argument_list|)
operator|!=
name|PVR2D_OK
condition|)
block|{
name|free
argument_list|(
name|devs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|devId
operator|=
name|devs
index|[
literal|0
index|]
operator|.
name|ulDevID
expr_stmt|;
name|free
argument_list|(
name|devs
argument_list|)
expr_stmt|;
if|if
condition|(
name|PVR2DCreateDeviceContext
argument_list|(
name|devId
argument_list|,
operator|&
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
literal|0
argument_list|)
operator|!=
name|PVR2D_OK
condition|)
return|return
literal|0
return|;
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
operator|=
literal|0
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|flipChain
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|PVR2DGetDeviceInfo
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
operator|&
name|displayInfo
argument_list|)
operator|==
name|PVR2D_OK
condition|)
block|{
if|if
condition|(
name|displayInfo
operator|.
name|ulMaxFlipChains
operator|>
literal|0
operator|&&
name|displayInfo
operator|.
name|ulMaxBuffersInChain
operator|>
literal|0
condition|)
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
operator|=
name|displayInfo
operator|.
name|ulMaxBuffersInChain
expr_stmt|;
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
operator|>
name|PVRQWS_MAX_FLIP_BUFFERS
condition|)
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
operator|=
name|PVRQWS_MAX_FLIP_BUFFERS
expr_stmt|;
block|}
comment|/* Create the PVR2DMEMINFO blocks for the active framebuffers */
for|for
control|(
name|screen
operator|=
literal|0
init|;
name|screen
operator|<
name|PVRQWS_MAX_SCREENS
condition|;
operator|++
name|screen
control|)
block|{
if|if
condition|(
name|screen
operator|!=
literal|0
operator|&&
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|mapped
condition|)
block|{
name|pageAddresses
index|[
literal|0
index|]
operator|=
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenStart
operator|&
literal|0xFFFFF000
expr_stmt|;
name|pageAddresses
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|PVR2DMemWrap
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|mapped
argument_list|,
name|PVR2D_WRAPFLAG_CONTIGUOUS
argument_list|,
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|mappedLength
argument_list|,
name|pageAddresses
argument_list|,
operator|&
name|memInfo
argument_list|)
operator|!=
name|PVR2D_OK
condition|)
block|{
name|PVR2DDestroyDeviceContext
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|)
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|context
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|frameBuffer
operator|=
name|memInfo
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|screen
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|PVR2DGetFrameBuffer
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|PVR2D_FB_PRIMARY_SURFACE
argument_list|,
operator|&
name|memInfo
argument_list|)
operator|!=
name|PVR2D_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"QWSWSEGL: could not get the primary framebuffer surface\n"
argument_list|)
expr_stmt|;
name|PVR2DDestroyDeviceContext
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|)
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|context
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|frameBuffer
operator|=
name|memInfo
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|mapped
operator|=
name|memInfo
operator|->
name|pBase
expr_stmt|;
block|}
block|}
comment|/* Create a flip chain for the screen if supported by the hardware */
name|pvrQwsDisplay
operator|.
name|usePresentBlit
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
operator|>
literal|0
condition|)
block|{
name|long
name|stride
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|flipId
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|numBuffers
decl_stmt|;
if|if
condition|(
name|PVR2DCreateFlipChain
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
literal|0
argument_list|,
comment|//PVR2D_CREATE_FLIPCHAIN_SHARED |
comment|//PVR2D_CREATE_FLIPCHAIN_QUERY,
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
argument_list|,
name|pvrQwsDisplay
operator|.
name|screens
index|[
literal|0
index|]
operator|.
name|screenRect
operator|.
name|width
argument_list|,
name|pvrQwsDisplay
operator|.
name|screens
index|[
literal|0
index|]
operator|.
name|screenRect
operator|.
name|height
argument_list|,
name|pvrQwsDisplay
operator|.
name|screens
index|[
literal|0
index|]
operator|.
name|pixelFormat
argument_list|,
operator|&
name|stride
argument_list|,
operator|&
name|flipId
argument_list|,
operator|&
operator|(
name|pvrQwsDisplay
operator|.
name|flipChain
operator|)
argument_list|)
operator|==
name|PVR2D_OK
condition|)
block|{
name|pvrQwsDisplay
operator|.
name|screens
index|[
literal|0
index|]
operator|.
name|screenStride
operator|=
name|stride
expr_stmt|;
name|PVR2DGetFlipChainBuffers
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|pvrQwsDisplay
operator|.
name|flipChain
argument_list|,
operator|&
name|numBuffers
argument_list|,
name|pvrQwsDisplay
operator|.
name|flipBuffers
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pvrQwsDisplay
operator|.
name|flipChain
operator|=
literal|0
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
operator|=
literal|0
expr_stmt|;
block|}
comment|/* PVR2DPresentBlt is a little more reliable than PVR2DBlt            when flip chains are present, even if we cannot create a            flip chain at the moment */
name|pvrQwsDisplay
operator|.
name|usePresentBlit
operator|=
literal|1
expr_stmt|;
block|}
comment|/* The context is ready to go */
operator|++
operator|(
name|pvrQwsDisplay
operator|.
name|numDrawables
operator|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function
begin_comment
comment|/* Called when the last drawable is destroyed.  The PVR2D context    will be destroyed but the raw framebuffer memory will stay mapped */
end_comment
begin_function
DECL|function|pvrQwsDestroyContext
specifier|static
name|void
name|pvrQwsDestroyContext
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|screen
decl_stmt|;
for|for
control|(
name|screen
operator|=
literal|0
init|;
name|screen
operator|<
name|PVRQWS_MAX_SCREENS
condition|;
operator|++
name|screen
control|)
block|{
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|frameBuffer
condition|)
block|{
name|PVR2DMemFree
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|frameBuffer
argument_list|)
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|frameBuffer
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
operator|>
literal|0
condition|)
name|PVR2DDestroyFlipChain
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|pvrQwsDisplay
operator|.
name|flipChain
argument_list|)
expr_stmt|;
name|PVR2DDestroyDeviceContext
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|)
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|context
operator|=
literal|0
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|flipChain
operator|=
literal|0
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
operator|=
literal|0
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|usePresentBlit
operator|=
literal|0
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pvrQwsDisplayOpen
name|int
name|pvrQwsDisplayOpen
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|screen
decl_stmt|;
comment|/* If the display is already open, increase reference count and return */
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|refCount
operator|>
literal|0
condition|)
block|{
operator|++
operator|(
name|pvrQwsDisplay
operator|.
name|refCount
operator|)
expr_stmt|;
return|return
literal|1
return|;
block|}
comment|/* Open the framebuffer and map it directly */
if|if
condition|(
operator|!
name|pvrQwsInitFbScreen
argument_list|(
literal|0
argument_list|)
condition|)
block|{
operator|--
operator|(
name|pvrQwsDisplay
operator|.
name|refCount
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Clear the other screens.  We will create them if they are referenced */
for|for
control|(
name|screen
operator|=
literal|1
init|;
name|screen
operator|<
name|PVRQWS_MAX_SCREENS
condition|;
operator|++
name|screen
control|)
name|memset
argument_list|(
operator|&
operator|(
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|PvrQwsScreenInfo
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The display is open and ready */
operator|++
operator|(
name|pvrQwsDisplay
operator|.
name|refCount
operator|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsDisplayClose
name|void
name|pvrQwsDisplayClose
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|screen
decl_stmt|;
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|refCount
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|--
operator|(
name|pvrQwsDisplay
operator|.
name|refCount
operator|)
operator|>
literal|0
condition|)
return|return;
comment|/* Prevent pvrQwsDestroyContext from being called for the time being */
operator|++
name|pvrQwsDisplay
operator|.
name|numDrawables
expr_stmt|;
comment|/* Free the screens */
for|for
control|(
name|screen
operator|=
literal|0
init|;
name|screen
operator|<
name|PVRQWS_MAX_SCREENS
condition|;
operator|++
name|screen
control|)
block|{
name|PvrQwsScreenInfo
modifier|*
name|info
init|=
operator|&
operator|(
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|)
decl_stmt|;
if|if
condition|(
name|info
operator|->
name|screenDrawable
condition|)
name|pvrQwsDestroyDrawableForced
argument_list|(
name|info
operator|->
name|screenDrawable
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|frameBuffer
condition|)
name|PVR2DMemFree
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|info
operator|->
name|frameBuffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|mapped
operator|&&
name|info
operator|->
name|needsUnmap
condition|)
name|munmap
argument_list|(
name|info
operator|->
name|mapped
argument_list|,
name|info
operator|->
name|mappedLength
argument_list|)
expr_stmt|;
block|}
comment|/* Now it is safe to destroy the PVR2D context */
operator|--
name|pvrQwsDisplay
operator|.
name|numDrawables
expr_stmt|;
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|context
condition|)
name|PVR2DDestroyDeviceContext
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pvrQwsDisplay
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pvrQwsDisplay
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pvrQwsDisplayIsOpen
name|int
name|pvrQwsDisplayIsOpen
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|pvrQwsDisplay
operator|.
name|refCount
operator|>
literal|0
operator|)
return|;
block|}
end_function
begin_comment
comment|/* Ensure that a specific screen has been initialized */
end_comment
begin_function
DECL|function|pvrQwsEnsureScreen
specifier|static
name|int
name|pvrQwsEnsureScreen
parameter_list|(
name|int
name|screen
parameter_list|)
block|{
if|if
condition|(
name|screen
operator|<
literal|0
operator|||
name|screen
operator|>=
name|PVRQWS_MAX_SCREENS
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|screen
condition|)
return|return
literal|1
return|;
return|return
name|pvrQwsInitFbScreen
argument_list|(
name|screen
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsScreenWindow
name|PvrQwsDrawable
modifier|*
name|pvrQwsScreenWindow
parameter_list|(
name|int
name|screen
parameter_list|)
block|{
name|PvrQwsDrawable
modifier|*
name|drawable
decl_stmt|;
if|if
condition|(
operator|!
name|pvrQwsEnsureScreen
argument_list|(
name|screen
argument_list|)
condition|)
return|return
literal|0
return|;
name|drawable
operator|=
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenDrawable
expr_stmt|;
if|if
condition|(
name|drawable
condition|)
return|return
name|drawable
return|;
name|drawable
operator|=
operator|(
name|PvrQwsDrawable
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|PvrQwsDrawable
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drawable
condition|)
return|return
literal|0
return|;
name|drawable
operator|->
name|type
operator|=
name|PvrQwsScreen
expr_stmt|;
name|drawable
operator|->
name|screen
operator|=
name|screen
expr_stmt|;
name|drawable
operator|->
name|pixelFormat
operator|=
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|pixelFormat
expr_stmt|;
name|drawable
operator|->
name|rect
operator|=
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenRect
expr_stmt|;
name|drawable
operator|->
name|visibleRects
index|[
literal|0
index|]
operator|=
name|drawable
operator|->
name|rect
expr_stmt|;
name|drawable
operator|->
name|numVisibleRects
operator|=
literal|1
expr_stmt|;
name|drawable
operator|->
name|isFullScreen
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|pvrQwsAddDrawable
argument_list|()
condition|)
block|{
name|free
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|screenDrawable
operator|=
name|drawable
expr_stmt|;
return|return
name|drawable
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsCreateWindow
name|PvrQwsDrawable
modifier|*
name|pvrQwsCreateWindow
parameter_list|(
name|int
name|screen
parameter_list|,
name|long
name|winId
parameter_list|,
specifier|const
name|PvrQwsRect
modifier|*
name|rect
parameter_list|)
block|{
name|PvrQwsDrawable
modifier|*
name|drawable
decl_stmt|;
if|if
condition|(
operator|!
name|pvrQwsEnsureScreen
argument_list|(
name|screen
argument_list|)
condition|)
return|return
literal|0
return|;
name|drawable
operator|=
operator|(
name|PvrQwsDrawable
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|PvrQwsDrawable
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drawable
condition|)
return|return
literal|0
return|;
name|drawable
operator|->
name|type
operator|=
name|PvrQwsWindow
expr_stmt|;
name|drawable
operator|->
name|winId
operator|=
name|winId
expr_stmt|;
name|drawable
operator|->
name|refCount
operator|=
literal|1
expr_stmt|;
name|drawable
operator|->
name|screen
operator|=
name|screen
expr_stmt|;
name|drawable
operator|->
name|pixelFormat
operator|=
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|pixelFormat
expr_stmt|;
name|drawable
operator|->
name|rect
operator|=
operator|*
name|rect
expr_stmt|;
if|if
condition|(
operator|!
name|pvrQwsAddDrawable
argument_list|()
condition|)
block|{
name|free
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|drawable
operator|->
name|nextWinId
operator|=
name|pvrQwsDisplay
operator|.
name|firstWinId
expr_stmt|;
name|pvrQwsDisplay
operator|.
name|firstWinId
operator|=
name|drawable
expr_stmt|;
return|return
name|drawable
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsFetchWindow
name|PvrQwsDrawable
modifier|*
name|pvrQwsFetchWindow
parameter_list|(
name|long
name|winId
parameter_list|)
block|{
name|PvrQwsDrawable
modifier|*
name|drawable
init|=
name|pvrQwsDisplay
operator|.
name|firstWinId
decl_stmt|;
while|while
condition|(
name|drawable
operator|!=
literal|0
operator|&&
name|drawable
operator|->
name|winId
operator|!=
name|winId
condition|)
name|drawable
operator|=
name|drawable
operator|->
name|nextWinId
expr_stmt|;
if|if
condition|(
name|drawable
condition|)
operator|++
operator|(
name|drawable
operator|->
name|refCount
operator|)
expr_stmt|;
return|return
name|drawable
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsReleaseWindow
name|int
name|pvrQwsReleaseWindow
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
if|if
condition|(
name|drawable
operator|->
name|type
operator|==
name|PvrQwsWindow
condition|)
return|return
operator|(
operator|--
operator|(
name|drawable
operator|->
name|refCount
operator|)
operator|<=
literal|0
operator|)
return|;
else|else
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsCreatePixmap
name|PvrQwsDrawable
modifier|*
name|pvrQwsCreatePixmap
parameter_list|(
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|screen
parameter_list|)
block|{
name|PvrQwsDrawable
modifier|*
name|drawable
decl_stmt|;
if|if
condition|(
operator|!
name|pvrQwsEnsureScreen
argument_list|(
name|screen
argument_list|)
condition|)
return|return
literal|0
return|;
name|drawable
operator|=
operator|(
name|PvrQwsDrawable
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|PvrQwsDrawable
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drawable
condition|)
return|return
literal|0
return|;
name|drawable
operator|->
name|type
operator|=
name|PvrQwsPixmap
expr_stmt|;
name|drawable
operator|->
name|screen
operator|=
name|screen
expr_stmt|;
name|drawable
operator|->
name|pixelFormat
operator|=
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|screen
index|]
operator|.
name|pixelFormat
expr_stmt|;
name|drawable
operator|->
name|rect
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|drawable
operator|->
name|rect
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|drawable
operator|->
name|rect
operator|.
name|width
operator|=
name|width
expr_stmt|;
name|drawable
operator|->
name|rect
operator|.
name|height
operator|=
name|height
expr_stmt|;
if|if
condition|(
operator|!
name|pvrQwsAddDrawable
argument_list|()
condition|)
block|{
name|free
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|drawable
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsDestroyDrawableForced
specifier|static
name|void
name|pvrQwsDestroyDrawableForced
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
comment|/* Remove the drawable from the display's winId list */
name|PvrQwsDrawable
modifier|*
name|current
init|=
name|pvrQwsDisplay
operator|.
name|firstWinId
decl_stmt|;
name|PvrQwsDrawable
modifier|*
name|prev
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|current
operator|!=
literal|0
operator|&&
name|current
operator|!=
name|drawable
condition|)
block|{
name|prev
operator|=
name|current
expr_stmt|;
name|current
operator|=
name|current
operator|->
name|nextWinId
expr_stmt|;
block|}
if|if
condition|(
name|current
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|nextWinId
operator|=
name|current
operator|->
name|nextWinId
expr_stmt|;
else|else
name|pvrQwsDisplay
operator|.
name|firstWinId
operator|=
name|current
operator|->
name|nextWinId
expr_stmt|;
block|}
name|pvrQwsFreeBuffers
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
operator|--
name|pvrQwsDisplay
operator|.
name|numDrawables
expr_stmt|;
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|numDrawables
operator|==
literal|0
condition|)
name|pvrQwsDestroyContext
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pvrQwsDestroyDrawable
name|void
name|pvrQwsDestroyDrawable
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
if|if
condition|(
name|drawable
operator|&&
name|drawable
operator|->
name|type
operator|!=
name|PvrQwsScreen
condition|)
name|pvrQwsDestroyDrawableForced
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pvrQwsGetDrawableType
name|PvrQwsDrawableType
name|pvrQwsGetDrawableType
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
return|return
name|drawable
operator|->
name|type
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsSetVisibleRegion
name|void
name|pvrQwsSetVisibleRegion
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|,
specifier|const
name|PvrQwsRect
modifier|*
name|rects
parameter_list|,
name|int
name|numRects
parameter_list|)
block|{
name|int
name|index
decl_stmt|,
name|indexOut
decl_stmt|;
name|PvrQwsRect
modifier|*
name|rect
decl_stmt|;
name|PvrQwsRect
modifier|*
name|screenRect
decl_stmt|;
comment|/* Visible regions don't make sense for pixmaps */
if|if
condition|(
name|drawable
operator|->
name|type
operator|==
name|PvrQwsPixmap
condition|)
return|return;
comment|/* Restrict the number of rectangles to prevent buffer overflow */
if|if
condition|(
name|numRects
operator|>
name|PVRQWS_MAX_VISIBLE_RECTS
condition|)
name|numRects
operator|=
name|PVRQWS_MAX_VISIBLE_RECTS
expr_stmt|;
if|if
condition|(
name|numRects
operator|>
literal|0
condition|)
name|memcpy
argument_list|(
name|drawable
operator|->
name|visibleRects
argument_list|,
name|rects
argument_list|,
name|numRects
operator|*
sizeof|sizeof
argument_list|(
name|PvrQwsRect
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Convert the rectangles into screen-relative co-ordinates and        then clamp them to the screen boundaries.  If any of the        clamped rectangles are empty, remove them from the list */
name|screenRect
operator|=
operator|&
operator|(
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|drawable
operator|->
name|screen
index|]
operator|.
name|screenRect
operator|)
expr_stmt|;
name|indexOut
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|index
operator|=
literal|0
operator|,
name|rect
operator|=
name|drawable
operator|->
name|visibleRects
init|;
name|index
operator|<
name|numRects
condition|;
operator|++
name|index
operator|,
operator|++
name|rect
control|)
block|{
if|if
condition|(
name|rect
operator|->
name|x
operator|<
literal|0
condition|)
block|{
name|rect
operator|->
name|width
operator|+=
name|rect
operator|->
name|x
expr_stmt|;
name|rect
operator|->
name|x
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rect
operator|->
name|width
operator|<
literal|0
condition|)
name|rect
operator|->
name|width
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rect
operator|->
name|x
operator|>=
name|screenRect
operator|->
name|width
condition|)
block|{
name|rect
operator|->
name|x
operator|=
name|screenRect
operator|->
name|width
expr_stmt|;
name|rect
operator|->
name|width
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rect
operator|->
name|x
operator|+
name|rect
operator|->
name|width
operator|)
operator|>
name|screenRect
operator|->
name|width
condition|)
block|{
name|rect
operator|->
name|width
operator|=
name|screenRect
operator|->
name|width
operator|-
name|rect
operator|->
name|x
expr_stmt|;
block|}
if|if
condition|(
name|rect
operator|->
name|y
operator|<
literal|0
condition|)
block|{
name|rect
operator|->
name|height
operator|+=
name|rect
operator|->
name|y
expr_stmt|;
name|rect
operator|->
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rect
operator|->
name|height
operator|<
literal|0
condition|)
name|rect
operator|->
name|height
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rect
operator|->
name|y
operator|>=
name|screenRect
operator|->
name|height
condition|)
block|{
name|rect
operator|->
name|y
operator|=
name|screenRect
operator|->
name|height
expr_stmt|;
name|rect
operator|->
name|height
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rect
operator|->
name|y
operator|+
name|rect
operator|->
name|height
operator|)
operator|>
name|screenRect
operator|->
name|height
condition|)
block|{
name|rect
operator|->
name|height
operator|=
name|screenRect
operator|->
name|height
operator|-
name|rect
operator|->
name|y
expr_stmt|;
block|}
if|if
condition|(
name|rect
operator|->
name|width
operator|>
literal|0
operator|&&
name|rect
operator|->
name|height
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|index
operator|!=
name|indexOut
condition|)
name|drawable
operator|->
name|visibleRects
index|[
name|indexOut
index|]
operator|=
operator|*
name|rect
expr_stmt|;
operator|++
name|indexOut
expr_stmt|;
block|}
block|}
name|drawable
operator|->
name|numVisibleRects
operator|=
name|indexOut
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pvrQwsClearVisibleRegion
name|void
name|pvrQwsClearVisibleRegion
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
if|if
condition|(
name|drawable
operator|->
name|type
operator|!=
name|PvrQwsPixmap
condition|)
name|drawable
operator|->
name|numVisibleRects
operator|=
literal|0
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pvrQwsSetGeometry
name|void
name|pvrQwsSetGeometry
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|,
specifier|const
name|PvrQwsRect
modifier|*
name|rect
parameter_list|)
block|{
comment|/* We can only change the geometry of window drawables */
if|if
condition|(
name|drawable
operator|->
name|type
operator|!=
name|PvrQwsWindow
condition|)
return|return;
comment|/* If the position has changed, then clear the visible region */
if|if
condition|(
name|drawable
operator|->
name|rect
operator|.
name|x
operator|!=
name|rect
operator|->
name|x
operator|||
name|drawable
operator|->
name|rect
operator|.
name|y
operator|!=
name|rect
operator|->
name|y
condition|)
block|{
name|drawable
operator|->
name|rect
operator|.
name|x
operator|=
name|rect
operator|->
name|x
expr_stmt|;
name|drawable
operator|->
name|rect
operator|.
name|y
operator|=
name|rect
operator|->
name|y
expr_stmt|;
name|drawable
operator|->
name|numVisibleRects
operator|=
literal|0
expr_stmt|;
block|}
comment|/* If the size has changed, then clear the visible region and        invalidate the drawable's buffers.  Invalidating the buffers        will force EGL to recreate the drawable, which will then        allocate new buffers for the new size */
if|if
condition|(
name|drawable
operator|->
name|rect
operator|.
name|width
operator|!=
name|rect
operator|->
name|width
operator|||
name|drawable
operator|->
name|rect
operator|.
name|height
operator|!=
name|rect
operator|->
name|height
condition|)
block|{
name|drawable
operator|->
name|rect
operator|.
name|width
operator|=
name|rect
operator|->
name|width
expr_stmt|;
name|drawable
operator|->
name|rect
operator|.
name|height
operator|=
name|rect
operator|->
name|height
expr_stmt|;
name|drawable
operator|->
name|numVisibleRects
operator|=
literal|0
expr_stmt|;
name|pvrQwsInvalidateBuffers
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|pvrQwsGetGeometry
name|void
name|pvrQwsGetGeometry
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|,
name|PvrQwsRect
modifier|*
name|rect
parameter_list|)
block|{
operator|*
name|rect
operator|=
name|drawable
operator|->
name|rect
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pvrQwsSetRotation
name|void
name|pvrQwsSetRotation
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|,
name|int
name|angle
parameter_list|)
block|{
if|if
condition|(
name|drawable
operator|->
name|rotationAngle
operator|!=
name|angle
condition|)
block|{
name|drawable
operator|->
name|rotationAngle
operator|=
name|angle
expr_stmt|;
comment|/* Force the buffers to be recreated if the rotation angle changes */
name|pvrQwsInvalidateBuffers
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|pvrQwsGetStride
name|int
name|pvrQwsGetStride
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
if|if
condition|(
name|drawable
operator|->
name|backBuffersValid
condition|)
return|return
name|drawable
operator|->
name|strideBytes
return|;
else|else
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsGetPixelFormat
name|PvrQwsPixelFormat
name|pvrQwsGetPixelFormat
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
return|return
call|(
name|PvrQwsPixelFormat
call|)
argument_list|(
name|drawable
operator|->
name|pixelFormat
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsGetRenderBuffer
name|void
modifier|*
name|pvrQwsGetRenderBuffer
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
if|if
condition|(
name|drawable
operator|->
name|backBuffersValid
condition|)
return|return
name|drawable
operator|->
name|backBuffers
index|[
name|drawable
operator|->
name|currentBackBuffer
index|]
operator|->
name|pBase
return|;
else|else
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsAllocBuffers
name|int
name|pvrQwsAllocBuffers
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
name|int
name|index
decl_stmt|;
name|int
name|numBuffers
init|=
name|PVRQWS_MAX_BACK_BUFFERS
decl_stmt|;
if|if
condition|(
name|drawable
operator|->
name|type
operator|==
name|PvrQwsPixmap
condition|)
name|numBuffers
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|drawable
operator|->
name|backBuffers
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|drawable
operator|->
name|backBuffersValid
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|drawable
operator|->
name|usingFlipBuffers
condition|)
block|{
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|numBuffers
condition|;
operator|++
name|index
control|)
name|PVR2DMemFree
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|drawable
operator|->
name|backBuffers
index|[
name|index
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|drawable
operator|->
name|stridePixels
operator|=
operator|(
name|drawable
operator|->
name|rect
operator|.
name|width
operator|+
literal|31
operator|)
operator|&
operator|~
literal|31
expr_stmt|;
name|drawable
operator|->
name|strideBytes
operator|=
name|drawable
operator|->
name|stridePixels
operator|*
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|drawable
operator|->
name|screen
index|]
operator|.
name|bytesPerPixel
expr_stmt|;
name|drawable
operator|->
name|usingFlipBuffers
operator|=
operator|(
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
operator|>
literal|0
operator|&&
name|drawable
operator|->
name|isFullScreen
operator|)
expr_stmt|;
if|if
condition|(
name|drawable
operator|->
name|usingFlipBuffers
condition|)
block|{
if|if
condition|(
name|numBuffers
operator|>
call|(
name|int
call|)
argument_list|(
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
argument_list|)
condition|)
name|numBuffers
operator|=
name|pvrQwsDisplay
operator|.
name|numFlipBuffers
expr_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|numBuffers
condition|;
operator|++
name|index
control|)
name|drawable
operator|->
name|backBuffers
index|[
name|index
index|]
operator|=
name|pvrQwsDisplay
operator|.
name|flipBuffers
index|[
name|index
index|]
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|numBuffers
condition|;
operator|++
name|index
control|)
block|{
if|if
condition|(
name|PVR2DMemAlloc
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|drawable
operator|->
name|strideBytes
operator|*
name|drawable
operator|->
name|rect
operator|.
name|height
argument_list|,
literal|128
argument_list|,
literal|0
argument_list|,
operator|&
operator|(
name|drawable
operator|->
name|backBuffers
index|[
name|index
index|]
operator|)
argument_list|)
operator|!=
name|PVR2D_OK
condition|)
block|{
while|while
condition|(
operator|--
name|index
operator|>=
literal|0
condition|)
name|PVR2DMemFree
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|drawable
operator|->
name|backBuffers
index|[
name|index
index|]
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|drawable
operator|->
name|backBuffers
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|drawable
operator|->
name|backBuffers
argument_list|)
argument_list|)
expr_stmt|;
name|drawable
operator|->
name|backBuffersValid
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
for|for
control|(
name|index
operator|=
name|numBuffers
init|;
name|index
operator|<
name|PVRQWS_MAX_BACK_BUFFERS
condition|;
operator|++
name|index
control|)
block|{
name|drawable
operator|->
name|backBuffers
index|[
name|index
index|]
operator|=
name|drawable
operator|->
name|backBuffers
index|[
literal|0
index|]
expr_stmt|;
block|}
name|drawable
operator|->
name|backBuffersValid
operator|=
literal|1
expr_stmt|;
name|drawable
operator|->
name|currentBackBuffer
operator|=
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsFreeBuffers
name|void
name|pvrQwsFreeBuffers
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
name|int
name|index
decl_stmt|;
name|int
name|numBuffers
init|=
name|PVRQWS_MAX_BACK_BUFFERS
decl_stmt|;
if|if
condition|(
name|drawable
operator|->
name|type
operator|==
name|PvrQwsPixmap
condition|)
name|numBuffers
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|drawable
operator|->
name|usingFlipBuffers
condition|)
block|{
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|numBuffers
condition|;
operator|++
name|index
control|)
block|{
if|if
condition|(
name|drawable
operator|->
name|backBuffers
index|[
name|index
index|]
condition|)
name|PVR2DMemFree
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|drawable
operator|->
name|backBuffers
index|[
name|index
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|memset
argument_list|(
name|drawable
operator|->
name|backBuffers
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|drawable
operator|->
name|backBuffers
argument_list|)
argument_list|)
expr_stmt|;
name|drawable
operator|->
name|backBuffersValid
operator|=
literal|0
expr_stmt|;
name|drawable
operator|->
name|usingFlipBuffers
operator|=
literal|0
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pvrQwsInvalidateBuffers
name|void
name|pvrQwsInvalidateBuffers
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|)
block|{
name|drawable
operator|->
name|backBuffersValid
operator|=
literal|0
expr_stmt|;
block|}
end_function
begin_function
DECL|function|pvrQwsGetBuffers
name|int
name|pvrQwsGetBuffers
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|,
name|PVR2DMEMINFO
modifier|*
modifier|*
name|source
parameter_list|,
name|PVR2DMEMINFO
modifier|*
modifier|*
name|render
parameter_list|)
block|{
if|if
condition|(
operator|!
name|drawable
operator|->
name|backBuffersValid
condition|)
return|return
literal|0
return|;
operator|*
name|render
operator|=
name|drawable
operator|->
name|backBuffers
index|[
name|drawable
operator|->
name|currentBackBuffer
index|]
expr_stmt|;
operator|*
name|source
operator|=
name|drawable
operator|->
name|backBuffers
index|[
operator|(
name|drawable
operator|->
name|currentBackBuffer
operator|+
name|PVRQWS_MAX_BACK_BUFFERS
operator|-
literal|1
operator|)
operator|%
name|PVRQWS_MAX_BACK_BUFFERS
index|]
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsSwapBuffers
name|int
name|pvrQwsSwapBuffers
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|,
name|int
name|repaintOnly
parameter_list|)
block|{
name|PVR2DMEMINFO
modifier|*
name|buffer
decl_stmt|;
name|PvrQwsRect
modifier|*
name|rect
decl_stmt|;
name|int
name|index
decl_stmt|;
comment|/* Bail out if the back buffers have been invalidated */
if|if
condition|(
operator|!
name|drawable
operator|->
name|backBuffersValid
condition|)
return|return
literal|0
return|;
comment|/* If there is a swap function, then use that instead */
if|if
condition|(
name|drawable
operator|->
name|swapFunction
condition|)
block|{
operator|(
operator|*
operator|(
name|drawable
operator|->
name|swapFunction
operator|)
operator|)
operator|(
name|drawable
operator|,
name|drawable
operator|->
name|userData
operator|,
name|repaintOnly
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|repaintOnly
condition|)
block|{
name|drawable
operator|->
name|currentBackBuffer
operator|=
operator|(
name|drawable
operator|->
name|currentBackBuffer
operator|+
literal|1
operator|)
operator|%
name|PVRQWS_MAX_BACK_BUFFERS
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
comment|/* Iterate through the visible rectangles and blit them to the screen */
if|if
condition|(
operator|!
name|repaintOnly
condition|)
block|{
name|index
operator|=
name|drawable
operator|->
name|currentBackBuffer
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
operator|(
name|drawable
operator|->
name|currentBackBuffer
operator|+
name|PVRQWS_MAX_BACK_BUFFERS
operator|-
literal|1
operator|)
operator|%
name|PVRQWS_MAX_BACK_BUFFERS
expr_stmt|;
block|}
name|buffer
operator|=
name|drawable
operator|->
name|backBuffers
index|[
name|index
index|]
expr_stmt|;
name|rect
operator|=
name|drawable
operator|->
name|visibleRects
expr_stmt|;
if|if
condition|(
name|drawable
operator|->
name|usingFlipBuffers
condition|)
block|{
name|PVR2DPresentFlip
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|pvrQwsDisplay
operator|.
name|flipChain
argument_list|,
name|buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pvrQwsDisplay
operator|.
name|usePresentBlit
operator|&&
name|drawable
operator|->
name|numVisibleRects
operator|>
literal|0
condition|)
block|{
name|PVR2DRECT
name|pvrRects
index|[
name|PVRQWS_MAX_VISIBLE_RECTS
index|]
decl_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|drawable
operator|->
name|numVisibleRects
condition|;
operator|++
name|index
operator|,
operator|++
name|rect
control|)
block|{
name|pvrRects
index|[
name|index
index|]
operator|.
name|left
operator|=
name|rect
operator|->
name|x
expr_stmt|;
name|pvrRects
index|[
name|index
index|]
operator|.
name|top
operator|=
name|rect
operator|->
name|y
expr_stmt|;
name|pvrRects
index|[
name|index
index|]
operator|.
name|right
operator|=
name|rect
operator|->
name|x
operator|+
name|rect
operator|->
name|width
expr_stmt|;
name|pvrRects
index|[
name|index
index|]
operator|.
name|bottom
operator|=
name|rect
operator|->
name|y
operator|+
name|rect
operator|->
name|height
expr_stmt|;
block|}
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|drawable
operator|->
name|numVisibleRects
condition|;
name|index
operator|+=
literal|4
control|)
block|{
name|int
name|numClip
init|=
name|drawable
operator|->
name|numVisibleRects
operator|-
name|index
decl_stmt|;
if|if
condition|(
name|numClip
operator|>
literal|4
condition|)
comment|/* No more than 4 clip rects at a time */
name|numClip
operator|=
literal|4
expr_stmt|;
name|PVR2DSetPresentBltProperties
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|PVR2D_PRESENT_PROPERTY_SRCSTRIDE
operator||
name|PVR2D_PRESENT_PROPERTY_DSTSIZE
operator||
name|PVR2D_PRESENT_PROPERTY_DSTPOS
operator||
name|PVR2D_PRESENT_PROPERTY_CLIPRECTS
argument_list|,
name|drawable
operator|->
name|strideBytes
argument_list|,
name|drawable
operator|->
name|rect
operator|.
name|width
argument_list|,
name|drawable
operator|->
name|rect
operator|.
name|height
argument_list|,
name|drawable
operator|->
name|rect
operator|.
name|x
argument_list|,
name|drawable
operator|->
name|rect
operator|.
name|y
argument_list|,
name|numClip
argument_list|,
name|pvrRects
operator|+
name|index
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PVR2DPresentBlt
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|PVR2DQueryBlitsComplete
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
name|buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* TODO: use PVR2DBltClipped for faster transfers of clipped windows */
name|PVR2DBLTINFO
name|blit
decl_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|drawable
operator|->
name|numVisibleRects
condition|;
operator|++
name|index
operator|,
operator|++
name|rect
control|)
block|{
name|memset
argument_list|(
operator|&
name|blit
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|blit
argument_list|)
argument_list|)
expr_stmt|;
name|blit
operator|.
name|CopyCode
operator|=
name|PVR2DROPcopy
expr_stmt|;
name|blit
operator|.
name|BlitFlags
operator|=
name|PVR2D_BLIT_DISABLE_ALL
expr_stmt|;
name|blit
operator|.
name|pSrcMemInfo
operator|=
name|buffer
expr_stmt|;
name|blit
operator|.
name|SrcStride
operator|=
name|drawable
operator|->
name|strideBytes
expr_stmt|;
name|blit
operator|.
name|SrcX
operator|=
name|rect
operator|->
name|x
operator|-
name|drawable
operator|->
name|rect
operator|.
name|x
expr_stmt|;
name|blit
operator|.
name|SrcY
operator|=
name|rect
operator|->
name|y
operator|-
name|drawable
operator|->
name|rect
operator|.
name|y
expr_stmt|;
name|blit
operator|.
name|SizeX
operator|=
name|rect
operator|->
name|width
expr_stmt|;
name|blit
operator|.
name|SizeY
operator|=
name|rect
operator|->
name|height
expr_stmt|;
name|blit
operator|.
name|SrcFormat
operator|=
name|drawable
operator|->
name|pixelFormat
expr_stmt|;
name|blit
operator|.
name|pDstMemInfo
operator|=
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|drawable
operator|->
name|screen
index|]
operator|.
name|frameBuffer
expr_stmt|;
name|blit
operator|.
name|DstStride
operator|=
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|drawable
operator|->
name|screen
index|]
operator|.
name|screenStride
expr_stmt|;
name|blit
operator|.
name|DstX
operator|=
name|rect
operator|->
name|x
expr_stmt|;
name|blit
operator|.
name|DstY
operator|=
name|rect
operator|->
name|y
expr_stmt|;
name|blit
operator|.
name|DSizeX
operator|=
name|rect
operator|->
name|width
expr_stmt|;
name|blit
operator|.
name|DSizeY
operator|=
name|rect
operator|->
name|height
expr_stmt|;
name|blit
operator|.
name|DstFormat
operator|=
name|pvrQwsDisplay
operator|.
name|screens
index|[
name|drawable
operator|->
name|screen
index|]
operator|.
name|pixelFormat
expr_stmt|;
name|PVR2DBlt
argument_list|(
name|pvrQwsDisplay
operator|.
name|context
argument_list|,
operator|&
name|blit
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Swap the buffers */
if|if
condition|(
operator|!
name|repaintOnly
condition|)
block|{
name|drawable
operator|->
name|currentBackBuffer
operator|=
operator|(
name|drawable
operator|->
name|currentBackBuffer
operator|+
literal|1
operator|)
operator|%
name|PVRQWS_MAX_BACK_BUFFERS
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|pvrQwsSetSwapFunction
name|void
name|pvrQwsSetSwapFunction
parameter_list|(
name|PvrQwsDrawable
modifier|*
name|drawable
parameter_list|,
name|PvrQwsSwapFunction
name|func
parameter_list|,
name|void
modifier|*
name|userData
parameter_list|)
block|{
name|drawable
operator|->
name|swapFunction
operator|=
name|func
expr_stmt|;
name|drawable
operator|->
name|userData
operator|=
name|userData
expr_stmt|;
block|}
end_function
end_unit
