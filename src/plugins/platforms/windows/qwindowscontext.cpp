begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2013 Samuel Gaist<samuel.gaist@edeltech.ch> ** Copyright (C) 2014 Digia Plc and/or its subsidiary(-ies). ** Contact: http://www.qt-project.org/legal ** ** This file is part of the plugins of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** Commercial License Usage ** Licensees holding valid commercial Qt licenses may use this file in ** accordance with the commercial license agreement provided with the ** Software or, alternatively, in accordance with the terms contained in ** a written agreement between you and Digia.  For licensing terms and ** conditions see http://qt.digia.com/licensing.  For further information ** use the contact form at http://qt.digia.com/contact-us. ** ** GNU Lesser General Public License Usage ** Alternatively, this file may be used under the terms of the GNU Lesser ** General Public License version 2.1 as published by the Free Software ** Foundation and appearing in the file LICENSE.LGPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU Lesser General Public License version 2.1 requirements ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Digia gives you certain additional ** rights.  These rights are described in the Digia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU ** General Public License version 3.0 as published by the Free Software ** Foundation and appearing in the file LICENSE.GPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU General Public License version 3.0 requirements will be ** met: http://www.gnu.org/copyleft/gpl.html. ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"qwindowscontext.h"
end_include
begin_include
include|#
directive|include
file|"qwindowswindow.h"
end_include
begin_include
include|#
directive|include
file|"qwindowskeymapper.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsguieventdispatcher.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsmousehandler.h"
end_include
begin_include
include|#
directive|include
file|"qtwindowsglobal.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsmime.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsinputcontext.h"
end_include
begin_include
include|#
directive|include
file|"qwindowstabletsupport.h"
end_include
begin_include
include|#
directive|include
file|<private/qguiapplication_p.h>
end_include
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_ACCESSIBILITY
end_ifndef
begin_include
include|#
directive|include
file|"accessible/qwindowsaccessibility.h"
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|QT_NO_SESSIONMANAGER
argument_list|)
end_if
begin_include
include|#
directive|include
file|<private/qsessionmanager_p.h>
end_include
begin_include
include|#
directive|include
file|"qwindowssessionmanager.h"
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"qwindowsscreen.h"
end_include
begin_include
include|#
directive|include
file|"qwindowstheme.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsscaling.h"
end_include
begin_include
include|#
directive|include
file|<QtGui/QWindow>
end_include
begin_include
include|#
directive|include
file|<qpa/qwindowsysteminterface.h>
end_include
begin_include
include|#
directive|include
file|<qpa/qplatformnativeinterface.h>
end_include
begin_include
include|#
directive|include
file|<QtGui/QGuiApplication>
end_include
begin_include
include|#
directive|include
file|<QtCore/QSet>
end_include
begin_include
include|#
directive|include
file|<QtCore/QHash>
end_include
begin_include
include|#
directive|include
file|<QtCore/QStringList>
end_include
begin_include
include|#
directive|include
file|<QtCore/QDebug>
end_include
begin_include
include|#
directive|include
file|<QtCore/QSysInfo>
end_include
begin_include
include|#
directive|include
file|<QtCore/QScopedArrayPointer>
end_include
begin_include
include|#
directive|include
file|<QtCore/private/qsystemlibrary_p.h>
end_include
begin_include
include|#
directive|include
file|<stdlib.h>
end_include
begin_include
include|#
directive|include
file|<stdio.h>
end_include
begin_include
include|#
directive|include
file|<windowsx.h>
end_include
begin_ifndef
ifndef|#
directive|ifndef
name|Q_OS_WINCE
end_ifndef
begin_include
include|#
directive|include
file|<comdef.h>
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_decl_stmt
name|QT_BEGIN_NAMESPACE
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaWindows
argument_list|,
literal|"qt.qpa.windows"
argument_list|)
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaBackingStore
argument_list|,
literal|"qt.qpa.backingstore"
argument_list|)
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaEvents
argument_list|,
literal|"qt.qpa.events"
argument_list|)
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaFonts
argument_list|,
literal|"qt.qpa.fonts"
argument_list|)
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaGl
argument_list|,
literal|"qt.qpa.gl"
argument_list|)
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaMime
argument_list|,
literal|"qt.qpa.mime"
argument_list|)
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaInputMethods
argument_list|,
literal|"qt.qpa.input.methods"
argument_list|)
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaDialogs
argument_list|,
literal|"qt.qpa.dialogs"
argument_list|)
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaTablet
argument_list|,
literal|"qt.qpa.input.tablet"
argument_list|)
name|Q_LOGGING_CATEGORY
argument_list|(
name|lcQpaAccessibility
argument_list|,
literal|"qt.qpa.accessibility"
argument_list|)
DECL|member|verbose
name|int
name|QWindowsContext
operator|::
name|verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt
begin_comment
comment|// Get verbosity of components from "foo:2,bar:3"
end_comment
begin_function
DECL|function|componentVerbose
specifier|static
specifier|inline
name|int
name|componentVerbose
parameter_list|(
specifier|const
name|char
modifier|*
name|v
parameter_list|,
specifier|const
name|char
modifier|*
name|keyWord
parameter_list|)
block|{
if|if
condition|(
specifier|const
name|char
modifier|*
name|k
init|=
name|strstr
argument_list|(
name|v
argument_list|,
name|keyWord
argument_list|)
condition|)
block|{
name|k
operator|+=
name|qstrlen
argument_list|(
name|keyWord
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|k
operator|==
literal|':'
condition|)
block|{
operator|++
name|k
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|k
argument_list|)
condition|)
return|return
operator|*
name|k
operator|-
literal|'0'
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|hasTouchSupport
specifier|static
specifier|inline
name|bool
name|hasTouchSupport
parameter_list|(
name|QSysInfo
operator|::
name|WinVersion
name|wv
parameter_list|)
block|{
enum|enum
block|{
name|QT_SM_DIGITIZER
init|=
literal|94
block|,
name|QT_NID_INTEGRATED_TOUCH
init|=
literal|0x1
block|,
name|QT_NID_EXTERNAL_TOUCH
init|=
literal|0x02
block|,
name|QT_NID_MULTI_INPUT
init|=
literal|0x40
block|}
enum|;
return|return
name|wv
operator|<
name|QSysInfo
operator|::
name|WV_WINDOWS7
condition|?
literal|false
else|:
operator|(
name|GetSystemMetrics
argument_list|(
name|QT_SM_DIGITIZER
argument_list|)
operator|&
operator|(
name|QT_NID_INTEGRATED_TOUCH
operator||
name|QT_NID_EXTERNAL_TOUCH
operator||
name|QT_NID_MULTI_INPUT
operator|)
operator|)
operator|!=
literal|0
return|;
block|}
end_function
begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|LANG_SYRIAC
argument_list|)
end_if
begin_define
DECL|macro|LANG_SYRIAC
define|#
directive|define
name|LANG_SYRIAC
value|0x5a
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_function
DECL|function|useRTL_Extensions
specifier|static
specifier|inline
name|bool
name|useRTL_Extensions
parameter_list|(
name|QSysInfo
operator|::
name|WinVersion
name|ver
parameter_list|)
block|{
comment|// This is SDK dependent on CE so out of scope for now
if|if
condition|(
name|QSysInfo
operator|::
name|windowsVersion
argument_list|()
operator|&
name|QSysInfo
operator|::
name|WV_CE_based
condition|)
return|return
literal|false
return|;
if|if
condition|(
operator|(
name|ver
operator|&
name|QSysInfo
operator|::
name|WV_NT_based
operator|)
operator|&&
operator|(
name|ver
operator|>=
name|QSysInfo
operator|::
name|WV_VISTA
operator|)
condition|)
block|{
comment|// Since the IsValidLanguageGroup/IsValidLocale functions always return true on
comment|// Vista, check the Keyboard Layouts for enabling RTL.
if|if
condition|(
specifier|const
name|UINT
name|nLayouts
init|=
name|GetKeyboardLayoutList
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|QScopedArrayPointer
argument_list|<
name|HKL
argument_list|>
name|lpList
argument_list|(
operator|new
name|HKL
index|[
name|nLayouts
index|]
argument_list|)
decl_stmt|;
name|GetKeyboardLayoutList
argument_list|(
name|nLayouts
argument_list|,
name|lpList
operator|.
name|data
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|UINT
name|i
init|=
literal|0
init|;
name|i
operator|<
name|nLayouts
condition|;
operator|++
name|i
control|)
block|{
switch|switch
condition|(
name|PRIMARYLANGID
argument_list|(
operator|(
name|quintptr
operator|)
name|lpList
index|[
name|i
index|]
argument_list|)
condition|)
block|{
case|case
name|LANG_ARABIC
case|:
case|case
name|LANG_HEBREW
case|:
case|case
name|LANG_FARSI
case|:
case|case
name|LANG_SYRIAC
case|:
return|return
literal|true
return|;
default|default:
break|break;
block|}
block|}
block|}
return|return
literal|false
return|;
block|}
comment|// NT/Vista
ifndef|#
directive|ifndef
name|Q_OS_WINCE
comment|// Pre-NT: figure out whether a RTL language is installed
return|return
name|IsValidLanguageGroup
argument_list|(
name|LGRPID_ARABIC
argument_list|,
name|LGRPID_INSTALLED
argument_list|)
operator|||
name|IsValidLanguageGroup
argument_list|(
name|LGRPID_HEBREW
argument_list|,
name|LGRPID_INSTALLED
argument_list|)
operator|||
name|IsValidLocale
argument_list|(
name|MAKELCID
argument_list|(
name|MAKELANGID
argument_list|(
name|LANG_ARABIC
argument_list|,
name|SUBLANG_DEFAULT
argument_list|)
argument_list|,
name|SORT_DEFAULT
argument_list|)
argument_list|,
name|LCID_INSTALLED
argument_list|)
operator|||
name|IsValidLocale
argument_list|(
name|MAKELCID
argument_list|(
name|MAKELANGID
argument_list|(
name|LANG_HEBREW
argument_list|,
name|SUBLANG_DEFAULT
argument_list|)
argument_list|,
name|SORT_DEFAULT
argument_list|)
argument_list|,
name|LCID_INSTALLED
argument_list|)
operator|||
name|IsValidLocale
argument_list|(
name|MAKELCID
argument_list|(
name|MAKELANGID
argument_list|(
name|LANG_SYRIAC
argument_list|,
name|SUBLANG_DEFAULT
argument_list|)
argument_list|,
name|SORT_DEFAULT
argument_list|)
argument_list|,
name|LCID_INSTALLED
argument_list|)
operator|||
name|IsValidLocale
argument_list|(
name|MAKELCID
argument_list|(
name|MAKELANGID
argument_list|(
name|LANG_FARSI
argument_list|,
name|SUBLANG_DEFAULT
argument_list|)
argument_list|,
name|SORT_DEFAULT
argument_list|)
argument_list|,
name|LCID_INSTALLED
argument_list|)
return|;
else|#
directive|else
return|return
literal|false
return|;
endif|#
directive|endif
block|}
end_function
begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|QT_NO_SESSIONMANAGER
argument_list|)
end_if
begin_function
DECL|function|platformSessionManager
specifier|static
specifier|inline
name|QWindowsSessionManager
modifier|*
name|platformSessionManager
parameter_list|()
block|{
name|QGuiApplicationPrivate
modifier|*
name|guiPrivate
init|=
cast|static_cast
argument_list|<
name|QGuiApplicationPrivate
operator|*
argument_list|>
argument_list|(
name|QObjectPrivate
operator|::
name|get
argument_list|(
name|qApp
argument_list|)
argument_list|)
decl_stmt|;
name|QSessionManagerPrivate
modifier|*
name|managerPrivate
init|=
cast|static_cast
argument_list|<
name|QSessionManagerPrivate
operator|*
argument_list|>
argument_list|(
name|QObjectPrivate
operator|::
name|get
argument_list|(
name|guiPrivate
operator|->
name|session_manager
argument_list|)
argument_list|)
decl_stmt|;
return|return
cast|static_cast
argument_list|<
name|QWindowsSessionManager
operator|*
argument_list|>
argument_list|(
name|managerPrivate
operator|->
name|platformSessionManager
argument_list|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/*!     \class QWindowsUser32DLL     \brief Struct that contains dynamically resolved symbols of User32.dll.      The stub libraries shipped with the MinGW compiler miss some of the     functions. They need to be retrieved dynamically.      In addition, touch-related functions are available only from Windows onwards.     These need to resolved dynamically for Q_CC_MSVC as well.      \sa QWindowsShell32DLL      \internal     \ingroup qt-lighthouse-win */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|Q_OS_WINCE
end_ifndef
begin_constructor
DECL|function|QWindowsUser32DLL
name|QWindowsUser32DLL
operator|::
name|QWindowsUser32DLL
parameter_list|()
member_init_list|:
name|setLayeredWindowAttributes
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|updateLayeredWindow
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|updateLayeredWindowIndirect
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|isHungAppWindow
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|registerTouchWindow
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|unregisterTouchWindow
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|getTouchInputInfo
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|closeTouchInputHandle
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|setProcessDPIAware
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|addClipboardFormatListener
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|removeClipboardFormatListener
argument_list|(
literal|0
argument_list|)
block|{ }
end_constructor
begin_function
DECL|function|init
name|void
name|QWindowsUser32DLL
operator|::
name|init
parameter_list|()
block|{
name|QSystemLibrary
name|library
argument_list|(
name|QStringLiteral
argument_list|(
literal|"user32"
argument_list|)
argument_list|)
decl_stmt|;
comment|// MinGW (g++ 3.4.5) accepts only C casts.
name|setLayeredWindowAttributes
operator|=
call|(
name|SetLayeredWindowAttributes
call|)
argument_list|(
name|library
operator|.
name|resolve
argument_list|(
literal|"SetLayeredWindowAttributes"
argument_list|)
argument_list|)
expr_stmt|;
name|updateLayeredWindow
operator|=
call|(
name|UpdateLayeredWindow
call|)
argument_list|(
name|library
operator|.
name|resolve
argument_list|(
literal|"UpdateLayeredWindow"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|setLayeredWindowAttributes
operator|||
operator|!
name|updateLayeredWindow
condition|)
name|qFatal
argument_list|(
literal|"This version of Windows is not supported (User32.dll is missing the symbols 'SetLayeredWindowAttributes', 'UpdateLayeredWindow')."
argument_list|)
expr_stmt|;
name|updateLayeredWindowIndirect
operator|=
call|(
name|UpdateLayeredWindowIndirect
call|)
argument_list|(
name|library
operator|.
name|resolve
argument_list|(
literal|"UpdateLayeredWindowIndirect"
argument_list|)
argument_list|)
expr_stmt|;
name|isHungAppWindow
operator|=
operator|(
name|IsHungAppWindow
operator|)
name|library
operator|.
name|resolve
argument_list|(
literal|"IsHungAppWindow"
argument_list|)
expr_stmt|;
name|setProcessDPIAware
operator|=
operator|(
name|SetProcessDPIAware
operator|)
name|library
operator|.
name|resolve
argument_list|(
literal|"SetProcessDPIAware"
argument_list|)
expr_stmt|;
if|if
condition|(
name|QSysInfo
operator|::
name|windowsVersion
argument_list|()
operator|>=
name|QSysInfo
operator|::
name|WV_VISTA
condition|)
block|{
name|addClipboardFormatListener
operator|=
operator|(
name|AddClipboardFormatListener
operator|)
name|library
operator|.
name|resolve
argument_list|(
literal|"AddClipboardFormatListener"
argument_list|)
expr_stmt|;
name|removeClipboardFormatListener
operator|=
operator|(
name|RemoveClipboardFormatListener
operator|)
name|library
operator|.
name|resolve
argument_list|(
literal|"RemoveClipboardFormatListener"
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|initTouch
name|bool
name|QWindowsUser32DLL
operator|::
name|initTouch
parameter_list|()
block|{
name|QSystemLibrary
name|library
argument_list|(
name|QStringLiteral
argument_list|(
literal|"user32"
argument_list|)
argument_list|)
decl_stmt|;
name|registerTouchWindow
operator|=
call|(
name|RegisterTouchWindow
call|)
argument_list|(
name|library
operator|.
name|resolve
argument_list|(
literal|"RegisterTouchWindow"
argument_list|)
argument_list|)
expr_stmt|;
name|unregisterTouchWindow
operator|=
call|(
name|UnregisterTouchWindow
call|)
argument_list|(
name|library
operator|.
name|resolve
argument_list|(
literal|"UnregisterTouchWindow"
argument_list|)
argument_list|)
expr_stmt|;
name|getTouchInputInfo
operator|=
call|(
name|GetTouchInputInfo
call|)
argument_list|(
name|library
operator|.
name|resolve
argument_list|(
literal|"GetTouchInputInfo"
argument_list|)
argument_list|)
expr_stmt|;
name|closeTouchInputHandle
operator|=
call|(
name|CloseTouchInputHandle
call|)
argument_list|(
name|library
operator|.
name|resolve
argument_list|(
literal|"CloseTouchInputHandle"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|registerTouchWindow
operator|&&
name|unregisterTouchWindow
operator|&&
name|getTouchInputInfo
operator|&&
name|closeTouchInputHandle
return|;
block|}
end_function
begin_comment
comment|/*!     \class QWindowsShell32DLL     \brief Struct that contains dynamically resolved symbols of Shell32.dll.      The stub libraries shipped with the MinGW compiler miss some of the     functions. They need to be retrieved dynamically.      \sa QWindowsUser32DLL      \internal     \ingroup qt-lighthouse-win */
end_comment
begin_constructor
DECL|function|QWindowsShell32DLL
name|QWindowsShell32DLL
operator|::
name|QWindowsShell32DLL
parameter_list|()
member_init_list|:
name|sHCreateItemFromParsingName
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|sHGetStockIconInfo
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|sHGetImageList
argument_list|(
literal|0
argument_list|)
block|{ }
end_constructor
begin_function
DECL|function|init
name|void
name|QWindowsShell32DLL
operator|::
name|init
parameter_list|()
block|{
name|QSystemLibrary
name|library
argument_list|(
name|QStringLiteral
argument_list|(
literal|"shell32"
argument_list|)
argument_list|)
decl_stmt|;
name|sHCreateItemFromParsingName
operator|=
call|(
name|SHCreateItemFromParsingName
call|)
argument_list|(
name|library
operator|.
name|resolve
argument_list|(
literal|"SHCreateItemFromParsingName"
argument_list|)
argument_list|)
expr_stmt|;
name|sHGetStockIconInfo
operator|=
operator|(
name|SHGetStockIconInfo
operator|)
name|library
operator|.
name|resolve
argument_list|(
literal|"SHGetStockIconInfo"
argument_list|)
expr_stmt|;
name|sHGetImageList
operator|=
operator|(
name|SHGetImageList
operator|)
name|library
operator|.
name|resolve
argument_list|(
literal|"SHGetImageList"
argument_list|)
expr_stmt|;
block|}
end_function
begin_constructor
DECL|function|QWindowsShcoreDLL
name|QWindowsShcoreDLL
operator|::
name|QWindowsShcoreDLL
parameter_list|()
member_init_list|:
name|getProcessDpiAwareness
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|setProcessDpiAwareness
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|getDpiForMonitor
argument_list|(
literal|0
argument_list|)
block|{ }
end_constructor
begin_function
DECL|function|init
name|void
name|QWindowsShcoreDLL
operator|::
name|init
parameter_list|()
block|{
if|if
condition|(
name|QSysInfo
operator|::
name|windowsVersion
argument_list|()
operator|<
name|QSysInfo
operator|::
name|WV_WINDOWS8_1
condition|)
return|return;
name|QSystemLibrary
name|library
argument_list|(
name|QStringLiteral
argument_list|(
literal|"SHCore"
argument_list|)
argument_list|)
decl_stmt|;
name|getProcessDpiAwareness
operator|=
operator|(
name|GetProcessDpiAwareness
operator|)
name|library
operator|.
name|resolve
argument_list|(
literal|"GetProcessDpiAwareness"
argument_list|)
expr_stmt|;
name|setProcessDpiAwareness
operator|=
operator|(
name|SetProcessDpiAwareness
operator|)
name|library
operator|.
name|resolve
argument_list|(
literal|"SetProcessDpiAwareness"
argument_list|)
expr_stmt|;
name|getDpiForMonitor
operator|=
operator|(
name|GetDpiForMonitor
operator|)
name|library
operator|.
name|resolve
argument_list|(
literal|"GetDpiForMonitor"
argument_list|)
expr_stmt|;
block|}
end_function
begin_decl_stmt
DECL|member|user32dll
name|QWindowsUser32DLL
name|QWindowsContext
operator|::
name|user32dll
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|member|shell32dll
name|QWindowsShell32DLL
name|QWindowsContext
operator|::
name|shell32dll
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|member|shcoredll
name|QWindowsShcoreDLL
name|QWindowsContext
operator|::
name|shcoredll
decl_stmt|;
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !Q_OS_WINCE
end_comment
begin_decl_stmt
DECL|member|m_instance
name|QWindowsContext
modifier|*
name|QWindowsContext
operator|::
name|m_instance
init|=
literal|0
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*!     \class QWindowsContext     \brief Singleton container for all relevant information.      Holds state information formerly stored in \c qapplication_win.cpp.      \internal     \ingroup qt-lighthouse-win */
end_comment
begin_typedef
DECL|typedef|HandleBaseWindowHash
typedef|typedef
name|QHash
argument_list|<
name|HWND
argument_list|,
name|QWindowsWindow
modifier|*
argument_list|>
name|HandleBaseWindowHash
typedef|;
end_typedef
begin_struct
DECL|struct|QWindowsContextPrivate
struct|struct
name|QWindowsContextPrivate
block|{
name|QWindowsContextPrivate
parameter_list|()
constructor_decl|;
DECL|member|m_systemInfo
name|unsigned
name|m_systemInfo
decl_stmt|;
DECL|member|m_registeredWindowClassNames
name|QSet
argument_list|<
name|QString
argument_list|>
name|m_registeredWindowClassNames
decl_stmt|;
DECL|member|m_windows
name|HandleBaseWindowHash
name|m_windows
decl_stmt|;
DECL|member|m_displayContext
name|HDC
name|m_displayContext
decl_stmt|;
DECL|member|m_defaultDPI
name|int
name|m_defaultDPI
decl_stmt|;
DECL|member|m_keyMapper
name|QWindowsKeyMapper
name|m_keyMapper
decl_stmt|;
DECL|member|m_mouseHandler
name|QWindowsMouseHandler
name|m_mouseHandler
decl_stmt|;
DECL|member|m_mimeConverter
name|QWindowsMimeConverter
name|m_mimeConverter
decl_stmt|;
DECL|member|m_screenManager
name|QWindowsScreenManager
name|m_screenManager
decl_stmt|;
DECL|member|m_creationContext
name|QSharedPointer
argument_list|<
name|QWindowCreationContext
argument_list|>
name|m_creationContext
decl_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|QT_NO_TABLETEVENT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
DECL|member|m_tabletSupport
name|QScopedPointer
argument_list|<
name|QWindowsTabletSupport
argument_list|>
name|m_tabletSupport
decl_stmt|;
endif|#
directive|endif
DECL|member|m_oleInitializeResult
specifier|const
name|HRESULT
name|m_oleInitializeResult
decl_stmt|;
DECL|member|m_eventType
specifier|const
name|QByteArray
name|m_eventType
decl_stmt|;
DECL|member|m_lastActiveWindow
name|QWindow
modifier|*
name|m_lastActiveWindow
decl_stmt|;
DECL|member|m_asyncExpose
name|bool
name|m_asyncExpose
decl_stmt|;
block|}
struct|;
end_struct
begin_constructor
DECL|function|QWindowsContextPrivate
name|QWindowsContextPrivate
operator|::
name|QWindowsContextPrivate
parameter_list|()
member_init_list|:
name|m_systemInfo
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|m_oleInitializeResult
argument_list|(
name|OleInitialize
argument_list|(
name|NULL
argument_list|)
argument_list|)
member_init_list|,
name|m_eventType
argument_list|(
name|QByteArrayLiteral
argument_list|(
literal|"windows_generic_MSG"
argument_list|)
argument_list|)
member_init_list|,
name|m_lastActiveWindow
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|m_asyncExpose
argument_list|(
literal|0
argument_list|)
block|{
specifier|const
name|QSysInfo
operator|::
name|WinVersion
name|ver
init|=
name|QSysInfo
operator|::
name|windowsVersion
argument_list|()
decl_stmt|;
ifndef|#
directive|ifndef
name|Q_OS_WINCE
name|QWindowsContext
operator|::
name|user32dll
operator|.
name|init
argument_list|()
expr_stmt|;
name|QWindowsContext
operator|::
name|shell32dll
operator|.
name|init
argument_list|()
expr_stmt|;
name|QWindowsContext
operator|::
name|shcoredll
operator|.
name|init
argument_list|()
expr_stmt|;
if|if
condition|(
name|hasTouchSupport
argument_list|(
name|ver
argument_list|)
operator|&&
name|QWindowsContext
operator|::
name|user32dll
operator|.
name|initTouch
argument_list|()
condition|)
name|m_systemInfo
operator||=
name|QWindowsContext
operator|::
name|SI_SupportsTouch
expr_stmt|;
endif|#
directive|endif
comment|// !Q_OS_WINCE
name|m_displayContext
operator|=
name|GetDC
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|m_defaultDPI
operator|=
name|GetDeviceCaps
argument_list|(
name|m_displayContext
argument_list|,
name|LOGPIXELSY
argument_list|)
expr_stmt|;
if|if
condition|(
name|useRTL_Extensions
argument_list|(
name|ver
argument_list|)
condition|)
block|{
name|m_systemInfo
operator||=
name|QWindowsContext
operator|::
name|SI_RTL_Extensions
expr_stmt|;
name|m_keyMapper
operator|.
name|setUseRTLExtensions
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FAILED
argument_list|(
name|m_oleInitializeResult
argument_list|)
condition|)
block|{
name|qWarning
argument_list|()
operator|<<
literal|"QWindowsContext: OleInitialize() failed: "
operator|<<
name|QWindowsContext
operator|::
name|comErrorString
argument_list|(
name|m_oleInitializeResult
argument_list|)
expr_stmt|;
block|}
block|}
end_constructor
begin_constructor
DECL|function|QWindowsContext
name|QWindowsContext
operator|::
name|QWindowsContext
parameter_list|()
member_init_list|:
name|d
argument_list|(
operator|new
name|QWindowsContextPrivate
argument_list|)
block|{
ifdef|#
directive|ifdef
name|Q_CC_MSVC
pragma|#
directive|pragma
name|warning
name|(
name|disable
name|:
name|4996
name|)
endif|#
directive|endif
name|m_instance
operator|=
name|this
expr_stmt|;
comment|// ### FIXME: Remove this once the logging system has other options of configurations.
specifier|const
name|QByteArray
name|bv
init|=
name|qgetenv
argument_list|(
literal|"QT_QPA_VERBOSE"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|bv
operator|.
name|isEmpty
argument_list|()
condition|)
name|QLoggingCategory
operator|::
name|setFilterRules
argument_list|(
name|QString
operator|::
name|fromLocal8Bit
argument_list|(
name|bv
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|QT_NO_TABLETEVENT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
name|d
operator|->
name|m_tabletSupport
operator|.
name|reset
argument_list|(
name|QWindowsTabletSupport
operator|::
name|create
argument_list|()
argument_list|)
expr_stmt|;
name|qCDebug
argument_list|(
name|lcQpaTablet
argument_list|)
operator|<<
literal|"Tablet support: "
operator|<<
operator|(
name|d
operator|->
name|m_tabletSupport
operator|.
name|isNull
argument_list|()
condition|?
name|QStringLiteral
argument_list|(
literal|"None"
argument_list|)
else|:
name|d
operator|->
name|m_tabletSupport
operator|->
name|description
argument_list|()
operator|)
expr_stmt|;
endif|#
directive|endif
block|}
end_constructor
begin_destructor
DECL|function|~QWindowsContext
name|QWindowsContext
operator|::
name|~
name|QWindowsContext
parameter_list|()
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|QT_NO_TABLETEVENT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
name|d
operator|->
name|m_tabletSupport
operator|.
name|reset
argument_list|()
expr_stmt|;
comment|// Destroy internal window before unregistering classes.
endif|#
directive|endif
name|unregisterWindowClasses
argument_list|()
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|m_oleInitializeResult
operator|==
name|S_OK
operator|||
name|d
operator|->
name|m_oleInitializeResult
operator|==
name|S_FALSE
condition|)
name|OleUninitialize
argument_list|()
expr_stmt|;
name|d
operator|->
name|m_screenManager
operator|.
name|clearScreens
argument_list|()
expr_stmt|;
comment|// Order: Potentially calls back to the windows.
name|m_instance
operator|=
literal|0
expr_stmt|;
block|}
end_destructor
begin_function
DECL|function|setTabletAbsoluteRange
name|void
name|QWindowsContext
operator|::
name|setTabletAbsoluteRange
parameter_list|(
name|int
name|a
parameter_list|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|QT_NO_TABLETEVENT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
if|if
condition|(
operator|!
name|d
operator|->
name|m_tabletSupport
operator|.
name|isNull
argument_list|()
condition|)
name|d
operator|->
name|m_tabletSupport
operator|->
name|setAbsoluteRange
argument_list|(
name|a
argument_list|)
expr_stmt|;
else|#
directive|else
name|Q_UNUSED
argument_list|(
argument|a
argument_list|)
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|setProcessDpiAwareness
name|void
name|QWindowsContext
operator|::
name|setProcessDpiAwareness
parameter_list|(
name|QtWindows
operator|::
name|ProcessDpiAwareness
name|dpiAwareness
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|Q_OS_WINCE
name|qCDebug
argument_list|(
name|lcQpaWindows
argument_list|)
operator|<<
name|__FUNCTION__
operator|<<
name|dpiAwareness
expr_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|shcoredll
operator|.
name|isValid
argument_list|()
condition|)
block|{
specifier|const
name|HRESULT
name|hr
init|=
name|QWindowsContext
operator|::
name|shcoredll
operator|.
name|setProcessDpiAwareness
argument_list|(
name|dpiAwareness
argument_list|)
decl_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
name|qWarning
argument_list|()
operator|<<
literal|"SetProcessDpiAwareness failed:"
operator|<<
name|QWindowsContext
operator|::
name|comErrorString
argument_list|(
name|hr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dpiAwareness
operator|!=
name|QtWindows
operator|::
name|ProcessDpiUnaware
operator|&&
name|QWindowsContext
operator|::
name|user32dll
operator|.
name|setProcessDPIAware
condition|)
block|{
if|if
condition|(
operator|!
name|QWindowsContext
operator|::
name|user32dll
operator|.
name|setProcessDPIAware
argument_list|()
condition|)
name|qErrnoWarning
argument_list|(
literal|"SetProcessDPIAware() failed"
argument_list|)
expr_stmt|;
block|}
block|}
else|#
directive|else
comment|// !Q_OS_WINCE
name|Q_UNUSED
argument_list|(
argument|dpiAwareness
argument_list|)
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|instance
name|QWindowsContext
modifier|*
name|QWindowsContext
operator|::
name|instance
parameter_list|()
block|{
return|return
name|m_instance
return|;
block|}
end_function
begin_function
DECL|function|systemInfo
name|unsigned
name|QWindowsContext
operator|::
name|systemInfo
parameter_list|()
specifier|const
block|{
return|return
name|d
operator|->
name|m_systemInfo
return|;
block|}
end_function
begin_function
DECL|function|useRTLExtensions
name|bool
name|QWindowsContext
operator|::
name|useRTLExtensions
parameter_list|()
specifier|const
block|{
return|return
name|d
operator|->
name|m_keyMapper
operator|.
name|useRTLExtensions
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|possibleKeys
name|QList
argument_list|<
name|int
argument_list|>
name|QWindowsContext
operator|::
name|possibleKeys
parameter_list|(
specifier|const
name|QKeyEvent
modifier|*
name|e
parameter_list|)
specifier|const
block|{
return|return
name|d
operator|->
name|m_keyMapper
operator|.
name|possibleKeys
argument_list|(
name|e
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|setWindowCreationContext
name|void
name|QWindowsContext
operator|::
name|setWindowCreationContext
parameter_list|(
specifier|const
name|QSharedPointer
argument_list|<
name|QWindowCreationContext
argument_list|>
modifier|&
name|ctx
parameter_list|)
block|{
name|d
operator|->
name|m_creationContext
operator|=
name|ctx
expr_stmt|;
block|}
end_function
begin_function
DECL|function|defaultDPI
name|int
name|QWindowsContext
operator|::
name|defaultDPI
parameter_list|()
specifier|const
block|{
return|return
name|d
operator|->
name|m_defaultDPI
return|;
block|}
end_function
begin_function
DECL|function|displayContext
name|HDC
name|QWindowsContext
operator|::
name|displayContext
parameter_list|()
specifier|const
block|{
return|return
name|d
operator|->
name|m_displayContext
return|;
block|}
end_function
begin_function
DECL|function|keyGrabber
name|QWindow
modifier|*
name|QWindowsContext
operator|::
name|keyGrabber
parameter_list|()
specifier|const
block|{
return|return
name|d
operator|->
name|m_keyMapper
operator|.
name|keyGrabber
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|setKeyGrabber
name|void
name|QWindowsContext
operator|::
name|setKeyGrabber
parameter_list|(
name|QWindow
modifier|*
name|w
parameter_list|)
block|{
name|d
operator|->
name|m_keyMapper
operator|.
name|setKeyGrabber
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// Window class registering code (from qapplication_win.cpp)
end_comment
begin_function
DECL|function|registerWindowClass
name|QString
name|QWindowsContext
operator|::
name|registerWindowClass
parameter_list|(
specifier|const
name|QWindow
modifier|*
name|w
parameter_list|,
name|bool
name|isGL
parameter_list|)
block|{
name|Q_ASSERT
argument_list|(
name|w
argument_list|)
expr_stmt|;
specifier|const
name|Qt
operator|::
name|WindowFlags
name|flags
init|=
name|w
operator|->
name|flags
argument_list|()
decl_stmt|;
specifier|const
name|Qt
operator|::
name|WindowFlags
name|type
init|=
name|flags
operator|&
name|Qt
operator|::
name|WindowType_Mask
decl_stmt|;
comment|// Determine style and icon.
name|uint
name|style
init|=
name|CS_DBLCLKS
decl_stmt|;
name|bool
name|icon
init|=
literal|true
decl_stmt|;
if|if
condition|(
name|isGL
operator|||
operator|(
name|flags
operator|&
name|Qt
operator|::
name|MSWindowsOwnDC
operator|)
condition|)
name|style
operator||=
name|CS_OWNDC
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|Qt
operator|::
name|NoDropShadowWindowHint
operator|)
operator|&&
operator|(
name|QSysInfo
operator|::
name|WindowsVersion
operator|&
name|QSysInfo
operator|::
name|WV_NT_based
operator|)
operator|&&
operator|(
name|type
operator|==
name|Qt
operator|::
name|Popup
operator|||
name|w
operator|->
name|property
argument_list|(
literal|"_q_windowsDropShadow"
argument_list|)
operator|.
name|toBool
argument_list|()
operator|)
condition|)
block|{
name|style
operator||=
name|CS_DROPSHADOW
expr_stmt|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|Qt
operator|::
name|Tool
case|:
case|case
name|Qt
operator|::
name|ToolTip
case|:
case|case
name|Qt
operator|::
name|Popup
case|:
name|style
operator||=
name|CS_SAVEBITS
expr_stmt|;
comment|// Save/restore background
name|icon
operator|=
literal|false
expr_stmt|;
break|break;
case|case
name|Qt
operator|::
name|Dialog
case|:
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|Qt
operator|::
name|WindowSystemMenuHint
operator|)
condition|)
name|icon
operator|=
literal|false
expr_stmt|;
comment|// QTBUG-2027, dialogs without system menu.
break|break;
block|}
comment|// Create a unique name for the flag combination
name|QString
name|cname
init|=
name|QStringLiteral
argument_list|(
literal|"Qt5QWindow"
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|Qt
operator|::
name|Tool
case|:
name|cname
operator|+=
name|QStringLiteral
argument_list|(
literal|"Tool"
argument_list|)
expr_stmt|;
break|break;
case|case
name|Qt
operator|::
name|ToolTip
case|:
name|cname
operator|+=
name|QStringLiteral
argument_list|(
literal|"ToolTip"
argument_list|)
expr_stmt|;
break|break;
case|case
name|Qt
operator|::
name|Popup
case|:
name|cname
operator|+=
name|QStringLiteral
argument_list|(
literal|"Popup"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|isGL
condition|)
name|cname
operator|+=
name|QStringLiteral
argument_list|(
literal|"GL"
argument_list|)
expr_stmt|;
if|if
condition|(
name|style
operator|&
name|CS_DROPSHADOW
condition|)
name|cname
operator|+=
name|QStringLiteral
argument_list|(
literal|"DropShadow"
argument_list|)
expr_stmt|;
if|if
condition|(
name|style
operator|&
name|CS_SAVEBITS
condition|)
name|cname
operator|+=
name|QStringLiteral
argument_list|(
literal|"SaveBits"
argument_list|)
expr_stmt|;
if|if
condition|(
name|style
operator|&
name|CS_OWNDC
condition|)
name|cname
operator|+=
name|QStringLiteral
argument_list|(
literal|"OwnDC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|icon
condition|)
name|cname
operator|+=
name|QStringLiteral
argument_list|(
literal|"Icon"
argument_list|)
expr_stmt|;
return|return
name|registerWindowClass
argument_list|(
name|cname
argument_list|,
name|qWindowsWndProc
argument_list|,
name|style
argument_list|,
name|GetSysColorBrush
argument_list|(
name|COLOR_WINDOW
argument_list|)
argument_list|,
name|icon
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|registerWindowClass
name|QString
name|QWindowsContext
operator|::
name|registerWindowClass
parameter_list|(
name|QString
name|cname
parameter_list|,
name|WNDPROC
name|proc
parameter_list|,
name|unsigned
name|style
parameter_list|,
name|HBRUSH
name|brush
parameter_list|,
name|bool
name|icon
parameter_list|)
block|{
comment|// since multiple Qt versions can be used in one process
comment|// each one has to have window class names with a unique name
comment|// The first instance gets the unmodified name; if the class
comment|// has already been registered by another instance of Qt then
comment|// add an instance-specific ID, the address of the window proc.
specifier|static
name|int
name|classExists
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|HINSTANCE
name|appInstance
init|=
operator|(
name|HINSTANCE
operator|)
name|GetModuleHandle
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|classExists
operator|==
operator|-
literal|1
condition|)
block|{
name|WNDCLASS
name|wcinfo
decl_stmt|;
name|classExists
operator|=
name|GetClassInfo
argument_list|(
name|appInstance
argument_list|,
operator|(
name|wchar_t
operator|*
operator|)
name|cname
operator|.
name|utf16
argument_list|()
argument_list|,
operator|&
name|wcinfo
argument_list|)
expr_stmt|;
name|classExists
operator|=
name|classExists
operator|&&
name|wcinfo
operator|.
name|lpfnWndProc
operator|!=
name|proc
expr_stmt|;
block|}
if|if
condition|(
name|classExists
condition|)
name|cname
operator|+=
name|QString
operator|::
name|number
argument_list|(
operator|(
name|quintptr
operator|)
name|proc
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|m_registeredWindowClassNames
operator|.
name|contains
argument_list|(
name|cname
argument_list|)
condition|)
comment|// already registered in our list
return|return
name|cname
return|;
ifndef|#
directive|ifndef
name|Q_OS_WINCE
name|WNDCLASSEX
name|wc
decl_stmt|;
name|wc
operator|.
name|cbSize
operator|=
sizeof|sizeof
argument_list|(
name|WNDCLASSEX
argument_list|)
expr_stmt|;
else|#
directive|else
name|WNDCLASS
name|wc
decl_stmt|;
endif|#
directive|endif
name|wc
operator|.
name|style
operator|=
name|style
expr_stmt|;
name|wc
operator|.
name|lpfnWndProc
operator|=
name|proc
expr_stmt|;
name|wc
operator|.
name|cbClsExtra
operator|=
literal|0
expr_stmt|;
name|wc
operator|.
name|cbWndExtra
operator|=
literal|0
expr_stmt|;
name|wc
operator|.
name|hInstance
operator|=
name|appInstance
expr_stmt|;
name|wc
operator|.
name|hCursor
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|Q_OS_WINCE
name|wc
operator|.
name|hbrBackground
operator|=
name|brush
expr_stmt|;
if|if
condition|(
name|icon
condition|)
block|{
name|wc
operator|.
name|hIcon
operator|=
operator|(
name|HICON
operator|)
name|LoadImage
argument_list|(
name|appInstance
argument_list|,
literal|L"IDI_ICON1"
argument_list|,
name|IMAGE_ICON
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LR_DEFAULTSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wc
operator|.
name|hIcon
condition|)
block|{
name|int
name|sw
init|=
name|GetSystemMetrics
argument_list|(
name|SM_CXSMICON
argument_list|)
decl_stmt|;
name|int
name|sh
init|=
name|GetSystemMetrics
argument_list|(
name|SM_CYSMICON
argument_list|)
decl_stmt|;
name|wc
operator|.
name|hIconSm
operator|=
operator|(
name|HICON
operator|)
name|LoadImage
argument_list|(
name|appInstance
argument_list|,
literal|L"IDI_ICON1"
argument_list|,
name|IMAGE_ICON
argument_list|,
name|sw
argument_list|,
name|sh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wc
operator|.
name|hIcon
operator|=
operator|(
name|HICON
operator|)
name|LoadImage
argument_list|(
literal|0
argument_list|,
name|IDI_APPLICATION
argument_list|,
name|IMAGE_ICON
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LR_DEFAULTSIZE
operator||
name|LR_SHARED
argument_list|)
expr_stmt|;
name|wc
operator|.
name|hIconSm
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|wc
operator|.
name|hIcon
operator|=
literal|0
expr_stmt|;
name|wc
operator|.
name|hIconSm
operator|=
literal|0
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|icon
condition|)
block|{
name|wc
operator|.
name|hIcon
operator|=
operator|(
name|HICON
operator|)
name|LoadImage
argument_list|(
name|appInstance
argument_list|,
literal|L"IDI_ICON1"
argument_list|,
name|IMAGE_ICON
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LR_DEFAULTSIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wc
operator|.
name|hIcon
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
name|wc
operator|.
name|lpszMenuName
operator|=
literal|0
expr_stmt|;
name|wc
operator|.
name|lpszClassName
operator|=
operator|(
name|wchar_t
operator|*
operator|)
name|cname
operator|.
name|utf16
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|Q_OS_WINCE
name|ATOM
name|atom
init|=
name|RegisterClassEx
argument_list|(
operator|&
name|wc
argument_list|)
decl_stmt|;
else|#
directive|else
name|ATOM
name|atom
init|=
name|RegisterClass
argument_list|(
operator|&
name|wc
argument_list|)
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|atom
condition|)
name|qErrnoWarning
argument_list|(
literal|"QApplication::regClass: Registering window class '%s' failed."
argument_list|,
name|qPrintable
argument_list|(
name|cname
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|m_registeredWindowClassNames
operator|.
name|insert
argument_list|(
name|cname
argument_list|)
expr_stmt|;
name|qCDebug
argument_list|(
name|lcQpaWindows
argument_list|)
operator|.
name|nospace
argument_list|()
operator|<<
name|__FUNCTION__
operator|<<
literal|' '
operator|<<
name|cname
operator|<<
literal|" style=0x"
operator|<<
name|QString
operator|::
name|number
argument_list|(
name|style
argument_list|,
literal|16
argument_list|)
operator|<<
literal|" brush="
operator|<<
name|brush
operator|<<
literal|" icon="
operator|<<
name|icon
operator|<<
literal|" atom="
operator|<<
name|atom
expr_stmt|;
return|return
name|cname
return|;
block|}
end_function
begin_function
DECL|function|unregisterWindowClasses
name|void
name|QWindowsContext
operator|::
name|unregisterWindowClasses
parameter_list|()
block|{
specifier|const
name|HINSTANCE
name|appInstance
init|=
operator|(
name|HINSTANCE
operator|)
name|GetModuleHandle
argument_list|(
literal|0
argument_list|)
decl_stmt|;
foreach|foreach
control|(
specifier|const
name|QString
modifier|&
name|name
decl|,
name|d
operator|->
name|m_registeredWindowClassNames
control|)
block|{
if|if
condition|(
operator|!
name|UnregisterClass
argument_list|(
operator|(
name|wchar_t
operator|*
operator|)
name|name
operator|.
name|utf16
argument_list|()
argument_list|,
name|appInstance
argument_list|)
operator|&&
name|QWindowsContext
operator|::
name|verbose
condition|)
name|qErrnoWarning
argument_list|(
literal|"UnregisterClass failed for '%s'"
argument_list|,
name|qPrintable
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|d
operator|->
name|m_registeredWindowClassNames
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|screenDepth
name|int
name|QWindowsContext
operator|::
name|screenDepth
parameter_list|()
specifier|const
block|{
return|return
name|GetDeviceCaps
argument_list|(
name|d
operator|->
name|m_displayContext
argument_list|,
name|BITSPIXEL
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|windowsErrorMessage
name|QString
name|QWindowsContext
operator|::
name|windowsErrorMessage
parameter_list|(
name|unsigned
name|long
name|errorCode
parameter_list|)
block|{
name|QString
name|rc
init|=
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"#%1: "
argument_list|)
operator|.
name|arg
argument_list|(
name|errorCode
argument_list|)
decl_stmt|;
name|ushort
modifier|*
name|lpMsgBuf
decl_stmt|;
specifier|const
name|int
name|len
init|=
name|FormatMessage
argument_list|(
name|FORMAT_MESSAGE_ALLOCATE_BUFFER
operator||
name|FORMAT_MESSAGE_FROM_SYSTEM
operator||
name|FORMAT_MESSAGE_IGNORE_INSERTS
argument_list|,
name|NULL
argument_list|,
name|errorCode
argument_list|,
literal|0
argument_list|,
operator|(
name|LPTSTR
operator|)
operator|&
name|lpMsgBuf
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
condition|)
block|{
name|rc
operator|=
name|QString
operator|::
name|fromUtf16
argument_list|(
name|lpMsgBuf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|LocalFree
argument_list|(
name|lpMsgBuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|+=
name|QString
operator|::
name|fromLatin1
argument_list|(
literal|"<unknown error>"
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function
begin_function
DECL|function|addWindow
name|void
name|QWindowsContext
operator|::
name|addWindow
parameter_list|(
name|HWND
name|hwnd
parameter_list|,
name|QWindowsWindow
modifier|*
name|w
parameter_list|)
block|{
name|d
operator|->
name|m_windows
operator|.
name|insert
argument_list|(
name|hwnd
argument_list|,
name|w
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|removeWindow
name|void
name|QWindowsContext
operator|::
name|removeWindow
parameter_list|(
name|HWND
name|hwnd
parameter_list|)
block|{
specifier|const
name|HandleBaseWindowHash
operator|::
name|iterator
name|it
init|=
name|d
operator|->
name|m_windows
operator|.
name|find
argument_list|(
name|hwnd
argument_list|)
decl_stmt|;
if|if
condition|(
name|it
operator|!=
name|d
operator|->
name|m_windows
operator|.
name|end
argument_list|()
condition|)
block|{
if|if
condition|(
name|d
operator|->
name|m_keyMapper
operator|.
name|keyGrabber
argument_list|()
operator|==
name|it
operator|.
name|value
argument_list|()
operator|->
name|window
argument_list|()
condition|)
name|d
operator|->
name|m_keyMapper
operator|.
name|setKeyGrabber
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|d
operator|->
name|m_windows
operator|.
name|erase
argument_list|(
name|it
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|findPlatformWindow
name|QWindowsWindow
modifier|*
name|QWindowsContext
operator|::
name|findPlatformWindow
parameter_list|(
name|HWND
name|hwnd
parameter_list|)
specifier|const
block|{
return|return
name|d
operator|->
name|m_windows
operator|.
name|value
argument_list|(
name|hwnd
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|findClosestPlatformWindow
name|QWindowsWindow
modifier|*
name|QWindowsContext
operator|::
name|findClosestPlatformWindow
parameter_list|(
name|HWND
name|hwnd
parameter_list|)
specifier|const
block|{
name|QWindowsWindow
modifier|*
name|window
init|=
name|d
operator|->
name|m_windows
operator|.
name|value
argument_list|(
name|hwnd
argument_list|)
decl_stmt|;
comment|// Requested hwnd may also be a child of a platform window in case of embedded native windows.
comment|// Find the closest parent that has a platform window.
if|if
condition|(
operator|!
name|window
condition|)
block|{
for|for
control|(
name|HWND
name|w
init|=
name|hwnd
init|;
name|w
condition|;
name|w
operator|=
name|GetParent
argument_list|(
name|w
argument_list|)
control|)
block|{
name|window
operator|=
name|d
operator|->
name|m_windows
operator|.
name|value
argument_list|(
name|w
argument_list|)
expr_stmt|;
if|if
condition|(
name|window
condition|)
break|break;
block|}
block|}
return|return
name|window
return|;
block|}
end_function
begin_function
DECL|function|findWindow
name|QWindow
modifier|*
name|QWindowsContext
operator|::
name|findWindow
parameter_list|(
name|HWND
name|hwnd
parameter_list|)
specifier|const
block|{
if|if
condition|(
specifier|const
name|QWindowsWindow
modifier|*
name|bw
init|=
name|findPlatformWindow
argument_list|(
name|hwnd
argument_list|)
condition|)
return|return
name|bw
operator|->
name|window
argument_list|()
return|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|windowUnderMouse
name|QWindow
modifier|*
name|QWindowsContext
operator|::
name|windowUnderMouse
parameter_list|()
specifier|const
block|{
return|return
name|d
operator|->
name|m_mouseHandler
operator|.
name|windowUnderMouse
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|clearWindowUnderMouse
name|void
name|QWindowsContext
operator|::
name|clearWindowUnderMouse
parameter_list|()
block|{
name|d
operator|->
name|m_mouseHandler
operator|.
name|clearWindowUnderMouse
argument_list|()
expr_stmt|;
block|}
end_function
begin_comment
comment|/*!     \brief Find a child window at a screen point.      Deep search for a QWindow at global point, skipping non-owned     windows (accessibility?). Implemented using ChildWindowFromPointEx()     instead of (historically used) WindowFromPoint() to get a well-defined     behaviour for hidden/transparent windows.      \a cwex_flags are flags of ChildWindowFromPointEx().     \a parent is the parent window, pass GetDesktopWindow() for top levels. */
end_comment
begin_function
DECL|function|findPlatformWindowHelper
specifier|static
specifier|inline
name|bool
name|findPlatformWindowHelper
parameter_list|(
specifier|const
name|POINT
modifier|&
name|screenPoint
parameter_list|,
name|unsigned
name|cwexFlags
parameter_list|,
specifier|const
name|QWindowsContext
modifier|*
name|context
parameter_list|,
name|HWND
modifier|*
name|hwnd
parameter_list|,
name|QWindowsWindow
modifier|*
modifier|*
name|result
parameter_list|)
block|{
name|POINT
name|point
init|=
name|screenPoint
decl_stmt|;
name|ScreenToClient
argument_list|(
operator|*
name|hwnd
argument_list|,
operator|&
name|point
argument_list|)
expr_stmt|;
comment|// Returns parent if inside& none matched.
ifndef|#
directive|ifndef
name|Q_OS_WINCE
specifier|const
name|HWND
name|child
init|=
name|ChildWindowFromPointEx
argument_list|(
operator|*
name|hwnd
argument_list|,
name|point
argument_list|,
name|cwexFlags
argument_list|)
decl_stmt|;
else|#
directive|else
name|Q_UNUSED
argument_list|(
argument|cwexFlags
argument_list|)
specifier|const
name|HWND
name|child
init|=
name|ChildWindowFromPoint
argument_list|(
operator|*
name|hwnd
argument_list|,
name|point
argument_list|)
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|child
operator|||
name|child
operator|==
operator|*
name|hwnd
condition|)
return|return
literal|false
return|;
if|if
condition|(
name|QWindowsWindow
modifier|*
name|window
init|=
name|context
operator|->
name|findPlatformWindow
argument_list|(
name|child
argument_list|)
condition|)
block|{
operator|*
name|result
operator|=
name|window
expr_stmt|;
operator|*
name|hwnd
operator|=
name|child
expr_stmt|;
return|return
literal|true
return|;
block|}
ifndef|#
directive|ifndef
name|Q_OS_WINCE
comment|// Does not have  WS_EX_TRANSPARENT .
comment|// QTBUG-40555: despite CWP_SKIPINVISIBLE, it is possible to hit on invisible
comment|// full screen windows of other applications that have WS_EX_TRANSPARENT set
comment|// (for example created by  screen sharing applications). In that case, try to
comment|// find a Qt window by searching again with CWP_SKIPTRANSPARENT.
comment|// Note that Qt 5 uses WS_EX_TRANSPARENT for Qt::WindowTransparentForInput
comment|// as well.
if|if
condition|(
operator|!
operator|(
name|cwexFlags
operator|&
name|CWP_SKIPTRANSPARENT
operator|)
operator|&&
operator|(
name|GetWindowLongPtr
argument_list|(
name|child
argument_list|,
name|GWL_EXSTYLE
argument_list|)
operator|&
name|WS_EX_TRANSPARENT
operator|)
condition|)
block|{
specifier|const
name|HWND
name|nonTransparentChild
init|=
name|ChildWindowFromPointEx
argument_list|(
operator|*
name|hwnd
argument_list|,
name|point
argument_list|,
name|cwexFlags
operator||
name|CWP_SKIPTRANSPARENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|QWindowsWindow
modifier|*
name|nonTransparentWindow
init|=
name|context
operator|->
name|findPlatformWindow
argument_list|(
name|nonTransparentChild
argument_list|)
condition|)
block|{
operator|*
name|result
operator|=
name|nonTransparentWindow
expr_stmt|;
operator|*
name|hwnd
operator|=
name|nonTransparentChild
expr_stmt|;
return|return
literal|true
return|;
block|}
block|}
endif|#
directive|endif
comment|// !Q_OS_WINCE
operator|*
name|hwnd
operator|=
name|child
expr_stmt|;
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|findPlatformWindowAt
name|QWindowsWindow
modifier|*
name|QWindowsContext
operator|::
name|findPlatformWindowAt
parameter_list|(
name|HWND
name|parent
parameter_list|,
specifier|const
name|QPoint
modifier|&
name|screenPointIn
parameter_list|,
name|unsigned
name|cwex_flags
parameter_list|)
specifier|const
block|{
name|QWindowsWindow
modifier|*
name|result
init|=
literal|0
decl_stmt|;
specifier|const
name|POINT
name|screenPoint
init|=
block|{
name|screenPointIn
operator|.
name|x
argument_list|()
block|,
name|screenPointIn
operator|.
name|y
argument_list|()
block|}
decl_stmt|;
while|while
condition|(
name|findPlatformWindowHelper
argument_list|(
name|screenPoint
argument_list|,
name|cwex_flags
argument_list|,
name|this
argument_list|,
operator|&
name|parent
argument_list|,
operator|&
name|result
argument_list|)
condition|)
block|{}
return|return
name|result
return|;
block|}
end_function
begin_function
DECL|function|mimeConverter
name|QWindowsMimeConverter
modifier|&
name|QWindowsContext
operator|::
name|mimeConverter
parameter_list|()
specifier|const
block|{
return|return
name|d
operator|->
name|m_mimeConverter
return|;
block|}
end_function
begin_function
DECL|function|screenManager
name|QWindowsScreenManager
modifier|&
name|QWindowsContext
operator|::
name|screenManager
parameter_list|()
block|{
return|return
name|d
operator|->
name|m_screenManager
return|;
block|}
end_function
begin_function
DECL|function|tabletSupport
name|QWindowsTabletSupport
modifier|*
name|QWindowsContext
operator|::
name|tabletSupport
parameter_list|()
specifier|const
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|QT_NO_TABLETEVENT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
return|return
name|d
operator|->
name|m_tabletSupport
operator|.
name|data
argument_list|()
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function
begin_comment
comment|/*!     \brief Convenience to create a non-visible, message-only dummy     window for example used as clipboard watcher or for GL. */
end_comment
begin_function
DECL|function|createDummyWindow
name|HWND
name|QWindowsContext
operator|::
name|createDummyWindow
parameter_list|(
specifier|const
name|QString
modifier|&
name|classNameIn
parameter_list|,
specifier|const
name|wchar_t
modifier|*
name|windowName
parameter_list|,
name|WNDPROC
name|wndProc
parameter_list|,
name|DWORD
name|style
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wndProc
condition|)
name|wndProc
operator|=
name|DefWindowProc
expr_stmt|;
name|QString
name|className
init|=
name|registerWindowClass
argument_list|(
name|classNameIn
argument_list|,
name|wndProc
argument_list|)
decl_stmt|;
return|return
name|CreateWindowEx
argument_list|(
literal|0
argument_list|,
operator|(
name|wchar_t
operator|*
operator|)
name|className
operator|.
name|utf16
argument_list|()
argument_list|,
name|windowName
argument_list|,
name|style
argument_list|,
name|CW_USEDEFAULT
argument_list|,
name|CW_USEDEFAULT
argument_list|,
name|CW_USEDEFAULT
argument_list|,
name|CW_USEDEFAULT
argument_list|,
name|HWND_MESSAGE
argument_list|,
name|NULL
argument_list|,
operator|(
name|HINSTANCE
operator|)
name|GetModuleHandle
argument_list|(
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|Q_OS_WINCE
end_ifndef
begin_comment
comment|// Re-engineered from the inline function _com_error::ErrorMessage().
end_comment
begin_comment
comment|// We cannot use it directly since it uses swprintf_s(), which is not
end_comment
begin_comment
comment|// present in the MSVCRT.DLL found on Windows XP (QTBUG-35617).
end_comment
begin_function
DECL|function|errorMessageFromComError
specifier|static
specifier|inline
name|QString
name|errorMessageFromComError
parameter_list|(
specifier|const
name|_com_error
modifier|&
name|comError
parameter_list|)
block|{
name|TCHAR
modifier|*
name|message
init|=
name|Q_NULLPTR
decl_stmt|;
name|FormatMessage
argument_list|(
name|FORMAT_MESSAGE_ALLOCATE_BUFFER
operator||
name|FORMAT_MESSAGE_FROM_SYSTEM
argument_list|,
name|NULL
argument_list|,
name|comError
operator|.
name|Error
argument_list|()
argument_list|,
name|MAKELANGID
argument_list|(
name|LANG_NEUTRAL
argument_list|,
name|SUBLANG_DEFAULT
argument_list|)
argument_list|,
name|message
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|message
condition|)
block|{
specifier|const
name|QString
name|result
init|=
name|QString
operator|::
name|fromWCharArray
argument_list|(
name|message
argument_list|)
operator|.
name|trimmed
argument_list|()
decl_stmt|;
name|LocalFree
argument_list|(
operator|(
name|HLOCAL
operator|)
name|message
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
if|if
condition|(
specifier|const
name|WORD
name|wCode
init|=
name|comError
operator|.
name|WCode
argument_list|()
condition|)
return|return
name|QStringLiteral
argument_list|(
literal|"IDispatch error #"
argument_list|)
operator|+
name|QString
operator|::
name|number
argument_list|(
name|wCode
argument_list|)
return|;
return|return
name|QStringLiteral
argument_list|(
literal|"Unknown error 0x0"
argument_list|)
operator|+
name|QString
operator|::
name|number
argument_list|(
name|comError
operator|.
name|Error
argument_list|()
argument_list|,
literal|16
argument_list|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// !Q_OS_WINCE
end_comment
begin_comment
comment|/*!     \brief Common COM error strings. */
end_comment
begin_function
DECL|function|comErrorString
name|QByteArray
name|QWindowsContext
operator|::
name|comErrorString
parameter_list|(
name|HRESULT
name|hr
parameter_list|)
block|{
name|QByteArray
name|result
init|=
name|QByteArrayLiteral
argument_list|(
literal|"COM error 0x"
argument_list|)
operator|+
name|QByteArray
operator|::
name|number
argument_list|(
name|quintptr
argument_list|(
name|hr
argument_list|)
argument_list|,
literal|16
argument_list|)
operator|+
literal|' '
decl_stmt|;
switch|switch
condition|(
name|hr
condition|)
block|{
case|case
name|S_OK
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"S_OK"
argument_list|)
expr_stmt|;
break|break;
case|case
name|S_FALSE
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"S_FALSE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_UNEXPECTED
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"E_UNEXPECTED"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CO_E_ALREADYINITIALIZED
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"CO_E_ALREADYINITIALIZED"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CO_E_NOTINITIALIZED
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"CO_E_NOTINITIALIZED"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPC_E_CHANGED_MODE
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"RPC_E_CHANGED_MODE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|OLE_E_WRONGCOMPOBJ
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"OLE_E_WRONGCOMPOBJ"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CO_E_NOT_SUPPORTED
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"CO_E_NOT_SUPPORTED"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_NOTIMPL
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"E_NOTIMPL"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_INVALIDARG
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"E_INVALIDARG"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_NOINTERFACE
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"E_NOINTERFACE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_POINTER
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"E_POINTER"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_HANDLE
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"E_HANDLE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_ABORT
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"E_ABORT"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_FAIL
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"E_FAIL"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPC_E_WRONG_THREAD
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"RPC_E_WRONG_THREAD"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPC_E_THREAD_NOT_INIT
case|:
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|"RPC_E_THREAD_NOT_INIT"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
ifndef|#
directive|ifndef
name|Q_OS_WINCE
name|_com_error
name|error
argument_list|(
name|hr
argument_list|)
decl_stmt|;
name|result
operator|+=
name|QByteArrayLiteral
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
name|result
operator|+=
name|errorMessageFromComError
argument_list|(
name|error
argument_list|)
expr_stmt|;
name|result
operator|+=
literal|')'
expr_stmt|;
endif|#
directive|endif
comment|// !Q_OS_WINCE
return|return
name|result
return|;
block|}
end_function
begin_comment
comment|/*!      \brief Main windows procedure registered for windows.       \sa QWindowsGuiEventDispatcher */
end_comment
begin_function
DECL|function|windowsProc
name|bool
name|QWindowsContext
operator|::
name|windowsProc
parameter_list|(
name|HWND
name|hwnd
parameter_list|,
name|UINT
name|message
parameter_list|,
name|QtWindows
operator|::
name|WindowsEventType
name|et
parameter_list|,
name|WPARAM
name|wParam
parameter_list|,
name|LPARAM
name|lParam
parameter_list|,
name|LRESULT
modifier|*
name|result
parameter_list|)
block|{
operator|*
name|result
operator|=
literal|0
expr_stmt|;
name|MSG
name|msg
decl_stmt|;
name|msg
operator|.
name|hwnd
operator|=
name|hwnd
expr_stmt|;
comment|// re-create MSG structure
name|msg
operator|.
name|message
operator|=
name|message
expr_stmt|;
comment|// time and pt fields ignored
name|msg
operator|.
name|wParam
operator|=
name|wParam
expr_stmt|;
name|msg
operator|.
name|lParam
operator|=
name|lParam
expr_stmt|;
name|msg
operator|.
name|pt
operator|.
name|x
operator|=
name|msg
operator|.
name|pt
operator|.
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|et
operator|!=
name|QtWindows
operator|::
name|CursorEvent
operator|&&
operator|(
name|et
operator|&
operator|(
name|QtWindows
operator|::
name|MouseEventFlag
operator||
name|QtWindows
operator|::
name|NonClientEventFlag
operator|)
operator|)
condition|)
block|{
name|msg
operator|.
name|pt
operator|.
name|x
operator|=
name|GET_X_LPARAM
argument_list|(
name|lParam
argument_list|)
expr_stmt|;
name|msg
operator|.
name|pt
operator|.
name|y
operator|=
name|GET_Y_LPARAM
argument_list|(
name|lParam
argument_list|)
expr_stmt|;
comment|// For non-client-area messages, these are screen coordinates (as expected
comment|// in the MSG structure), otherwise they are client coordinates.
if|if
condition|(
operator|!
operator|(
name|et
operator|&
name|QtWindows
operator|::
name|NonClientEventFlag
operator|)
condition|)
block|{
name|ClientToScreen
argument_list|(
name|msg
operator|.
name|hwnd
argument_list|,
operator|&
name|msg
operator|.
name|pt
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|Q_OS_WINCE
name|GetCursorPos
argument_list|(
operator|&
name|msg
operator|.
name|pt
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|// Run the native event filters.
name|long
name|filterResult
init|=
literal|0
decl_stmt|;
name|QAbstractEventDispatcher
modifier|*
name|dispatcher
init|=
name|QAbstractEventDispatcher
operator|::
name|instance
argument_list|()
decl_stmt|;
if|if
condition|(
name|dispatcher
operator|&&
name|dispatcher
operator|->
name|filterNativeEvent
argument_list|(
name|d
operator|->
name|m_eventType
argument_list|,
operator|&
name|msg
argument_list|,
operator|&
name|filterResult
argument_list|)
condition|)
block|{
operator|*
name|result
operator|=
name|LRESULT
argument_list|(
name|filterResult
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|QWindowsWindow
modifier|*
name|platformWindow
init|=
name|findPlatformWindow
argument_list|(
name|hwnd
argument_list|)
decl_stmt|;
if|if
condition|(
name|platformWindow
condition|)
block|{
name|filterResult
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|QWindowSystemInterface
operator|::
name|handleNativeEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|d
operator|->
name|m_eventType
argument_list|,
operator|&
name|msg
argument_list|,
operator|&
name|filterResult
argument_list|)
condition|)
block|{
operator|*
name|result
operator|=
name|LRESULT
argument_list|(
name|filterResult
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
block|}
switch|switch
condition|(
name|et
condition|)
block|{
case|case
name|QtWindows
operator|::
name|InputMethodStartCompositionEvent
case|:
return|return
name|QWindowsInputContext
operator|::
name|instance
argument_list|()
operator|->
name|startComposition
argument_list|(
name|hwnd
argument_list|)
return|;
case|case
name|QtWindows
operator|::
name|InputMethodCompositionEvent
case|:
return|return
name|QWindowsInputContext
operator|::
name|instance
argument_list|()
operator|->
name|composition
argument_list|(
name|hwnd
argument_list|,
name|lParam
argument_list|)
return|;
case|case
name|QtWindows
operator|::
name|InputMethodEndCompositionEvent
case|:
return|return
name|QWindowsInputContext
operator|::
name|instance
argument_list|()
operator|->
name|endComposition
argument_list|(
name|hwnd
argument_list|)
return|;
case|case
name|QtWindows
operator|::
name|InputMethodRequest
case|:
return|return
name|QWindowsInputContext
operator|::
name|instance
argument_list|()
operator|->
name|handleIME_Request
argument_list|(
name|wParam
argument_list|,
name|lParam
argument_list|,
name|result
argument_list|)
return|;
case|case
name|QtWindows
operator|::
name|InputMethodOpenCandidateWindowEvent
case|:
case|case
name|QtWindows
operator|::
name|InputMethodCloseCandidateWindowEvent
case|:
comment|// TODO: Release/regrab mouse if a popup has mouse grab.
return|return
literal|false
return|;
case|case
name|QtWindows
operator|::
name|DestroyEvent
case|:
if|if
condition|(
name|platformWindow
operator|&&
operator|!
name|platformWindow
operator|->
name|testFlag
argument_list|(
name|QWindowsWindow
operator|::
name|WithinDestroy
argument_list|)
condition|)
block|{
name|qWarning
argument_list|()
operator|<<
literal|"External WM_DESTROY received for "
operator|<<
name|platformWindow
operator|->
name|window
argument_list|()
operator|<<
literal|", parent: "
operator|<<
name|platformWindow
operator|->
name|window
argument_list|()
operator|->
name|parent
argument_list|()
operator|<<
literal|", transient parent: "
operator|<<
name|platformWindow
operator|->
name|window
argument_list|()
operator|->
name|transientParent
argument_list|()
expr_stmt|;
block|}
return|return
literal|false
return|;
case|case
name|QtWindows
operator|::
name|ClipboardEvent
case|:
return|return
literal|false
return|;
case|case
name|QtWindows
operator|::
name|UnknownEvent
case|:
return|return
literal|false
return|;
case|case
name|QtWindows
operator|::
name|AccessibleObjectFromWindowRequest
case|:
ifndef|#
directive|ifndef
name|QT_NO_ACCESSIBILITY
return|return
name|QWindowsAccessibility
operator|::
name|handleAccessibleObjectFromWindowRequest
argument_list|(
name|hwnd
argument_list|,
name|wParam
argument_list|,
name|lParam
argument_list|,
name|result
argument_list|)
return|;
else|#
directive|else
return|return
literal|false
return|;
endif|#
directive|endif
case|case
name|QtWindows
operator|::
name|DisplayChangedEvent
case|:
return|return
name|d
operator|->
name|m_screenManager
operator|.
name|handleDisplayChange
argument_list|(
name|wParam
argument_list|,
name|lParam
argument_list|)
return|;
case|case
name|QtWindows
operator|::
name|SettingChangedEvent
case|:
return|return
name|d
operator|->
name|m_screenManager
operator|.
name|handleScreenChanges
argument_list|()
return|;
default|default:
break|break;
block|}
comment|// Before CreateWindowEx() returns, some events are sent,
comment|// for example WM_GETMINMAXINFO asking for size constraints for top levels.
comment|// Pass on to current creation context
if|if
condition|(
operator|!
name|platformWindow
operator|&&
operator|!
name|d
operator|->
name|m_creationContext
operator|.
name|isNull
argument_list|()
condition|)
block|{
switch|switch
condition|(
name|et
condition|)
block|{
ifndef|#
directive|ifndef
name|Q_OS_WINCE
comment|// maybe available on some SDKs revisit WM_GETMINMAXINFO
case|case
name|QtWindows
operator|::
name|QuerySizeHints
case|:
name|d
operator|->
name|m_creationContext
operator|->
name|applyToMinMaxInfo
argument_list|(
cast|reinterpret_cast
argument_list|<
name|MINMAXINFO
operator|*
argument_list|>
argument_list|(
name|lParam
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
endif|#
directive|endif
case|case
name|QtWindows
operator|::
name|ResizeEvent
case|:
name|d
operator|->
name|m_creationContext
operator|->
name|obtainedGeometry
operator|.
name|setSize
argument_list|(
name|QSize
argument_list|(
name|GET_X_LPARAM
argument_list|(
name|lParam
argument_list|)
argument_list|,
name|GET_Y_LPARAM
argument_list|(
name|lParam
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
case|case
name|QtWindows
operator|::
name|MoveEvent
case|:
name|d
operator|->
name|m_creationContext
operator|->
name|obtainedGeometry
operator|.
name|moveTo
argument_list|(
name|GET_X_LPARAM
argument_list|(
name|lParam
argument_list|)
argument_list|,
name|GET_Y_LPARAM
argument_list|(
name|lParam
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
case|case
name|QtWindows
operator|::
name|CalculateSize
case|:
return|return
name|QWindowsGeometryHint
operator|::
name|handleCalculateSize
argument_list|(
name|d
operator|->
name|m_creationContext
operator|->
name|customMargins
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|platformWindow
condition|)
block|{
comment|// Suppress events sent during DestroyWindow() for native children.
if|if
condition|(
name|platformWindow
operator|->
name|testFlag
argument_list|(
name|QWindowsWindow
operator|::
name|WithinDestroy
argument_list|)
condition|)
return|return
literal|false
return|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verbose
operator|>
literal|1
condition|)
name|qCDebug
argument_list|(
name|lcQpaEvents
argument_list|)
operator|<<
literal|"Event window: "
operator|<<
name|platformWindow
operator|->
name|window
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|qWarning
argument_list|(
literal|"%s: No Qt Window found for event 0x%x (%s), hwnd=0x%p."
argument_list|,
name|__FUNCTION__
argument_list|,
name|message
argument_list|,
name|QWindowsGuiEventDispatcher
operator|::
name|windowsMessageName
argument_list|(
name|message
argument_list|)
argument_list|,
name|hwnd
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
switch|switch
condition|(
name|et
condition|)
block|{
case|case
name|QtWindows
operator|::
name|KeyDownEvent
case|:
case|case
name|QtWindows
operator|::
name|KeyEvent
case|:
case|case
name|QtWindows
operator|::
name|InputMethodKeyEvent
case|:
case|case
name|QtWindows
operator|::
name|InputMethodKeyDownEvent
case|:
case|case
name|QtWindows
operator|::
name|KeyboardLayoutChangeEvent
case|:
case|case
name|QtWindows
operator|::
name|AppCommandEvent
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|QT_NO_SESSIONMANAGER
argument_list|)
return|return
name|platformSessionManager
argument_list|()
operator|->
name|isInteractionBlocked
argument_list|()
condition|?
literal|true
else|:
name|d
operator|->
name|m_keyMapper
operator|.
name|translateKeyEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|hwnd
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
else|#
directive|else
return|return
name|d
operator|->
name|m_keyMapper
operator|.
name|translateKeyEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|hwnd
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
endif|#
directive|endif
case|case
name|QtWindows
operator|::
name|MoveEvent
case|:
name|platformWindow
operator|->
name|handleMoved
argument_list|()
expr_stmt|;
return|return
literal|true
return|;
case|case
name|QtWindows
operator|::
name|ResizeEvent
case|:
name|platformWindow
operator|->
name|handleResized
argument_list|(
operator|(
name|int
operator|)
name|wParam
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
ifndef|#
directive|ifndef
name|Q_OS_WINCE
comment|// maybe available on some SDKs revisit WM_GETMINMAXINFO
case|case
name|QtWindows
operator|::
name|QuerySizeHints
case|:
name|platformWindow
operator|->
name|getSizeHints
argument_list|(
cast|reinterpret_cast
argument_list|<
name|MINMAXINFO
operator|*
argument_list|>
argument_list|(
name|lParam
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
comment|// maybe available on some SDKs revisit WM_NCCALCSIZE
case|case
name|QtWindows
operator|::
name|CalculateSize
case|:
return|return
name|QWindowsGeometryHint
operator|::
name|handleCalculateSize
argument_list|(
name|platformWindow
operator|->
name|customMargins
argument_list|()
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
case|case
name|QtWindows
operator|::
name|NonClientHitTest
case|:
return|return
name|platformWindow
operator|->
name|handleNonClientHitTest
argument_list|(
name|QPoint
argument_list|(
name|msg
operator|.
name|pt
operator|.
name|x
argument_list|,
name|msg
operator|.
name|pt
operator|.
name|y
argument_list|)
argument_list|,
name|result
argument_list|)
return|;
endif|#
directive|endif
comment|// !Q_OS_WINCE
case|case
name|QtWindows
operator|::
name|ExposeEvent
case|:
return|return
name|platformWindow
operator|->
name|handleWmPaint
argument_list|(
name|hwnd
argument_list|,
name|message
argument_list|,
name|wParam
argument_list|,
name|lParam
argument_list|)
return|;
case|case
name|QtWindows
operator|::
name|NonClientMouseEvent
case|:
if|if
condition|(
name|platformWindow
operator|->
name|frameStrutEventsEnabled
argument_list|()
condition|)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|QT_NO_SESSIONMANAGER
argument_list|)
return|return
name|platformSessionManager
argument_list|()
operator|->
name|isInteractionBlocked
argument_list|()
condition|?
literal|true
else|:
name|d
operator|->
name|m_mouseHandler
operator|.
name|translateMouseEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|hwnd
argument_list|,
name|et
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
else|#
directive|else
return|return
name|d
operator|->
name|m_mouseHandler
operator|.
name|translateMouseEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|hwnd
argument_list|,
name|et
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
endif|#
directive|endif
break|break;
comment|/* the mouse tracking on windows already handles the reset of the cursor  * and does not like somebody else handling it.  * on WINCE its necessary to handle this event to get the correct cursor  */
ifdef|#
directive|ifdef
name|Q_OS_WINCE
case|case
name|QtWindows
operator|::
name|CursorEvent
case|:
block|{
name|QWindowsWindow
operator|::
name|baseWindowOf
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|)
operator|->
name|applyCursor
argument_list|()
expr_stmt|;
return|return
literal|true
return|;
block|}
endif|#
directive|endif
case|case
name|QtWindows
operator|::
name|MouseWheelEvent
case|:
case|case
name|QtWindows
operator|::
name|MouseEvent
case|:
case|case
name|QtWindows
operator|::
name|LeaveEvent
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|QT_NO_SESSIONMANAGER
argument_list|)
return|return
name|platformSessionManager
argument_list|()
operator|->
name|isInteractionBlocked
argument_list|()
condition|?
literal|true
else|:
name|d
operator|->
name|m_mouseHandler
operator|.
name|translateMouseEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|hwnd
argument_list|,
name|et
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
else|#
directive|else
return|return
name|d
operator|->
name|m_mouseHandler
operator|.
name|translateMouseEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|hwnd
argument_list|,
name|et
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
endif|#
directive|endif
case|case
name|QtWindows
operator|::
name|TouchEvent
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|QT_NO_SESSIONMANAGER
argument_list|)
return|return
name|platformSessionManager
argument_list|()
operator|->
name|isInteractionBlocked
argument_list|()
condition|?
literal|true
else|:
name|d
operator|->
name|m_mouseHandler
operator|.
name|translateTouchEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|hwnd
argument_list|,
name|et
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
else|#
directive|else
return|return
name|d
operator|->
name|m_mouseHandler
operator|.
name|translateTouchEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|hwnd
argument_list|,
name|et
argument_list|,
name|msg
argument_list|,
name|result
argument_list|)
return|;
endif|#
directive|endif
case|case
name|QtWindows
operator|::
name|FocusInEvent
case|:
comment|// see QWindowsWindow::requestActivateWindow().
case|case
name|QtWindows
operator|::
name|FocusOutEvent
case|:
name|handleFocusEvent
argument_list|(
name|et
argument_list|,
name|platformWindow
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
case|case
name|QtWindows
operator|::
name|ShowEventOnParentRestoring
case|:
comment|// QTBUG-40696, prevent Windows from re-showing hidden transient children (dialogs).
if|if
condition|(
operator|!
name|platformWindow
operator|->
name|window
argument_list|()
operator|->
name|isVisible
argument_list|()
condition|)
block|{
operator|*
name|result
operator|=
literal|0
expr_stmt|;
return|return
literal|true
return|;
block|}
break|break;
case|case
name|QtWindows
operator|::
name|HideEvent
case|:
name|platformWindow
operator|->
name|handleHidden
argument_list|()
expr_stmt|;
return|return
literal|false
return|;
comment|// Indicate transient children should be hidden by windows (SW_PARENTCLOSING)
case|case
name|QtWindows
operator|::
name|CloseEvent
case|:
name|QWindowSystemInterface
operator|::
name|handleCloseEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
case|case
name|QtWindows
operator|::
name|ThemeChanged
case|:
block|{
comment|// Switch from Aero to Classic changes margins.
specifier|const
name|Qt
operator|::
name|WindowFlags
name|flags
init|=
name|platformWindow
operator|->
name|window
argument_list|()
operator|->
name|flags
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|Qt
operator|::
name|WindowType_Mask
operator|)
operator|!=
name|Qt
operator|::
name|Desktop
operator|&&
operator|!
operator|(
name|flags
operator|&
name|Qt
operator|::
name|FramelessWindowHint
operator|)
condition|)
name|platformWindow
operator|->
name|setFlag
argument_list|(
name|QWindowsWindow
operator|::
name|FrameDirty
argument_list|)
expr_stmt|;
if|if
condition|(
name|QWindowsTheme
modifier|*
name|theme
init|=
name|QWindowsTheme
operator|::
name|instance
argument_list|()
condition|)
name|theme
operator|->
name|windowsThemeChanged
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
case|case
name|QtWindows
operator|::
name|CompositionSettingsChanged
case|:
name|platformWindow
operator|->
name|handleCompositionSettingsChanged
argument_list|()
expr_stmt|;
return|return
literal|true
return|;
ifndef|#
directive|ifndef
name|Q_OS_WINCE
case|case
name|QtWindows
operator|::
name|ActivateWindowEvent
case|:
if|if
condition|(
name|platformWindow
operator|->
name|window
argument_list|()
operator|->
name|flags
argument_list|()
operator|&
name|Qt
operator|::
name|WindowDoesNotAcceptFocus
condition|)
block|{
operator|*
name|result
operator|=
name|LRESULT
argument_list|(
name|MA_NOACTIVATE
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
ifndef|#
directive|ifndef
name|QT_NO_TABLETEVENT
if|if
condition|(
operator|!
name|d
operator|->
name|m_tabletSupport
operator|.
name|isNull
argument_list|()
condition|)
name|d
operator|->
name|m_tabletSupport
operator|->
name|notifyActivate
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// !QT_NO_TABLETEVENT
if|if
condition|(
name|platformWindow
operator|->
name|testFlag
argument_list|(
name|QWindowsWindow
operator|::
name|BlockedByModal
argument_list|)
condition|)
if|if
condition|(
specifier|const
name|QWindow
modifier|*
name|modalWindow
init|=
name|QGuiApplication
operator|::
name|modalWindow
argument_list|()
condition|)
name|QWindowsWindow
operator|::
name|baseWindowOf
argument_list|(
name|modalWindow
argument_list|)
operator|->
name|alertWindow
argument_list|()
expr_stmt|;
break|break;
case|case
name|QtWindows
operator|::
name|MouseActivateWindowEvent
case|:
if|if
condition|(
name|platformWindow
operator|->
name|window
argument_list|()
operator|->
name|flags
argument_list|()
operator|&
name|Qt
operator|::
name|WindowDoesNotAcceptFocus
condition|)
block|{
operator|*
name|result
operator|=
name|LRESULT
argument_list|(
name|MA_NOACTIVATE
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
break|break;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|QT_NO_CONTEXTMENU
case|case
name|QtWindows
operator|::
name|ContextMenu
case|:
return|return
name|handleContextMenuEvent
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|,
name|msg
argument_list|)
return|;
endif|#
directive|endif
case|case
name|QtWindows
operator|::
name|WhatsThisEvent
case|:
block|{
ifndef|#
directive|ifndef
name|QT_NO_WHATSTHIS
name|QWindowSystemInterface
operator|::
name|handleEnterWhatsThisEvent
argument_list|()
expr_stmt|;
return|return
literal|true
return|;
endif|#
directive|endif
block|}
break|break;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|QT_NO_SESSIONMANAGER
argument_list|)
case|case
name|QtWindows
operator|::
name|QueryEndSessionApplicationEvent
case|:
block|{
name|QWindowsSessionManager
modifier|*
name|sessionManager
init|=
name|platformSessionManager
argument_list|()
decl_stmt|;
if|if
condition|(
name|sessionManager
operator|->
name|isActive
argument_list|()
condition|)
block|{
comment|// bogus message from windows
operator|*
name|result
operator|=
name|sessionManager
operator|->
name|wasCanceled
argument_list|()
condition|?
literal|0
else|:
literal|1
expr_stmt|;
return|return
literal|true
return|;
block|}
name|sessionManager
operator|->
name|setActive
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|sessionManager
operator|->
name|blocksInteraction
argument_list|()
expr_stmt|;
name|sessionManager
operator|->
name|clearCancellation
argument_list|()
expr_stmt|;
name|QGuiApplicationPrivate
modifier|*
name|qGuiAppPriv
init|=
cast|static_cast
argument_list|<
name|QGuiApplicationPrivate
operator|*
argument_list|>
argument_list|(
name|QObjectPrivate
operator|::
name|get
argument_list|(
name|qApp
argument_list|)
argument_list|)
decl_stmt|;
name|qGuiAppPriv
operator|->
name|commitData
argument_list|()
expr_stmt|;
if|if
condition|(
name|lParam
operator|&
name|ENDSESSION_LOGOFF
condition|)
name|fflush
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|result
operator|=
name|sessionManager
operator|->
name|wasCanceled
argument_list|()
condition|?
literal|0
else|:
literal|1
expr_stmt|;
return|return
literal|true
return|;
block|}
case|case
name|QtWindows
operator|::
name|EndSessionApplicationEvent
case|:
block|{
name|QWindowsSessionManager
modifier|*
name|sessionManager
init|=
name|platformSessionManager
argument_list|()
decl_stmt|;
name|sessionManager
operator|->
name|setActive
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|sessionManager
operator|->
name|allowsInteraction
argument_list|()
expr_stmt|;
name|bool
name|endsession
init|=
operator|(
name|bool
operator|)
name|wParam
decl_stmt|;
comment|// we receive the message for each toplevel window included internal hidden ones,
comment|// but the aboutToQuit signal should be emitted only once.
name|QGuiApplicationPrivate
modifier|*
name|qGuiAppPriv
init|=
cast|static_cast
argument_list|<
name|QGuiApplicationPrivate
operator|*
argument_list|>
argument_list|(
name|QObjectPrivate
operator|::
name|get
argument_list|(
name|qApp
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|endsession
operator|&&
operator|!
name|qGuiAppPriv
operator|->
name|aboutToQuitEmitted
condition|)
block|{
name|qGuiAppPriv
operator|->
name|aboutToQuitEmitted
operator|=
literal|true
expr_stmt|;
name|int
name|index
init|=
name|QGuiApplication
operator|::
name|staticMetaObject
operator|.
name|indexOfSignal
argument_list|(
literal|"aboutToQuit()"
argument_list|)
decl_stmt|;
name|qApp
operator|->
name|qt_metacall
argument_list|(
name|QMetaObject
operator|::
name|InvokeMetaMethod
argument_list|,
name|index
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// since the process will be killed immediately quit() has no real effect
name|QGuiApplication
operator|::
name|quit
argument_list|()
expr_stmt|;
block|}
return|return
literal|true
return|;
block|}
endif|#
directive|endif
comment|// !defined(Q_OS_WINCE)&& !defined(QT_NO_SESSIONMANAGER)
default|default:
break|break;
block|}
return|return
literal|false
return|;
block|}
end_function
begin_comment
comment|/* Compress activation events. If the next focus window is already known  * at the time the current one receives focus-out, pass that to  * QWindowSystemInterface instead of sending 0 and ignore its consecutive  * focus-in event.  * This helps applications that do handling in focus-out events. */
end_comment
begin_function
DECL|function|handleFocusEvent
name|void
name|QWindowsContext
operator|::
name|handleFocusEvent
parameter_list|(
name|QtWindows
operator|::
name|WindowsEventType
name|et
parameter_list|,
name|QWindowsWindow
modifier|*
name|platformWindow
parameter_list|)
block|{
name|QWindow
modifier|*
name|nextActiveWindow
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|et
operator|==
name|QtWindows
operator|::
name|FocusInEvent
condition|)
block|{
name|QWindow
modifier|*
name|topWindow
init|=
name|QWindowsWindow
operator|::
name|topLevelOf
argument_list|(
name|platformWindow
operator|->
name|window
argument_list|()
argument_list|)
decl_stmt|;
name|QWindow
modifier|*
name|modalWindow
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|QGuiApplicationPrivate
operator|::
name|instance
argument_list|()
operator|->
name|isWindowBlocked
argument_list|(
name|topWindow
argument_list|,
operator|&
name|modalWindow
argument_list|)
operator|&&
name|topWindow
operator|!=
name|modalWindow
condition|)
block|{
name|modalWindow
operator|->
name|requestActivate
argument_list|()
expr_stmt|;
return|return;
block|}
comment|// QTBUG-32867: Invoking WinAPI SetParent() can cause focus-in for the
comment|// window which is not desired for native child widgets.
if|if
condition|(
name|platformWindow
operator|->
name|testFlag
argument_list|(
name|QWindowsWindow
operator|::
name|WithinSetParent
argument_list|)
condition|)
block|{
name|QWindow
modifier|*
name|currentFocusWindow
init|=
name|QGuiApplication
operator|::
name|focusWindow
argument_list|()
decl_stmt|;
if|if
condition|(
name|currentFocusWindow
operator|&&
name|currentFocusWindow
operator|!=
name|platformWindow
operator|->
name|window
argument_list|()
condition|)
block|{
name|currentFocusWindow
operator|->
name|requestActivate
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
name|nextActiveWindow
operator|=
name|platformWindow
operator|->
name|window
argument_list|()
expr_stmt|;
block|}
else|else
block|{
comment|// Focus out: Is the next window known and different
comment|// from the receiving the focus out.
if|if
condition|(
specifier|const
name|HWND
name|nextActiveHwnd
init|=
name|GetFocus
argument_list|()
condition|)
if|if
condition|(
name|QWindowsWindow
modifier|*
name|nextActivePlatformWindow
init|=
name|findClosestPlatformWindow
argument_list|(
name|nextActiveHwnd
argument_list|)
condition|)
if|if
condition|(
name|nextActivePlatformWindow
operator|!=
name|platformWindow
condition|)
name|nextActiveWindow
operator|=
name|nextActivePlatformWindow
operator|->
name|window
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|nextActiveWindow
operator|!=
name|d
operator|->
name|m_lastActiveWindow
condition|)
block|{
name|d
operator|->
name|m_lastActiveWindow
operator|=
name|nextActiveWindow
expr_stmt|;
name|QWindowSystemInterface
operator|::
name|handleWindowActivated
argument_list|(
name|nextActiveWindow
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_CONTEXTMENU
end_ifndef
begin_function
DECL|function|handleContextMenuEvent
name|bool
name|QWindowsContext
operator|::
name|handleContextMenuEvent
parameter_list|(
name|QWindow
modifier|*
name|window
parameter_list|,
specifier|const
name|MSG
modifier|&
name|msg
parameter_list|)
block|{
name|bool
name|mouseTriggered
init|=
literal|false
decl_stmt|;
name|QPoint
name|globalPos
decl_stmt|;
name|QPoint
name|pos
decl_stmt|;
if|if
condition|(
name|msg
operator|.
name|lParam
operator|!=
operator|(
name|int
operator|)
literal|0xffffffff
condition|)
block|{
name|mouseTriggered
operator|=
literal|true
expr_stmt|;
name|globalPos
operator|.
name|setX
argument_list|(
name|msg
operator|.
name|pt
operator|.
name|x
argument_list|)
expr_stmt|;
name|globalPos
operator|.
name|setY
argument_list|(
name|msg
operator|.
name|pt
operator|.
name|y
argument_list|)
expr_stmt|;
name|pos
operator|=
name|QWindowsGeometryHint
operator|::
name|mapFromGlobal
argument_list|(
name|msg
operator|.
name|hwnd
argument_list|,
name|globalPos
argument_list|)
expr_stmt|;
name|RECT
name|clientRect
decl_stmt|;
if|if
condition|(
name|GetClientRect
argument_list|(
name|msg
operator|.
name|hwnd
argument_list|,
operator|&
name|clientRect
argument_list|)
condition|)
block|{
if|if
condition|(
name|pos
operator|.
name|x
argument_list|()
operator|<
operator|(
name|int
operator|)
name|clientRect
operator|.
name|left
operator|||
name|pos
operator|.
name|x
argument_list|()
operator|>=
operator|(
name|int
operator|)
name|clientRect
operator|.
name|right
operator|||
name|pos
operator|.
name|y
argument_list|()
operator|<
operator|(
name|int
operator|)
name|clientRect
operator|.
name|top
operator|||
name|pos
operator|.
name|y
argument_list|()
operator|>=
operator|(
name|int
operator|)
name|clientRect
operator|.
name|bottom
condition|)
block|{
comment|// This is the case that user has right clicked in the window's caption,
comment|// We should call DefWindowProc() to display a default shortcut menu
comment|// instead of sending a Qt window system event.
return|return
literal|false
return|;
block|}
block|}
block|}
name|QWindowSystemInterface
operator|::
name|handleContextMenuEvent
argument_list|(
name|window
argument_list|,
name|mouseTriggered
argument_list|,
name|pos
operator|/
name|QWindowsScaling
operator|::
name|factor
argument_list|()
argument_list|,
name|globalPos
operator|/
name|QWindowsScaling
operator|::
name|factor
argument_list|()
argument_list|,
name|QWindowsKeyMapper
operator|::
name|queryKeyboardModifiers
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_function
DECL|function|asyncExpose
name|bool
name|QWindowsContext
operator|::
name|asyncExpose
parameter_list|()
specifier|const
block|{
return|return
name|d
operator|->
name|m_asyncExpose
return|;
block|}
end_function
begin_function
DECL|function|setAsyncExpose
name|void
name|QWindowsContext
operator|::
name|setAsyncExpose
parameter_list|(
name|bool
name|value
parameter_list|)
block|{
name|d
operator|->
name|m_asyncExpose
operator|=
name|value
expr_stmt|;
block|}
end_function
begin_comment
comment|/*!     \brief Windows functions for actual windows.      There is another one for timers, sockets, etc in     QEventDispatcherWin32.      \ingroup qt-lighthouse-win */
end_comment
begin_extern
DECL|function|qWindowsWndProc
extern|extern
literal|"C"
name|LRESULT
name|QT_WIN_CALLBACK
name|qWindowsWndProc
parameter_list|(
name|HWND
name|hwnd
parameter_list|,
name|UINT
name|message
parameter_list|,
name|WPARAM
name|wParam
parameter_list|,
name|LPARAM
name|lParam
parameter_list|)
block|{
name|LRESULT
name|result
decl_stmt|;
specifier|const
name|QtWindows
operator|::
name|WindowsEventType
name|et
init|=
name|windowsEventType
argument_list|(
name|message
argument_list|,
name|wParam
argument_list|,
name|lParam
argument_list|)
decl_stmt|;
specifier|const
name|bool
name|handled
init|=
name|QWindowsContext
operator|::
name|instance
argument_list|()
operator|->
name|windowsProc
argument_list|(
name|hwnd
argument_list|,
name|message
argument_list|,
name|et
argument_list|,
name|wParam
argument_list|,
name|lParam
argument_list|,
operator|&
name|result
argument_list|)
decl_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verbose
operator|>
literal|1
operator|&&
name|lcQpaEvents
argument_list|()
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
if|if
condition|(
specifier|const
name|char
modifier|*
name|eventName
init|=
name|QWindowsGuiEventDispatcher
operator|::
name|windowsMessageName
argument_list|(
name|message
argument_list|)
condition|)
block|{
name|qCDebug
argument_list|(
name|lcQpaEvents
argument_list|)
operator|<<
literal|"EVENT: hwd="
operator|<<
name|hwnd
operator|<<
name|eventName
operator|<<
name|hex
operator|<<
literal|"msg=0x"
operator|<<
name|message
operator|<<
literal|"et=0x"
operator|<<
name|et
operator|<<
name|dec
operator|<<
literal|"wp="
operator|<<
name|int
argument_list|(
name|wParam
argument_list|)
operator|<<
literal|"at"
operator|<<
name|GET_X_LPARAM
argument_list|(
name|lParam
argument_list|)
operator|<<
name|GET_Y_LPARAM
argument_list|(
name|lParam
argument_list|)
operator|<<
literal|"handled="
operator|<<
name|handled
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|handled
condition|)
name|result
operator|=
name|DefWindowProc
argument_list|(
name|hwnd
argument_list|,
name|message
argument_list|,
name|wParam
argument_list|,
name|lParam
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_extern
begin_macro
name|QT_END_NAMESPACE
end_macro
end_unit
