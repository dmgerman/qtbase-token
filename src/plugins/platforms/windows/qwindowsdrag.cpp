begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2012 Digia Plc and/or its subsidiary(-ies). ** Contact: http://www.qt-project.org/legal ** ** This file is part of the plugins of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** Commercial License Usage ** Licensees holding valid commercial Qt licenses may use this file in ** accordance with the commercial license agreement provided with the ** Software or, alternatively, in accordance with the terms contained in ** a written agreement between you and Digia.  For licensing terms and ** conditions see http://qt.digia.com/licensing.  For further information ** use the contact form at http://qt.digia.com/contact-us. ** ** GNU Lesser General Public License Usage ** Alternatively, this file may be used under the terms of the GNU Lesser ** General Public License version 2.1 as published by the Free Software ** Foundation and appearing in the file LICENSE.LGPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU Lesser General Public License version 2.1 requirements ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Digia gives you certain additional ** rights.  These rights are described in the Digia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU ** General Public License version 3.0 as published by the Free Software ** Foundation and appearing in the file LICENSE.GPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU General Public License version 3.0 requirements will be ** met: http://www.gnu.org/copyleft/gpl.html. ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"qwindowsdrag.h"
end_include
begin_include
include|#
directive|include
file|"qwindowscontext.h"
end_include
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_CLIPBOARD
end_ifndef
begin_include
include|#
directive|include
file|"qwindowsclipboard.h"
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"qwindowsintegration.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsole.h"
end_include
begin_include
include|#
directive|include
file|"qtwindows_additional.h"
end_include
begin_include
include|#
directive|include
file|"qwindowswindow.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsmousehandler.h"
end_include
begin_include
include|#
directive|include
file|"qwindowscursor.h"
end_include
begin_include
include|#
directive|include
file|<QtGui/QMouseEvent>
end_include
begin_include
include|#
directive|include
file|<QtGui/QPixmap>
end_include
begin_include
include|#
directive|include
file|<QtGui/QPainter>
end_include
begin_include
include|#
directive|include
file|<QtGui/QGuiApplication>
end_include
begin_include
include|#
directive|include
file|<qpa/qwindowsysteminterface_p.h>
end_include
begin_include
include|#
directive|include
file|<QtGui/private/qguiapplication_p.h>
end_include
begin_include
include|#
directive|include
file|<QtCore/QDebug>
end_include
begin_include
include|#
directive|include
file|<QtCore/QBuffer>
end_include
begin_include
include|#
directive|include
file|<QtCore/QPoint>
end_include
begin_include
include|#
directive|include
file|<shlobj.h>
end_include
begin_decl_stmt
name|QT_BEGIN_NAMESPACE
comment|// These pixmaps approximate the images in the Windows User Interface Guidelines.
comment|// XPM
DECL|variable|moveDragCursorXpmC
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|moveDragCursorXpmC
index|[]
init|=
block|{
literal|"11 20 3 1"
block|,
literal|".        c None"
block|,
literal|"a        c #FFFFFF"
block|,
literal|"X        c #000000"
block|,
comment|// X11 cursor is traditionally black
literal|"aa........."
block|,
literal|"aXa........"
block|,
literal|"aXXa......."
block|,
literal|"aXXXa......"
block|,
literal|"aXXXXa....."
block|,
literal|"aXXXXXa...."
block|,
literal|"aXXXXXXa..."
block|,
literal|"aXXXXXXXa.."
block|,
literal|"aXXXXXXXXa."
block|,
literal|"aXXXXXXXXXa"
block|,
literal|"aXXXXXXaaaa"
block|,
literal|"aXXXaXXa..."
block|,
literal|"aXXaaXXa..."
block|,
literal|"aXa..aXXa.."
block|,
literal|"aa...aXXa.."
block|,
literal|"a.....aXXa."
block|,
literal|"......aXXa."
block|,
literal|".......aXXa"
block|,
literal|".......aXXa"
block|,
literal|"........aa."
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* XPM */
end_comment
begin_decl_stmt
DECL|variable|copyDragCursorXpmC
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|copyDragCursorXpmC
index|[]
init|=
block|{
literal|"24 30 3 1"
block|,
literal|".        c None"
block|,
literal|"a        c #000000"
block|,
literal|"X        c #FFFFFF"
block|,
literal|"XX......................"
block|,
literal|"XaX....................."
block|,
literal|"XaaX...................."
block|,
literal|"XaaaX..................."
block|,
literal|"XaaaaX.................."
block|,
literal|"XaaaaaX................."
block|,
literal|"XaaaaaaX................"
block|,
literal|"XaaaaaaaX..............."
block|,
literal|"XaaaaaaaaX.............."
block|,
literal|"XaaaaaaaaaX............."
block|,
literal|"XaaaaaaXXXX............."
block|,
literal|"XaaaXaaX................"
block|,
literal|"XaaXXaaX................"
block|,
literal|"XaX..XaaX..............."
block|,
literal|"XX...XaaX..............."
block|,
literal|"X.....XaaX.............."
block|,
literal|"......XaaX.............."
block|,
literal|".......XaaX............."
block|,
literal|".......XaaX............."
block|,
literal|"........XX...aaaaaaaaaaa"
block|,
literal|".............aXXXXXXXXXa"
block|,
literal|".............aXXXXXXXXXa"
block|,
literal|".............aXXXXaXXXXa"
block|,
literal|".............aXXXXaXXXXa"
block|,
literal|".............aXXaaaaaXXa"
block|,
literal|".............aXXXXaXXXXa"
block|,
literal|".............aXXXXaXXXXa"
block|,
literal|".............aXXXXXXXXXa"
block|,
literal|".............aXXXXXXXXXa"
block|,
literal|".............aaaaaaaaaaa"
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* XPM */
end_comment
begin_decl_stmt
DECL|variable|linkDragCursorXpmC
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|linkDragCursorXpmC
index|[]
init|=
block|{
literal|"24 30 3 1"
block|,
literal|".        c None"
block|,
literal|"a        c #000000"
block|,
literal|"X        c #FFFFFF"
block|,
literal|"XX......................"
block|,
literal|"XaX....................."
block|,
literal|"XaaX...................."
block|,
literal|"XaaaX..................."
block|,
literal|"XaaaaX.................."
block|,
literal|"XaaaaaX................."
block|,
literal|"XaaaaaaX................"
block|,
literal|"XaaaaaaaX..............."
block|,
literal|"XaaaaaaaaX.............."
block|,
literal|"XaaaaaaaaaX............."
block|,
literal|"XaaaaaaXXXX............."
block|,
literal|"XaaaXaaX................"
block|,
literal|"XaaXXaaX................"
block|,
literal|"XaX..XaaX..............."
block|,
literal|"XX...XaaX..............."
block|,
literal|"X.....XaaX.............."
block|,
literal|"......XaaX.............."
block|,
literal|".......XaaX............."
block|,
literal|".......XaaX............."
block|,
literal|"........XX...aaaaaaaaaaa"
block|,
literal|".............aXXXXXXXXXa"
block|,
literal|".............aXXXaaaaXXa"
block|,
literal|".............aXXXXaaaXXa"
block|,
literal|".............aXXXaaaaXXa"
block|,
literal|".............aXXaaaXaXXa"
block|,
literal|".............aXXaaXXXXXa"
block|,
literal|".............aXXaXXXXXXa"
block|,
literal|".............aXXXaXXXXXa"
block|,
literal|".............aXXXXXXXXXa"
block|,
literal|".............aaaaaaaaaaa"
block|}
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|ignoreDragCursorXpmC
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|ignoreDragCursorXpmC
index|[]
init|=
block|{
literal|"24 30 3 1"
block|,
literal|".        c None"
block|,
literal|"a        c #000000"
block|,
literal|"X        c #FFFFFF"
block|,
literal|"aa......................"
block|,
literal|"aXa....................."
block|,
literal|"aXXa...................."
block|,
literal|"aXXXa..................."
block|,
literal|"aXXXXa.................."
block|,
literal|"aXXXXXa................."
block|,
literal|"aXXXXXXa................"
block|,
literal|"aXXXXXXXa..............."
block|,
literal|"aXXXXXXXXa.............."
block|,
literal|"aXXXXXXXXXa............."
block|,
literal|"aXXXXXXaaaa............."
block|,
literal|"aXXXaXXa................"
block|,
literal|"aXXaaXXa................"
block|,
literal|"aXa..aXXa..............."
block|,
literal|"aa...aXXa..............."
block|,
literal|"a.....aXXa.............."
block|,
literal|"......aXXa.....XXXX....."
block|,
literal|".......aXXa..XXaaaaXX..."
block|,
literal|".......aXXa.XaaaaaaaaX.."
block|,
literal|"........aa.XaaaXXXXaaaX."
block|,
literal|"...........XaaaaX..XaaX."
block|,
literal|"..........XaaXaaaX..XaaX"
block|,
literal|"..........XaaXXaaaX.XaaX"
block|,
literal|"..........XaaX.XaaaXXaaX"
block|,
literal|"..........XaaX..XaaaXaaX"
block|,
literal|"...........XaaX..XaaaaX."
block|,
literal|"...........XaaaXXXXaaaX."
block|,
literal|"............XaaaaaaaaX.."
block|,
literal|".............XXaaaaXX..."
block|,
literal|"...............XXXX....."
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*!     \class QWindowsDropMimeData     \brief Special mime data class for data retrieval from Drag operations.      Implementation of QWindowsInternalMimeDataBase which retrieves the     current drop data object from QWindowsDrag.      \sa QWindowsDrag     \internal     \ingroup qt-lighthouse-win */
end_comment
begin_function
DECL|function|retrieveDataObject
name|IDataObject
modifier|*
name|QWindowsDropMimeData
operator|::
name|retrieveDataObject
parameter_list|()
specifier|const
block|{
return|return
name|QWindowsDrag
operator|::
name|instance
argument_list|()
operator|->
name|dropDataObject
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|translateToQDragDropActions
specifier|static
specifier|inline
name|Qt
operator|::
name|DropActions
name|translateToQDragDropActions
parameter_list|(
name|DWORD
name|pdwEffects
parameter_list|)
block|{
name|Qt
operator|::
name|DropActions
name|actions
init|=
name|Qt
operator|::
name|IgnoreAction
decl_stmt|;
if|if
condition|(
name|pdwEffects
operator|&
name|DROPEFFECT_LINK
condition|)
name|actions
operator||=
name|Qt
operator|::
name|LinkAction
expr_stmt|;
if|if
condition|(
name|pdwEffects
operator|&
name|DROPEFFECT_COPY
condition|)
name|actions
operator||=
name|Qt
operator|::
name|CopyAction
expr_stmt|;
if|if
condition|(
name|pdwEffects
operator|&
name|DROPEFFECT_MOVE
condition|)
name|actions
operator||=
name|Qt
operator|::
name|MoveAction
expr_stmt|;
return|return
name|actions
return|;
block|}
end_function
begin_function
DECL|function|translateToQDragDropAction
specifier|static
specifier|inline
name|Qt
operator|::
name|DropAction
name|translateToQDragDropAction
parameter_list|(
name|DWORD
name|pdwEffect
parameter_list|)
block|{
if|if
condition|(
name|pdwEffect
operator|&
name|DROPEFFECT_LINK
condition|)
return|return
name|Qt
operator|::
name|LinkAction
return|;
if|if
condition|(
name|pdwEffect
operator|&
name|DROPEFFECT_COPY
condition|)
return|return
name|Qt
operator|::
name|CopyAction
return|;
if|if
condition|(
name|pdwEffect
operator|&
name|DROPEFFECT_MOVE
condition|)
return|return
name|Qt
operator|::
name|MoveAction
return|;
return|return
name|Qt
operator|::
name|IgnoreAction
return|;
block|}
end_function
begin_function
DECL|function|translateToWinDragEffects
specifier|static
specifier|inline
name|DWORD
name|translateToWinDragEffects
parameter_list|(
name|Qt
operator|::
name|DropActions
name|action
parameter_list|)
block|{
name|DWORD
name|effect
init|=
name|DROPEFFECT_NONE
decl_stmt|;
if|if
condition|(
name|action
operator|&
name|Qt
operator|::
name|LinkAction
condition|)
name|effect
operator||=
name|DROPEFFECT_LINK
expr_stmt|;
if|if
condition|(
name|action
operator|&
name|Qt
operator|::
name|CopyAction
condition|)
name|effect
operator||=
name|DROPEFFECT_COPY
expr_stmt|;
if|if
condition|(
name|action
operator|&
name|Qt
operator|::
name|MoveAction
condition|)
name|effect
operator||=
name|DROPEFFECT_MOVE
expr_stmt|;
return|return
name|effect
return|;
block|}
end_function
begin_function
DECL|function|toQtKeyboardModifiers
specifier|static
specifier|inline
name|Qt
operator|::
name|KeyboardModifiers
name|toQtKeyboardModifiers
parameter_list|(
name|DWORD
name|keyState
parameter_list|)
block|{
name|Qt
operator|::
name|KeyboardModifiers
name|modifiers
init|=
name|Qt
operator|::
name|NoModifier
decl_stmt|;
if|if
condition|(
name|keyState
operator|&
name|MK_SHIFT
condition|)
name|modifiers
operator||=
name|Qt
operator|::
name|ShiftModifier
expr_stmt|;
if|if
condition|(
name|keyState
operator|&
name|MK_CONTROL
condition|)
name|modifiers
operator||=
name|Qt
operator|::
name|ControlModifier
expr_stmt|;
if|if
condition|(
name|keyState
operator|&
name|MK_ALT
condition|)
name|modifiers
operator||=
name|Qt
operator|::
name|AltModifier
expr_stmt|;
return|return
name|modifiers
return|;
block|}
end_function
begin_comment
comment|/*!     \class QWindowsOleDropSource     \brief Implementation of IDropSource      Used for drag operations.      \sa QWindowsDrag     \internal     \ingroup qt-lighthouse-win */
end_comment
begin_class
DECL|class|QWindowsOleDropSource
class|class
name|QWindowsOleDropSource
super|:
specifier|public
name|IDropSource
block|{
public|public:
specifier|explicit
name|QWindowsOleDropSource
parameter_list|(
name|QWindowsDrag
modifier|*
name|drag
parameter_list|)
constructor_decl|;
specifier|virtual
name|~
name|QWindowsOleDropSource
parameter_list|()
destructor_decl|;
name|void
name|createCursors
parameter_list|()
function_decl|;
comment|// IUnknown methods
name|STDMETHOD
function_decl|(
name|QueryInterface
function_decl|)
parameter_list|(
name|REFIID
name|riid
parameter_list|,
name|void
modifier|*
modifier|*
name|ppvObj
parameter_list|)
function_decl|;
name|STDMETHOD_
argument_list|(
argument|ULONG
argument_list|,
argument|AddRef
argument_list|)
operator|(
name|void
operator|)
expr_stmt|;
name|STDMETHOD_
argument_list|(
argument|ULONG
argument_list|,
argument|Release
argument_list|)
operator|(
name|void
operator|)
expr_stmt|;
comment|// IDropSource methods
name|STDMETHOD
function_decl|(
name|QueryContinueDrag
function_decl|)
parameter_list|(
name|BOOL
name|fEscapePressed
parameter_list|,
name|DWORD
name|grfKeyState
parameter_list|)
function_decl|;
name|STDMETHOD
function_decl|(
name|GiveFeedback
function_decl|)
parameter_list|(
name|DWORD
name|dwEffect
parameter_list|)
function_decl|;
private|private:
DECL|class|DragCursorHandle
class|class
name|DragCursorHandle
block|{
name|Q_DISABLE_COPY
parameter_list|(
name|DragCursorHandle
parameter_list|)
specifier|public
private|:
DECL|function|DragCursorHandle
name|DragCursorHandle
parameter_list|(
name|HCURSOR
name|c
parameter_list|,
name|quint64
name|k
parameter_list|)
member_init_list|:
name|cursor
argument_list|(
name|c
argument_list|)
member_init_list|,
name|cacheKey
argument_list|(
name|k
argument_list|)
block|{}
DECL|function|~DragCursorHandle
name|~
name|DragCursorHandle
parameter_list|()
block|{
name|DestroyCursor
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
DECL|member|cursor
name|HCURSOR
name|cursor
decl_stmt|;
DECL|member|cacheKey
name|quint64
name|cacheKey
decl_stmt|;
block|}
class|;
DECL|typedef|ActionCursorMap
typedef|typedef
name|QMap
argument_list|<
name|Qt
operator|::
name|DropAction
argument_list|,
name|QSharedPointer
argument_list|<
name|DragCursorHandle
argument_list|>
argument_list|>
name|ActionCursorMap
typedef|;
DECL|member|m_drag
name|QWindowsDrag
modifier|*
name|m_drag
decl_stmt|;
DECL|member|m_currentButtons
name|Qt
operator|::
name|MouseButtons
name|m_currentButtons
decl_stmt|;
DECL|member|m_cursors
name|ActionCursorMap
name|m_cursors
decl_stmt|;
DECL|member|m_refs
name|ULONG
name|m_refs
decl_stmt|;
block|}
class|;
end_class
begin_constructor
DECL|function|QWindowsOleDropSource
name|QWindowsOleDropSource
operator|::
name|QWindowsOleDropSource
parameter_list|(
name|QWindowsDrag
modifier|*
name|drag
parameter_list|)
member_init_list|:
name|m_drag
argument_list|(
name|drag
argument_list|)
member_init_list|,
name|m_currentButtons
argument_list|(
name|Qt
operator|::
name|NoButton
argument_list|)
member_init_list|,
name|m_refs
argument_list|(
literal|1
argument_list|)
block|{
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
block|}
end_constructor
begin_destructor
DECL|function|~QWindowsOleDropSource
name|QWindowsOleDropSource
operator|::
name|~
name|QWindowsOleDropSource
parameter_list|()
block|{
name|m_cursors
operator|.
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
block|}
end_destructor
begin_comment
comment|/*!     \brief Blend custom pixmap with cursors. */
end_comment
begin_function
DECL|function|createCursors
name|void
name|QWindowsOleDropSource
operator|::
name|createCursors
parameter_list|()
block|{
specifier|const
name|QDrag
modifier|*
name|drag
init|=
name|m_drag
operator|->
name|currentDrag
argument_list|()
decl_stmt|;
specifier|const
name|QPixmap
name|pixmap
init|=
name|drag
operator|->
name|pixmap
argument_list|()
decl_stmt|;
specifier|const
name|bool
name|hasPixmap
init|=
operator|!
name|pixmap
operator|.
name|isNull
argument_list|()
decl_stmt|;
name|QList
argument_list|<
name|Qt
operator|::
name|DropAction
argument_list|>
name|actions
decl_stmt|;
name|actions
operator|<<
name|Qt
operator|::
name|MoveAction
operator|<<
name|Qt
operator|::
name|CopyAction
operator|<<
name|Qt
operator|::
name|LinkAction
expr_stmt|;
if|if
condition|(
name|hasPixmap
condition|)
name|actions
operator|<<
name|Qt
operator|::
name|IgnoreAction
expr_stmt|;
specifier|const
name|QPoint
name|hotSpot
init|=
name|drag
operator|->
name|hotSpot
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|cnum
init|=
literal|0
init|;
name|cnum
operator|<
name|actions
operator|.
name|size
argument_list|()
condition|;
operator|++
name|cnum
control|)
block|{
specifier|const
name|Qt
operator|::
name|DropAction
name|action
init|=
name|actions
operator|.
name|at
argument_list|(
name|cnum
argument_list|)
decl_stmt|;
name|QPixmap
name|cpm
init|=
name|drag
operator|->
name|dragCursor
argument_list|(
name|action
argument_list|)
decl_stmt|;
if|if
condition|(
name|cpm
operator|.
name|isNull
argument_list|()
condition|)
name|cpm
operator|=
name|m_drag
operator|->
name|defaultCursor
argument_list|(
name|action
argument_list|)
expr_stmt|;
name|QSharedPointer
argument_list|<
name|DragCursorHandle
argument_list|>
name|cursorHandler
init|=
name|m_cursors
operator|.
name|value
argument_list|(
name|action
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|cursorHandler
operator|.
name|isNull
argument_list|()
operator|&&
name|cpm
operator|.
name|cacheKey
argument_list|()
operator|==
name|cursorHandler
operator|->
name|cacheKey
condition|)
continue|continue;
if|if
condition|(
name|cpm
operator|.
name|isNull
argument_list|()
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Unable to obtain drag cursor for %d."
argument_list|,
name|__FUNCTION__
argument_list|,
name|action
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|int
name|w
init|=
name|cpm
operator|.
name|width
argument_list|()
decl_stmt|;
name|int
name|h
init|=
name|cpm
operator|.
name|height
argument_list|()
decl_stmt|;
if|if
condition|(
name|hasPixmap
condition|)
block|{
specifier|const
name|int
name|x1
init|=
name|qMin
argument_list|(
operator|-
name|hotSpot
operator|.
name|x
argument_list|()
argument_list|,
literal|0
argument_list|)
decl_stmt|;
specifier|const
name|int
name|x2
init|=
name|qMax
argument_list|(
name|pixmap
operator|.
name|width
argument_list|()
operator|-
name|hotSpot
operator|.
name|x
argument_list|()
argument_list|,
name|cpm
operator|.
name|width
argument_list|()
argument_list|)
decl_stmt|;
specifier|const
name|int
name|y1
init|=
name|qMin
argument_list|(
operator|-
name|hotSpot
operator|.
name|y
argument_list|()
argument_list|,
literal|0
argument_list|)
decl_stmt|;
specifier|const
name|int
name|y2
init|=
name|qMax
argument_list|(
name|pixmap
operator|.
name|height
argument_list|()
operator|-
name|hotSpot
operator|.
name|y
argument_list|()
argument_list|,
name|cpm
operator|.
name|height
argument_list|()
argument_list|)
decl_stmt|;
name|w
operator|=
name|x2
operator|-
name|x1
operator|+
literal|1
expr_stmt|;
name|h
operator|=
name|y2
operator|-
name|y1
operator|+
literal|1
expr_stmt|;
block|}
specifier|const
name|QPoint
name|newHotSpot
init|=
name|hotSpot
decl_stmt|;
name|QPixmap
name|newCursor
argument_list|(
name|w
argument_list|,
name|h
argument_list|)
decl_stmt|;
if|if
condition|(
name|hasPixmap
condition|)
block|{
name|newCursor
operator|.
name|fill
argument_list|(
name|Qt
operator|::
name|transparent
argument_list|)
expr_stmt|;
name|QPainter
name|p
argument_list|(
operator|&
name|newCursor
argument_list|)
decl_stmt|;
specifier|const
name|QRect
name|srcRect
init|=
name|pixmap
operator|.
name|rect
argument_list|()
decl_stmt|;
specifier|const
name|QPoint
name|pmDest
init|=
name|QPoint
argument_list|(
name|qMax
argument_list|(
literal|0
argument_list|,
operator|-
name|hotSpot
operator|.
name|x
argument_list|()
argument_list|)
argument_list|,
name|qMax
argument_list|(
literal|0
argument_list|,
operator|-
name|hotSpot
operator|.
name|y
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|p
operator|.
name|drawPixmap
argument_list|(
name|pmDest
argument_list|,
name|pixmap
argument_list|,
name|srcRect
argument_list|)
expr_stmt|;
name|p
operator|.
name|drawPixmap
argument_list|(
name|qMax
argument_list|(
literal|0
argument_list|,
name|newHotSpot
operator|.
name|x
argument_list|()
argument_list|)
argument_list|,
name|qMax
argument_list|(
literal|0
argument_list|,
name|newHotSpot
operator|.
name|y
argument_list|()
argument_list|)
argument_list|,
name|cpm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|newCursor
operator|=
name|cpm
expr_stmt|;
block|}
specifier|const
name|int
name|hotX
init|=
name|hasPixmap
condition|?
name|qMax
argument_list|(
literal|0
argument_list|,
name|newHotSpot
operator|.
name|x
argument_list|()
argument_list|)
else|:
literal|0
decl_stmt|;
specifier|const
name|int
name|hotY
init|=
name|hasPixmap
condition|?
name|qMax
argument_list|(
literal|0
argument_list|,
name|newHotSpot
operator|.
name|y
argument_list|()
argument_list|)
else|:
literal|0
decl_stmt|;
if|if
condition|(
specifier|const
name|HCURSOR
name|sysCursor
init|=
name|QWindowsCursor
operator|::
name|createPixmapCursor
argument_list|(
name|newCursor
argument_list|,
name|hotX
argument_list|,
name|hotY
argument_list|)
condition|)
block|{
name|m_cursors
operator|.
name|insert
argument_list|(
name|action
argument_list|,
name|QSharedPointer
argument_list|<
name|DragCursorHandle
argument_list|>
argument_list|(
operator|new
name|DragCursorHandle
argument_list|(
name|sysCursor
argument_list|,
name|cpm
operator|.
name|cacheKey
argument_list|()
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|"%s %d cursors"
argument_list|,
name|__FUNCTION__
argument_list|,
name|m_cursors
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|//---------------------------------------------------------------------
end_comment
begin_comment
comment|//                    IUnknown Methods
end_comment
begin_comment
comment|//---------------------------------------------------------------------
end_comment
begin_function
name|STDMETHODIMP
DECL|function|QueryInterface
name|QWindowsOleDropSource
operator|::
name|QueryInterface
parameter_list|(
name|REFIID
name|iid
parameter_list|,
name|void
name|FAR
modifier|*
name|FAR
modifier|*
name|ppv
parameter_list|)
block|{
if|if
condition|(
name|iid
operator|==
name|IID_IUnknown
operator|||
name|iid
operator|==
name|IID_IDropSource
condition|)
block|{
operator|*
name|ppv
operator|=
name|this
expr_stmt|;
operator|++
name|m_refs
expr_stmt|;
return|return
name|NOERROR
return|;
block|}
operator|*
name|ppv
operator|=
name|NULL
expr_stmt|;
return|return
name|ResultFromScode
argument_list|(
name|E_NOINTERFACE
argument_list|)
return|;
block|}
end_function
begin_macro
name|STDMETHODIMP_
argument_list|(
argument|ULONG
argument_list|)
end_macro
begin_macro
DECL|function|AddRef
name|QWindowsOleDropSource
end_macro
begin_expr_stmt
DECL|function|AddRef
operator|::
name|AddRef
operator|(
name|void
operator|)
block|{
return|return
operator|++
name|m_refs
return|;
block|}
end_expr_stmt
begin_macro
name|STDMETHODIMP_
argument_list|(
argument|ULONG
argument_list|)
end_macro
begin_macro
DECL|function|Release
name|QWindowsOleDropSource
end_macro
begin_expr_stmt
DECL|function|Release
operator|::
name|Release
operator|(
name|void
operator|)
block|{
if|if
condition|(
operator|--
name|m_refs
operator|==
literal|0
condition|)
block|{
operator|delete
name|this
expr_stmt|;
return|return
literal|0
return|;
block|}
end_expr_stmt
begin_return
return|return
name|m_refs
return|;
end_return
begin_comment
unit|}
comment|/*!     \brief Check for cancel. */
end_comment
begin_function
unit|QT_ENSURE_STACK_ALIGNED_FOR_SSE
name|STDMETHODIMP
DECL|function|QueryContinueDrag
name|QWindowsOleDropSource
operator|::
name|QueryContinueDrag
parameter_list|(
name|BOOL
name|fEscapePressed
parameter_list|,
name|DWORD
name|grfKeyState
parameter_list|)
block|{
name|HRESULT
name|hr
init|=
name|S_OK
decl_stmt|;
do|do
block|{
if|if
condition|(
name|fEscapePressed
condition|)
block|{
name|hr
operator|=
name|ResultFromScode
argument_list|(
name|DRAGDROP_S_CANCEL
argument_list|)
expr_stmt|;
break|break;
block|}
comment|// grfKeyState is broken on CE& some Windows XP versions,
comment|// therefore we need to check the state manually
if|if
condition|(
operator|(
name|GetAsyncKeyState
argument_list|(
name|VK_LBUTTON
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|GetAsyncKeyState
argument_list|(
name|VK_MBUTTON
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|GetAsyncKeyState
argument_list|(
name|VK_RBUTTON
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|hr
operator|=
name|ResultFromScode
argument_list|(
name|DRAGDROP_S_DROP
argument_list|)
expr_stmt|;
break|break;
block|}
specifier|const
name|Qt
operator|::
name|MouseButtons
name|buttons
init|=
name|QWindowsMouseHandler
operator|::
name|keyStateToMouseButtons
argument_list|(
name|grfKeyState
argument_list|)
decl_stmt|;
if|if
condition|(
name|m_currentButtons
operator|==
name|Qt
operator|::
name|NoButton
condition|)
block|{
name|m_currentButtons
operator|=
name|buttons
expr_stmt|;
block|}
else|else
block|{
comment|// Button changed: Complete Drop operation.
if|if
condition|(
operator|!
operator|(
name|m_currentButtons
operator|&
name|buttons
operator|)
condition|)
block|{
name|hr
operator|=
name|ResultFromScode
argument_list|(
name|DRAGDROP_S_DROP
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|QGuiApplication
operator|::
name|processEvents
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
literal|false
condition|)
do|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
operator|&&
operator|(
name|QWindowsContext
operator|::
name|verboseOLE
operator|>
literal|1
operator|||
name|hr
operator|!=
name|S_OK
operator|)
condition|)
name|qDebug
argument_list|(
literal|"%s fEscapePressed=%d, grfKeyState=%lu buttons=%d returns 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|fEscapePressed
argument_list|,
name|grfKeyState
argument_list|,
name|int
argument_list|(
name|m_currentButtons
argument_list|)
argument_list|,
name|int
argument_list|(
name|hr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|hr
return|;
block|}
end_function
begin_comment
comment|/*!     \brief Give feedback: Change cursor accoding to action. */
end_comment
begin_function
name|QT_ENSURE_STACK_ALIGNED_FOR_SSE
name|STDMETHODIMP
DECL|function|GiveFeedback
name|QWindowsOleDropSource
operator|::
name|GiveFeedback
parameter_list|(
name|DWORD
name|dwEffect
parameter_list|)
block|{
specifier|const
name|Qt
operator|::
name|DropAction
name|action
init|=
name|translateToQDragDropAction
argument_list|(
name|dwEffect
argument_list|)
decl_stmt|;
name|m_drag
operator|->
name|updateAction
argument_list|(
name|action
argument_list|)
expr_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
operator|>
literal|2
condition|)
name|qDebug
argument_list|(
literal|"%s dwEffect=%lu, action=%d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|dwEffect
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|QSharedPointer
argument_list|<
name|DragCursorHandle
argument_list|>
name|cursorHandler
init|=
name|m_cursors
operator|.
name|value
argument_list|(
name|action
argument_list|)
decl_stmt|;
name|quint64
name|currentCacheKey
init|=
name|m_drag
operator|->
name|currentDrag
argument_list|()
operator|->
name|dragCursor
argument_list|(
name|action
argument_list|)
operator|.
name|cacheKey
argument_list|()
decl_stmt|;
if|if
condition|(
name|cursorHandler
operator|.
name|isNull
argument_list|()
operator|||
name|currentCacheKey
operator|!=
name|cursorHandler
operator|->
name|cacheKey
condition|)
name|createCursors
argument_list|()
expr_stmt|;
specifier|const
name|ActionCursorMap
operator|::
name|const_iterator
name|it
init|=
name|m_cursors
operator|.
name|constFind
argument_list|(
name|action
argument_list|)
decl_stmt|;
if|if
condition|(
name|it
operator|!=
name|m_cursors
operator|.
name|constEnd
argument_list|()
condition|)
block|{
name|SetCursor
argument_list|(
name|it
operator|.
name|value
argument_list|()
operator|->
name|cursor
argument_list|)
expr_stmt|;
return|return
name|ResultFromScode
argument_list|(
name|S_OK
argument_list|)
return|;
block|}
return|return
name|ResultFromScode
argument_list|(
name|DRAGDROP_S_USEDEFAULTCURSORS
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/*!     \class QWindowsOleDropTarget     \brief Implementation of IDropTarget      To be registered for each window. Currently, drop sites     are enabled for top levels. The child window handling     (sending DragEnter/Leave, etc) is handled in here.      \sa QWindowsDrag     \internal     \ingroup qt-lighthouse-win */
end_comment
begin_constructor
DECL|function|QWindowsOleDropTarget
name|QWindowsOleDropTarget
operator|::
name|QWindowsOleDropTarget
parameter_list|(
name|QWindow
modifier|*
name|w
parameter_list|)
member_init_list|:
name|m_refs
argument_list|(
literal|1
argument_list|)
member_init_list|,
name|m_window
argument_list|(
name|w
argument_list|)
member_init_list|,
name|m_chosenEffect
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|m_lastKeyState
argument_list|(
literal|0
argument_list|)
block|{
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|()
operator|<<
name|__FUNCTION__
operator|<<
name|this
operator|<<
name|w
expr_stmt|;
block|}
end_constructor
begin_destructor
DECL|function|~QWindowsOleDropTarget
name|QWindowsOleDropTarget
operator|::
name|~
name|QWindowsOleDropTarget
parameter_list|()
block|{
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|"%s %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|this
argument_list|)
expr_stmt|;
block|}
end_destructor
begin_function
name|STDMETHODIMP
DECL|function|QueryInterface
name|QWindowsOleDropTarget
operator|::
name|QueryInterface
parameter_list|(
name|REFIID
name|iid
parameter_list|,
name|void
name|FAR
modifier|*
name|FAR
modifier|*
name|ppv
parameter_list|)
block|{
if|if
condition|(
name|iid
operator|==
name|IID_IUnknown
operator|||
name|iid
operator|==
name|IID_IDropTarget
condition|)
block|{
operator|*
name|ppv
operator|=
name|this
expr_stmt|;
name|AddRef
argument_list|()
expr_stmt|;
return|return
name|NOERROR
return|;
block|}
operator|*
name|ppv
operator|=
name|NULL
expr_stmt|;
return|return
name|ResultFromScode
argument_list|(
name|E_NOINTERFACE
argument_list|)
return|;
block|}
end_function
begin_macro
name|STDMETHODIMP_
argument_list|(
argument|ULONG
argument_list|)
end_macro
begin_macro
DECL|function|AddRef
name|QWindowsOleDropTarget
end_macro
begin_expr_stmt
DECL|function|AddRef
operator|::
name|AddRef
operator|(
name|void
operator|)
block|{
return|return
operator|++
name|m_refs
return|;
block|}
end_expr_stmt
begin_macro
name|STDMETHODIMP_
argument_list|(
argument|ULONG
argument_list|)
end_macro
begin_macro
DECL|function|Release
name|QWindowsOleDropTarget
end_macro
begin_expr_stmt
DECL|function|Release
operator|::
name|Release
operator|(
name|void
operator|)
block|{
if|if
condition|(
operator|--
name|m_refs
operator|==
literal|0
condition|)
block|{
operator|delete
name|this
expr_stmt|;
return|return
literal|0
return|;
block|}
end_expr_stmt
begin_return
return|return
name|m_refs
return|;
end_return
begin_expr_stmt
unit|}  QWindow
DECL|function|findDragOverWindow
operator|*
name|QWindowsOleDropTarget
operator|::
name|findDragOverWindow
operator|(
specifier|const
name|POINTL
operator|&
name|pt
operator|)
specifier|const
block|{
if|if
condition|(
name|QWindowsWindow
modifier|*
name|child
init|=
name|QWindowsWindow
operator|::
name|baseWindowOf
argument_list|(
name|m_window
argument_list|)
operator|->
name|childAtScreenPoint
argument_list|(
name|QPoint
argument_list|(
name|pt
operator|.
name|x
argument_list|,
name|pt
operator|.
name|y
argument_list|)
argument_list|)
condition|)
return|return
name|child
operator|->
name|window
argument_list|()
return|;
end_expr_stmt
begin_return
return|return
name|m_window
return|;
end_return
begin_macro
unit|}  void
DECL|function|handleDrag
name|QWindowsOleDropTarget
end_macro
begin_expr_stmt
DECL|function|handleDrag
operator|::
name|handleDrag
operator|(
name|QWindow
operator|*
name|window
operator|,
name|DWORD
name|grfKeyState
operator|,
specifier|const
name|QPoint
operator|&
name|point
operator|,
name|LPDWORD
name|pdwEffect
operator|)
block|{
name|Q_ASSERT
argument_list|(
name|window
argument_list|)
block|;
name|m_lastPoint
operator|=
name|point
block|;
name|m_lastKeyState
operator|=
name|grfKeyState
block|;
name|QWindowsDrag
operator|*
name|windowsDrag
operator|=
name|QWindowsDrag
operator|::
name|instance
argument_list|()
block|;
specifier|const
name|Qt
operator|::
name|DropActions
name|actions
operator|=
name|translateToQDragDropActions
argument_list|(
operator|*
name|pdwEffect
argument_list|)
block|;
name|QGuiApplicationPrivate
operator|::
name|modifier_buttons
operator|=
name|toQtKeyboardModifiers
argument_list|(
name|grfKeyState
argument_list|)
block|;
name|QGuiApplicationPrivate
operator|::
name|mouse_buttons
operator|=
name|QWindowsMouseHandler
operator|::
name|keyStateToMouseButtons
argument_list|(
name|grfKeyState
argument_list|)
block|;
specifier|const
name|QPlatformDragQtResponse
name|response
operator|=
name|QWindowSystemInterface
operator|::
name|handleDrag
argument_list|(
name|window
argument_list|,
name|windowsDrag
operator|->
name|dropData
argument_list|()
argument_list|,
name|m_lastPoint
argument_list|,
name|actions
argument_list|)
block|;
name|m_answerRect
operator|=
name|response
operator|.
name|answerRect
argument_list|()
block|;
specifier|const
name|Qt
operator|::
name|DropAction
name|action
operator|=
name|response
operator|.
name|acceptedAction
argument_list|()
block|;
if|if
condition|(
name|response
operator|.
name|isAccepted
argument_list|()
condition|)
block|{
name|m_chosenEffect
operator|=
name|translateToWinDragEffects
argument_list|(
name|action
argument_list|)
expr_stmt|;
block|}
end_expr_stmt
begin_else
else|else
block|{
name|m_chosenEffect
operator|=
name|DROPEFFECT_NONE
expr_stmt|;
block|}
end_else
begin_expr_stmt
operator|*
name|pdwEffect
operator|=
name|m_chosenEffect
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|()
operator|<<
name|__FUNCTION__
operator|<<
name|m_window
operator|<<
name|windowsDrag
operator|->
name|dropData
argument_list|()
operator|<<
literal|" supported actions="
operator|<<
name|actions
operator|<<
literal|" mods="
operator|<<
name|QGuiApplicationPrivate
operator|::
name|modifier_buttons
operator|<<
literal|" mouse="
operator|<<
name|QGuiApplicationPrivate
operator|::
name|mouse_buttons
operator|<<
literal|" accepted: "
operator|<<
name|response
operator|.
name|isAccepted
argument_list|()
operator|<<
name|action
operator|<<
name|m_answerRect
operator|<<
literal|" effect"
operator|<<
operator|*
name|pdwEffect
expr_stmt|;
end_if
begin_function
unit|}  QT_ENSURE_STACK_ALIGNED_FOR_SSE
name|STDMETHODIMP
DECL|function|DragEnter
name|QWindowsOleDropTarget
operator|::
name|DragEnter
parameter_list|(
name|LPDATAOBJECT
name|pDataObj
parameter_list|,
name|DWORD
name|grfKeyState
parameter_list|,
name|POINTL
name|pt
parameter_list|,
name|LPDWORD
name|pdwEffect
parameter_list|)
block|{
if|if
condition|(
name|IDropTargetHelper
modifier|*
name|dh
init|=
name|QWindowsDrag
operator|::
name|instance
argument_list|()
operator|->
name|dropHelper
argument_list|()
condition|)
name|dh
operator|->
name|DragEnter
argument_list|(
cast|reinterpret_cast
argument_list|<
name|HWND
argument_list|>
argument_list|(
name|m_window
operator|->
name|winId
argument_list|()
argument_list|)
argument_list|,
name|pDataObj
argument_list|,
cast|reinterpret_cast
argument_list|<
name|POINT
operator|*
argument_list|>
argument_list|(
operator|&
name|pt
argument_list|)
argument_list|,
operator|*
name|pdwEffect
argument_list|)
expr_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|"%s widget=%p key=%lu, pt=%ld,%ld"
argument_list|,
name|__FUNCTION__
argument_list|,
name|m_window
argument_list|,
name|grfKeyState
argument_list|,
name|pt
operator|.
name|x
argument_list|,
name|pt
operator|.
name|y
argument_list|)
expr_stmt|;
name|QWindowsDrag
operator|::
name|instance
argument_list|()
operator|->
name|setDropDataObject
argument_list|(
name|pDataObj
argument_list|)
expr_stmt|;
name|pDataObj
operator|->
name|AddRef
argument_list|()
expr_stmt|;
specifier|const
name|QPoint
name|point
init|=
name|QWindowsGeometryHint
operator|::
name|mapFromGlobal
argument_list|(
name|m_window
argument_list|,
name|QPoint
argument_list|(
name|pt
operator|.
name|x
argument_list|,
name|pt
operator|.
name|y
argument_list|)
argument_list|)
decl_stmt|;
name|handleDrag
argument_list|(
name|m_window
argument_list|,
name|grfKeyState
argument_list|,
name|point
argument_list|,
name|pdwEffect
argument_list|)
expr_stmt|;
return|return
name|NOERROR
return|;
block|}
end_function
begin_function
name|QT_ENSURE_STACK_ALIGNED_FOR_SSE
name|STDMETHODIMP
DECL|function|DragOver
name|QWindowsOleDropTarget
operator|::
name|DragOver
parameter_list|(
name|DWORD
name|grfKeyState
parameter_list|,
name|POINTL
name|pt
parameter_list|,
name|LPDWORD
name|pdwEffect
parameter_list|)
block|{
if|if
condition|(
name|IDropTargetHelper
modifier|*
name|dh
init|=
name|QWindowsDrag
operator|::
name|instance
argument_list|()
operator|->
name|dropHelper
argument_list|()
condition|)
name|dh
operator|->
name|DragOver
argument_list|(
cast|reinterpret_cast
argument_list|<
name|POINT
operator|*
argument_list|>
argument_list|(
operator|&
name|pt
argument_list|)
argument_list|,
operator|*
name|pdwEffect
argument_list|)
expr_stmt|;
name|QWindow
modifier|*
name|dragOverWindow
init|=
name|findDragOverWindow
argument_list|(
name|pt
argument_list|)
decl_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|"%s widget=%p key=%lu, pt=%ld,%ld"
argument_list|,
name|__FUNCTION__
argument_list|,
name|dragOverWindow
argument_list|,
name|grfKeyState
argument_list|,
name|pt
operator|.
name|x
argument_list|,
name|pt
operator|.
name|y
argument_list|)
expr_stmt|;
specifier|const
name|QPoint
name|tmpPoint
init|=
name|QWindowsGeometryHint
operator|::
name|mapFromGlobal
argument_list|(
name|dragOverWindow
argument_list|,
name|QPoint
argument_list|(
name|pt
operator|.
name|x
argument_list|,
name|pt
operator|.
name|y
argument_list|)
argument_list|)
decl_stmt|;
comment|// see if we should compress this event
if|if
condition|(
operator|(
name|tmpPoint
operator|==
name|m_lastPoint
operator|||
name|m_answerRect
operator|.
name|contains
argument_list|(
name|tmpPoint
argument_list|)
operator|)
operator|&&
name|m_lastKeyState
operator|==
name|grfKeyState
condition|)
block|{
operator|*
name|pdwEffect
operator|=
name|m_chosenEffect
expr_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|"%s: compressed event"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
name|NOERROR
return|;
block|}
name|handleDrag
argument_list|(
name|dragOverWindow
argument_list|,
name|grfKeyState
argument_list|,
name|tmpPoint
argument_list|,
name|pdwEffect
argument_list|)
expr_stmt|;
return|return
name|NOERROR
return|;
block|}
end_function
begin_function
name|QT_ENSURE_STACK_ALIGNED_FOR_SSE
name|STDMETHODIMP
DECL|function|DragLeave
name|QWindowsOleDropTarget
operator|::
name|DragLeave
parameter_list|()
block|{
if|if
condition|(
name|IDropTargetHelper
modifier|*
name|dh
init|=
name|QWindowsDrag
operator|::
name|instance
argument_list|()
operator|->
name|dropHelper
argument_list|()
condition|)
name|dh
operator|->
name|DragLeave
argument_list|()
expr_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|()
operator|.
name|nospace
argument_list|()
operator|<<
name|__FUNCTION__
operator|<<
literal|' '
operator|<<
name|m_window
expr_stmt|;
name|QWindowSystemInterface
operator|::
name|handleDrag
argument_list|(
name|m_window
argument_list|,
literal|0
argument_list|,
name|QPoint
argument_list|()
argument_list|,
name|Qt
operator|::
name|IgnoreAction
argument_list|)
expr_stmt|;
name|QWindowsDrag
operator|::
name|instance
argument_list|()
operator|->
name|releaseDropDataObject
argument_list|()
expr_stmt|;
return|return
name|NOERROR
return|;
block|}
end_function
begin_define
DECL|macro|KEY_STATE_BUTTON_MASK
define|#
directive|define
name|KEY_STATE_BUTTON_MASK
value|(MK_LBUTTON | MK_MBUTTON | MK_RBUTTON)
end_define
begin_function
name|QT_ENSURE_STACK_ALIGNED_FOR_SSE
name|STDMETHODIMP
DECL|function|Drop
name|QWindowsOleDropTarget
operator|::
name|Drop
parameter_list|(
name|LPDATAOBJECT
name|pDataObj
parameter_list|,
name|DWORD
name|grfKeyState
parameter_list|,
name|POINTL
name|pt
parameter_list|,
name|LPDWORD
name|pdwEffect
parameter_list|)
block|{
if|if
condition|(
name|IDropTargetHelper
modifier|*
name|dh
init|=
name|QWindowsDrag
operator|::
name|instance
argument_list|()
operator|->
name|dropHelper
argument_list|()
condition|)
name|dh
operator|->
name|Drop
argument_list|(
name|pDataObj
argument_list|,
cast|reinterpret_cast
argument_list|<
name|POINT
operator|*
argument_list|>
argument_list|(
operator|&
name|pt
argument_list|)
argument_list|,
operator|*
name|pdwEffect
argument_list|)
expr_stmt|;
name|QWindow
modifier|*
name|dropWindow
init|=
name|findDragOverWindow
argument_list|(
name|pt
argument_list|)
decl_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|()
operator|.
name|nospace
argument_list|()
operator|<<
name|__FUNCTION__
operator|<<
literal|' '
operator|<<
name|m_window
operator|<<
literal|" on "
operator|<<
name|dropWindow
operator|<<
literal|" keys="
operator|<<
name|grfKeyState
operator|<<
literal|" pt="
operator|<<
name|pt
operator|.
name|x
operator|<<
literal|','
operator|<<
name|pt
operator|.
name|y
expr_stmt|;
name|m_lastPoint
operator|=
name|QWindowsGeometryHint
operator|::
name|mapFromGlobal
argument_list|(
name|dropWindow
argument_list|,
name|QPoint
argument_list|(
name|pt
operator|.
name|x
argument_list|,
name|pt
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
comment|// grfKeyState does not all ways contain button state in the drop so if
comment|// it doesn't then use the last known button state;
if|if
condition|(
operator|(
name|grfKeyState
operator|&
name|KEY_STATE_BUTTON_MASK
operator|)
operator|==
literal|0
condition|)
name|grfKeyState
operator||=
name|m_lastKeyState
operator|&
name|KEY_STATE_BUTTON_MASK
expr_stmt|;
name|m_lastKeyState
operator|=
name|grfKeyState
expr_stmt|;
name|QWindowsDrag
modifier|*
name|windowsDrag
init|=
name|QWindowsDrag
operator|::
name|instance
argument_list|()
decl_stmt|;
specifier|const
name|QPlatformDropQtResponse
name|response
init|=
name|QWindowSystemInterface
operator|::
name|handleDrop
argument_list|(
name|dropWindow
argument_list|,
name|windowsDrag
operator|->
name|dropData
argument_list|()
argument_list|,
name|m_lastPoint
argument_list|,
name|translateToQDragDropActions
argument_list|(
operator|*
name|pdwEffect
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|response
operator|.
name|isAccepted
argument_list|()
condition|)
block|{
specifier|const
name|Qt
operator|::
name|DropAction
name|action
init|=
name|response
operator|.
name|acceptedAction
argument_list|()
decl_stmt|;
if|if
condition|(
name|action
operator|==
name|Qt
operator|::
name|MoveAction
operator|||
name|action
operator|==
name|Qt
operator|::
name|TargetMoveAction
condition|)
block|{
if|if
condition|(
name|action
operator|==
name|Qt
operator|::
name|MoveAction
condition|)
name|m_chosenEffect
operator|=
name|DROPEFFECT_MOVE
expr_stmt|;
else|else
name|m_chosenEffect
operator|=
name|DROPEFFECT_COPY
expr_stmt|;
name|HGLOBAL
name|hData
init|=
name|GlobalAlloc
argument_list|(
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|DWORD
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|hData
condition|)
block|{
name|DWORD
modifier|*
name|moveEffect
init|=
operator|(
name|DWORD
operator|*
operator|)
name|GlobalLock
argument_list|(
name|hData
argument_list|)
decl_stmt|;
empty_stmt|;
operator|*
name|moveEffect
operator|=
name|DROPEFFECT_MOVE
expr_stmt|;
name|GlobalUnlock
argument_list|(
name|hData
argument_list|)
expr_stmt|;
name|STGMEDIUM
name|medium
decl_stmt|;
name|memset
argument_list|(
operator|&
name|medium
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|STGMEDIUM
argument_list|)
argument_list|)
expr_stmt|;
name|medium
operator|.
name|tymed
operator|=
name|TYMED_HGLOBAL
expr_stmt|;
name|medium
operator|.
name|hGlobal
operator|=
name|hData
expr_stmt|;
name|FORMATETC
name|format
decl_stmt|;
name|format
operator|.
name|cfFormat
operator|=
name|RegisterClipboardFormat
argument_list|(
name|CFSTR_PERFORMEDDROPEFFECT
argument_list|)
expr_stmt|;
name|format
operator|.
name|tymed
operator|=
name|TYMED_HGLOBAL
expr_stmt|;
name|format
operator|.
name|ptd
operator|=
literal|0
expr_stmt|;
name|format
operator|.
name|dwAspect
operator|=
literal|1
expr_stmt|;
name|format
operator|.
name|lindex
operator|=
operator|-
literal|1
expr_stmt|;
name|windowsDrag
operator|->
name|dropDataObject
argument_list|()
operator|->
name|SetData
argument_list|(
operator|&
name|format
argument_list|,
operator|&
name|medium
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|m_chosenEffect
operator|=
name|translateToWinDragEffects
argument_list|(
name|action
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|m_chosenEffect
operator|=
name|DROPEFFECT_NONE
expr_stmt|;
block|}
operator|*
name|pdwEffect
operator|=
name|m_chosenEffect
expr_stmt|;
name|windowsDrag
operator|->
name|releaseDropDataObject
argument_list|()
expr_stmt|;
return|return
name|NOERROR
return|;
block|}
end_function
begin_if
if|#
directive|if
name|defined
argument_list|(
name|Q_CC_MINGW
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|_WIN32_IE
argument_list|)
end_if
begin_define
DECL|macro|_WIN32_IE
define|#
directive|define
name|_WIN32_IE
value|0x0501
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/*!     \class QWindowsDrag     \brief Windows drag implementation.     \internal     \ingroup qt-lighthouse-win */
end_comment
begin_constructor
DECL|function|QWindowsDrag
name|QWindowsDrag
operator|::
name|QWindowsDrag
parameter_list|()
member_init_list|:
name|m_dropDataObject
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|m_cachedDropTargetHelper
argument_list|(
literal|0
argument_list|)
block|{ }
end_constructor
begin_destructor
DECL|function|~QWindowsDrag
name|QWindowsDrag
operator|::
name|~
name|QWindowsDrag
parameter_list|()
block|{
if|if
condition|(
name|m_cachedDropTargetHelper
condition|)
name|m_cachedDropTargetHelper
operator|->
name|Release
argument_list|()
expr_stmt|;
block|}
end_destructor
begin_comment
comment|/*!     \brief Return data for a drop in process. If it stems from a current drag, use a shortcut. */
end_comment
begin_function
DECL|function|dropData
name|QMimeData
modifier|*
name|QWindowsDrag
operator|::
name|dropData
parameter_list|()
block|{
if|if
condition|(
specifier|const
name|QDrag
modifier|*
name|drag
init|=
name|currentDrag
argument_list|()
condition|)
return|return
name|drag
operator|->
name|mimeData
argument_list|()
return|;
return|return
operator|&
name|m_dropData
return|;
block|}
end_function
begin_comment
comment|/*!     \brief May be used to handle extended cursors functionality for drags from outside the app. */
end_comment
begin_function
DECL|function|dropHelper
name|IDropTargetHelper
modifier|*
name|QWindowsDrag
operator|::
name|dropHelper
parameter_list|()
block|{
if|if
condition|(
operator|!
name|m_cachedDropTargetHelper
condition|)
block|{
name|CoCreateInstance
argument_list|(
name|CLSID_DragDropHelper
argument_list|,
literal|0
argument_list|,
name|CLSCTX_INPROC_SERVER
argument_list|,
name|IID_IDropTargetHelper
argument_list|,
cast|reinterpret_cast
argument_list|<
name|void
operator|*
operator|*
argument_list|>
argument_list|(
operator|&
name|m_cachedDropTargetHelper
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|m_cachedDropTargetHelper
return|;
block|}
end_function
begin_function
DECL|function|defaultCursor
name|QPixmap
name|QWindowsDrag
operator|::
name|defaultCursor
parameter_list|(
name|Qt
operator|::
name|DropAction
name|action
parameter_list|)
specifier|const
block|{
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|Qt
operator|::
name|CopyAction
case|:
if|if
condition|(
name|m_copyDragCursor
operator|.
name|isNull
argument_list|()
condition|)
name|m_copyDragCursor
operator|=
name|QPixmap
argument_list|(
name|copyDragCursorXpmC
argument_list|)
expr_stmt|;
return|return
name|m_copyDragCursor
return|;
case|case
name|Qt
operator|::
name|TargetMoveAction
case|:
case|case
name|Qt
operator|::
name|MoveAction
case|:
if|if
condition|(
name|m_moveDragCursor
operator|.
name|isNull
argument_list|()
condition|)
name|m_moveDragCursor
operator|=
name|QPixmap
argument_list|(
name|moveDragCursorXpmC
argument_list|)
expr_stmt|;
return|return
name|m_moveDragCursor
return|;
case|case
name|Qt
operator|::
name|LinkAction
case|:
if|if
condition|(
name|m_linkDragCursor
operator|.
name|isNull
argument_list|()
condition|)
name|m_linkDragCursor
operator|=
name|QPixmap
argument_list|(
name|linkDragCursorXpmC
argument_list|)
expr_stmt|;
return|return
name|m_linkDragCursor
return|;
default|default:
break|break;
block|}
if|if
condition|(
name|m_ignoreDragCursor
operator|.
name|isNull
argument_list|()
condition|)
name|m_ignoreDragCursor
operator|=
name|QPixmap
argument_list|(
name|ignoreDragCursorXpmC
argument_list|)
expr_stmt|;
return|return
name|m_ignoreDragCursor
return|;
block|}
end_function
begin_function
DECL|function|drag
name|Qt
operator|::
name|DropAction
name|QWindowsDrag
operator|::
name|drag
parameter_list|(
name|QDrag
modifier|*
name|drag
parameter_list|)
block|{
comment|// TODO: Accessibility handling?
name|QMimeData
modifier|*
name|dropData
init|=
name|drag
operator|->
name|mimeData
argument_list|()
decl_stmt|;
name|Qt
operator|::
name|DropAction
name|dragResult
init|=
name|Qt
operator|::
name|IgnoreAction
decl_stmt|;
name|DWORD
name|resultEffect
decl_stmt|;
name|QWindowsOleDropSource
modifier|*
name|windowDropSource
init|=
operator|new
name|QWindowsOleDropSource
argument_list|(
name|this
argument_list|)
decl_stmt|;
name|windowDropSource
operator|->
name|createCursors
argument_list|()
expr_stmt|;
name|QWindowsOleDataObject
modifier|*
name|dropDataObject
init|=
operator|new
name|QWindowsOleDataObject
argument_list|(
name|dropData
argument_list|)
decl_stmt|;
specifier|const
name|Qt
operator|::
name|DropActions
name|possibleActions
init|=
name|drag
operator|->
name|supportedActions
argument_list|()
decl_stmt|;
specifier|const
name|DWORD
name|allowedEffects
init|=
name|translateToWinDragEffects
argument_list|(
name|possibleActions
argument_list|)
decl_stmt|;
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|">%s possible Actions=%x, effects=0x%lx"
argument_list|,
name|__FUNCTION__
argument_list|,
name|int
argument_list|(
name|possibleActions
argument_list|)
argument_list|,
name|allowedEffects
argument_list|)
expr_stmt|;
specifier|const
name|HRESULT
name|r
init|=
name|DoDragDrop
argument_list|(
name|dropDataObject
argument_list|,
name|windowDropSource
argument_list|,
name|allowedEffects
argument_list|,
operator|&
name|resultEffect
argument_list|)
decl_stmt|;
specifier|const
name|DWORD
name|reportedPerformedEffect
init|=
name|dropDataObject
operator|->
name|reportedPerformedEffect
argument_list|()
decl_stmt|;
if|if
condition|(
name|r
operator|==
name|DRAGDROP_S_DROP
condition|)
block|{
if|if
condition|(
name|reportedPerformedEffect
operator|==
name|DROPEFFECT_MOVE
operator|&&
name|resultEffect
operator|!=
name|DROPEFFECT_MOVE
condition|)
block|{
name|dragResult
operator|=
name|Qt
operator|::
name|TargetMoveAction
expr_stmt|;
name|resultEffect
operator|=
name|DROPEFFECT_MOVE
expr_stmt|;
block|}
else|else
block|{
name|dragResult
operator|=
name|translateToQDragDropAction
argument_list|(
name|resultEffect
argument_list|)
expr_stmt|;
block|}
comment|// Force it to be a copy if an unsupported operation occurred.
comment|// This indicates a bug in the drop target.
if|if
condition|(
name|resultEffect
operator|!=
name|DROPEFFECT_NONE
operator|&&
operator|!
operator|(
name|resultEffect
operator|&
name|allowedEffects
operator|)
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Forcing Qt::CopyAction"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|dragResult
operator|=
name|Qt
operator|::
name|CopyAction
expr_stmt|;
block|}
block|}
comment|// clean up
name|dropDataObject
operator|->
name|releaseQt
argument_list|()
expr_stmt|;
name|dropDataObject
operator|->
name|Release
argument_list|()
expr_stmt|;
comment|// Will delete obj if refcount becomes 0
name|windowDropSource
operator|->
name|Release
argument_list|()
expr_stmt|;
comment|// Will delete src if refcount becomes 0
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|"<%s allowedEffects=0x%lx, reportedPerformedEffect=0x%lx, resultEffect=0x%lx, hr=0x%x, dropAction=%d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|allowedEffects
argument_list|,
name|reportedPerformedEffect
argument_list|,
name|resultEffect
argument_list|,
name|int
argument_list|(
name|r
argument_list|)
argument_list|,
name|dragResult
argument_list|)
expr_stmt|;
return|return
name|dragResult
return|;
block|}
end_function
begin_function
DECL|function|instance
name|QWindowsDrag
modifier|*
name|QWindowsDrag
operator|::
name|instance
parameter_list|()
block|{
return|return
cast|static_cast
argument_list|<
name|QWindowsDrag
operator|*
argument_list|>
argument_list|(
name|QWindowsIntegration
operator|::
name|instance
argument_list|()
operator|->
name|drag
argument_list|()
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|releaseDropDataObject
name|void
name|QWindowsDrag
operator|::
name|releaseDropDataObject
parameter_list|()
block|{
if|if
condition|(
name|QWindowsContext
operator|::
name|verboseOLE
condition|)
name|qDebug
argument_list|(
literal|"%s %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|m_dropDataObject
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_dropDataObject
condition|)
block|{
name|m_dropDataObject
operator|->
name|Release
argument_list|()
expr_stmt|;
name|m_dropDataObject
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function
begin_macro
name|QT_END_NAMESPACE
end_macro
end_unit
