begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2015 The Qt Company Ltd. ** Contact: http://www.qt.io/licensing/ ** ** This file is part of the plugins of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL21$ ** Commercial License Usage ** Licensees holding valid commercial Qt licenses may use this file in ** accordance with the commercial license agreement provided with the ** Software or, alternatively, in accordance with the terms contained in ** a written agreement between you and The Qt Company. For licensing terms ** and conditions see http://www.qt.io/terms-conditions. For further ** information use the contact form at http://www.qt.io/contact-us. ** ** GNU Lesser General Public License Usage ** Alternatively, this file may be used under the terms of the GNU Lesser ** General Public License version 2.1 or version 3 as published by the Free ** Software Foundation and appearing in the file LICENSE.LGPLv21 and ** LICENSE.LGPLv3 included in the packaging of this file. Please review the ** following information to ensure the GNU Lesser General Public License ** requirements will be met: https://www.gnu.org/licenses/lgpl.html and ** http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** As a special exception, The Qt Company gives you certain additional ** rights. These rights are described in The Qt Company LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"qxcbscreen.h"
end_include
begin_include
include|#
directive|include
file|"qxcbwindow.h"
end_include
begin_include
include|#
directive|include
file|"qxcbcursor.h"
end_include
begin_include
include|#
directive|include
file|"qxcbimage.h"
end_include
begin_include
include|#
directive|include
file|"qnamespace.h"
end_include
begin_include
include|#
directive|include
file|"qxcbxsettings.h"
end_include
begin_include
include|#
directive|include
file|<stdio.h>
end_include
begin_include
include|#
directive|include
file|<QDebug>
end_include
begin_include
include|#
directive|include
file|<qpa/qwindowsysteminterface.h>
end_include
begin_include
include|#
directive|include
file|<private/qmath_p.h>
end_include
begin_macro
name|QT_BEGIN_NAMESPACE
end_macro
begin_constructor
DECL|function|QXcbVirtualDesktop
name|QXcbVirtualDesktop
operator|::
name|QXcbVirtualDesktop
parameter_list|(
name|QXcbConnection
modifier|*
name|connection
parameter_list|,
name|xcb_screen_t
modifier|*
name|screen
parameter_list|,
name|int
name|number
parameter_list|)
member_init_list|:
name|QXcbObject
argument_list|(
name|connection
argument_list|)
member_init_list|,
name|m_screen
argument_list|(
name|screen
argument_list|)
member_init_list|,
name|m_number
argument_list|(
name|number
argument_list|)
member_init_list|,
name|m_xSettings
argument_list|(
name|Q_NULLPTR
argument_list|)
block|{ }
end_constructor
begin_destructor
DECL|function|~QXcbVirtualDesktop
name|QXcbVirtualDesktop
operator|::
name|~
name|QXcbVirtualDesktop
parameter_list|()
block|{
operator|delete
name|m_xSettings
expr_stmt|;
block|}
end_destructor
begin_function
DECL|function|xSettings
name|QXcbXSettings
modifier|*
name|QXcbVirtualDesktop
operator|::
name|xSettings
parameter_list|()
specifier|const
block|{
if|if
condition|(
operator|!
name|m_xSettings
condition|)
block|{
name|QXcbVirtualDesktop
modifier|*
name|self
init|=
cast|const_cast
argument_list|<
name|QXcbVirtualDesktop
operator|*
argument_list|>
argument_list|(
name|this
argument_list|)
decl_stmt|;
name|self
operator|->
name|m_xSettings
operator|=
operator|new
name|QXcbXSettings
argument_list|(
name|self
argument_list|)
expr_stmt|;
block|}
return|return
name|m_xSettings
return|;
block|}
end_function
begin_constructor
DECL|function|QXcbScreen
name|QXcbScreen
operator|::
name|QXcbScreen
parameter_list|(
name|QXcbConnection
modifier|*
name|connection
parameter_list|,
name|QXcbVirtualDesktop
modifier|*
name|virtualDesktop
parameter_list|,
name|xcb_randr_output_t
name|outputId
parameter_list|,
name|xcb_randr_get_output_info_reply_t
modifier|*
name|output
parameter_list|,
name|QString
name|outputName
parameter_list|)
member_init_list|:
name|QXcbObject
argument_list|(
name|connection
argument_list|)
member_init_list|,
name|m_virtualDesktop
argument_list|(
name|virtualDesktop
argument_list|)
member_init_list|,
name|m_output
argument_list|(
name|outputId
argument_list|)
member_init_list|,
name|m_crtc
argument_list|(
name|output
condition|?
name|output
operator|->
name|crtc
else|:
literal|0
argument_list|)
member_init_list|,
name|m_mode
argument_list|(
name|XCB_NONE
argument_list|)
member_init_list|,
name|m_primary
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|m_rotation
argument_list|(
name|XCB_RANDR_ROTATION_ROTATE_0
argument_list|)
member_init_list|,
name|m_outputName
argument_list|(
name|outputName
argument_list|)
member_init_list|,
name|m_outputSizeMillimeters
argument_list|(
name|output
condition|?
name|QSize
argument_list|(
name|output
operator|->
name|mm_width
argument_list|,
name|output
operator|->
name|mm_height
argument_list|)
else|:
name|QSize
argument_list|()
argument_list|)
member_init_list|,
name|m_virtualSize
argument_list|(
name|virtualDesktop
operator|->
name|size
argument_list|()
argument_list|)
member_init_list|,
name|m_virtualSizeMillimeters
argument_list|(
name|virtualDesktop
operator|->
name|physicalSize
argument_list|()
argument_list|)
member_init_list|,
name|m_orientation
argument_list|(
name|Qt
operator|::
name|PrimaryOrientation
argument_list|)
member_init_list|,
name|m_refreshRate
argument_list|(
literal|60
argument_list|)
member_init_list|,
name|m_forcedDpi
argument_list|(
operator|-
literal|1
argument_list|)
member_init_list|,
name|m_devicePixelRatio
argument_list|(
literal|1
argument_list|)
member_init_list|,
name|m_hintStyle
argument_list|(
name|QFontEngine
operator|::
name|HintStyle
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
member_init_list|,
name|m_noFontHinting
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|m_subpixelType
argument_list|(
name|QFontEngine
operator|::
name|SubpixelAntialiasingType
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
member_init_list|,
name|m_antialiasingEnabled
argument_list|(
operator|-
literal|1
argument_list|)
block|{
if|if
condition|(
name|connection
operator|->
name|hasXRandr
argument_list|()
condition|)
block|{
name|xcb_randr_select_input
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|screen
argument_list|()
operator|->
name|root
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|xcb_randr_get_crtc_info_cookie_t
name|crtcCookie
init|=
name|xcb_randr_get_crtc_info_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|m_crtc
argument_list|,
name|output
condition|?
name|output
operator|->
name|timestamp
else|:
literal|0
argument_list|)
decl_stmt|;
name|xcb_randr_get_crtc_info_reply_t
modifier|*
name|crtc
init|=
name|xcb_randr_get_crtc_info_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|crtcCookie
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|crtc
condition|)
block|{
name|updateGeometry
argument_list|(
name|QRect
argument_list|(
name|crtc
operator|->
name|x
argument_list|,
name|crtc
operator|->
name|y
argument_list|,
name|crtc
operator|->
name|width
argument_list|,
name|crtc
operator|->
name|height
argument_list|)
argument_list|,
name|crtc
operator|->
name|rotation
argument_list|)
expr_stmt|;
name|updateRefreshRate
argument_list|(
name|crtc
operator|->
name|mode
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|updateGeometry
argument_list|(
name|output
condition|?
name|output
operator|->
name|timestamp
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
specifier|const
name|int
name|dpr
init|=
name|int
argument_list|(
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|m_geometry
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|m_geometry
operator|=
name|QRect
argument_list|(
name|QPoint
argument_list|()
argument_list|,
name|m_virtualSize
operator|/
name|dpr
argument_list|)
expr_stmt|;
name|m_nativeGeometry
operator|=
name|QRect
argument_list|(
name|QPoint
argument_list|()
argument_list|,
name|m_virtualSize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|m_availableGeometry
operator|.
name|isEmpty
argument_list|()
condition|)
name|m_availableGeometry
operator|=
name|m_geometry
expr_stmt|;
name|readXResources
argument_list|()
expr_stmt|;
comment|// disable font hinting when we do UI scaling
specifier|static
name|bool
name|dpr_scaling_enabled
init|=
operator|(
name|qgetenv
argument_list|(
literal|"QT_DEVICE_PIXEL_RATIO"
argument_list|)
operator|.
name|toInt
argument_list|()
operator|>
literal|1
operator|||
name|qgetenv
argument_list|(
literal|"QT_DEVICE_PIXEL_RATIO"
argument_list|)
operator|.
name|toLower
argument_list|()
operator|==
literal|"auto"
operator|)
decl_stmt|;
if|if
condition|(
name|dpr_scaling_enabled
condition|)
name|m_noFontHinting
operator|=
literal|true
expr_stmt|;
name|QScopedPointer
argument_list|<
name|xcb_get_window_attributes_reply_t
argument_list|,
name|QScopedPointerPodDeleter
argument_list|>
name|rootAttribs
argument_list|(
name|xcb_get_window_attributes_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|xcb_get_window_attributes_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|screen
argument_list|()
operator|->
name|root
argument_list|)
argument_list|,
name|NULL
argument_list|)
argument_list|)
decl_stmt|;
specifier|const
name|quint32
name|existingEventMask
init|=
name|rootAttribs
operator|.
name|isNull
argument_list|()
condition|?
literal|0
else|:
name|rootAttribs
operator|->
name|your_event_mask
decl_stmt|;
specifier|const
name|quint32
name|mask
init|=
name|XCB_CW_EVENT_MASK
decl_stmt|;
specifier|const
name|quint32
name|values
index|[]
init|=
block|{
comment|// XCB_CW_EVENT_MASK
name|XCB_EVENT_MASK_ENTER_WINDOW
operator||
name|XCB_EVENT_MASK_LEAVE_WINDOW
operator||
name|XCB_EVENT_MASK_PROPERTY_CHANGE
operator||
name|XCB_EVENT_MASK_STRUCTURE_NOTIFY
comment|// for the "MANAGER" atom (system tray notification).
operator||
name|existingEventMask
comment|// don't overwrite the event mask on the root window
block|}
decl_stmt|;
name|xcb_change_window_attributes
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|screen
argument_list|()
operator|->
name|root
argument_list|,
name|mask
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|xcb_get_property_reply_t
modifier|*
name|reply
init|=
name|xcb_get_property_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|xcb_get_property_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
literal|false
argument_list|,
name|screen
argument_list|()
operator|->
name|root
argument_list|,
name|atom
argument_list|(
name|QXcbAtom
operator|::
name|_NET_SUPPORTING_WM_CHECK
argument_list|)
argument_list|,
name|XCB_ATOM_WINDOW
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|reply
operator|&&
name|reply
operator|->
name|format
operator|==
literal|32
operator|&&
name|reply
operator|->
name|type
operator|==
name|XCB_ATOM_WINDOW
condition|)
block|{
name|xcb_window_t
name|windowManager
init|=
operator|*
operator|(
operator|(
name|xcb_window_t
operator|*
operator|)
name|xcb_get_property_value
argument_list|(
name|reply
argument_list|)
operator|)
decl_stmt|;
if|if
condition|(
name|windowManager
operator|!=
name|XCB_WINDOW_NONE
condition|)
block|{
name|xcb_get_property_reply_t
modifier|*
name|windowManagerReply
init|=
name|xcb_get_property_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|xcb_get_property_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
literal|false
argument_list|,
name|windowManager
argument_list|,
name|atom
argument_list|(
name|QXcbAtom
operator|::
name|_NET_WM_NAME
argument_list|)
argument_list|,
name|atom
argument_list|(
name|QXcbAtom
operator|::
name|UTF8_STRING
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|windowManagerReply
operator|&&
name|windowManagerReply
operator|->
name|format
operator|==
literal|8
operator|&&
name|windowManagerReply
operator|->
name|type
operator|==
name|atom
argument_list|(
name|QXcbAtom
operator|::
name|UTF8_STRING
argument_list|)
condition|)
block|{
name|m_windowManagerName
operator|=
name|QString
operator|::
name|fromUtf8
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|xcb_get_property_value
argument_list|(
name|windowManagerReply
argument_list|)
argument_list|,
name|xcb_get_property_value_length
argument_list|(
name|windowManagerReply
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|windowManagerReply
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
specifier|const
name|xcb_query_extension_reply_t
modifier|*
name|sync_reply
init|=
name|xcb_get_extension_data
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
operator|&
name|xcb_sync_id
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|sync_reply
operator|||
operator|!
name|sync_reply
operator|->
name|present
condition|)
name|m_syncRequestSupported
operator|=
literal|false
expr_stmt|;
else|else
name|m_syncRequestSupported
operator|=
literal|true
expr_stmt|;
name|xcb_depth_iterator_t
name|depth_iterator
init|=
name|xcb_screen_allowed_depths_iterator
argument_list|(
name|screen
argument_list|()
argument_list|)
decl_stmt|;
while|while
condition|(
name|depth_iterator
operator|.
name|rem
condition|)
block|{
name|xcb_depth_t
modifier|*
name|depth
init|=
name|depth_iterator
operator|.
name|data
decl_stmt|;
name|xcb_visualtype_iterator_t
name|visualtype_iterator
init|=
name|xcb_depth_visuals_iterator
argument_list|(
name|depth
argument_list|)
decl_stmt|;
while|while
condition|(
name|visualtype_iterator
operator|.
name|rem
condition|)
block|{
name|xcb_visualtype_t
modifier|*
name|visualtype
init|=
name|visualtype_iterator
operator|.
name|data
decl_stmt|;
name|m_visuals
operator|.
name|insert
argument_list|(
name|visualtype
operator|->
name|visual_id
argument_list|,
operator|*
name|visualtype
argument_list|)
expr_stmt|;
name|m_visualDepths
operator|.
name|insert
argument_list|(
name|visualtype
operator|->
name|visual_id
argument_list|,
name|depth
operator|->
name|depth
argument_list|)
expr_stmt|;
name|xcb_visualtype_next
argument_list|(
operator|&
name|visualtype_iterator
argument_list|)
expr_stmt|;
block|}
name|xcb_depth_next
argument_list|(
operator|&
name|depth_iterator
argument_list|)
expr_stmt|;
block|}
name|m_cursor
operator|=
operator|new
name|QXcbCursor
argument_list|(
name|connection
argument_list|,
name|this
argument_list|)
expr_stmt|;
block|}
end_constructor
begin_destructor
DECL|function|~QXcbScreen
name|QXcbScreen
operator|::
name|~
name|QXcbScreen
parameter_list|()
block|{
operator|delete
name|m_cursor
expr_stmt|;
block|}
end_destructor
begin_function
DECL|function|topLevelAt
name|QWindow
modifier|*
name|QXcbScreen
operator|::
name|topLevelAt
parameter_list|(
specifier|const
name|QPoint
modifier|&
name|p
parameter_list|)
specifier|const
block|{
name|xcb_window_t
name|root
init|=
name|screen
argument_list|()
operator|->
name|root
decl_stmt|;
name|int
name|dpr
init|=
name|int
argument_list|(
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
name|int
name|x
init|=
name|p
operator|.
name|x
argument_list|()
operator|/
name|dpr
decl_stmt|;
name|int
name|y
init|=
name|p
operator|.
name|y
argument_list|()
operator|/
name|dpr
decl_stmt|;
name|xcb_window_t
name|parent
init|=
name|root
decl_stmt|;
name|xcb_window_t
name|child
init|=
name|root
decl_stmt|;
do|do
block|{
name|xcb_translate_coordinates_cookie_t
name|translate_cookie
init|=
name|xcb_translate_coordinates_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|parent
argument_list|,
name|child
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
decl_stmt|;
name|xcb_translate_coordinates_reply_t
modifier|*
name|translate_reply
init|=
name|xcb_translate_coordinates_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|translate_cookie
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|translate_reply
condition|)
block|{
return|return
literal|0
return|;
block|}
name|parent
operator|=
name|child
expr_stmt|;
name|child
operator|=
name|translate_reply
operator|->
name|child
expr_stmt|;
name|x
operator|=
name|translate_reply
operator|->
name|dst_x
expr_stmt|;
name|y
operator|=
name|translate_reply
operator|->
name|dst_y
expr_stmt|;
name|free
argument_list|(
name|translate_reply
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|child
operator|||
name|child
operator|==
name|root
condition|)
return|return
literal|0
return|;
name|QPlatformWindow
modifier|*
name|platformWindow
init|=
name|connection
argument_list|()
operator|->
name|platformWindowFromId
argument_list|(
name|child
argument_list|)
decl_stmt|;
if|if
condition|(
name|platformWindow
condition|)
return|return
name|platformWindow
operator|->
name|window
argument_list|()
return|;
block|}
do|while
condition|(
name|parent
operator|!=
name|child
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|mapToNative
name|QPoint
name|QXcbScreen
operator|::
name|mapToNative
parameter_list|(
specifier|const
name|QPoint
modifier|&
name|pos
parameter_list|)
specifier|const
block|{
specifier|const
name|int
name|dpr
init|=
name|int
argument_list|(
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
return|return
operator|(
name|pos
operator|-
name|m_geometry
operator|.
name|topLeft
argument_list|()
operator|)
operator|*
name|dpr
operator|+
name|m_nativeGeometry
operator|.
name|topLeft
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|mapFromNative
name|QPoint
name|QXcbScreen
operator|::
name|mapFromNative
parameter_list|(
specifier|const
name|QPoint
modifier|&
name|pos
parameter_list|)
specifier|const
block|{
specifier|const
name|int
name|dpr
init|=
name|int
argument_list|(
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
return|return
operator|(
name|pos
operator|-
name|m_nativeGeometry
operator|.
name|topLeft
argument_list|()
operator|)
operator|/
name|dpr
operator|+
name|m_geometry
operator|.
name|topLeft
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|mapToNative
name|QPointF
name|QXcbScreen
operator|::
name|mapToNative
parameter_list|(
specifier|const
name|QPointF
modifier|&
name|pos
parameter_list|)
specifier|const
block|{
specifier|const
name|int
name|dpr
init|=
name|int
argument_list|(
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
return|return
operator|(
name|pos
operator|-
name|m_geometry
operator|.
name|topLeft
argument_list|()
operator|)
operator|*
name|dpr
operator|+
name|m_nativeGeometry
operator|.
name|topLeft
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|mapFromNative
name|QPointF
name|QXcbScreen
operator|::
name|mapFromNative
parameter_list|(
specifier|const
name|QPointF
modifier|&
name|pos
parameter_list|)
specifier|const
block|{
specifier|const
name|int
name|dpr
init|=
name|int
argument_list|(
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
return|return
operator|(
name|pos
operator|-
name|m_nativeGeometry
operator|.
name|topLeft
argument_list|()
operator|)
operator|/
name|dpr
operator|+
name|m_geometry
operator|.
name|topLeft
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|mapToNative
name|QRect
name|QXcbScreen
operator|::
name|mapToNative
parameter_list|(
specifier|const
name|QRect
modifier|&
name|rect
parameter_list|)
specifier|const
block|{
specifier|const
name|int
name|dpr
init|=
name|int
argument_list|(
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|QRect
argument_list|(
name|mapToNative
argument_list|(
name|rect
operator|.
name|topLeft
argument_list|()
argument_list|)
argument_list|,
name|rect
operator|.
name|size
argument_list|()
operator|*
name|dpr
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|mapFromNative
name|QRect
name|QXcbScreen
operator|::
name|mapFromNative
parameter_list|(
specifier|const
name|QRect
modifier|&
name|rect
parameter_list|)
specifier|const
block|{
specifier|const
name|int
name|dpr
init|=
name|int
argument_list|(
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|QRect
argument_list|(
name|mapFromNative
argument_list|(
name|rect
operator|.
name|topLeft
argument_list|()
argument_list|)
argument_list|,
name|rect
operator|.
name|size
argument_list|()
operator|/
name|dpr
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|windowShown
name|void
name|QXcbScreen
operator|::
name|windowShown
parameter_list|(
name|QXcbWindow
modifier|*
name|window
parameter_list|)
block|{
comment|// Freedesktop.org Startup Notification
if|if
condition|(
operator|!
name|connection
argument_list|()
operator|->
name|startupId
argument_list|()
operator|.
name|isEmpty
argument_list|()
operator|&&
name|window
operator|->
name|window
argument_list|()
operator|->
name|isTopLevel
argument_list|()
condition|)
block|{
name|sendStartupMessage
argument_list|(
name|QByteArrayLiteral
argument_list|(
literal|"remove: ID="
argument_list|)
operator|+
name|connection
argument_list|()
operator|->
name|startupId
argument_list|()
argument_list|)
expr_stmt|;
name|connection
argument_list|()
operator|->
name|clearStartupId
argument_list|()
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|sendStartupMessage
name|void
name|QXcbScreen
operator|::
name|sendStartupMessage
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|message
parameter_list|)
specifier|const
block|{
name|xcb_window_t
name|rootWindow
init|=
name|root
argument_list|()
decl_stmt|;
name|xcb_client_message_event_t
name|ev
decl_stmt|;
name|ev
operator|.
name|response_type
operator|=
name|XCB_CLIENT_MESSAGE
expr_stmt|;
name|ev
operator|.
name|format
operator|=
literal|8
expr_stmt|;
name|ev
operator|.
name|type
operator|=
name|connection
argument_list|()
operator|->
name|atom
argument_list|(
name|QXcbAtom
operator|::
name|_NET_STARTUP_INFO_BEGIN
argument_list|)
expr_stmt|;
name|ev
operator|.
name|window
operator|=
name|rootWindow
expr_stmt|;
name|int
name|sent
init|=
literal|0
decl_stmt|;
name|int
name|length
init|=
name|message
operator|.
name|length
argument_list|()
operator|+
literal|1
decl_stmt|;
comment|// include NUL byte
specifier|const
name|char
modifier|*
name|data
init|=
name|message
operator|.
name|constData
argument_list|()
decl_stmt|;
do|do
block|{
if|if
condition|(
name|sent
operator|==
literal|20
condition|)
name|ev
operator|.
name|type
operator|=
name|connection
argument_list|()
operator|->
name|atom
argument_list|(
name|QXcbAtom
operator|::
name|_NET_STARTUP_INFO
argument_list|)
expr_stmt|;
specifier|const
name|int
name|start
init|=
name|sent
decl_stmt|;
specifier|const
name|int
name|numBytes
init|=
name|qMin
argument_list|(
name|length
operator|-
name|start
argument_list|,
literal|20
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|ev
operator|.
name|data
operator|.
name|data8
argument_list|,
name|data
operator|+
name|start
argument_list|,
name|numBytes
argument_list|)
expr_stmt|;
name|xcb_send_event
argument_list|(
name|connection
argument_list|()
operator|->
name|xcb_connection
argument_list|()
argument_list|,
literal|false
argument_list|,
name|rootWindow
argument_list|,
name|XCB_EVENT_MASK_PROPERTY_CHANGE
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|ev
argument_list|)
expr_stmt|;
name|sent
operator|+=
name|numBytes
expr_stmt|;
block|}
do|while
condition|(
name|sent
operator|<
name|length
condition|)
do|;
block|}
end_function
begin_function
DECL|function|visualForId
specifier|const
name|xcb_visualtype_t
modifier|*
name|QXcbScreen
operator|::
name|visualForId
parameter_list|(
name|xcb_visualid_t
name|visualid
parameter_list|)
specifier|const
block|{
name|QMap
argument_list|<
name|xcb_visualid_t
argument_list|,
name|xcb_visualtype_t
argument_list|>
operator|::
name|const_iterator
name|it
init|=
name|m_visuals
operator|.
name|find
argument_list|(
name|visualid
argument_list|)
decl_stmt|;
if|if
condition|(
name|it
operator|==
name|m_visuals
operator|.
name|constEnd
argument_list|()
condition|)
return|return
literal|0
return|;
return|return
operator|&
operator|*
name|it
return|;
block|}
end_function
begin_function
DECL|function|depthOfVisual
name|quint8
name|QXcbScreen
operator|::
name|depthOfVisual
parameter_list|(
name|xcb_visualid_t
name|visualid
parameter_list|)
specifier|const
block|{
name|QMap
argument_list|<
name|xcb_visualid_t
argument_list|,
name|quint8
argument_list|>
operator|::
name|const_iterator
name|it
init|=
name|m_visualDepths
operator|.
name|find
argument_list|(
name|visualid
argument_list|)
decl_stmt|;
if|if
condition|(
name|it
operator|==
name|m_visualDepths
operator|.
name|constEnd
argument_list|()
condition|)
return|return
literal|0
return|;
return|return
operator|*
name|it
return|;
block|}
end_function
begin_function
DECL|function|format
name|QImage
operator|::
name|Format
name|QXcbScreen
operator|::
name|format
parameter_list|()
specifier|const
block|{
return|return
name|QImage
operator|::
name|Format_RGB32
return|;
block|}
end_function
begin_function
DECL|function|virtualDpi
name|QDpi
name|QXcbScreen
operator|::
name|virtualDpi
parameter_list|()
specifier|const
block|{
return|return
name|QDpi
argument_list|(
name|Q_MM_PER_INCH
operator|*
name|m_virtualSize
operator|.
name|width
argument_list|()
operator|/
name|m_virtualSizeMillimeters
operator|.
name|width
argument_list|()
argument_list|,
name|Q_MM_PER_INCH
operator|*
name|m_virtualSize
operator|.
name|height
argument_list|()
operator|/
name|m_virtualSizeMillimeters
operator|.
name|height
argument_list|()
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|logicalDpi
name|QDpi
name|QXcbScreen
operator|::
name|logicalDpi
parameter_list|()
specifier|const
block|{
specifier|static
specifier|const
name|int
name|overrideDpi
init|=
name|qEnvironmentVariableIntValue
argument_list|(
literal|"QT_FONT_DPI"
argument_list|)
decl_stmt|;
if|if
condition|(
name|overrideDpi
condition|)
return|return
name|QDpi
argument_list|(
name|overrideDpi
argument_list|,
name|overrideDpi
argument_list|)
return|;
name|int
name|primaryDpr
init|=
name|int
argument_list|(
name|connection
argument_list|()
operator|->
name|screens
argument_list|()
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|->
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|m_forcedDpi
operator|>
literal|0
condition|)
return|return
name|QDpi
argument_list|(
name|m_forcedDpi
operator|/
name|primaryDpr
argument_list|,
name|m_forcedDpi
operator|/
name|primaryDpr
argument_list|)
return|;
name|QDpi
name|vDpi
init|=
name|virtualDpi
argument_list|()
decl_stmt|;
return|return
name|QDpi
argument_list|(
name|vDpi
operator|.
name|first
operator|/
name|primaryDpr
argument_list|,
name|vDpi
operator|.
name|second
operator|/
name|primaryDpr
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|devicePixelRatio
name|qreal
name|QXcbScreen
operator|::
name|devicePixelRatio
parameter_list|()
specifier|const
block|{
specifier|static
name|int
name|override_dpr
init|=
name|qEnvironmentVariableIntValue
argument_list|(
literal|"QT_DEVICE_PIXEL_RATIO"
argument_list|)
decl_stmt|;
specifier|static
name|bool
name|auto_dpr
init|=
name|qgetenv
argument_list|(
literal|"QT_DEVICE_PIXEL_RATIO"
argument_list|)
operator|.
name|toLower
argument_list|()
operator|==
literal|"auto"
decl_stmt|;
if|if
condition|(
name|override_dpr
operator|>
literal|0
condition|)
return|return
name|override_dpr
return|;
if|if
condition|(
name|auto_dpr
condition|)
return|return
name|m_devicePixelRatio
return|;
return|return
literal|1.0
return|;
block|}
end_function
begin_function
DECL|function|cursor
name|QPlatformCursor
modifier|*
name|QXcbScreen
operator|::
name|cursor
parameter_list|()
specifier|const
block|{
return|return
name|m_cursor
return|;
block|}
end_function
begin_comment
comment|/*!     \brief handle the XCB screen change event and update properties      On a mobile device, the ideal use case is that the accelerometer would     drive the orientation. This could be achieved by using QSensors to read the     accelerometer and adjusting the rotation in QML, or by reading the     orientation from the QScreen object and doing the same, or in many other     ways. However, on X we have the XRandR extension, which makes it possible     to have the whole screen rotated, so that individual apps DO NOT have to     rotate themselves. Apps could optionally use the     QScreen::primaryOrientation property to optimize layout though.     Furthermore, there is no support in X for accelerometer events anyway. So     it makes more sense on a Linux system running X to just run a daemon which     monitors the accelerometer and runs xrandr automatically to do the rotation,     then apps do not have to be aware of it (but probably the window manager     would resize them accordingly). updateGeometry() is written with this     design in mind. Therefore the physical geometry, available geometry,     virtual geometry, orientation and primaryOrientation should all change at     the same time.  On a system which cannot rotate the whole screen, it would     be correct for only the orientation (not the primary orientation) to     change. */
end_comment
begin_function
DECL|function|handleScreenChange
name|void
name|QXcbScreen
operator|::
name|handleScreenChange
parameter_list|(
name|xcb_randr_screen_change_notify_event_t
modifier|*
name|change_event
parameter_list|)
block|{
comment|// No need to do anything when screen rotation did not change - if any
comment|// xcb output geometry has changed, we will get RRCrtcChangeNotify and
comment|// RROutputChangeNotify events next
if|if
condition|(
name|change_event
operator|->
name|rotation
operator|==
name|m_rotation
condition|)
return|return;
name|m_rotation
operator|=
name|change_event
operator|->
name|rotation
expr_stmt|;
switch|switch
condition|(
name|m_rotation
condition|)
block|{
case|case
name|XCB_RANDR_ROTATION_ROTATE_0
case|:
comment|// xrandr --rotate normal
name|m_orientation
operator|=
name|Qt
operator|::
name|LandscapeOrientation
expr_stmt|;
name|m_virtualSize
operator|.
name|setWidth
argument_list|(
name|change_event
operator|->
name|width
argument_list|)
expr_stmt|;
name|m_virtualSize
operator|.
name|setHeight
argument_list|(
name|change_event
operator|->
name|height
argument_list|)
expr_stmt|;
name|m_virtualSizeMillimeters
operator|.
name|setWidth
argument_list|(
name|change_event
operator|->
name|mwidth
argument_list|)
expr_stmt|;
name|m_virtualSizeMillimeters
operator|.
name|setHeight
argument_list|(
name|change_event
operator|->
name|mheight
argument_list|)
expr_stmt|;
break|break;
case|case
name|XCB_RANDR_ROTATION_ROTATE_90
case|:
comment|// xrandr --rotate left
name|m_orientation
operator|=
name|Qt
operator|::
name|PortraitOrientation
expr_stmt|;
name|m_virtualSize
operator|.
name|setWidth
argument_list|(
name|change_event
operator|->
name|height
argument_list|)
expr_stmt|;
name|m_virtualSize
operator|.
name|setHeight
argument_list|(
name|change_event
operator|->
name|width
argument_list|)
expr_stmt|;
name|m_virtualSizeMillimeters
operator|.
name|setWidth
argument_list|(
name|change_event
operator|->
name|mheight
argument_list|)
expr_stmt|;
name|m_virtualSizeMillimeters
operator|.
name|setHeight
argument_list|(
name|change_event
operator|->
name|mwidth
argument_list|)
expr_stmt|;
break|break;
case|case
name|XCB_RANDR_ROTATION_ROTATE_180
case|:
comment|// xrandr --rotate inverted
name|m_orientation
operator|=
name|Qt
operator|::
name|InvertedLandscapeOrientation
expr_stmt|;
name|m_virtualSize
operator|.
name|setWidth
argument_list|(
name|change_event
operator|->
name|width
argument_list|)
expr_stmt|;
name|m_virtualSize
operator|.
name|setHeight
argument_list|(
name|change_event
operator|->
name|height
argument_list|)
expr_stmt|;
name|m_virtualSizeMillimeters
operator|.
name|setWidth
argument_list|(
name|change_event
operator|->
name|mwidth
argument_list|)
expr_stmt|;
name|m_virtualSizeMillimeters
operator|.
name|setHeight
argument_list|(
name|change_event
operator|->
name|mheight
argument_list|)
expr_stmt|;
break|break;
case|case
name|XCB_RANDR_ROTATION_ROTATE_270
case|:
comment|// xrandr --rotate right
name|m_orientation
operator|=
name|Qt
operator|::
name|InvertedPortraitOrientation
expr_stmt|;
name|m_virtualSize
operator|.
name|setWidth
argument_list|(
name|change_event
operator|->
name|height
argument_list|)
expr_stmt|;
name|m_virtualSize
operator|.
name|setHeight
argument_list|(
name|change_event
operator|->
name|width
argument_list|)
expr_stmt|;
name|m_virtualSizeMillimeters
operator|.
name|setWidth
argument_list|(
name|change_event
operator|->
name|mheight
argument_list|)
expr_stmt|;
name|m_virtualSizeMillimeters
operator|.
name|setHeight
argument_list|(
name|change_event
operator|->
name|mwidth
argument_list|)
expr_stmt|;
break|break;
comment|// We don't need to do anything with these, since QScreen doesn't store reflection state,
comment|// and Qt-based applications probably don't need to care about it anyway.
case|case
name|XCB_RANDR_ROTATION_REFLECT_X
case|:
break|break;
case|case
name|XCB_RANDR_ROTATION_REFLECT_Y
case|:
break|break;
block|}
name|updateGeometry
argument_list|(
name|change_event
operator|->
name|timestamp
argument_list|)
expr_stmt|;
name|QWindowSystemInterface
operator|::
name|handleScreenGeometryChange
argument_list|(
name|QPlatformScreen
operator|::
name|screen
argument_list|()
argument_list|,
name|geometry
argument_list|()
argument_list|,
name|availableGeometry
argument_list|()
argument_list|)
expr_stmt|;
name|QWindowSystemInterface
operator|::
name|handleScreenOrientationChange
argument_list|(
name|QPlatformScreen
operator|::
name|screen
argument_list|()
argument_list|,
name|m_orientation
argument_list|)
expr_stmt|;
name|QDpi
name|ldpi
init|=
name|logicalDpi
argument_list|()
decl_stmt|;
name|QWindowSystemInterface
operator|::
name|handleScreenLogicalDotsPerInchChange
argument_list|(
name|QPlatformScreen
operator|::
name|screen
argument_list|()
argument_list|,
name|ldpi
operator|.
name|first
argument_list|,
name|ldpi
operator|.
name|second
argument_list|)
expr_stmt|;
comment|// Windows which had null screens have already had expose events by now.
comment|// They need to be told the screen is back, it's OK to render.
foreach|foreach
control|(
name|QWindow
modifier|*
name|window
decl|,
name|QGuiApplication
operator|::
name|topLevelWindows
argument_list|()
control|)
block|{
name|QXcbWindow
modifier|*
name|xcbWin
init|=
cast|static_cast
argument_list|<
name|QXcbWindow
operator|*
argument_list|>
argument_list|(
name|window
operator|->
name|handle
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|xcbWin
condition|)
name|xcbWin
operator|->
name|maybeSetScreen
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|updateGeometry
name|void
name|QXcbScreen
operator|::
name|updateGeometry
parameter_list|(
name|xcb_timestamp_t
name|timestamp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|connection
argument_list|()
operator|->
name|hasXRandr
argument_list|()
condition|)
return|return;
name|xcb_randr_get_crtc_info_cookie_t
name|crtcCookie
init|=
name|xcb_randr_get_crtc_info_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|m_crtc
argument_list|,
name|timestamp
argument_list|)
decl_stmt|;
name|xcb_randr_get_crtc_info_reply_t
modifier|*
name|crtc
init|=
name|xcb_randr_get_crtc_info_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|crtcCookie
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|crtc
condition|)
block|{
name|updateGeometry
argument_list|(
name|QRect
argument_list|(
name|crtc
operator|->
name|x
argument_list|,
name|crtc
operator|->
name|y
argument_list|,
name|crtc
operator|->
name|width
argument_list|,
name|crtc
operator|->
name|height
argument_list|)
argument_list|,
name|crtc
operator|->
name|rotation
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|updateGeometry
name|void
name|QXcbScreen
operator|::
name|updateGeometry
parameter_list|(
specifier|const
name|QRect
modifier|&
name|geom
parameter_list|,
name|uint8_t
name|rotation
parameter_list|)
block|{
name|QRect
name|xGeometry
init|=
name|geom
decl_stmt|;
name|QRect
name|xAvailableGeometry
init|=
name|xGeometry
decl_stmt|;
switch|switch
condition|(
name|rotation
condition|)
block|{
case|case
name|XCB_RANDR_ROTATION_ROTATE_0
case|:
comment|// xrandr --rotate normal
name|m_orientation
operator|=
name|Qt
operator|::
name|LandscapeOrientation
expr_stmt|;
name|m_sizeMillimeters
operator|=
name|m_outputSizeMillimeters
expr_stmt|;
break|break;
case|case
name|XCB_RANDR_ROTATION_ROTATE_90
case|:
comment|// xrandr --rotate left
name|m_orientation
operator|=
name|Qt
operator|::
name|PortraitOrientation
expr_stmt|;
name|m_sizeMillimeters
operator|=
name|m_outputSizeMillimeters
operator|.
name|transposed
argument_list|()
expr_stmt|;
break|break;
case|case
name|XCB_RANDR_ROTATION_ROTATE_180
case|:
comment|// xrandr --rotate inverted
name|m_orientation
operator|=
name|Qt
operator|::
name|InvertedLandscapeOrientation
expr_stmt|;
name|m_sizeMillimeters
operator|=
name|m_outputSizeMillimeters
expr_stmt|;
break|break;
case|case
name|XCB_RANDR_ROTATION_ROTATE_270
case|:
comment|// xrandr --rotate right
name|m_orientation
operator|=
name|Qt
operator|::
name|InvertedPortraitOrientation
expr_stmt|;
name|m_sizeMillimeters
operator|=
name|m_outputSizeMillimeters
operator|.
name|transposed
argument_list|()
expr_stmt|;
break|break;
block|}
comment|// It can be that physical size is unknown while virtual size
comment|// is known (probably back-calculated from DPI and resolution),
comment|// e.g. on VNC or with some hardware.
if|if
condition|(
name|m_sizeMillimeters
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|QDpi
name|dpi
init|=
name|virtualDpi
argument_list|()
decl_stmt|;
name|m_sizeMillimeters
operator|=
name|QSizeF
argument_list|(
name|Q_MM_PER_INCH
operator|*
name|xGeometry
operator|.
name|width
argument_list|()
operator|/
name|dpi
operator|.
name|first
argument_list|,
name|Q_MM_PER_INCH
operator|*
name|xGeometry
operator|.
name|width
argument_list|()
operator|/
name|dpi
operator|.
name|second
argument_list|)
expr_stmt|;
block|}
name|xcb_get_property_reply_t
modifier|*
name|workArea
init|=
name|xcb_get_property_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|xcb_get_property_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
literal|false
argument_list|,
name|screen
argument_list|()
operator|->
name|root
argument_list|,
name|atom
argument_list|(
name|QXcbAtom
operator|::
name|_NET_WORKAREA
argument_list|)
argument_list|,
name|XCB_ATOM_CARDINAL
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|workArea
operator|&&
name|workArea
operator|->
name|type
operator|==
name|XCB_ATOM_CARDINAL
operator|&&
name|workArea
operator|->
name|format
operator|==
literal|32
operator|&&
name|workArea
operator|->
name|value_len
operator|>=
literal|4
condition|)
block|{
comment|// If workArea->value_len> 4, the remaining ones seem to be for virtual desktops.
comment|// But QScreen doesn't know about that concept.  In reality there could be a
comment|// "docked" panel (with _NET_WM_STRUT_PARTIAL atom set) on just one desktop.
comment|// But for now just assume the first 4 values give us the geometry of the
comment|// "work area", AKA "available geometry"
name|uint32_t
modifier|*
name|geom
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|xcb_get_property_value
argument_list|(
name|workArea
argument_list|)
decl_stmt|;
name|QRect
name|virtualAvailableGeometry
argument_list|(
name|geom
index|[
literal|0
index|]
argument_list|,
name|geom
index|[
literal|1
index|]
argument_list|,
name|geom
index|[
literal|2
index|]
argument_list|,
name|geom
index|[
literal|3
index|]
argument_list|)
decl_stmt|;
comment|// Take the intersection of the desktop's available geometry with this screen's geometry
comment|// to get the part of the available geometry which belongs to this screen.
name|xAvailableGeometry
operator|=
name|xGeometry
operator|&
name|virtualAvailableGeometry
expr_stmt|;
block|}
name|free
argument_list|(
name|workArea
argument_list|)
expr_stmt|;
name|qreal
name|dpi
init|=
name|xGeometry
operator|.
name|width
argument_list|()
operator|/
name|physicalSize
argument_list|()
operator|.
name|width
argument_list|()
operator|*
name|qreal
argument_list|(
literal|25.4
argument_list|)
decl_stmt|;
name|m_devicePixelRatio
operator|=
name|qRound
argument_list|(
name|dpi
operator|/
literal|96
argument_list|)
expr_stmt|;
specifier|const
name|int
name|dpr
init|=
name|int
argument_list|(
name|devicePixelRatio
argument_list|()
argument_list|)
decl_stmt|;
comment|// we may override m_devicePixelRatio
name|m_geometry
operator|=
name|QRect
argument_list|(
name|xGeometry
operator|.
name|topLeft
argument_list|()
argument_list|,
name|xGeometry
operator|.
name|size
argument_list|()
operator|/
name|dpr
argument_list|)
expr_stmt|;
name|m_nativeGeometry
operator|=
name|QRect
argument_list|(
name|xGeometry
operator|.
name|topLeft
argument_list|()
argument_list|,
name|xGeometry
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|m_availableGeometry
operator|=
name|QRect
argument_list|(
name|mapFromNative
argument_list|(
name|xAvailableGeometry
operator|.
name|topLeft
argument_list|()
argument_list|)
argument_list|,
name|xAvailableGeometry
operator|.
name|size
argument_list|()
operator|/
name|dpr
argument_list|)
expr_stmt|;
name|QWindowSystemInterface
operator|::
name|handleScreenGeometryChange
argument_list|(
name|QPlatformScreen
operator|::
name|screen
argument_list|()
argument_list|,
name|m_geometry
argument_list|,
name|m_availableGeometry
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|updateRefreshRate
name|void
name|QXcbScreen
operator|::
name|updateRefreshRate
parameter_list|(
name|xcb_randr_mode_t
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|!
name|connection
argument_list|()
operator|->
name|hasXRandr
argument_list|()
condition|)
return|return;
if|if
condition|(
name|m_mode
operator|==
name|mode
condition|)
return|return;
comment|// we can safely use get_screen_resources_current here, because in order to
comment|// get here, we must have called get_screen_resources before
name|xcb_randr_get_screen_resources_current_cookie_t
name|resourcesCookie
init|=
name|xcb_randr_get_screen_resources_current_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|screen
argument_list|()
operator|->
name|root
argument_list|)
decl_stmt|;
name|xcb_randr_get_screen_resources_current_reply_t
modifier|*
name|resources
init|=
name|xcb_randr_get_screen_resources_current_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|resourcesCookie
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|resources
condition|)
block|{
name|xcb_randr_mode_info_iterator_t
name|modesIter
init|=
name|xcb_randr_get_screen_resources_current_modes_iterator
argument_list|(
name|resources
argument_list|)
decl_stmt|;
for|for
control|(
init|;
name|modesIter
operator|.
name|rem
condition|;
name|xcb_randr_mode_info_next
argument_list|(
operator|&
name|modesIter
argument_list|)
control|)
block|{
name|xcb_randr_mode_info_t
modifier|*
name|modeInfo
init|=
name|modesIter
operator|.
name|data
decl_stmt|;
if|if
condition|(
name|modeInfo
operator|->
name|id
operator|==
name|mode
condition|)
block|{
name|m_refreshRate
operator|=
name|modeInfo
operator|->
name|dot_clock
operator|/
operator|(
name|modeInfo
operator|->
name|htotal
operator|*
name|modeInfo
operator|->
name|vtotal
operator|)
expr_stmt|;
name|m_mode
operator|=
name|mode
expr_stmt|;
break|break;
block|}
block|}
name|free
argument_list|(
name|resources
argument_list|)
expr_stmt|;
name|QWindowSystemInterface
operator|::
name|handleScreenRefreshRateChange
argument_list|(
name|QPlatformScreen
operator|::
name|screen
argument_list|()
argument_list|,
name|m_refreshRate
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|grabWindow
name|QPixmap
name|QXcbScreen
operator|::
name|grabWindow
parameter_list|(
name|WId
name|window
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
specifier|const
block|{
if|if
condition|(
name|width
operator|==
literal|0
operator|||
name|height
operator|==
literal|0
condition|)
return|return
name|QPixmap
argument_list|()
return|;
comment|// TODO: handle multiple screens
name|QXcbScreen
modifier|*
name|screen
init|=
cast|const_cast
argument_list|<
name|QXcbScreen
operator|*
argument_list|>
argument_list|(
name|this
argument_list|)
decl_stmt|;
name|xcb_window_t
name|root
init|=
name|screen
operator|->
name|root
argument_list|()
decl_stmt|;
if|if
condition|(
name|window
operator|==
literal|0
condition|)
name|window
operator|=
name|root
expr_stmt|;
name|xcb_get_geometry_cookie_t
name|geometry_cookie
init|=
name|xcb_get_geometry_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|window
argument_list|)
decl_stmt|;
name|xcb_get_geometry_reply_t
modifier|*
name|reply
init|=
name|xcb_get_geometry_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|geometry_cookie
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|reply
condition|)
block|{
return|return
name|QPixmap
argument_list|()
return|;
block|}
if|if
condition|(
name|width
operator|<
literal|0
condition|)
name|width
operator|=
name|reply
operator|->
name|width
operator|-
name|x
expr_stmt|;
if|if
condition|(
name|height
operator|<
literal|0
condition|)
name|height
operator|=
name|reply
operator|->
name|height
operator|-
name|y
expr_stmt|;
name|geometry_cookie
operator|=
name|xcb_get_geometry_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|root
argument_list|)
expr_stmt|;
name|xcb_get_geometry_reply_t
modifier|*
name|root_reply
init|=
name|xcb_get_geometry_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|geometry_cookie
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|root_reply
condition|)
block|{
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
name|QPixmap
argument_list|()
return|;
block|}
if|if
condition|(
name|reply
operator|->
name|depth
operator|==
name|root_reply
operator|->
name|depth
condition|)
block|{
comment|// if the depth of the specified window and the root window are the
comment|// same, grab pixels from the root window (so that we get the any
comment|// overlapping windows and window manager frames)
comment|// map x and y to the root window
name|xcb_translate_coordinates_cookie_t
name|translate_cookie
init|=
name|xcb_translate_coordinates_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|window
argument_list|,
name|root
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
decl_stmt|;
name|xcb_translate_coordinates_reply_t
modifier|*
name|translate_reply
init|=
name|xcb_translate_coordinates_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|translate_cookie
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|translate_reply
condition|)
block|{
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|root_reply
argument_list|)
expr_stmt|;
return|return
name|QPixmap
argument_list|()
return|;
block|}
name|x
operator|=
name|translate_reply
operator|->
name|dst_x
expr_stmt|;
name|y
operator|=
name|translate_reply
operator|->
name|dst_y
expr_stmt|;
name|window
operator|=
name|root
expr_stmt|;
name|free
argument_list|(
name|translate_reply
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|reply
operator|=
name|root_reply
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|root_reply
argument_list|)
expr_stmt|;
name|root_reply
operator|=
literal|0
expr_stmt|;
block|}
name|xcb_get_window_attributes_reply_t
modifier|*
name|attributes_reply
init|=
name|xcb_get_window_attributes_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|xcb_get_window_attributes_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|window
argument_list|)
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|attributes_reply
condition|)
block|{
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
name|QPixmap
argument_list|()
return|;
block|}
specifier|const
name|xcb_visualtype_t
modifier|*
name|visual
init|=
name|screen
operator|->
name|visualForId
argument_list|(
name|attributes_reply
operator|->
name|visual
argument_list|)
decl_stmt|;
name|free
argument_list|(
name|attributes_reply
argument_list|)
expr_stmt|;
name|xcb_pixmap_t
name|pixmap
init|=
name|xcb_generate_id
argument_list|(
name|xcb_connection
argument_list|()
argument_list|)
decl_stmt|;
name|xcb_create_pixmap
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|reply
operator|->
name|depth
argument_list|,
name|pixmap
argument_list|,
name|window
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|uint32_t
name|gc_value_mask
init|=
name|XCB_GC_SUBWINDOW_MODE
decl_stmt|;
name|uint32_t
name|gc_value_list
index|[]
init|=
block|{
name|XCB_SUBWINDOW_MODE_INCLUDE_INFERIORS
block|}
decl_stmt|;
name|xcb_gcontext_t
name|gc
init|=
name|xcb_generate_id
argument_list|(
name|xcb_connection
argument_list|()
argument_list|)
decl_stmt|;
name|xcb_create_gc
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|gc
argument_list|,
name|pixmap
argument_list|,
name|gc_value_mask
argument_list|,
name|gc_value_list
argument_list|)
expr_stmt|;
name|xcb_copy_area
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|window
argument_list|,
name|pixmap
argument_list|,
name|gc
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|QPixmap
name|result
init|=
name|qt_xcb_pixmapFromXPixmap
argument_list|(
name|connection
argument_list|()
argument_list|,
name|pixmap
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|reply
operator|->
name|depth
argument_list|,
name|visual
argument_list|)
decl_stmt|;
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|xcb_free_gc
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|gc
argument_list|)
expr_stmt|;
name|xcb_free_pixmap
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|pixmap
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function
begin_function
DECL|function|parseXftInt
specifier|static
name|bool
name|parseXftInt
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|stringValue
parameter_list|,
name|int
modifier|*
name|value
parameter_list|)
block|{
name|Q_ASSERT
argument_list|(
name|value
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|bool
name|ok
decl_stmt|;
operator|*
name|value
operator|=
name|stringValue
operator|.
name|toInt
argument_list|(
operator|&
name|ok
argument_list|)
expr_stmt|;
return|return
name|ok
return|;
block|}
end_function
begin_function
DECL|function|parseXftHintStyle
specifier|static
name|QFontEngine
operator|::
name|HintStyle
name|parseXftHintStyle
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|stringValue
parameter_list|)
block|{
if|if
condition|(
name|stringValue
operator|==
literal|"hintfull"
condition|)
return|return
name|QFontEngine
operator|::
name|HintFull
return|;
elseif|else
if|if
condition|(
name|stringValue
operator|==
literal|"hintnone"
condition|)
return|return
name|QFontEngine
operator|::
name|HintNone
return|;
elseif|else
if|if
condition|(
name|stringValue
operator|==
literal|"hintmedium"
condition|)
return|return
name|QFontEngine
operator|::
name|HintMedium
return|;
elseif|else
if|if
condition|(
name|stringValue
operator|==
literal|"hintslight"
condition|)
return|return
name|QFontEngine
operator|::
name|HintLight
return|;
return|return
name|QFontEngine
operator|::
name|HintStyle
argument_list|(
operator|-
literal|1
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|parseXftRgba
specifier|static
name|QFontEngine
operator|::
name|SubpixelAntialiasingType
name|parseXftRgba
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|stringValue
parameter_list|)
block|{
if|if
condition|(
name|stringValue
operator|==
literal|"none"
condition|)
return|return
name|QFontEngine
operator|::
name|Subpixel_None
return|;
elseif|else
if|if
condition|(
name|stringValue
operator|==
literal|"rgb"
condition|)
return|return
name|QFontEngine
operator|::
name|Subpixel_RGB
return|;
elseif|else
if|if
condition|(
name|stringValue
operator|==
literal|"bgr"
condition|)
return|return
name|QFontEngine
operator|::
name|Subpixel_BGR
return|;
elseif|else
if|if
condition|(
name|stringValue
operator|==
literal|"vrgb"
condition|)
return|return
name|QFontEngine
operator|::
name|Subpixel_VRGB
return|;
elseif|else
if|if
condition|(
name|stringValue
operator|==
literal|"vbgr"
condition|)
return|return
name|QFontEngine
operator|::
name|Subpixel_VBGR
return|;
return|return
name|QFontEngine
operator|::
name|SubpixelAntialiasingType
argument_list|(
operator|-
literal|1
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|xResource
name|bool
name|QXcbScreen
operator|::
name|xResource
parameter_list|(
specifier|const
name|QByteArray
modifier|&
name|identifier
parameter_list|,
specifier|const
name|QByteArray
modifier|&
name|expectedIdentifier
parameter_list|,
name|QByteArray
modifier|&
name|stringValue
parameter_list|)
block|{
if|if
condition|(
name|identifier
operator|.
name|startsWith
argument_list|(
name|expectedIdentifier
argument_list|)
condition|)
block|{
name|stringValue
operator|=
name|identifier
operator|.
name|mid
argument_list|(
name|expectedIdentifier
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
return|return
literal|false
return|;
block|}
end_function
begin_function
DECL|function|readXResources
name|void
name|QXcbScreen
operator|::
name|readXResources
parameter_list|()
block|{
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|QByteArray
name|resources
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|xcb_get_property_reply_t
modifier|*
name|reply
init|=
name|xcb_get_property_reply
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
name|xcb_get_property_unchecked
argument_list|(
name|xcb_connection
argument_list|()
argument_list|,
literal|false
argument_list|,
name|screen
argument_list|()
operator|->
name|root
argument_list|,
name|XCB_ATOM_RESOURCE_MANAGER
argument_list|,
name|XCB_ATOM_STRING
argument_list|,
name|offset
operator|/
literal|4
argument_list|,
literal|8192
argument_list|)
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|bool
name|more
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|reply
operator|&&
name|reply
operator|->
name|format
operator|==
literal|8
operator|&&
name|reply
operator|->
name|type
operator|==
name|XCB_ATOM_STRING
condition|)
block|{
name|resources
operator|+=
name|QByteArray
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|xcb_get_property_value
argument_list|(
name|reply
argument_list|)
argument_list|,
name|xcb_get_property_value_length
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|xcb_get_property_value_length
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|more
operator|=
name|reply
operator|->
name|bytes_after
operator|!=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|reply
condition|)
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|more
condition|)
break|break;
block|}
name|QList
argument_list|<
name|QByteArray
argument_list|>
name|split
init|=
name|resources
operator|.
name|split
argument_list|(
literal|'\n'
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|split
operator|.
name|size
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|QByteArray
modifier|&
name|r
init|=
name|split
operator|.
name|at
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|int
name|value
decl_stmt|;
name|QByteArray
name|stringValue
decl_stmt|;
if|if
condition|(
name|xResource
argument_list|(
name|r
argument_list|,
literal|"Xft.dpi:\t"
argument_list|,
name|stringValue
argument_list|)
condition|)
block|{
if|if
condition|(
name|parseXftInt
argument_list|(
name|stringValue
argument_list|,
operator|&
name|value
argument_list|)
condition|)
name|m_forcedDpi
operator|=
name|value
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xResource
argument_list|(
name|r
argument_list|,
literal|"Xft.hintstyle:\t"
argument_list|,
name|stringValue
argument_list|)
condition|)
block|{
name|m_hintStyle
operator|=
name|parseXftHintStyle
argument_list|(
name|stringValue
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xResource
argument_list|(
name|r
argument_list|,
literal|"Xft.antialias:\t"
argument_list|,
name|stringValue
argument_list|)
condition|)
block|{
if|if
condition|(
name|parseXftInt
argument_list|(
name|stringValue
argument_list|,
operator|&
name|value
argument_list|)
condition|)
name|m_antialiasingEnabled
operator|=
name|value
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xResource
argument_list|(
name|r
argument_list|,
literal|"Xft.rgba:\t"
argument_list|,
name|stringValue
argument_list|)
condition|)
block|{
name|m_subpixelType
operator|=
name|parseXftRgba
argument_list|(
name|stringValue
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function
begin_function
DECL|function|xSettings
name|QXcbXSettings
modifier|*
name|QXcbScreen
operator|::
name|xSettings
parameter_list|()
specifier|const
block|{
return|return
name|m_virtualDesktop
operator|->
name|xSettings
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|formatRect
specifier|static
specifier|inline
name|void
name|formatRect
parameter_list|(
name|QDebug
modifier|&
name|debug
parameter_list|,
specifier|const
name|QRect
name|r
parameter_list|)
block|{
name|debug
operator|<<
name|r
operator|.
name|width
argument_list|()
operator|<<
literal|'x'
operator|<<
name|r
operator|.
name|height
argument_list|()
operator|<<
name|forcesign
operator|<<
name|r
operator|.
name|x
argument_list|()
operator|<<
name|r
operator|.
name|y
argument_list|()
operator|<<
name|noforcesign
expr_stmt|;
block|}
end_function
begin_function
DECL|function|formatSizeF
specifier|static
specifier|inline
name|void
name|formatSizeF
parameter_list|(
name|QDebug
modifier|&
name|debug
parameter_list|,
specifier|const
name|QSizeF
name|s
parameter_list|)
block|{
name|debug
operator|<<
name|s
operator|.
name|width
argument_list|()
operator|<<
literal|'x'
operator|<<
name|s
operator|.
name|height
argument_list|()
operator|<<
literal|"mm"
expr_stmt|;
block|}
end_function
begin_function
DECL|function|operator <<
name|Q_XCB_EXPORT
name|QDebug
name|operator
name|<<
parameter_list|(
name|QDebug
name|debug
parameter_list|,
specifier|const
name|QXcbScreen
modifier|*
name|screen
parameter_list|)
block|{
specifier|const
name|QDebugStateSaver
name|saver
argument_list|(
name|debug
argument_list|)
decl_stmt|;
name|debug
operator|.
name|nospace
argument_list|()
expr_stmt|;
name|debug
operator|<<
literal|"QXcbScreen("
operator|<<
operator|(
specifier|const
name|void
operator|*
operator|)
name|screen
expr_stmt|;
if|if
condition|(
name|screen
condition|)
block|{
name|debug
operator|<<
name|fixed
operator|<<
name|qSetRealNumberPrecision
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|debug
operator|<<
literal|", name="
operator|<<
name|screen
operator|->
name|name
argument_list|()
expr_stmt|;
name|debug
operator|<<
literal|", geometry="
expr_stmt|;
name|formatRect
argument_list|(
name|debug
argument_list|,
name|screen
operator|->
name|geometry
argument_list|()
argument_list|)
expr_stmt|;
name|debug
operator|<<
literal|", availableGeometry="
expr_stmt|;
name|formatRect
argument_list|(
name|debug
argument_list|,
name|screen
operator|->
name|availableGeometry
argument_list|()
argument_list|)
expr_stmt|;
name|debug
operator|<<
literal|", devicePixelRatio="
operator|<<
name|screen
operator|->
name|devicePixelRatio
argument_list|()
expr_stmt|;
name|debug
operator|<<
literal|", logicalDpi="
operator|<<
name|screen
operator|->
name|logicalDpi
argument_list|()
expr_stmt|;
name|debug
operator|<<
literal|", physicalSize="
expr_stmt|;
name|formatSizeF
argument_list|(
name|debug
argument_list|,
name|screen
operator|->
name|physicalSize
argument_list|()
argument_list|)
expr_stmt|;
comment|// TODO 5.6 if (debug.verbosity()> 2) {
name|debug
operator|<<
literal|", screenNumber="
operator|<<
name|screen
operator|->
name|screenNumber
argument_list|()
expr_stmt|;
name|debug
operator|<<
literal|", virtualSize="
operator|<<
name|screen
operator|->
name|virtualSize
argument_list|()
operator|.
name|width
argument_list|()
operator|<<
literal|"x"
operator|<<
name|screen
operator|->
name|virtualSize
argument_list|()
operator|.
name|height
argument_list|()
operator|<<
literal|" ("
expr_stmt|;
name|formatSizeF
argument_list|(
name|debug
argument_list|,
name|screen
operator|->
name|virtualSize
argument_list|()
argument_list|)
expr_stmt|;
name|debug
operator|<<
literal|"), nativeGeometry="
expr_stmt|;
name|formatRect
argument_list|(
name|debug
argument_list|,
name|screen
operator|->
name|nativeGeometry
argument_list|()
argument_list|)
expr_stmt|;
name|debug
operator|<<
literal|", orientation="
operator|<<
name|screen
operator|->
name|orientation
argument_list|()
expr_stmt|;
name|debug
operator|<<
literal|", depth="
operator|<<
name|screen
operator|->
name|depth
argument_list|()
expr_stmt|;
name|debug
operator|<<
literal|", refreshRate="
operator|<<
name|screen
operator|->
name|refreshRate
argument_list|()
expr_stmt|;
name|debug
operator|<<
literal|", root="
operator|<<
name|hex
operator|<<
name|screen
operator|->
name|root
argument_list|()
expr_stmt|;
name|debug
operator|<<
literal|", windowManagerName="
operator|<<
name|screen
operator|->
name|windowManagerName
argument_list|()
expr_stmt|;
block|}
name|debug
operator|<<
literal|')'
expr_stmt|;
return|return
name|debug
return|;
block|}
end_function
begin_macro
name|QT_END_NAMESPACE
end_macro
end_unit
