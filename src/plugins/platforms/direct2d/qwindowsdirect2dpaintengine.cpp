begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2013 Digia Plc and/or its subsidiary(-ies). ** Contact: http://www.qt-project.org/legal ** ** This file is part of the plugins of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** Commercial License Usage ** Licensees holding valid commercial Qt licenses may use this file in ** accordance with the commercial license agreement provided with the ** Software or, alternatively, in accordance with the terms contained in ** a written agreement between you and Digia.  For licensing terms and ** conditions see http://qt.digia.com/licensing.  For further information ** use the contact form at http://qt.digia.com/contact-us. ** ** GNU Lesser General Public License Usage ** Alternatively, this file may be used under the terms of the GNU Lesser ** General Public License version 2.1 as published by the Free Software ** Foundation and appearing in the file LICENSE.LGPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU Lesser General Public License version 2.1 requirements ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Digia gives you certain additional ** rights.  These rights are described in the Digia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU ** General Public License version 3.0 as published by the Free Software ** Foundation and appearing in the file LICENSE.GPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU General Public License version 3.0 requirements will be ** met: http://www.gnu.org/copyleft/gpl.html. ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"qwindowsdirect2dpaintengine.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsdirect2dplatformpixmap.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsdirect2dpaintdevice.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsdirect2dcontext.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsdirect2dhelpers.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsdirect2dbitmap.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsdirect2ddevicecontext.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsfontengine.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsfontenginedirectwrite.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsfontdatabase.h"
end_include
begin_include
include|#
directive|include
file|"qwindowsintegration.h"
end_include
begin_include
include|#
directive|include
file|<QtCore/QStack>
end_include
begin_include
include|#
directive|include
file|<QtGui/private/qpaintengine_p.h>
end_include
begin_include
include|#
directive|include
file|<QtGui/private/qtextengine_p.h>
end_include
begin_include
include|#
directive|include
file|<QtGui/private/qfontengine_p.h>
end_include
begin_include
include|#
directive|include
file|<dwrite_1.h>
end_include
begin_include
include|#
directive|include
file|<wrl.h>
end_include
begin_using
using|using
name|Microsoft
operator|::
name|WRL
operator|::
name|ComPtr
using|;
end_using
begin_decl_stmt
name|QT_BEGIN_NAMESPACE
name|enum
type|{
DECL|enumerator|D2DDebugDrawInitialStateTag
name|D2DDebugDrawInitialStateTag
init|=
operator|-
literal|1
decl_stmt|,
DECL|enumerator|D2DDebugDrawEllipseTag
name|D2DDebugDrawEllipseTag
init|=
literal|1
decl_stmt|,
DECL|enumerator|D2DDebugDrawImageTag
name|D2DDebugDrawImageTag
decl_stmt|,
DECL|enumerator|D2DDebugDrawLinesTag
name|D2DDebugDrawLinesTag
decl_stmt|,
DECL|enumerator|D2DDebugDrawPathTag
name|D2DDebugDrawPathTag
decl_stmt|,
DECL|enumerator|D2DDebugDrawPixmapTag
name|D2DDebugDrawPixmapTag
decl_stmt|,
DECL|enumerator|D2DDebugDrawPointsTag
name|D2DDebugDrawPointsTag
decl_stmt|,
DECL|enumerator|D2DDebugDrawPolygonTag
name|D2DDebugDrawPolygonTag
decl_stmt|,
DECL|enumerator|D2DDebugDrawRectsTag
name|D2DDebugDrawRectsTag
decl_stmt|,
DECL|enumerator|D2DDebugDrawTextItemTag
name|D2DDebugDrawTextItemTag
decl_stmt|,
DECL|enumerator|D2DDebugDrawTiledPixmap
name|D2DDebugDrawTiledPixmap
end_decl_stmt
begin_define
DECL|macro|D2D_TAG
unit|};
define|#
directive|define
name|D2D_TAG
parameter_list|(
name|tag
parameter_list|)
value|d->dc()->SetTags(tag, tag)
end_define
begin_function_decl
name|Q_GUI_EXPORT
name|QImage
name|qt_imageForBrush
parameter_list|(
name|int
name|brushStyle
parameter_list|,
name|bool
name|invert
parameter_list|)
function_decl|;
end_function_decl
begin_function
DECL|function|factory
specifier|static
specifier|inline
name|ID2D1Factory1
modifier|*
name|factory
parameter_list|()
block|{
return|return
name|QWindowsDirect2DContext
operator|::
name|instance
argument_list|()
operator|->
name|d2dFactory
argument_list|()
return|;
block|}
end_function
begin_decl_stmt
DECL|variable|defaultOpacity
specifier|static
specifier|const
name|qreal
name|defaultOpacity
init|=
literal|1.0
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|defaultPenWidth
specifier|static
specifier|const
name|qreal
name|defaultPenWidth
init|=
literal|1.0
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|painterPathToPathGeometry
specifier|static
name|ComPtr
argument_list|<
name|ID2D1PathGeometry
argument_list|>
name|painterPathToPathGeometry
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|path
parameter_list|)
block|{
name|ComPtr
argument_list|<
name|ID2D1PathGeometry
argument_list|>
name|geometry
decl_stmt|;
name|ComPtr
argument_list|<
name|ID2D1GeometrySink
argument_list|>
name|sink
decl_stmt|;
name|HRESULT
name|hr
init|=
name|factory
argument_list|()
operator|->
name|CreatePathGeometry
argument_list|(
operator|&
name|geometry
argument_list|)
decl_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Could not create path geometry: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|hr
operator|=
name|geometry
operator|->
name|Open
argument_list|(
operator|&
name|sink
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Could not create geometry sink: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
switch|switch
condition|(
name|path
operator|.
name|fillRule
argument_list|()
condition|)
block|{
case|case
name|Qt
operator|::
name|WindingFill
case|:
name|sink
operator|->
name|SetFillMode
argument_list|(
name|D2D1_FILL_MODE_WINDING
argument_list|)
expr_stmt|;
break|break;
case|case
name|Qt
operator|::
name|OddEvenFill
case|:
name|sink
operator|->
name|SetFillMode
argument_list|(
name|D2D1_FILL_MODE_ALTERNATE
argument_list|)
expr_stmt|;
break|break;
block|}
name|bool
name|inFigure
init|=
literal|false
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|path
operator|.
name|elementCount
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|QPainterPath
operator|::
name|Element
name|element
init|=
name|path
operator|.
name|elementAt
argument_list|(
name|i
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|element
operator|.
name|type
condition|)
block|{
case|case
name|QPainterPath
operator|::
name|MoveToElement
case|:
if|if
condition|(
name|inFigure
condition|)
name|sink
operator|->
name|EndFigure
argument_list|(
name|D2D1_FIGURE_END_OPEN
argument_list|)
expr_stmt|;
name|sink
operator|->
name|BeginFigure
argument_list|(
name|to_d2d_point_2f
argument_list|(
name|element
argument_list|)
argument_list|,
name|D2D1_FIGURE_BEGIN_FILLED
argument_list|)
expr_stmt|;
name|inFigure
operator|=
literal|true
expr_stmt|;
break|break;
case|case
name|QPainterPath
operator|::
name|LineToElement
case|:
name|sink
operator|->
name|AddLine
argument_list|(
name|to_d2d_point_2f
argument_list|(
name|element
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|QPainterPath
operator|::
name|CurveToElement
case|:
block|{
specifier|const
name|QPainterPath
operator|::
name|Element
name|data1
init|=
name|path
operator|.
name|elementAt
argument_list|(
operator|++
name|i
argument_list|)
decl_stmt|;
specifier|const
name|QPainterPath
operator|::
name|Element
name|data2
init|=
name|path
operator|.
name|elementAt
argument_list|(
operator|++
name|i
argument_list|)
decl_stmt|;
name|Q_ASSERT
argument_list|(
name|i
operator|<
name|path
operator|.
name|elementCount
argument_list|()
argument_list|)
expr_stmt|;
name|Q_ASSERT
argument_list|(
name|data1
operator|.
name|type
operator|==
name|QPainterPath
operator|::
name|CurveToDataElement
argument_list|)
expr_stmt|;
name|Q_ASSERT
argument_list|(
name|data2
operator|.
name|type
operator|==
name|QPainterPath
operator|::
name|CurveToDataElement
argument_list|)
expr_stmt|;
name|D2D1_BEZIER_SEGMENT
name|segment
decl_stmt|;
name|segment
operator|.
name|point1
operator|=
name|to_d2d_point_2f
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|segment
operator|.
name|point2
operator|=
name|to_d2d_point_2f
argument_list|(
name|data1
argument_list|)
expr_stmt|;
name|segment
operator|.
name|point3
operator|=
name|to_d2d_point_2f
argument_list|(
name|data2
argument_list|)
expr_stmt|;
name|sink
operator|->
name|AddBezier
argument_list|(
name|segment
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|QPainterPath
operator|::
name|CurveToDataElement
case|:
name|qWarning
argument_list|(
literal|"%s: Unhandled Curve Data Element"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|inFigure
condition|)
name|sink
operator|->
name|EndFigure
argument_list|(
name|D2D1_FIGURE_END_OPEN
argument_list|)
expr_stmt|;
name|sink
operator|->
name|Close
argument_list|()
expr_stmt|;
return|return
name|geometry
return|;
block|}
end_function
begin_function
DECL|function|regionToPathGeometry
specifier|static
name|ComPtr
argument_list|<
name|ID2D1PathGeometry
argument_list|>
name|regionToPathGeometry
parameter_list|(
specifier|const
name|QRegion
modifier|&
name|region
parameter_list|)
block|{
name|QPainterPath
name|ppath
decl_stmt|;
name|ppath
operator|.
name|addRegion
argument_list|(
name|region
argument_list|)
expr_stmt|;
return|return
name|painterPathToPathGeometry
argument_list|(
name|ppath
argument_list|)
return|;
block|}
end_function
begin_class
DECL|class|QWindowsDirect2DPaintEnginePrivate
class|class
name|QWindowsDirect2DPaintEnginePrivate
super|:
specifier|public
name|QPaintEnginePrivate
block|{
name|Q_DECLARE_PUBLIC
parameter_list|(
name|QWindowsDirect2DPaintEngine
parameter_list|)
specifier|public
private|:
DECL|function|QWindowsDirect2DPaintEnginePrivate
name|QWindowsDirect2DPaintEnginePrivate
parameter_list|(
name|QWindowsDirect2DBitmap
modifier|*
name|bm
parameter_list|)
member_init_list|:
name|bitmap
argument_list|(
name|bm
argument_list|)
member_init_list|,
name|clipPushed
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|hasPerspectiveTransform
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|opacity
argument_list|(
literal|1.0
argument_list|)
member_init_list|,
name|renderHints
argument_list|(
name|QPainter
operator|::
name|TextAntialiasing
argument_list|)
block|{
name|pen
operator|.
name|reset
argument_list|()
expr_stmt|;
name|HRESULT
name|hr
init|=
name|factory
argument_list|()
operator|->
name|CreateStrokeStyle
argument_list|(
name|D2D1
operator|::
name|StrokeStyleProperties
argument_list|(
name|D2D1_CAP_STYLE_ROUND
argument_list|,
name|D2D1_CAP_STYLE_ROUND
argument_list|,
name|D2D1_CAP_STYLE_ROUND
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|pointStrokeStyle
operator|.
name|ReleaseAndGetAddressOf
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
name|qWarning
argument_list|(
literal|"%s: Could not create stroke style for points and zero length lines: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
name|dc
argument_list|()
operator|->
name|SetAntialiasMode
argument_list|(
name|D2D1_ANTIALIAS_MODE_ALIASED
argument_list|)
expr_stmt|;
block|}
DECL|member|bitmap
name|QWindowsDirect2DBitmap
modifier|*
name|bitmap
decl_stmt|;
DECL|member|clipPath
name|QPainterPath
name|clipPath
decl_stmt|;
DECL|member|clipPushed
name|bool
name|clipPushed
decl_stmt|;
DECL|member|pointStrokeStyle
name|ComPtr
argument_list|<
name|ID2D1StrokeStyle
argument_list|>
name|pointStrokeStyle
decl_stmt|;
DECL|member|currentBrushOrigin
name|QPointF
name|currentBrushOrigin
decl_stmt|;
DECL|member|hasPerspectiveTransform
name|bool
name|hasPerspectiveTransform
decl_stmt|;
DECL|member|opacity
name|qreal
name|opacity
decl_stmt|;
struct|struct
block|{
DECL|member|width
name|qreal
name|width
decl_stmt|;
DECL|member|color
name|QColor
name|color
decl_stmt|;
DECL|member|isNull
name|bool
name|isNull
decl_stmt|;
DECL|member|brush
name|ComPtr
argument_list|<
name|ID2D1Brush
argument_list|>
name|brush
decl_stmt|;
DECL|member|strokeStyle
name|ComPtr
argument_list|<
name|ID2D1StrokeStyle1
argument_list|>
name|strokeStyle
decl_stmt|;
DECL|function|reset
specifier|inline
name|void
name|reset
parameter_list|()
block|{
name|width
operator|=
name|defaultPenWidth
expr_stmt|;
name|color
operator|=
name|QColor
argument_list|(
name|Qt
operator|::
name|black
argument_list|)
expr_stmt|;
name|isNull
operator|=
literal|true
expr_stmt|;
name|brush
operator|.
name|Reset
argument_list|()
expr_stmt|;
name|strokeStyle
operator|.
name|Reset
argument_list|()
expr_stmt|;
block|}
DECL|member|pen
block|}
name|pen
struct|;
struct|struct
block|{
DECL|member|brush
name|ComPtr
argument_list|<
name|ID2D1Brush
argument_list|>
name|brush
decl_stmt|;
DECL|member|brush
block|}
name|brush
struct|;
DECL|member|renderHints
name|QPainter
operator|::
name|RenderHints
name|renderHints
decl_stmt|;
DECL|function|dc
specifier|inline
name|ID2D1DeviceContext
modifier|*
name|dc
parameter_list|()
specifier|const
block|{
name|Q_ASSERT
argument_list|(
name|bitmap
argument_list|)
expr_stmt|;
return|return
name|bitmap
operator|->
name|deviceContext
argument_list|()
operator|->
name|get
argument_list|()
return|;
block|}
DECL|function|interpolationMode
specifier|inline
name|D2D1_INTERPOLATION_MODE
name|interpolationMode
parameter_list|()
specifier|const
block|{
return|return
operator|(
name|renderHints
operator|&
name|QPainter
operator|::
name|SmoothPixmapTransform
operator|)
condition|?
name|D2D1_INTERPOLATION_MODE_HIGH_QUALITY_CUBIC
else|:
name|D2D1_INTERPOLATION_MODE_NEAREST_NEIGHBOR
return|;
block|}
DECL|function|antialiasMode
specifier|inline
name|D2D1_ANTIALIAS_MODE
name|antialiasMode
parameter_list|()
specifier|const
block|{
return|return
operator|(
name|renderHints
operator|&
name|QPainter
operator|::
name|Antialiasing
operator|)
condition|?
name|D2D1_ANTIALIAS_MODE_PER_PRIMITIVE
else|:
name|D2D1_ANTIALIAS_MODE_ALIASED
return|;
block|}
DECL|function|updateState
name|void
name|updateState
parameter_list|(
specifier|const
name|QPaintEngineState
modifier|&
name|state
parameter_list|,
name|QPaintEngine
operator|::
name|DirtyFlags
name|dirty
parameter_list|)
block|{
if|if
condition|(
name|dirty
operator|&
name|QPaintEngine
operator|::
name|DirtyPen
condition|)
name|updatePen
argument_list|(
name|state
operator|.
name|pen
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|QPaintEngine
operator|::
name|DirtyBrush
condition|)
name|updateBrush
argument_list|(
name|state
operator|.
name|brush
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|QPaintEngine
operator|::
name|DirtyBrushOrigin
condition|)
name|updateBrushOrigin
argument_list|(
name|state
operator|.
name|brushOrigin
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|QPaintEngine
operator|::
name|DirtyHints
condition|)
name|updateHints
argument_list|(
name|state
operator|.
name|renderHints
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|QPaintEngine
operator|::
name|DirtyTransform
condition|)
name|updateTransform
argument_list|(
name|state
operator|.
name|transform
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|QPaintEngine
operator|::
name|DirtyClipEnabled
condition|)
name|updateClipEnabled
argument_list|(
name|state
operator|.
name|isClipEnabled
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|QPaintEngine
operator|::
name|DirtyClipPath
condition|)
name|updateClipPath
argument_list|(
name|state
operator|.
name|clipPath
argument_list|()
argument_list|,
name|state
operator|.
name|clipOperation
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|QPaintEngine
operator|::
name|DirtyClipRegion
condition|)
name|updateClipRegion
argument_list|(
name|state
operator|.
name|clipRegion
argument_list|()
argument_list|,
name|state
operator|.
name|clipOperation
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|QPaintEngine
operator|::
name|DirtyOpacity
condition|)
name|updateOpacity
argument_list|(
name|state
operator|.
name|opacity
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|function|updateTransform
name|void
name|updateTransform
parameter_list|(
specifier|const
name|QTransform
modifier|&
name|t
parameter_list|)
block|{
name|dc
argument_list|()
operator|->
name|SetTransform
argument_list|(
name|to_d2d_matrix_3x2_f
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|hasPerspectiveTransform
operator|=
operator|!
name|t
operator|.
name|isAffine
argument_list|()
expr_stmt|;
block|}
DECL|function|updateOpacity
name|void
name|updateOpacity
parameter_list|(
name|qreal
name|o
parameter_list|)
block|{
name|opacity
operator|=
name|o
expr_stmt|;
if|if
condition|(
name|brush
operator|.
name|brush
condition|)
name|brush
operator|.
name|brush
operator|.
name|Get
argument_list|()
operator|->
name|SetOpacity
argument_list|(
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
name|pen
operator|.
name|brush
condition|)
name|pen
operator|.
name|brush
operator|.
name|Get
argument_list|()
operator|->
name|SetOpacity
argument_list|(
name|o
argument_list|)
expr_stmt|;
block|}
DECL|function|pushClip
name|void
name|pushClip
parameter_list|()
block|{
name|ComPtr
argument_list|<
name|ID2D1Geometry
argument_list|>
name|geometricMask
init|=
name|painterPathToPathGeometry
argument_list|(
name|clipPath
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|geometricMask
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Could not convert painter path, not pushing clip path!"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return;
block|}
name|popClip
argument_list|()
expr_stmt|;
name|dc
argument_list|()
operator|->
name|PushLayer
argument_list|(
name|D2D1
operator|::
name|LayerParameters1
argument_list|(
name|D2D1
operator|::
name|InfiniteRect
argument_list|()
argument_list|,
name|geometricMask
operator|.
name|Get
argument_list|()
argument_list|,
name|antialiasMode
argument_list|()
argument_list|,
name|D2D1
operator|::
name|IdentityMatrix
argument_list|()
argument_list|,
literal|1.0
argument_list|,
name|NULL
argument_list|,
name|D2D1_LAYER_OPTIONS1_INITIALIZE_FROM_BACKGROUND
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|clipPushed
operator|=
literal|true
expr_stmt|;
block|}
DECL|function|popClip
name|void
name|popClip
parameter_list|()
block|{
if|if
condition|(
name|clipPushed
condition|)
block|{
name|dc
argument_list|()
operator|->
name|PopLayer
argument_list|()
expr_stmt|;
name|clipPushed
operator|=
literal|false
expr_stmt|;
block|}
block|}
DECL|function|updateClipEnabled
name|void
name|updateClipEnabled
parameter_list|(
name|bool
name|enabled
parameter_list|)
block|{
if|if
condition|(
operator|!
name|enabled
condition|)
name|popClip
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|clipPushed
condition|)
name|pushClip
argument_list|()
expr_stmt|;
block|}
DECL|function|updateClipPath
name|void
name|updateClipPath
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|path
parameter_list|,
name|Qt
operator|::
name|ClipOperation
name|operation
parameter_list|)
block|{
switch|switch
condition|(
name|operation
condition|)
block|{
case|case
name|Qt
operator|::
name|NoClip
case|:
name|popClip
argument_list|()
expr_stmt|;
break|break;
case|case
name|Qt
operator|::
name|ReplaceClip
case|:
name|clipPath
operator|=
name|path
expr_stmt|;
name|pushClip
argument_list|()
expr_stmt|;
break|break;
case|case
name|Qt
operator|::
name|IntersectClip
case|:
name|clipPath
operator|&=
name|path
expr_stmt|;
name|pushClip
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
DECL|function|updateClipRegion
name|void
name|updateClipRegion
parameter_list|(
specifier|const
name|QRegion
modifier|&
name|region
parameter_list|,
name|Qt
operator|::
name|ClipOperation
name|operation
parameter_list|)
block|{
name|QPainterPath
name|p
decl_stmt|;
name|p
operator|.
name|addRegion
argument_list|(
name|region
argument_list|)
expr_stmt|;
name|updateClipPath
argument_list|(
name|p
argument_list|,
name|operation
argument_list|)
expr_stmt|;
block|}
DECL|function|updateBrush
name|void
name|updateBrush
parameter_list|(
specifier|const
name|QBrush
modifier|&
name|newBrush
parameter_list|)
block|{
name|brush
operator|.
name|brush
operator|=
name|to_d2d_brush
argument_list|(
name|newBrush
argument_list|)
expr_stmt|;
if|if
condition|(
name|brush
operator|.
name|brush
condition|)
block|{
name|brush
operator|.
name|brush
operator|->
name|SetOpacity
argument_list|(
name|opacity
argument_list|)
expr_stmt|;
name|applyBrushOrigin
argument_list|(
name|currentBrushOrigin
argument_list|)
expr_stmt|;
block|}
block|}
DECL|function|updateBrushOrigin
name|void
name|updateBrushOrigin
parameter_list|(
specifier|const
name|QPointF
modifier|&
name|origin
parameter_list|)
block|{
name|negateCurrentBrushOrigin
argument_list|()
expr_stmt|;
name|applyBrushOrigin
argument_list|(
name|origin
argument_list|)
expr_stmt|;
block|}
DECL|function|negateCurrentBrushOrigin
name|void
name|negateCurrentBrushOrigin
parameter_list|()
block|{
if|if
condition|(
name|brush
operator|.
name|brush
operator|&&
operator|!
name|currentBrushOrigin
operator|.
name|isNull
argument_list|()
condition|)
block|{
name|D2D1_MATRIX_3X2_F
name|transform
decl_stmt|;
name|brush
operator|.
name|brush
operator|->
name|GetTransform
argument_list|(
operator|&
name|transform
argument_list|)
expr_stmt|;
name|brush
operator|.
name|brush
operator|->
name|SetTransform
argument_list|(
operator|*
operator|(
name|D2D1
operator|::
name|Matrix3x2F
operator|::
name|ReinterpretBaseType
argument_list|(
operator|&
name|transform
argument_list|)
operator|)
operator|*
name|D2D1
operator|::
name|Matrix3x2F
operator|::
name|Translation
argument_list|(
operator|-
name|currentBrushOrigin
operator|.
name|x
argument_list|()
argument_list|,
operator|-
name|currentBrushOrigin
operator|.
name|y
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|function|applyBrushOrigin
name|void
name|applyBrushOrigin
parameter_list|(
specifier|const
name|QPointF
modifier|&
name|origin
parameter_list|)
block|{
if|if
condition|(
name|brush
operator|.
name|brush
operator|&&
operator|!
name|origin
operator|.
name|isNull
argument_list|()
condition|)
block|{
name|D2D1_MATRIX_3X2_F
name|transform
decl_stmt|;
name|brush
operator|.
name|brush
operator|->
name|GetTransform
argument_list|(
operator|&
name|transform
argument_list|)
expr_stmt|;
name|brush
operator|.
name|brush
operator|->
name|SetTransform
argument_list|(
operator|*
operator|(
name|D2D1
operator|::
name|Matrix3x2F
operator|::
name|ReinterpretBaseType
argument_list|(
operator|&
name|transform
argument_list|)
operator|)
operator|*
name|D2D1
operator|::
name|Matrix3x2F
operator|::
name|Translation
argument_list|(
name|origin
operator|.
name|x
argument_list|()
argument_list|,
name|origin
operator|.
name|y
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|currentBrushOrigin
operator|=
name|origin
expr_stmt|;
block|}
DECL|function|updatePen
name|void
name|updatePen
parameter_list|(
specifier|const
name|QPen
modifier|&
name|newPen
parameter_list|)
block|{
name|pen
operator|.
name|reset
argument_list|()
expr_stmt|;
if|if
condition|(
name|newPen
operator|.
name|style
argument_list|()
operator|==
name|Qt
operator|::
name|NoPen
condition|)
return|return;
name|pen
operator|.
name|isNull
operator|=
literal|false
expr_stmt|;
name|pen
operator|.
name|brush
operator|=
name|to_d2d_brush
argument_list|(
name|newPen
operator|.
name|brush
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pen
operator|.
name|brush
condition|)
return|return;
name|pen
operator|.
name|width
operator|=
name|newPen
operator|.
name|widthF
argument_list|()
expr_stmt|;
name|pen
operator|.
name|color
operator|=
name|newPen
operator|.
name|color
argument_list|()
expr_stmt|;
name|pen
operator|.
name|brush
operator|->
name|SetOpacity
argument_list|(
name|opacity
argument_list|)
expr_stmt|;
name|D2D1_STROKE_STYLE_PROPERTIES1
name|props
init|=
block|{}
decl_stmt|;
comment|// Try and match Qt's raster engine in output as closely as possible
switch|switch
condition|(
name|newPen
operator|.
name|style
argument_list|()
condition|)
block|{
case|case
name|Qt
operator|::
name|DotLine
case|:
case|case
name|Qt
operator|::
name|DashDotLine
case|:
case|case
name|Qt
operator|::
name|DashDotDotLine
case|:
if|if
condition|(
name|pen
operator|.
name|width
operator|<=
literal|1.0
condition|)
block|{
name|props
operator|.
name|startCap
operator|=
name|props
operator|.
name|endCap
operator|=
name|props
operator|.
name|dashCap
operator|=
name|D2D1_CAP_STYLE_FLAT
expr_stmt|;
break|break;
block|}
comment|// fall through
default|default:
switch|switch
condition|(
name|newPen
operator|.
name|capStyle
argument_list|()
condition|)
block|{
case|case
name|Qt
operator|::
name|SquareCap
case|:
name|props
operator|.
name|startCap
operator|=
name|props
operator|.
name|endCap
operator|=
name|props
operator|.
name|dashCap
operator|=
name|D2D1_CAP_STYLE_SQUARE
expr_stmt|;
break|break;
case|case
name|Qt
operator|::
name|RoundCap
case|:
name|props
operator|.
name|startCap
operator|=
name|props
operator|.
name|endCap
operator|=
name|props
operator|.
name|dashCap
operator|=
name|D2D1_CAP_STYLE_ROUND
expr_stmt|;
case|case
name|Qt
operator|::
name|FlatCap
case|:
default|default:
name|props
operator|.
name|startCap
operator|=
name|props
operator|.
name|endCap
operator|=
name|props
operator|.
name|dashCap
operator|=
name|D2D1_CAP_STYLE_FLAT
expr_stmt|;
break|break;
block|}
break|break;
block|}
switch|switch
condition|(
name|newPen
operator|.
name|joinStyle
argument_list|()
condition|)
block|{
case|case
name|Qt
operator|::
name|BevelJoin
case|:
name|props
operator|.
name|lineJoin
operator|=
name|D2D1_LINE_JOIN_BEVEL
expr_stmt|;
break|break;
case|case
name|Qt
operator|::
name|RoundJoin
case|:
name|props
operator|.
name|lineJoin
operator|=
name|D2D1_LINE_JOIN_ROUND
expr_stmt|;
break|break;
case|case
name|Qt
operator|::
name|MiterJoin
case|:
default|default:
name|props
operator|.
name|lineJoin
operator|=
name|D2D1_LINE_JOIN_MITER
expr_stmt|;
break|break;
block|}
name|props
operator|.
name|miterLimit
operator|=
name|newPen
operator|.
name|miterLimit
argument_list|()
operator|*
name|qreal
argument_list|(
literal|2.0
argument_list|)
expr_stmt|;
comment|// D2D and Qt miter specs differ
name|props
operator|.
name|dashOffset
operator|=
name|newPen
operator|.
name|dashOffset
argument_list|()
expr_stmt|;
name|props
operator|.
name|transformType
operator|=
name|qIsNull
argument_list|(
name|newPen
operator|.
name|widthF
argument_list|()
argument_list|)
condition|?
name|D2D1_STROKE_TRANSFORM_TYPE_HAIRLINE
else|:
name|newPen
operator|.
name|isCosmetic
argument_list|()
condition|?
name|D2D1_STROKE_TRANSFORM_TYPE_FIXED
else|:
name|D2D1_STROKE_TRANSFORM_TYPE_NORMAL
expr_stmt|;
switch|switch
condition|(
name|newPen
operator|.
name|style
argument_list|()
condition|)
block|{
case|case
name|Qt
operator|::
name|SolidLine
case|:
name|props
operator|.
name|dashStyle
operator|=
name|D2D1_DASH_STYLE_SOLID
expr_stmt|;
break|break;
default|default:
name|props
operator|.
name|dashStyle
operator|=
name|D2D1_DASH_STYLE_CUSTOM
expr_stmt|;
break|break;
block|}
name|HRESULT
name|hr
decl_stmt|;
if|if
condition|(
name|props
operator|.
name|dashStyle
operator|==
name|D2D1_DASH_STYLE_CUSTOM
condition|)
block|{
name|QVector
argument_list|<
name|qreal
argument_list|>
name|dashes
init|=
name|newPen
operator|.
name|dashPattern
argument_list|()
decl_stmt|;
name|QVector
argument_list|<
name|FLOAT
argument_list|>
name|converted
argument_list|(
name|dashes
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|dashes
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|converted
index|[
name|i
index|]
operator|=
name|dashes
index|[
name|i
index|]
expr_stmt|;
block|}
name|hr
operator|=
name|factory
argument_list|()
operator|->
name|CreateStrokeStyle
argument_list|(
name|props
argument_list|,
name|converted
operator|.
name|constData
argument_list|()
argument_list|,
name|converted
operator|.
name|size
argument_list|()
argument_list|,
operator|&
operator|(
name|pen
operator|.
name|strokeStyle
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hr
operator|=
name|factory
argument_list|()
operator|->
name|CreateStrokeStyle
argument_list|(
name|props
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
operator|(
name|pen
operator|.
name|strokeStyle
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
name|qWarning
argument_list|(
literal|"%s: Could not create stroke style: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
block|}
DECL|function|to_d2d_brush
name|ComPtr
argument_list|<
name|ID2D1Brush
argument_list|>
name|to_d2d_brush
parameter_list|(
specifier|const
name|QBrush
modifier|&
name|newBrush
parameter_list|)
block|{
name|HRESULT
name|hr
decl_stmt|;
name|ComPtr
argument_list|<
name|ID2D1Brush
argument_list|>
name|result
decl_stmt|;
switch|switch
condition|(
name|newBrush
operator|.
name|style
argument_list|()
condition|)
block|{
case|case
name|Qt
operator|::
name|NoBrush
case|:
break|break;
case|case
name|Qt
operator|::
name|SolidPattern
case|:
block|{
name|ComPtr
argument_list|<
name|ID2D1SolidColorBrush
argument_list|>
name|solid
decl_stmt|;
name|hr
operator|=
name|dc
argument_list|()
operator|->
name|CreateSolidColorBrush
argument_list|(
name|to_d2d_color_f
argument_list|(
name|newBrush
operator|.
name|color
argument_list|()
argument_list|)
argument_list|,
operator|&
name|solid
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Could not create solid color brush: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
break|break;
block|}
name|hr
operator|=
name|solid
operator|.
name|As
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
name|qWarning
argument_list|(
literal|"%s: Could not convert solid color brush: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|Qt
operator|::
name|Dense1Pattern
case|:
case|case
name|Qt
operator|::
name|Dense2Pattern
case|:
case|case
name|Qt
operator|::
name|Dense3Pattern
case|:
case|case
name|Qt
operator|::
name|Dense4Pattern
case|:
case|case
name|Qt
operator|::
name|Dense5Pattern
case|:
case|case
name|Qt
operator|::
name|Dense6Pattern
case|:
case|case
name|Qt
operator|::
name|Dense7Pattern
case|:
case|case
name|Qt
operator|::
name|HorPattern
case|:
case|case
name|Qt
operator|::
name|VerPattern
case|:
case|case
name|Qt
operator|::
name|CrossPattern
case|:
case|case
name|Qt
operator|::
name|BDiagPattern
case|:
case|case
name|Qt
operator|::
name|FDiagPattern
case|:
case|case
name|Qt
operator|::
name|DiagCrossPattern
case|:
block|{
name|ComPtr
argument_list|<
name|ID2D1BitmapBrush1
argument_list|>
name|bitmapBrush
decl_stmt|;
name|D2D1_BITMAP_BRUSH_PROPERTIES1
name|bitmapBrushProperties
init|=
block|{
name|D2D1_EXTEND_MODE_WRAP
block|,
name|D2D1_EXTEND_MODE_WRAP
block|,
name|interpolationMode
argument_list|()
block|}
decl_stmt|;
name|QImage
name|brushImg
init|=
name|qt_imageForBrush
argument_list|(
name|newBrush
operator|.
name|style
argument_list|()
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|brushImg
operator|.
name|setColor
argument_list|(
literal|0
argument_list|,
name|newBrush
operator|.
name|color
argument_list|()
operator|.
name|rgba
argument_list|()
argument_list|)
expr_stmt|;
name|brushImg
operator|.
name|setColor
argument_list|(
literal|1
argument_list|,
name|qRgba
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|QWindowsDirect2DBitmap
name|bitmap
decl_stmt|;
name|bool
name|success
init|=
name|bitmap
operator|.
name|fromImage
argument_list|(
name|brushImg
argument_list|,
name|Qt
operator|::
name|AutoColor
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|success
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Could not create Direct2D bitmap from Qt pattern brush image"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
break|break;
block|}
name|hr
operator|=
name|dc
argument_list|()
operator|->
name|CreateBitmapBrush
argument_list|(
name|bitmap
operator|.
name|bitmap
argument_list|()
argument_list|,
name|bitmapBrushProperties
argument_list|,
operator|&
name|bitmapBrush
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Could not create Direct2D bitmap brush for Qt pattern brush: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
break|break;
block|}
name|hr
operator|=
name|bitmapBrush
operator|.
name|As
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
name|qWarning
argument_list|(
literal|"%s: Could not convert Direct2D bitmap brush for Qt pattern brush: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|Qt
operator|::
name|LinearGradientPattern
case|:
case|case
name|Qt
operator|::
name|RadialGradientPattern
case|:
case|case
name|Qt
operator|::
name|ConicalGradientPattern
case|:
break|break;
case|case
name|Qt
operator|::
name|TexturePattern
case|:
block|{
name|ComPtr
argument_list|<
name|ID2D1BitmapBrush1
argument_list|>
name|bitmapBrush
decl_stmt|;
name|D2D1_BITMAP_BRUSH_PROPERTIES1
name|bitmapBrushProperties
init|=
block|{
name|D2D1_EXTEND_MODE_WRAP
block|,
name|D2D1_EXTEND_MODE_WRAP
block|,
name|interpolationMode
argument_list|()
block|}
decl_stmt|;
name|QWindowsDirect2DPlatformPixmap
modifier|*
name|pp
init|=
cast|static_cast
argument_list|<
name|QWindowsDirect2DPlatformPixmap
operator|*
argument_list|>
argument_list|(
name|newBrush
operator|.
name|texture
argument_list|()
operator|.
name|handle
argument_list|()
argument_list|)
decl_stmt|;
name|QWindowsDirect2DBitmap
modifier|*
name|bitmap
init|=
name|pp
operator|->
name|bitmap
argument_list|()
decl_stmt|;
name|hr
operator|=
name|dc
argument_list|()
operator|->
name|CreateBitmapBrush
argument_list|(
name|bitmap
operator|->
name|bitmap
argument_list|()
argument_list|,
name|bitmapBrushProperties
argument_list|,
operator|&
name|bitmapBrush
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Could not create texture brush: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
break|break;
block|}
name|hr
operator|=
name|bitmapBrush
operator|.
name|As
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
name|qWarning
argument_list|(
literal|"%s: Could not convert texture brush: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|result
operator|&&
operator|!
name|newBrush
operator|.
name|transform
argument_list|()
operator|.
name|isIdentity
argument_list|()
condition|)
name|result
operator|->
name|SetTransform
argument_list|(
name|to_d2d_matrix_3x2_f
argument_list|(
name|newBrush
operator|.
name|transform
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
DECL|function|updateHints
name|void
name|updateHints
parameter_list|(
name|QPainter
operator|::
name|RenderHints
name|newHints
parameter_list|)
block|{
name|renderHints
operator|=
name|newHints
expr_stmt|;
name|dc
argument_list|()
operator|->
name|SetAntialiasMode
argument_list|(
name|antialiasMode
argument_list|()
argument_list|)
expr_stmt|;
block|}
template|template
parameter_list|<
name|typename
name|T
parameter_list|>
DECL|function|drawLines
name|void
name|drawLines
parameter_list|(
specifier|const
name|T
modifier|*
name|lines
parameter_list|,
name|int
name|lineCount
parameter_list|)
block|{
if|if
condition|(
operator|!
name|pen
operator|.
name|brush
condition|)
return|return;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|lineCount
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|T
modifier|&
name|line
init|=
name|lines
index|[
name|i
index|]
decl_stmt|;
comment|// Try to fit Qt's and Direct2D's idea of zero length line
comment|// handling together nicely.
if|if
condition|(
name|line
operator|.
name|p1
argument_list|()
operator|==
name|line
operator|.
name|p2
argument_list|()
operator|&&
name|pen
operator|.
name|strokeStyle
operator|.
name|Get
argument_list|()
operator|->
name|GetDashCap
argument_list|()
operator|!=
name|D2D1_CAP_STYLE_SQUARE
condition|)
block|{
if|if
condition|(
name|pen
operator|.
name|width
operator|<=
literal|1.0
condition|)
block|{
name|dc
argument_list|()
operator|->
name|SetAntialiasMode
argument_list|(
name|D2D1_ANTIALIAS_MODE_ALIASED
argument_list|)
expr_stmt|;
comment|// Note that we use pointStrokeStyle here, not the pen's stroke style!
name|dc
argument_list|()
operator|->
name|DrawLine
argument_list|(
name|to_d2d_point_2f
argument_list|(
name|line
operator|.
name|p1
argument_list|()
argument_list|)
argument_list|,
name|to_d2d_point_2f
argument_list|(
name|line
operator|.
name|p2
argument_list|()
argument_list|)
argument_list|,
name|pen
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|,
name|pen
operator|.
name|width
argument_list|,
name|pointStrokeStyle
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
name|dc
argument_list|()
operator|->
name|SetAntialiasMode
argument_list|(
name|antialiasMode
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|dc
argument_list|()
operator|->
name|DrawLine
argument_list|(
name|to_d2d_point_2f
argument_list|(
name|line
operator|.
name|p1
argument_list|()
argument_list|)
argument_list|,
name|to_d2d_point_2f
argument_list|(
name|line
operator|.
name|p2
argument_list|()
argument_list|)
argument_list|,
name|pen
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|,
name|pen
operator|.
name|width
argument_list|,
name|pen
operator|.
name|strokeStyle
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
template|template
parameter_list|<
name|typename
name|T
parameter_list|>
DECL|function|drawRects
name|void
name|drawRects
parameter_list|(
specifier|const
name|T
modifier|*
name|rects
parameter_list|,
name|int
name|rectCount
parameter_list|)
block|{
if|if
condition|(
operator|!
name|brush
operator|.
name|brush
operator|&&
operator|!
name|pen
operator|.
name|brush
condition|)
return|return;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|rectCount
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|brush
operator|.
name|brush
condition|)
name|dc
argument_list|()
operator|->
name|FillRectangle
argument_list|(
name|to_d2d_rect_f
argument_list|(
name|rects
index|[
name|i
index|]
argument_list|)
argument_list|,
name|brush
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
comment|// Direct2D for some reason uses different geometry in FillRectangle and DrawRectangle.
comment|// We have to adjust the rect right and down here by one pixel to paint the rectangle properly.
if|if
condition|(
name|pen
operator|.
name|brush
condition|)
name|dc
argument_list|()
operator|->
name|DrawRectangle
argument_list|(
name|to_d2d_rect_f
argument_list|(
name|rects
index|[
name|i
index|]
operator|.
name|adjusted
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|,
name|pen
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|,
name|pen
operator|.
name|width
argument_list|,
name|pen
operator|.
name|strokeStyle
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
template|template
parameter_list|<
name|typename
name|T
parameter_list|>
DECL|function|drawPolygon
name|void
name|drawPolygon
parameter_list|(
specifier|const
name|T
modifier|*
name|points
parameter_list|,
name|int
name|pointCount
parameter_list|,
name|QPaintEngine
operator|::
name|PolygonDrawMode
name|mode
parameter_list|)
block|{
if|if
condition|(
name|pointCount
operator|<
literal|3
condition|)
return|return;
if|if
condition|(
operator|!
name|brush
operator|.
name|brush
operator|&&
operator|!
name|pen
operator|.
name|brush
condition|)
return|return;
name|QVector
argument_list|<
name|D2D1_POINT_2F
argument_list|>
name|converted
argument_list|(
name|pointCount
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|pointCount
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|T
modifier|&
name|p
init|=
name|points
index|[
name|i
index|]
decl_stmt|;
name|converted
index|[
name|i
index|]
operator|.
name|x
operator|=
name|p
operator|.
name|x
argument_list|()
expr_stmt|;
name|converted
index|[
name|i
index|]
operator|.
name|y
operator|=
name|p
operator|.
name|y
argument_list|()
expr_stmt|;
block|}
name|drawPolygon
argument_list|(
name|converted
operator|.
name|constData
argument_list|()
argument_list|,
name|converted
operator|.
name|size
argument_list|()
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
DECL|function|drawPolygon
name|void
name|drawPolygon
parameter_list|(
specifier|const
name|D2D1_POINT_2F
modifier|*
name|points
parameter_list|,
name|int
name|pointCount
parameter_list|,
name|QPaintEngine
operator|::
name|PolygonDrawMode
name|mode
parameter_list|)
block|{
name|ComPtr
argument_list|<
name|ID2D1PathGeometry
argument_list|>
name|geometry
decl_stmt|;
name|ComPtr
argument_list|<
name|ID2D1GeometrySink
argument_list|>
name|sink
decl_stmt|;
specifier|const
name|bool
name|is_polyline
init|=
name|mode
operator|==
name|QPaintEngine
operator|::
name|PolylineMode
decl_stmt|;
name|HRESULT
name|hr
init|=
name|factory
argument_list|()
operator|->
name|CreatePathGeometry
argument_list|(
operator|&
name|geometry
argument_list|)
decl_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
return|return;
name|hr
operator|=
name|geometry
operator|->
name|Open
argument_list|(
operator|&
name|sink
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
return|return;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|QPaintEngine
operator|::
name|OddEvenMode
case|:
name|sink
operator|->
name|SetFillMode
argument_list|(
name|D2D1_FILL_MODE_ALTERNATE
argument_list|)
expr_stmt|;
break|break;
case|case
name|QPaintEngine
operator|::
name|WindingMode
case|:
name|sink
operator|->
name|SetFillMode
argument_list|(
name|D2D1_FILL_MODE_WINDING
argument_list|)
expr_stmt|;
break|break;
case|case
name|QPaintEngine
operator|::
name|ConvexMode
case|:
case|case
name|QPaintEngine
operator|::
name|PolylineMode
case|:
comment|// XXX
break|break;
block|}
name|sink
operator|->
name|BeginFigure
argument_list|(
name|points
index|[
literal|0
index|]
argument_list|,
name|is_polyline
condition|?
name|D2D1_FIGURE_BEGIN_HOLLOW
else|:
name|D2D1_FIGURE_BEGIN_FILLED
argument_list|)
expr_stmt|;
name|sink
operator|->
name|AddLines
argument_list|(
name|points
operator|+
literal|1
argument_list|,
name|pointCount
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sink
operator|->
name|EndFigure
argument_list|(
name|is_polyline
condition|?
name|D2D1_FIGURE_END_OPEN
else|:
name|D2D1_FIGURE_END_CLOSED
argument_list|)
expr_stmt|;
name|sink
operator|->
name|Close
argument_list|()
expr_stmt|;
if|if
condition|(
name|brush
operator|.
name|brush
condition|)
name|dc
argument_list|()
operator|->
name|FillGeometry
argument_list|(
name|geometry
operator|.
name|Get
argument_list|()
argument_list|,
name|brush
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|pen
operator|.
name|brush
condition|)
name|dc
argument_list|()
operator|->
name|DrawGeometry
argument_list|(
name|geometry
operator|.
name|Get
argument_list|()
argument_list|,
name|pen
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|,
name|pen
operator|.
name|width
argument_list|,
name|pen
operator|.
name|strokeStyle
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
class|;
end_class
begin_constructor
DECL|function|QWindowsDirect2DPaintEngine
name|QWindowsDirect2DPaintEngine
operator|::
name|QWindowsDirect2DPaintEngine
parameter_list|(
name|QWindowsDirect2DBitmap
modifier|*
name|bitmap
parameter_list|)
member_init_list|:
name|QPaintEngine
argument_list|(
name|PrimitiveTransform
operator||
name|PatternTransform
operator||
name|PixmapTransform
operator||
name|PatternBrush
operator||
name|AlphaBlend
operator||
name|PainterPaths
operator||
name|Antialiasing
operator||
name|BrushStroke
operator||
name|ConstantOpacity
operator||
name|MaskedBrush
operator||
name|ObjectBoundingModeGradients
comment|// Although Direct2D 1.1 contains support for both linear and radial gradients,
comment|// there unfortunately is no support for repeating or reflecting versions of them
comment|//| LinearGradientFill
comment|//| RadialGradientFill
comment|// Unsupported entirely by Direct2D 1.1
comment|//| ConicalGradientFill
comment|// We might be able to support this using Direct2D effects
comment|//| PorterDuff
comment|// Direct2D currently only supports affine transforms directly
comment|// We might be able to support this using Direct2D effects
comment|//| PerspectiveTransform
comment|// We might be able to support this using Direct2D effects
comment|//| BlendModes
comment|// We might be able to support this using Direct2D effects
comment|//| RasterOpModes
comment|// We have to inform Direct2D when we start and end drawing
comment|//| PaintOutsidePaintEvent
argument_list|)
member_init_list|,
name|d_ptr
argument_list|(
operator|new
name|QWindowsDirect2DPaintEnginePrivate
argument_list|(
name|bitmap
argument_list|)
argument_list|)
block|{  }
end_constructor
begin_function
DECL|function|begin
name|bool
name|QWindowsDirect2DPaintEngine
operator|::
name|begin
parameter_list|(
name|QPaintDevice
modifier|*
name|pdev
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|d
operator|->
name|bitmap
operator|->
name|deviceContext
argument_list|()
operator|->
name|begin
argument_list|()
expr_stmt|;
name|d
operator|->
name|dc
argument_list|()
operator|->
name|SetTransform
argument_list|(
name|D2D1
operator|::
name|Matrix3x2F
operator|::
name|Identity
argument_list|()
argument_list|)
expr_stmt|;
name|QRect
name|clip
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|pdev
operator|->
name|width
argument_list|()
argument_list|,
name|pdev
operator|->
name|height
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|systemClip
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|clip
operator|&=
name|systemClip
argument_list|()
operator|.
name|boundingRect
argument_list|()
expr_stmt|;
block|}
name|d
operator|->
name|dc
argument_list|()
operator|->
name|PushAxisAlignedClip
argument_list|(
name|to_d2d_rect_f
argument_list|(
name|clip
argument_list|)
argument_list|,
name|d
operator|->
name|antialiasMode
argument_list|()
argument_list|)
expr_stmt|;
name|updateState
argument_list|(
operator|*
name|state
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawInitialStateTag
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|end
name|bool
name|QWindowsDirect2DPaintEngine
operator|::
name|end
parameter_list|()
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|d
operator|->
name|popClip
argument_list|()
expr_stmt|;
name|d
operator|->
name|dc
argument_list|()
operator|->
name|PopAxisAlignedClip
argument_list|()
expr_stmt|;
return|return
name|d
operator|->
name|bitmap
operator|->
name|deviceContext
argument_list|()
operator|->
name|end
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|updateState
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|updateState
parameter_list|(
specifier|const
name|QPaintEngineState
modifier|&
name|state
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|d
operator|->
name|updateState
argument_list|(
name|state
argument_list|,
name|state
operator|.
name|state
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|type
name|QPaintEngine
operator|::
name|Type
name|QWindowsDirect2DPaintEngine
operator|::
name|type
parameter_list|()
specifier|const
block|{
return|return
name|QPaintEngine
operator|::
name|Direct2D
return|;
block|}
end_function
begin_function
DECL|function|drawEllipse
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawEllipse
parameter_list|(
specifier|const
name|QRectF
modifier|&
name|rect
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawEllipseTag
argument_list|)
expr_stmt|;
name|D2D1_ELLIPSE
name|ellipse
init|=
block|{
name|to_d2d_point_2f
argument_list|(
name|rect
operator|.
name|center
argument_list|()
argument_list|)
block|,
name|rect
operator|.
name|width
argument_list|()
operator|/
literal|2
block|,
name|rect
operator|.
name|height
argument_list|()
operator|/
literal|2
block|}
decl_stmt|;
if|if
condition|(
name|d
operator|->
name|brush
operator|.
name|brush
condition|)
name|d
operator|->
name|dc
argument_list|()
operator|->
name|FillEllipse
argument_list|(
name|ellipse
argument_list|,
name|d
operator|->
name|brush
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|pen
operator|.
name|brush
condition|)
block|{
name|d
operator|->
name|dc
argument_list|()
operator|->
name|DrawEllipse
argument_list|(
name|ellipse
argument_list|,
name|d
operator|->
name|pen
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|,
name|d
operator|->
name|pen
operator|.
name|width
argument_list|,
name|d
operator|->
name|pen
operator|.
name|strokeStyle
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|drawEllipse
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawEllipse
parameter_list|(
specifier|const
name|QRect
modifier|&
name|rect
parameter_list|)
block|{
name|drawEllipse
argument_list|(
name|QRectF
argument_list|(
name|rect
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawImage
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawImage
parameter_list|(
specifier|const
name|QRectF
modifier|&
name|rectangle
parameter_list|,
specifier|const
name|QImage
modifier|&
name|image
parameter_list|,
specifier|const
name|QRectF
modifier|&
name|sr
parameter_list|,
name|Qt
operator|::
name|ImageConversionFlags
name|flags
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawImageTag
argument_list|)
expr_stmt|;
name|QPixmap
name|pixmap
init|=
name|QPixmap
operator|::
name|fromImage
argument_list|(
name|image
argument_list|,
name|flags
argument_list|)
decl_stmt|;
name|drawPixmap
argument_list|(
name|rectangle
argument_list|,
name|pixmap
argument_list|,
name|sr
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawLines
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawLines
parameter_list|(
specifier|const
name|QLineF
modifier|*
name|lines
parameter_list|,
name|int
name|lineCount
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawLinesTag
argument_list|)
expr_stmt|;
name|d
operator|->
name|drawLines
argument_list|(
name|lines
argument_list|,
name|lineCount
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawLines
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawLines
parameter_list|(
specifier|const
name|QLine
modifier|*
name|lines
parameter_list|,
name|int
name|lineCount
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawLinesTag
argument_list|)
expr_stmt|;
name|d
operator|->
name|drawLines
argument_list|(
name|lines
argument_list|,
name|lineCount
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawPath
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawPath
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|path
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawPathTag
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|.
name|elementCount
argument_list|()
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|d
operator|->
name|brush
operator|.
name|brush
operator|&&
operator|!
name|d
operator|->
name|pen
operator|.
name|brush
condition|)
return|return;
name|ComPtr
argument_list|<
name|ID2D1PathGeometry
argument_list|>
name|geometry
init|=
name|painterPathToPathGeometry
argument_list|(
name|path
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|geometry
condition|)
return|return;
if|if
condition|(
name|d
operator|->
name|brush
operator|.
name|brush
condition|)
name|d
operator|->
name|dc
argument_list|()
operator|->
name|FillGeometry
argument_list|(
name|geometry
operator|.
name|Get
argument_list|()
argument_list|,
name|d
operator|->
name|brush
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|pen
operator|.
name|brush
condition|)
name|d
operator|->
name|dc
argument_list|()
operator|->
name|DrawGeometry
argument_list|(
name|geometry
operator|.
name|Get
argument_list|()
argument_list|,
name|d
operator|->
name|pen
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|,
name|d
operator|->
name|pen
operator|.
name|width
argument_list|,
name|d
operator|->
name|pen
operator|.
name|strokeStyle
operator|.
name|Get
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawPixmap
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawPixmap
parameter_list|(
specifier|const
name|QRectF
modifier|&
name|r
parameter_list|,
specifier|const
name|QPixmap
modifier|&
name|pm
parameter_list|,
specifier|const
name|QRectF
modifier|&
name|sr
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawPixmapTag
argument_list|)
expr_stmt|;
if|if
condition|(
name|pm
operator|.
name|isNull
argument_list|()
condition|)
return|return;
if|if
condition|(
name|pm
operator|.
name|handle
argument_list|()
operator|->
name|pixelType
argument_list|()
operator|==
name|QPlatformPixmap
operator|::
name|BitmapType
condition|)
block|{
name|QImage
name|i
init|=
name|pm
operator|.
name|toImage
argument_list|()
decl_stmt|;
name|i
operator|.
name|setColor
argument_list|(
literal|0
argument_list|,
name|qRgba
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|.
name|setColor
argument_list|(
literal|1
argument_list|,
name|d
operator|->
name|pen
operator|.
name|color
operator|.
name|rgba
argument_list|()
argument_list|)
expr_stmt|;
name|drawImage
argument_list|(
name|r
argument_list|,
name|i
argument_list|,
name|sr
argument_list|)
expr_stmt|;
return|return;
block|}
name|QWindowsDirect2DPlatformPixmap
modifier|*
name|pp
init|=
cast|static_cast
argument_list|<
name|QWindowsDirect2DPlatformPixmap
operator|*
argument_list|>
argument_list|(
name|pm
operator|.
name|handle
argument_list|()
argument_list|)
decl_stmt|;
name|QWindowsDirect2DBitmap
modifier|*
name|bitmap
init|=
name|pp
operator|->
name|bitmap
argument_list|()
decl_stmt|;
if|if
condition|(
name|bitmap
operator|->
name|bitmap
argument_list|()
operator|!=
name|d
operator|->
name|bitmap
operator|->
name|bitmap
argument_list|()
condition|)
block|{
comment|// Good, src bitmap != dst bitmap
if|if
condition|(
name|sr
operator|.
name|isValid
argument_list|()
condition|)
name|d
operator|->
name|dc
argument_list|()
operator|->
name|DrawBitmap
argument_list|(
name|bitmap
operator|->
name|bitmap
argument_list|()
argument_list|,
name|to_d2d_rect_f
argument_list|(
name|r
argument_list|)
argument_list|,
name|d
operator|->
name|opacity
argument_list|,
name|d
operator|->
name|interpolationMode
argument_list|()
argument_list|,
name|to_d2d_rect_f
argument_list|(
name|sr
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|d
operator|->
name|dc
argument_list|()
operator|->
name|DrawBitmap
argument_list|(
name|bitmap
operator|->
name|bitmap
argument_list|()
argument_list|,
name|to_d2d_rect_f
argument_list|(
name|r
argument_list|)
argument_list|,
name|d
operator|->
name|opacity
argument_list|,
name|d
operator|->
name|interpolationMode
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Ok, so the source pixmap and destination pixmap is the same.
comment|// D2D is not fond of this scenario, deal with it through
comment|// an intermediate bitmap
name|QWindowsDirect2DBitmap
name|intermediate
decl_stmt|;
if|if
condition|(
name|sr
operator|.
name|isValid
argument_list|()
condition|)
block|{
name|bool
name|r
init|=
name|intermediate
operator|.
name|resize
argument_list|(
name|sr
operator|.
name|width
argument_list|()
argument_list|,
name|sr
operator|.
name|height
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
block|{
name|qDebug
argument_list|(
literal|"%s: Could not resize intermediate bitmap to source rect size"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return;
block|}
name|D2D1_RECT_U
name|d2d_sr
init|=
name|to_d2d_rect_u
argument_list|(
name|sr
operator|.
name|toRect
argument_list|()
argument_list|)
decl_stmt|;
name|HRESULT
name|hr
init|=
name|intermediate
operator|.
name|bitmap
argument_list|()
operator|->
name|CopyFromBitmap
argument_list|(
name|NULL
argument_list|,
name|bitmap
operator|->
name|bitmap
argument_list|()
argument_list|,
operator|&
name|d2d_sr
argument_list|)
decl_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Could not copy source rect area from source bitmap to intermediate bitmap: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|bool
name|r
init|=
name|intermediate
operator|.
name|resize
argument_list|(
name|bitmap
operator|->
name|size
argument_list|()
operator|.
name|width
argument_list|()
argument_list|,
name|bitmap
operator|->
name|size
argument_list|()
operator|.
name|height
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
block|{
name|qDebug
argument_list|(
literal|"%s: Could not resize intermediate bitmap to source bitmap size"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return;
block|}
name|HRESULT
name|hr
init|=
name|intermediate
operator|.
name|bitmap
argument_list|()
operator|->
name|CopyFromBitmap
argument_list|(
name|NULL
argument_list|,
name|bitmap
operator|->
name|bitmap
argument_list|()
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|qWarning
argument_list|(
literal|"%s: Could not copy source bitmap to intermediate bitmap: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|d
operator|->
name|dc
argument_list|()
operator|->
name|DrawBitmap
argument_list|(
name|intermediate
operator|.
name|bitmap
argument_list|()
argument_list|,
name|to_d2d_rect_f
argument_list|(
name|r
argument_list|)
argument_list|,
name|d
operator|->
name|opacity
argument_list|,
name|d
operator|->
name|interpolationMode
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|drawPolygon
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawPolygon
parameter_list|(
specifier|const
name|QPointF
modifier|*
name|points
parameter_list|,
name|int
name|pointCount
parameter_list|,
name|QPaintEngine
operator|::
name|PolygonDrawMode
name|mode
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawPolygonTag
argument_list|)
expr_stmt|;
name|d
operator|->
name|drawPolygon
argument_list|(
name|points
argument_list|,
name|pointCount
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawPolygon
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawPolygon
parameter_list|(
specifier|const
name|QPoint
modifier|*
name|points
parameter_list|,
name|int
name|pointCount
parameter_list|,
name|QPaintEngine
operator|::
name|PolygonDrawMode
name|mode
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawPolygonTag
argument_list|)
expr_stmt|;
name|d
operator|->
name|drawPolygon
argument_list|(
name|points
argument_list|,
name|pointCount
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawRects
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawRects
parameter_list|(
specifier|const
name|QRectF
modifier|*
name|rects
parameter_list|,
name|int
name|rectCount
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawRectsTag
argument_list|)
expr_stmt|;
name|d
operator|->
name|drawRects
argument_list|(
name|rects
argument_list|,
name|rectCount
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawRects
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawRects
parameter_list|(
specifier|const
name|QRect
modifier|*
name|rects
parameter_list|,
name|int
name|rectCount
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawRectsTag
argument_list|)
expr_stmt|;
name|d
operator|->
name|drawRects
argument_list|(
name|rects
argument_list|,
name|rectCount
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|// Points (1/72 inches) to Microsoft's Device Independent Pixels (1/96 inches)
end_comment
begin_function
DECL|function|pointSizeToDIP
specifier|inline
specifier|static
name|Q_DECL_CONSTEXPR
name|FLOAT
name|pointSizeToDIP
parameter_list|(
name|qreal
name|pointSize
parameter_list|)
block|{
return|return
name|pointSize
operator|+
operator|(
name|pointSize
operator|/
name|qreal
argument_list|(
literal|3.0
argument_list|)
operator|)
return|;
block|}
end_function
begin_function
DECL|function|pixelSizeToDIP
specifier|inline
specifier|static
name|FLOAT
name|pixelSizeToDIP
parameter_list|(
name|int
name|pixelSize
parameter_list|)
block|{
name|FLOAT
name|dpiX
decl_stmt|,
name|dpiY
decl_stmt|;
name|factory
argument_list|()
operator|->
name|GetDesktopDpi
argument_list|(
operator|&
name|dpiX
argument_list|,
operator|&
name|dpiY
argument_list|)
expr_stmt|;
return|return
name|FLOAT
argument_list|(
name|pixelSize
argument_list|)
operator|/
operator|(
name|dpiY
operator|/
literal|96.0f
operator|)
return|;
block|}
end_function
begin_function
DECL|function|fontSizeInDIP
specifier|inline
specifier|static
name|FLOAT
name|fontSizeInDIP
parameter_list|(
specifier|const
name|QFont
modifier|&
name|font
parameter_list|)
block|{
comment|// Microsoft wants the font size in DIPs (Device Independent Pixels), each of which is 1/96 inches.
if|if
condition|(
name|font
operator|.
name|pixelSize
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
comment|// font size was set as points
return|return
name|pointSizeToDIP
argument_list|(
name|font
operator|.
name|pointSizeF
argument_list|()
argument_list|)
return|;
block|}
else|else
block|{
comment|// font size was set as pixels
return|return
name|pixelSizeToDIP
argument_list|(
name|font
operator|.
name|pixelSize
argument_list|()
argument_list|)
return|;
block|}
block|}
end_function
begin_function
DECL|function|drawTextItem
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawTextItem
parameter_list|(
specifier|const
name|QPointF
modifier|&
name|p
parameter_list|,
specifier|const
name|QTextItem
modifier|&
name|textItem
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawTextItemTag
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|pen
operator|.
name|isNull
condition|)
return|return;
comment|// If we can't support the current configuration with Direct2D, fall back to slow path
comment|// Most common cases are perspective transform and gradient brush as pen
if|if
condition|(
name|d
operator|->
name|hasPerspectiveTransform
operator|||
operator|!
name|d
operator|->
name|pen
operator|.
name|brush
condition|)
block|{
name|QPaintEngine
operator|::
name|drawTextItem
argument_list|(
name|p
argument_list|,
name|textItem
argument_list|)
expr_stmt|;
return|return;
block|}
specifier|const
name|QTextItemInt
modifier|&
name|ti
init|=
cast|static_cast
argument_list|<
specifier|const
name|QTextItemInt
operator|&
argument_list|>
argument_list|(
name|textItem
argument_list|)
decl_stmt|;
name|ComPtr
argument_list|<
name|IDWriteFontFace
argument_list|>
name|fontFace
decl_stmt|;
switch|switch
condition|(
name|ti
operator|.
name|fontEngine
operator|->
name|type
argument_list|()
condition|)
block|{
case|case
name|QFontEngine
operator|::
name|Win
case|:
block|{
name|QWindowsFontEngine
modifier|*
name|wfe
init|=
cast|static_cast
argument_list|<
name|QWindowsFontEngine
operator|*
argument_list|>
argument_list|(
name|ti
operator|.
name|fontEngine
argument_list|)
decl_stmt|;
name|QSharedPointer
argument_list|<
name|QWindowsFontEngineData
argument_list|>
name|wfed
init|=
name|wfe
operator|->
name|fontEngineData
argument_list|()
decl_stmt|;
name|HGDIOBJ
name|oldfont
init|=
name|wfe
operator|->
name|selectDesignFont
argument_list|()
decl_stmt|;
name|HRESULT
name|hr
init|=
name|QWindowsDirect2DContext
operator|::
name|instance
argument_list|()
operator|->
name|dwriteGdiInterop
argument_list|()
operator|->
name|CreateFontFaceFromHdc
argument_list|(
name|wfed
operator|->
name|hdc
argument_list|,
operator|&
name|fontFace
argument_list|)
decl_stmt|;
name|DeleteObject
argument_list|(
name|SelectObject
argument_list|(
name|wfed
operator|->
name|hdc
argument_list|,
name|oldfont
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
name|qWarning
argument_list|(
literal|"%s: Could not create DirectWrite fontface from HDC: %#x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|hr
argument_list|)
expr_stmt|;
block|}
break|break;
ifndef|#
directive|ifndef
name|QT_NO_DIRECTWRITE
case|case
name|QFontEngine
operator|::
name|DirectWrite
case|:
block|{
name|QWindowsFontEngineDirectWrite
modifier|*
name|wfedw
init|=
cast|static_cast
argument_list|<
name|QWindowsFontEngineDirectWrite
operator|*
argument_list|>
argument_list|(
name|ti
operator|.
name|fontEngine
argument_list|)
decl_stmt|;
name|fontFace
operator|=
name|wfedw
operator|->
name|directWriteFontFace
argument_list|()
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|// QT_NO_DIRECTWRITE
default|default:
name|qDebug
argument_list|(
literal|"%s: Unknown font engine!"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|fontFace
condition|)
block|{
name|qDebug
argument_list|(
literal|"%s: Could not find font - falling back to slow text rendering path."
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|QPaintEngine
operator|::
name|drawTextItem
argument_list|(
name|p
argument_list|,
name|textItem
argument_list|)
expr_stmt|;
return|return;
block|}
name|QVector
argument_list|<
name|UINT16
argument_list|>
name|glyphIndices
argument_list|(
name|ti
operator|.
name|glyphs
operator|.
name|numGlyphs
argument_list|)
decl_stmt|;
name|QVector
argument_list|<
name|FLOAT
argument_list|>
name|glyphAdvances
argument_list|(
name|ti
operator|.
name|glyphs
operator|.
name|numGlyphs
argument_list|)
decl_stmt|;
name|QVector
argument_list|<
name|DWRITE_GLYPH_OFFSET
argument_list|>
name|glyphOffsets
argument_list|(
name|ti
operator|.
name|glyphs
operator|.
name|numGlyphs
argument_list|)
decl_stmt|;
comment|// Imperfect conversion here
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|ti
operator|.
name|glyphs
operator|.
name|numGlyphs
condition|;
name|i
operator|++
control|)
block|{
name|glyphIndices
index|[
name|i
index|]
operator|=
name|UINT16
argument_list|(
name|ti
operator|.
name|glyphs
operator|.
name|glyphs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|glyphAdvances
index|[
name|i
index|]
operator|=
name|ti
operator|.
name|glyphs
operator|.
name|effectiveAdvance
argument_list|(
name|i
argument_list|)
operator|.
name|toReal
argument_list|()
expr_stmt|;
name|glyphOffsets
index|[
name|i
index|]
operator|.
name|advanceOffset
operator|=
name|ti
operator|.
name|glyphs
operator|.
name|offsets
index|[
name|i
index|]
operator|.
name|x
operator|.
name|toReal
argument_list|()
expr_stmt|;
name|glyphOffsets
index|[
name|i
index|]
operator|.
name|ascenderOffset
operator|=
name|ti
operator|.
name|glyphs
operator|.
name|offsets
index|[
name|i
index|]
operator|.
name|y
operator|.
name|toReal
argument_list|()
expr_stmt|;
block|}
specifier|const
name|bool
name|rtl
init|=
operator|(
name|ti
operator|.
name|flags
operator|&
name|QTextItem
operator|::
name|RightToLeft
operator|)
decl_stmt|;
specifier|const
name|UINT32
name|bidiLevel
init|=
name|rtl
condition|?
literal|1
else|:
literal|0
decl_stmt|;
name|DWRITE_GLYPH_RUN
name|glyphRun
init|=
block|{
name|fontFace
operator|.
name|Get
argument_list|()
block|,
comment|//    IDWriteFontFace           *fontFace;
name|fontSizeInDIP
argument_list|(
name|ti
operator|.
name|font
argument_list|()
argument_list|)
block|,
comment|//    FLOAT                     fontEmSize;
name|ti
operator|.
name|glyphs
operator|.
name|numGlyphs
block|,
comment|//    UINT32                    glyphCount;
name|glyphIndices
operator|.
name|constData
argument_list|()
block|,
comment|//    const UINT16              *glyphIndices;
name|glyphAdvances
operator|.
name|constData
argument_list|()
block|,
comment|//    const FLOAT               *glyphAdvances;
name|glyphOffsets
operator|.
name|constData
argument_list|()
block|,
comment|//    const DWRITE_GLYPH_OFFSET *glyphOffsets;
name|FALSE
block|,
comment|//    BOOL                      isSideways;
name|bidiLevel
comment|//    UINT32                    bidiLevel;
block|}
decl_stmt|;
specifier|const
name|bool
name|antiAlias
init|=
name|bool
argument_list|(
operator|(
name|d
operator|->
name|renderHints
operator|&
name|QPainter
operator|::
name|TextAntialiasing
operator|)
operator|&&
operator|!
operator|(
name|ti
operator|.
name|font
argument_list|()
operator|.
name|styleStrategy
argument_list|()
operator|&
name|QFont
operator|::
name|NoAntialias
operator|)
argument_list|)
decl_stmt|;
name|d
operator|->
name|dc
argument_list|()
operator|->
name|SetTextAntialiasMode
argument_list|(
name|antiAlias
condition|?
name|D2D1_TEXT_ANTIALIAS_MODE_CLEARTYPE
else|:
name|D2D1_TEXT_ANTIALIAS_MODE_ALIASED
argument_list|)
expr_stmt|;
specifier|const
name|QPointF
name|offset
argument_list|(
name|rtl
condition|?
name|ti
operator|.
name|width
operator|.
name|toReal
argument_list|()
else|:
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|d
operator|->
name|dc
argument_list|()
operator|->
name|DrawGlyphRun
argument_list|(
name|to_d2d_point_2f
argument_list|(
name|p
operator|+
name|offset
argument_list|)
argument_list|,
operator|&
name|glyphRun
argument_list|,
name|NULL
argument_list|,
name|d
operator|->
name|pen
operator|.
name|brush
operator|.
name|Get
argument_list|()
argument_list|,
name|DWRITE_MEASURING_MODE_GDI_CLASSIC
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|qt_draw_tile
specifier|static
name|void
name|qt_draw_tile
parameter_list|(
name|QPaintEngine
modifier|*
name|gc
parameter_list|,
name|qreal
name|x
parameter_list|,
name|qreal
name|y
parameter_list|,
name|qreal
name|w
parameter_list|,
name|qreal
name|h
parameter_list|,
specifier|const
name|QPixmap
modifier|&
name|pixmap
parameter_list|,
name|qreal
name|xOffset
parameter_list|,
name|qreal
name|yOffset
parameter_list|)
block|{
name|qreal
name|yPos
decl_stmt|,
name|xPos
decl_stmt|,
name|drawH
decl_stmt|,
name|drawW
decl_stmt|,
name|yOff
decl_stmt|,
name|xOff
decl_stmt|;
name|yPos
operator|=
name|y
expr_stmt|;
name|yOff
operator|=
name|yOffset
expr_stmt|;
while|while
condition|(
name|yPos
operator|<
name|y
operator|+
name|h
condition|)
block|{
name|drawH
operator|=
name|pixmap
operator|.
name|height
argument_list|()
operator|-
name|yOff
expr_stmt|;
comment|// Cropping first row
if|if
condition|(
name|yPos
operator|+
name|drawH
operator|>
name|y
operator|+
name|h
condition|)
comment|// Cropping last row
name|drawH
operator|=
name|y
operator|+
name|h
operator|-
name|yPos
expr_stmt|;
name|xPos
operator|=
name|x
expr_stmt|;
name|xOff
operator|=
name|xOffset
expr_stmt|;
while|while
condition|(
name|xPos
operator|<
name|x
operator|+
name|w
condition|)
block|{
name|drawW
operator|=
name|pixmap
operator|.
name|width
argument_list|()
operator|-
name|xOff
expr_stmt|;
comment|// Cropping first column
if|if
condition|(
name|xPos
operator|+
name|drawW
operator|>
name|x
operator|+
name|w
condition|)
comment|// Cropping last column
name|drawW
operator|=
name|x
operator|+
name|w
operator|-
name|xPos
expr_stmt|;
if|if
condition|(
name|drawW
operator|>
literal|0
operator|&&
name|drawH
operator|>
literal|0
condition|)
name|gc
operator|->
name|drawPixmap
argument_list|(
name|QRectF
argument_list|(
name|xPos
argument_list|,
name|yPos
argument_list|,
name|drawW
argument_list|,
name|drawH
argument_list|)
argument_list|,
name|pixmap
argument_list|,
name|QRectF
argument_list|(
name|xOff
argument_list|,
name|yOff
argument_list|,
name|drawW
argument_list|,
name|drawH
argument_list|)
argument_list|)
expr_stmt|;
name|xPos
operator|+=
name|drawW
expr_stmt|;
name|xOff
operator|=
literal|0
expr_stmt|;
block|}
name|yPos
operator|+=
name|drawH
expr_stmt|;
name|yOff
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|drawTiledPixmap
name|void
name|QWindowsDirect2DPaintEngine
operator|::
name|drawTiledPixmap
parameter_list|(
specifier|const
name|QRectF
modifier|&
name|rect
parameter_list|,
specifier|const
name|QPixmap
modifier|&
name|pixmap
parameter_list|,
specifier|const
name|QPointF
modifier|&
name|p
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWindowsDirect2DPaintEngine
argument_list|)
expr_stmt|;
name|D2D_TAG
argument_list|(
name|D2DDebugDrawTextItemTag
argument_list|)
expr_stmt|;
name|qt_draw_tile
argument_list|(
name|this
argument_list|,
name|rect
operator|.
name|x
argument_list|()
argument_list|,
name|rect
operator|.
name|y
argument_list|()
argument_list|,
name|rect
operator|.
name|width
argument_list|()
argument_list|,
name|rect
operator|.
name|height
argument_list|()
argument_list|,
name|pixmap
argument_list|,
name|p
operator|.
name|x
argument_list|()
argument_list|,
name|p
operator|.
name|y
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_macro
name|QT_END_NAMESPACE
end_macro
end_unit
