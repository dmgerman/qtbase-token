begin_unit
begin_comment
comment|/*************************************************************************** ** ** Copyright (C) 2011 - 2012 Research In Motion ** Contact: http://www.qt-project.org/ ** ** This file is part of the plugins of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** GNU Lesser General Public License Usage ** This file may be used under the terms of the GNU Lesser General Public ** License version 2.1 as published by the Free Software Foundation and ** appearing in the file LICENSE.LGPL included in the packaging of this ** file. Please review the following information to ensure the GNU Lesser ** General Public License version 2.1 requirements will be met: ** http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Nokia gives you certain additional ** rights. These rights are described in the Nokia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU General ** Public License version 3.0 as published by the Free Software Foundation ** and appearing in the file LICENSE.GPL included in the packaging of this ** file. Please review the following information to ensure the GNU General ** Public License version 3.0 requirements will be met: ** http://www.gnu.org/copyleft/gpl.html. ** ** Other Usage ** Alternatively, this file may be used in accordance with the terms and ** conditions contained in a signed written agreement between you and Nokia. ** ** ** ** ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"qbbscreen.h"
end_include
begin_include
include|#
directive|include
file|"qbbvirtualkeyboard.h"
end_include
begin_include
include|#
directive|include
file|"qbbwindow.h"
end_include
begin_include
include|#
directive|include
file|<QtCore/QDebug>
end_include
begin_include
include|#
directive|include
file|<QtCore/QUuid>
end_include
begin_include
include|#
directive|include
file|<errno.h>
end_include
begin_decl_stmt
name|QT_BEGIN_NAMESPACE
DECL|member|ms_screens
name|QList
argument_list|<
name|QPlatformScreen
modifier|*
argument_list|>
name|QBBScreen
operator|::
name|ms_screens
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|member|ms_childWindows
name|QList
argument_list|<
name|QBBWindow
modifier|*
argument_list|>
name|QBBScreen
operator|::
name|ms_childWindows
decl_stmt|;
end_decl_stmt
begin_constructor
DECL|function|QBBScreen
name|QBBScreen
operator|::
name|QBBScreen
parameter_list|(
name|screen_context_t
name|screenContext
parameter_list|,
name|screen_display_t
name|display
parameter_list|,
name|bool
name|primaryScreen
parameter_list|)
member_init_list|:
name|m_screenContext
argument_list|(
name|screenContext
argument_list|)
member_init_list|,
name|m_display
argument_list|(
name|display
argument_list|)
member_init_list|,
name|m_rootWindow
argument_list|()
member_init_list|,
name|m_primaryScreen
argument_list|(
name|primaryScreen
argument_list|)
member_init_list|,
name|m_posted
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|m_platformContext
argument_list|(
literal|0
argument_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
expr_stmt|;
endif|#
directive|endif
comment|// Cache initial orientation of this display
comment|// TODO: use ORIENTATION environment variable?
name|errno
operator|=
literal|0
expr_stmt|;
name|int
name|result
init|=
name|screen_get_display_property_iv
argument_list|(
name|m_display
argument_list|,
name|SCREEN_PROPERTY_ROTATION
argument_list|,
operator|&
name|m_initialRotation
argument_list|)
decl_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
name|qFatal
argument_list|(
literal|"QBBScreen: failed to query display rotation, errno=%d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
name|m_currentRotation
operator|=
name|m_initialRotation
expr_stmt|;
comment|// Cache size of this display in pixels
comment|// TODO: use WIDTH and HEIGHT environment variables?
name|errno
operator|=
literal|0
expr_stmt|;
name|int
name|val
index|[
literal|2
index|]
decl_stmt|;
name|result
operator|=
name|screen_get_display_property_iv
argument_list|(
name|m_display
argument_list|,
name|SCREEN_PROPERTY_SIZE
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
name|qFatal
argument_list|(
literal|"QBBScreen: failed to query display size, errno=%d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
name|m_currentGeometry
operator|=
name|m_initialGeometry
operator|=
name|QRect
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|val
index|[
literal|0
index|]
argument_list|,
name|val
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|// Cache size of this display in millimeters
name|errno
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|screen_get_display_property_iv
argument_list|(
name|m_display
argument_list|,
name|SCREEN_PROPERTY_PHYSICAL_SIZE
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
name|qFatal
argument_list|(
literal|"QBBScreen: failed to query display physical size, errno=%d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
comment|// Peg the DPI to 96 (for now) so fonts are a reasonable size. We'll want to match
comment|// everything with a QStyle later, and at that point the physical size can be used
comment|// instead.
block|{
specifier|static
specifier|const
name|int
name|dpi
init|=
literal|96
decl_stmt|;
name|int
name|width
init|=
name|m_currentGeometry
operator|.
name|width
argument_list|()
operator|/
name|dpi
operator|*
name|qreal
argument_list|(
literal|25.4
argument_list|)
decl_stmt|;
name|int
name|height
init|=
name|m_currentGeometry
operator|.
name|height
argument_list|()
operator|/
name|dpi
operator|*
name|qreal
argument_list|(
literal|25.4
argument_list|)
decl_stmt|;
name|m_currentPhysicalSize
operator|=
name|m_initialPhysicalSize
operator|=
name|QSize
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
comment|// We only create the root window if we are the primary display.
if|if
condition|(
name|primaryScreen
condition|)
name|m_rootWindow
operator|=
name|QSharedPointer
argument_list|<
name|QBBRootWindow
argument_list|>
argument_list|(
operator|new
name|QBBRootWindow
argument_list|(
name|this
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_constructor
begin_destructor
DECL|function|~QBBScreen
name|QBBScreen
operator|::
name|~
name|QBBScreen
parameter_list|()
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
expr_stmt|;
endif|#
directive|endif
block|}
end_destructor
begin_comment
comment|/* static */
end_comment
begin_function
DECL|function|createDisplays
name|void
name|QBBScreen
operator|::
name|createDisplays
parameter_list|(
name|screen_context_t
name|context
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
expr_stmt|;
endif|#
directive|endif
comment|// Query number of displays
name|errno
operator|=
literal|0
expr_stmt|;
name|int
name|displayCount
decl_stmt|;
name|int
name|result
init|=
name|screen_get_context_property_iv
argument_list|(
name|context
argument_list|,
name|SCREEN_PROPERTY_DISPLAY_COUNT
argument_list|,
operator|&
name|displayCount
argument_list|)
decl_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
name|qFatal
argument_list|(
literal|"QBBScreen: failed to query display count, errno=%d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
comment|// Get all displays
name|errno
operator|=
literal|0
expr_stmt|;
name|screen_display_t
modifier|*
name|displays
init|=
operator|(
name|screen_display_t
operator|*
operator|)
name|alloca
argument_list|(
sizeof|sizeof
argument_list|(
name|screen_display_t
argument_list|)
operator|*
name|displayCount
argument_list|)
decl_stmt|;
name|result
operator|=
name|screen_get_context_property_pv
argument_list|(
name|context
argument_list|,
name|SCREEN_PROPERTY_DISPLAYS
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
name|displays
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
name|qFatal
argument_list|(
literal|"QBBScreen: failed to query displays, errno=%d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|displayCount
condition|;
name|i
operator|++
control|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
literal|"QBBScreen::Creating screen for display "
operator|<<
name|i
expr_stmt|;
endif|#
directive|endif
name|QBBScreen
modifier|*
name|screen
init|=
operator|new
name|QBBScreen
argument_list|(
name|context
argument_list|,
name|displays
index|[
name|i
index|]
argument_list|,
name|i
operator|==
literal|0
argument_list|)
decl_stmt|;
name|ms_screens
operator|.
name|append
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_comment
comment|/* static */
end_comment
begin_function
DECL|function|destroyDisplays
name|void
name|QBBScreen
operator|::
name|destroyDisplays
parameter_list|()
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
expr_stmt|;
endif|#
directive|endif
name|qDeleteAll
argument_list|(
name|ms_screens
argument_list|)
expr_stmt|;
name|ms_screens
operator|.
name|clear
argument_list|()
expr_stmt|;
comment|// We're not managing the child windows anymore so we need to clear the list.
name|ms_childWindows
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
end_function
begin_comment
comment|/* static */
end_comment
begin_function
DECL|function|defaultDepth
name|int
name|QBBScreen
operator|::
name|defaultDepth
parameter_list|()
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
expr_stmt|;
endif|#
directive|endif
specifier|static
name|int
name|defaultDepth
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|defaultDepth
operator|==
literal|0
condition|)
block|{
comment|// check if display depth was specified in environment variable;
comment|// use default value if no valid value found
name|defaultDepth
operator|=
name|qgetenv
argument_list|(
literal|"QBB_DISPLAY_DEPTH"
argument_list|)
operator|.
name|toInt
argument_list|()
expr_stmt|;
if|if
condition|(
name|defaultDepth
operator|!=
literal|16
operator|&&
name|defaultDepth
operator|!=
literal|32
condition|)
block|{
name|defaultDepth
operator|=
literal|32
expr_stmt|;
block|}
block|}
return|return
name|defaultDepth
return|;
block|}
end_function
begin_function
DECL|function|availableGeometry
name|QRect
name|QBBScreen
operator|::
name|availableGeometry
parameter_list|()
specifier|const
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
expr_stmt|;
endif|#
directive|endif
comment|// available geometry = total geometry - keyboard
name|int
name|keyboardHeight
init|=
name|QBBVirtualKeyboard
operator|::
name|instance
argument_list|()
operator|.
name|height
argument_list|()
decl_stmt|;
return|return
name|QRect
argument_list|(
name|m_currentGeometry
operator|.
name|x
argument_list|()
argument_list|,
name|m_currentGeometry
operator|.
name|y
argument_list|()
argument_list|,
name|m_currentGeometry
operator|.
name|width
argument_list|()
argument_list|,
name|m_currentGeometry
operator|.
name|height
argument_list|()
operator|-
name|keyboardHeight
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/*!     Check if the supplied angles are perpendicular to each other. */
end_comment
begin_function
DECL|function|isOrthogonal
specifier|static
name|bool
name|isOrthogonal
parameter_list|(
name|int
name|angle1
parameter_list|,
name|int
name|angle2
parameter_list|)
block|{
return|return
operator|(
operator|(
name|angle1
operator|-
name|angle2
operator|)
operator|%
literal|180
operator|)
operator|!=
literal|0
return|;
block|}
end_function
begin_function
DECL|function|setRotation
name|void
name|QBBScreen
operator|::
name|setRotation
parameter_list|(
name|int
name|rotation
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
operator|<<
literal|"orientation ="
operator|<<
name|rotation
expr_stmt|;
endif|#
directive|endif
comment|// Check if rotation changed
if|if
condition|(
name|m_currentRotation
operator|!=
name|rotation
condition|)
block|{
comment|// Update rotation of root window
if|if
condition|(
name|m_rootWindow
condition|)
name|m_rootWindow
operator|->
name|setRotation
argument_list|(
name|rotation
argument_list|)
expr_stmt|;
comment|// Swap dimensions if we've rotated 90 or 270 from initial orientation
if|if
condition|(
name|isOrthogonal
argument_list|(
name|m_currentRotation
argument_list|,
name|rotation
argument_list|)
condition|)
block|{
name|m_currentGeometry
operator|=
name|QRect
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|m_initialGeometry
operator|.
name|height
argument_list|()
argument_list|,
name|m_initialGeometry
operator|.
name|width
argument_list|()
argument_list|)
expr_stmt|;
name|m_currentPhysicalSize
operator|=
name|QSize
argument_list|(
name|m_initialPhysicalSize
operator|.
name|height
argument_list|()
argument_list|,
name|m_initialPhysicalSize
operator|.
name|width
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|m_currentGeometry
operator|=
name|QRect
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|m_initialGeometry
operator|.
name|width
argument_list|()
argument_list|,
name|m_initialGeometry
operator|.
name|height
argument_list|()
argument_list|)
expr_stmt|;
name|m_currentPhysicalSize
operator|=
name|m_initialPhysicalSize
expr_stmt|;
block|}
comment|// Resize root window if we've rotated 90 or 270 from previous orientation
if|if
condition|(
name|isOrthogonal
argument_list|(
name|m_currentRotation
argument_list|,
name|rotation
argument_list|)
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
operator|<<
literal|"resize, size ="
operator|<<
name|m_currentGeometry
operator|.
name|size
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|m_rootWindow
condition|)
name|m_rootWindow
operator|->
name|resize
argument_list|(
name|m_currentGeometry
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// TODO: Find one global place to flush display updates
comment|// Force immediate display update if no geometry changes required
if|if
condition|(
name|m_rootWindow
condition|)
name|m_rootWindow
operator|->
name|flush
argument_list|()
expr_stmt|;
block|}
comment|// Save new rotation
name|m_currentRotation
operator|=
name|rotation
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|addWindow
name|void
name|QBBScreen
operator|::
name|addWindow
parameter_list|(
name|QBBWindow
modifier|*
name|window
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
operator|<<
literal|"window ="
operator|<<
name|window
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ms_childWindows
operator|.
name|contains
argument_list|(
name|window
argument_list|)
condition|)
return|return;
name|ms_childWindows
operator|.
name|push_back
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|QBBScreen
operator|::
name|updateHierarchy
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|removeWindow
name|void
name|QBBScreen
operator|::
name|removeWindow
parameter_list|(
name|QBBWindow
modifier|*
name|window
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
operator|<<
literal|"window ="
operator|<<
name|window
expr_stmt|;
endif|#
directive|endif
name|ms_childWindows
operator|.
name|removeAll
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|QBBScreen
operator|::
name|updateHierarchy
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|raiseWindow
name|void
name|QBBScreen
operator|::
name|raiseWindow
parameter_list|(
name|QBBWindow
modifier|*
name|window
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
operator|<<
literal|"window ="
operator|<<
name|window
expr_stmt|;
endif|#
directive|endif
name|removeWindow
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|ms_childWindows
operator|.
name|push_back
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|QBBScreen
operator|::
name|updateHierarchy
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|lowerWindow
name|void
name|QBBScreen
operator|::
name|lowerWindow
parameter_list|(
name|QBBWindow
modifier|*
name|window
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
operator|<<
literal|"window ="
operator|<<
name|window
expr_stmt|;
endif|#
directive|endif
name|removeWindow
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|ms_childWindows
operator|.
name|push_front
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|QBBScreen
operator|::
name|updateHierarchy
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|updateHierarchy
name|void
name|QBBScreen
operator|::
name|updateHierarchy
parameter_list|()
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
expr_stmt|;
endif|#
directive|endif
name|QList
argument_list|<
name|QBBWindow
modifier|*
argument_list|>
operator|::
name|iterator
name|it
decl_stmt|;
name|int
name|topZorder
init|=
literal|1
decl_stmt|;
comment|// root window is z-order 0, all "top" level windows are "above" it
for|for
control|(
name|it
operator|=
name|ms_childWindows
operator|.
name|begin
argument_list|()
init|;
name|it
operator|!=
name|ms_childWindows
operator|.
name|end
argument_list|()
condition|;
name|it
operator|++
control|)
operator|(
operator|*
name|it
operator|)
operator|->
name|updateZorder
argument_list|(
name|topZorder
argument_list|)
expr_stmt|;
comment|// After a hierarchy update, we need to force a flush on all screens.
comment|// Right now, all screens share a context.
name|screen_flush_context
argument_list|(
name|primaryDisplay
argument_list|()
operator|->
name|m_screenContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|onWindowPost
name|void
name|QBBScreen
operator|::
name|onWindowPost
parameter_list|(
name|QBBWindow
modifier|*
name|window
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|QBBSCREEN_DEBUG
argument_list|)
name|qDebug
argument_list|()
operator|<<
name|Q_FUNC_INFO
expr_stmt|;
endif|#
directive|endif
name|Q_UNUSED
argument_list|(
argument|window
argument_list|)
comment|// post app window (so navigator will show it) after first child window
comment|// has posted; this only needs to happen once as the app window's content
comment|// never changes
if|if
condition|(
operator|!
name|m_posted
operator|&&
name|m_rootWindow
condition|)
block|{
name|m_rootWindow
operator|->
name|post
argument_list|()
expr_stmt|;
name|m_posted
operator|=
literal|true
expr_stmt|;
block|}
block|}
end_function
begin_macro
name|QT_END_NAMESPACE
end_macro
end_unit
