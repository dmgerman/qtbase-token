begin_unit
begin_comment
comment|/*************************************************************************** ** ** Copyright (C) 2011 - 2012 Research In Motion ** Contact: http://www.qt-project.org/ ** ** This file is part of the plugins of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** GNU Lesser General Public License Usage ** This file may be used under the terms of the GNU Lesser General Public ** License version 2.1 as published by the Free Software Foundation and ** appearing in the file LICENSE.LGPL included in the packaging of this ** file. Please review the following information to ensure the GNU Lesser ** General Public License version 2.1 requirements will be met: ** http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Nokia gives you certain additional ** rights. These rights are described in the Nokia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU General ** Public License version 3.0 as published by the Free Software Foundation ** and appearing in the file LICENSE.GPL included in the packaging of this ** file. Please review the following information to ensure the GNU General ** Public License version 3.0 requirements will be met: ** http://www.gnu.org/copyleft/gpl.html. ** ** Other Usage ** Alternatively, this file may be used in accordance with the terms and ** conditions contained in a signed written agreement between you and Nokia. ** ** ** ** ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"qbbvirtualkeyboard.h"
end_include
begin_include
include|#
directive|include
file|"qbbscreen.h"
end_include
begin_include
include|#
directive|include
file|<QtGui/QPlatformScreen>
end_include
begin_include
include|#
directive|include
file|<QtGui/QPlatformWindow>
end_include
begin_include
include|#
directive|include
file|<QtCore/QDebug>
end_include
begin_include
include|#
directive|include
file|<errno.h>
end_include
begin_include
include|#
directive|include
file|<fcntl.h>
end_include
begin_include
include|#
directive|include
file|<stdlib.h>
end_include
begin_include
include|#
directive|include
file|<string.h>
end_include
begin_include
include|#
directive|include
file|<sys/iomsg.h>
end_include
begin_include
include|#
directive|include
file|<sys/pps.h>
end_include
begin_include
include|#
directive|include
file|<sys/stat.h>
end_include
begin_include
include|#
directive|include
file|<sys/types.h>
end_include
begin_include
include|#
directive|include
file|<unistd.h>
end_include
begin_decl_stmt
DECL|member|ms_PPSPath
specifier|const
name|char
modifier|*
name|QBBVirtualKeyboard
operator|::
name|ms_PPSPath
init|=
literal|"/pps/services/input/control?wait"
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|member|ms_bufferSize
specifier|const
name|size_t
name|QBBVirtualKeyboard
operator|::
name|ms_bufferSize
init|=
literal|2048
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|s_instance
specifier|static
name|QBBVirtualKeyboard
modifier|*
name|s_instance
init|=
literal|0
decl_stmt|;
end_decl_stmt
begin_comment
comment|// Huge hack for keyboard shadow (see QNX PR 88400). Should be removed ASAP.
end_comment
begin_define
DECL|macro|KEYBOARD_SHADOW_HEIGHT
define|#
directive|define
name|KEYBOARD_SHADOW_HEIGHT
value|8
end_define
begin_constructor
DECL|function|QBBVirtualKeyboard
name|QBBVirtualKeyboard
operator|::
name|QBBVirtualKeyboard
parameter_list|()
member_init_list|:
name|m_encoder
argument_list|(
name|NULL
argument_list|)
member_init_list|,
name|m_decoder
argument_list|(
name|NULL
argument_list|)
member_init_list|,
name|m_buffer
argument_list|(
name|NULL
argument_list|)
member_init_list|,
name|m_height
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|m_fd
argument_list|(
operator|-
literal|1
argument_list|)
member_init_list|,
name|m_keyboardMode
argument_list|(
name|Default
argument_list|)
member_init_list|,
name|m_visible
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|m_locale
argument_list|(
name|QLatin1String
argument_list|(
literal|"en_US"
argument_list|)
argument_list|)
block|{
name|connect
argument_list|()
expr_stmt|;
block|}
end_constructor
begin_destructor
DECL|function|~QBBVirtualKeyboard
name|QBBVirtualKeyboard
operator|::
name|~
name|QBBVirtualKeyboard
parameter_list|()
block|{
name|close
argument_list|()
expr_stmt|;
block|}
end_destructor
begin_comment
comment|/* static */
end_comment
begin_function
DECL|function|instance
name|QBBVirtualKeyboard
modifier|&
name|QBBVirtualKeyboard
operator|::
name|instance
parameter_list|()
block|{
if|if
condition|(
operator|!
name|s_instance
condition|)
block|{
name|s_instance
operator|=
operator|new
name|QBBVirtualKeyboard
argument_list|()
expr_stmt|;
name|s_instance
operator|->
name|start
argument_list|()
expr_stmt|;
block|}
return|return
operator|*
name|s_instance
return|;
block|}
end_function
begin_comment
comment|/* static */
end_comment
begin_function
DECL|function|destroy
name|void
name|QBBVirtualKeyboard
operator|::
name|destroy
parameter_list|()
block|{
if|if
condition|(
name|s_instance
condition|)
block|{
operator|delete
name|s_instance
expr_stmt|;
name|s_instance
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|close
name|void
name|QBBVirtualKeyboard
operator|::
name|close
parameter_list|()
block|{
if|if
condition|(
name|m_fd
condition|)
block|{
comment|// any reads will fail after we close the fd, which is basically what we want.
operator|::
name|close
argument_list|(
name|m_fd
argument_list|)
expr_stmt|;
block|}
comment|// Wait for the thread to die (should be immediate), then continue the cleanup.
name|wait
argument_list|()
expr_stmt|;
if|if
condition|(
name|m_fd
condition|)
block|{
name|m_fd
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|m_decoder
condition|)
block|{
name|pps_decoder_cleanup
argument_list|(
name|m_decoder
argument_list|)
expr_stmt|;
operator|delete
name|m_decoder
expr_stmt|;
name|m_decoder
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|m_encoder
condition|)
block|{
name|pps_encoder_cleanup
argument_list|(
name|m_encoder
argument_list|)
expr_stmt|;
operator|delete
name|m_encoder
expr_stmt|;
name|m_encoder
operator|=
name|NULL
expr_stmt|;
block|}
operator|delete
index|[]
name|m_buffer
expr_stmt|;
name|m_buffer
operator|=
name|NULL
expr_stmt|;
block|}
end_function
begin_function
DECL|function|connect
name|bool
name|QBBVirtualKeyboard
operator|::
name|connect
parameter_list|()
block|{
name|close
argument_list|()
expr_stmt|;
name|m_encoder
operator|=
operator|new
name|pps_encoder_t
expr_stmt|;
name|m_decoder
operator|=
operator|new
name|pps_decoder_t
expr_stmt|;
name|pps_encoder_initialize
argument_list|(
name|m_encoder
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|pps_decoder_initialize
argument_list|(
name|m_decoder
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|m_fd
operator|=
operator|::
name|open
argument_list|(
name|ms_PPSPath
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_fd
operator|==
operator|-
literal|1
condition|)
block|{
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Unable to open \"%s\" for keyboard: %s (%d)."
argument_list|,
name|ms_PPSPath
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|close
argument_list|()
expr_stmt|;
return|return
literal|false
return|;
block|}
name|m_buffer
operator|=
operator|new
name|char
index|[
name|ms_bufferSize
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|m_buffer
condition|)
block|{
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Unable to allocate buffer of %d bytes. Size is unavailable."
argument_list|,
name|ms_bufferSize
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
if|if
condition|(
operator|!
name|queryPPSInfo
argument_list|()
condition|)
return|return
literal|false
return|;
name|start
argument_list|()
expr_stmt|;
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|queryPPSInfo
name|bool
name|QBBVirtualKeyboard
operator|::
name|queryPPSInfo
parameter_list|()
block|{
comment|// Request info, requires id to regenerate res message.
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"msg"
argument_list|,
literal|"info"
argument_list|)
expr_stmt|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"id"
argument_list|,
literal|"libWebView"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|::
name|write
argument_list|(
name|m_fd
argument_list|,
name|pps_encoder_buffer
argument_list|(
name|m_encoder
argument_list|)
argument_list|,
name|pps_encoder_length
argument_list|(
name|m_encoder
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|()
expr_stmt|;
return|return
literal|false
return|;
block|}
name|pps_encoder_reset
argument_list|(
name|m_encoder
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|notifyClientActiveStateChange
name|void
name|QBBVirtualKeyboard
operator|::
name|notifyClientActiveStateChange
parameter_list|(
name|bool
name|active
parameter_list|)
block|{
if|if
condition|(
operator|!
name|active
condition|)
name|hideKeyboard
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|run
name|void
name|QBBVirtualKeyboard
operator|::
name|run
parameter_list|()
block|{
name|ppsDataReady
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ppsDataReady
name|void
name|QBBVirtualKeyboard
operator|::
name|ppsDataReady
parameter_list|()
block|{
while|while
condition|(
literal|1
condition|)
block|{
name|ssize_t
name|nread
init|=
name|read
argument_list|(
name|m_fd
argument_list|,
name|m_buffer
argument_list|,
name|ms_bufferSize
operator|-
literal|1
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|QBBVIRTUALKEYBOARD_DEBUG
name|qDebug
argument_list|()
operator|<<
literal|"QBB: keyboardMessage size: "
operator|<<
name|nread
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|nread
operator|<
literal|0
condition|)
break|break;
comment|// nread is the real space necessary, not the amount read.
if|if
condition|(
cast|static_cast
argument_list|<
name|size_t
argument_list|>
argument_list|(
name|nread
argument_list|)
operator|>
name|ms_bufferSize
operator|-
literal|1
condition|)
block|{
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Keyboard buffer size too short; need %u."
argument_list|,
name|nread
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|m_buffer
index|[
name|nread
index|]
operator|=
literal|0
expr_stmt|;
name|pps_decoder_parse_pps_str
argument_list|(
name|m_decoder
argument_list|,
name|m_buffer
argument_list|)
expr_stmt|;
name|pps_decoder_push
argument_list|(
name|m_decoder
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|QBBVIRTUALKEYBOARD_DEBUG
name|pps_decoder_dump_tree
argument_list|(
name|m_decoder
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
specifier|const
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|pps_decoder_get_string
argument_list|(
name|m_decoder
argument_list|,
literal|"error"
argument_list|,
operator|&
name|value
argument_list|)
operator|==
name|PPS_DECODER_OK
condition|)
block|{
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Keyboard PPS decoder error: %s"
argument_list|,
name|value
condition|?
name|value
else|:
literal|"[null]"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|pps_decoder_get_string
argument_list|(
name|m_decoder
argument_list|,
literal|"msg"
argument_list|,
operator|&
name|value
argument_list|)
operator|==
name|PPS_DECODER_OK
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"show"
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|bool
name|oldVisible
init|=
name|m_visible
decl_stmt|;
name|m_visible
operator|=
literal|true
expr_stmt|;
name|handleKeyboardStateChangeMessage
argument_list|(
literal|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldVisible
operator|!=
name|m_visible
condition|)
emit|emit
name|visibilityChanged
argument_list|(
name|m_visible
argument_list|)
emit|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"hide"
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|bool
name|oldVisible
init|=
name|m_visible
decl_stmt|;
name|m_visible
operator|=
literal|false
expr_stmt|;
name|handleKeyboardStateChangeMessage
argument_list|(
literal|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldVisible
operator|!=
name|m_visible
condition|)
emit|emit
name|visibilityChanged
argument_list|(
name|m_visible
argument_list|)
emit|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"info"
argument_list|)
operator|==
literal|0
condition|)
name|handleKeyboardInfoMessage
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"connect"
argument_list|)
operator|==
literal|0
condition|)
block|{ }
else|else
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Unexpected keyboard PPS msg value: %s"
argument_list|,
name|value
condition|?
name|value
else|:
literal|"[null]"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pps_decoder_get_string
argument_list|(
name|m_decoder
argument_list|,
literal|"res"
argument_list|,
operator|&
name|value
argument_list|)
operator|==
name|PPS_DECODER_OK
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"info"
argument_list|)
operator|==
literal|0
condition|)
name|handleKeyboardInfoMessage
argument_list|()
expr_stmt|;
else|else
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Unexpected keyboard PPS res value: %s"
argument_list|,
name|value
condition|?
name|value
else|:
literal|"[null]"
argument_list|)
expr_stmt|;
block|}
else|else
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Unexpected keyboard PPS message type"
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|QBBVIRTUALKEYBOARD_DEBUG
name|qDebug
argument_list|()
operator|<<
literal|"QBB: exiting keyboard thread"
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|m_decoder
condition|)
name|pps_decoder_cleanup
argument_list|(
name|m_decoder
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|handleKeyboardInfoMessage
name|void
name|QBBVirtualKeyboard
operator|::
name|handleKeyboardInfoMessage
parameter_list|()
block|{
name|int
name|newHeight
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|pps_decoder_push
argument_list|(
name|m_decoder
argument_list|,
literal|"dat"
argument_list|)
operator|!=
name|PPS_DECODER_OK
condition|)
block|{
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Keyboard PPS dat object not found"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pps_decoder_get_int
argument_list|(
name|m_decoder
argument_list|,
literal|"size"
argument_list|,
operator|&
name|newHeight
argument_list|)
operator|!=
name|PPS_DECODER_OK
condition|)
block|{
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Keyboard PPS size field not found"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pps_decoder_push
argument_list|(
name|m_decoder
argument_list|,
literal|"locale"
argument_list|)
operator|!=
name|PPS_DECODER_OK
condition|)
block|{
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Keyboard PPS locale object not found"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pps_decoder_get_string
argument_list|(
name|m_decoder
argument_list|,
literal|"languageId"
argument_list|,
operator|&
name|value
argument_list|)
operator|!=
name|PPS_DECODER_OK
condition|)
block|{
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Keyboard PPS languageId field not found"
argument_list|)
expr_stmt|;
return|return;
block|}
specifier|const
name|QString
name|languageId
init|=
name|QString
operator|::
name|fromLatin1
argument_list|(
name|value
argument_list|)
decl_stmt|;
if|if
condition|(
name|pps_decoder_get_string
argument_list|(
name|m_decoder
argument_list|,
literal|"countryId"
argument_list|,
operator|&
name|value
argument_list|)
operator|!=
name|PPS_DECODER_OK
condition|)
block|{
name|qCritical
argument_list|(
literal|"QBBVirtualKeyboard: Keyboard PPS size countryId not found"
argument_list|)
expr_stmt|;
return|return;
block|}
specifier|const
name|QString
name|countryId
init|=
name|QString
operator|::
name|fromLatin1
argument_list|(
name|value
argument_list|)
decl_stmt|;
comment|// HUGE hack, should be removed ASAP.
name|newHeight
operator|-=
name|KEYBOARD_SHADOW_HEIGHT
expr_stmt|;
comment|// We want to ignore the 8 pixel shadow above the keyboard. (PR 88400)
if|if
condition|(
name|newHeight
operator|!=
name|m_height
condition|)
block|{
name|m_height
operator|=
name|newHeight
expr_stmt|;
name|updateAvailableScreenGeometry
argument_list|()
expr_stmt|;
block|}
specifier|const
name|QLocale
name|locale
init|=
name|QLocale
argument_list|(
name|languageId
operator|+
name|QLatin1Char
argument_list|(
literal|'_'
argument_list|)
operator|+
name|countryId
argument_list|)
decl_stmt|;
if|if
condition|(
name|locale
operator|!=
name|m_locale
condition|)
block|{
name|m_locale
operator|=
name|locale
expr_stmt|;
emit|emit
name|localeChanged
argument_list|(
name|locale
argument_list|)
emit|;
block|}
ifdef|#
directive|ifdef
name|QBBVIRTUALKEYBOARD_DEBUG
name|qDebug
argument_list|()
operator|<<
literal|"QBB: handleKeyboardInfoMessage size="
operator|<<
name|m_height
operator|<<
literal|"locale="
operator|<<
name|m_locale
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|handleKeyboardStateChangeMessage
name|void
name|QBBVirtualKeyboard
operator|::
name|handleKeyboardStateChangeMessage
parameter_list|(
name|bool
name|visible
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|QBBVIRTUALKEYBOARD_DEBUG
name|qDebug
argument_list|()
operator|<<
literal|"QBB: handleKeyboardStateChangeMessage "
operator|<<
name|visible
expr_stmt|;
endif|#
directive|endif
name|updateAvailableScreenGeometry
argument_list|()
expr_stmt|;
if|if
condition|(
name|visible
condition|)
name|showKeyboard
argument_list|()
expr_stmt|;
else|else
name|hideKeyboard
argument_list|()
expr_stmt|;
block|}
end_function
begin_function
DECL|function|updateAvailableScreenGeometry
name|void
name|QBBVirtualKeyboard
operator|::
name|updateAvailableScreenGeometry
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|QBBVIRTUALKEYBOARD_DEBUG
name|qDebug
argument_list|()
operator|<<
literal|"QBB: updateAvailableScreenGeometry: keyboard visible="
operator|<<
name|m_visible
operator|<<
literal|", keyboard height="
operator|<<
name|m_height
expr_stmt|;
endif|#
directive|endif
comment|// TODO: What screen index should be used? I assume primaryScreen here because it works, and
comment|//       we do it for handleScreenGeometryChange elsewhere but since we have support
comment|//       for more than one screen, that's not going to always work.
name|QBBScreen
modifier|*
name|platformScreen
init|=
name|QBBScreen
operator|::
name|primaryDisplay
argument_list|()
decl_stmt|;
name|QWindowSystemInterface
operator|::
name|handleScreenAvailableGeometryChange
argument_list|(
name|platformScreen
operator|->
name|screen
argument_list|()
argument_list|,
name|platformScreen
operator|->
name|availableGeometry
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|showKeyboard
name|bool
name|QBBVirtualKeyboard
operator|::
name|showKeyboard
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|QBBVIRTUALKEYBOARD_DEBUG
name|qDebug
argument_list|()
operator|<<
literal|"QBB: showKeyboard()"
expr_stmt|;
endif|#
directive|endif
comment|// Try to connect.
if|if
condition|(
name|m_fd
operator|==
operator|-
literal|1
operator|&&
operator|!
name|connect
argument_list|()
condition|)
return|return
literal|false
return|;
comment|// NOTE:  This must be done everytime the keyboard is shown even if there is no change because
comment|// hiding the keyboard wipes the setting.
name|applyKeyboardModeOptions
argument_list|()
expr_stmt|;
name|pps_encoder_reset
argument_list|(
name|m_encoder
argument_list|)
expr_stmt|;
comment|// Send the show message.
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"msg"
argument_list|,
literal|"show"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|::
name|write
argument_list|(
name|m_fd
argument_list|,
name|pps_encoder_buffer
argument_list|(
name|m_encoder
argument_list|)
argument_list|,
name|pps_encoder_length
argument_list|(
name|m_encoder
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|()
expr_stmt|;
return|return
literal|false
return|;
block|}
name|pps_encoder_reset
argument_list|(
name|m_encoder
argument_list|)
expr_stmt|;
comment|// Return true if no error occurs.  Sizing response will be triggered when confirmation of
comment|// the change arrives.
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|hideKeyboard
name|bool
name|QBBVirtualKeyboard
operator|::
name|hideKeyboard
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|QBBVIRTUALKEYBOARD_DEBUG
name|qDebug
argument_list|()
operator|<<
literal|"QBB: hideKeyboard()"
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|m_fd
operator|==
operator|-
literal|1
operator|&&
operator|!
name|connect
argument_list|()
condition|)
return|return
literal|false
return|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"msg"
argument_list|,
literal|"hide"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|::
name|write
argument_list|(
name|m_fd
argument_list|,
name|pps_encoder_buffer
argument_list|(
name|m_encoder
argument_list|)
argument_list|,
name|pps_encoder_length
argument_list|(
name|m_encoder
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|()
expr_stmt|;
comment|//Try again.
if|if
condition|(
name|connect
argument_list|()
condition|)
block|{
if|if
condition|(
operator|::
name|write
argument_list|(
name|m_fd
argument_list|,
name|pps_encoder_buffer
argument_list|(
name|m_encoder
argument_list|)
argument_list|,
name|pps_encoder_length
argument_list|(
name|m_encoder
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|()
expr_stmt|;
return|return
literal|false
return|;
block|}
block|}
else|else
return|return
literal|false
return|;
block|}
name|pps_encoder_reset
argument_list|(
name|m_encoder
argument_list|)
expr_stmt|;
comment|// Return true if no error occurs.  Sizing response will be triggered when confirmation of
comment|// the change arrives.
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|setKeyboardMode
name|void
name|QBBVirtualKeyboard
operator|::
name|setKeyboardMode
parameter_list|(
name|KeyboardMode
name|mode
parameter_list|)
block|{
name|m_keyboardMode
operator|=
name|mode
expr_stmt|;
block|}
end_function
begin_function
DECL|function|applyKeyboardModeOptions
name|void
name|QBBVirtualKeyboard
operator|::
name|applyKeyboardModeOptions
parameter_list|()
block|{
comment|// Try to connect.
if|if
condition|(
name|m_fd
operator|==
operator|-
literal|1
operator|&&
operator|!
name|connect
argument_list|()
condition|)
return|return;
comment|// Send the options message.
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"msg"
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
name|pps_encoder_start_object
argument_list|(
name|m_encoder
argument_list|,
literal|"dat"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|m_keyboardMode
condition|)
block|{
case|case
name|Url
case|:
name|addUrlModeOptions
argument_list|()
expr_stmt|;
break|break;
case|case
name|Email
case|:
name|addEmailModeOptions
argument_list|()
expr_stmt|;
break|break;
case|case
name|Web
case|:
name|addWebModeOptions
argument_list|()
expr_stmt|;
break|break;
case|case
name|NumPunc
case|:
name|addNumPuncModeOptions
argument_list|()
expr_stmt|;
break|break;
case|case
name|Symbol
case|:
name|addSymbolModeOptions
argument_list|()
expr_stmt|;
break|break;
case|case
name|Phone
case|:
name|addPhoneModeOptions
argument_list|()
expr_stmt|;
break|break;
case|case
name|Pin
case|:
name|addPinModeOptions
argument_list|()
expr_stmt|;
break|break;
case|case
name|Default
case|:
default|default:
name|addDefaultModeOptions
argument_list|()
expr_stmt|;
break|break;
block|}
name|pps_encoder_end_object
argument_list|(
name|m_encoder
argument_list|)
expr_stmt|;
if|if
condition|(
operator|::
name|write
argument_list|(
name|m_fd
argument_list|,
name|pps_encoder_buffer
argument_list|(
name|m_encoder
argument_list|)
argument_list|,
name|pps_encoder_length
argument_list|(
name|m_encoder
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|()
expr_stmt|;
block|}
name|pps_encoder_reset
argument_list|(
name|m_encoder
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|addDefaultModeOptions
name|void
name|QBBVirtualKeyboard
operator|::
name|addDefaultModeOptions
parameter_list|()
block|{
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"enter"
argument_list|,
literal|"enter.default"
argument_list|)
expr_stmt|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"type"
argument_list|,
literal|"default"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|addUrlModeOptions
name|void
name|QBBVirtualKeyboard
operator|::
name|addUrlModeOptions
parameter_list|()
block|{
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"enter"
argument_list|,
literal|"enter.default"
argument_list|)
expr_stmt|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"type"
argument_list|,
literal|"url"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|addEmailModeOptions
name|void
name|QBBVirtualKeyboard
operator|::
name|addEmailModeOptions
parameter_list|()
block|{
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"enter"
argument_list|,
literal|"enter.default"
argument_list|)
expr_stmt|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"type"
argument_list|,
literal|"email"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|addWebModeOptions
name|void
name|QBBVirtualKeyboard
operator|::
name|addWebModeOptions
parameter_list|()
block|{
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"enter"
argument_list|,
literal|"enter.default"
argument_list|)
expr_stmt|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"type"
argument_list|,
literal|"web"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|addNumPuncModeOptions
name|void
name|QBBVirtualKeyboard
operator|::
name|addNumPuncModeOptions
parameter_list|()
block|{
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"enter"
argument_list|,
literal|"enter.default"
argument_list|)
expr_stmt|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"type"
argument_list|,
literal|"numPunc"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|addPhoneModeOptions
name|void
name|QBBVirtualKeyboard
operator|::
name|addPhoneModeOptions
parameter_list|()
block|{
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"enter"
argument_list|,
literal|"enter.default"
argument_list|)
expr_stmt|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"type"
argument_list|,
literal|"phone"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|addPinModeOptions
name|void
name|QBBVirtualKeyboard
operator|::
name|addPinModeOptions
parameter_list|()
block|{
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"enter"
argument_list|,
literal|"enter.default"
argument_list|)
expr_stmt|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"type"
argument_list|,
literal|"pin"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|addSymbolModeOptions
name|void
name|QBBVirtualKeyboard
operator|::
name|addSymbolModeOptions
parameter_list|()
block|{
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"enter"
argument_list|,
literal|"enter.default"
argument_list|)
expr_stmt|;
name|pps_encoder_add_string
argument_list|(
name|m_encoder
argument_list|,
literal|"type"
argument_list|,
literal|"symbol"
argument_list|)
expr_stmt|;
block|}
end_function
end_unit
