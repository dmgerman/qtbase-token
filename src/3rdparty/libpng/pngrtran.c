begin_unit
begin_comment
comment|/* pngrtran.c - transforms the data in a row for PNG readers  *  * Last changed in libpng 1.5.1 [February 3, 2011]  * Copyright (c) 1998-2011 Glenn Randers-Pehrson  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)  *  * This code is released under the libpng license.  * For conditions of distribution and use, see the disclaimer  * and license in png.h  *  * This file contains functions optionally called by an application  * in order to tell libpng how to handle data when reading a PNG.  * Transformations that are used in both reading and writing are  * in pngtrans.c.  */
end_comment
begin_include
include|#
directive|include
file|"pngpriv.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_SUPPORTED
end_ifdef
begin_comment
comment|/* Set the action on getting a CRC error for an ancillary or critical chunk. */
end_comment
begin_function
name|void
name|PNGAPI
DECL|function|png_set_crc_action
name|png_set_crc_action
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|int
name|crit_action
parameter_list|,
name|int
name|ancil_action
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_crc_action"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
comment|/* Tell libpng how we react to CRC errors in critical chunks */
switch|switch
condition|(
name|crit_action
condition|)
block|{
case|case
name|PNG_CRC_NO_CHANGE
case|:
comment|/* Leave setting as is */
break|break;
case|case
name|PNG_CRC_WARN_USE
case|:
comment|/* Warn/use data */
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_CRC_CRITICAL_MASK
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator||=
name|PNG_FLAG_CRC_CRITICAL_USE
expr_stmt|;
break|break;
case|case
name|PNG_CRC_QUIET_USE
case|:
comment|/* Quiet/use data */
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_CRC_CRITICAL_MASK
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator||=
name|PNG_FLAG_CRC_CRITICAL_USE
operator||
name|PNG_FLAG_CRC_CRITICAL_IGNORE
expr_stmt|;
break|break;
case|case
name|PNG_CRC_WARN_DISCARD
case|:
comment|/* Not a valid action for critical data */
name|png_warning
argument_list|(
name|png_ptr
argument_list|,
literal|"Can't discard critical data on CRC error"
argument_list|)
expr_stmt|;
case|case
name|PNG_CRC_ERROR_QUIT
case|:
comment|/* Error/quit */
case|case
name|PNG_CRC_DEFAULT
case|:
default|default:
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_CRC_CRITICAL_MASK
expr_stmt|;
break|break;
block|}
comment|/* Tell libpng how we react to CRC errors in ancillary chunks */
switch|switch
condition|(
name|ancil_action
condition|)
block|{
case|case
name|PNG_CRC_NO_CHANGE
case|:
comment|/* Leave setting as is */
break|break;
case|case
name|PNG_CRC_WARN_USE
case|:
comment|/* Warn/use data */
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_CRC_ANCILLARY_MASK
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator||=
name|PNG_FLAG_CRC_ANCILLARY_USE
expr_stmt|;
break|break;
case|case
name|PNG_CRC_QUIET_USE
case|:
comment|/* Quiet/use data */
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_CRC_ANCILLARY_MASK
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator||=
name|PNG_FLAG_CRC_ANCILLARY_USE
operator||
name|PNG_FLAG_CRC_ANCILLARY_NOWARN
expr_stmt|;
break|break;
case|case
name|PNG_CRC_ERROR_QUIT
case|:
comment|/* Error/quit */
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_CRC_ANCILLARY_MASK
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator||=
name|PNG_FLAG_CRC_ANCILLARY_NOWARN
expr_stmt|;
break|break;
case|case
name|PNG_CRC_WARN_DISCARD
case|:
comment|/* Warn/discard data */
case|case
name|PNG_CRC_DEFAULT
case|:
default|default:
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_CRC_ANCILLARY_MASK
expr_stmt|;
break|break;
block|}
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_BACKGROUND_SUPPORTED
end_ifdef
begin_comment
comment|/* Handle alpha and tRNS via a background color */
end_comment
begin_function
name|void
name|PNGFAPI
DECL|function|png_set_background_fixed
name|png_set_background_fixed
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_const_color_16p
name|background_color
parameter_list|,
name|int
name|background_gamma_code
parameter_list|,
name|int
name|need_expand
parameter_list|,
name|png_fixed_point
name|background_gamma
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_background_fixed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|background_gamma_code
operator|==
name|PNG_BACKGROUND_GAMMA_UNKNOWN
condition|)
block|{
name|png_warning
argument_list|(
name|png_ptr
argument_list|,
literal|"Application must supply a known background gamma"
argument_list|)
expr_stmt|;
return|return;
block|}
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_BACKGROUND
expr_stmt|;
name|png_memcpy
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|background
operator|)
argument_list|,
name|background_color
argument_list|,
name|png_sizeof
argument_list|(
name|png_color_16
argument_list|)
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|background_gamma
operator|=
name|background_gamma
expr_stmt|;
name|png_ptr
operator|->
name|background_gamma_type
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background_gamma_code
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|transformations
operator||=
operator|(
name|need_expand
condition|?
name|PNG_BACKGROUND_EXPAND
else|:
literal|0
operator|)
expr_stmt|;
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_FLOATING_POINT_SUPPORTED
end_ifdef
begin_function
name|void
name|PNGAPI
DECL|function|png_set_background
name|png_set_background
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_const_color_16p
name|background_color
parameter_list|,
name|int
name|background_gamma_code
parameter_list|,
name|int
name|need_expand
parameter_list|,
name|double
name|background_gamma
parameter_list|)
block|{
name|png_set_background_fixed
argument_list|(
name|png_ptr
argument_list|,
name|background_color
argument_list|,
name|background_gamma_code
argument_list|,
name|need_expand
argument_list|,
name|png_fixed
argument_list|(
name|png_ptr
argument_list|,
name|background_gamma
argument_list|,
literal|"png_set_background"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* FLOATING_POINT */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* READ_BACKGROUND */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_16_TO_8_SUPPORTED
end_ifdef
begin_comment
comment|/* Strip 16 bit depth files to 8 bit depth */
end_comment
begin_function
name|void
name|PNGAPI
DECL|function|png_set_strip_16
name|png_set_strip_16
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_strip_16"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_16_TO_8
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_STRIP_ALPHA_SUPPORTED
end_ifdef
begin_function
name|void
name|PNGAPI
DECL|function|png_set_strip_alpha
name|png_set_strip_alpha
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_strip_alpha"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|png_ptr
operator|->
name|flags
operator||=
name|PNG_FLAG_STRIP_ALPHA
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_QUANTIZE_SUPPORTED
end_ifdef
begin_comment
comment|/* Dither file to 8 bit.  Supply a palette, the current number  * of elements in the palette, the maximum number of elements  * allowed, and a histogram if possible.  If the current number  * of colors is greater then the maximum number, the palette will be  * modified to fit in the maximum number.  "full_quantize" indicates  * whether we need a quantizing cube set up for RGB images, or if we  * simply are reducing the number of colors in a paletted image.  */
end_comment
begin_typedef
DECL|struct|png_dsort_struct
typedef|typedef
struct|struct
name|png_dsort_struct
block|{
DECL|member|next
name|struct
name|png_dsort_struct
name|FAR
modifier|*
name|next
decl_stmt|;
DECL|member|left
name|png_byte
name|left
decl_stmt|;
DECL|member|right
name|png_byte
name|right
decl_stmt|;
block|}
DECL|typedef|png_dsort
name|png_dsort
typedef|;
end_typedef
begin_typedef
DECL|typedef|png_dsortp
typedef|typedef
name|png_dsort
name|FAR
modifier|*
name|png_dsortp
typedef|;
end_typedef
begin_typedef
DECL|typedef|png_dsortpp
typedef|typedef
name|png_dsort
name|FAR
modifier|*
name|FAR
modifier|*
name|png_dsortpp
typedef|;
end_typedef
begin_function
name|void
name|PNGAPI
DECL|function|png_set_quantize
name|png_set_quantize
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_colorp
name|palette
parameter_list|,
name|int
name|num_palette
parameter_list|,
name|int
name|maximum_colors
parameter_list|,
name|png_const_uint_16p
name|histogram
parameter_list|,
name|int
name|full_quantize
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_quantize"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_QUANTIZE
expr_stmt|;
if|if
condition|(
operator|!
name|full_quantize
condition|)
block|{
name|int
name|i
decl_stmt|;
name|png_ptr
operator|->
name|quantize_index
operator|=
operator|(
name|png_bytep
operator|)
name|png_malloc
argument_list|(
name|png_ptr
argument_list|,
call|(
name|png_uint_32
call|)
argument_list|(
name|num_palette
operator|*
name|png_sizeof
argument_list|(
name|png_byte
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_palette
condition|;
name|i
operator|++
control|)
name|png_ptr
operator|->
name|quantize_index
index|[
name|i
index|]
operator|=
operator|(
name|png_byte
operator|)
name|i
expr_stmt|;
block|}
if|if
condition|(
name|num_palette
operator|>
name|maximum_colors
condition|)
block|{
if|if
condition|(
name|histogram
operator|!=
name|NULL
condition|)
block|{
comment|/* This is easy enough, just throw out the least used colors.           * Perhaps not the best solution, but good enough.           */
name|int
name|i
decl_stmt|;
comment|/* Initialize an array to sort colors */
name|png_ptr
operator|->
name|quantize_sort
operator|=
operator|(
name|png_bytep
operator|)
name|png_malloc
argument_list|(
name|png_ptr
argument_list|,
call|(
name|png_uint_32
call|)
argument_list|(
name|num_palette
operator|*
name|png_sizeof
argument_list|(
name|png_byte
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize the quantize_sort array */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_palette
condition|;
name|i
operator|++
control|)
name|png_ptr
operator|->
name|quantize_sort
index|[
name|i
index|]
operator|=
operator|(
name|png_byte
operator|)
name|i
expr_stmt|;
comment|/* Find the least used palette entries by starting a           * bubble sort, and running it until we have sorted           * out enough colors.  Note that we don't care about           * sorting all the colors, just finding which are           * least used.           */
for|for
control|(
name|i
operator|=
name|num_palette
operator|-
literal|1
init|;
name|i
operator|>=
name|maximum_colors
condition|;
name|i
operator|--
control|)
block|{
name|int
name|done
decl_stmt|;
comment|/* To stop early if the list is pre-sorted */
name|int
name|j
decl_stmt|;
name|done
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|histogram
index|[
name|png_ptr
operator|->
name|quantize_sort
index|[
name|j
index|]
index|]
operator|<
name|histogram
index|[
name|png_ptr
operator|->
name|quantize_sort
index|[
name|j
operator|+
literal|1
index|]
index|]
condition|)
block|{
name|png_byte
name|t
decl_stmt|;
name|t
operator|=
name|png_ptr
operator|->
name|quantize_sort
index|[
name|j
index|]
expr_stmt|;
name|png_ptr
operator|->
name|quantize_sort
index|[
name|j
index|]
operator|=
name|png_ptr
operator|->
name|quantize_sort
index|[
name|j
operator|+
literal|1
index|]
expr_stmt|;
name|png_ptr
operator|->
name|quantize_sort
index|[
name|j
operator|+
literal|1
index|]
operator|=
name|t
expr_stmt|;
name|done
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|done
condition|)
break|break;
block|}
comment|/* Swap the palette around, and set up a table, if necessary */
if|if
condition|(
name|full_quantize
condition|)
block|{
name|int
name|j
init|=
name|num_palette
decl_stmt|;
comment|/* Put all the useful colors within the max, but don't              * move the others.              */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maximum_colors
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|quantize_sort
index|[
name|i
index|]
operator|>=
name|maximum_colors
condition|)
block|{
do|do
name|j
operator|--
expr_stmt|;
do|while
condition|(
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|quantize_sort
index|[
name|j
index|]
operator|>=
name|maximum_colors
condition|)
do|;
name|palette
index|[
name|i
index|]
operator|=
name|palette
index|[
name|j
index|]
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|int
name|j
init|=
name|num_palette
decl_stmt|;
comment|/* Move all the used colors inside the max limit, and              * develop a translation table.              */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maximum_colors
condition|;
name|i
operator|++
control|)
block|{
comment|/* Only move the colors we need to */
if|if
condition|(
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|quantize_sort
index|[
name|i
index|]
operator|>=
name|maximum_colors
condition|)
block|{
name|png_color
name|tmp_color
decl_stmt|;
do|do
name|j
operator|--
expr_stmt|;
do|while
condition|(
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|quantize_sort
index|[
name|j
index|]
operator|>=
name|maximum_colors
condition|)
do|;
name|tmp_color
operator|=
name|palette
index|[
name|j
index|]
expr_stmt|;
name|palette
index|[
name|j
index|]
operator|=
name|palette
index|[
name|i
index|]
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|=
name|tmp_color
expr_stmt|;
comment|/* Indicate where the color went */
name|png_ptr
operator|->
name|quantize_index
index|[
name|j
index|]
operator|=
operator|(
name|png_byte
operator|)
name|i
expr_stmt|;
name|png_ptr
operator|->
name|quantize_index
index|[
name|i
index|]
operator|=
operator|(
name|png_byte
operator|)
name|j
expr_stmt|;
block|}
block|}
comment|/* Find closest color for those colors we are not using */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_palette
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|quantize_index
index|[
name|i
index|]
operator|>=
name|maximum_colors
condition|)
block|{
name|int
name|min_d
decl_stmt|,
name|k
decl_stmt|,
name|min_k
decl_stmt|,
name|d_index
decl_stmt|;
comment|/* Find the closest color to one we threw out */
name|d_index
operator|=
name|png_ptr
operator|->
name|quantize_index
index|[
name|i
index|]
expr_stmt|;
name|min_d
operator|=
name|PNG_COLOR_DIST
argument_list|(
name|palette
index|[
name|d_index
index|]
argument_list|,
name|palette
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|1
operator|,
name|min_k
operator|=
literal|0
init|;
name|k
operator|<
name|maximum_colors
condition|;
name|k
operator|++
control|)
block|{
name|int
name|d
decl_stmt|;
name|d
operator|=
name|PNG_COLOR_DIST
argument_list|(
name|palette
index|[
name|d_index
index|]
argument_list|,
name|palette
index|[
name|k
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|<
name|min_d
condition|)
block|{
name|min_d
operator|=
name|d
expr_stmt|;
name|min_k
operator|=
name|k
expr_stmt|;
block|}
block|}
comment|/* Point to closest color */
name|png_ptr
operator|->
name|quantize_index
index|[
name|i
index|]
operator|=
operator|(
name|png_byte
operator|)
name|min_k
expr_stmt|;
block|}
block|}
block|}
name|png_free
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|quantize_sort
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|quantize_sort
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* This is much harder to do simply (and quickly).  Perhaps           * we need to go through a median cut routine, but those           * don't always behave themselves with only a few colors           * as input.  So we will just find the closest two colors,           * and throw out one of them (chosen somewhat randomly).           * [We don't understand this at all, so if someone wants to           *  work on improving it, be our guest - AED, GRP]           */
name|int
name|i
decl_stmt|;
name|int
name|max_d
decl_stmt|;
name|int
name|num_new_palette
decl_stmt|;
name|png_dsortp
name|t
decl_stmt|;
name|png_dsortpp
name|hash
decl_stmt|;
name|t
operator|=
name|NULL
expr_stmt|;
comment|/* Initialize palette index arrays */
name|png_ptr
operator|->
name|index_to_palette
operator|=
operator|(
name|png_bytep
operator|)
name|png_malloc
argument_list|(
name|png_ptr
argument_list|,
call|(
name|png_uint_32
call|)
argument_list|(
name|num_palette
operator|*
name|png_sizeof
argument_list|(
name|png_byte
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|palette_to_index
operator|=
operator|(
name|png_bytep
operator|)
name|png_malloc
argument_list|(
name|png_ptr
argument_list|,
call|(
name|png_uint_32
call|)
argument_list|(
name|num_palette
operator|*
name|png_sizeof
argument_list|(
name|png_byte
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize the sort array */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_palette
condition|;
name|i
operator|++
control|)
block|{
name|png_ptr
operator|->
name|index_to_palette
index|[
name|i
index|]
operator|=
operator|(
name|png_byte
operator|)
name|i
expr_stmt|;
name|png_ptr
operator|->
name|palette_to_index
index|[
name|i
index|]
operator|=
operator|(
name|png_byte
operator|)
name|i
expr_stmt|;
block|}
name|hash
operator|=
operator|(
name|png_dsortpp
operator|)
name|png_calloc
argument_list|(
name|png_ptr
argument_list|,
call|(
name|png_uint_32
call|)
argument_list|(
literal|769
operator|*
name|png_sizeof
argument_list|(
name|png_dsortp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|num_new_palette
operator|=
name|num_palette
expr_stmt|;
comment|/* Initial wild guess at how far apart the farthest pixel           * pair we will be eliminating will be.  Larger           * numbers mean more areas will be allocated, Smaller           * numbers run the risk of not saving enough data, and           * having to do this all over again.           *           * I have not done extensive checking on this number.           */
name|max_d
operator|=
literal|96
expr_stmt|;
while|while
condition|(
name|num_new_palette
operator|>
name|maximum_colors
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_new_palette
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
name|i
operator|+
literal|1
init|;
name|j
operator|<
name|num_new_palette
condition|;
name|j
operator|++
control|)
block|{
name|int
name|d
decl_stmt|;
name|d
operator|=
name|PNG_COLOR_DIST
argument_list|(
name|palette
index|[
name|i
index|]
argument_list|,
name|palette
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|<=
name|max_d
condition|)
block|{
name|t
operator|=
operator|(
name|png_dsortp
operator|)
name|png_malloc_warn
argument_list|(
name|png_ptr
argument_list|,
call|(
name|png_uint_32
call|)
argument_list|(
name|png_sizeof
argument_list|(
name|png_dsort
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
break|break;
name|t
operator|->
name|next
operator|=
name|hash
index|[
name|d
index|]
expr_stmt|;
name|t
operator|->
name|left
operator|=
operator|(
name|png_byte
operator|)
name|i
expr_stmt|;
name|t
operator|->
name|right
operator|=
operator|(
name|png_byte
operator|)
name|j
expr_stmt|;
name|hash
index|[
name|d
index|]
operator|=
name|t
expr_stmt|;
block|}
block|}
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
break|break;
block|}
if|if
condition|(
name|t
operator|!=
name|NULL
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|max_d
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|hash
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|png_dsortp
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|hash
index|[
name|i
index|]
init|;
name|p
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|index_to_palette
index|[
name|p
operator|->
name|left
index|]
operator|<
name|num_new_palette
operator|&&
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|index_to_palette
index|[
name|p
operator|->
name|right
index|]
operator|<
name|num_new_palette
condition|)
block|{
name|int
name|j
decl_stmt|,
name|next_j
decl_stmt|;
if|if
condition|(
name|num_new_palette
operator|&
literal|0x01
condition|)
block|{
name|j
operator|=
name|p
operator|->
name|left
expr_stmt|;
name|next_j
operator|=
name|p
operator|->
name|right
expr_stmt|;
block|}
else|else
block|{
name|j
operator|=
name|p
operator|->
name|right
expr_stmt|;
name|next_j
operator|=
name|p
operator|->
name|left
expr_stmt|;
block|}
name|num_new_palette
operator|--
expr_stmt|;
name|palette
index|[
name|png_ptr
operator|->
name|index_to_palette
index|[
name|j
index|]
index|]
operator|=
name|palette
index|[
name|num_new_palette
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|full_quantize
condition|)
block|{
name|int
name|k
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|num_palette
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
name|png_ptr
operator|->
name|quantize_index
index|[
name|k
index|]
operator|==
name|png_ptr
operator|->
name|index_to_palette
index|[
name|j
index|]
condition|)
name|png_ptr
operator|->
name|quantize_index
index|[
name|k
index|]
operator|=
name|png_ptr
operator|->
name|index_to_palette
index|[
name|next_j
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|quantize_index
index|[
name|k
index|]
operator|==
name|num_new_palette
condition|)
name|png_ptr
operator|->
name|quantize_index
index|[
name|k
index|]
operator|=
name|png_ptr
operator|->
name|index_to_palette
index|[
name|j
index|]
expr_stmt|;
block|}
block|}
name|png_ptr
operator|->
name|index_to_palette
index|[
name|png_ptr
operator|->
name|palette_to_index
index|[
name|num_new_palette
index|]
index|]
operator|=
name|png_ptr
operator|->
name|index_to_palette
index|[
name|j
index|]
expr_stmt|;
name|png_ptr
operator|->
name|palette_to_index
index|[
name|png_ptr
operator|->
name|index_to_palette
index|[
name|j
index|]
index|]
operator|=
name|png_ptr
operator|->
name|palette_to_index
index|[
name|num_new_palette
index|]
expr_stmt|;
name|png_ptr
operator|->
name|index_to_palette
index|[
name|j
index|]
operator|=
operator|(
name|png_byte
operator|)
name|num_new_palette
expr_stmt|;
name|png_ptr
operator|->
name|palette_to_index
index|[
name|num_new_palette
index|]
operator|=
operator|(
name|png_byte
operator|)
name|j
expr_stmt|;
block|}
if|if
condition|(
name|num_new_palette
operator|<=
name|maximum_colors
condition|)
break|break;
block|}
if|if
condition|(
name|num_new_palette
operator|<=
name|maximum_colors
condition|)
break|break;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|769
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|hash
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|png_dsortp
name|p
init|=
name|hash
index|[
name|i
index|]
decl_stmt|;
while|while
condition|(
name|p
condition|)
block|{
name|t
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|png_free
argument_list|(
name|png_ptr
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|t
expr_stmt|;
block|}
block|}
name|hash
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|max_d
operator|+=
literal|96
expr_stmt|;
block|}
name|png_free
argument_list|(
name|png_ptr
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|png_free
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|palette_to_index
argument_list|)
expr_stmt|;
name|png_free
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|index_to_palette
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|palette_to_index
operator|=
name|NULL
expr_stmt|;
name|png_ptr
operator|->
name|index_to_palette
operator|=
name|NULL
expr_stmt|;
block|}
name|num_palette
operator|=
name|maximum_colors
expr_stmt|;
block|}
if|if
condition|(
name|png_ptr
operator|->
name|palette
operator|==
name|NULL
condition|)
block|{
name|png_ptr
operator|->
name|palette
operator|=
name|palette
expr_stmt|;
block|}
name|png_ptr
operator|->
name|num_palette
operator|=
operator|(
name|png_uint_16
operator|)
name|num_palette
expr_stmt|;
if|if
condition|(
name|full_quantize
condition|)
block|{
name|int
name|i
decl_stmt|;
name|png_bytep
name|distance
decl_stmt|;
name|int
name|total_bits
init|=
name|PNG_QUANTIZE_RED_BITS
operator|+
name|PNG_QUANTIZE_GREEN_BITS
operator|+
name|PNG_QUANTIZE_BLUE_BITS
decl_stmt|;
name|int
name|num_red
init|=
operator|(
literal|1
operator|<<
name|PNG_QUANTIZE_RED_BITS
operator|)
decl_stmt|;
name|int
name|num_green
init|=
operator|(
literal|1
operator|<<
name|PNG_QUANTIZE_GREEN_BITS
operator|)
decl_stmt|;
name|int
name|num_blue
init|=
operator|(
literal|1
operator|<<
name|PNG_QUANTIZE_BLUE_BITS
operator|)
decl_stmt|;
name|png_size_t
name|num_entries
init|=
operator|(
operator|(
name|png_size_t
operator|)
literal|1
operator|<<
name|total_bits
operator|)
decl_stmt|;
name|png_ptr
operator|->
name|palette_lookup
operator|=
operator|(
name|png_bytep
operator|)
name|png_calloc
argument_list|(
name|png_ptr
argument_list|,
call|(
name|png_uint_32
call|)
argument_list|(
name|num_entries
operator|*
name|png_sizeof
argument_list|(
name|png_byte
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|distance
operator|=
operator|(
name|png_bytep
operator|)
name|png_malloc
argument_list|(
name|png_ptr
argument_list|,
call|(
name|png_uint_32
call|)
argument_list|(
name|num_entries
operator|*
name|png_sizeof
argument_list|(
name|png_byte
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|png_memset
argument_list|(
name|distance
argument_list|,
literal|0xff
argument_list|,
name|num_entries
operator|*
name|png_sizeof
argument_list|(
name|png_byte
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_palette
condition|;
name|i
operator|++
control|)
block|{
name|int
name|ir
decl_stmt|,
name|ig
decl_stmt|,
name|ib
decl_stmt|;
name|int
name|r
init|=
operator|(
name|palette
index|[
name|i
index|]
operator|.
name|red
operator|>>
operator|(
literal|8
operator|-
name|PNG_QUANTIZE_RED_BITS
operator|)
operator|)
decl_stmt|;
name|int
name|g
init|=
operator|(
name|palette
index|[
name|i
index|]
operator|.
name|green
operator|>>
operator|(
literal|8
operator|-
name|PNG_QUANTIZE_GREEN_BITS
operator|)
operator|)
decl_stmt|;
name|int
name|b
init|=
operator|(
name|palette
index|[
name|i
index|]
operator|.
name|blue
operator|>>
operator|(
literal|8
operator|-
name|PNG_QUANTIZE_BLUE_BITS
operator|)
operator|)
decl_stmt|;
for|for
control|(
name|ir
operator|=
literal|0
init|;
name|ir
operator|<
name|num_red
condition|;
name|ir
operator|++
control|)
block|{
comment|/* int dr = abs(ir - r); */
name|int
name|dr
init|=
operator|(
operator|(
name|ir
operator|>
name|r
operator|)
condition|?
name|ir
operator|-
name|r
else|:
name|r
operator|-
name|ir
operator|)
decl_stmt|;
name|int
name|index_r
init|=
operator|(
name|ir
operator|<<
operator|(
name|PNG_QUANTIZE_BLUE_BITS
operator|+
name|PNG_QUANTIZE_GREEN_BITS
operator|)
operator|)
decl_stmt|;
for|for
control|(
name|ig
operator|=
literal|0
init|;
name|ig
operator|<
name|num_green
condition|;
name|ig
operator|++
control|)
block|{
comment|/* int dg = abs(ig - g); */
name|int
name|dg
init|=
operator|(
operator|(
name|ig
operator|>
name|g
operator|)
condition|?
name|ig
operator|-
name|g
else|:
name|g
operator|-
name|ig
operator|)
decl_stmt|;
name|int
name|dt
init|=
name|dr
operator|+
name|dg
decl_stmt|;
name|int
name|dm
init|=
operator|(
operator|(
name|dr
operator|>
name|dg
operator|)
condition|?
name|dr
else|:
name|dg
operator|)
decl_stmt|;
name|int
name|index_g
init|=
name|index_r
operator||
operator|(
name|ig
operator|<<
name|PNG_QUANTIZE_BLUE_BITS
operator|)
decl_stmt|;
for|for
control|(
name|ib
operator|=
literal|0
init|;
name|ib
operator|<
name|num_blue
condition|;
name|ib
operator|++
control|)
block|{
name|int
name|d_index
init|=
name|index_g
operator||
name|ib
decl_stmt|;
comment|/* int db = abs(ib - b); */
name|int
name|db
init|=
operator|(
operator|(
name|ib
operator|>
name|b
operator|)
condition|?
name|ib
operator|-
name|b
else|:
name|b
operator|-
name|ib
operator|)
decl_stmt|;
name|int
name|dmax
init|=
operator|(
operator|(
name|dm
operator|>
name|db
operator|)
condition|?
name|dm
else|:
name|db
operator|)
decl_stmt|;
name|int
name|d
init|=
name|dmax
operator|+
name|dt
operator|+
name|db
decl_stmt|;
if|if
condition|(
name|d
operator|<
operator|(
name|int
operator|)
name|distance
index|[
name|d_index
index|]
condition|)
block|{
name|distance
index|[
name|d_index
index|]
operator|=
operator|(
name|png_byte
operator|)
name|d
expr_stmt|;
name|png_ptr
operator|->
name|palette_lookup
index|[
name|d_index
index|]
operator|=
operator|(
name|png_byte
operator|)
name|i
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
name|png_free
argument_list|(
name|png_ptr
argument_list|,
name|distance
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* PNG_READ_QUANTIZE_SUPPORTED */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
end_ifdef
begin_comment
comment|/* Transform the image from the file_gamma to the screen_gamma.  We  * only do transformations on images where the file_gamma and screen_gamma  * are not close reciprocals, otherwise it slows things down slightly, and  * also needlessly introduces small errors.  *  * We will turn off gamma transformation later if no semitransparent entries  * are present in the tRNS array for palette images.  We can't do it here  * because we don't necessarily have the tRNS chunk yet.  */
end_comment
begin_function
specifier|static
name|int
comment|/* PRIVATE */
DECL|function|png_gamma_threshold
name|png_gamma_threshold
parameter_list|(
name|png_fixed_point
name|scrn_gamma
parameter_list|,
name|png_fixed_point
name|file_gamma
parameter_list|)
block|{
comment|/* PNG_GAMMA_THRESHOLD is the threshold for performing gamma     * correction as a difference of the overall transform from 1.0     *     * We want to compare the threshold with s*f - 1, if we get     * overflow here it is because of wacky gamma values so we     * turn on processing anyway.     */
name|png_fixed_point
name|gtest
decl_stmt|;
return|return
operator|!
name|png_muldiv
argument_list|(
operator|&
name|gtest
argument_list|,
name|scrn_gamma
argument_list|,
name|file_gamma
argument_list|,
name|PNG_FP_1
argument_list|)
operator|||
name|png_gamma_significant
argument_list|(
name|gtest
argument_list|)
return|;
block|}
end_function
begin_function
name|void
name|PNGFAPI
DECL|function|png_set_gamma_fixed
name|png_set_gamma_fixed
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_fixed_point
name|scrn_gamma
parameter_list|,
name|png_fixed_point
name|file_gamma
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_gamma_fixed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_ALPHA
operator|)
operator|||
operator|(
name|png_ptr
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
operator|)
operator|||
name|png_gamma_threshold
argument_list|(
name|scrn_gamma
argument_list|,
name|file_gamma
argument_list|)
condition|)
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_GAMMA
expr_stmt|;
name|png_ptr
operator|->
name|gamma
operator|=
name|file_gamma
expr_stmt|;
name|png_ptr
operator|->
name|screen_gamma
operator|=
name|scrn_gamma
expr_stmt|;
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_FLOATING_POINT_SUPPORTED
end_ifdef
begin_function
name|void
name|PNGAPI
DECL|function|png_set_gamma
name|png_set_gamma
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|double
name|scrn_gamma
parameter_list|,
name|double
name|file_gamma
parameter_list|)
block|{
name|png_set_gamma_fixed
argument_list|(
name|png_ptr
argument_list|,
name|png_fixed
argument_list|(
name|png_ptr
argument_list|,
name|scrn_gamma
argument_list|,
literal|"png_set_gamma screen gamma"
argument_list|)
argument_list|,
name|png_fixed
argument_list|(
name|png_ptr
argument_list|,
name|file_gamma
argument_list|,
literal|"png_set_gamma file gamma"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* FLOATING_POINT_SUPPORTED */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* READ_GAMMA */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_EXPAND_SUPPORTED
end_ifdef
begin_comment
comment|/* Expand paletted images to RGB, expand grayscale images of  * less than 8-bit depth to 8-bit depth, and expand tRNS chunks  * to alpha channels.  */
end_comment
begin_function
name|void
name|PNGAPI
DECL|function|png_set_expand
name|png_set_expand
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_expand"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|png_ptr
operator|->
name|transformations
operator||=
operator|(
name|PNG_EXPAND
operator||
name|PNG_EXPAND_tRNS
operator|)
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_ROW_INIT
expr_stmt|;
block|}
end_function
begin_comment
comment|/* GRR 19990627:  the following three functions currently are identical  *  to png_set_expand().  However, it is entirely reasonable that someone  *  might wish to expand an indexed image to RGB but *not* expand a single,  *  fully transparent palette entry to a full alpha channel--perhaps instead  *  convert tRNS to the grayscale/RGB format (16-bit RGB value), or replace  *  the transparent color with a particular RGB value, or drop tRNS entirely.  *  IOW, a future version of the library may make the transformations flag  *  a bit more fine-grained, with separate bits for each of these three  *  functions.  *  *  More to the point, these functions make it obvious what libpng will be  *  doing, whereas "expand" can (and does) mean any number of things.  *  *  GRP 20060307: In libpng-1.2.9, png_set_gray_1_2_4_to_8() was modified  *  to expand only the sample depth but not to expand the tRNS to alpha  *  and its name was changed to png_set_expand_gray_1_2_4_to_8().  */
end_comment
begin_comment
comment|/* Expand paletted images to RGB. */
end_comment
begin_function
name|void
name|PNGAPI
DECL|function|png_set_palette_to_rgb
name|png_set_palette_to_rgb
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_palette_to_rgb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|png_ptr
operator|->
name|transformations
operator||=
operator|(
name|PNG_EXPAND
operator||
name|PNG_EXPAND_tRNS
operator|)
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_ROW_INIT
expr_stmt|;
block|}
end_function
begin_comment
comment|/* Expand grayscale images of less than 8-bit depth to 8 bits. */
end_comment
begin_function
name|void
name|PNGAPI
DECL|function|png_set_expand_gray_1_2_4_to_8
name|png_set_expand_gray_1_2_4_to_8
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_expand_gray_1_2_4_to_8"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_EXPAND
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_ROW_INIT
expr_stmt|;
block|}
end_function
begin_comment
comment|/* Expand tRNS chunks to alpha channels. */
end_comment
begin_function
name|void
name|PNGAPI
DECL|function|png_set_tRNS_to_alpha
name|png_set_tRNS_to_alpha
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_tRNS_to_alpha"
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|transformations
operator||=
operator|(
name|PNG_EXPAND
operator||
name|PNG_EXPAND_tRNS
operator|)
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_ROW_INIT
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* defined(PNG_READ_EXPAND_SUPPORTED) */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_GRAY_TO_RGB_SUPPORTED
end_ifdef
begin_function
name|void
name|PNGAPI
DECL|function|png_set_gray_to_rgb
name|png_set_gray_to_rgb
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_gray_to_rgb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|!=
name|NULL
condition|)
block|{
comment|/* Because rgb must be 8 bits or more: */
name|png_set_expand_gray_1_2_4_to_8
argument_list|(
name|png_ptr
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_GRAY_TO_RGB
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator|&=
operator|~
name|PNG_FLAG_ROW_INIT
expr_stmt|;
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_RGB_TO_GRAY_SUPPORTED
end_ifdef
begin_function
name|void
name|PNGFAPI
DECL|function|png_set_rgb_to_gray_fixed
name|png_set_rgb_to_gray_fixed
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|int
name|error_action
parameter_list|,
name|png_fixed_point
name|red
parameter_list|,
name|png_fixed_point
name|green
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_rgb_to_gray"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|error_action
condition|)
block|{
case|case
literal|1
case|:
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_RGB_TO_GRAY
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_RGB_TO_GRAY_WARN
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_RGB_TO_GRAY_ERR
expr_stmt|;
break|break;
default|default:
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"invalid error action to rgb_to_gray"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|png_ptr
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
condition|)
ifdef|#
directive|ifdef
name|PNG_READ_EXPAND_SUPPORTED
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_EXPAND
expr_stmt|;
else|#
directive|else
block|{
name|png_warning
argument_list|(
name|png_ptr
argument_list|,
literal|"Cannot do RGB_TO_GRAY without EXPAND_SUPPORTED"
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|transformations
operator|&=
operator|~
name|PNG_RGB_TO_GRAY
expr_stmt|;
block|}
endif|#
directive|endif
block|{
name|png_uint_16
name|red_int
decl_stmt|,
name|green_int
decl_stmt|;
if|if
condition|(
name|red
operator|<
literal|0
operator|||
name|green
operator|<
literal|0
condition|)
block|{
name|red_int
operator|=
literal|6968
expr_stmt|;
comment|/* .212671 * 32768 + .5 */
name|green_int
operator|=
literal|23434
expr_stmt|;
comment|/* .715160 * 32768 + .5 */
block|}
elseif|else
if|if
condition|(
name|red
operator|+
name|green
operator|<
literal|100000L
condition|)
block|{
name|red_int
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
name|png_uint_32
operator|)
name|red
operator|*
literal|32768L
operator|)
operator|/
literal|100000L
argument_list|)
expr_stmt|;
name|green_int
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
name|png_uint_32
operator|)
name|green
operator|*
literal|32768L
operator|)
operator|/
literal|100000L
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|png_warning
argument_list|(
name|png_ptr
argument_list|,
literal|"ignoring out of range rgb_to_gray coefficients"
argument_list|)
expr_stmt|;
name|red_int
operator|=
literal|6968
expr_stmt|;
name|green_int
operator|=
literal|23434
expr_stmt|;
block|}
name|png_ptr
operator|->
name|rgb_to_gray_red_coeff
operator|=
name|red_int
expr_stmt|;
name|png_ptr
operator|->
name|rgb_to_gray_green_coeff
operator|=
name|green_int
expr_stmt|;
name|png_ptr
operator|->
name|rgb_to_gray_blue_coeff
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
literal|32768
operator|-
name|red_int
operator|-
name|green_int
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_FLOATING_POINT_SUPPORTED
end_ifdef
begin_comment
comment|/* Convert a RGB image to a grayscale of the same width.  This allows us,  * for example, to convert a 24 bpp RGB image into an 8 bpp grayscale image.  */
end_comment
begin_function
name|void
name|PNGAPI
DECL|function|png_set_rgb_to_gray
name|png_set_rgb_to_gray
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|int
name|error_action
parameter_list|,
name|double
name|red
parameter_list|,
name|double
name|green
parameter_list|)
block|{
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|png_set_rgb_to_gray_fixed
argument_list|(
name|png_ptr
argument_list|,
name|error_action
argument_list|,
name|png_fixed
argument_list|(
name|png_ptr
argument_list|,
name|red
argument_list|,
literal|"rgb to gray red coefficient"
argument_list|)
argument_list|,
name|png_fixed
argument_list|(
name|png_ptr
argument_list|,
name|green
argument_list|,
literal|"rgb to gray green coefficient"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* FLOATING POINT */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_if
if|#
directive|if
name|defined
argument_list|(
name|PNG_READ_USER_TRANSFORM_SUPPORTED
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|PNG_WRITE_USER_TRANSFORM_SUPPORTED
argument_list|)
end_if
begin_function
name|void
name|PNGAPI
DECL|function|png_set_read_user_transform_fn
name|png_set_read_user_transform_fn
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_user_transform_ptr
name|read_user_transform_fn
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_set_read_user_transform_fn"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
ifdef|#
directive|ifdef
name|PNG_READ_USER_TRANSFORM_SUPPORTED
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_USER_TRANSFORM
expr_stmt|;
name|png_ptr
operator|->
name|read_user_transform_fn
operator|=
name|read_user_transform_fn
expr_stmt|;
endif|#
directive|endif
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* Initialize everything needed for the read.  This includes modifying  * the palette.  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_init_read_transformations
name|png_init_read_transformations
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_init_read_transformations"
argument_list|)
expr_stmt|;
block|{
if|#
directive|if
name|defined
argument_list|(
name|PNG_READ_BACKGROUND_SUPPORTED
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|PNG_READ_SHIFT_SUPPORTED
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|PNG_READ_GAMMA_SUPPORTED
argument_list|)
name|int
name|color_type
init|=
name|png_ptr
operator|->
name|color_type
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|PNG_READ_EXPAND_SUPPORTED
argument_list|)
operator|&&
name|defined
argument_list|(
name|PNG_READ_BACKGROUND_SUPPORTED
argument_list|)
ifdef|#
directive|ifdef
name|PNG_READ_GRAY_TO_RGB_SUPPORTED
comment|/* Detect gray background and attempt to enable optimization     * for gray --> RGB case     *     * Note:  if PNG_BACKGROUND_EXPAND is set and color_type is either RGB or     * RGB_ALPHA (in which case need_expand is superfluous anyway), the     * background color might actually be gray yet not be flagged as such.     * This is not a problem for the current code, which uses     * PNG_BACKGROUND_IS_GRAY only to decide when to do the     * png_do_gray_to_rgb() transformation.     */
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BACKGROUND_EXPAND
operator|)
operator|&&
operator|!
operator|(
name|color_type
operator|&
name|PNG_COLOR_MASK_COLOR
operator|)
condition|)
block|{
name|png_ptr
operator|->
name|mode
operator||=
name|PNG_BACKGROUND_IS_GRAY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BACKGROUND
operator|)
operator|&&
operator|!
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BACKGROUND_EXPAND
operator|)
operator|&&
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_GRAY_TO_RGB
operator|)
operator|&&
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|==
name|png_ptr
operator|->
name|background
operator|.
name|green
operator|&&
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|==
name|png_ptr
operator|->
name|background
operator|.
name|blue
condition|)
block|{
name|png_ptr
operator|->
name|mode
operator||=
name|PNG_BACKGROUND_IS_GRAY
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|gray
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|red
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BACKGROUND_EXPAND
operator|)
operator|&&
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|color_type
operator|&
name|PNG_COLOR_MASK_COLOR
operator|)
condition|)
comment|/* i.e., GRAY or GRAY_ALPHA */
block|{
comment|/* Expand background and tRNS chunks */
switch|switch
condition|(
name|png_ptr
operator|->
name|bit_depth
condition|)
block|{
case|case
literal|1
case|:
name|png_ptr
operator|->
name|background
operator|.
name|gray
operator|*=
operator|(
name|png_uint_16
operator|)
literal|0xff
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|gray
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND_tRNS
operator|)
condition|)
block|{
name|png_ptr
operator|->
name|trans_color
operator|.
name|gray
operator|*=
operator|(
name|png_uint_16
operator|)
literal|0xff
expr_stmt|;
name|png_ptr
operator|->
name|trans_color
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|trans_color
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|trans_color
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|trans_color
operator|.
name|gray
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
name|png_ptr
operator|->
name|background
operator|.
name|gray
operator|*=
operator|(
name|png_uint_16
operator|)
literal|0x55
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|gray
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND_tRNS
operator|)
condition|)
block|{
name|png_ptr
operator|->
name|trans_color
operator|.
name|gray
operator|*=
operator|(
name|png_uint_16
operator|)
literal|0x55
expr_stmt|;
name|png_ptr
operator|->
name|trans_color
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|trans_color
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|trans_color
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|trans_color
operator|.
name|gray
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
name|png_ptr
operator|->
name|background
operator|.
name|gray
operator|*=
operator|(
name|png_uint_16
operator|)
literal|0x11
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|gray
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND_tRNS
operator|)
condition|)
block|{
name|png_ptr
operator|->
name|trans_color
operator|.
name|gray
operator|*=
operator|(
name|png_uint_16
operator|)
literal|0x11
expr_stmt|;
name|png_ptr
operator|->
name|trans_color
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|trans_color
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|trans_color
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|trans_color
operator|.
name|gray
expr_stmt|;
block|}
break|break;
default|default:
case|case
literal|8
case|:
case|case
literal|16
case|:
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|gray
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
condition|)
block|{
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|palette
index|[
name|png_ptr
operator|->
name|background
operator|.
name|index
index|]
operator|.
name|red
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|palette
index|[
name|png_ptr
operator|->
name|background
operator|.
name|index
index|]
operator|.
name|green
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|palette
index|[
name|png_ptr
operator|->
name|background
operator|.
name|index
index|]
operator|.
name|blue
expr_stmt|;
ifdef|#
directive|ifdef
name|PNG_READ_INVERT_ALPHA_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_INVERT_ALPHA
condition|)
block|{
ifdef|#
directive|ifdef
name|PNG_READ_EXPAND_SUPPORTED
if|if
condition|(
operator|!
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND_tRNS
operator|)
condition|)
endif|#
directive|endif
block|{
comment|/* Invert the alpha channel (in tRNS) unless the pixels are                * going to be expanded, in which case leave it for later                */
name|int
name|i
decl_stmt|,
name|istop
decl_stmt|;
name|istop
operator|=
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|num_trans
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|istop
condition|;
name|i
operator|++
control|)
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
operator|=
call|(
name|png_byte
call|)
argument_list|(
literal|255
operator|-
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|PNG_READ_BACKGROUND_SUPPORTED
argument_list|)
operator|&&
name|defined
argument_list|(
name|PNG_READ_GAMMA_SUPPORTED
argument_list|)
name|png_ptr
operator|->
name|background_1
operator|=
name|png_ptr
operator|->
name|background
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
operator|(
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
operator|&&
name|png_ptr
operator|->
name|num_trans
operator|!=
literal|0
operator|)
operator|&&
name|png_gamma_threshold
argument_list|(
name|png_ptr
operator|->
name|screen_gamma
argument_list|,
name|png_ptr
operator|->
name|gamma
argument_list|)
condition|)
block|{
name|int
name|i
decl_stmt|,
name|k
decl_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|png_ptr
operator|->
name|num_trans
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
operator|!=
literal|0
operator|&&
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
operator|!=
literal|0xff
condition|)
name|k
operator|=
literal|1
expr_stmt|;
comment|/* Partial transparency is present */
block|}
if|if
condition|(
name|k
operator|==
literal|0
condition|)
name|png_ptr
operator|->
name|transformations
operator|&=
operator|~
name|PNG_GAMMA
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
operator|(
name|PNG_GAMMA
operator||
name|PNG_RGB_TO_GRAY
operator|)
operator|)
operator|&&
name|png_ptr
operator|->
name|gamma
operator|!=
literal|0
condition|)
block|{
name|png_build_gamma_table
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|bit_depth
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PNG_READ_BACKGROUND_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BACKGROUND
condition|)
block|{
if|if
condition|(
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
condition|)
block|{
comment|/* Could skip if no transparency */
name|png_color
name|back
decl_stmt|,
name|back_1
decl_stmt|;
name|png_colorp
name|palette
init|=
name|png_ptr
operator|->
name|palette
decl_stmt|;
name|int
name|num_palette
init|=
name|png_ptr
operator|->
name|num_palette
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|png_ptr
operator|->
name|background_gamma_type
operator|==
name|PNG_BACKGROUND_GAMMA_FILE
condition|)
block|{
name|back
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|gamma_table
index|[
name|png_ptr
operator|->
name|background
operator|.
name|red
index|]
expr_stmt|;
name|back
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|gamma_table
index|[
name|png_ptr
operator|->
name|background
operator|.
name|green
index|]
expr_stmt|;
name|back
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|gamma_table
index|[
name|png_ptr
operator|->
name|background
operator|.
name|blue
index|]
expr_stmt|;
name|back_1
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
name|png_ptr
operator|->
name|background
operator|.
name|red
index|]
expr_stmt|;
name|back_1
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
name|png_ptr
operator|->
name|background
operator|.
name|green
index|]
expr_stmt|;
name|back_1
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
name|png_ptr
operator|->
name|background
operator|.
name|blue
index|]
expr_stmt|;
block|}
else|else
block|{
name|png_fixed_point
name|g
decl_stmt|,
name|gs
decl_stmt|;
switch|switch
condition|(
name|png_ptr
operator|->
name|background_gamma_type
condition|)
block|{
case|case
name|PNG_BACKGROUND_GAMMA_SCREEN
case|:
name|g
operator|=
operator|(
name|png_ptr
operator|->
name|screen_gamma
operator|)
expr_stmt|;
name|gs
operator|=
name|PNG_FP_1
expr_stmt|;
break|break;
case|case
name|PNG_BACKGROUND_GAMMA_FILE
case|:
name|g
operator|=
name|png_reciprocal
argument_list|(
name|png_ptr
operator|->
name|gamma
argument_list|)
expr_stmt|;
name|gs
operator|=
name|png_reciprocal2
argument_list|(
name|png_ptr
operator|->
name|gamma
argument_list|,
name|png_ptr
operator|->
name|screen_gamma
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNG_BACKGROUND_GAMMA_UNIQUE
case|:
name|g
operator|=
name|png_reciprocal
argument_list|(
name|png_ptr
operator|->
name|background_gamma
argument_list|)
expr_stmt|;
name|gs
operator|=
name|png_reciprocal2
argument_list|(
name|png_ptr
operator|->
name|background_gamma
argument_list|,
name|png_ptr
operator|->
name|screen_gamma
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g
operator|=
name|PNG_FP_1
expr_stmt|;
comment|/* back_1 */
name|gs
operator|=
name|PNG_FP_1
expr_stmt|;
comment|/* back */
break|break;
block|}
if|if
condition|(
name|png_gamma_significant
argument_list|(
name|gs
argument_list|)
condition|)
block|{
name|back
operator|.
name|red
operator|=
operator|(
name|png_byte
operator|)
name|png_ptr
operator|->
name|background
operator|.
name|red
expr_stmt|;
name|back
operator|.
name|green
operator|=
operator|(
name|png_byte
operator|)
name|png_ptr
operator|->
name|background
operator|.
name|green
expr_stmt|;
name|back
operator|.
name|blue
operator|=
operator|(
name|png_byte
operator|)
name|png_ptr
operator|->
name|background
operator|.
name|blue
expr_stmt|;
block|}
else|else
block|{
name|back
operator|.
name|red
operator|=
name|png_gamma_8bit_correct
argument_list|(
name|png_ptr
operator|->
name|background
operator|.
name|red
argument_list|,
name|gs
argument_list|)
expr_stmt|;
name|back
operator|.
name|green
operator|=
name|png_gamma_8bit_correct
argument_list|(
name|png_ptr
operator|->
name|background
operator|.
name|green
argument_list|,
name|gs
argument_list|)
expr_stmt|;
name|back
operator|.
name|blue
operator|=
name|png_gamma_8bit_correct
argument_list|(
name|png_ptr
operator|->
name|background
operator|.
name|blue
argument_list|,
name|gs
argument_list|)
expr_stmt|;
block|}
name|back_1
operator|.
name|red
operator|=
name|png_gamma_8bit_correct
argument_list|(
name|png_ptr
operator|->
name|background
operator|.
name|red
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|back_1
operator|.
name|green
operator|=
name|png_gamma_8bit_correct
argument_list|(
name|png_ptr
operator|->
name|background
operator|.
name|green
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|back_1
operator|.
name|blue
operator|=
name|png_gamma_8bit_correct
argument_list|(
name|png_ptr
operator|->
name|background
operator|.
name|blue
argument_list|,
name|g
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_palette
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|<
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|num_trans
operator|&&
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
operator|!=
literal|0xff
condition|)
block|{
if|if
condition|(
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
name|palette
index|[
name|i
index|]
operator|=
name|back
expr_stmt|;
block|}
else|else
comment|/* if (png_ptr->trans_alpha[i] != 0xff) */
block|{
name|png_byte
name|v
decl_stmt|,
name|w
decl_stmt|;
name|v
operator|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
name|palette
index|[
name|i
index|]
operator|.
name|red
index|]
expr_stmt|;
name|png_composite
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
argument_list|,
name|back_1
operator|.
name|red
argument_list|)
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|gamma_from_1
index|[
name|w
index|]
expr_stmt|;
name|v
operator|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
name|palette
index|[
name|i
index|]
operator|.
name|green
index|]
expr_stmt|;
name|png_composite
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
argument_list|,
name|back_1
operator|.
name|green
argument_list|)
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|gamma_from_1
index|[
name|w
index|]
expr_stmt|;
name|v
operator|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
name|palette
index|[
name|i
index|]
operator|.
name|blue
index|]
expr_stmt|;
name|png_composite
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
argument_list|,
name|back_1
operator|.
name|blue
argument_list|)
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|gamma_from_1
index|[
name|w
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
name|palette
index|[
name|i
index|]
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|gamma_table
index|[
name|palette
index|[
name|i
index|]
operator|.
name|red
index|]
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|gamma_table
index|[
name|palette
index|[
name|i
index|]
operator|.
name|green
index|]
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|gamma_table
index|[
name|palette
index|[
name|i
index|]
operator|.
name|blue
index|]
expr_stmt|;
block|}
block|}
comment|/* Prevent the transformations being done again, and make sure              * that the now spurious alpha channel is stripped - the code              * has just reduced background composition and gamma correction              * to a simple alpha channel strip.              */
name|png_ptr
operator|->
name|transformations
operator|&=
operator|~
name|PNG_BACKGROUND
expr_stmt|;
name|png_ptr
operator|->
name|transformations
operator|&=
operator|~
name|PNG_GAMMA
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator||=
name|PNG_FLAG_STRIP_ALPHA
expr_stmt|;
block|}
comment|/* if (png_ptr->background_gamma_type!=PNG_BACKGROUND_GAMMA_UNKNOWN) */
else|else
comment|/* color_type != PNG_COLOR_TYPE_PALETTE */
block|{
name|png_fixed_point
name|g
init|=
name|PNG_FP_1
decl_stmt|;
name|png_fixed_point
name|gs
init|=
name|PNG_FP_1
decl_stmt|;
switch|switch
condition|(
name|png_ptr
operator|->
name|background_gamma_type
condition|)
block|{
case|case
name|PNG_BACKGROUND_GAMMA_SCREEN
case|:
name|g
operator|=
name|png_ptr
operator|->
name|screen_gamma
expr_stmt|;
comment|/* gs = PNG_FP_1; */
break|break;
case|case
name|PNG_BACKGROUND_GAMMA_FILE
case|:
name|g
operator|=
name|png_reciprocal
argument_list|(
name|png_ptr
operator|->
name|gamma
argument_list|)
expr_stmt|;
name|gs
operator|=
name|png_reciprocal2
argument_list|(
name|png_ptr
operator|->
name|gamma
argument_list|,
name|png_ptr
operator|->
name|screen_gamma
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNG_BACKGROUND_GAMMA_UNIQUE
case|:
name|g
operator|=
name|png_reciprocal
argument_list|(
name|png_ptr
operator|->
name|background_gamma
argument_list|)
expr_stmt|;
name|gs
operator|=
name|png_reciprocal2
argument_list|(
name|png_ptr
operator|->
name|background_gamma
argument_list|,
name|png_ptr
operator|->
name|screen_gamma
argument_list|)
expr_stmt|;
break|break;
default|default:
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"invalid background gamma type"
argument_list|)
expr_stmt|;
block|}
name|png_ptr
operator|->
name|background_1
operator|.
name|gray
operator|=
name|png_gamma_correct
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|background
operator|.
name|gray
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|gray
operator|=
name|png_gamma_correct
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|background
operator|.
name|gray
argument_list|,
name|gs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|!=
name|png_ptr
operator|->
name|background
operator|.
name|green
operator|)
operator|||
operator|(
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|!=
name|png_ptr
operator|->
name|background
operator|.
name|blue
operator|)
operator|||
operator|(
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|!=
name|png_ptr
operator|->
name|background
operator|.
name|gray
operator|)
condition|)
block|{
comment|/* RGB or RGBA with color background */
name|png_ptr
operator|->
name|background_1
operator|.
name|red
operator|=
name|png_gamma_correct
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|background
operator|.
name|red
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|background_1
operator|.
name|green
operator|=
name|png_gamma_correct
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|background
operator|.
name|green
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|background_1
operator|.
name|blue
operator|=
name|png_gamma_correct
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|background
operator|.
name|blue
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|=
name|png_gamma_correct
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|background
operator|.
name|red
argument_list|,
name|gs
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|green
operator|=
name|png_gamma_correct
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|background
operator|.
name|green
argument_list|,
name|gs
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|blue
operator|=
name|png_gamma_correct
argument_list|(
name|png_ptr
argument_list|,
name|png_ptr
operator|->
name|background
operator|.
name|blue
argument_list|,
name|gs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* GRAY, GRAY ALPHA, RGB, or RGBA with gray background */
name|png_ptr
operator|->
name|background_1
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|background_1
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|background_1
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|background_1
operator|.
name|gray
expr_stmt|;
name|png_ptr
operator|->
name|background
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|background
operator|.
name|gray
expr_stmt|;
block|}
block|}
block|}
elseif|else
comment|/* Transformation does not include PNG_BACKGROUND */
endif|#
directive|endif
comment|/* PNG_READ_BACKGROUND_SUPPORTED */
if|if
condition|(
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
condition|)
block|{
name|png_colorp
name|palette
init|=
name|png_ptr
operator|->
name|palette
decl_stmt|;
name|int
name|num_palette
init|=
name|png_ptr
operator|->
name|num_palette
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_palette
condition|;
name|i
operator|++
control|)
block|{
name|palette
index|[
name|i
index|]
operator|.
name|red
operator|=
name|png_ptr
operator|->
name|gamma_table
index|[
name|palette
index|[
name|i
index|]
operator|.
name|red
index|]
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|green
operator|=
name|png_ptr
operator|->
name|gamma_table
index|[
name|palette
index|[
name|i
index|]
operator|.
name|green
index|]
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|blue
operator|=
name|png_ptr
operator|->
name|gamma_table
index|[
name|palette
index|[
name|i
index|]
operator|.
name|blue
index|]
expr_stmt|;
block|}
comment|/* Done the gamma correction. */
name|png_ptr
operator|->
name|transformations
operator|&=
operator|~
name|PNG_GAMMA
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|PNG_READ_BACKGROUND_SUPPORTED
elseif|else
endif|#
directive|endif
endif|#
directive|endif
comment|/* PNG_READ_GAMMA_SUPPORTED */
ifdef|#
directive|ifdef
name|PNG_READ_BACKGROUND_SUPPORTED
comment|/* No GAMMA transformation */
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BACKGROUND
operator|)
operator|&&
operator|(
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
operator|)
condition|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|istop
init|=
operator|(
name|int
operator|)
name|png_ptr
operator|->
name|num_trans
decl_stmt|;
name|png_color
name|back
decl_stmt|;
name|png_colorp
name|palette
init|=
name|png_ptr
operator|->
name|palette
decl_stmt|;
name|back
operator|.
name|red
operator|=
operator|(
name|png_byte
operator|)
name|png_ptr
operator|->
name|background
operator|.
name|red
expr_stmt|;
name|back
operator|.
name|green
operator|=
operator|(
name|png_byte
operator|)
name|png_ptr
operator|->
name|background
operator|.
name|green
expr_stmt|;
name|back
operator|.
name|blue
operator|=
operator|(
name|png_byte
operator|)
name|png_ptr
operator|->
name|background
operator|.
name|blue
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|istop
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
name|palette
index|[
name|i
index|]
operator|=
name|back
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
operator|!=
literal|0xff
condition|)
block|{
comment|/* The png_composite() macro is defined in png.h */
name|png_composite
argument_list|(
name|palette
index|[
name|i
index|]
operator|.
name|red
argument_list|,
name|palette
index|[
name|i
index|]
operator|.
name|red
argument_list|,
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
argument_list|,
name|back
operator|.
name|red
argument_list|)
expr_stmt|;
name|png_composite
argument_list|(
name|palette
index|[
name|i
index|]
operator|.
name|green
argument_list|,
name|palette
index|[
name|i
index|]
operator|.
name|green
argument_list|,
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
argument_list|,
name|back
operator|.
name|green
argument_list|)
expr_stmt|;
name|png_composite
argument_list|(
name|palette
index|[
name|i
index|]
operator|.
name|blue
argument_list|,
name|palette
index|[
name|i
index|]
operator|.
name|blue
argument_list|,
name|png_ptr
operator|->
name|trans_alpha
index|[
name|i
index|]
argument_list|,
name|back
operator|.
name|blue
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Handled alpha, still need to strip the channel. */
name|png_ptr
operator|->
name|transformations
operator|&=
operator|~
name|PNG_BACKGROUND
expr_stmt|;
name|png_ptr
operator|->
name|flags
operator||=
name|PNG_FLAG_STRIP_ALPHA
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* PNG_READ_BACKGROUND_SUPPORTED */
ifdef|#
directive|ifdef
name|PNG_READ_SHIFT_SUPPORTED
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_SHIFT
operator|)
operator|&&
operator|(
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
operator|)
condition|)
block|{
name|png_uint_16
name|i
decl_stmt|;
name|png_uint_16
name|istop
init|=
name|png_ptr
operator|->
name|num_palette
decl_stmt|;
name|int
name|sr
init|=
literal|8
operator|-
name|png_ptr
operator|->
name|sig_bit
operator|.
name|red
decl_stmt|;
name|int
name|sg
init|=
literal|8
operator|-
name|png_ptr
operator|->
name|sig_bit
operator|.
name|green
decl_stmt|;
name|int
name|sb
init|=
literal|8
operator|-
name|png_ptr
operator|->
name|sig_bit
operator|.
name|blue
decl_stmt|;
if|if
condition|(
name|sr
operator|<
literal|0
operator|||
name|sr
operator|>
literal|8
condition|)
name|sr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sg
operator|<
literal|0
operator|||
name|sg
operator|>
literal|8
condition|)
name|sg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sb
operator|<
literal|0
operator|||
name|sb
operator|>
literal|8
condition|)
name|sb
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|istop
condition|;
name|i
operator|++
control|)
block|{
name|png_ptr
operator|->
name|palette
index|[
name|i
index|]
operator|.
name|red
operator|>>=
name|sr
expr_stmt|;
name|png_ptr
operator|->
name|palette
index|[
name|i
index|]
operator|.
name|green
operator|>>=
name|sg
expr_stmt|;
name|png_ptr
operator|->
name|palette
index|[
name|i
index|]
operator|.
name|blue
operator|>>=
name|sb
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* PNG_READ_SHIFT_SUPPORTED */
block|}
if|#
directive|if
operator|!
name|defined
argument_list|(
name|PNG_READ_GAMMA_SUPPORTED
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|PNG_READ_SHIFT_SUPPORTED
argument_list|)
expr|\
operator|&&
operator|!
name|defined
argument_list|(
name|PNG_READ_BACKGROUND_SUPPORTED
argument_list|)
if|if
condition|(
name|png_ptr
condition|)
return|return;
endif|#
directive|endif
block|}
end_function
begin_comment
comment|/* Modify the info structure to reflect the transformations.  The  * info should be updated so a PNG file could be written with it,  * assuming the transformations result in valid PNG data.  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_read_transform_info
name|png_read_transform_info
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_infop
name|info_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_read_transform_info"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PNG_READ_EXPAND_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND
condition|)
block|{
if|if
condition|(
name|info_ptr
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
condition|)
block|{
if|if
condition|(
name|png_ptr
operator|->
name|num_trans
operator|&&
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND_tRNS
operator|)
condition|)
name|info_ptr
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_RGB_ALPHA
expr_stmt|;
else|else
name|info_ptr
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_RGB
expr_stmt|;
name|info_ptr
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
name|info_ptr
operator|->
name|num_trans
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|png_ptr
operator|->
name|num_trans
condition|)
block|{
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND_tRNS
condition|)
name|info_ptr
operator|->
name|color_type
operator||=
name|PNG_COLOR_MASK_ALPHA
expr_stmt|;
block|}
if|if
condition|(
name|info_ptr
operator|->
name|bit_depth
operator|<
literal|8
condition|)
name|info_ptr
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
name|info_ptr
operator|->
name|num_trans
operator|=
literal|0
expr_stmt|;
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_BACKGROUND_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BACKGROUND
condition|)
block|{
name|info_ptr
operator|->
name|color_type
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|info_ptr
operator|->
name|color_type
operator|&
operator|~
name|PNG_COLOR_MASK_ALPHA
argument_list|)
expr_stmt|;
name|info_ptr
operator|->
name|num_trans
operator|=
literal|0
expr_stmt|;
name|info_ptr
operator|->
name|background
operator|=
name|png_ptr
operator|->
name|background
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_GAMMA
condition|)
block|{
name|info_ptr
operator|->
name|gamma
operator|=
name|png_ptr
operator|->
name|gamma
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_16_TO_8_SUPPORTED
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_16_TO_8
operator|)
operator|&&
operator|(
name|info_ptr
operator|->
name|bit_depth
operator|==
literal|16
operator|)
condition|)
name|info_ptr
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
else|#
directive|else
comment|/* Force chopping 16-bit input down to 8 */
if|if
condition|(
name|info_ptr
operator|->
name|bit_depth
operator|==
literal|16
condition|)
block|{
name|png_ptr
operator|->
name|transformations
operator||=
name|PNG_16_TO_8
expr_stmt|;
name|info_ptr
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_GRAY_TO_RGB_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_GRAY_TO_RGB
condition|)
name|info_ptr
operator|->
name|color_type
operator||=
name|PNG_COLOR_MASK_COLOR
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_RGB_TO_GRAY_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_RGB_TO_GRAY
condition|)
name|info_ptr
operator|->
name|color_type
operator|&=
operator|~
name|PNG_COLOR_MASK_COLOR
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_QUANTIZE_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_QUANTIZE
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|info_ptr
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB
operator|)
operator|||
operator|(
name|info_ptr
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB_ALPHA
operator|)
operator|)
operator|&&
name|png_ptr
operator|->
name|palette_lookup
operator|&&
name|info_ptr
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|info_ptr
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_PALETTE
expr_stmt|;
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_PACK_SUPPORTED
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_PACK
operator|)
operator|&&
operator|(
name|info_ptr
operator|->
name|bit_depth
operator|<
literal|8
operator|)
condition|)
name|info_ptr
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|info_ptr
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
condition|)
name|info_ptr
operator|->
name|channels
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|info_ptr
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_COLOR
condition|)
name|info_ptr
operator|->
name|channels
operator|=
literal|3
expr_stmt|;
else|else
name|info_ptr
operator|->
name|channels
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|PNG_READ_STRIP_ALPHA_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|flags
operator|&
name|PNG_FLAG_STRIP_ALPHA
condition|)
name|info_ptr
operator|->
name|color_type
operator|&=
operator|~
name|PNG_COLOR_MASK_ALPHA
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|info_ptr
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_ALPHA
condition|)
name|info_ptr
operator|->
name|channels
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|PNG_READ_FILLER_SUPPORTED
comment|/* STRIP_ALPHA and FILLER allowed:  MASK_ALPHA bit stripped above */
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_FILLER
operator|)
operator|&&
operator|(
operator|(
name|info_ptr
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB
operator|)
operator|||
operator|(
name|info_ptr
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_GRAY
operator|)
operator|)
condition|)
block|{
name|info_ptr
operator|->
name|channels
operator|++
expr_stmt|;
comment|/* If adding a true alpha channel not just filler */
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_ADD_ALPHA
condition|)
name|info_ptr
operator|->
name|color_type
operator||=
name|PNG_COLOR_MASK_ALPHA
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|PNG_USER_TRANSFORM_PTR_SUPPORTED
argument_list|)
operator|&&
expr|\
name|defined
argument_list|(
name|PNG_READ_USER_TRANSFORM_SUPPORTED
argument_list|)
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_USER_TRANSFORM
condition|)
block|{
if|if
condition|(
name|info_ptr
operator|->
name|bit_depth
operator|<
name|png_ptr
operator|->
name|user_transform_depth
condition|)
name|info_ptr
operator|->
name|bit_depth
operator|=
name|png_ptr
operator|->
name|user_transform_depth
expr_stmt|;
if|if
condition|(
name|info_ptr
operator|->
name|channels
operator|<
name|png_ptr
operator|->
name|user_transform_channels
condition|)
name|info_ptr
operator|->
name|channels
operator|=
name|png_ptr
operator|->
name|user_transform_channels
expr_stmt|;
block|}
endif|#
directive|endif
name|info_ptr
operator|->
name|pixel_depth
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|info_ptr
operator|->
name|channels
operator|*
name|info_ptr
operator|->
name|bit_depth
argument_list|)
expr_stmt|;
name|info_ptr
operator|->
name|rowbytes
operator|=
name|PNG_ROWBYTES
argument_list|(
name|info_ptr
operator|->
name|pixel_depth
argument_list|,
name|info_ptr
operator|->
name|width
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|PNG_READ_EXPAND_SUPPORTED
if|if
condition|(
name|png_ptr
condition|)
return|return;
endif|#
directive|endif
block|}
end_function
begin_comment
comment|/* Transform the row.  The order of transformations is significant,  * and is very touchy.  If you add a transformation, take care to  * decide how it fits in with the other transformations here.  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_read_transformations
name|png_do_read_transformations
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_read_transformations"
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|->
name|row_buf
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|PNG_CONSOLE_IO_SUPPORTED
name|char
name|msg
index|[
literal|50
index|]
decl_stmt|;
name|png_snprintf2
argument_list|(
name|msg
argument_list|,
literal|50
argument_list|,
literal|"NULL row buffer for row %ld, pass %d"
argument_list|,
operator|(
name|long
operator|)
name|png_ptr
operator|->
name|row_number
argument_list|,
name|png_ptr
operator|->
name|pass
argument_list|)
expr_stmt|;
name|png_error
argument_list|(
name|png_ptr
argument_list|,
name|msg
argument_list|)
expr_stmt|;
else|#
directive|else
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"NULL row buffer"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|PNG_WARN_UNINITIALIZED_ROW
if|if
condition|(
operator|!
operator|(
name|png_ptr
operator|->
name|flags
operator|&
name|PNG_FLAG_ROW_INIT
operator|)
condition|)
comment|/* Application has failed to call either png_read_start_image()        * or png_read_update_info() after setting transforms that expand        * pixels.  This check added to libpng-1.2.19        */
if|#
directive|if
operator|(
name|PNG_WARN_UNINITIALIZED_ROW
operator|==
literal|1
operator|)
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"Uninitialized row"
argument_list|)
expr_stmt|;
else|#
directive|else
name|png_warning
argument_list|(
name|png_ptr
argument_list|,
literal|"Uninitialized row"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_EXPAND_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND
condition|)
block|{
if|if
condition|(
name|png_ptr
operator|->
name|row_info
operator|.
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
condition|)
block|{
name|png_do_expand_palette
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|,
name|png_ptr
operator|->
name|palette
argument_list|,
name|png_ptr
operator|->
name|trans_alpha
argument_list|,
name|png_ptr
operator|->
name|num_trans
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|png_ptr
operator|->
name|num_trans
operator|&&
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_EXPAND_tRNS
operator|)
condition|)
name|png_do_expand
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|,
operator|&
operator|(
name|png_ptr
operator|->
name|trans_color
operator|)
argument_list|)
expr_stmt|;
else|else
name|png_do_expand
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_STRIP_ALPHA_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|flags
operator|&
name|PNG_FLAG_STRIP_ALPHA
condition|)
name|png_do_strip_filler
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|,
name|PNG_FLAG_FILLER_AFTER
operator||
operator|(
name|png_ptr
operator|->
name|flags
operator|&
name|PNG_FLAG_STRIP_ALPHA
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_RGB_TO_GRAY_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_RGB_TO_GRAY
condition|)
block|{
name|int
name|rgb_error
init|=
name|png_do_rgb_to_gray
argument_list|(
name|png_ptr
argument_list|,
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|rgb_error
condition|)
block|{
name|png_ptr
operator|->
name|rgb_to_gray_status
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_RGB_TO_GRAY
operator|)
operator|==
name|PNG_RGB_TO_GRAY_WARN
condition|)
name|png_warning
argument_list|(
name|png_ptr
argument_list|,
literal|"png_do_rgb_to_gray found nongray pixel"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_RGB_TO_GRAY
operator|)
operator|==
name|PNG_RGB_TO_GRAY_ERR
condition|)
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"png_do_rgb_to_gray found nongray pixel"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* From Andreas Dilger e-mail to png-implement, 26 March 1998:  *  *   In most cases, the "simple transparency" should be done prior to doing  *   gray-to-RGB, or you will have to test 3x as many bytes to check if a  *   pixel is transparent.  You would also need to make sure that the  *   transparency information is upgraded to RGB.  *  *   To summarize, the current flow is:  *   - Gray + simple transparency -> compare 1 or 2 gray bytes and composite  *                                   with background "in place" if transparent,  *                                   convert to RGB if necessary  *   - Gray + alpha -> composite with gray background and remove alpha bytes,  *                                   convert to RGB if necessary  *  *   To support RGB backgrounds for gray images we need:  *   - Gray + simple transparency -> convert to RGB + simple transparency,  *                                   compare 3 or 6 bytes and composite with  *                                   background "in place" if transparent  *                                   (3x compare/pixel compared to doing  *                                   composite with gray bkgrnd)  *   - Gray + alpha -> convert to RGB + alpha, composite with background and  *                                   remove alpha bytes (3x float  *                                   operations/pixel compared with composite  *                                   on gray background)  *  *  Greg's change will do this.  The reason it wasn't done before is for  *  performance, as this increases the per-pixel operations.  If we would check  *  in advance if the background was gray or RGB, and position the gray-to-RGB  *  transform appropriately, then it would save a lot of work/time.  */
ifdef|#
directive|ifdef
name|PNG_READ_GRAY_TO_RGB_SUPPORTED
comment|/* If gray -> RGB, do so now only if background is non-gray; else do later     * for performance reasons     */
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_GRAY_TO_RGB
operator|)
operator|&&
operator|!
operator|(
name|png_ptr
operator|->
name|mode
operator|&
name|PNG_BACKGROUND_IS_GRAY
operator|)
condition|)
name|png_do_gray_to_rgb
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_BACKGROUND_SUPPORTED
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BACKGROUND
operator|)
operator|&&
operator|(
operator|(
name|png_ptr
operator|->
name|num_trans
operator|!=
literal|0
operator|)
operator|||
operator|(
name|png_ptr
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_ALPHA
operator|)
operator|)
condition|)
name|png_do_background
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|,
operator|&
operator|(
name|png_ptr
operator|->
name|trans_color
operator|)
argument_list|,
operator|&
operator|(
name|png_ptr
operator|->
name|background
operator|)
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
argument_list|,
operator|&
operator|(
name|png_ptr
operator|->
name|background_1
operator|)
argument_list|,
name|png_ptr
operator|->
name|gamma_table
argument_list|,
name|png_ptr
operator|->
name|gamma_from_1
argument_list|,
name|png_ptr
operator|->
name|gamma_to_1
argument_list|,
name|png_ptr
operator|->
name|gamma_16_table
argument_list|,
name|png_ptr
operator|->
name|gamma_16_from_1
argument_list|,
name|png_ptr
operator|->
name|gamma_16_to_1
argument_list|,
name|png_ptr
operator|->
name|gamma_shift
endif|#
directive|endif
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_GAMMA
operator|)
operator|&&
ifdef|#
directive|ifdef
name|PNG_READ_BACKGROUND_SUPPORTED
operator|!
operator|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BACKGROUND
operator|)
operator|&&
operator|(
operator|(
name|png_ptr
operator|->
name|num_trans
operator|!=
literal|0
operator|)
operator|||
operator|(
name|png_ptr
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_ALPHA
operator|)
operator|)
operator|)
operator|&&
endif|#
directive|endif
operator|(
name|png_ptr
operator|->
name|color_type
operator|!=
name|PNG_COLOR_TYPE_PALETTE
operator|)
condition|)
name|png_do_gamma
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|,
name|png_ptr
operator|->
name|gamma_table
argument_list|,
name|png_ptr
operator|->
name|gamma_16_table
argument_list|,
name|png_ptr
operator|->
name|gamma_shift
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_16_TO_8_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_16_TO_8
condition|)
name|png_do_chop
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_QUANTIZE_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_QUANTIZE
condition|)
block|{
name|png_do_quantize
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|,
name|png_ptr
operator|->
name|palette_lookup
argument_list|,
name|png_ptr
operator|->
name|quantize_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|->
name|row_info
operator|.
name|rowbytes
operator|==
literal|0
condition|)
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"png_do_quantize returned rowbytes=0"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* PNG_READ_QUANTIZE_SUPPORTED */
ifdef|#
directive|ifdef
name|PNG_READ_INVERT_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_INVERT_MONO
condition|)
name|png_do_invert
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_SHIFT_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_SHIFT
condition|)
name|png_do_unshift
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|,
operator|&
operator|(
name|png_ptr
operator|->
name|shift
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_PACK_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_PACK
condition|)
name|png_do_unpack
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_BGR_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_BGR
condition|)
name|png_do_bgr
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_PACKSWAP_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_PACKSWAP
condition|)
name|png_do_packswap
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_GRAY_TO_RGB_SUPPORTED
comment|/* If gray -> RGB, do so now only if we did not do so above */
if|if
condition|(
operator|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_GRAY_TO_RGB
operator|)
operator|&&
operator|(
name|png_ptr
operator|->
name|mode
operator|&
name|PNG_BACKGROUND_IS_GRAY
operator|)
condition|)
name|png_do_gray_to_rgb
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_FILLER_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_FILLER
condition|)
name|png_do_read_filler
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|,
operator|(
name|png_uint_32
operator|)
name|png_ptr
operator|->
name|filler
argument_list|,
name|png_ptr
operator|->
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_INVERT_ALPHA_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_INVERT_ALPHA
condition|)
name|png_do_read_invert_alpha
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_SWAP_ALPHA_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_SWAP_ALPHA
condition|)
name|png_do_read_swap_alpha
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
ifdef|#
directive|ifdef
name|PNG_READ_SWAP_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_SWAP_BYTES
condition|)
name|png_do_swap
argument_list|(
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
argument_list|,
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_READ_USER_TRANSFORM_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|transformations
operator|&
name|PNG_USER_TRANSFORM
condition|)
block|{
if|if
condition|(
name|png_ptr
operator|->
name|read_user_transform_fn
operator|!=
name|NULL
condition|)
operator|(
operator|*
operator|(
name|png_ptr
operator|->
name|read_user_transform_fn
operator|)
operator|)
comment|/* User read transform function */
operator|(
name|png_ptr
operator|,
comment|/* png_ptr */
operator|&
operator|(
name|png_ptr
operator|->
name|row_info
operator|)
operator|,
comment|/* row_info: */
comment|/*  png_uint_32 width;       width of row */
comment|/*  png_size_t rowbytes;     number of bytes in row */
comment|/*  png_byte color_type;     color type of pixels */
comment|/*  png_byte bit_depth;      bit depth of samples */
comment|/*  png_byte channels;       number of channels (1-4) */
comment|/*  png_byte pixel_depth;    bits per pixel (depth*channels) */
name|png_ptr
operator|->
name|row_buf
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* start of pixel data for row */
ifdef|#
directive|ifdef
name|PNG_USER_TRANSFORM_PTR_SUPPORTED
if|if
condition|(
name|png_ptr
operator|->
name|user_transform_depth
condition|)
name|png_ptr
operator|->
name|row_info
operator|.
name|bit_depth
operator|=
name|png_ptr
operator|->
name|user_transform_depth
expr_stmt|;
if|if
condition|(
name|png_ptr
operator|->
name|user_transform_channels
condition|)
name|png_ptr
operator|->
name|row_info
operator|.
name|channels
operator|=
name|png_ptr
operator|->
name|user_transform_channels
expr_stmt|;
endif|#
directive|endif
name|png_ptr
operator|->
name|row_info
operator|.
name|pixel_depth
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|png_ptr
operator|->
name|row_info
operator|.
name|bit_depth
operator|*
name|png_ptr
operator|->
name|row_info
operator|.
name|channels
argument_list|)
expr_stmt|;
name|png_ptr
operator|->
name|row_info
operator|.
name|rowbytes
operator|=
name|PNG_ROWBYTES
argument_list|(
name|png_ptr
operator|->
name|row_info
operator|.
name|pixel_depth
argument_list|,
name|png_ptr
operator|->
name|row_info
operator|.
name|width
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_PACK_SUPPORTED
end_ifdef
begin_comment
comment|/* Unpack pixels of 1, 2, or 4 bits per pixel into 1 byte per pixel,  * without changing the actual values.  Thus, if you had a row with  * a bit depth of 1, you would end up with bytes that only contained  * the numbers 0 or 1.  If you would rather they contain 0 and 255, use  * png_do_shift() after this.  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_unpack
name|png_do_unpack
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_unpack"
argument_list|)
expr_stmt|;
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|<
literal|8
condition|)
block|{
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
switch|switch
condition|(
name|row_info
operator|->
name|bit_depth
condition|)
block|{
case|case
literal|1
case|:
block|{
name|png_bytep
name|sp
init|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
operator|(
name|row_width
operator|-
literal|1
operator|)
operator|>>
literal|3
argument_list|)
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
decl_stmt|;
name|png_uint_32
name|shift
init|=
literal|7
operator|-
call|(
name|int
call|)
argument_list|(
operator|(
name|row_width
operator|+
literal|7
operator|)
operator|&
literal|0x07
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x01
argument_list|)
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|7
condition|)
block|{
name|shift
operator|=
literal|0
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
else|else
name|shift
operator|++
expr_stmt|;
name|dp
operator|--
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|2
case|:
block|{
name|png_bytep
name|sp
init|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
operator|(
name|row_width
operator|-
literal|1
operator|)
operator|>>
literal|2
argument_list|)
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
decl_stmt|;
name|png_uint_32
name|shift
init|=
call|(
name|int
call|)
argument_list|(
operator|(
literal|3
operator|-
operator|(
operator|(
name|row_width
operator|+
literal|3
operator|)
operator|&
literal|0x03
operator|)
operator|)
operator|<<
literal|1
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x03
argument_list|)
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|6
condition|)
block|{
name|shift
operator|=
literal|0
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
else|else
name|shift
operator|+=
literal|2
expr_stmt|;
name|dp
operator|--
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
name|png_bytep
name|sp
init|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
operator|(
name|row_width
operator|-
literal|1
operator|)
operator|>>
literal|1
argument_list|)
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
decl_stmt|;
name|png_uint_32
name|shift
init|=
call|(
name|int
call|)
argument_list|(
operator|(
literal|1
operator|-
operator|(
operator|(
name|row_width
operator|+
literal|1
operator|)
operator|&
literal|0x01
operator|)
operator|)
operator|<<
literal|2
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|4
condition|)
block|{
name|shift
operator|=
literal|0
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
else|else
name|shift
operator|=
literal|4
expr_stmt|;
name|dp
operator|--
expr_stmt|;
block|}
break|break;
block|}
default|default:
break|break;
block|}
name|row_info
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
call|(
name|png_byte
call|)
argument_list|(
literal|8
operator|*
name|row_info
operator|->
name|channels
argument_list|)
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
name|row_info
operator|->
name|channels
expr_stmt|;
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_SHIFT_SUPPORTED
end_ifdef
begin_comment
comment|/* Reverse the effects of png_do_shift.  This routine merely shifts the  * pixels back to their significant bits values.  Thus, if you have  * a row of bit depth 8, but only 5 are significant, this will shift  * the values back to 0 through 31.  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_unshift
name|png_do_unshift
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|,
name|png_const_color_8p
name|sig_bits
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_unshift"
argument_list|)
expr_stmt|;
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|!=
name|PNG_COLOR_TYPE_PALETTE
condition|)
block|{
name|int
name|shift
index|[
literal|4
index|]
decl_stmt|;
name|int
name|channels
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|;
name|png_uint_16
name|value
init|=
literal|0
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_COLOR
condition|)
block|{
name|shift
index|[
name|channels
operator|++
index|]
operator|=
name|row_info
operator|->
name|bit_depth
operator|-
name|sig_bits
operator|->
name|red
expr_stmt|;
name|shift
index|[
name|channels
operator|++
index|]
operator|=
name|row_info
operator|->
name|bit_depth
operator|-
name|sig_bits
operator|->
name|green
expr_stmt|;
name|shift
index|[
name|channels
operator|++
index|]
operator|=
name|row_info
operator|->
name|bit_depth
operator|-
name|sig_bits
operator|->
name|blue
expr_stmt|;
block|}
else|else
block|{
name|shift
index|[
name|channels
operator|++
index|]
operator|=
name|row_info
operator|->
name|bit_depth
operator|-
name|sig_bits
operator|->
name|gray
expr_stmt|;
block|}
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_ALPHA
condition|)
block|{
name|shift
index|[
name|channels
operator|++
index|]
operator|=
name|row_info
operator|->
name|bit_depth
operator|-
name|sig_bits
operator|->
name|alpha
expr_stmt|;
block|}
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|channels
condition|;
name|c
operator|++
control|)
block|{
if|if
condition|(
name|shift
index|[
name|c
index|]
operator|<=
literal|0
condition|)
name|shift
index|[
name|c
index|]
operator|=
literal|0
expr_stmt|;
else|else
name|value
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|value
condition|)
return|return;
switch|switch
condition|(
name|row_info
operator|->
name|bit_depth
condition|)
block|{
default|default:
break|break;
case|case
literal|2
case|:
block|{
name|png_bytep
name|bp
decl_stmt|;
name|png_size_t
name|i
decl_stmt|;
name|png_size_t
name|istop
init|=
name|row_info
operator|->
name|rowbytes
decl_stmt|;
for|for
control|(
name|bp
operator|=
name|row
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|istop
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|bp
operator|>>=
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|&=
literal|0x55
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
name|png_bytep
name|bp
init|=
name|row
decl_stmt|;
name|png_size_t
name|i
decl_stmt|;
name|png_size_t
name|istop
init|=
name|row_info
operator|->
name|rowbytes
decl_stmt|;
name|png_byte
name|mask
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
operator|(
operator|(
name|int
operator|)
literal|0xf0
operator|>>
name|shift
index|[
literal|0
index|]
operator|)
operator|&
operator|(
name|int
operator|)
literal|0xf0
operator|)
operator||
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|int
operator|)
literal|0xf
operator|>>
name|shift
index|[
literal|0
index|]
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|istop
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|bp
operator|>>=
name|shift
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|bp
operator|++
operator|&=
name|mask
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|8
case|:
block|{
name|png_bytep
name|bp
init|=
name|row
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|istop
init|=
name|row_width
operator|*
name|channels
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|istop
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|bp
operator|++
operator|>>=
name|shift
index|[
name|i
operator|%
name|channels
index|]
expr_stmt|;
block|}
break|break;
block|}
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
case|case
literal|16
case|:
block|{
name|png_bytep
name|bp
init|=
name|row
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|istop
init|=
name|channels
operator|*
name|row_width
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|istop
condition|;
name|i
operator|++
control|)
block|{
name|value
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|*
name|bp
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|bp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|value
operator|>>=
name|shift
index|[
name|i
operator|%
name|channels
index|]
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|value
operator|>>
literal|8
argument_list|)
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|value
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_16_TO_8_SUPPORTED
end_ifdef
begin_comment
comment|/* Chop rows of bit depth 16 down to 8 */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_chop
name|png_do_chop
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_chop"
argument_list|)
expr_stmt|;
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|16
condition|)
block|{
name|png_bytep
name|sp
init|=
name|row
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|istop
init|=
name|row_info
operator|->
name|width
operator|*
name|row_info
operator|->
name|channels
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|istop
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|2
operator|,
name|dp
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|PNG_READ_16_TO_8_ACCURATE_SCALE_SUPPORTED
comment|/* This does a more accurate scaling of the 16-bit color        * value, rather than a simple low-byte truncation.        *        * What the ideal calculation should be:        *   *dp = (((((png_uint_32)(*sp)<< 8) |        *          (png_uint_32)(*(sp + 1))) * 255 + 127)        *          / (png_uint_32)65535L;        *        * GRR: no, I think this is what it really should be:        *   *dp = (((((png_uint_32)(*sp)<< 8) |        *           (png_uint_32)(*(sp + 1))) + 128L)        *           / (png_uint_32)257L;        *        * GRR: here's the exact calculation with shifts:        *   temp = (((png_uint_32)(*sp)<< 8) |        *           (png_uint_32)(*(sp + 1))) + 128L;        *   *dp = (temp - (temp>> 8))>> 8;        *        * Approximate calculation with shift/add instead of multiply/divide:        *   *dp = ((((png_uint_32)(*sp)<< 8) |        *          (png_uint_32)((int)(*(sp + 1)) - *sp)) + 128)>> 8;        *        * What we actually do to avoid extra shifting and conversion:        */
operator|*
name|dp
operator|=
operator|*
name|sp
operator|+
operator|(
operator|(
operator|(
call|(
name|int
call|)
argument_list|(
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
operator|-
operator|*
name|sp
operator|)
operator|>
literal|128
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
else|#
directive|else
comment|/* Simply discard the low order byte */
operator|*
name|dp
operator|=
operator|*
name|sp
expr_stmt|;
endif|#
directive|endif
block|}
name|row_info
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
call|(
name|png_byte
call|)
argument_list|(
literal|8
operator|*
name|row_info
operator|->
name|channels
argument_list|)
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_info
operator|->
name|width
operator|*
name|row_info
operator|->
name|channels
expr_stmt|;
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_SWAP_ALPHA_SUPPORTED
end_ifdef
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_read_swap_alpha
name|png_do_read_swap_alpha
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_read_swap_alpha"
argument_list|)
expr_stmt|;
block|{
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB_ALPHA
condition|)
block|{
comment|/* This converts from RGBA to ARGB */
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|png_bytep
name|sp
init|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
decl_stmt|;
name|png_byte
name|save
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|save
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|save
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
comment|/* This converts from RRGGBBAA to AARRGGBB */
else|else
block|{
name|png_bytep
name|sp
init|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
decl_stmt|;
name|png_byte
name|save
index|[
literal|2
index|]
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|save
index|[
literal|0
index|]
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
name|save
index|[
literal|1
index|]
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|save
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|save
index|[
literal|1
index|]
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_GRAY_ALPHA
condition|)
block|{
comment|/* This converts from GA to AG */
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|png_bytep
name|sp
init|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
decl_stmt|;
name|png_byte
name|save
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|save
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|save
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
comment|/* This converts from GGAA to AAGG */
else|else
block|{
name|png_bytep
name|sp
init|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
decl_stmt|;
name|png_byte
name|save
index|[
literal|2
index|]
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|save
index|[
literal|0
index|]
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
name|save
index|[
literal|1
index|]
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|save
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|save
index|[
literal|1
index|]
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_INVERT_ALPHA_SUPPORTED
end_ifdef
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_read_invert_alpha
name|png_do_read_invert_alpha
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|)
block|{
name|png_uint_32
name|row_width
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_read_invert_alpha"
argument_list|)
expr_stmt|;
name|row_width
operator|=
name|row_info
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB_ALPHA
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
comment|/* This inverts the alpha channel in RGBA */
name|png_bytep
name|sp
init|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
literal|255
operator|-
operator|*
operator|(
operator|--
name|sp
operator|)
argument_list|)
expr_stmt|;
comment|/*          This does nothing:             *(--dp) = *(--sp);             *(--dp) = *(--sp);             *(--dp) = *(--sp);             We can replace it with: */
name|sp
operator|-=
literal|3
expr_stmt|;
name|dp
operator|=
name|sp
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
comment|/* This inverts the alpha channel in RRGGBBAA */
else|else
block|{
name|png_bytep
name|sp
init|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
literal|255
operator|-
operator|*
operator|(
operator|--
name|sp
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
literal|255
operator|-
operator|*
operator|(
operator|--
name|sp
operator|)
argument_list|)
expr_stmt|;
comment|/*          This does nothing:             *(--dp) = *(--sp);             *(--dp) = *(--sp);             *(--dp) = *(--sp);             *(--dp) = *(--sp);             *(--dp) = *(--sp);             *(--dp) = *(--sp);             We can replace it with: */
name|sp
operator|-=
literal|6
expr_stmt|;
name|dp
operator|=
name|sp
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_GRAY_ALPHA
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
comment|/* This inverts the alpha channel in GA */
name|png_bytep
name|sp
init|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
literal|255
operator|-
operator|*
operator|(
operator|--
name|sp
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
else|else
block|{
comment|/* This inverts the alpha channel in GGAA */
name|png_bytep
name|sp
init|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
literal|255
operator|-
operator|*
operator|(
operator|--
name|sp
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
literal|255
operator|-
operator|*
operator|(
operator|--
name|sp
operator|)
argument_list|)
expr_stmt|;
comment|/*             *(--dp) = *(--sp);             *(--dp) = *(--sp); */
name|sp
operator|-=
literal|2
expr_stmt|;
name|dp
operator|=
name|sp
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_FILLER_SUPPORTED
end_ifdef
begin_comment
comment|/* Add filler channel if we have RGB color */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_read_filler
name|png_do_read_filler
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|,
name|png_uint_32
name|filler
parameter_list|,
name|png_uint_32
name|flags
parameter_list|)
block|{
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
name|png_byte
name|hi_filler
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|filler
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
decl_stmt|;
endif|#
directive|endif
name|png_byte
name|lo_filler
init|=
call|(
name|png_byte
call|)
argument_list|(
name|filler
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_read_filler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_GRAY
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
if|if
condition|(
name|flags
operator|&
name|PNG_FLAG_FILLER_AFTER
condition|)
block|{
comment|/* This changes the data from G to GX */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
block|}
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|2
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|16
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|2
expr_stmt|;
block|}
else|else
block|{
comment|/* This changes the data from G to XG */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
block|}
name|row_info
operator|->
name|channels
operator|=
literal|2
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|16
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|2
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
elseif|else
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|16
condition|)
block|{
if|if
condition|(
name|flags
operator|&
name|PNG_FLAG_FILLER_AFTER
condition|)
block|{
comment|/* This changes the data from GG to GGXX */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|hi_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
block|}
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|hi_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|2
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|32
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|4
expr_stmt|;
block|}
else|else
block|{
comment|/* This changes the data from GG to XXGG */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|hi_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
block|}
name|row_info
operator|->
name|channels
operator|=
literal|2
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|32
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|4
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
comment|/* COLOR_TYPE == GRAY */
elseif|else
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
if|if
condition|(
name|flags
operator|&
name|PNG_FLAG_FILLER_AFTER
condition|)
block|{
comment|/* This changes the data from RGB to RGBX */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|3
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
block|}
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|32
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|4
expr_stmt|;
block|}
else|else
block|{
comment|/* This changes the data from RGB to XRGB */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|3
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
block|}
name|row_info
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|32
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|4
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|PNG_READ_16BIT_SUPPORTED
elseif|else
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|16
condition|)
block|{
if|if
condition|(
name|flags
operator|&
name|PNG_FLAG_FILLER_AFTER
condition|)
block|{
comment|/* This changes the data from RRGGBB to RRGGBBXX */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|6
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|hi_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
block|}
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|hi_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|64
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|8
expr_stmt|;
block|}
else|else
block|{
comment|/* This changes the data from RRGGBB to XXRRGGBB */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|6
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
operator|*
operator|(
operator|--
name|sp
operator|)
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|hi_filler
expr_stmt|;
operator|*
operator|(
operator|--
name|dp
operator|)
operator|=
name|lo_filler
expr_stmt|;
block|}
name|row_info
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|64
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|8
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
comment|/* COLOR_TYPE == RGB */
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_GRAY_TO_RGB_SUPPORTED
end_ifdef
begin_comment
comment|/* Expand grayscale files to RGB, with or without alpha */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_gray_to_rgb
name|png_do_gray_to_rgb
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|)
block|{
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_gray_to_rgb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|>=
literal|8
operator|&&
operator|!
operator|(
name|row_info
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_COLOR
operator|)
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_GRAY
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
comment|/* This changes G to RGB */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
name|sp
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
name|sp
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|--
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* This changes GG to RRGGBB */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
operator|-
literal|1
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|4
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
name|sp
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|-
literal|1
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
name|sp
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|-
literal|1
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|--
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|--
operator|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_GRAY_ALPHA
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
comment|/* This changes GA to RGBA */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
operator|-
literal|1
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|--
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
name|sp
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
name|sp
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|--
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* This changes GGAA to RRGGBBAA */
name|png_bytep
name|sp
init|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|4
operator|-
literal|1
decl_stmt|;
name|png_bytep
name|dp
init|=
name|sp
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|*
literal|4
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|--
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|--
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
name|sp
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|-
literal|1
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
name|sp
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|-
literal|1
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|--
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|--
operator|)
operator|=
operator|*
operator|(
name|sp
operator|--
operator|)
expr_stmt|;
block|}
block|}
block|}
name|row_info
operator|->
name|channels
operator|+=
operator|(
name|png_byte
operator|)
literal|2
expr_stmt|;
name|row_info
operator|->
name|color_type
operator||=
name|PNG_COLOR_MASK_COLOR
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|row_info
operator|->
name|channels
operator|*
name|row_info
operator|->
name|bit_depth
argument_list|)
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|PNG_ROWBYTES
argument_list|(
name|row_info
operator|->
name|pixel_depth
argument_list|,
name|row_width
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_RGB_TO_GRAY_SUPPORTED
end_ifdef
begin_comment
comment|/* Reduce RGB files to grayscale, with or without alpha  * using the equation given in Poynton's ColorFAQ at  *<http://www.inforamp.net/~poynton/>  (THIS LINK IS DEAD June 2008)  * New link:  *<http://www.poynton.com/notes/colour_and_gamma/>  * Charles Poynton poynton at poynton.com  *  *     Y = 0.212671 * R + 0.715160 * G + 0.072169 * B  *  *  We approximate this with  *  *     Y = 0.21268 * R    + 0.7151 * G    + 0.07217 * B  *  *  which can be expressed with integers as  *  *     Y = (6969 * R + 23434 * G + 2365 * B)/32768  *  *  The calculation is to be done in a linear colorspace.  *  *  Other integer coefficents can be used via png_set_rgb_to_gray().  */
end_comment
begin_function
name|int
comment|/* PRIVATE */
DECL|function|png_do_rgb_to_gray
name|png_do_rgb_to_gray
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|)
block|{
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
name|int
name|rgb_error
init|=
literal|0
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_rgb_to_gray"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|row_info
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_PALETTE
operator|)
operator|&&
operator|(
name|row_info
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_COLOR
operator|)
condition|)
block|{
name|png_uint_32
name|rc
init|=
name|png_ptr
operator|->
name|rgb_to_gray_red_coeff
decl_stmt|;
name|png_uint_32
name|gc
init|=
name|png_ptr
operator|->
name|rgb_to_gray_green_coeff
decl_stmt|;
name|png_uint_32
name|bc
init|=
name|png_ptr
operator|->
name|rgb_to_gray_blue_coeff
decl_stmt|;
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|PNG_READ_GAMMA_SUPPORTED
argument_list|)
operator|||
name|defined
argument_list|(
name|PNG_READ_BACKGROUND_SUPPORTED
argument_list|)
if|if
condition|(
name|png_ptr
operator|->
name|gamma_from_1
operator|!=
name|NULL
operator|&&
name|png_ptr
operator|->
name|gamma_to_1
operator|!=
name|NULL
condition|)
block|{
name|png_bytep
name|sp
init|=
name|row
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_byte
name|red
init|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
operator|*
operator|(
name|sp
operator|++
operator|)
index|]
decl_stmt|;
name|png_byte
name|green
init|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
operator|*
operator|(
name|sp
operator|++
operator|)
index|]
decl_stmt|;
name|png_byte
name|blue
init|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
operator|*
operator|(
name|sp
operator|++
operator|)
index|]
decl_stmt|;
if|if
condition|(
name|red
operator|!=
name|green
operator|||
name|red
operator|!=
name|blue
condition|)
block|{
name|rgb_error
operator||=
literal|1
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
name|png_ptr
operator|->
name|gamma_from_1
index|[
operator|(
name|rc
operator|*
name|red
operator|+
name|gc
operator|*
name|green
operator|+
name|bc
operator|*
name|blue
operator|)
operator|>>
literal|15
index|]
expr_stmt|;
block|}
else|else
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
operator|*
operator|(
name|sp
operator|-
literal|1
operator|)
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|png_bytep
name|sp
init|=
name|row
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_byte
name|red
init|=
operator|*
operator|(
name|sp
operator|++
operator|)
decl_stmt|;
name|png_byte
name|green
init|=
operator|*
operator|(
name|sp
operator|++
operator|)
decl_stmt|;
name|png_byte
name|blue
init|=
operator|*
operator|(
name|sp
operator|++
operator|)
decl_stmt|;
if|if
condition|(
name|red
operator|!=
name|green
operator|||
name|red
operator|!=
name|blue
condition|)
block|{
name|rgb_error
operator||=
literal|1
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|rc
operator|*
name|red
operator|+
name|gc
operator|*
name|green
operator|+
name|bc
operator|*
name|blue
operator|)
operator|>>
literal|15
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
operator|*
operator|(
name|sp
operator|-
literal|1
operator|)
expr_stmt|;
block|}
block|}
block|}
else|else
comment|/* RGB bit_depth == 16 */
block|{
if|#
directive|if
name|defined
argument_list|(
name|PNG_READ_GAMMA_SUPPORTED
argument_list|)
operator|||
name|defined
argument_list|(
name|PNG_READ_BACKGROUND_SUPPORTED
argument_list|)
if|if
condition|(
name|png_ptr
operator|->
name|gamma_16_to_1
operator|!=
name|NULL
operator|&&
name|png_ptr
operator|->
name|gamma_16_from_1
operator|!=
name|NULL
condition|)
block|{
name|png_bytep
name|sp
init|=
name|row
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_uint_16
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|,
name|w
decl_stmt|;
name|red
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|green
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|blue
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|red
operator|==
name|green
operator|&&
name|red
operator|==
name|blue
condition|)
name|w
operator|=
name|red
expr_stmt|;
else|else
block|{
name|png_uint_16
name|red_1
init|=
name|png_ptr
operator|->
name|gamma_16_to_1
index|[
operator|(
name|red
operator|&
literal|0xff
operator|)
operator|>>
name|png_ptr
operator|->
name|gamma_shift
index|]
index|[
name|red
operator|>>
literal|8
index|]
decl_stmt|;
name|png_uint_16
name|green_1
init|=
name|png_ptr
operator|->
name|gamma_16_to_1
index|[
operator|(
name|green
operator|&
literal|0xff
operator|)
operator|>>
name|png_ptr
operator|->
name|gamma_shift
index|]
index|[
name|green
operator|>>
literal|8
index|]
decl_stmt|;
name|png_uint_16
name|blue_1
init|=
name|png_ptr
operator|->
name|gamma_16_to_1
index|[
operator|(
name|blue
operator|&
literal|0xff
operator|)
operator|>>
name|png_ptr
operator|->
name|gamma_shift
index|]
index|[
name|blue
operator|>>
literal|8
index|]
decl_stmt|;
name|png_uint_16
name|gray16
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
name|rc
operator|*
name|red_1
operator|+
name|gc
operator|*
name|green_1
operator|+
name|bc
operator|*
name|blue_1
operator|)
operator|>>
literal|15
argument_list|)
decl_stmt|;
name|w
operator|=
name|png_ptr
operator|->
name|gamma_16_from_1
index|[
operator|(
name|gray16
operator|&
literal|0xff
operator|)
operator|>>
name|png_ptr
operator|->
name|gamma_shift
index|]
index|[
name|gray16
operator|>>
literal|8
index|]
expr_stmt|;
name|rgb_error
operator||=
literal|1
expr_stmt|;
block|}
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|w
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|w
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|png_bytep
name|sp
init|=
name|row
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_uint_16
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|,
name|gray16
decl_stmt|;
name|red
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|green
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|blue
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|red
operator|!=
name|green
operator|||
name|red
operator|!=
name|blue
condition|)
name|rgb_error
operator||=
literal|1
expr_stmt|;
name|gray16
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
name|rc
operator|*
name|red
operator|+
name|gc
operator|*
name|green
operator|+
name|bc
operator|*
name|blue
operator|)
operator|>>
literal|15
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|gray16
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|gray16
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB_ALPHA
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|PNG_READ_GAMMA_SUPPORTED
argument_list|)
operator|||
name|defined
argument_list|(
name|PNG_READ_BACKGROUND_SUPPORTED
argument_list|)
if|if
condition|(
name|png_ptr
operator|->
name|gamma_from_1
operator|!=
name|NULL
operator|&&
name|png_ptr
operator|->
name|gamma_to_1
operator|!=
name|NULL
condition|)
block|{
name|png_bytep
name|sp
init|=
name|row
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_byte
name|red
init|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
operator|*
operator|(
name|sp
operator|++
operator|)
index|]
decl_stmt|;
name|png_byte
name|green
init|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
operator|*
operator|(
name|sp
operator|++
operator|)
index|]
decl_stmt|;
name|png_byte
name|blue
init|=
name|png_ptr
operator|->
name|gamma_to_1
index|[
operator|*
operator|(
name|sp
operator|++
operator|)
index|]
decl_stmt|;
if|if
condition|(
name|red
operator|!=
name|green
operator|||
name|red
operator|!=
name|blue
condition|)
name|rgb_error
operator||=
literal|1
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
name|png_ptr
operator|->
name|gamma_from_1
index|[
operator|(
name|rc
operator|*
name|red
operator|+
name|gc
operator|*
name|green
operator|+
name|bc
operator|*
name|blue
operator|)
operator|>>
literal|15
index|]
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
operator|*
operator|(
name|sp
operator|++
operator|)
expr_stmt|;
comment|/* alpha */
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|png_bytep
name|sp
init|=
name|row
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_byte
name|red
init|=
operator|*
operator|(
name|sp
operator|++
operator|)
decl_stmt|;
name|png_byte
name|green
init|=
operator|*
operator|(
name|sp
operator|++
operator|)
decl_stmt|;
name|png_byte
name|blue
init|=
operator|*
operator|(
name|sp
operator|++
operator|)
decl_stmt|;
if|if
condition|(
name|red
operator|!=
name|green
operator|||
name|red
operator|!=
name|blue
condition|)
name|rgb_error
operator||=
literal|1
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|rc
operator|*
name|red
operator|+
name|gc
operator|*
name|green
operator|+
name|bc
operator|*
name|blue
operator|)
operator|>>
literal|15
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
operator|*
operator|(
name|sp
operator|++
operator|)
expr_stmt|;
comment|/* alpha */
block|}
block|}
block|}
else|else
comment|/* RGBA bit_depth == 16 */
block|{
if|#
directive|if
name|defined
argument_list|(
name|PNG_READ_GAMMA_SUPPORTED
argument_list|)
operator|||
name|defined
argument_list|(
name|PNG_READ_BACKGROUND_SUPPORTED
argument_list|)
if|if
condition|(
name|png_ptr
operator|->
name|gamma_16_to_1
operator|!=
name|NULL
operator|&&
name|png_ptr
operator|->
name|gamma_16_from_1
operator|!=
name|NULL
condition|)
block|{
name|png_bytep
name|sp
init|=
name|row
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_uint_16
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|,
name|w
decl_stmt|;
name|red
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|green
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|blue
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|red
operator|==
name|green
operator|&&
name|red
operator|==
name|blue
condition|)
name|w
operator|=
name|red
expr_stmt|;
else|else
block|{
name|png_uint_16
name|red_1
init|=
name|png_ptr
operator|->
name|gamma_16_to_1
index|[
operator|(
name|red
operator|&
literal|0xff
operator|)
operator|>>
name|png_ptr
operator|->
name|gamma_shift
index|]
index|[
name|red
operator|>>
literal|8
index|]
decl_stmt|;
name|png_uint_16
name|green_1
init|=
name|png_ptr
operator|->
name|gamma_16_to_1
index|[
operator|(
name|green
operator|&
literal|0xff
operator|)
operator|>>
name|png_ptr
operator|->
name|gamma_shift
index|]
index|[
name|green
operator|>>
literal|8
index|]
decl_stmt|;
name|png_uint_16
name|blue_1
init|=
name|png_ptr
operator|->
name|gamma_16_to_1
index|[
operator|(
name|blue
operator|&
literal|0xff
operator|)
operator|>>
name|png_ptr
operator|->
name|gamma_shift
index|]
index|[
name|blue
operator|>>
literal|8
index|]
decl_stmt|;
name|png_uint_16
name|gray16
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
name|rc
operator|*
name|red_1
operator|+
name|gc
operator|*
name|green_1
operator|+
name|bc
operator|*
name|blue_1
operator|)
operator|>>
literal|15
argument_list|)
decl_stmt|;
name|w
operator|=
name|png_ptr
operator|->
name|gamma_16_from_1
index|[
operator|(
name|gray16
operator|&
literal|0xff
operator|)
operator|>>
name|png_ptr
operator|->
name|gamma_shift
index|]
index|[
name|gray16
operator|>>
literal|8
index|]
expr_stmt|;
name|rgb_error
operator||=
literal|1
expr_stmt|;
block|}
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|w
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|w
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
operator|*
operator|(
name|sp
operator|++
operator|)
expr_stmt|;
comment|/* alpha */
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
operator|*
operator|(
name|sp
operator|++
operator|)
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|png_bytep
name|sp
init|=
name|row
decl_stmt|;
name|png_bytep
name|dp
init|=
name|row
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_uint_16
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|,
name|gray16
decl_stmt|;
name|red
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|green
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|blue
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|*
operator|(
name|sp
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|red
operator|!=
name|green
operator|||
name|red
operator|!=
name|blue
condition|)
name|rgb_error
operator||=
literal|1
expr_stmt|;
name|gray16
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
name|rc
operator|*
name|red
operator|+
name|gc
operator|*
name|green
operator|+
name|bc
operator|*
name|blue
operator|)
operator|>>
literal|15
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|gray16
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|gray16
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
operator|*
operator|(
name|sp
operator|++
operator|)
expr_stmt|;
comment|/* alpha */
operator|*
operator|(
name|dp
operator|++
operator|)
operator|=
operator|*
operator|(
name|sp
operator|++
operator|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|row_info
operator|->
name|channels
operator|-=
literal|2
expr_stmt|;
name|row_info
operator|->
name|color_type
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|row_info
operator|->
name|color_type
operator|&
operator|~
name|PNG_COLOR_MASK_COLOR
argument_list|)
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|row_info
operator|->
name|channels
operator|*
name|row_info
operator|->
name|bit_depth
argument_list|)
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|PNG_ROWBYTES
argument_list|(
name|row_info
operator|->
name|pixel_depth
argument_list|,
name|row_width
argument_list|)
expr_stmt|;
block|}
return|return
name|rgb_error
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* Build a grayscale palette.  Palette is assumed to be 1<< bit_depth  * large of png_color.  This lets grayscale images be treated as  * paletted.  Most useful for gamma correction and simplification  * of code.  */
end_comment
begin_function
name|void
name|PNGAPI
DECL|function|png_build_grayscale_palette
name|png_build_grayscale_palette
parameter_list|(
name|int
name|bit_depth
parameter_list|,
name|png_colorp
name|palette
parameter_list|)
block|{
name|int
name|num_palette
decl_stmt|;
name|int
name|color_inc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|v
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_build_grayscale_palette"
argument_list|)
expr_stmt|;
if|if
condition|(
name|palette
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|bit_depth
condition|)
block|{
case|case
literal|1
case|:
name|num_palette
operator|=
literal|2
expr_stmt|;
name|color_inc
operator|=
literal|0xff
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|num_palette
operator|=
literal|4
expr_stmt|;
name|color_inc
operator|=
literal|0x55
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|num_palette
operator|=
literal|16
expr_stmt|;
name|color_inc
operator|=
literal|0x11
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|num_palette
operator|=
literal|256
expr_stmt|;
name|color_inc
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|num_palette
operator|=
literal|0
expr_stmt|;
name|color_inc
operator|=
literal|0
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|v
operator|=
literal|0
init|;
name|i
operator|<
name|num_palette
condition|;
name|i
operator|++
operator|,
name|v
operator|+=
name|color_inc
control|)
block|{
name|palette
index|[
name|i
index|]
operator|.
name|red
operator|=
operator|(
name|png_byte
operator|)
name|v
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|green
operator|=
operator|(
name|png_byte
operator|)
name|v
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|blue
operator|=
operator|(
name|png_byte
operator|)
name|v
expr_stmt|;
block|}
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_BACKGROUND_SUPPORTED
end_ifdef
begin_comment
comment|/* Replace any alpha or transparency with the supplied background color.  * "background" is already in the screen gamma, while "background_1" is  * at a gamma of 1.0.  Paletted files have already been taken care of.  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_background
name|png_do_background
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|,
name|png_const_color_16p
name|trans_color
parameter_list|,
name|png_const_color_16p
name|background
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
parameter_list|,
name|png_const_color_16p
name|background_1
parameter_list|,
name|png_const_bytep
name|gamma_table
parameter_list|,
name|png_const_bytep
name|gamma_from_1
parameter_list|,
name|png_const_bytep
name|gamma_to_1
parameter_list|,
name|png_const_uint_16pp
name|gamma_16
parameter_list|,
name|png_const_uint_16pp
name|gamma_16_from_1
parameter_list|,
name|png_const_uint_16pp
name|gamma_16_to_1
parameter_list|,
name|int
name|gamma_shift
endif|#
directive|endif
parameter_list|)
block|{
name|png_bytep
name|sp
decl_stmt|,
name|dp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
name|int
name|shift
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_background"
argument_list|)
expr_stmt|;
if|if
condition|(
name|background
operator|!=
name|NULL
operator|&&
operator|(
operator|!
operator|(
name|row_info
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_ALPHA
operator|)
operator|||
operator|(
name|row_info
operator|->
name|color_type
operator|!=
name|PNG_COLOR_TYPE_PALETTE
operator|&&
name|trans_color
operator|)
operator|)
condition|)
block|{
switch|switch
condition|(
name|row_info
operator|->
name|color_type
condition|)
block|{
case|case
name|PNG_COLOR_TYPE_GRAY
case|:
block|{
switch|switch
condition|(
name|row_info
operator|->
name|bit_depth
condition|)
block|{
case|case
literal|1
case|:
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|shift
operator|=
literal|7
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x01
argument_list|)
operator|==
name|trans_color
operator|->
name|gray
condition|)
block|{
operator|*
name|sp
operator|&=
call|(
name|png_byte
call|)
argument_list|(
operator|(
literal|0x7f7f
operator|>>
operator|(
literal|7
operator|-
name|shift
operator|)
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
name|sp
operator||=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|gray
operator|<<
name|shift
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|shift
condition|)
block|{
name|shift
operator|=
literal|7
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
else|else
name|shift
operator|--
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|2
case|:
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_table
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|shift
operator|=
literal|6
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x03
argument_list|)
operator|==
name|trans_color
operator|->
name|gray
condition|)
block|{
operator|*
name|sp
operator|&=
call|(
name|png_byte
call|)
argument_list|(
operator|(
literal|0x3f3f
operator|>>
operator|(
literal|6
operator|-
name|shift
operator|)
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
name|sp
operator||=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|gray
operator|<<
name|shift
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|png_byte
name|p
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x03
argument_list|)
decl_stmt|;
name|png_byte
name|g
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|gamma_table
index|[
name|p
operator||
operator|(
name|p
operator|<<
literal|2
operator|)
operator||
operator|(
name|p
operator|<<
literal|4
operator|)
operator||
operator|(
name|p
operator|<<
literal|6
operator|)
index|]
operator|>>
literal|6
operator|)
operator|&
literal|0x03
argument_list|)
decl_stmt|;
operator|*
name|sp
operator|&=
call|(
name|png_byte
call|)
argument_list|(
operator|(
literal|0x3f3f
operator|>>
operator|(
literal|6
operator|-
name|shift
operator|)
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
name|sp
operator||=
call|(
name|png_byte
call|)
argument_list|(
name|g
operator|<<
name|shift
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|shift
condition|)
block|{
name|shift
operator|=
literal|6
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
else|else
name|shift
operator|-=
literal|2
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|shift
operator|=
literal|6
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x03
argument_list|)
operator|==
name|trans_color
operator|->
name|gray
condition|)
block|{
operator|*
name|sp
operator|&=
call|(
name|png_byte
call|)
argument_list|(
operator|(
literal|0x3f3f
operator|>>
operator|(
literal|6
operator|-
name|shift
operator|)
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
name|sp
operator||=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|gray
operator|<<
name|shift
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|shift
condition|)
block|{
name|shift
operator|=
literal|6
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
else|else
name|shift
operator|-=
literal|2
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_table
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|shift
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x0f
argument_list|)
operator|==
name|trans_color
operator|->
name|gray
condition|)
block|{
operator|*
name|sp
operator|&=
call|(
name|png_byte
call|)
argument_list|(
operator|(
literal|0xf0f
operator|>>
operator|(
literal|4
operator|-
name|shift
operator|)
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
name|sp
operator||=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|gray
operator|<<
name|shift
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|png_byte
name|p
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x0f
argument_list|)
decl_stmt|;
name|png_byte
name|g
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|gamma_table
index|[
name|p
operator||
operator|(
name|p
operator|<<
literal|4
operator|)
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
argument_list|)
decl_stmt|;
operator|*
name|sp
operator|&=
call|(
name|png_byte
call|)
argument_list|(
operator|(
literal|0xf0f
operator|>>
operator|(
literal|4
operator|-
name|shift
operator|)
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
name|sp
operator||=
call|(
name|png_byte
call|)
argument_list|(
name|g
operator|<<
name|shift
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|shift
condition|)
block|{
name|shift
operator|=
literal|4
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
else|else
name|shift
operator|-=
literal|4
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|shift
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x0f
argument_list|)
operator|==
name|trans_color
operator|->
name|gray
condition|)
block|{
operator|*
name|sp
operator|&=
call|(
name|png_byte
call|)
argument_list|(
operator|(
literal|0xf0f
operator|>>
operator|(
literal|4
operator|-
name|shift
operator|)
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
name|sp
operator||=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|gray
operator|<<
name|shift
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|shift
condition|)
block|{
name|shift
operator|=
literal|4
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
else|else
name|shift
operator|-=
literal|4
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
literal|8
case|:
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_table
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|sp
operator|==
name|trans_color
operator|->
name|gray
condition|)
operator|*
name|sp
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|gray
expr_stmt|;
else|else
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|sp
operator|==
name|trans_color
operator|->
name|gray
condition|)
operator|*
name|sp
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|gray
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
literal|16
case|:
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_16
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|2
control|)
block|{
name|png_uint_16
name|v
decl_stmt|;
name|v
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
name|sp
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|trans_color
operator|->
name|gray
condition|)
block|{
comment|/* Background is already in screen gamma */
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|gray
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|gray
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|v
operator|=
name|gamma_16
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|2
control|)
block|{
name|png_uint_16
name|v
decl_stmt|;
name|v
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
name|sp
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|trans_color
operator|->
name|gray
condition|)
block|{
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|gray
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|gray
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
block|}
default|default:
break|break;
block|}
break|break;
block|}
case|case
name|PNG_COLOR_TYPE_RGB
case|:
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_table
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|3
control|)
block|{
if|if
condition|(
operator|*
name|sp
operator|==
name|trans_color
operator|->
name|red
operator|&&
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|==
name|trans_color
operator|->
name|green
operator|&&
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|==
name|trans_color
operator|->
name|blue
condition|)
block|{
operator|*
name|sp
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|red
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|green
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|blue
expr_stmt|;
block|}
else|else
block|{
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
name|gamma_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
index|]
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|=
name|gamma_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
index|]
expr_stmt|;
block|}
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|3
control|)
block|{
if|if
condition|(
operator|*
name|sp
operator|==
name|trans_color
operator|->
name|red
operator|&&
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|==
name|trans_color
operator|->
name|green
operator|&&
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|==
name|trans_color
operator|->
name|blue
condition|)
block|{
operator|*
name|sp
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|red
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|green
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|blue
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
comment|/* if (row_info->bit_depth == 16) */
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_16
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|6
control|)
block|{
name|png_uint_16
name|r
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
name|sp
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
decl_stmt|;
name|png_uint_16
name|g
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
argument_list|)
decl_stmt|;
name|png_uint_16
name|b
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|+
literal|4
operator|)
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|5
operator|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|==
name|trans_color
operator|->
name|red
operator|&&
name|g
operator|==
name|trans_color
operator|->
name|green
operator|&&
name|b
operator|==
name|trans_color
operator|->
name|blue
condition|)
block|{
comment|/* Background is already in screen gamma */
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|red
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|red
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|green
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|green
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|4
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|blue
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|5
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|blue
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|png_uint_16
name|v
init|=
name|gamma_16
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
decl_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|v
operator|=
name|gamma_16
index|[
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
index|]
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|v
operator|=
name|gamma_16
index|[
operator|*
operator|(
name|sp
operator|+
literal|5
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
operator|(
name|sp
operator|+
literal|4
operator|)
index|]
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|4
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|5
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|6
control|)
block|{
name|png_uint_16
name|r
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
name|sp
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
decl_stmt|;
name|png_uint_16
name|g
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
argument_list|)
decl_stmt|;
name|png_uint_16
name|b
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|+
literal|4
operator|)
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|5
operator|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|==
name|trans_color
operator|->
name|red
operator|&&
name|g
operator|==
name|trans_color
operator|->
name|green
operator|&&
name|b
operator|==
name|trans_color
operator|->
name|blue
condition|)
block|{
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|red
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|red
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|green
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|green
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|4
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|blue
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|5
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|blue
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
break|break;
block|}
case|case
name|PNG_COLOR_TYPE_GRAY_ALPHA
case|:
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_to_1
operator|!=
name|NULL
operator|&&
name|gamma_from_1
operator|!=
name|NULL
operator|&&
name|gamma_table
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|2
operator|,
name|dp
operator|++
control|)
block|{
name|png_uint_16
name|a
init|=
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|a
operator|==
literal|0xff
condition|)
operator|*
name|dp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|a
operator|==
literal|0
condition|)
block|{
comment|/* Background is already in screen gamma */
operator|*
name|dp
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|gray
expr_stmt|;
block|}
else|else
block|{
name|png_byte
name|v
decl_stmt|,
name|w
decl_stmt|;
name|v
operator|=
name|gamma_to_1
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|png_composite
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|gray
argument_list|)
expr_stmt|;
operator|*
name|dp
operator|=
name|gamma_from_1
index|[
name|w
index|]
expr_stmt|;
block|}
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|2
operator|,
name|dp
operator|++
control|)
block|{
name|png_byte
name|a
init|=
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|a
operator|==
literal|0xff
condition|)
operator|*
name|dp
operator|=
operator|*
name|sp
expr_stmt|;
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
elseif|else
if|if
condition|(
name|a
operator|==
literal|0
condition|)
operator|*
name|dp
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|gray
expr_stmt|;
else|else
name|png_composite
argument_list|(
operator|*
name|dp
argument_list|,
operator|*
name|sp
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|gray
argument_list|)
expr_stmt|;
else|#
directive|else
operator|*
name|dp
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|gray
expr_stmt|;
endif|#
directive|endif
block|}
block|}
block|}
else|else
comment|/* if (png_ptr->bit_depth == 16) */
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_16
operator|!=
name|NULL
operator|&&
name|gamma_16_from_1
operator|!=
name|NULL
operator|&&
name|gamma_16_to_1
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|4
operator|,
name|dp
operator|+=
literal|2
control|)
block|{
name|png_uint_16
name|a
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|a
operator|==
operator|(
name|png_uint_16
operator|)
literal|0xffff
condition|)
block|{
name|png_uint_16
name|v
decl_stmt|;
name|v
operator|=
name|gamma_16
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
elseif|else
if|if
condition|(
name|a
operator|==
literal|0
condition|)
else|#
directive|else
else|else
endif|#
directive|endif
block|{
comment|/* Background is already in screen gamma */
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|gray
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|gray
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
else|else
block|{
name|png_uint_16
name|g
decl_stmt|,
name|v
decl_stmt|,
name|w
decl_stmt|;
name|g
operator|=
name|gamma_16_to_1
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|png_composite_16
argument_list|(
name|v
argument_list|,
name|g
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|gray
argument_list|)
expr_stmt|;
name|w
operator|=
name|gamma_16_from_1
index|[
operator|(
name|v
operator|&
literal|0xff
operator|)
operator|>>
name|gamma_shift
index|]
index|[
name|v
operator|>>
literal|8
index|]
expr_stmt|;
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|w
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|w
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|4
operator|,
name|dp
operator|+=
literal|2
control|)
block|{
name|png_uint_16
name|a
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|a
operator|==
operator|(
name|png_uint_16
operator|)
literal|0xffff
condition|)
name|png_memcpy
argument_list|(
name|dp
argument_list|,
name|sp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
elseif|else
if|if
condition|(
name|a
operator|==
literal|0
condition|)
else|#
directive|else
else|else
endif|#
directive|endif
block|{
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|gray
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|gray
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
else|else
block|{
name|png_uint_16
name|g
decl_stmt|,
name|v
decl_stmt|;
name|g
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
name|sp
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|png_composite_16
argument_list|(
name|v
argument_list|,
name|g
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|gray
argument_list|)
expr_stmt|;
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
block|}
break|break;
block|}
case|case
name|PNG_COLOR_TYPE_RGB_ALPHA
case|:
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_to_1
operator|!=
name|NULL
operator|&&
name|gamma_from_1
operator|!=
name|NULL
operator|&&
name|gamma_table
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|4
operator|,
name|dp
operator|+=
literal|3
control|)
block|{
name|png_byte
name|a
init|=
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
decl_stmt|;
if|if
condition|(
name|a
operator|==
literal|0xff
condition|)
block|{
operator|*
name|dp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
name|gamma_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
index|]
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
name|gamma_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|a
operator|==
literal|0
condition|)
block|{
comment|/* Background is already in screen gamma */
operator|*
name|dp
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|red
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|green
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|blue
expr_stmt|;
block|}
else|else
block|{
name|png_byte
name|v
decl_stmt|,
name|w
decl_stmt|;
name|v
operator|=
name|gamma_to_1
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|png_composite
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|red
argument_list|)
expr_stmt|;
operator|*
name|dp
operator|=
name|gamma_from_1
index|[
name|w
index|]
expr_stmt|;
name|v
operator|=
name|gamma_to_1
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
index|]
expr_stmt|;
name|png_composite
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|green
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
name|gamma_from_1
index|[
name|w
index|]
expr_stmt|;
name|v
operator|=
name|gamma_to_1
index|[
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
index|]
expr_stmt|;
name|png_composite
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|blue
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
name|gamma_from_1
index|[
name|w
index|]
expr_stmt|;
block|}
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|4
operator|,
name|dp
operator|+=
literal|3
control|)
block|{
name|png_byte
name|a
init|=
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
decl_stmt|;
if|if
condition|(
name|a
operator|==
literal|0xff
condition|)
block|{
operator|*
name|dp
operator|=
operator|*
name|sp
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|a
operator|==
literal|0
condition|)
block|{
operator|*
name|dp
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|red
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|green
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
operator|(
name|png_byte
operator|)
name|background
operator|->
name|blue
expr_stmt|;
block|}
else|else
block|{
name|png_composite
argument_list|(
operator|*
name|dp
argument_list|,
operator|*
name|sp
argument_list|,
name|a
argument_list|,
name|background
operator|->
name|red
argument_list|)
expr_stmt|;
name|png_composite
argument_list|(
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
argument_list|,
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|,
name|a
argument_list|,
name|background
operator|->
name|green
argument_list|)
expr_stmt|;
name|png_composite
argument_list|(
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
argument_list|,
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
argument_list|,
name|a
argument_list|,
name|background
operator|->
name|blue
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
comment|/* if (row_info->bit_depth == 16) */
block|{
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
if|if
condition|(
name|gamma_16
operator|!=
name|NULL
operator|&&
name|gamma_16_from_1
operator|!=
name|NULL
operator|&&
name|gamma_16_to_1
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|8
operator|,
name|dp
operator|+=
literal|6
control|)
block|{
name|png_uint_16
name|a
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
call|(
name|png_uint_16
call|)
argument_list|(
operator|*
operator|(
name|sp
operator|+
literal|6
operator|)
argument_list|)
operator|<<
literal|8
operator|)
operator|+
call|(
name|png_uint_16
call|)
argument_list|(
operator|*
operator|(
name|sp
operator|+
literal|7
operator|)
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|a
operator|==
operator|(
name|png_uint_16
operator|)
literal|0xffff
condition|)
block|{
name|png_uint_16
name|v
decl_stmt|;
name|v
operator|=
name|gamma_16
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|v
operator|=
name|gamma_16
index|[
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
index|]
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|3
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|v
operator|=
name|gamma_16
index|[
operator|*
operator|(
name|sp
operator|+
literal|5
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
operator|(
name|sp
operator|+
literal|4
operator|)
index|]
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|4
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|5
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|a
operator|==
literal|0
condition|)
block|{
comment|/* Background is already in screen gamma */
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|red
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|red
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|green
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|3
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|green
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|4
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|blue
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|5
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|blue
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|png_uint_16
name|v
decl_stmt|,
name|w
decl_stmt|,
name|x
decl_stmt|;
name|v
operator|=
name|gamma_16_to_1
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|png_composite_16
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|red
argument_list|)
expr_stmt|;
name|x
operator|=
name|gamma_16_from_1
index|[
operator|(
operator|(
name|w
operator|&
literal|0xff
operator|)
operator|>>
name|gamma_shift
operator|)
index|]
index|[
name|w
operator|>>
literal|8
index|]
expr_stmt|;
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|x
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|x
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|v
operator|=
name|gamma_16_to_1
index|[
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
index|]
expr_stmt|;
name|png_composite_16
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|green
argument_list|)
expr_stmt|;
name|x
operator|=
name|gamma_16_from_1
index|[
operator|(
operator|(
name|w
operator|&
literal|0xff
operator|)
operator|>>
name|gamma_shift
operator|)
index|]
index|[
name|w
operator|>>
literal|8
index|]
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|x
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|3
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|x
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|v
operator|=
name|gamma_16_to_1
index|[
operator|*
operator|(
name|sp
operator|+
literal|5
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
operator|(
name|sp
operator|+
literal|4
operator|)
index|]
expr_stmt|;
name|png_composite_16
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|a
argument_list|,
name|background_1
operator|->
name|blue
argument_list|)
expr_stmt|;
name|x
operator|=
name|gamma_16_from_1
index|[
operator|(
name|w
operator|&
literal|0xff
operator|)
operator|>>
name|gamma_shift
index|]
index|[
name|w
operator|>>
literal|8
index|]
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|4
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|x
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|5
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|x
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|+=
literal|8
operator|,
name|dp
operator|+=
literal|6
control|)
block|{
name|png_uint_16
name|a
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
call|(
name|png_uint_16
call|)
argument_list|(
operator|*
operator|(
name|sp
operator|+
literal|6
operator|)
argument_list|)
operator|<<
literal|8
operator|)
operator|+
call|(
name|png_uint_16
call|)
argument_list|(
operator|*
operator|(
name|sp
operator|+
literal|7
operator|)
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|a
operator|==
operator|(
name|png_uint_16
operator|)
literal|0xffff
condition|)
block|{
name|png_memcpy
argument_list|(
name|dp
argument_list|,
name|sp
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|a
operator|==
literal|0
condition|)
block|{
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|red
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|red
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|green
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|3
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|green
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|4
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|background
operator|->
name|blue
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|5
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|background
operator|->
name|blue
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|png_uint_16
name|v
decl_stmt|;
name|png_uint_16
name|r
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
name|sp
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
argument_list|)
decl_stmt|;
name|png_uint_16
name|g
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|+
literal|2
operator|)
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|3
operator|)
argument_list|)
decl_stmt|;
name|png_uint_16
name|b
init|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
operator|(
operator|*
operator|(
name|sp
operator|+
literal|4
operator|)
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|sp
operator|+
literal|5
operator|)
argument_list|)
decl_stmt|;
name|png_composite_16
argument_list|(
name|v
argument_list|,
name|r
argument_list|,
name|a
argument_list|,
name|background
operator|->
name|red
argument_list|)
expr_stmt|;
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|png_composite_16
argument_list|(
name|v
argument_list|,
name|g
argument_list|,
name|a
argument_list|,
name|background
operator|->
name|green
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|2
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|3
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|png_composite_16
argument_list|(
name|v
argument_list|,
name|b
argument_list|,
name|a
argument_list|,
name|background
operator|->
name|blue
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|4
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|dp
operator|+
literal|5
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
break|break;
block|}
default|default:
break|break;
block|}
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_ALPHA
condition|)
block|{
name|row_info
operator|->
name|color_type
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|row_info
operator|->
name|color_type
operator|&
operator|~
name|PNG_COLOR_MASK_ALPHA
argument_list|)
expr_stmt|;
name|row_info
operator|->
name|channels
operator|--
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|row_info
operator|->
name|channels
operator|*
name|row_info
operator|->
name|bit_depth
argument_list|)
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|PNG_ROWBYTES
argument_list|(
name|row_info
operator|->
name|pixel_depth
argument_list|,
name|row_width
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_GAMMA_SUPPORTED
end_ifdef
begin_comment
comment|/* Gamma correct the image, avoiding the alpha channel.  Make sure  * you do this after you deal with the transparency issue on grayscale  * or RGB images. If your bit depth is 8, use gamma_table, if it  * is 16, use gamma_16_table and gamma_shift.  Build these with  * build_gamma_table().  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_gamma
name|png_do_gamma
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|,
name|png_const_bytep
name|gamma_table
parameter_list|,
name|png_const_uint_16pp
name|gamma_16_table
parameter_list|,
name|int
name|gamma_shift
parameter_list|)
block|{
name|png_bytep
name|sp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_gamma"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|row_info
operator|->
name|bit_depth
operator|<=
literal|8
operator|&&
name|gamma_table
operator|!=
name|NULL
operator|)
operator|||
operator|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|16
operator|&&
name|gamma_16_table
operator|!=
name|NULL
operator|)
operator|)
condition|)
block|{
switch|switch
condition|(
name|row_info
operator|->
name|color_type
condition|)
block|{
case|case
name|PNG_COLOR_TYPE_RGB
case|:
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|sp
operator|++
expr_stmt|;
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|sp
operator|++
expr_stmt|;
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
block|}
else|else
comment|/* if (row_info->bit_depth == 16) */
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_uint_16
name|v
decl_stmt|;
name|v
operator|=
name|gamma_16_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|v
operator|=
name|gamma_16_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|v
operator|=
name|gamma_16_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
name|PNG_COLOR_TYPE_RGB_ALPHA
case|:
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|sp
operator|++
expr_stmt|;
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|sp
operator|++
expr_stmt|;
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|sp
operator|++
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
block|}
else|else
comment|/* if (row_info->bit_depth == 16) */
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_uint_16
name|v
init|=
name|gamma_16_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
decl_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|v
operator|=
name|gamma_16_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
name|v
operator|=
name|gamma_16_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|4
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
name|PNG_COLOR_TYPE_GRAY_ALPHA
case|:
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
comment|/* if (row_info->bit_depth == 16) */
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_uint_16
name|v
init|=
name|gamma_16_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
decl_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|4
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
name|PNG_COLOR_TYPE_GRAY
case|:
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|2
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|+=
literal|4
control|)
block|{
name|int
name|a
init|=
operator|*
name|sp
operator|&
literal|0xc0
decl_stmt|;
name|int
name|b
init|=
operator|*
name|sp
operator|&
literal|0x30
decl_stmt|;
name|int
name|c
init|=
operator|*
name|sp
operator|&
literal|0x0c
decl_stmt|;
name|int
name|d
init|=
operator|*
name|sp
operator|&
literal|0x03
decl_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
operator|(
operator|(
operator|(
name|int
operator|)
name|gamma_table
index|[
name|a
operator||
operator|(
name|a
operator|>>
literal|2
operator|)
operator||
operator|(
name|a
operator|>>
literal|4
operator|)
operator||
operator|(
name|a
operator|>>
literal|6
operator|)
index|]
operator|)
operator|)
operator|&
literal|0xc0
operator|)
operator||
operator|(
operator|(
operator|(
operator|(
name|int
operator|)
name|gamma_table
index|[
operator|(
name|b
operator|<<
literal|2
operator|)
operator||
name|b
operator||
operator|(
name|b
operator|>>
literal|2
operator|)
operator||
operator|(
name|b
operator|>>
literal|4
operator|)
index|]
operator|)
operator|>>
literal|2
operator|)
operator|&
literal|0x30
operator|)
operator||
operator|(
operator|(
operator|(
operator|(
name|int
operator|)
name|gamma_table
index|[
operator|(
name|c
operator|<<
literal|4
operator|)
operator||
operator|(
name|c
operator|<<
literal|2
operator|)
operator||
name|c
operator||
operator|(
name|c
operator|>>
literal|2
operator|)
index|]
operator|)
operator|>>
literal|4
operator|)
operator|&
literal|0x0c
operator|)
operator||
operator|(
operator|(
operator|(
operator|(
name|int
operator|)
name|gamma_table
index|[
operator|(
name|d
operator|<<
literal|6
operator|)
operator||
operator|(
name|d
operator|<<
literal|4
operator|)
operator||
operator|(
name|d
operator|<<
literal|2
operator|)
operator||
name|d
index|]
operator|)
operator|>>
literal|6
operator|)
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|4
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|int
name|msb
init|=
operator|*
name|sp
operator|&
literal|0xf0
decl_stmt|;
name|int
name|lsb
init|=
operator|*
name|sp
operator|&
literal|0x0f
decl_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
operator|(
operator|(
name|int
operator|)
name|gamma_table
index|[
name|msb
operator||
operator|(
name|msb
operator|>>
literal|4
operator|)
index|]
operator|)
operator|&
literal|0xf0
operator|)
operator||
operator|(
operator|(
operator|(
name|int
operator|)
name|gamma_table
index|[
operator|(
name|lsb
operator|<<
literal|4
operator|)
operator||
name|lsb
index|]
operator|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|sp
operator|=
name|gamma_table
index|[
operator|*
name|sp
index|]
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|16
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|png_uint_16
name|v
init|=
name|gamma_16_table
index|[
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|>>
name|gamma_shift
index|]
index|[
operator|*
name|sp
index|]
decl_stmt|;
operator|*
name|sp
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|sp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sp
operator|+=
literal|2
expr_stmt|;
block|}
block|}
break|break;
block|}
default|default:
break|break;
block|}
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_EXPAND_SUPPORTED
end_ifdef
begin_comment
comment|/* Expands a palette row to an RGB or RGBA row depending  * upon whether you supply trans and num_trans.  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_expand_palette
name|png_do_expand_palette
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|,
name|png_const_colorp
name|palette
parameter_list|,
name|png_const_bytep
name|trans_alpha
parameter_list|,
name|int
name|num_trans
parameter_list|)
block|{
name|int
name|shift
decl_stmt|,
name|value
decl_stmt|;
name|png_bytep
name|sp
decl_stmt|,
name|dp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_expand_palette"
argument_list|)
expr_stmt|;
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|<
literal|8
condition|)
block|{
switch|switch
condition|(
name|row_info
operator|->
name|bit_depth
condition|)
block|{
case|case
literal|1
case|:
block|{
name|sp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
operator|(
name|row_width
operator|-
literal|1
operator|)
operator|>>
literal|3
argument_list|)
expr_stmt|;
name|dp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
expr_stmt|;
name|shift
operator|=
literal|7
operator|-
call|(
name|int
call|)
argument_list|(
operator|(
name|row_width
operator|+
literal|7
operator|)
operator|&
literal|0x07
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x01
condition|)
operator|*
name|dp
operator|=
literal|1
expr_stmt|;
else|else
operator|*
name|dp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|7
condition|)
block|{
name|shift
operator|=
literal|0
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
else|else
name|shift
operator|++
expr_stmt|;
name|dp
operator|--
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|2
case|:
block|{
name|sp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
operator|(
name|row_width
operator|-
literal|1
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|dp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
expr_stmt|;
name|shift
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
literal|3
operator|-
operator|(
operator|(
name|row_width
operator|+
literal|3
operator|)
operator|&
literal|0x03
operator|)
operator|)
operator|<<
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|value
operator|=
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x03
expr_stmt|;
operator|*
name|dp
operator|=
operator|(
name|png_byte
operator|)
name|value
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|6
condition|)
block|{
name|shift
operator|=
literal|0
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
else|else
name|shift
operator|+=
literal|2
expr_stmt|;
name|dp
operator|--
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
name|sp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
operator|(
name|row_width
operator|-
literal|1
operator|)
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|dp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
expr_stmt|;
name|shift
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|row_width
operator|&
literal|0x01
operator|)
operator|<<
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|value
operator|=
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x0f
expr_stmt|;
operator|*
name|dp
operator|=
operator|(
name|png_byte
operator|)
name|value
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|4
condition|)
block|{
name|shift
operator|=
literal|0
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
else|else
name|shift
operator|+=
literal|4
expr_stmt|;
name|dp
operator|--
expr_stmt|;
block|}
break|break;
block|}
default|default:
break|break;
block|}
name|row_info
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|8
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
expr_stmt|;
block|}
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
block|{
if|if
condition|(
name|trans_alpha
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
expr_stmt|;
name|dp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
name|row_width
operator|<<
literal|2
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
call|(
name|int
call|)
argument_list|(
operator|*
name|sp
argument_list|)
operator|>=
name|num_trans
condition|)
operator|*
name|dp
operator|--
operator|=
literal|0xff
expr_stmt|;
else|else
operator|*
name|dp
operator|--
operator|=
name|trans_alpha
index|[
operator|*
name|sp
index|]
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
name|palette
index|[
operator|*
name|sp
index|]
operator|.
name|blue
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
name|palette
index|[
operator|*
name|sp
index|]
operator|.
name|green
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
name|palette
index|[
operator|*
name|sp
index|]
operator|.
name|red
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
name|row_info
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|32
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|4
expr_stmt|;
name|row_info
operator|->
name|color_type
operator|=
literal|6
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|sp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
expr_stmt|;
name|dp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
name|row_width
operator|*
literal|3
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|dp
operator|--
operator|=
name|palette
index|[
operator|*
name|sp
index|]
operator|.
name|blue
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
name|palette
index|[
operator|*
name|sp
index|]
operator|.
name|green
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
name|palette
index|[
operator|*
name|sp
index|]
operator|.
name|red
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
name|row_info
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|24
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
operator|*
literal|3
expr_stmt|;
name|row_info
operator|->
name|color_type
operator|=
literal|2
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|3
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_function
begin_comment
comment|/* If the bit depth< 8, it is expanded to 8.  Also, if the already  * expanded transparency value is supplied, an alpha channel is built.  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_expand
name|png_do_expand
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|,
name|png_const_color_16p
name|trans_value
parameter_list|)
block|{
name|int
name|shift
decl_stmt|,
name|value
decl_stmt|;
name|png_bytep
name|sp
decl_stmt|,
name|dp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_expand"
argument_list|)
expr_stmt|;
block|{
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_GRAY
condition|)
block|{
name|png_uint_16
name|gray
init|=
call|(
name|png_uint_16
call|)
argument_list|(
name|trans_value
condition|?
name|trans_value
operator|->
name|gray
else|:
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|<
literal|8
condition|)
block|{
switch|switch
condition|(
name|row_info
operator|->
name|bit_depth
condition|)
block|{
case|case
literal|1
case|:
block|{
name|gray
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
name|gray
operator|&
literal|0x01
operator|)
operator|*
literal|0xff
argument_list|)
expr_stmt|;
name|sp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
operator|(
name|row_width
operator|-
literal|1
operator|)
operator|>>
literal|3
argument_list|)
expr_stmt|;
name|dp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
expr_stmt|;
name|shift
operator|=
literal|7
operator|-
call|(
name|int
call|)
argument_list|(
operator|(
name|row_width
operator|+
literal|7
operator|)
operator|&
literal|0x07
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x01
condition|)
operator|*
name|dp
operator|=
literal|0xff
expr_stmt|;
else|else
operator|*
name|dp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|7
condition|)
block|{
name|shift
operator|=
literal|0
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
else|else
name|shift
operator|++
expr_stmt|;
name|dp
operator|--
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|2
case|:
block|{
name|gray
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
name|gray
operator|&
literal|0x03
operator|)
operator|*
literal|0x55
argument_list|)
expr_stmt|;
name|sp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
operator|(
name|row_width
operator|-
literal|1
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|dp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
expr_stmt|;
name|shift
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
literal|3
operator|-
operator|(
operator|(
name|row_width
operator|+
literal|3
operator|)
operator|&
literal|0x03
operator|)
operator|)
operator|<<
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|value
operator|=
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x03
expr_stmt|;
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|value
operator||
operator|(
name|value
operator|<<
literal|2
operator|)
operator||
operator|(
name|value
operator|<<
literal|4
operator|)
operator||
operator|(
name|value
operator|<<
literal|6
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|6
condition|)
block|{
name|shift
operator|=
literal|0
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
else|else
name|shift
operator|+=
literal|2
expr_stmt|;
name|dp
operator|--
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
name|gray
operator|=
call|(
name|png_uint_16
call|)
argument_list|(
operator|(
name|gray
operator|&
literal|0x0f
operator|)
operator|*
literal|0x11
argument_list|)
expr_stmt|;
name|sp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
operator|(
name|row_width
operator|-
literal|1
operator|)
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|dp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
expr_stmt|;
name|shift
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
literal|1
operator|-
operator|(
operator|(
name|row_width
operator|+
literal|1
operator|)
operator|&
literal|0x01
operator|)
operator|)
operator|<<
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|value
operator|=
operator|(
operator|*
name|sp
operator|>>
name|shift
operator|)
operator|&
literal|0x0f
expr_stmt|;
operator|*
name|dp
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|value
operator||
operator|(
name|value
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|4
condition|)
block|{
name|shift
operator|=
literal|0
expr_stmt|;
name|sp
operator|--
expr_stmt|;
block|}
else|else
name|shift
operator|=
literal|4
expr_stmt|;
name|dp
operator|--
expr_stmt|;
block|}
break|break;
block|}
default|default:
break|break;
block|}
name|row_info
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
literal|8
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|row_width
expr_stmt|;
block|}
if|if
condition|(
name|trans_value
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|gray
operator|=
name|gray
operator|&
literal|0xff
expr_stmt|;
name|sp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_width
operator|-
literal|1
expr_stmt|;
name|dp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
name|row_width
operator|<<
literal|1
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|sp
operator|==
name|gray
condition|)
operator|*
name|dp
operator|--
operator|=
literal|0
expr_stmt|;
else|else
operator|*
name|dp
operator|--
operator|=
literal|0xff
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|16
condition|)
block|{
name|png_byte
name|gray_high
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|gray
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|png_byte
name|gray_low
init|=
call|(
name|png_byte
call|)
argument_list|(
name|gray
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|sp
operator|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
operator|-
literal|1
expr_stmt|;
name|dp
operator|=
name|row
operator|+
operator|(
name|row_info
operator|->
name|rowbytes
operator|<<
literal|1
operator|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|sp
operator|-
literal|1
operator|)
operator|==
name|gray_high
operator|&&
operator|*
operator|(
name|sp
operator|)
operator|==
name|gray_low
condition|)
block|{
operator|*
name|dp
operator|--
operator|=
literal|0
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
operator|*
name|dp
operator|--
operator|=
literal|0xff
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
literal|0xff
expr_stmt|;
block|}
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
block|}
block|}
name|row_info
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_GRAY_ALPHA
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|2
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|row_info
operator|->
name|bit_depth
operator|<<
literal|1
argument_list|)
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|PNG_ROWBYTES
argument_list|(
name|row_info
operator|->
name|pixel_depth
argument_list|,
name|row_width
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB
operator|&&
name|trans_value
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|png_byte
name|red
init|=
call|(
name|png_byte
call|)
argument_list|(
name|trans_value
operator|->
name|red
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|png_byte
name|green
init|=
call|(
name|png_byte
call|)
argument_list|(
name|trans_value
operator|->
name|green
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|png_byte
name|blue
init|=
call|(
name|png_byte
call|)
argument_list|(
name|trans_value
operator|->
name|blue
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|sp
operator|=
name|row
operator|+
operator|(
name|png_size_t
operator|)
name|row_info
operator|->
name|rowbytes
operator|-
literal|1
expr_stmt|;
name|dp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
name|row_width
operator|<<
literal|2
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|sp
operator|-
literal|2
operator|)
operator|==
name|red
operator|&&
operator|*
operator|(
name|sp
operator|-
literal|1
operator|)
operator|==
name|green
operator|&&
operator|*
operator|(
name|sp
operator|)
operator|==
name|blue
condition|)
operator|*
name|dp
operator|--
operator|=
literal|0
expr_stmt|;
else|else
operator|*
name|dp
operator|--
operator|=
literal|0xff
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|16
condition|)
block|{
name|png_byte
name|red_high
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|trans_value
operator|->
name|red
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|png_byte
name|green_high
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|trans_value
operator|->
name|green
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|png_byte
name|blue_high
init|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|trans_value
operator|->
name|blue
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|png_byte
name|red_low
init|=
call|(
name|png_byte
call|)
argument_list|(
name|trans_value
operator|->
name|red
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|png_byte
name|green_low
init|=
call|(
name|png_byte
call|)
argument_list|(
name|trans_value
operator|->
name|green
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|png_byte
name|blue_low
init|=
call|(
name|png_byte
call|)
argument_list|(
name|trans_value
operator|->
name|blue
operator|&
literal|0xff
argument_list|)
decl_stmt|;
name|sp
operator|=
name|row
operator|+
name|row_info
operator|->
name|rowbytes
operator|-
literal|1
expr_stmt|;
name|dp
operator|=
name|row
operator|+
call|(
name|png_size_t
call|)
argument_list|(
name|row_width
operator|<<
literal|3
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|sp
operator|-
literal|5
operator|)
operator|==
name|red_high
operator|&&
operator|*
operator|(
name|sp
operator|-
literal|4
operator|)
operator|==
name|red_low
operator|&&
operator|*
operator|(
name|sp
operator|-
literal|3
operator|)
operator|==
name|green_high
operator|&&
operator|*
operator|(
name|sp
operator|-
literal|2
operator|)
operator|==
name|green_low
operator|&&
operator|*
operator|(
name|sp
operator|-
literal|1
operator|)
operator|==
name|blue_high
operator|&&
operator|*
operator|(
name|sp
operator|)
operator|==
name|blue_low
condition|)
block|{
operator|*
name|dp
operator|--
operator|=
literal|0
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
operator|*
name|dp
operator|--
operator|=
literal|0xff
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
literal|0xff
expr_stmt|;
block|}
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
operator|*
name|dp
operator|--
operator|=
operator|*
name|sp
operator|--
expr_stmt|;
block|}
block|}
name|row_info
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_RGB_ALPHA
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|row_info
operator|->
name|bit_depth
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|PNG_ROWBYTES
argument_list|(
name|row_info
operator|->
name|pixel_depth
argument_list|,
name|row_width
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_READ_QUANTIZE_SUPPORTED
end_ifdef
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_quantize
name|png_do_quantize
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|,
name|png_const_bytep
name|palette_lookup
parameter_list|,
name|png_const_bytep
name|quantize_lookup
parameter_list|)
block|{
name|png_bytep
name|sp
decl_stmt|,
name|dp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_quantize"
argument_list|)
expr_stmt|;
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB
operator|&&
name|palette_lookup
condition|)
block|{
name|int
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|,
name|p
decl_stmt|;
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
operator|*
name|sp
operator|++
expr_stmt|;
name|g
operator|=
operator|*
name|sp
operator|++
expr_stmt|;
name|b
operator|=
operator|*
name|sp
operator|++
expr_stmt|;
comment|/* This looks real messy, but the compiler will reduce              * it down to a reasonable formula.  For example, with              * 5 bits per color, we get:              * p = (((r>> 3)& 0x1f)<< 10) |              *    (((g>> 3)& 0x1f)<< 5) |              *    ((b>> 3)& 0x1f);              */
name|p
operator|=
operator|(
operator|(
operator|(
name|r
operator|>>
operator|(
literal|8
operator|-
name|PNG_QUANTIZE_RED_BITS
operator|)
operator|)
operator|&
operator|(
operator|(
literal|1
operator|<<
name|PNG_QUANTIZE_RED_BITS
operator|)
operator|-
literal|1
operator|)
operator|)
operator|<<
operator|(
name|PNG_QUANTIZE_GREEN_BITS
operator|+
name|PNG_QUANTIZE_BLUE_BITS
operator|)
operator|)
operator||
operator|(
operator|(
operator|(
name|g
operator|>>
operator|(
literal|8
operator|-
name|PNG_QUANTIZE_GREEN_BITS
operator|)
operator|)
operator|&
operator|(
operator|(
literal|1
operator|<<
name|PNG_QUANTIZE_GREEN_BITS
operator|)
operator|-
literal|1
operator|)
operator|)
operator|<<
operator|(
name|PNG_QUANTIZE_BLUE_BITS
operator|)
operator|)
operator||
operator|(
operator|(
name|b
operator|>>
operator|(
literal|8
operator|-
name|PNG_QUANTIZE_BLUE_BITS
operator|)
operator|)
operator|&
operator|(
operator|(
literal|1
operator|<<
name|PNG_QUANTIZE_BLUE_BITS
operator|)
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
operator|*
name|dp
operator|++
operator|=
name|palette_lookup
index|[
name|p
index|]
expr_stmt|;
block|}
name|row_info
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_PALETTE
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|1
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
name|row_info
operator|->
name|bit_depth
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|PNG_ROWBYTES
argument_list|(
name|row_info
operator|->
name|pixel_depth
argument_list|,
name|row_width
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB_ALPHA
operator|&&
name|palette_lookup
operator|!=
name|NULL
condition|)
block|{
name|int
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|,
name|p
decl_stmt|;
name|sp
operator|=
name|row
expr_stmt|;
name|dp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
operator|*
name|sp
operator|++
expr_stmt|;
name|g
operator|=
operator|*
name|sp
operator|++
expr_stmt|;
name|b
operator|=
operator|*
name|sp
operator|++
expr_stmt|;
name|sp
operator|++
expr_stmt|;
name|p
operator|=
operator|(
operator|(
operator|(
name|r
operator|>>
operator|(
literal|8
operator|-
name|PNG_QUANTIZE_RED_BITS
operator|)
operator|)
operator|&
operator|(
operator|(
literal|1
operator|<<
name|PNG_QUANTIZE_RED_BITS
operator|)
operator|-
literal|1
operator|)
operator|)
operator|<<
operator|(
name|PNG_QUANTIZE_GREEN_BITS
operator|+
name|PNG_QUANTIZE_BLUE_BITS
operator|)
operator|)
operator||
operator|(
operator|(
operator|(
name|g
operator|>>
operator|(
literal|8
operator|-
name|PNG_QUANTIZE_GREEN_BITS
operator|)
operator|)
operator|&
operator|(
operator|(
literal|1
operator|<<
name|PNG_QUANTIZE_GREEN_BITS
operator|)
operator|-
literal|1
operator|)
operator|)
operator|<<
operator|(
name|PNG_QUANTIZE_BLUE_BITS
operator|)
operator|)
operator||
operator|(
operator|(
name|b
operator|>>
operator|(
literal|8
operator|-
name|PNG_QUANTIZE_BLUE_BITS
operator|)
operator|)
operator|&
operator|(
operator|(
literal|1
operator|<<
name|PNG_QUANTIZE_BLUE_BITS
operator|)
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
operator|*
name|dp
operator|++
operator|=
name|palette_lookup
index|[
name|p
index|]
expr_stmt|;
block|}
name|row_info
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_PALETTE
expr_stmt|;
name|row_info
operator|->
name|channels
operator|=
literal|1
expr_stmt|;
name|row_info
operator|->
name|pixel_depth
operator|=
name|row_info
operator|->
name|bit_depth
expr_stmt|;
name|row_info
operator|->
name|rowbytes
operator|=
name|PNG_ROWBYTES
argument_list|(
name|row_info
operator|->
name|pixel_depth
argument_list|,
name|row_width
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
operator|&&
name|quantize_lookup
condition|)
block|{
name|sp
operator|=
name|row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|sp
operator|++
control|)
block|{
operator|*
name|sp
operator|=
name|quantize_lookup
index|[
operator|*
name|sp
index|]
expr_stmt|;
block|}
block|}
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* PNG_READ_QUANTIZE_SUPPORTED */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_MNG_FEATURES_SUPPORTED
end_ifdef
begin_comment
comment|/* Undoes intrapixel differencing  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_do_read_intrapixel
name|png_do_read_intrapixel
parameter_list|(
name|png_row_infop
name|row_info
parameter_list|,
name|png_bytep
name|row
parameter_list|)
block|{
name|png_debug
argument_list|(
literal|1
argument_list|,
literal|"in png_do_read_intrapixel"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|row_info
operator|->
name|color_type
operator|&
name|PNG_COLOR_MASK_COLOR
operator|)
condition|)
block|{
name|int
name|bytes_per_pixel
decl_stmt|;
name|png_uint_32
name|row_width
init|=
name|row_info
operator|->
name|width
decl_stmt|;
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|8
condition|)
block|{
name|png_bytep
name|rp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB
condition|)
name|bytes_per_pixel
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB_ALPHA
condition|)
name|bytes_per_pixel
operator|=
literal|4
expr_stmt|;
else|else
return|return;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|rp
operator|=
name|row
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|rp
operator|+=
name|bytes_per_pixel
control|)
block|{
operator|*
operator|(
name|rp
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
literal|256
operator|+
operator|*
name|rp
operator|+
operator|*
operator|(
name|rp
operator|+
literal|1
operator|)
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|rp
operator|+
literal|2
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
literal|256
operator|+
operator|*
operator|(
name|rp
operator|+
literal|2
operator|)
operator|+
operator|*
operator|(
name|rp
operator|+
literal|1
operator|)
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|row_info
operator|->
name|bit_depth
operator|==
literal|16
condition|)
block|{
name|png_bytep
name|rp
decl_stmt|;
name|png_uint_32
name|i
decl_stmt|;
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB
condition|)
name|bytes_per_pixel
operator|=
literal|6
expr_stmt|;
elseif|else
if|if
condition|(
name|row_info
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_RGB_ALPHA
condition|)
name|bytes_per_pixel
operator|=
literal|8
expr_stmt|;
else|else
return|return;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|rp
operator|=
name|row
init|;
name|i
operator|<
name|row_width
condition|;
name|i
operator|++
operator|,
name|rp
operator|+=
name|bytes_per_pixel
control|)
block|{
name|png_uint_32
name|s0
init|=
operator|(
operator|*
operator|(
name|rp
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|rp
operator|+
literal|1
operator|)
decl_stmt|;
name|png_uint_32
name|s1
init|=
operator|(
operator|*
operator|(
name|rp
operator|+
literal|2
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|rp
operator|+
literal|3
operator|)
decl_stmt|;
name|png_uint_32
name|s2
init|=
operator|(
operator|*
operator|(
name|rp
operator|+
literal|4
operator|)
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|rp
operator|+
literal|5
operator|)
decl_stmt|;
name|png_uint_32
name|red
init|=
call|(
name|png_uint_32
call|)
argument_list|(
operator|(
name|s0
operator|+
name|s1
operator|+
literal|65536L
operator|)
operator|&
literal|0xffffL
argument_list|)
decl_stmt|;
name|png_uint_32
name|blue
init|=
call|(
name|png_uint_32
call|)
argument_list|(
operator|(
name|s2
operator|+
name|s1
operator|+
literal|65536L
operator|)
operator|&
literal|0xffffL
argument_list|)
decl_stmt|;
operator|*
operator|(
name|rp
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|red
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|rp
operator|+
literal|1
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|red
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|rp
operator|+
literal|4
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
operator|(
name|blue
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|rp
operator|+
literal|5
operator|)
operator|=
call|(
name|png_byte
call|)
argument_list|(
name|blue
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* PNG_MNG_FEATURES_SUPPORTED */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* PNG_READ_SUPPORTED */
end_comment
end_unit
