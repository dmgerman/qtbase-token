begin_unit
begin_comment
comment|/* pngwio.c - functions for data output  *  * Last changed in libpng 1.5.0 [January 6, 2011]  * Copyright (c) 1998-2011 Glenn Randers-Pehrson  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)  *  * This code is released under the libpng license.  * For conditions of distribution and use, see the disclaimer  * and license in png.h  *  * This file provides a location for all output.  Users who need  * special handling are expected to write functions that have the same  * arguments as these and perform similar functions, but that possibly  * use different output methods.  Note that you shouldn't change these  * functions, but rather write replacement functions and then change  * them at run time with png_set_write_fn(...).  */
end_comment
begin_include
include|#
directive|include
file|"pngpriv.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_WRITE_SUPPORTED
end_ifdef
begin_comment
comment|/* Write the data to whatever output you are using.  The default routine  * writes to a file pointer.  Note that this routine sometimes gets called  * with very small lengths, so you should implement some kind of simple  * buffering if you are using unbuffered writes.  This should never be asked  * to write more than 64K on a 16 bit machine.  */
end_comment
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_write_data
name|png_write_data
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_const_bytep
name|data
parameter_list|,
name|png_size_t
name|length
parameter_list|)
block|{
comment|/* NOTE: write_data_fn must not change the buffer! */
if|if
condition|(
name|png_ptr
operator|->
name|write_data_fn
operator|!=
name|NULL
condition|)
operator|(
operator|*
operator|(
name|png_ptr
operator|->
name|write_data_fn
operator|)
operator|)
operator|(
name|png_ptr
operator|,
operator|(
name|png_bytep
operator|)
name|data
operator|,
name|length
operator|)
expr_stmt|;
else|else
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"Call to NULL write function"
argument_list|)
expr_stmt|;
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_STDIO_SUPPORTED
end_ifdef
begin_comment
comment|/* This is the function that does the actual writing of data.  If you are  * not writing to a standard C stream, you should create a replacement  * write_data function and use it at run time with png_set_write_fn(), rather  * than changing the library.  */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|USE_FAR_KEYWORD
end_ifndef
begin_function
name|void
name|PNGCBAPI
DECL|function|png_default_write_data
name|png_default_write_data
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_bytep
name|data
parameter_list|,
name|png_size_t
name|length
parameter_list|)
block|{
name|png_size_t
name|check
decl_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|check
operator|=
name|fwrite
argument_list|(
name|data
argument_list|,
literal|1
argument_list|,
name|length
argument_list|,
call|(
name|png_FILE_p
call|)
argument_list|(
name|png_ptr
operator|->
name|io_ptr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|check
operator|!=
name|length
condition|)
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"Write Error"
argument_list|)
expr_stmt|;
block|}
end_function
begin_else
else|#
directive|else
end_else
begin_comment
comment|/* This is the model-independent version. Since the standard I/O library  * can't handle far buffers in the medium and small models, we have to copy  * the data.  */
end_comment
begin_define
DECL|macro|NEAR_BUF_SIZE
define|#
directive|define
name|NEAR_BUF_SIZE
value|1024
end_define
begin_define
DECL|macro|MIN
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(a<= b ? a : b)
end_define
begin_function
name|void
name|PNGCBAPI
DECL|function|png_default_write_data
name|png_default_write_data
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_bytep
name|data
parameter_list|,
name|png_size_t
name|length
parameter_list|)
block|{
name|png_uint_32
name|check
decl_stmt|;
name|png_byte
modifier|*
name|near_data
decl_stmt|;
comment|/* Needs to be "png_byte *" instead of "png_bytep" */
name|png_FILE_p
name|io_ptr
decl_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
comment|/* Check if data really is near. If so, use usual code. */
name|near_data
operator|=
operator|(
name|png_byte
operator|*
operator|)
name|CVT_PTR_NOCHECK
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|io_ptr
operator|=
operator|(
name|png_FILE_p
operator|)
name|CVT_PTR
argument_list|(
name|png_ptr
operator|->
name|io_ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|png_bytep
operator|)
name|near_data
operator|==
name|data
condition|)
block|{
name|check
operator|=
name|fwrite
argument_list|(
name|near_data
argument_list|,
literal|1
argument_list|,
name|length
argument_list|,
name|io_ptr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|png_byte
name|buf
index|[
name|NEAR_BUF_SIZE
index|]
decl_stmt|;
name|png_size_t
name|written
decl_stmt|,
name|remaining
decl_stmt|,
name|err
decl_stmt|;
name|check
operator|=
literal|0
expr_stmt|;
name|remaining
operator|=
name|length
expr_stmt|;
do|do
block|{
name|written
operator|=
name|MIN
argument_list|(
name|NEAR_BUF_SIZE
argument_list|,
name|remaining
argument_list|)
expr_stmt|;
name|png_memcpy
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|written
argument_list|)
expr_stmt|;
comment|/* Copy far buffer to near buffer */
name|err
operator|=
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|written
argument_list|,
name|io_ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|written
condition|)
break|break;
else|else
name|check
operator|+=
name|err
expr_stmt|;
name|data
operator|+=
name|written
expr_stmt|;
name|remaining
operator|-=
name|written
expr_stmt|;
block|}
do|while
condition|(
name|remaining
operator|!=
literal|0
condition|)
do|;
block|}
if|if
condition|(
name|check
operator|!=
name|length
condition|)
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"Write Error"
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* This function is called to output any data pending writing (normally  * to disk).  After png_flush is called, there should be no data pending  * writing in any buffers.  */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_WRITE_FLUSH_SUPPORTED
end_ifdef
begin_function
name|void
comment|/* PRIVATE */
DECL|function|png_flush
name|png_flush
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
if|if
condition|(
name|png_ptr
operator|->
name|output_flush_fn
operator|!=
name|NULL
condition|)
operator|(
operator|*
operator|(
name|png_ptr
operator|->
name|output_flush_fn
operator|)
operator|)
operator|(
name|png_ptr
operator|)
expr_stmt|;
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|PNG_STDIO_SUPPORTED
end_ifdef
begin_function
name|void
name|PNGCBAPI
DECL|function|png_default_flush
name|png_default_flush
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|)
block|{
name|png_FILE_p
name|io_ptr
decl_stmt|;
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|io_ptr
operator|=
operator|(
name|png_FILE_p
operator|)
name|CVT_PTR
argument_list|(
operator|(
name|png_ptr
operator|->
name|io_ptr
operator|)
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|io_ptr
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* This function allows the application to supply new output functions for  * libpng if standard C streams aren't being used.  *  * This function takes as its arguments:  * png_ptr       - pointer to a png output data structure  * io_ptr        - pointer to user supplied structure containing info about  *                 the output functions.  May be NULL.  * write_data_fn - pointer to a new output function that takes as its  *                 arguments a pointer to a png_struct, a pointer to  *                 data to be written, and a 32-bit unsigned int that is  *                 the number of bytes to be written.  The new write  *                 function should call png_error(png_ptr, "Error msg")  *                 to exit and output any fatal error messages.  May be  *                 NULL, in which case libpng's default function will  *                 be used.  * flush_data_fn - pointer to a new flush function that takes as its  *                 arguments a pointer to a png_struct.  After a call to  *                 the flush function, there should be no data in any buffers  *                 or pending transmission.  If the output method doesn't do  *                 any buffering of output, a function prototype must still be  *                 supplied although it doesn't have to do anything.  If  *                 PNG_WRITE_FLUSH_SUPPORTED is not defined at libpng compile  *                 time, output_flush_fn will be ignored, although it must be  *                 supplied for compatibility.  May be NULL, in which case  *                 libpng's default function will be used, if  *                 PNG_WRITE_FLUSH_SUPPORTED is defined.  This is not  *                 a good idea if io_ptr does not point to a standard  *                 *FILE structure.  */
end_comment
begin_function
name|void
name|PNGAPI
DECL|function|png_set_write_fn
name|png_set_write_fn
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_voidp
name|io_ptr
parameter_list|,
name|png_rw_ptr
name|write_data_fn
parameter_list|,
name|png_flush_ptr
name|output_flush_fn
parameter_list|)
block|{
if|if
condition|(
name|png_ptr
operator|==
name|NULL
condition|)
return|return;
name|png_ptr
operator|->
name|io_ptr
operator|=
name|io_ptr
expr_stmt|;
ifdef|#
directive|ifdef
name|PNG_STDIO_SUPPORTED
if|if
condition|(
name|write_data_fn
operator|!=
name|NULL
condition|)
name|png_ptr
operator|->
name|write_data_fn
operator|=
name|write_data_fn
expr_stmt|;
else|else
name|png_ptr
operator|->
name|write_data_fn
operator|=
name|png_default_write_data
expr_stmt|;
else|#
directive|else
name|png_ptr
operator|->
name|write_data_fn
operator|=
name|write_data_fn
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PNG_WRITE_FLUSH_SUPPORTED
ifdef|#
directive|ifdef
name|PNG_STDIO_SUPPORTED
if|if
condition|(
name|output_flush_fn
operator|!=
name|NULL
condition|)
name|png_ptr
operator|->
name|output_flush_fn
operator|=
name|output_flush_fn
expr_stmt|;
else|else
name|png_ptr
operator|->
name|output_flush_fn
operator|=
name|png_default_flush
expr_stmt|;
else|#
directive|else
name|png_ptr
operator|->
name|output_flush_fn
operator|=
name|output_flush_fn
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* PNG_WRITE_FLUSH_SUPPORTED */
comment|/* It is an error to read while writing a png file */
if|if
condition|(
name|png_ptr
operator|->
name|read_data_fn
operator|!=
name|NULL
condition|)
block|{
name|png_ptr
operator|->
name|read_data_fn
operator|=
name|NULL
expr_stmt|;
name|png_warning
argument_list|(
name|png_ptr
argument_list|,
literal|"Can't set both read_data_fn and write_data_fn in the"
literal|" same structure"
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|USE_FAR_KEYWORD
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|_MSC_VER
end_ifdef
begin_function
DECL|function|png_far_to_near
name|void
modifier|*
name|png_far_to_near
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_voidp
name|ptr
parameter_list|,
name|int
name|check
parameter_list|)
block|{
name|void
modifier|*
name|near_ptr
decl_stmt|;
name|void
name|FAR
modifier|*
name|far_ptr
decl_stmt|;
name|FP_OFF
argument_list|(
name|near_ptr
argument_list|)
operator|=
name|FP_OFF
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|far_ptr
operator|=
operator|(
name|void
name|FAR
operator|*
operator|)
name|near_ptr
expr_stmt|;
if|if
condition|(
name|check
operator|!=
literal|0
condition|)
if|if
condition|(
name|FP_SEG
argument_list|(
name|ptr
argument_list|)
operator|!=
name|FP_SEG
argument_list|(
name|far_ptr
argument_list|)
condition|)
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"segment lost in conversion"
argument_list|)
expr_stmt|;
return|return
operator|(
name|near_ptr
operator|)
return|;
block|}
end_function
begin_else
else|#
directive|else
end_else
begin_function
DECL|function|png_far_to_near
name|void
modifier|*
name|png_far_to_near
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_voidp
name|ptr
parameter_list|,
name|int
name|check
parameter_list|)
block|{
name|void
modifier|*
name|near_ptr
decl_stmt|;
name|void
name|FAR
modifier|*
name|far_ptr
decl_stmt|;
name|near_ptr
operator|=
operator|(
name|void
name|FAR
operator|*
operator|)
name|ptr
expr_stmt|;
name|far_ptr
operator|=
operator|(
name|void
name|FAR
operator|*
operator|)
name|near_ptr
expr_stmt|;
if|if
condition|(
name|check
operator|!=
literal|0
condition|)
if|if
condition|(
name|far_ptr
operator|!=
name|ptr
condition|)
name|png_error
argument_list|(
name|png_ptr
argument_list|,
literal|"segment lost in conversion"
argument_list|)
expr_stmt|;
return|return
operator|(
name|near_ptr
operator|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* PNG_WRITE_SUPPORTED */
end_comment
end_unit
