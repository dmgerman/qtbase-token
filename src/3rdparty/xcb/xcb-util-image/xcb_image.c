begin_unit
begin_comment
comment|/* Copyright Â© 2007 Bart Massey  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *   * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE  * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.  *   * Except as contained in this notice, the names of the authors or their  * institutions shall not be used in advertising or otherwise to promote the  * sale, use or other dealings in this Software without prior written  * authorization from the authors.  */
end_comment
begin_include
include|#
directive|include
file|<stdlib.h>
end_include
begin_include
include|#
directive|include
file|<stdio.h>
end_include
begin_include
include|#
directive|include
file|<string.h>
end_include
begin_include
include|#
directive|include
file|<xcb/xcb.h>
end_include
begin_include
include|#
directive|include
file|<xcb/shm.h>
end_include
begin_include
include|#
directive|include
file|<xcb/xcb_aux.h>
end_include
begin_include
include|#
directive|include
file|"xcb_bitops.h"
end_include
begin_include
include|#
directive|include
file|"xcb_image.h"
end_include
begin_define
DECL|macro|BUILD
define|#
directive|define
name|BUILD
end_define
begin_include
include|#
directive|include
file|"xcb_pixel.h"
end_include
begin_function
specifier|static
name|xcb_format_t
modifier|*
DECL|function|find_format_by_depth
name|find_format_by_depth
parameter_list|(
specifier|const
name|xcb_setup_t
modifier|*
name|setup
parameter_list|,
name|uint8_t
name|depth
parameter_list|)
block|{
name|xcb_format_t
modifier|*
name|fmt
init|=
name|xcb_setup_pixmap_formats
argument_list|(
name|setup
argument_list|)
decl_stmt|;
name|xcb_format_t
modifier|*
name|fmtend
init|=
name|fmt
operator|+
name|xcb_setup_pixmap_formats_length
argument_list|(
name|setup
argument_list|)
decl_stmt|;
for|for
control|(
init|;
name|fmt
operator|!=
name|fmtend
condition|;
operator|++
name|fmt
control|)
if|if
condition|(
name|fmt
operator|->
name|depth
operator|==
name|depth
condition|)
return|return
name|fmt
return|;
return|return
literal|0
return|;
block|}
end_function
begin_function
specifier|static
name|xcb_image_format_t
DECL|function|effective_format
name|effective_format
parameter_list|(
name|xcb_image_format_t
name|format
parameter_list|,
name|uint8_t
name|bpp
parameter_list|)
block|{
if|if
condition|(
name|format
operator|==
name|XCB_IMAGE_FORMAT_Z_PIXMAP
operator|&&
name|bpp
operator|!=
literal|1
condition|)
return|return
name|format
return|;
return|return
name|XCB_IMAGE_FORMAT_XY_PIXMAP
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|format_valid
name|format_valid
parameter_list|(
name|uint8_t
name|depth
parameter_list|,
name|uint8_t
name|bpp
parameter_list|,
name|uint8_t
name|unit
parameter_list|,
name|xcb_image_format_t
name|format
parameter_list|,
name|uint8_t
name|xpad
parameter_list|)
block|{
name|xcb_image_format_t
name|ef
init|=
name|effective_format
argument_list|(
name|format
argument_list|,
name|bpp
argument_list|)
decl_stmt|;
if|if
condition|(
name|depth
operator|>
name|bpp
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|ef
condition|)
block|{
case|case
name|XCB_IMAGE_FORMAT_XY_PIXMAP
case|:
switch|switch
condition|(
name|unit
condition|)
block|{
case|case
literal|8
case|:
case|case
literal|16
case|:
case|case
literal|32
case|:
break|break;
default|default:
return|return
literal|0
return|;
block|}
if|if
condition|(
name|xpad
operator|<
name|bpp
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|xpad
condition|)
block|{
case|case
literal|8
case|:
case|case
literal|16
case|:
case|case
literal|32
case|:
break|break;
default|default:
return|return
literal|0
return|;
block|}
break|break;
case|case
name|XCB_IMAGE_FORMAT_Z_PIXMAP
case|:
switch|switch
condition|(
name|bpp
condition|)
block|{
case|case
literal|4
case|:
if|if
condition|(
name|unit
operator|!=
literal|8
condition|)
return|return
literal|0
return|;
break|break;
case|case
literal|8
case|:
case|case
literal|16
case|:
case|case
literal|24
case|:
case|case
literal|32
case|:
if|if
condition|(
name|unit
operator|!=
name|bpp
condition|)
return|return
literal|0
return|;
break|break;
default|default:
return|return
literal|0
return|;
block|}
break|break;
default|default:
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|image_format_valid
name|image_format_valid
parameter_list|(
name|xcb_image_t
modifier|*
name|image
parameter_list|)
block|{
return|return
name|format_valid
argument_list|(
name|image
operator|->
name|depth
argument_list|,
name|image
operator|->
name|bpp
argument_list|,
name|image
operator|->
name|unit
argument_list|,
name|image
operator|->
name|format
argument_list|,
name|image
operator|->
name|scanline_pad
argument_list|)
return|;
block|}
end_function
begin_function
name|void
DECL|function|xcb_image_annotate
name|xcb_image_annotate
parameter_list|(
name|xcb_image_t
modifier|*
name|image
parameter_list|)
block|{
name|xcb_image_format_t
name|ef
init|=
name|effective_format
argument_list|(
name|image
operator|->
name|format
argument_list|,
name|image
operator|->
name|bpp
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ef
condition|)
block|{
case|case
name|XCB_IMAGE_FORMAT_XY_PIXMAP
case|:
name|image
operator|->
name|stride
operator|=
name|xcb_roundup
argument_list|(
name|image
operator|->
name|width
argument_list|,
name|image
operator|->
name|scanline_pad
argument_list|)
operator|>>
literal|3
expr_stmt|;
name|image
operator|->
name|size
operator|=
name|image
operator|->
name|height
operator|*
name|image
operator|->
name|stride
operator|*
name|image
operator|->
name|depth
expr_stmt|;
break|break;
case|case
name|XCB_IMAGE_FORMAT_Z_PIXMAP
case|:
name|image
operator|->
name|stride
operator|=
name|xcb_roundup
argument_list|(
operator|(
name|uint32_t
operator|)
name|image
operator|->
name|width
operator|*
operator|(
name|uint32_t
operator|)
name|image
operator|->
name|bpp
argument_list|,
name|image
operator|->
name|scanline_pad
argument_list|)
operator|>>
literal|3
expr_stmt|;
name|image
operator|->
name|size
operator|=
name|image
operator|->
name|height
operator|*
name|image
operator|->
name|stride
expr_stmt|;
break|break;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
name|xcb_image_t
modifier|*
DECL|function|xcb_image_create_native
name|xcb_image_create_native
parameter_list|(
name|xcb_connection_t
modifier|*
name|c
parameter_list|,
name|uint16_t
name|width
parameter_list|,
name|uint16_t
name|height
parameter_list|,
name|xcb_image_format_t
name|format
parameter_list|,
name|uint8_t
name|depth
parameter_list|,
name|void
modifier|*
name|base
parameter_list|,
name|uint32_t
name|bytes
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
specifier|const
name|xcb_setup_t
modifier|*
name|setup
init|=
name|xcb_get_setup
argument_list|(
name|c
argument_list|)
decl_stmt|;
name|xcb_format_t
modifier|*
name|fmt
decl_stmt|;
name|xcb_image_format_t
name|ef
init|=
name|format
decl_stmt|;
if|if
condition|(
name|ef
operator|==
name|XCB_IMAGE_FORMAT_Z_PIXMAP
operator|&&
name|depth
operator|==
literal|1
condition|)
name|ef
operator|=
name|XCB_IMAGE_FORMAT_XY_PIXMAP
expr_stmt|;
switch|switch
condition|(
name|ef
condition|)
block|{
case|case
name|XCB_IMAGE_FORMAT_XY_BITMAP
case|:
if|if
condition|(
name|depth
operator|!=
literal|1
condition|)
return|return
literal|0
return|;
comment|/* fall through */
case|case
name|XCB_IMAGE_FORMAT_XY_PIXMAP
case|:
if|if
condition|(
name|depth
operator|>
literal|1
condition|)
block|{
name|fmt
operator|=
name|find_format_by_depth
argument_list|(
name|setup
argument_list|,
name|depth
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fmt
condition|)
return|return
literal|0
return|;
block|}
return|return
name|xcb_image_create
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|format
argument_list|,
name|setup
operator|->
name|bitmap_format_scanline_pad
argument_list|,
name|depth
argument_list|,
name|depth
argument_list|,
name|setup
operator|->
name|bitmap_format_scanline_unit
argument_list|,
name|setup
operator|->
name|image_byte_order
argument_list|,
name|setup
operator|->
name|bitmap_format_bit_order
argument_list|,
name|base
argument_list|,
name|bytes
argument_list|,
name|data
argument_list|)
return|;
case|case
name|XCB_IMAGE_FORMAT_Z_PIXMAP
case|:
name|fmt
operator|=
name|find_format_by_depth
argument_list|(
name|setup
argument_list|,
name|depth
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fmt
condition|)
return|return
literal|0
return|;
return|return
name|xcb_image_create
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|format
argument_list|,
name|fmt
operator|->
name|scanline_pad
argument_list|,
name|fmt
operator|->
name|depth
argument_list|,
name|fmt
operator|->
name|bits_per_pixel
argument_list|,
literal|0
argument_list|,
name|setup
operator|->
name|image_byte_order
argument_list|,
name|XCB_IMAGE_ORDER_MSB_FIRST
argument_list|,
name|base
argument_list|,
name|bytes
argument_list|,
name|data
argument_list|)
return|;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
name|xcb_image_t
modifier|*
DECL|function|xcb_image_create
name|xcb_image_create
parameter_list|(
name|uint16_t
name|width
parameter_list|,
name|uint16_t
name|height
parameter_list|,
name|xcb_image_format_t
name|format
parameter_list|,
name|uint8_t
name|xpad
parameter_list|,
name|uint8_t
name|depth
parameter_list|,
name|uint8_t
name|bpp
parameter_list|,
name|uint8_t
name|unit
parameter_list|,
name|xcb_image_order_t
name|byte_order
parameter_list|,
name|xcb_image_order_t
name|bit_order
parameter_list|,
name|void
modifier|*
name|base
parameter_list|,
name|uint32_t
name|bytes
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
name|xcb_image_t
modifier|*
name|image
decl_stmt|;
if|if
condition|(
name|unit
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|format
condition|)
block|{
case|case
name|XCB_IMAGE_FORMAT_XY_BITMAP
case|:
case|case
name|XCB_IMAGE_FORMAT_XY_PIXMAP
case|:
name|unit
operator|=
literal|32
expr_stmt|;
break|break;
case|case
name|XCB_IMAGE_FORMAT_Z_PIXMAP
case|:
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
block|{
name|unit
operator|=
literal|32
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|bpp
operator|<
literal|8
condition|)
block|{
name|unit
operator|=
literal|8
expr_stmt|;
break|break;
block|}
name|unit
operator|=
name|bpp
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|format_valid
argument_list|(
name|depth
argument_list|,
name|bpp
argument_list|,
name|unit
argument_list|,
name|format
argument_list|,
name|xpad
argument_list|)
condition|)
return|return
literal|0
return|;
name|image
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|image
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|image
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|image
operator|->
name|width
operator|=
name|width
expr_stmt|;
name|image
operator|->
name|height
operator|=
name|height
expr_stmt|;
name|image
operator|->
name|format
operator|=
name|format
expr_stmt|;
name|image
operator|->
name|scanline_pad
operator|=
name|xpad
expr_stmt|;
name|image
operator|->
name|depth
operator|=
name|depth
expr_stmt|;
name|image
operator|->
name|bpp
operator|=
name|bpp
expr_stmt|;
name|image
operator|->
name|unit
operator|=
name|unit
expr_stmt|;
name|image
operator|->
name|plane_mask
operator|=
name|xcb_mask
argument_list|(
name|depth
argument_list|)
expr_stmt|;
name|image
operator|->
name|byte_order
operator|=
name|byte_order
expr_stmt|;
name|image
operator|->
name|bit_order
operator|=
name|bit_order
expr_stmt|;
name|xcb_image_annotate
argument_list|(
name|image
argument_list|)
expr_stmt|;
comment|/*    * Ways this function can be called:    *   * with data: we fail if bytes isn't    *     large enough, else leave well enough alone.    *   * with base and !data: if bytes is zero, we    *     default; otherwise we fail if bytes isn't    *     large enough, else fill in data    *   * with !base and !data: we malloc storage    *     for the data, save that address as the base,    *     and fail if malloc does.    *    * When successful, we establish the invariant that data    * points at sufficient storage that may have been    * supplied, and base is set iff it should be    * auto-freed when the image is destroyed.    *     * Except as a special case when base = 0&& data == 0&&    * bytes == ~0 we just return the image structure and let    * the caller deal with getting the allocation right.    */
if|if
condition|(
operator|!
name|base
operator|&&
operator|!
name|data
operator|&&
name|bytes
operator|==
operator|~
literal|0
condition|)
block|{
name|image
operator|->
name|base
operator|=
literal|0
expr_stmt|;
name|image
operator|->
name|data
operator|=
literal|0
expr_stmt|;
return|return
name|image
return|;
block|}
if|if
condition|(
operator|!
name|base
operator|&&
name|data
operator|&&
name|bytes
operator|==
literal|0
condition|)
name|bytes
operator|=
name|image
operator|->
name|size
expr_stmt|;
name|image
operator|->
name|base
operator|=
name|base
expr_stmt|;
name|image
operator|->
name|data
operator|=
name|data
expr_stmt|;
if|if
condition|(
operator|!
name|image
operator|->
name|data
condition|)
block|{
if|if
condition|(
name|image
operator|->
name|base
condition|)
block|{
name|image
operator|->
name|data
operator|=
name|image
operator|->
name|base
expr_stmt|;
block|}
else|else
block|{
name|bytes
operator|=
name|image
operator|->
name|size
expr_stmt|;
name|image
operator|->
name|base
operator|=
name|malloc
argument_list|(
name|bytes
argument_list|)
expr_stmt|;
name|image
operator|->
name|data
operator|=
name|image
operator|->
name|base
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|image
operator|->
name|data
operator|||
name|bytes
operator|<
name|image
operator|->
name|size
condition|)
block|{
name|free
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|image
return|;
block|}
end_function
begin_function
name|void
DECL|function|xcb_image_destroy
name|xcb_image_destroy
parameter_list|(
name|xcb_image_t
modifier|*
name|image
parameter_list|)
block|{
if|if
condition|(
name|image
operator|->
name|base
condition|)
name|free
argument_list|(
name|image
operator|->
name|base
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|image
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
name|xcb_image_t
modifier|*
DECL|function|xcb_image_get
name|xcb_image_get
parameter_list|(
name|xcb_connection_t
modifier|*
name|conn
parameter_list|,
name|xcb_drawable_t
name|draw
parameter_list|,
name|int16_t
name|x
parameter_list|,
name|int16_t
name|y
parameter_list|,
name|uint16_t
name|width
parameter_list|,
name|uint16_t
name|height
parameter_list|,
name|uint32_t
name|plane_mask
parameter_list|,
name|xcb_image_format_t
name|format
parameter_list|)
block|{
name|xcb_get_image_cookie_t
name|image_cookie
decl_stmt|;
name|xcb_get_image_reply_t
modifier|*
name|imrep
decl_stmt|;
name|xcb_image_t
modifier|*
name|image
init|=
literal|0
decl_stmt|;
name|uint32_t
name|bytes
decl_stmt|;
name|uint8_t
modifier|*
name|data
decl_stmt|;
name|image_cookie
operator|=
name|xcb_get_image
argument_list|(
name|conn
argument_list|,
name|format
argument_list|,
name|draw
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|plane_mask
argument_list|)
expr_stmt|;
name|imrep
operator|=
name|xcb_get_image_reply
argument_list|(
name|conn
argument_list|,
name|image_cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|imrep
condition|)
return|return
literal|0
return|;
name|bytes
operator|=
name|xcb_get_image_data_length
argument_list|(
name|imrep
argument_list|)
expr_stmt|;
name|data
operator|=
name|xcb_get_image_data
argument_list|(
name|imrep
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|format
condition|)
block|{
case|case
name|XCB_IMAGE_FORMAT_XY_PIXMAP
case|:
name|plane_mask
operator|&=
name|xcb_mask
argument_list|(
name|imrep
operator|->
name|depth
argument_list|)
expr_stmt|;
if|if
condition|(
name|plane_mask
operator|!=
name|xcb_mask
argument_list|(
name|imrep
operator|->
name|depth
argument_list|)
condition|)
block|{
name|xcb_image_t
modifier|*
name|tmp_image
init|=
name|xcb_image_create_native
argument_list|(
name|conn
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|format
argument_list|,
name|imrep
operator|->
name|depth
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|tmp_image
condition|)
block|{
name|free
argument_list|(
name|imrep
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|int
name|i
decl_stmt|;
name|uint32_t
name|rpm
init|=
name|plane_mask
decl_stmt|;
name|uint8_t
modifier|*
name|src_plane
init|=
name|image
operator|->
name|data
decl_stmt|;
name|uint8_t
modifier|*
name|dst_plane
init|=
name|tmp_image
operator|->
name|data
decl_stmt|;
name|uint32_t
name|size
init|=
name|image
operator|->
name|height
operator|*
name|image
operator|->
name|stride
decl_stmt|;
if|if
condition|(
name|tmp_image
operator|->
name|bit_order
operator|==
name|XCB_IMAGE_ORDER_MSB_FIRST
condition|)
name|rpm
operator|=
name|xcb_bit_reverse
argument_list|(
name|plane_mask
argument_list|,
name|imrep
operator|->
name|depth
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|imrep
operator|->
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rpm
operator|&
literal|1
condition|)
block|{
name|memcpy
argument_list|(
name|dst_plane
argument_list|,
name|src_plane
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|src_plane
operator|+=
name|size
expr_stmt|;
block|}
else|else
block|{
name|memset
argument_list|(
name|dst_plane
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
name|dst_plane
operator|+=
name|size
expr_stmt|;
block|}
name|tmp_image
operator|->
name|plane_mask
operator|=
name|plane_mask
expr_stmt|;
name|image
operator|=
name|tmp_image
expr_stmt|;
name|free
argument_list|(
name|imrep
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* fall through */
case|case
name|XCB_IMAGE_FORMAT_Z_PIXMAP
case|:
name|image
operator|=
name|xcb_image_create_native
argument_list|(
name|conn
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|format
argument_list|,
name|imrep
operator|->
name|depth
argument_list|,
name|imrep
argument_list|,
name|bytes
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|image
condition|)
block|{
name|free
argument_list|(
name|imrep
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
break|break;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|assert
argument_list|(
name|bytes
operator|==
name|image
operator|->
name|size
argument_list|)
expr_stmt|;
return|return
name|image
return|;
block|}
end_function
begin_function
name|xcb_image_t
modifier|*
DECL|function|xcb_image_native
name|xcb_image_native
parameter_list|(
name|xcb_connection_t
modifier|*
name|c
parameter_list|,
name|xcb_image_t
modifier|*
name|image
parameter_list|,
name|int
name|convert
parameter_list|)
block|{
name|xcb_image_t
modifier|*
name|tmp_image
init|=
literal|0
decl_stmt|;
specifier|const
name|xcb_setup_t
modifier|*
name|setup
init|=
name|xcb_get_setup
argument_list|(
name|c
argument_list|)
decl_stmt|;
name|xcb_format_t
modifier|*
name|fmt
init|=
literal|0
decl_stmt|;
name|xcb_image_format_t
name|ef
init|=
name|effective_format
argument_list|(
name|image
operator|->
name|format
argument_list|,
name|image
operator|->
name|bpp
argument_list|)
decl_stmt|;
name|uint8_t
name|bpp
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|image
operator|->
name|depth
operator|>
literal|1
operator|||
name|ef
operator|==
name|XCB_IMAGE_FORMAT_Z_PIXMAP
condition|)
block|{
name|fmt
operator|=
name|find_format_by_depth
argument_list|(
name|setup
argument_list|,
name|image
operator|->
name|depth
argument_list|)
expr_stmt|;
comment|/* XXX For now, we don't do depth conversions, even 	 for xy-pixmaps */
if|if
condition|(
operator|!
name|fmt
condition|)
return|return
literal|0
return|;
name|bpp
operator|=
name|fmt
operator|->
name|bits_per_pixel
expr_stmt|;
block|}
switch|switch
condition|(
name|ef
condition|)
block|{
case|case
name|XCB_IMAGE_FORMAT_XY_PIXMAP
case|:
if|if
condition|(
name|setup
operator|->
name|bitmap_format_scanline_unit
operator|!=
name|image
operator|->
name|unit
operator|||
name|setup
operator|->
name|bitmap_format_scanline_pad
operator|!=
name|image
operator|->
name|scanline_pad
operator|||
name|setup
operator|->
name|image_byte_order
operator|!=
name|image
operator|->
name|byte_order
operator|||
name|setup
operator|->
name|bitmap_format_bit_order
operator|!=
name|image
operator|->
name|bit_order
operator|||
name|bpp
operator|!=
name|image
operator|->
name|bpp
condition|)
block|{
if|if
condition|(
operator|!
name|convert
condition|)
return|return
literal|0
return|;
name|tmp_image
operator|=
name|xcb_image_create
argument_list|(
name|image
operator|->
name|width
argument_list|,
name|image
operator|->
name|height
argument_list|,
name|image
operator|->
name|format
argument_list|,
name|setup
operator|->
name|bitmap_format_scanline_pad
argument_list|,
name|image
operator|->
name|depth
argument_list|,
name|bpp
argument_list|,
name|setup
operator|->
name|bitmap_format_scanline_unit
argument_list|,
name|setup
operator|->
name|image_byte_order
argument_list|,
name|setup
operator|->
name|bitmap_format_bit_order
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp_image
condition|)
return|return
literal|0
return|;
block|}
break|break;
case|case
name|XCB_IMAGE_FORMAT_Z_PIXMAP
case|:
if|if
condition|(
name|fmt
operator|->
name|scanline_pad
operator|!=
name|image
operator|->
name|scanline_pad
operator|||
name|setup
operator|->
name|image_byte_order
operator|!=
name|image
operator|->
name|byte_order
operator|||
name|bpp
operator|!=
name|image
operator|->
name|bpp
condition|)
block|{
if|if
condition|(
operator|!
name|convert
condition|)
return|return
literal|0
return|;
name|tmp_image
operator|=
name|xcb_image_create
argument_list|(
name|image
operator|->
name|width
argument_list|,
name|image
operator|->
name|height
argument_list|,
name|image
operator|->
name|format
argument_list|,
name|fmt
operator|->
name|scanline_pad
argument_list|,
name|image
operator|->
name|depth
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|setup
operator|->
name|image_byte_order
argument_list|,
name|XCB_IMAGE_ORDER_MSB_FIRST
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp_image
condition|)
return|return
literal|0
return|;
block|}
break|break;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tmp_image
condition|)
block|{
if|if
condition|(
operator|!
name|xcb_image_convert
argument_list|(
name|image
argument_list|,
name|tmp_image
argument_list|)
condition|)
block|{
name|xcb_image_destroy
argument_list|(
name|tmp_image
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|image
operator|=
name|tmp_image
expr_stmt|;
block|}
return|return
name|image
return|;
block|}
end_function
begin_function
name|xcb_void_cookie_t
DECL|function|xcb_image_put
name|xcb_image_put
parameter_list|(
name|xcb_connection_t
modifier|*
name|conn
parameter_list|,
name|xcb_drawable_t
name|draw
parameter_list|,
name|xcb_gcontext_t
name|gc
parameter_list|,
name|xcb_image_t
modifier|*
name|image
parameter_list|,
name|int16_t
name|x
parameter_list|,
name|int16_t
name|y
parameter_list|,
name|uint8_t
name|left_pad
parameter_list|)
block|{
return|return
name|xcb_put_image
argument_list|(
name|conn
argument_list|,
name|image
operator|->
name|format
argument_list|,
name|draw
argument_list|,
name|gc
argument_list|,
name|image
operator|->
name|width
argument_list|,
name|image
operator|->
name|height
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|left_pad
argument_list|,
name|image
operator|->
name|depth
argument_list|,
name|image
operator|->
name|size
argument_list|,
name|image
operator|->
name|data
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/*  * Shm stuff  */
end_comment
begin_function
name|xcb_image_t
modifier|*
DECL|function|xcb_image_shm_put
name|xcb_image_shm_put
parameter_list|(
name|xcb_connection_t
modifier|*
name|conn
parameter_list|,
name|xcb_drawable_t
name|draw
parameter_list|,
name|xcb_gcontext_t
name|gc
parameter_list|,
name|xcb_image_t
modifier|*
name|image
parameter_list|,
name|xcb_shm_segment_info_t
name|shminfo
parameter_list|,
name|int16_t
name|src_x
parameter_list|,
name|int16_t
name|src_y
parameter_list|,
name|int16_t
name|dest_x
parameter_list|,
name|int16_t
name|dest_y
parameter_list|,
name|uint16_t
name|src_width
parameter_list|,
name|uint16_t
name|src_height
parameter_list|,
name|uint8_t
name|send_event
parameter_list|)
block|{
if|if
condition|(
operator|!
name|xcb_image_native
argument_list|(
name|conn
argument_list|,
name|image
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|shminfo
operator|.
name|shmaddr
condition|)
return|return
literal|0
return|;
name|xcb_shm_put_image
argument_list|(
name|conn
argument_list|,
name|draw
argument_list|,
name|gc
argument_list|,
name|image
operator|->
name|width
argument_list|,
name|image
operator|->
name|height
argument_list|,
name|src_x
argument_list|,
name|src_y
argument_list|,
name|src_width
argument_list|,
name|src_height
argument_list|,
name|dest_x
argument_list|,
name|dest_y
argument_list|,
name|image
operator|->
name|depth
argument_list|,
name|image
operator|->
name|format
argument_list|,
name|send_event
argument_list|,
name|shminfo
operator|.
name|shmseg
argument_list|,
name|image
operator|->
name|data
operator|-
name|shminfo
operator|.
name|shmaddr
argument_list|)
expr_stmt|;
return|return
name|image
return|;
block|}
end_function
begin_function
name|int
DECL|function|xcb_image_shm_get
name|xcb_image_shm_get
parameter_list|(
name|xcb_connection_t
modifier|*
name|conn
parameter_list|,
name|xcb_drawable_t
name|draw
parameter_list|,
name|xcb_image_t
modifier|*
name|image
parameter_list|,
name|xcb_shm_segment_info_t
name|shminfo
parameter_list|,
name|int16_t
name|x
parameter_list|,
name|int16_t
name|y
parameter_list|,
name|uint32_t
name|plane_mask
parameter_list|)
block|{
name|xcb_shm_get_image_reply_t
modifier|*
name|setup
decl_stmt|;
name|xcb_shm_get_image_cookie_t
name|cookie
decl_stmt|;
name|xcb_generic_error_t
modifier|*
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|shminfo
operator|.
name|shmaddr
condition|)
return|return
literal|0
return|;
name|cookie
operator|=
name|xcb_shm_get_image
argument_list|(
name|conn
argument_list|,
name|draw
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|image
operator|->
name|width
argument_list|,
name|image
operator|->
name|height
argument_list|,
name|plane_mask
argument_list|,
name|image
operator|->
name|format
argument_list|,
name|shminfo
operator|.
name|shmseg
argument_list|,
name|image
operator|->
name|data
operator|-
name|shminfo
operator|.
name|shmaddr
argument_list|)
expr_stmt|;
name|setup
operator|=
name|xcb_shm_get_image_reply
argument_list|(
name|conn
argument_list|,
name|cookie
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ShmGetImageReply error %d\n"
argument_list|,
operator|(
name|int
operator|)
name|err
operator|->
name|error_code
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|free
argument_list|(
name|setup
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
end_function
begin_function
specifier|static
name|uint32_t
DECL|function|xy_image_byte
name|xy_image_byte
parameter_list|(
name|xcb_image_t
modifier|*
name|image
parameter_list|,
name|uint32_t
name|x
parameter_list|)
block|{
name|x
operator|>>=
literal|3
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|byte_order
operator|==
name|image
operator|->
name|bit_order
condition|)
return|return
name|x
return|;
switch|switch
condition|(
name|image
operator|->
name|unit
condition|)
block|{
default|default:
case|case
literal|8
case|:
return|return
name|x
return|;
case|case
literal|16
case|:
return|return
name|x
operator|^
literal|1
return|;
case|case
literal|32
case|:
return|return
name|x
operator|^
literal|3
return|;
block|}
block|}
end_function
begin_function
specifier|static
name|uint32_t
DECL|function|xy_image_bit
name|xy_image_bit
parameter_list|(
name|xcb_image_t
modifier|*
name|image
parameter_list|,
name|uint32_t
name|x
parameter_list|)
block|{
name|x
operator|&=
literal|7
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|bit_order
operator|==
name|XCB_IMAGE_ORDER_MSB_FIRST
condition|)
name|x
operator|=
literal|7
operator|-
name|x
expr_stmt|;
return|return
name|x
return|;
block|}
end_function
begin_comment
comment|/* GetPixel/PutPixel */
end_comment
begin_comment
comment|/* XXX this is the most hideously done cut-and-paste    to below.  Any bugs fixed there should be fixed here    and vice versa. */
end_comment
begin_function
name|void
DECL|function|xcb_image_put_pixel
name|xcb_image_put_pixel
parameter_list|(
name|xcb_image_t
modifier|*
name|image
parameter_list|,
name|uint32_t
name|x
parameter_list|,
name|uint32_t
name|y
parameter_list|,
name|uint32_t
name|pixel
parameter_list|)
block|{
name|uint8_t
modifier|*
name|row
decl_stmt|;
if|if
condition|(
name|x
operator|>
name|image
operator|->
name|width
operator|||
name|y
operator|>
name|image
operator|->
name|height
condition|)
return|return;
name|row
operator|=
name|image
operator|->
name|data
operator|+
operator|(
name|y
operator|*
name|image
operator|->
name|stride
operator|)
expr_stmt|;
switch|switch
condition|(
name|effective_format
argument_list|(
name|image
operator|->
name|format
argument_list|,
name|image
operator|->
name|bpp
argument_list|)
condition|)
block|{
case|case
name|XCB_IMAGE_FORMAT_XY_BITMAP
case|:
case|case
name|XCB_IMAGE_FORMAT_XY_PIXMAP
case|:
comment|/* block */
block|{
name|int
name|p
decl_stmt|;
name|uint32_t
name|plane_mask
init|=
name|image
operator|->
name|plane_mask
decl_stmt|;
name|uint8_t
modifier|*
name|plane
init|=
name|row
decl_stmt|;
name|uint32_t
name|byte
init|=
name|xy_image_byte
argument_list|(
name|image
argument_list|,
name|x
argument_list|)
decl_stmt|;
name|uint32_t
name|bit
init|=
name|xy_image_bit
argument_list|(
name|image
argument_list|,
name|x
argument_list|)
decl_stmt|;
name|uint8_t
name|mask
init|=
literal|1
operator|<<
name|bit
decl_stmt|;
for|for
control|(
name|p
operator|=
name|image
operator|->
name|bpp
operator|-
literal|1
init|;
name|p
operator|>=
literal|0
condition|;
name|p
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|plane_mask
operator|>>
name|p
operator|)
operator|&
literal|1
condition|)
block|{
name|uint8_t
modifier|*
name|bp
init|=
name|plane
operator|+
name|byte
decl_stmt|;
name|uint8_t
name|this_bit
init|=
operator|(
operator|(
name|pixel
operator|>>
name|p
operator|)
operator|&
literal|1
operator|)
operator|<<
name|bit
decl_stmt|;
operator|*
name|bp
operator|=
operator|(
operator|*
name|bp
operator|&
operator|~
name|mask
operator|)
operator||
name|this_bit
expr_stmt|;
block|}
name|plane
operator|+=
name|image
operator|->
name|stride
operator|*
name|image
operator|->
name|height
expr_stmt|;
block|}
block|}
break|break;
case|case
name|XCB_IMAGE_FORMAT_Z_PIXMAP
case|:
switch|switch
condition|(
name|image
operator|->
name|bpp
condition|)
block|{
name|uint32_t
name|mask
decl_stmt|;
case|case
literal|4
case|:
name|mask
operator|=
literal|0xf
expr_stmt|;
name|pixel
operator|&=
literal|0xf
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|&
literal|1
operator|)
operator|==
operator|(
name|image
operator|->
name|byte_order
operator|==
name|XCB_IMAGE_ORDER_MSB_FIRST
operator|)
condition|)
block|{
name|pixel
operator|<<=
literal|4
expr_stmt|;
name|mask
operator|<<=
literal|4
expr_stmt|;
block|}
name|row
index|[
name|x
operator|>>
literal|1
index|]
operator|=
operator|(
name|row
index|[
name|x
operator|>>
literal|1
index|]
operator|&
operator|~
name|mask
operator|)
operator||
name|pixel
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|row
index|[
name|x
index|]
operator|=
name|pixel
expr_stmt|;
break|break;
case|case
literal|16
case|:
switch|switch
condition|(
name|image
operator|->
name|byte_order
condition|)
block|{
case|case
name|XCB_IMAGE_ORDER_LSB_FIRST
case|:
name|row
index|[
name|x
operator|<<
literal|1
index|]
operator|=
name|pixel
expr_stmt|;
name|row
index|[
operator|(
name|x
operator|<<
literal|1
operator|)
operator|+
literal|1
index|]
operator|=
name|pixel
operator|>>
literal|8
expr_stmt|;
break|break;
case|case
name|XCB_IMAGE_ORDER_MSB_FIRST
case|:
name|row
index|[
name|x
operator|<<
literal|1
index|]
operator|=
name|pixel
operator|>>
literal|8
expr_stmt|;
name|row
index|[
operator|(
name|x
operator|<<
literal|1
operator|)
operator|+
literal|1
index|]
operator|=
name|pixel
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|24
case|:
switch|switch
condition|(
name|image
operator|->
name|byte_order
condition|)
block|{
case|case
name|XCB_IMAGE_ORDER_LSB_FIRST
case|:
name|row
index|[
name|x
operator|*
literal|3
index|]
operator|=
name|pixel
expr_stmt|;
name|row
index|[
name|x
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|pixel
operator|>>
literal|8
expr_stmt|;
name|row
index|[
name|x
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|pixel
operator|>>
literal|16
expr_stmt|;
break|break;
case|case
name|XCB_IMAGE_ORDER_MSB_FIRST
case|:
name|row
index|[
name|x
operator|*
literal|3
index|]
operator|=
name|pixel
operator|>>
literal|16
expr_stmt|;
name|row
index|[
name|x
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|pixel
operator|>>
literal|8
expr_stmt|;
name|row
index|[
name|x
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|pixel
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|32
case|:
switch|switch
condition|(
name|image
operator|->
name|byte_order
condition|)
block|{
case|case
name|XCB_IMAGE_ORDER_LSB_FIRST
case|:
name|row
index|[
name|x
operator|<<
literal|2
index|]
operator|=
name|pixel
expr_stmt|;
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|1
index|]
operator|=
name|pixel
operator|>>
literal|8
expr_stmt|;
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|2
index|]
operator|=
name|pixel
operator|>>
literal|16
expr_stmt|;
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|3
index|]
operator|=
name|pixel
operator|>>
literal|24
expr_stmt|;
break|break;
case|case
name|XCB_IMAGE_ORDER_MSB_FIRST
case|:
name|row
index|[
name|x
operator|<<
literal|2
index|]
operator|=
name|pixel
operator|>>
literal|24
expr_stmt|;
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|1
index|]
operator|=
name|pixel
operator|>>
literal|16
expr_stmt|;
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|2
index|]
operator|=
name|pixel
operator|>>
literal|8
expr_stmt|;
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|3
index|]
operator|=
name|pixel
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_comment
comment|/* XXX this is the most hideously done cut-and-paste    from above.  Any bugs fixed there should be fixed here    and vice versa. */
end_comment
begin_function
name|uint32_t
DECL|function|xcb_image_get_pixel
name|xcb_image_get_pixel
parameter_list|(
name|xcb_image_t
modifier|*
name|image
parameter_list|,
name|uint32_t
name|x
parameter_list|,
name|uint32_t
name|y
parameter_list|)
block|{
name|uint32_t
name|pixel
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|row
decl_stmt|;
name|assert
argument_list|(
name|x
operator|<
name|image
operator|->
name|width
operator|&&
name|y
operator|<
name|image
operator|->
name|height
argument_list|)
expr_stmt|;
name|row
operator|=
name|image
operator|->
name|data
operator|+
operator|(
name|y
operator|*
name|image
operator|->
name|stride
operator|)
expr_stmt|;
switch|switch
condition|(
name|effective_format
argument_list|(
name|image
operator|->
name|format
argument_list|,
name|image
operator|->
name|bpp
argument_list|)
condition|)
block|{
case|case
name|XCB_IMAGE_FORMAT_XY_BITMAP
case|:
case|case
name|XCB_IMAGE_FORMAT_XY_PIXMAP
case|:
comment|/* block */
block|{
name|int
name|p
decl_stmt|;
name|uint32_t
name|plane_mask
init|=
name|image
operator|->
name|plane_mask
decl_stmt|;
name|uint8_t
modifier|*
name|plane
init|=
name|row
decl_stmt|;
name|uint32_t
name|byte
init|=
name|xy_image_byte
argument_list|(
name|image
argument_list|,
name|x
argument_list|)
decl_stmt|;
name|uint32_t
name|bit
init|=
name|xy_image_bit
argument_list|(
name|image
argument_list|,
name|x
argument_list|)
decl_stmt|;
for|for
control|(
name|p
operator|=
name|image
operator|->
name|bpp
operator|-
literal|1
init|;
name|p
operator|>=
literal|0
condition|;
name|p
operator|--
control|)
block|{
name|pixel
operator|<<=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|plane_mask
operator|>>
name|p
operator|)
operator|&
literal|1
condition|)
block|{
name|uint8_t
modifier|*
name|bp
init|=
name|plane
operator|+
name|byte
decl_stmt|;
name|pixel
operator||=
operator|(
operator|*
name|bp
operator|>>
name|bit
operator|)
operator|&
literal|1
expr_stmt|;
block|}
name|plane
operator|+=
name|image
operator|->
name|stride
operator|*
name|image
operator|->
name|height
expr_stmt|;
block|}
block|}
return|return
name|pixel
return|;
case|case
name|XCB_IMAGE_FORMAT_Z_PIXMAP
case|:
switch|switch
condition|(
name|image
operator|->
name|bpp
condition|)
block|{
case|case
literal|4
case|:
if|if
condition|(
operator|(
name|x
operator|&
literal|1
operator|)
operator|==
operator|(
name|image
operator|->
name|byte_order
operator|==
name|XCB_IMAGE_ORDER_MSB_FIRST
operator|)
condition|)
return|return
name|row
index|[
name|x
operator|>>
literal|1
index|]
operator|>>
literal|4
return|;
return|return
name|row
index|[
name|x
operator|>>
literal|1
index|]
operator|&
literal|0xf
return|;
case|case
literal|8
case|:
return|return
name|row
index|[
name|x
index|]
return|;
case|case
literal|16
case|:
switch|switch
condition|(
name|image
operator|->
name|byte_order
condition|)
block|{
case|case
name|XCB_IMAGE_ORDER_LSB_FIRST
case|:
name|pixel
operator|=
name|row
index|[
name|x
operator|<<
literal|1
index|]
expr_stmt|;
name|pixel
operator||=
name|row
index|[
operator|(
name|x
operator|<<
literal|1
operator|)
operator|+
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
break|break;
case|case
name|XCB_IMAGE_ORDER_MSB_FIRST
case|:
name|pixel
operator|=
name|row
index|[
name|x
operator|<<
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|pixel
operator||=
name|row
index|[
operator|(
name|x
operator|<<
literal|1
operator|)
operator|+
literal|1
index|]
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|24
case|:
switch|switch
condition|(
name|image
operator|->
name|byte_order
condition|)
block|{
case|case
name|XCB_IMAGE_ORDER_LSB_FIRST
case|:
name|pixel
operator|=
name|row
index|[
name|x
operator|*
literal|3
index|]
expr_stmt|;
name|pixel
operator||=
name|row
index|[
name|x
operator|*
literal|3
operator|+
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|pixel
operator||=
name|row
index|[
name|x
operator|*
literal|3
operator|+
literal|2
index|]
operator|<<
literal|16
expr_stmt|;
break|break;
case|case
name|XCB_IMAGE_ORDER_MSB_FIRST
case|:
name|pixel
operator|=
name|row
index|[
name|x
operator|*
literal|3
index|]
operator|<<
literal|16
expr_stmt|;
name|pixel
operator||=
name|row
index|[
name|x
operator|*
literal|3
operator|+
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|pixel
operator||=
name|row
index|[
name|x
operator|*
literal|3
operator|+
literal|2
index|]
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|32
case|:
switch|switch
condition|(
name|image
operator|->
name|byte_order
condition|)
block|{
case|case
name|XCB_IMAGE_ORDER_LSB_FIRST
case|:
name|pixel
operator|=
name|row
index|[
name|x
operator|<<
literal|2
index|]
expr_stmt|;
name|pixel
operator||=
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|pixel
operator||=
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|2
index|]
operator|<<
literal|16
expr_stmt|;
name|pixel
operator||=
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|3
index|]
operator|<<
literal|24
expr_stmt|;
break|break;
case|case
name|XCB_IMAGE_ORDER_MSB_FIRST
case|:
name|pixel
operator|=
name|row
index|[
name|x
operator|<<
literal|2
index|]
operator|<<
literal|24
expr_stmt|;
name|pixel
operator||=
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|1
index|]
operator|<<
literal|16
expr_stmt|;
name|pixel
operator||=
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|2
index|]
operator|<<
literal|8
expr_stmt|;
name|pixel
operator||=
name|row
index|[
operator|(
name|x
operator|<<
literal|2
operator|)
operator|+
literal|3
index|]
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
name|pixel
return|;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
name|xcb_image_t
modifier|*
DECL|function|xcb_image_create_from_bitmap_data
name|xcb_image_create_from_bitmap_data
parameter_list|(
name|uint8_t
modifier|*
name|data
parameter_list|,
name|uint32_t
name|width
parameter_list|,
name|uint32_t
name|height
parameter_list|)
block|{
return|return
name|xcb_image_create
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|XCB_IMAGE_FORMAT_XY_PIXMAP
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
name|XCB_IMAGE_ORDER_LSB_FIRST
argument_list|,
name|XCB_IMAGE_ORDER_LSB_FIRST
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|data
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/*  * (Adapted from libX11.)  *  * xcb_create_pixmap_from_bitmap_data: Routine to make a pixmap of  *      given depth from user supplied bitmap data.  *	D is any drawable on the same screen that the pixmap will be used in.  *	Data is a pointer to the bit data, and   *	width& height give the size in bits of the pixmap.  *  * The following format is assumed for data:  *  *    format=XY (will use XYPixmap for depth 1 and XYBitmap for larger)  *    bit_order=LSBFirst  *    padding=8  *    bitmap_unit=8  */
end_comment
begin_function
name|xcb_pixmap_t
DECL|function|xcb_create_pixmap_from_bitmap_data
name|xcb_create_pixmap_from_bitmap_data
parameter_list|(
name|xcb_connection_t
modifier|*
name|display
parameter_list|,
name|xcb_drawable_t
name|d
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|uint32_t
name|width
parameter_list|,
name|uint32_t
name|height
parameter_list|,
name|uint32_t
name|depth
parameter_list|,
name|uint32_t
name|fg
parameter_list|,
name|uint32_t
name|bg
parameter_list|,
name|xcb_gcontext_t
modifier|*
name|gcp
parameter_list|)
block|{
name|xcb_pixmap_t
name|pix
decl_stmt|;
name|xcb_image_t
modifier|*
name|image
decl_stmt|;
name|xcb_image_t
modifier|*
name|final_image
decl_stmt|;
name|xcb_gcontext_t
name|gc
decl_stmt|;
name|uint32_t
name|mask
init|=
literal|0
decl_stmt|;
name|xcb_params_gc_t
name|gcv
decl_stmt|;
name|image
operator|=
name|xcb_image_create_from_bitmap_data
argument_list|(
name|data
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|image
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|depth
operator|>
literal|1
condition|)
name|image
operator|->
name|format
operator|=
name|XCB_IMAGE_FORMAT_XY_BITMAP
expr_stmt|;
name|final_image
operator|=
name|xcb_image_native
argument_list|(
name|display
argument_list|,
name|image
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|final_image
condition|)
block|{
name|xcb_image_destroy
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pix
operator|=
name|xcb_generate_id
argument_list|(
name|display
argument_list|)
expr_stmt|;
name|xcb_create_pixmap
argument_list|(
name|display
argument_list|,
name|depth
argument_list|,
name|pix
argument_list|,
name|d
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|gc
operator|=
name|xcb_generate_id
argument_list|(
name|display
argument_list|)
expr_stmt|;
name|XCB_AUX_ADD_PARAM
argument_list|(
operator|&
name|mask
argument_list|,
operator|&
name|gcv
argument_list|,
name|foreground
argument_list|,
name|fg
argument_list|)
expr_stmt|;
name|XCB_AUX_ADD_PARAM
argument_list|(
operator|&
name|mask
argument_list|,
operator|&
name|gcv
argument_list|,
name|background
argument_list|,
name|bg
argument_list|)
expr_stmt|;
name|xcb_aux_create_gc
argument_list|(
name|display
argument_list|,
name|gc
argument_list|,
name|pix
argument_list|,
name|mask
argument_list|,
operator|&
name|gcv
argument_list|)
expr_stmt|;
name|xcb_image_put
argument_list|(
name|display
argument_list|,
name|pix
argument_list|,
name|gc
argument_list|,
name|final_image
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|final_image
operator|!=
name|image
condition|)
name|xcb_image_destroy
argument_list|(
name|final_image
argument_list|)
expr_stmt|;
name|xcb_image_destroy
argument_list|(
name|image
argument_list|)
expr_stmt|;
if|if
condition|(
name|gcp
condition|)
operator|*
name|gcp
operator|=
name|gc
expr_stmt|;
else|else
name|xcb_free_gc
argument_list|(
name|display
argument_list|,
name|gc
argument_list|)
expr_stmt|;
return|return
name|pix
return|;
block|}
end_function
begin_comment
comment|/* Thanks to Keith Packard<keithp@keithp.com> for this code */
end_comment
begin_function
specifier|static
name|void
DECL|function|swap_image
name|swap_image
parameter_list|(
name|uint8_t
modifier|*
name|src
parameter_list|,
name|uint32_t
name|src_stride
parameter_list|,
name|uint8_t
modifier|*
name|dst
parameter_list|,
name|uint32_t
name|dst_stride
parameter_list|,
name|uint32_t
name|height
parameter_list|,
name|uint32_t
name|byteswap
parameter_list|,
name|int
name|bitswap
parameter_list|,
name|int
name|nibbleswap
parameter_list|)
block|{
while|while
condition|(
name|height
operator|--
condition|)
block|{
name|uint32_t
name|s
decl_stmt|;
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<
name|src_stride
condition|;
name|s
operator|++
control|)
block|{
name|uint8_t
name|b
decl_stmt|;
name|uint32_t
name|d
init|=
name|s
operator|^
name|byteswap
decl_stmt|;
if|if
condition|(
name|d
operator|>
name|dst_stride
condition|)
continue|continue;
name|b
operator|=
name|src
index|[
name|s
index|]
expr_stmt|;
if|if
condition|(
name|bitswap
condition|)
name|b
operator|=
name|xcb_bit_reverse
argument_list|(
name|b
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|nibbleswap
condition|)
name|b
operator|=
operator|(
name|b
operator|<<
literal|4
operator|)
operator||
operator|(
name|b
operator|>>
literal|4
operator|)
expr_stmt|;
name|dst
index|[
name|d
index|]
operator|=
name|b
expr_stmt|;
block|}
name|src
operator|+=
name|src_stride
expr_stmt|;
name|dst
operator|+=
name|dst_stride
expr_stmt|;
block|}
block|}
end_function
begin_comment
comment|/* Which order are bytes in (low two bits), given  * code which accesses an image one byte at a time  */
end_comment
begin_function
specifier|static
name|uint32_t
DECL|function|byte_order
name|byte_order
parameter_list|(
name|xcb_image_t
modifier|*
name|i
parameter_list|)
block|{
name|uint32_t
name|flip
init|=
name|i
operator|->
name|byte_order
operator|==
name|XCB_IMAGE_ORDER_MSB_FIRST
decl_stmt|;
switch|switch
condition|(
name|i
operator|->
name|bpp
condition|)
block|{
default|default:
case|case
literal|8
case|:
return|return
literal|0
return|;
case|case
literal|16
case|:
return|return
name|flip
return|;
case|case
literal|32
case|:
return|return
name|flip
operator||
operator|(
name|flip
operator|<<
literal|1
operator|)
return|;
block|}
block|}
end_function
begin_function
specifier|static
name|uint32_t
DECL|function|bit_order
name|bit_order
parameter_list|(
name|xcb_image_t
modifier|*
name|i
parameter_list|)
block|{
name|uint32_t
name|flip
init|=
name|i
operator|->
name|byte_order
operator|!=
name|i
operator|->
name|bit_order
decl_stmt|;
switch|switch
condition|(
name|i
operator|->
name|unit
condition|)
block|{
default|default:
case|case
literal|8
case|:
return|return
literal|0
return|;
case|case
literal|16
case|:
return|return
name|flip
return|;
case|case
literal|32
case|:
return|return
name|flip
operator||
operator|(
name|flip
operator|<<
literal|1
operator|)
return|;
block|}
block|}
end_function
begin_comment
comment|/* Convert from one byte order to another by flipping the   * low two bits of the byte index along a scanline  */
end_comment
begin_function
specifier|static
name|uint32_t
DECL|function|conversion_byte_swap
name|conversion_byte_swap
parameter_list|(
name|xcb_image_t
modifier|*
name|src
parameter_list|,
name|xcb_image_t
modifier|*
name|dst
parameter_list|)
block|{
name|xcb_image_format_t
name|ef
init|=
name|effective_format
argument_list|(
name|src
operator|->
name|format
argument_list|,
name|src
operator|->
name|bpp
argument_list|)
decl_stmt|;
comment|/* src_ef == dst_ef in all callers of this function */
if|if
condition|(
name|ef
operator|==
name|XCB_IMAGE_FORMAT_XY_PIXMAP
condition|)
block|{
return|return
name|bit_order
argument_list|(
name|src
argument_list|)
operator|^
name|bit_order
argument_list|(
name|dst
argument_list|)
return|;
block|}
else|else
block|{
comment|/* src_bpp == dst_bpp in all callers of this function */
return|return
name|byte_order
argument_list|(
name|src
argument_list|)
operator|^
name|byte_order
argument_list|(
name|dst
argument_list|)
return|;
block|}
block|}
end_function
begin_function
name|xcb_image_t
modifier|*
DECL|function|xcb_image_convert
name|xcb_image_convert
parameter_list|(
name|xcb_image_t
modifier|*
name|src
parameter_list|,
name|xcb_image_t
modifier|*
name|dst
parameter_list|)
block|{
name|xcb_image_format_t
name|ef
init|=
name|effective_format
argument_list|(
name|src
operator|->
name|format
argument_list|,
name|src
operator|->
name|bpp
argument_list|)
decl_stmt|;
comment|/* Things will go horribly wrong here if a bad      image is passed in, so we check some things      up front just to be nice. */
name|assert
argument_list|(
name|image_format_valid
argument_list|(
name|src
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|image_format_valid
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
comment|/* images must be the same size    * (yes, we could copy a sub-set)    */
if|if
condition|(
name|src
operator|->
name|width
operator|!=
name|dst
operator|->
name|width
operator|||
name|src
operator|->
name|height
operator|!=
name|dst
operator|->
name|height
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ef
operator|==
name|effective_format
argument_list|(
name|dst
operator|->
name|format
argument_list|,
name|dst
operator|->
name|bpp
argument_list|)
operator|&&
name|src
operator|->
name|bpp
operator|==
name|dst
operator|->
name|bpp
condition|)
block|{
if|if
condition|(
name|src
operator|->
name|unit
operator|==
name|dst
operator|->
name|unit
operator|&&
name|src
operator|->
name|scanline_pad
operator|==
name|dst
operator|->
name|scanline_pad
operator|&&
name|src
operator|->
name|byte_order
operator|==
name|dst
operator|->
name|byte_order
operator|&&
operator|(
name|ef
operator|==
name|XCB_IMAGE_FORMAT_Z_PIXMAP
operator|||
name|src
operator|->
name|bit_order
operator|==
name|dst
operator|->
name|bit_order
operator|)
condition|)
block|{
name|memcpy
argument_list|(
name|dst
operator|->
name|data
argument_list|,
name|src
operator|->
name|data
argument_list|,
name|src
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|bitswap
init|=
literal|0
decl_stmt|;
name|int
name|nibbleswap
init|=
literal|0
decl_stmt|;
name|uint32_t
name|byteswap
init|=
name|conversion_byte_swap
argument_list|(
name|src
argument_list|,
name|dst
argument_list|)
decl_stmt|;
name|uint32_t
name|height
init|=
name|src
operator|->
name|height
decl_stmt|;
empty_stmt|;
if|if
condition|(
name|ef
operator|==
name|XCB_IMAGE_FORMAT_Z_PIXMAP
condition|)
block|{
if|if
condition|(
name|src
operator|->
name|bpp
operator|==
literal|4
operator|&&
name|src
operator|->
name|byte_order
operator|!=
name|dst
operator|->
name|byte_order
condition|)
name|nibbleswap
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|src
operator|->
name|bit_order
operator|!=
name|dst
operator|->
name|bit_order
condition|)
name|bitswap
operator|=
literal|1
expr_stmt|;
name|height
operator|*=
name|src
operator|->
name|depth
expr_stmt|;
block|}
name|swap_image
argument_list|(
name|src
operator|->
name|data
argument_list|,
name|src
operator|->
name|stride
argument_list|,
name|dst
operator|->
name|data
argument_list|,
name|dst
operator|->
name|stride
argument_list|,
name|height
argument_list|,
name|byteswap
argument_list|,
name|bitswap
argument_list|,
name|nibbleswap
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|uint32_t
name|x
decl_stmt|;
name|uint32_t
name|y
decl_stmt|;
comment|/* General case: Slow pixel copy. Should we optimize        Z24<->Z32 copies of either endianness? */
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|src
operator|->
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|src
operator|->
name|width
condition|;
name|x
operator|++
control|)
block|{
name|uint32_t
name|pixel
init|=
name|xcb_image_get_pixel
argument_list|(
name|src
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
decl_stmt|;
name|xcb_image_put_pixel
argument_list|(
name|dst
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|dst
return|;
block|}
end_function
begin_function
name|xcb_image_t
modifier|*
DECL|function|xcb_image_subimage
name|xcb_image_subimage
parameter_list|(
name|xcb_image_t
modifier|*
name|image
parameter_list|,
name|uint32_t
name|x
parameter_list|,
name|uint32_t
name|y
parameter_list|,
name|uint32_t
name|width
parameter_list|,
name|uint32_t
name|height
parameter_list|,
name|void
modifier|*
name|base
parameter_list|,
name|uint32_t
name|bytes
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|xcb_image_t
modifier|*
name|result
decl_stmt|;
if|if
condition|(
name|x
operator|+
name|width
operator|>
name|image
operator|->
name|width
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|y
operator|+
name|height
operator|>
name|image
operator|->
name|height
condition|)
return|return
literal|0
return|;
name|result
operator|=
name|xcb_image_create
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|image
operator|->
name|format
argument_list|,
name|image
operator|->
name|scanline_pad
argument_list|,
name|image
operator|->
name|depth
argument_list|,
name|image
operator|->
name|bpp
argument_list|,
name|image
operator|->
name|unit
argument_list|,
name|image
operator|->
name|byte_order
argument_list|,
name|image
operator|->
name|bit_order
argument_list|,
name|base
argument_list|,
name|bytes
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
return|return
literal|0
return|;
comment|/* XXX FIXME  For now, lose on performance. Sorry. */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|height
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|width
condition|;
name|i
operator|++
control|)
block|{
name|uint32_t
name|pixel
init|=
name|xcb_image_get_pixel
argument_list|(
name|image
argument_list|,
name|x
operator|+
name|i
argument_list|,
name|y
operator|+
name|j
argument_list|)
decl_stmt|;
name|xcb_image_put_pixel
argument_list|(
name|result
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
end_function
end_unit
