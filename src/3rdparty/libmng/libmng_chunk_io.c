begin_unit
begin_comment
comment|/** ************************************************************************* */
end_comment
begin_comment
comment|/* *             For conditions of distribution and use,                    * */
end_comment
begin_comment
comment|/* *                see copyright notice in libmng.h                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * project   : libmng                                                     * */
end_comment
begin_comment
comment|/* * file      : libmng_chunk_io.c         copyright (c) 2000-2007 G.Juyn   * */
end_comment
begin_comment
comment|/* * version   : 1.0.10                                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * purpose   : Chunk I/O routines (implementation)                        * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * author    : G.Juyn                                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * comment   : implementation of chunk input/output routines              * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * changes   : 0.5.1 - 05/01/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - cleaned up left-over teststuff in the BACK chunk routine * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/04/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed CRC initialization to use dynamic structure      * */
end_comment
begin_comment
comment|/* *               (wasn't thread-safe the old way !)                       * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/06/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - filled in many missing sequence&length checks            * */
end_comment
begin_comment
comment|/* *             - filled in many missing chunk-store snippets              * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/08/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added checks for running animations                      * */
end_comment
begin_comment
comment|/* *             - filled some write routines                               * */
end_comment
begin_comment
comment|/* *             - changed strict-ANSI stuff                                * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/10/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - filled some more write routines                          * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/11/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - filled remaining write routines                          * */
end_comment
begin_comment
comment|/* *             - fixed read_pplt with regard to deltatype                 * */
end_comment
begin_comment
comment|/* *             - added callback error-reporting support                   * */
end_comment
begin_comment
comment|/* *             - added pre-draft48 support (short MHDR, frame_mode, LOOP) * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/12/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed trace to macro for callback error-reporting      * */
end_comment
begin_comment
comment|/* *             - fixed chunk-storage bit in several routines              * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/13/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added eMNGma hack (will be removed in 1.0.0 !!!)         * */
end_comment
begin_comment
comment|/* *             - added TERM animation object pointer (easier reference)   * */
end_comment
begin_comment
comment|/* *             - supplemented the SAVE& SEEK display processing          * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/18/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B004 - fixed problem with MNG_SUPPORT_WRITE not defined  * */
end_comment
begin_comment
comment|/* *               also for MNG_SUPPORT_WRITE without MNG_INCLUDE_JNG       * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/19/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - cleaned up some code regarding mixed support             * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/20/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - implemented JNG support                                  * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/24/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for global color-chunks in animation       * */
end_comment
begin_comment
comment|/* *             - added support for global PLTE,tRNS,bKGD in animation     * */
end_comment
begin_comment
comment|/* *             - added support for SAVE& SEEK in animation               * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/29/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed ani_create calls not returning object pointer    * */
end_comment
begin_comment
comment|/* *             - create ani objects always (not just inside TERM/LOOP)    * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/30/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for delta-image processing                 * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/31/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed up punctuation (contributed by Tim Rowley)         * */
end_comment
begin_comment
comment|/* *             0.5.2 - 06/02/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed SWAP_ENDIAN to BIGENDIAN_SUPPORTED               * */
end_comment
begin_comment
comment|/* *             0.5.2 - 06/03/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed makeup for Linux gcc compile                       * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/12/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added processing of color-info on delta-image            * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/13/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed handling of empty SAVE chunk                       * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/17/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed to support delta-images                          * */
end_comment
begin_comment
comment|/* *             - added extra checks for delta-images                      * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/20/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed possible trouble if IEND display-process got       * */
end_comment
begin_comment
comment|/* *               broken up                                                * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/21/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added processing of PLTE& tRNS for delta-images         * */
end_comment
begin_comment
comment|/* *             - added administration of imagelevel parameter             * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/22/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - implemented support for PPLT chunk                       * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/26/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added precaution against faulty iCCP chunks from PS      * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/29/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed some 64-bit warnings                               * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/14/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed pre-draft48 frame_mode=3 to frame_mode=1         * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed storage of images during mng_read()                * */
end_comment
begin_comment
comment|/* *             - fixed support for mng_display() after mng_read()         * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/19/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed several chunk-writing routines                     * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/24/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed reading of still-images                            * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.2 - 08/05/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed file-prefixes                                    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/07/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B111300 - fixup for improved portability                 * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/08/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed compiler-warnings from Mozilla                     * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/09/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added check for simplicity-bits in MHDR                  * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/12/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed check for simplicity-bits in MHDR (JNG)            * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/12/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added workaround for faulty PhotoShop iCCP chunk         * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/22/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed write-code for zTXt& iTXt                         * */
end_comment
begin_comment
comment|/* *             - fixed read-code for iTXt                                 * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/26/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added MAGN chunk                                         * */
end_comment
begin_comment
comment|/* *             0.9.3 - 09/07/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for new filter_types                       * */
end_comment
begin_comment
comment|/* *             0.9.3 - 09/10/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed DEFI behavior                                      * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/02/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed simplicity-check in compliance with draft 81/0.98a * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/10/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for alpha-depth prediction                 * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/11/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for nEED                                   * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for JDAA                                   * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/17/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed support for MAGN                                   * */
end_comment
begin_comment
comment|/* *             - implemented nEED "xxxx" (where "xxxx" is a chunkid)      * */
end_comment
begin_comment
comment|/* *             - added callback to process non-critical unknown chunks    * */
end_comment
begin_comment
comment|/* *             - fixed support for bKGD                                   * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/23/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed bug in empty PLTE handling                         * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.4 - 11/20/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed IHDR filter_method check for PNGs                * */
end_comment
begin_comment
comment|/* *             0.9.4 -  1/18/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added errorchecking for MAGN methods                     * */
end_comment
begin_comment
comment|/* *             - removed test filter-methods 1& 65                       * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.5 -  1/25/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed some small compiler warnings (thanks Nikki)        * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.2 - 05/05/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B421427 - writes wrong format in bKGD and tRNS           * */
end_comment
begin_comment
comment|/* *             1.0.2 - 06/20/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B434583 - compiler-warning if MNG_STORE_CHUNKS undefined * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.5 - 07/08/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B578572 - removed eMNGma hack (thanks Dimitri!)          * */
end_comment
begin_comment
comment|/* *             1.0.5 - 08/07/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added test-option for PNG filter method 193 (=no filter) * */
end_comment
begin_comment
comment|/* *             1.0.5 - 08/15/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - completed PROM support                                   * */
end_comment
begin_comment
comment|/* *             1.0.5 - 08/19/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B597134 - libmng pollutes the linker namespace           * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/07/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed reading of FRAM with just frame_mode and name      * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/13/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed read/write of MAGN chunk                           * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/14/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added event handling for dynamic MNG                     * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/15/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed LOOP iteration=0 special case                      * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/19/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - misplaced TERM is now treated as warning                 * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/20/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for PAST                                   * */
end_comment
begin_comment
comment|/* *             1.0.5 - 10/03/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed chunk-storage for evNT chunk                       * */
end_comment
begin_comment
comment|/* *             1.0.5 - 10/07/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed DISC support                                       * */
end_comment
begin_comment
comment|/* *             - added another fix for misplaced TERM chunk               * */
end_comment
begin_comment
comment|/* *             1.0.5 - 10/17/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed initializtion of pIds in dISC read routine         * */
end_comment
begin_comment
comment|/* *             1.0.5 - 11/06/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for nEED "MNG 1.1"                         * */
end_comment
begin_comment
comment|/* *             - added support for nEED "CACHEOFF"                        * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.6 - 05/25/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added MNG_SKIPCHUNK_cHNK footprint optimizations         * */
end_comment
begin_comment
comment|/* *             1.0.6 - 06/02/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - removed some redundant checks for iRawlen==0             * */
end_comment
begin_comment
comment|/* *             1.0.6 - 06/22/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added MNG_NO_16BIT_SUPPORT, MNG_NO_DELTA_PNG reductions  * */
end_comment
begin_comment
comment|/* *             - optionally use zlib's crc32 function instead of          * */
end_comment
begin_comment
comment|/* *               local mng_update_crc                                     * */
end_comment
begin_comment
comment|/* *             1.0.6 - 07/14/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added MNG_NO_LOOP_SIGNALS_SUPPORTED conditional          * */
end_comment
begin_comment
comment|/* *             1.0.6 - 07/29/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added conditionals around PAST chunk support             * */
end_comment
begin_comment
comment|/* *             1.0.6 - 08/17/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added conditionals around non-VLC chunk support          * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.7 - 10/29/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - revised JDAA and JDAT readers to avoid compiler bug      * */
end_comment
begin_comment
comment|/* *             1.0.7 - 01/25/2004 - J.S                                   * */
end_comment
begin_comment
comment|/* *             - added premultiplied alpha canvas' for RGBA, ARGB, ABGR   * */
end_comment
begin_comment
comment|/* *             1.0.7 - 01/27/2004 - J.S                                   * */
end_comment
begin_comment
comment|/* *             - fixed inclusion of IJNG chunk for non-JNG use            * */
end_comment
begin_comment
comment|/* *             1.0.7 - 02/26/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed bug in chunk-storage of SHOW chunk (from == to)    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.8 - 04/02/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added CRC existence& checking flags                     * */
end_comment
begin_comment
comment|/* *             1.0.8 - 07/07/2004 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - change worst-case iAlphadepth to 1 for standalone PNGs   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.9 - 09/28/2004 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - improved handling of cheap transparency when 16-bit      * */
end_comment
begin_comment
comment|/* *               support is disabled                                      * */
end_comment
begin_comment
comment|/* *             1.0.9 - 10/04/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed bug in writing sBIT for indexed color              * */
end_comment
begin_comment
comment|/* *             1.0.9 - 10/10/2004 - G.R-P.                                * */
end_comment
begin_comment
comment|/* *             - added MNG_NO_1_2_4BIT_SUPPORT                            * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/05/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added conditional MNG_OPTIMIZE_CHUNKINITFREE             * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/06/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added conditional MNG_OPTIMIZE_CHUNKASSIGN               * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/07/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added conditional MNG_OPTIMIZE_CHUNKREADER               * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/11/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added conditional MNG_OPTIMIZE_DISPLAYCALLS              * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/20/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - cleaned up macro-invocations (thanks to D. Airlie)       * */
end_comment
begin_comment
comment|/* *             1.0.9 - 01/17/2005 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed problem with global PLTE/tRNS                      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.10 - 02/07/2005 - G.Juyn                               * */
end_comment
begin_comment
comment|/* *             - fixed display routines called twice for FULL_MNG         * */
end_comment
begin_comment
comment|/* *               support in mozlibmngconf.h                               * */
end_comment
begin_comment
comment|/* *             1.0.10 - 12/04/2005 - G.R-P.                               * */
end_comment
begin_comment
comment|/* *             - #ifdef out use of mng_inflate_buffer when it is not      * */
end_comment
begin_comment
comment|/* *               available.                                               * */
end_comment
begin_comment
comment|/* *             1.0.10 - 04/08/2007 - G.Juyn                               * */
end_comment
begin_comment
comment|/* *             - added support for mPNG proposal                          * */
end_comment
begin_comment
comment|/* *             1.0.10 - 04/12/2007 - G.Juyn                               * */
end_comment
begin_comment
comment|/* *             - added support for ANG proposal                           * */
end_comment
begin_comment
comment|/* *             1.0.10 - 05/02/2007 - G.Juyn                               * */
end_comment
begin_comment
comment|/* *             - fixed inflate_buffer for extreme compression ratios      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_include
include|#
directive|include
file|"libmng.h"
end_include
begin_include
include|#
directive|include
file|"libmng_data.h"
end_include
begin_include
include|#
directive|include
file|"libmng_error.h"
end_include
begin_include
include|#
directive|include
file|"libmng_trace.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|__BORLANDC__
end_ifdef
begin_pragma
pragma|#
directive|pragma
name|hdrstop
end_pragma
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"libmng_objects.h"
end_include
begin_include
include|#
directive|include
file|"libmng_object_prc.h"
end_include
begin_include
include|#
directive|include
file|"libmng_chunks.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_CHECK_BAD_ICCP
end_ifdef
begin_include
include|#
directive|include
file|"libmng_chunk_prc.h"
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"libmng_memory.h"
end_include
begin_include
include|#
directive|include
file|"libmng_display.h"
end_include
begin_include
include|#
directive|include
file|"libmng_zlib.h"
end_include
begin_include
include|#
directive|include
file|"libmng_pixels.h"
end_include
begin_include
include|#
directive|include
file|"libmng_chunk_io.h"
end_include
begin_if
if|#
directive|if
name|defined
argument_list|(
name|__BORLANDC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_STRICT_ANSI
argument_list|)
end_if
begin_pragma
pragma|#
directive|pragma
name|option
name|-
name|A
end_pragma
begin_comment
comment|/* force ANSI-C */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * CRC - Cyclic Redundancy Check                                          * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * The code below is taken directly from the sample provided with the     * */
end_comment
begin_comment
comment|/* * PNG specification.                                                     * */
end_comment
begin_comment
comment|/* * (it is only adapted to the library's internal data-definitions)        * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* Make the table for a fast CRC. */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_USE_ZLIB_CRC
end_ifndef
begin_function
DECL|function|make_crc_table
name|MNG_LOCAL
name|void
name|make_crc_table
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_uint32
name|iC
decl_stmt|;
name|mng_int32
name|iN
decl_stmt|,
name|iK
decl_stmt|;
for|for
control|(
name|iN
operator|=
literal|0
init|;
name|iN
operator|<
literal|256
condition|;
name|iN
operator|++
control|)
block|{
name|iC
operator|=
operator|(
name|mng_uint32
operator|)
name|iN
expr_stmt|;
for|for
control|(
name|iK
operator|=
literal|0
init|;
name|iK
operator|<
literal|8
condition|;
name|iK
operator|++
control|)
block|{
if|if
condition|(
name|iC
operator|&
literal|1
condition|)
name|iC
operator|=
literal|0xedb88320U
operator|^
operator|(
name|iC
operator|>>
literal|1
operator|)
expr_stmt|;
else|else
name|iC
operator|=
name|iC
operator|>>
literal|1
expr_stmt|;
block|}
name|pData
operator|->
name|aCRCtable
index|[
name|iN
index|]
operator|=
name|iC
expr_stmt|;
block|}
name|pData
operator|->
name|bCRCcomputed
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* Update a running CRC with the bytes buf[0..len-1]--the CRC    should be initialized to all 1's, and the transmitted value    is the 1's complement of the final running CRC (see the    crc() routine below). */
end_comment
begin_function
DECL|function|update_crc
name|MNG_LOCAL
name|mng_uint32
name|update_crc
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint32
name|iCrc
parameter_list|,
name|mng_uint8p
name|pBuf
parameter_list|,
name|mng_int32
name|iLen
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_USE_ZLIB_CRC
return|return
name|crc32
argument_list|(
name|iCrc
argument_list|,
name|pBuf
argument_list|,
name|iLen
argument_list|)
return|;
else|#
directive|else
name|mng_uint32
name|iC
init|=
name|iCrc
decl_stmt|;
name|mng_int32
name|iN
decl_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|bCRCcomputed
condition|)
name|make_crc_table
argument_list|(
name|pData
argument_list|)
expr_stmt|;
for|for
control|(
name|iN
operator|=
literal|0
init|;
name|iN
operator|<
name|iLen
condition|;
name|iN
operator|++
control|)
name|iC
operator|=
name|pData
operator|->
name|aCRCtable
index|[
operator|(
name|iC
operator|^
name|pBuf
index|[
name|iN
index|]
operator|)
operator|&
literal|0xff
index|]
operator|^
operator|(
name|iC
operator|>>
literal|8
operator|)
expr_stmt|;
return|return
name|iC
return|;
endif|#
directive|endif
block|}
end_function
begin_comment
comment|/* Return the CRC of the bytes buf[0..len-1]. */
end_comment
begin_function
DECL|function|mng_crc
name|mng_uint32
name|mng_crc
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint8p
name|pBuf
parameter_list|,
name|mng_int32
name|iLen
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_USE_ZLIB_CRC
return|return
name|update_crc
argument_list|(
name|pData
argument_list|,
literal|0
argument_list|,
name|pBuf
argument_list|,
name|iLen
argument_list|)
return|;
else|#
directive|else
return|return
name|update_crc
argument_list|(
name|pData
argument_list|,
literal|0xffffffffU
argument_list|,
name|pBuf
argument_list|,
name|iLen
argument_list|)
operator|^
literal|0xffffffffU
return|;
endif|#
directive|endif
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Routines for swapping byte-order from and to graphic files             * */
end_comment
begin_comment
comment|/* * (This code is adapted from the libpng package)                         * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_BIGENDIAN_SUPPORTED
end_ifndef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_get_uint32
name|mng_uint32
name|mng_get_uint32
parameter_list|(
name|mng_uint8p
name|pBuf
parameter_list|)
block|{
name|mng_uint32
name|i
init|=
operator|(
call|(
name|mng_uint32
call|)
argument_list|(
operator|*
name|pBuf
argument_list|)
operator|<<
literal|24
operator|)
operator|+
operator|(
call|(
name|mng_uint32
call|)
argument_list|(
operator|*
operator|(
name|pBuf
operator|+
literal|1
operator|)
argument_list|)
operator|<<
literal|16
operator|)
operator|+
operator|(
call|(
name|mng_uint32
call|)
argument_list|(
operator|*
operator|(
name|pBuf
operator|+
literal|2
operator|)
argument_list|)
operator|<<
literal|8
operator|)
operator|+
call|(
name|mng_uint32
call|)
argument_list|(
operator|*
operator|(
name|pBuf
operator|+
literal|3
operator|)
argument_list|)
decl_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_get_int32
name|mng_int32
name|mng_get_int32
parameter_list|(
name|mng_uint8p
name|pBuf
parameter_list|)
block|{
name|mng_int32
name|i
init|=
operator|(
call|(
name|mng_int32
call|)
argument_list|(
operator|*
name|pBuf
argument_list|)
operator|<<
literal|24
operator|)
operator|+
operator|(
call|(
name|mng_int32
call|)
argument_list|(
operator|*
operator|(
name|pBuf
operator|+
literal|1
operator|)
argument_list|)
operator|<<
literal|16
operator|)
operator|+
operator|(
call|(
name|mng_int32
call|)
argument_list|(
operator|*
operator|(
name|pBuf
operator|+
literal|2
operator|)
argument_list|)
operator|<<
literal|8
operator|)
operator|+
call|(
name|mng_int32
call|)
argument_list|(
operator|*
operator|(
name|pBuf
operator|+
literal|3
operator|)
argument_list|)
decl_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_get_uint16
name|mng_uint16
name|mng_get_uint16
parameter_list|(
name|mng_uint8p
name|pBuf
parameter_list|)
block|{
name|mng_uint16
name|i
init|=
call|(
name|mng_uint16
call|)
argument_list|(
operator|(
call|(
name|mng_uint16
call|)
argument_list|(
operator|*
name|pBuf
argument_list|)
operator|<<
literal|8
operator|)
operator|+
call|(
name|mng_uint16
call|)
argument_list|(
operator|*
operator|(
name|pBuf
operator|+
literal|1
operator|)
argument_list|)
argument_list|)
decl_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_put_uint32
name|void
name|mng_put_uint32
parameter_list|(
name|mng_uint8p
name|pBuf
parameter_list|,
name|mng_uint32
name|i
parameter_list|)
block|{
operator|*
name|pBuf
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pBuf
operator|+
literal|1
operator|)
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pBuf
operator|+
literal|2
operator|)
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pBuf
operator|+
literal|3
operator|)
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|i
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_put_int32
name|void
name|mng_put_int32
parameter_list|(
name|mng_uint8p
name|pBuf
parameter_list|,
name|mng_int32
name|i
parameter_list|)
block|{
operator|*
name|pBuf
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pBuf
operator|+
literal|1
operator|)
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pBuf
operator|+
literal|2
operator|)
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pBuf
operator|+
literal|3
operator|)
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|i
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_put_uint16
name|void
name|mng_put_uint16
parameter_list|(
name|mng_uint8p
name|pBuf
parameter_list|,
name|mng_uint16
name|i
parameter_list|)
block|{
operator|*
name|pBuf
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pBuf
operator|+
literal|1
operator|)
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|i
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* !MNG_BIGENDIAN_SUPPORTED */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Helper routines to simplify chunk-data extraction                      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_READ_PROCS
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_function
DECL|function|find_null
name|MNG_LOCAL
name|mng_uint8p
name|find_null
parameter_list|(
name|mng_uint8p
name|pIn
parameter_list|)
block|{
name|mng_uint8p
name|pOut
init|=
name|pIn
decl_stmt|;
while|while
condition|(
operator|*
name|pOut
condition|)
comment|/* the read_graphic routine has made sure there's */
name|pOut
operator|++
expr_stmt|;
comment|/* always at least 1 zero-byte in the buffer */
return|return
name|pOut
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_SKIPCHUNK_iCCP
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|MNG_SKIPCHUNK_zTXt
argument_list|)
operator|||
expr|\
operator|!
name|defined
argument_list|(
name|MNG_SKIPCHUNK_iTXt
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_INCLUDE_MPNG_PROPOSAL
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|MNG_INCLUDE_ANG_PROPOSAL
argument_list|)
end_if
begin_function
DECL|function|mng_inflate_buffer
name|mng_retcode
name|mng_inflate_buffer
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint8p
name|pInbuf
parameter_list|,
name|mng_uint32
name|iInsize
parameter_list|,
name|mng_uint8p
modifier|*
name|pOutbuf
parameter_list|,
name|mng_uint32
modifier|*
name|iOutsize
parameter_list|,
name|mng_uint32
modifier|*
name|iRealsize
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INFLATE_BUFFER
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iInsize
condition|)
comment|/* anything to do ? */
block|{
operator|*
name|iOutsize
operator|=
name|iInsize
operator|*
literal|3
expr_stmt|;
comment|/* estimate uncompressed size */
comment|/* and allocate a temporary buffer */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|*
name|pOutbuf
argument_list|,
operator|*
name|iOutsize
argument_list|)
expr_stmt|;
do|do
block|{
name|mngzlib_inflateinit
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* initialize zlib */
comment|/* let zlib know where to store the output */
name|pData
operator|->
name|sZlib
operator|.
name|next_out
operator|=
operator|*
name|pOutbuf
expr_stmt|;
comment|/* "size - 1" so we've got space for the                                           zero-termination of a possible string */
name|pData
operator|->
name|sZlib
operator|.
name|avail_out
operator|=
operator|*
name|iOutsize
operator|-
literal|1
expr_stmt|;
comment|/* ok; let's inflate... */
name|iRetcode
operator|=
name|mngzlib_inflatedata
argument_list|(
name|pData
argument_list|,
name|iInsize
argument_list|,
name|pInbuf
argument_list|)
expr_stmt|;
comment|/* determine actual output size */
operator|*
name|iRealsize
operator|=
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|sZlib
operator|.
name|total_out
expr_stmt|;
name|mngzlib_inflatefree
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* zlib's done */
if|if
condition|(
name|iRetcode
operator|==
name|MNG_BUFOVERFLOW
condition|)
comment|/* not enough space ? */
block|{
comment|/* then get some more */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
operator|*
name|pOutbuf
argument_list|,
operator|*
name|iOutsize
argument_list|)
expr_stmt|;
operator|*
name|iOutsize
operator|=
operator|*
name|iOutsize
operator|+
operator|*
name|iOutsize
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|*
name|pOutbuf
argument_list|,
operator|*
name|iOutsize
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* repeat if we didn't have enough space */
do|while
condition|(
operator|(
name|iRetcode
operator|==
name|MNG_BUFOVERFLOW
operator|)
operator|&&
operator|(
operator|*
name|iOutsize
operator|<
literal|200
operator|*
name|iInsize
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* if oke ? */
operator|*
operator|(
operator|(
operator|*
name|pOutbuf
operator|)
operator|+
operator|*
name|iRealsize
operator|)
operator|=
literal|0
expr_stmt|;
comment|/* then put terminator zero */
block|}
else|else
block|{
operator|*
name|pOutbuf
operator|=
literal|0
expr_stmt|;
comment|/* nothing to do; then there's no output */
operator|*
name|iOutsize
operator|=
literal|0
expr_stmt|;
operator|*
name|iRealsize
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INFLATE_BUFFER
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_READ_PROCS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Helper routines to simplify chunk writing                              * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_WRITE_PROCS
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_SKIPCHUNK_iCCP
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|MNG_SKIPCHUNK_zTXt
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|MNG_SKIPCHUNK_iTXt
argument_list|)
end_if
begin_function
DECL|function|deflate_buffer
name|MNG_LOCAL
name|mng_retcode
name|deflate_buffer
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint8p
name|pInbuf
parameter_list|,
name|mng_uint32
name|iInsize
parameter_list|,
name|mng_uint8p
modifier|*
name|pOutbuf
parameter_list|,
name|mng_uint32
modifier|*
name|iOutsize
parameter_list|,
name|mng_uint32
modifier|*
name|iRealsize
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_DEFLATE_BUFFER
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iInsize
condition|)
comment|/* anything to do ? */
block|{
operator|*
name|iOutsize
operator|=
operator|(
name|iInsize
operator|*
literal|5
operator|)
operator|>>
literal|2
expr_stmt|;
comment|/* estimate compressed size */
comment|/* and allocate a temporary buffer */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|*
name|pOutbuf
argument_list|,
operator|*
name|iOutsize
argument_list|)
expr_stmt|;
do|do
block|{
name|mngzlib_deflateinit
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* initialize zlib */
comment|/* let zlib know where to store the output */
name|pData
operator|->
name|sZlib
operator|.
name|next_out
operator|=
operator|*
name|pOutbuf
expr_stmt|;
name|pData
operator|->
name|sZlib
operator|.
name|avail_out
operator|=
operator|*
name|iOutsize
expr_stmt|;
comment|/* ok; let's deflate... */
name|iRetcode
operator|=
name|mngzlib_deflatedata
argument_list|(
name|pData
argument_list|,
name|iInsize
argument_list|,
name|pInbuf
argument_list|)
expr_stmt|;
comment|/* determine actual output size */
operator|*
name|iRealsize
operator|=
name|pData
operator|->
name|sZlib
operator|.
name|total_out
expr_stmt|;
name|mngzlib_deflatefree
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* zlib's done */
if|if
condition|(
name|iRetcode
operator|==
name|MNG_BUFOVERFLOW
condition|)
comment|/* not enough space ? */
block|{
comment|/* then get some more */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
operator|*
name|pOutbuf
argument_list|,
operator|*
name|iOutsize
argument_list|)
expr_stmt|;
operator|*
name|iOutsize
operator|=
operator|*
name|iOutsize
operator|+
operator|(
name|iInsize
operator|>>
literal|1
operator|)
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|*
name|pOutbuf
argument_list|,
operator|*
name|iOutsize
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* repeat if we didn't have enough space */
do|while
condition|(
name|iRetcode
operator|==
name|MNG_BUFOVERFLOW
condition|)
do|;
block|}
else|else
block|{
operator|*
name|pOutbuf
operator|=
literal|0
expr_stmt|;
comment|/* nothing to do; then there's no output */
operator|*
name|iOutsize
operator|=
literal|0
expr_stmt|;
operator|*
name|iRealsize
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_DEFLATE_BUFFER
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|write_raw_chunk
name|MNG_LOCAL
name|mng_retcode
name|write_raw_chunk
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_chunkid
name|iChunkname
parameter_list|,
name|mng_uint32
name|iRawlen
parameter_list|,
name|mng_uint8p
name|pRawdata
parameter_list|)
block|{
name|mng_uint32
name|iCrc
decl_stmt|;
name|mng_uint32
name|iWritten
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_RAW_CHUNK
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* temporary buffer ? */
if|if
condition|(
operator|(
name|pRawdata
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|pRawdata
operator|!=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
operator|)
condition|)
block|{
comment|/* store length& chunktype in default buffer */
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
operator|+
literal|4
argument_list|,
operator|(
name|mng_uint32
operator|)
name|iChunkname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_OUTPUT
condition|)
block|{
if|if
condition|(
operator|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_OUTPUT
operator|)
operator|==
name|MNG_CRC_OUTPUT_GENERATE
condition|)
block|{
comment|/* calculate the crc */
name|iCrc
operator|=
name|update_crc
argument_list|(
name|pData
argument_list|,
literal|0xffffffffL
argument_list|,
name|pData
operator|->
name|pWritebuf
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|iCrc
operator|=
name|update_crc
argument_list|(
name|pData
argument_list|,
name|iCrc
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
operator|^
literal|0xffffffffL
expr_stmt|;
block|}
else|else
block|{
name|iCrc
operator|=
literal|0
expr_stmt|;
comment|/* dummy crc */
block|}
comment|/* store in default buffer */
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
argument_list|,
name|iCrc
argument_list|)
expr_stmt|;
block|}
comment|/* write the length& chunktype */
if|if
condition|(
operator|!
name|pData
operator|->
name|fWritedata
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
argument_list|,
literal|8
argument_list|,
operator|&
name|iWritten
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|iWritten
operator|!=
literal|8
condition|)
comment|/* disk full ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTPUTERROR
argument_list|)
expr_stmt|;
comment|/* write the temporary buffer */
if|if
condition|(
operator|!
name|pData
operator|->
name|fWritedata
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|,
operator|&
name|iWritten
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|iWritten
operator|!=
name|iRawlen
condition|)
comment|/* disk full ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTPUTERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_OUTPUT
condition|)
block|{
comment|/* write the crc */
if|if
condition|(
operator|!
name|pData
operator|->
name|fWritedata
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
argument_list|,
literal|4
argument_list|,
operator|&
name|iWritten
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|iWritten
operator|!=
literal|4
condition|)
comment|/* disk full ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTPUTERROR
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* prefix with length& chunktype */
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
operator|+
literal|4
argument_list|,
operator|(
name|mng_uint32
operator|)
name|iChunkname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_OUTPUT
condition|)
block|{
if|if
condition|(
operator|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_OUTPUT
operator|)
operator|==
name|MNG_CRC_OUTPUT_GENERATE
condition|)
comment|/* calculate the crc */
name|iCrc
operator|=
name|mng_crc
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
operator|+
literal|4
argument_list|,
name|iRawlen
operator|+
literal|4
argument_list|)
expr_stmt|;
else|else
name|iCrc
operator|=
literal|0
expr_stmt|;
comment|/* dummy crc */
comment|/* add it to the buffer */
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
operator|+
name|iRawlen
operator|+
literal|8
argument_list|,
name|iCrc
argument_list|)
expr_stmt|;
comment|/* write it in a single pass */
if|if
condition|(
operator|!
name|pData
operator|->
name|fWritedata
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
argument_list|,
name|iRawlen
operator|+
literal|12
argument_list|,
operator|&
name|iWritten
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|iWritten
operator|!=
name|iRawlen
operator|+
literal|12
condition|)
comment|/* disk full ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTPUTERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|fWritedata
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
argument_list|,
name|iRawlen
operator|+
literal|8
argument_list|,
operator|&
name|iWritten
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|iWritten
operator|!=
name|iRawlen
operator|+
literal|8
condition|)
comment|/* disk full ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTPUTERROR
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_RAW_CHUNK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* B004 */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_WRITE_PROCS */
end_comment
begin_comment
comment|/* B004 */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * chunk read functions                                                   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_READ_PROCS
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|create_chunk_storage
name|MNG_LOCAL
name|mng_retcode
name|create_chunk_storage
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_chunkp
name|pHeader
parameter_list|,
name|mng_uint32
name|iRawlen
parameter_list|,
name|mng_uint8p
name|pRawdata
parameter_list|,
name|mng_field_descp
name|pField
parameter_list|,
name|mng_uint16
name|iFields
parameter_list|,
name|mng_chunkp
modifier|*
name|ppChunk
parameter_list|,
name|mng_bool
name|bWorkcopy
parameter_list|)
block|{
name|mng_field_descp
name|pTempfield
init|=
name|pField
decl_stmt|;
name|mng_uint16
name|iFieldcount
init|=
name|iFields
decl_stmt|;
name|mng_uint8p
name|pTempdata
init|=
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iTemplen
init|=
name|iRawlen
decl_stmt|;
name|mng_uint16
name|iLastgroup
init|=
literal|0
decl_stmt|;
name|mng_uint8p
name|pChunkdata
decl_stmt|;
name|mng_uint32
name|iDatalen
decl_stmt|;
name|mng_uint8
name|iColortype
decl_stmt|;
name|mng_bool
name|bProcess
decl_stmt|;
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
operator|(
call|(
name|mng_chunk_headerp
call|)
argument_list|(
operator|*
name|ppChunk
argument_list|)
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_HUH
condition|)
operator|(
call|(
name|mng_chunk_headerp
call|)
argument_list|(
operator|*
name|ppChunk
argument_list|)
operator|)
operator|->
name|iChunkname
operator|=
name|pData
operator|->
name|iChunkname
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|bWorkcopy
operator|)
operator|||
operator|(
operator|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|!=
name|MNG_UINT_IDAT
operator|)
operator|&&
operator|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|!=
name|MNG_UINT_JDAT
operator|)
operator|&&
operator|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|!=
name|MNG_UINT_JDAA
operator|)
operator|)
condition|)
block|{
name|pChunkdata
operator|=
call|(
name|mng_uint8p
call|)
argument_list|(
operator|*
name|ppChunk
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
comment|/* determine current colortype */
if|if
condition|(
name|pData
operator|->
name|bHasJHDR
condition|)
name|iColortype
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pData
operator|->
name|iJHDRcolortype
operator|-
literal|8
argument_list|)
expr_stmt|;
elseif|else
endif|#
directive|endif
comment|/* MNG_INCLUDE_JNG */
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|iColortype
operator|=
name|pData
operator|->
name|iColortype
expr_stmt|;
else|else
name|iColortype
operator|=
literal|6
expr_stmt|;
if|if
condition|(
name|iTemplen
condition|)
comment|/* not empty ? */
block|{
comment|/* then go fill the fields */
while|while
condition|(
operator|(
name|iFieldcount
operator|)
operator|&&
operator|(
name|iTemplen
operator|)
condition|)
block|{
if|if
condition|(
name|pTempfield
operator|->
name|iOffsetchunk
condition|)
block|{
if|if
condition|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_PUTIMGTYPE
condition|)
block|{
operator|*
operator|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunk
operator|)
operator|=
name|iColortype
expr_stmt|;
name|bProcess
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPES
condition|)
name|bProcess
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE0
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE2
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|2
operator|)
operator|)
operator|||
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE3
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|3
operator|)
operator|)
operator|||
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE4
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|4
operator|)
operator|)
operator|||
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE6
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|6
operator|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|bProcess
operator|=
name|MNG_TRUE
expr_stmt|;
if|if
condition|(
name|bProcess
condition|)
block|{
name|iLastgroup
operator|=
call|(
name|mng_uint16
call|)
argument_list|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_GROUPMASK
argument_list|)
expr_stmt|;
comment|/* numeric field ? */
if|if
condition|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_INT
condition|)
block|{
if|if
condition|(
name|iTemplen
operator|<
name|pTempfield
operator|->
name|iLengthmax
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pTempfield
operator|->
name|iLengthmax
condition|)
block|{
case|case
literal|1
case|:
block|{
name|mng_uint8
name|iNum
init|=
operator|*
name|pTempdata
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|mng_uint16
operator|)
name|iNum
operator|<
name|pTempfield
operator|->
name|iMinvalue
operator|)
operator|||
operator|(
operator|(
name|mng_uint16
operator|)
name|iNum
operator|>
name|pTempfield
operator|->
name|iMaxvalue
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFIELDVAL
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunk
operator|)
operator|=
name|iNum
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|mng_uint16
name|iNum
init|=
name|mng_get_uint16
argument_list|(
name|pTempdata
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|iNum
operator|<
name|pTempfield
operator|->
name|iMinvalue
operator|)
operator|||
operator|(
name|iNum
operator|>
name|pTempfield
operator|->
name|iMaxvalue
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFIELDVAL
argument_list|)
expr_stmt|;
operator|*
operator|(
call|(
name|mng_uint16p
call|)
argument_list|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunk
argument_list|)
operator|)
operator|=
name|iNum
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|mng_uint32
name|iNum
init|=
name|mng_get_uint32
argument_list|(
name|pTempdata
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|iNum
operator|<
name|pTempfield
operator|->
name|iMinvalue
operator|)
operator|||
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_NOHIGHBIT
operator|)
operator|&&
operator|(
name|iNum
operator|&
literal|0x80000000
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFIELDVAL
argument_list|)
expr_stmt|;
operator|*
operator|(
call|(
name|mng_uint32p
call|)
argument_list|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunk
argument_list|)
operator|)
operator|=
name|iNum
expr_stmt|;
break|break;
block|}
block|}
name|pTempdata
operator|+=
name|pTempfield
operator|->
name|iLengthmax
expr_stmt|;
name|iTemplen
operator|-=
name|pTempfield
operator|->
name|iLengthmax
expr_stmt|;
block|}
else|else
block|{
comment|/* not numeric so it's a bunch of bytes */
if|if
condition|(
operator|!
name|pTempfield
operator|->
name|iOffsetchunklen
condition|)
comment|/* big fat NONO */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INTERNALERROR
argument_list|)
expr_stmt|;
comment|/* with terminating 0 ? */
if|if
condition|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_TERMINATOR
condition|)
block|{
name|mng_uint8p
name|pWork
init|=
name|pTempdata
decl_stmt|;
while|while
condition|(
operator|*
name|pWork
condition|)
comment|/* find the zero */
name|pWork
operator|++
expr_stmt|;
name|iDatalen
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|pWork
operator|-
name|pTempdata
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no terminator, so everything that's left ! */
name|iDatalen
operator|=
name|iTemplen
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pTempfield
operator|->
name|iLengthmax
operator|)
operator|&&
operator|(
name|iDatalen
operator|>
name|pTempfield
operator|->
name|iLengthmax
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_SKIPCHUNK_iCCP
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|MNG_SKIPCHUNK_zTXt
argument_list|)
operator|||
expr|\
operator|!
name|defined
argument_list|(
name|MNG_SKIPCHUNK_iTXt
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_INCLUDE_MPNG_PROPOSAL
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|MNG_INCLUDE_ANG_PROPOSAL
argument_list|)
comment|/* needs decompression ? */
if|if
condition|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_DEFLATED
condition|)
block|{
name|mng_uint8p
name|pBuf
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iBufsize
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iRealsize
decl_stmt|;
name|mng_ptr
name|pWork
decl_stmt|;
name|iRetcode
operator|=
name|mng_inflate_buffer
argument_list|(
name|pData
argument_list|,
name|pTempdata
argument_list|,
name|iDatalen
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBufsize
argument_list|,
operator|&
name|iRealsize
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_CHECK_BAD_ICCP
comment|/* Check for bad iCCP chunk */
if|if
condition|(
operator|(
name|iRetcode
operator|)
operator|&&
operator|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_iCCP
operator|)
condition|)
block|{
operator|*
operator|(
operator|(
name|mng_ptr
operator|*
operator|)
operator|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunk
operator|)
operator|)
operator|=
name|MNG_NULL
expr_stmt|;
operator|*
operator|(
call|(
name|mng_uint32p
call|)
argument_list|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunklen
argument_list|)
operator|)
operator|=
name|iDatalen
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_MPNG_PROPOSAL
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_INCLUDE_ANG_PROPOSAL
argument_list|)
if|if
condition|(
operator|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_mpNG
operator|)
operator|||
operator|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_adAT
operator|)
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pWork
argument_list|,
name|iRealsize
argument_list|)
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
comment|/* don't forget to generate null terminator */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pWork
argument_list|,
name|iRealsize
operator|+
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_MPNG_PROPOSAL
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_INCLUDE_ANG_PROPOSAL
argument_list|)
block|}
endif|#
directive|endif
name|MNG_COPY
argument_list|(
name|pWork
argument_list|,
name|pBuf
argument_list|,
name|iRealsize
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|mng_ptr
operator|*
operator|)
operator|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunk
operator|)
operator|)
operator|=
name|pWork
expr_stmt|;
operator|*
operator|(
call|(
name|mng_uint32p
call|)
argument_list|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunklen
argument_list|)
operator|)
operator|=
name|iRealsize
expr_stmt|;
block|}
if|if
condition|(
name|pBuf
condition|)
comment|/* free the temporary buffer */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
comment|/* no decompression, so just copy */
name|mng_ptr
name|pWork
decl_stmt|;
comment|/* don't forget to generate null terminator */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pWork
argument_list|,
name|iDatalen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pWork
argument_list|,
name|pTempdata
argument_list|,
name|iDatalen
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|mng_ptr
operator|*
operator|)
operator|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunk
operator|)
operator|)
operator|=
name|pWork
expr_stmt|;
operator|*
operator|(
call|(
name|mng_uint32p
call|)
argument_list|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunklen
argument_list|)
operator|)
operator|=
name|iDatalen
expr_stmt|;
block|}
if|if
condition|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_TERMINATOR
condition|)
name|iDatalen
operator|++
expr_stmt|;
comment|/* skip the terminating zero as well !!! */
name|iTemplen
operator|-=
name|iDatalen
expr_stmt|;
name|pTempdata
operator|+=
name|iDatalen
expr_stmt|;
block|}
comment|/* need to set an indicator ? */
if|if
condition|(
name|pTempfield
operator|->
name|iOffsetchunkind
condition|)
operator|*
operator|(
call|(
name|mng_uint8p
call|)
argument_list|(
name|pChunkdata
operator|+
name|pTempfield
operator|->
name|iOffsetchunkind
argument_list|)
operator|)
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pTempfield
operator|->
name|pSpecialfunc
condition|)
comment|/* special function required ? */
block|{
name|iRetcode
operator|=
name|pTempfield
operator|->
name|pSpecialfunc
argument_list|(
name|pData
argument_list|,
operator|*
name|ppChunk
argument_list|,
operator|&
name|iTemplen
argument_list|,
operator|&
name|pTempdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
name|pTempfield
operator|++
expr_stmt|;
comment|/* Neeeeeeexxxtt */
name|iFieldcount
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|iTemplen
condition|)
comment|/* extra data ??? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
while|while
condition|(
name|iFieldcount
condition|)
comment|/* not enough data ??? */
block|{
if|if
condition|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPES
condition|)
name|bProcess
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE0
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE2
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|2
operator|)
operator|)
operator|||
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE3
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|3
operator|)
operator|)
operator|||
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE4
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|4
operator|)
operator|)
operator|||
operator|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_IFIMGTYPE6
operator|)
operator|&&
operator|(
name|iColortype
operator|==
literal|6
operator|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|bProcess
operator|=
name|MNG_TRUE
expr_stmt|;
if|if
condition|(
name|bProcess
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_OPTIONAL
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_GROUPMASK
operator|)
operator|&&
operator|(
call|(
name|mng_uint16
call|)
argument_list|(
name|pTempfield
operator|->
name|iFlags
operator|&
name|MNG_FIELD_GROUPMASK
argument_list|)
operator|==
name|iLastgroup
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
name|pTempfield
operator|++
expr_stmt|;
name|iFieldcount
operator|--
expr_stmt|;
block|}
block|}
block|}
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|READ_CHUNK
name|READ_CHUNK
argument_list|(
argument|mng_read_general
argument_list|)
end_macro
begin_block
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
name|mng_chunk_descp
name|pDescr
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|pChunkdescr
decl_stmt|;
name|mng_field_descp
name|pField
decl_stmt|;
name|mng_uint16
name|iFields
decl_stmt|;
if|if
condition|(
operator|!
name|pDescr
condition|)
comment|/* this is a bad booboo !!! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INTERNALERROR
argument_list|)
expr_stmt|;
name|pField
operator|=
name|pDescr
operator|->
name|pFielddesc
expr_stmt|;
name|iFields
operator|=
name|pDescr
operator|->
name|iFielddesc
expr_stmt|;
comment|/* check chunk against signature */
if|if
condition|(
operator|(
name|pDescr
operator|->
name|eImgtype
operator|==
name|mng_it_mng
operator|)
operator|&&
operator|(
name|pData
operator|->
name|eSigtype
operator|!=
name|mng_it_mng
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CHUNKNOTALLOWED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pDescr
operator|->
name|eImgtype
operator|==
name|mng_it_jng
operator|)
operator|&&
operator|(
name|pData
operator|->
name|eSigtype
operator|==
name|mng_it_png
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CHUNKNOTALLOWED
argument_list|)
expr_stmt|;
comment|/* empties allowed ? */
if|if
condition|(
operator|(
name|iRawlen
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|!
operator|(
name|pDescr
operator|->
name|iAllowed
operator|&
name|MNG_DESCR_EMPTY
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|eImagetype
operator|!=
name|mng_it_mng
operator|)
operator|||
operator|(
operator|!
operator|(
name|pDescr
operator|->
name|iAllowed
operator|&
name|MNG_DESCR_GLOBAL
operator|)
operator|)
condition|)
block|{
comment|/* *a* header required ? */
if|if
condition|(
operator|(
name|pDescr
operator|->
name|iMusthaves
operator|&
name|MNG_DESCR_GenHDR
operator|)
operator|&&
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
block|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
name|pDescr
operator|->
name|iMusthaves
operator|&
name|MNG_DESCR_JngHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_block
begin_comment
comment|/* specific chunk pre-requisite ? */
end_comment
begin_if
if|if
condition|(
operator|(
operator|(
name|pDescr
operator|->
name|iMusthaves
operator|&
name|MNG_DESCR_IHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|)
operator|||
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
operator|(
operator|(
name|pDescr
operator|->
name|iMusthaves
operator|&
name|MNG_DESCR_JHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
operator|)
operator|||
endif|#
directive|endif
operator|(
operator|(
name|pDescr
operator|->
name|iMusthaves
operator|&
name|MNG_DESCR_DHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMusthaves
operator|&
name|MNG_DESCR_LOOP
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasLOOP
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMusthaves
operator|&
name|MNG_DESCR_PLTE
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasPLTE
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMusthaves
operator|&
name|MNG_DESCR_MHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMusthaves
operator|&
name|MNG_DESCR_SAVE
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasSAVE
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* specific chunk undesired ? */
end_comment
begin_if
if|if
condition|(
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOIHDR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOBASI
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NODHDR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOIDAT
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOPLTE
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
operator|)
operator|||
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOJHDR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOJDAT
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasJDAT
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOJDAA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasJDAA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOJSEP
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasJSEP
operator|)
operator|)
operator|||
endif|#
directive|endif
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOMHDR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasMHDR
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOLOOP
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasLOOP
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOTERM
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasTERM
operator|)
operator|)
operator|||
operator|(
operator|(
name|pDescr
operator|->
name|iMustNOThaves
operator|&
name|MNG_DESCR_NOSAVE
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasSAVE
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|eSigtype
operator|==
name|mng_it_mng
condition|)
comment|/* check global and embedded empty chunks */
block|{
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
operator|(
name|iRawlen
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|!
operator|(
name|pDescr
operator|->
name|iAllowed
operator|&
name|MNG_DESCR_EMPTYEMBED
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|iRawlen
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|!
operator|(
name|pDescr
operator|->
name|iAllowed
operator|&
name|MNG_DESCR_EMPTYGLOBAL
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_if
if|if
condition|(
name|pDescr
operator|->
name|pSpecialfunc
condition|)
comment|/* need special processing ? */
block|{
name|iRetcode
operator|=
name|create_chunk_storage
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|,
name|pField
argument_list|,
name|iFields
argument_list|,
name|ppChunk
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* empty indicator ? */
if|if
condition|(
operator|(
operator|!
name|iRawlen
operator|)
operator|&&
operator|(
name|pDescr
operator|->
name|iOffsetempty
operator|)
condition|)
operator|*
operator|(
operator|(
operator|(
name|mng_uint8p
operator|)
operator|*
name|ppChunk
operator|)
operator|+
name|pDescr
operator|->
name|iOffsetempty
operator|)
operator|=
name|MNG_TRUE
expr_stmt|;
name|iRetcode
operator|=
name|pDescr
operator|->
name|pSpecialfunc
argument_list|(
name|pData
argument_list|,
operator|*
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
operator|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_IDAT
operator|)
operator|||
operator|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_JDAT
operator|)
operator|||
operator|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_JDAA
operator|)
condition|)
block|{
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|fCleanup
argument_list|(
name|pData
argument_list|,
operator|*
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
operator|*
name|ppChunk
operator|=
name|MNG_NULL
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
if|if
condition|(
operator|!
name|pData
operator|->
name|bStorechunks
condition|)
endif|#
directive|endif
block|{
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|fCleanup
argument_list|(
name|pData
argument_list|,
operator|*
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
operator|*
name|ppChunk
operator|=
name|MNG_NULL
expr_stmt|;
block|}
block|}
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_if
if|if
condition|(
name|iRawlen
condition|)
block|{
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pData
operator|->
name|iRawlen
operator|=
name|iRawlen
expr_stmt|;
name|pData
operator|->
name|pRawdata
operator|=
name|pRawdata
expr_stmt|;
endif|#
directive|endif
comment|/* display processing */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_IDAT
condition|)
name|iRetcode
operator|=
name|mng_process_display_idat
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
elseif|else
if|if
condition|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_JDAT
condition|)
name|iRetcode
operator|=
name|mng_process_display_jdat
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_JDAA
condition|)
name|iRetcode
operator|=
name|mng_process_display_jdaa
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
if|if
condition|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_IDAT
condition|)
name|iRetcode
operator|=
name|mng_process_display_idat
argument_list|(
name|pData
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
elseif|else
if|if
condition|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_JDAT
condition|)
name|iRetcode
operator|=
name|mng_process_display_jdat
argument_list|(
name|pData
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_JDAA
condition|)
name|iRetcode
operator|=
name|mng_process_display_jdaa
argument_list|(
name|pData
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bStorechunks
operator|)
operator|&&
operator|(
operator|!
operator|(
operator|*
name|ppChunk
operator|)
operator|)
condition|)
block|{
name|iRetcode
operator|=
name|create_chunk_storage
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|,
name|pField
argument_list|,
name|iFields
argument_list|,
name|ppChunk
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* empty indicator ? */
if|if
condition|(
operator|(
operator|!
name|iRawlen
operator|)
operator|&&
operator|(
name|pDescr
operator|->
name|iOffsetempty
operator|)
condition|)
operator|*
operator|(
operator|(
operator|(
name|mng_uint8p
operator|)
operator|*
name|ppChunk
operator|)
operator|+
name|pDescr
operator|->
name|iOffsetempty
operator|)
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
unit|}
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_OPTIMIZE_CHUNKREADER */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_ihdr
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IHDR
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
name|iRawlen
operator|!=
literal|13
condition|)
comment|/* length oke ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* only allowed inside PNG or MNG */
end_comment
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|eSigtype
operator|!=
name|mng_it_png
operator|)
operator|&&
operator|(
name|pData
operator|->
name|eSigtype
operator|!=
name|mng_it_mng
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CHUNKNOTALLOWED
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* sequence checks */
end_comment
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|eSigtype
operator|==
name|mng_it_png
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iChunkseq
operator|>
literal|1
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasIHDR
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* indicate IHDR is present */
end_comment
begin_comment
comment|/* and store interesting fields */
end_comment
begin_if
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_NOCHANGE
operator|)
condition|)
block|{
name|pData
operator|->
name|iDatawidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDataheight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
end_if
begin_expr_stmt
name|pData
operator|->
name|iBitdepth
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iColortype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iCompression
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|10
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iFilter
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|11
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iInterlace
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
expr_stmt|;
end_expr_stmt
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_NO_1_2_4BIT_SUPPORT
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_NO_16BIT_SUPPORT
argument_list|)
end_if
begin_expr_stmt
name|pData
operator|->
name|iPNGmult
operator|=
literal|1
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iPNGdepth
operator|=
name|pData
operator|->
name|iBitdepth
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_NO_1_2_4BIT_SUPPORT
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<
literal|8
condition|)
name|pData
operator|->
name|iBitdepth
operator|=
literal|8
expr_stmt|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_NO_16BIT_SUPPORT
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
block|{
name|pData
operator|->
name|iBitdepth
operator|=
literal|8
expr_stmt|;
name|pData
operator|->
name|iPNGmult
operator|=
literal|2
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|8
operator|)
comment|/* parameter validity checks */
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|4
operator|)
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|16
operator|)
endif|#
directive|endif
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAY
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_INDEXED
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAYA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOLORTYPE
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_INDEXED
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|>
literal|8
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGB
operator|)
operator|||
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|<
literal|8
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|iCompression
operator|!=
name|MNG_COMPRESSION_DEFLATE
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOMPRESS
argument_list|)
expr_stmt|;
end_if
begin_if
if|#
directive|if
name|defined
argument_list|(
name|FILTER192
argument_list|)
operator|||
name|defined
argument_list|(
name|FILTER193
argument_list|)
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_ADAPTIVE
operator|)
operator|&&
if|#
directive|if
name|defined
argument_list|(
name|FILTER192
argument_list|)
operator|&&
name|defined
argument_list|(
name|FILTER193
argument_list|)
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_DIFFERING
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_NOFILTER
operator|)
condition|)
else|#
directive|else
ifdef|#
directive|ifdef
name|FILTER192
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_DIFFERING
operator|)
end_if
begin_else
unit|)
else|#
directive|else
end_else
begin_expr_stmt
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_NOFILTER
operator|)
end_expr_stmt
begin_endif
unit|)
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_expr_stmt
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFILTER
argument_list|)
expr_stmt|;
end_expr_stmt
begin_else
else|#
directive|else
end_else
begin_if
if|if
condition|(
name|pData
operator|->
name|iFilter
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFILTER
argument_list|)
expr_stmt|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iInterlace
operator|!=
name|MNG_INTERLACE_NONE
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iInterlace
operator|!=
name|MNG_INTERLACE_ADAM7
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDINTERLACE
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* check the colortype for delta-images ! */
block|{
name|mng_imagedatap
name|pBuf
init|=
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
operator|)
operator|->
name|pImgbuf
decl_stmt|;
if|if
condition|(
name|pData
operator|->
name|iColortype
operator|!=
name|pBuf
operator|->
name|iColortype
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_INDEXED
operator|)
operator|||
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAY
operator|)
operator|)
operator|&&
operator|(
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAY
operator|)
operator|||
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_INDEXED
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOLORTYPE
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_if
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasheader
condition|)
comment|/* first chunk ? */
block|{
name|pData
operator|->
name|bHasheader
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* we've got a header */
name|pData
operator|->
name|eImagetype
operator|=
name|mng_it_png
expr_stmt|;
comment|/* then this must be a PNG */
name|pData
operator|->
name|iWidth
operator|=
name|pData
operator|->
name|iDatawidth
expr_stmt|;
name|pData
operator|->
name|iHeight
operator|=
name|pData
operator|->
name|iDataheight
expr_stmt|;
comment|/* predict alpha-depth ! */
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGBA
operator|)
condition|)
name|pData
operator|->
name|iAlphadepth
operator|=
name|pData
operator|->
name|iBitdepth
expr_stmt|;
elseif|else
if|if
condition|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_INDEXED
condition|)
name|pData
operator|->
name|iAlphadepth
operator|=
literal|8
expr_stmt|;
comment|/* worst case scenario */
else|else
name|pData
operator|->
name|iAlphadepth
operator|=
literal|1
expr_stmt|;
comment|/* Possible tRNS cheap binary transparency */
comment|/* fits on maximum canvas ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iWidth
operator|>
name|pData
operator|->
name|iMaxwidth
operator|)
operator|||
operator|(
name|pData
operator|->
name|iHeight
operator|>
name|pData
operator|->
name|iMaxheight
operator|)
condition|)
name|MNG_WARNING
argument_list|(
name|pData
argument_list|,
name|MNG_IMAGETOOLARGE
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_INCLUDE_MPNG_PROPOSAL
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
if|if
condition|(
name|pData
operator|->
name|fProcessheader
condition|)
comment|/* inform the app ? */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessheader
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|pData
operator|->
name|iWidth
argument_list|,
name|pData
operator|->
name|iHeight
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_if
begin_if
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasDHDR
condition|)
name|pData
operator|->
name|iImagelevel
operator|++
expr_stmt|;
end_if
begin_comment
comment|/* one level deeper */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
init|=
name|mng_process_display_ihdr
argument_list|(
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* fill the fields */
operator|(
operator|(
name|mng_ihdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iWidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_ihdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iHeight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_ihdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBitdepth
operator|=
name|pData
operator|->
name|iBitdepth
expr_stmt|;
operator|(
operator|(
name|mng_ihdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iColortype
operator|=
name|pData
operator|->
name|iColortype
expr_stmt|;
operator|(
operator|(
name|mng_ihdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCompression
operator|=
name|pData
operator|->
name|iCompression
expr_stmt|;
operator|(
operator|(
name|mng_ihdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFilter
operator|=
name|pData
operator|->
name|iFilter
expr_stmt|;
operator|(
operator|(
name|mng_ihdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iInterlace
operator|=
name|pData
operator|->
name|iInterlace
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_OPTIMIZE_CHUNKREADER */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_plte
operator|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
name|mng_uint32
name|iX
block|;
name|mng_uint8p
name|pRawdata2
block|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
name|mng_uint32
name|iRawlen2
block|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PLTE
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|bHasIDAT
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* multiple PLTE only inside BASI */
end_comment
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_MULTIPLEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* length must be multiple of 3 */
end_comment
begin_if
if|if
condition|(
operator|(
operator|(
name|iRawlen
operator|%
literal|3
operator|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|iRawlen
operator|>
literal|768
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
block|{
comment|/* only allowed for indexed-color or                                           rgb(a)-color! */
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
literal|3
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
literal|6
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CHUNKNOTALLOWED
argument_list|)
expr_stmt|;
comment|/* empty only allowed if global present */
if|if
condition|(
operator|(
name|iRawlen
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasglobalPLTE
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CANNOTBEEMPTY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|iRawlen
operator|==
literal|0
condition|)
comment|/* cannot be empty as global! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CANNOTBEEMPTY
argument_list|)
expr_stmt|;
block|}
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|pData
operator|->
name|bHasPLTE
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* got it! */
else|else
name|pData
operator|->
name|bHasglobalPLTE
operator|=
name|MNG_TRUE
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|iPLTEcount
operator|=
name|iRawlen
operator|/
literal|3
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
block|{
name|mng_imagep
name|pImage
decl_stmt|;
name|mng_imagedatap
name|pBuf
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* processing delta-image ? */
block|{
comment|/* store in object 0 !!! */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
name|pBuf
operator|->
name|bHasPLTE
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* it's definitely got a PLTE now */
name|pBuf
operator|->
name|iPLTEcount
operator|=
name|iRawlen
operator|/
literal|3
expr_stmt|;
comment|/* this is the exact length */
name|pRawdata2
operator|=
name|pRawdata
expr_stmt|;
comment|/* copy the entries */
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iRawlen
operator|/
literal|3
condition|;
name|iX
operator|++
control|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
operator|*
name|pRawdata2
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
operator|*
operator|(
name|pRawdata2
operator|+
literal|1
operator|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
operator|*
operator|(
name|pRawdata2
operator|+
literal|2
operator|)
expr_stmt|;
name|pRawdata2
operator|+=
literal|3
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
comment|/* get the current object */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* no object then dump it in obj 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* address the object buffer */
name|pBuf
operator|->
name|bHasPLTE
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* and tell it it's got a PLTE now */
if|if
condition|(
operator|!
name|iRawlen
condition|)
comment|/* if empty, inherit from global */
block|{
name|pBuf
operator|->
name|iPLTEcount
operator|=
name|pData
operator|->
name|iGlobalPLTEcount
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
argument_list|,
name|pData
operator|->
name|aGlobalPLTEentries
argument_list|,
sizeof|sizeof
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bHasglobalTRNS
condition|)
comment|/* also copy global tRNS ? */
block|{
comment|/* indicate tRNS available */
name|pBuf
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
name|iRawlen2
operator|=
name|pData
operator|->
name|iGlobalTRNSrawlen
expr_stmt|;
name|pRawdata2
operator|=
call|(
name|mng_uint8p
call|)
argument_list|(
name|pData
operator|->
name|aGlobalTRNSrawdata
argument_list|)
expr_stmt|;
comment|/* global length oke ? */
if|if
condition|(
operator|(
name|iRawlen2
operator|==
literal|0
operator|)
operator|||
operator|(
name|iRawlen2
operator|>
name|pBuf
operator|->
name|iPLTEcount
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_GLOBALLENGTHERR
argument_list|)
expr_stmt|;
comment|/* copy it */
name|pBuf
operator|->
name|iTRNScount
operator|=
name|iRawlen2
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pBuf
operator|->
name|aTRNSentries
argument_list|,
name|pRawdata2
argument_list|,
name|iRawlen2
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* store fields for future reference */
name|pBuf
operator|->
name|iPLTEcount
operator|=
name|iRawlen
operator|/
literal|3
expr_stmt|;
name|pRawdata2
operator|=
name|pRawdata
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pBuf
operator|->
name|iPLTEcount
condition|;
name|iX
operator|++
control|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
operator|*
name|pRawdata2
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
operator|*
operator|(
name|pRawdata2
operator|+
literal|1
operator|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
operator|*
operator|(
name|pRawdata2
operator|+
literal|2
operator|)
expr_stmt|;
name|pRawdata2
operator|+=
literal|3
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
comment|/* store as global */
block|{
name|pData
operator|->
name|iGlobalPLTEcount
operator|=
name|iRawlen
operator|/
literal|3
expr_stmt|;
name|pRawdata2
operator|=
name|pRawdata
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iGlobalPLTEcount
condition|;
name|iX
operator|++
control|)
block|{
name|pData
operator|->
name|aGlobalPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
operator|*
name|pRawdata2
expr_stmt|;
name|pData
operator|->
name|aGlobalPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
operator|*
operator|(
name|pRawdata2
operator|+
literal|1
operator|)
expr_stmt|;
name|pData
operator|->
name|aGlobalPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
operator|*
operator|(
name|pRawdata2
operator|+
literal|2
operator|)
expr_stmt|;
name|pRawdata2
operator|+=
literal|3
expr_stmt|;
block|}
block|{
comment|/* create an animation object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_plte
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iGlobalPLTEcount
argument_list|,
name|pData
operator|->
name|aGlobalPLTEentries
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_pltep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_pltep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iEntrycount
operator|=
name|iRawlen
operator|/
literal|3
expr_stmt|;
name|pRawdata2
operator|=
name|pRawdata
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
operator|(
operator|(
name|mng_pltep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iEntrycount
condition|;
name|iX
operator|++
control|)
block|{
operator|(
operator|(
name|mng_pltep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
operator|*
name|pRawdata2
expr_stmt|;
operator|(
operator|(
name|mng_pltep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
operator|*
operator|(
name|pRawdata2
operator|+
literal|1
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_pltep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
operator|*
operator|(
name|pRawdata2
operator|+
literal|2
operator|)
expr_stmt|;
name|pRawdata2
operator|+=
literal|3
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PLTE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_OPTIMIZE_CHUNKREADER */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_idat
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IDAT
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRalphacompression
operator|!=
name|MNG_COMPRESSION_DEFLATE
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasJSEP
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* not allowed for deltatype NO_CHANGE */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_NOCHANGE
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CHUNKNOTALLOWED
argument_list|)
expr_stmt|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* can only be empty in BASI-block! */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* indexed-color requires PLTE */
end_comment
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|3
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasPLTE
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_PLTEMISSING
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasIDAT
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* got some IDAT now, don't we */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_if
if|if
condition|(
name|iRawlen
condition|)
block|{
comment|/* display processing */
name|mng_retcode
name|iRetcode
init|=
name|mng_process_display_idat
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_idatp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_idatp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDatasize
operator|=
name|iRawlen
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
comment|/* is there any data ? */
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_idatp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pData
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_idatp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IDAT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_iend
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IEND
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
name|iRawlen
operator|>
literal|0
condition|)
comment|/* must not contain data! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_comment
comment|/* sequence checks */
end_comment
begin_if
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* IHDR-block requires IDAT */
end_comment
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIDAT
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_IDATMISSING
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|iImagelevel
operator|--
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* one level up */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* create an animation object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_image
argument_list|(
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* display processing */
name|iRetcode
operator|=
name|mng_process_display_iend
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_if
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
comment|/* reset only if not broken !!! */
block|{
endif|#
directive|endif
comment|/* IEND signals the end for most ... */
name|pData
operator|->
name|bHasIHDR
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasBASI
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasDHDR
operator|=
name|MNG_FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
name|pData
operator|->
name|bHasJHDR
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasJSEP
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasJDAA
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasJDAT
operator|=
name|MNG_FALSE
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|bHasPLTE
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasTRNS
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasGAMA
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasCHRM
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasSRGB
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasICCP
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasBKGD
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasIDAT
operator|=
name|MNG_FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IEND
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_trns
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_TRNS
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|bHasIDAT
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* multiple tRNS only inside BASI */
end_comment
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasTRNS
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_MULTIPLEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|>
literal|256
condition|)
comment|/* it just can't be bigger than that! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
block|{
comment|/* not allowed with full alpha-channel */
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|4
operator|)
operator|||
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|6
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CHUNKNOTALLOWED
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
comment|/* filled ? */
block|{
comment|/* length checks */
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|0
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|2
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|2
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|6
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
if|if
condition|(
name|pData
operator|->
name|iColortype
operator|==
literal|3
condition|)
block|{
name|mng_imagep
name|pImage
init|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
decl_stmt|;
name|mng_imagedatap
name|pBuf
decl_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* no object then check obj 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* address object buffer */
if|if
condition|(
name|iRawlen
operator|>
name|pBuf
operator|->
name|iPLTEcount
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
else|else
comment|/* if empty there must be global stuff! */
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasglobalTRNS
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CANNOTBEEMPTY
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|pData
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate tRNS available */
else|else
name|pData
operator|->
name|bHasglobalTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
block|{
name|mng_imagep
name|pImage
decl_stmt|;
name|mng_imagedatap
name|pBuf
decl_stmt|;
name|mng_uint8p
name|pRawdata2
decl_stmt|;
name|mng_uint32
name|iRawlen2
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* processing delta-image ? */
block|{
comment|/* store in object 0 !!! */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* address object buffer */
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
comment|/* store fields for future reference */
block|{
case|case
literal|0
case|:
block|{
comment|/* gray */
if|#
directive|if
name|defined
argument_list|(
name|MNG_NO_1_2_4BIT_SUPPORT
argument_list|)
name|mng_uint8
name|multiplier
index|[]
init|=
block|{
literal|0
block|,
literal|255
block|,
literal|85
block|,
literal|0
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|}
decl_stmt|;
endif|#
directive|endif
name|pBuf
operator|->
name|iTRNSgray
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iTRNSred
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNScount
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_NO_1_2_4BIT_SUPPORT
argument_list|)
name|pBuf
operator|->
name|iTRNSgray
operator|*=
name|multiplier
index|[
name|pData
operator|->
name|iPNGdepth
index|]
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|MNG_NO_16BIT_SUPPORT
argument_list|)
if|if
condition|(
name|pData
operator|->
name|iPNGmult
operator|==
literal|2
condition|)
name|pBuf
operator|->
name|iTRNSgray
operator|>>=
literal|8
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
name|pBuf
operator|->
name|iTRNSgray
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSred
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iTRNScount
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_NO_16BIT_SUPPORT
argument_list|)
if|if
condition|(
name|pData
operator|->
name|iPNGmult
operator|==
literal|2
condition|)
block|{
name|pBuf
operator|->
name|iTRNSred
operator|>>=
literal|8
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|>>=
literal|8
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|>>=
literal|8
expr_stmt|;
block|}
endif|#
directive|endif
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
name|pBuf
operator|->
name|iTRNSgray
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSred
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNScount
operator|=
name|iRawlen
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pBuf
operator|->
name|aTRNSentries
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|pBuf
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* tell it it's got a tRNS now */
block|}
else|else
endif|#
directive|endif
block|{
comment|/* address current object */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* no object then dump it in obj 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* address object buffer */
name|pBuf
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* and tell it it's got a tRNS now */
if|if
condition|(
name|iRawlen
operator|==
literal|0
condition|)
comment|/* if empty, inherit from global */
block|{
name|iRawlen2
operator|=
name|pData
operator|->
name|iGlobalTRNSrawlen
expr_stmt|;
name|pRawdata2
operator|=
call|(
name|mng_ptr
call|)
argument_list|(
name|pData
operator|->
name|aGlobalTRNSrawdata
argument_list|)
expr_stmt|;
comment|/* global length oke ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|0
operator|)
operator|&&
operator|(
name|iRawlen2
operator|!=
literal|2
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_GLOBALLENGTHERR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|2
operator|)
operator|&&
operator|(
name|iRawlen2
operator|!=
literal|6
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_GLOBALLENGTHERR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|3
operator|)
operator|&&
operator|(
operator|(
name|iRawlen2
operator|==
literal|0
operator|)
operator|||
operator|(
name|iRawlen2
operator|>
name|pBuf
operator|->
name|iPLTEcount
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_GLOBALLENGTHERR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iRawlen2
operator|=
name|iRawlen
expr_stmt|;
name|pRawdata2
operator|=
name|pRawdata
expr_stmt|;
block|}
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
comment|/* store fields for future reference */
block|{
case|case
literal|0
case|:
block|{
comment|/* gray */
name|pBuf
operator|->
name|iTRNSgray
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata2
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iTRNSred
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNScount
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_NO_16BIT_SUPPORT
argument_list|)
if|if
condition|(
name|pData
operator|->
name|iPNGmult
operator|==
literal|2
condition|)
name|pBuf
operator|->
name|iTRNSgray
operator|>>=
literal|8
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
name|pBuf
operator|->
name|iTRNSgray
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSred
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata2
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata2
operator|+
literal|2
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata2
operator|+
literal|4
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iTRNScount
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_NO_16BIT_SUPPORT
argument_list|)
if|if
condition|(
name|pData
operator|->
name|iPNGmult
operator|==
literal|2
condition|)
block|{
name|pBuf
operator|->
name|iTRNSred
operator|>>=
literal|8
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|>>=
literal|8
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|>>=
literal|8
expr_stmt|;
block|}
endif|#
directive|endif
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
name|pBuf
operator|->
name|iTRNSgray
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSred
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|iTRNScount
operator|=
name|iRawlen2
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pBuf
operator|->
name|aTRNSentries
argument_list|,
name|pRawdata2
argument_list|,
name|iRawlen2
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
else|else
comment|/* store as global */
block|{
name|pData
operator|->
name|iGlobalTRNSrawlen
operator|=
name|iRawlen
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pData
operator|->
name|aGlobalTRNSrawdata
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|{
comment|/* create an animation object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_trns
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iGlobalTRNSrawlen
argument_list|,
name|pData
operator|->
name|aGlobalTRNSrawdata
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
block|{
comment|/* not global! */
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bGlobal
operator|=
name|MNG_FALSE
expr_stmt|;
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iType
operator|=
name|pData
operator|->
name|iColortype
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|==
literal|0
condition|)
comment|/* if empty, indicate so */
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
name|MNG_TRUE
expr_stmt|;
else|else
block|{
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
name|MNG_FALSE
expr_stmt|;
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
comment|/* store fields */
block|{
case|case
literal|0
case|:
block|{
comment|/* gray */
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iGray
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRed
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iGreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBlue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
name|iRawlen
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
else|else
comment|/* it's global! */
block|{
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bGlobal
operator|=
name|MNG_TRUE
expr_stmt|;
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iType
operator|=
literal|0
expr_stmt|;
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRawlen
operator|=
name|iRawlen
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_trnsp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aRawdata
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_TRNS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_gama
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_GAMA
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAA
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
block|{
comment|/* length must be exactly 4 */
if|if
condition|(
name|iRawlen
operator|!=
literal|4
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* length must be empty or exactly 4 */
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|4
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|pData
operator|->
name|bHasGAMA
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate we've got it */
else|else
name|pData
operator|->
name|bHasglobalGAMA
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|!=
literal|0
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
block|{
name|mng_imagep
name|pImage
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* update delta image ? */
block|{
comment|/* store in object 0 ! */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* store for color-processing routines */
name|pImage
operator|->
name|pImgbuf
operator|->
name|iGamma
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasGAMA
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* no object then dump it in obj 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* store for color-processing routines */
name|pImage
operator|->
name|pImgbuf
operator|->
name|iGamma
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasGAMA
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* store as global */
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
name|pData
operator|->
name|iGlobalGamma
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
block|{
comment|/* create an animation object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_gama
argument_list|(
name|pData
argument_list|,
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
argument_list|,
name|pData
operator|->
name|iGlobalGamma
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_gamap
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
operator|(
operator|(
name|mng_gamap
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iGamma
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_GAMA
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_chrm
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CHRM
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAA
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
block|{
comment|/* length must be exactly 32 */
if|if
condition|(
name|iRawlen
operator|!=
literal|32
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* length must be empty or exactly 32 */
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|32
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|pData
operator|->
name|bHasCHRM
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate we've got it */
else|else
name|pData
operator|->
name|bHasglobalCHRM
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|!=
literal|0
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_uint32
name|iWhitepointx
decl_stmt|,
name|iWhitepointy
decl_stmt|;
name|mng_uint32
name|iPrimaryredx
decl_stmt|,
name|iPrimaryredy
decl_stmt|;
name|mng_uint32
name|iPrimarygreenx
decl_stmt|,
name|iPrimarygreeny
decl_stmt|;
name|mng_uint32
name|iPrimarybluex
decl_stmt|,
name|iPrimarybluey
decl_stmt|;
name|iWhitepointx
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|iWhitepointy
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iPrimaryredx
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
name|iPrimaryredy
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
name|iPrimarygreenx
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|)
expr_stmt|;
name|iPrimarygreeny
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|20
argument_list|)
expr_stmt|;
name|iPrimarybluex
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|24
argument_list|)
expr_stmt|;
name|iPrimarybluey
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|28
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
block|{
name|mng_imagep
name|pImage
decl_stmt|;
name|mng_imagedatap
name|pBuf
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* update delta image ? */
block|{
comment|/* store it in object 0 ! */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* address object buffer */
name|pBuf
operator|->
name|bHasCHRM
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* and tell it it's got a CHRM now */
comment|/* store for color-processing routines */
name|pBuf
operator|->
name|iWhitepointx
operator|=
name|iWhitepointx
expr_stmt|;
name|pBuf
operator|->
name|iWhitepointy
operator|=
name|iWhitepointy
expr_stmt|;
name|pBuf
operator|->
name|iPrimaryredx
operator|=
name|iPrimaryredx
expr_stmt|;
name|pBuf
operator|->
name|iPrimaryredy
operator|=
name|iPrimaryredy
expr_stmt|;
name|pBuf
operator|->
name|iPrimarygreenx
operator|=
name|iPrimarygreenx
expr_stmt|;
name|pBuf
operator|->
name|iPrimarygreeny
operator|=
name|iPrimarygreeny
expr_stmt|;
name|pBuf
operator|->
name|iPrimarybluex
operator|=
name|iPrimarybluex
expr_stmt|;
name|pBuf
operator|->
name|iPrimarybluey
operator|=
name|iPrimarybluey
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* no object then dump it in obj 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* address object buffer */
name|pBuf
operator|->
name|bHasCHRM
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* and tell it it's got a CHRM now */
comment|/* store for color-processing routines */
name|pBuf
operator|->
name|iWhitepointx
operator|=
name|iWhitepointx
expr_stmt|;
name|pBuf
operator|->
name|iWhitepointy
operator|=
name|iWhitepointy
expr_stmt|;
name|pBuf
operator|->
name|iPrimaryredx
operator|=
name|iPrimaryredx
expr_stmt|;
name|pBuf
operator|->
name|iPrimaryredy
operator|=
name|iPrimaryredy
expr_stmt|;
name|pBuf
operator|->
name|iPrimarygreenx
operator|=
name|iPrimarygreenx
expr_stmt|;
name|pBuf
operator|->
name|iPrimarygreeny
operator|=
name|iPrimarygreeny
expr_stmt|;
name|pBuf
operator|->
name|iPrimarybluex
operator|=
name|iPrimarybluex
expr_stmt|;
name|pBuf
operator|->
name|iPrimarybluey
operator|=
name|iPrimarybluey
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* store as global */
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
block|{
name|pData
operator|->
name|iGlobalWhitepointx
operator|=
name|iWhitepointx
expr_stmt|;
name|pData
operator|->
name|iGlobalWhitepointy
operator|=
name|iWhitepointy
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimaryredx
operator|=
name|iPrimaryredx
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimaryredy
operator|=
name|iPrimaryredy
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarygreenx
operator|=
name|iPrimarygreenx
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarygreeny
operator|=
name|iPrimarygreeny
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarybluex
operator|=
name|iPrimarybluex
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarybluey
operator|=
name|iPrimarybluey
expr_stmt|;
block|}
block|{
comment|/* create an animation object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_chrm
argument_list|(
name|pData
argument_list|,
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
argument_list|,
name|iWhitepointx
argument_list|,
name|iWhitepointy
argument_list|,
name|iPrimaryredx
argument_list|,
name|iPrimaryredy
argument_list|,
name|iPrimarygreenx
argument_list|,
name|iPrimarygreeny
argument_list|,
name|iPrimarybluex
argument_list|,
name|iPrimarybluey
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_chrmp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
operator|(
operator|(
name|mng_chrmp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iWhitepointx
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_chrmp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iWhitepointy
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_chrmp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRedx
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_chrmp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRedy
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_chrmp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iGreenx
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_chrmp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iGreeny
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|20
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_chrmp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBluex
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|24
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_chrmp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBluey
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|28
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CHRM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_srgb
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SRGB
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAA
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
block|{
comment|/* length must be exactly 1 */
if|if
condition|(
name|iRawlen
operator|!=
literal|1
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* length must be empty or exactly 1 */
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|1
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|pData
operator|->
name|bHasSRGB
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate we've got it */
else|else
name|pData
operator|->
name|bHasglobalSRGB
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|!=
literal|0
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
block|{
name|mng_imagep
name|pImage
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* update delta image ? */
block|{
comment|/* store in object 0 ! */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* store for color-processing routines */
name|pImage
operator|->
name|pImgbuf
operator|->
name|iRenderingintent
operator|=
operator|*
name|pRawdata
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasSRGB
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* no object then dump it in obj 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* store for color-processing routines */
name|pImage
operator|->
name|pImgbuf
operator|->
name|iRenderingintent
operator|=
operator|*
name|pRawdata
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasSRGB
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* store as global */
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
name|pData
operator|->
name|iGlobalRendintent
operator|=
operator|*
name|pRawdata
expr_stmt|;
block|{
comment|/* create an animation object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_srgb
argument_list|(
name|pData
argument_list|,
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
argument_list|,
name|pData
operator|->
name|iGlobalRendintent
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_srgbp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
operator|(
operator|(
name|mng_srgbp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRenderingintent
operator|=
operator|*
name|pRawdata
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SRGB
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_iccp
operator|)
block|{
name|mng_retcode
name|iRetcode
block|;
name|mng_uint8p
name|pTemp
block|;
name|mng_uint32
name|iCompressedsize
block|;
name|mng_uint32
name|iProfilesize
block|;
name|mng_uint32
name|iBufsize
operator|=
literal|0
block|;
name|mng_uint8p
name|pBuf
operator|=
literal|0
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ICCP
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAA
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
block|{
comment|/* length must be at least 2 */
if|if
condition|(
name|iRawlen
operator|<
literal|2
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* length must be empty or at least 2 */
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|iRawlen
operator|<
literal|2
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
end_if
begin_expr_stmt
name|pTemp
operator|=
name|find_null
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* find null-separator */
end_comment
begin_comment
comment|/* not found inside input-data ? */
end_comment
begin_if
if|if
condition|(
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_NULLNOTFOUND
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* determine size of compressed profile */
end_comment
begin_expr_stmt
name|iCompressedsize
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|iRawlen
operator|-
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
operator|-
literal|2
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* decompress the profile */
end_comment
begin_expr_stmt
name|iRetcode
operator|=
name|mng_inflate_buffer
argument_list|(
name|pData
argument_list|,
name|pTemp
operator|+
literal|2
argument_list|,
name|iCompressedsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBufsize
argument_list|,
operator|&
name|iProfilesize
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_CHECK_BAD_ICCP
end_ifdef
begin_comment
comment|/* Check for bad iCCP chunk */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRetcode
operator|)
operator|&&
operator|(
operator|!
name|strncmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pRawdata
argument_list|,
literal|"Photoshop ICC profile"
argument_list|,
literal|21
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|iRawlen
operator|==
literal|2615
condition|)
comment|/* is it the sRGB profile ? */
block|{
name|mng_chunk_header
name|chunk_srgb
init|=
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_CHUNKINITFREE
block|{
name|MNG_UINT_sRGB
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_srgb
block|,
name|mng_write_srgb
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_srgb
operator|)
block|}
decl_stmt|;
else|#
directive|else
block|{
name|MNG_UINT_sRGB
operator|,
name|mng_init_srgb
operator|,
name|mng_free_srgb
operator|,
name|mng_read_srgb
operator|,
name|mng_write_srgb
operator|,
name|mng_assign_srgb
operator|,
literal|0
operator|,
literal|0
block|}
empty_stmt|;
endif|#
directive|endif
comment|/* pretend it's an sRGB chunk then ! */
name|iRetcode
operator|=
name|mng_read_srgb
argument_list|(
name|pData
argument_list|,
operator|&
name|chunk_srgb
argument_list|,
literal|1
argument_list|,
operator|(
name|mng_ptr
operator|)
literal|"0"
argument_list|,
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffer */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
block|}
block|}
else|else
block|{
endif|#
directive|endif
comment|/* MNG_CHECK_BAD_ICCP */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffer */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|pData
operator|->
name|bHasICCP
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate we've got it */
else|else
name|pData
operator|->
name|bHasglobalICCP
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|!=
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
block|{
name|mng_imagep
name|pImage
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* update delta image ? */
block|{
comment|/* store in object 0 ! */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|pProfile
condition|)
comment|/* profile existed ? */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pImage
operator|->
name|pImgbuf
operator|->
name|pProfile
argument_list|,
name|pImage
operator|->
name|pImgbuf
operator|->
name|iProfilesize
argument_list|)
expr_stmt|;
comment|/* allocate a buffer& copy it */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pImage
operator|->
name|pImgbuf
operator|->
name|pProfile
argument_list|,
name|iProfilesize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|pProfile
argument_list|,
name|pBuf
argument_list|,
name|iProfilesize
argument_list|)
expr_stmt|;
comment|/* store its length as well */
name|pImage
operator|->
name|pImgbuf
operator|->
name|iProfilesize
operator|=
name|iProfilesize
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasICCP
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* no object then dump it in obj 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|pProfile
condition|)
comment|/* profile existed ? */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pImage
operator|->
name|pImgbuf
operator|->
name|pProfile
argument_list|,
name|pImage
operator|->
name|pImgbuf
operator|->
name|iProfilesize
argument_list|)
expr_stmt|;
comment|/* allocate a buffer& copy it */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pImage
operator|->
name|pImgbuf
operator|->
name|pProfile
argument_list|,
name|iProfilesize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|pProfile
argument_list|,
name|pBuf
argument_list|,
name|iProfilesize
argument_list|)
expr_stmt|;
comment|/* store its length as well */
name|pImage
operator|->
name|pImgbuf
operator|->
name|iProfilesize
operator|=
name|iProfilesize
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasICCP
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* store as global */
if|if
condition|(
name|iRawlen
operator|==
literal|0
condition|)
comment|/* empty chunk ? */
block|{
if|if
condition|(
name|pData
operator|->
name|pGlobalProfile
condition|)
comment|/* did we have a global profile ? */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pGlobalProfile
argument_list|,
name|pData
operator|->
name|iGlobalProfilesize
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iGlobalProfilesize
operator|=
literal|0
expr_stmt|;
comment|/* reset to null */
name|pData
operator|->
name|pGlobalProfile
operator|=
name|MNG_NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* allocate a global buffer& copy it */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pGlobalProfile
argument_list|,
name|iProfilesize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pData
operator|->
name|pGlobalProfile
argument_list|,
name|pBuf
argument_list|,
name|iProfilesize
argument_list|)
expr_stmt|;
comment|/* store its length as well */
name|pData
operator|->
name|iGlobalProfilesize
operator|=
name|iProfilesize
expr_stmt|;
block|}
comment|/* create an animation object */
name|iRetcode
operator|=
name|mng_create_ani_iccp
argument_list|(
name|pData
argument_list|,
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
argument_list|,
name|pData
operator|->
name|iGlobalProfilesize
argument_list|,
name|pData
operator|->
name|pGlobalProfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
endif|#
directive|endif
comment|/* MNG_SUPPORT_DISPLAY */
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffer */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
comment|/* store the fields */
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
comment|/* not empty ? */
block|{
if|if
condition|(
operator|!
name|pBuf
condition|)
comment|/* hasn't been unpuzzled it yet ? */
block|{
comment|/* find null-separator */
name|pTemp
operator|=
name|find_null
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
comment|/* not found inside input-data ? */
if|if
condition|(
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_NULLNOTFOUND
argument_list|)
expr_stmt|;
comment|/* determine size of compressed profile */
name|iCompressedsize
operator|=
name|iRawlen
operator|-
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
operator|-
literal|2
expr_stmt|;
comment|/* decompress the profile */
name|iRetcode
operator|=
name|mng_inflate_buffer
argument_list|(
name|pData
argument_list|,
name|pTemp
operator|+
literal|2
argument_list|,
name|iCompressedsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBufsize
argument_list|,
operator|&
name|iProfilesize
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffer */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
block|}
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|pTemp
operator|-
name|pRawdata
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
name|pRawdata
argument_list|,
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
argument_list|)
expr_stmt|;
block|}
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCompression
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iProfilesize
operator|=
name|iProfilesize
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pProfile
argument_list|,
name|iProfilesize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_iccpp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pProfile
argument_list|,
name|pBuf
argument_list|,
name|iProfilesize
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* MNG_STORE_CHUNKS */
if|if
condition|(
name|pBuf
condition|)
comment|/* free the temporary buffer */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_CHECK_BAD_ICCP
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ICCP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_tEXt
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_text
operator|)
block|{
name|mng_uint32
name|iKeywordlen
block|,
name|iTextlen
block|;
name|mng_pchar
name|zKeyword
block|,
name|zText
block|;
name|mng_uint8p
name|pTemp
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_TEXT
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|<
literal|2
condition|)
comment|/* length must be at least 2 */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pTemp
operator|=
name|find_null
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* find the null separator */
end_comment
begin_comment
comment|/* not found inside input-data ? */
end_comment
begin_if
if|if
condition|(
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_NULLNOTFOUND
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pTemp
operator|==
name|pRawdata
condition|)
comment|/* there must be at least 1 char for keyword */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_KEYWORDNULL
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|iKeywordlen
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|pTemp
operator|-
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iTextlen
operator|=
name|iRawlen
operator|-
name|iKeywordlen
operator|-
literal|1
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|pData
operator|->
name|fProcesstext
condition|)
comment|/* inform the application ? */
block|{
name|mng_bool
name|bOke
decl_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|zKeyword
argument_list|,
name|pRawdata
argument_list|,
name|iKeywordlen
argument_list|)
expr_stmt|;
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
name|zText
argument_list|,
name|iTextlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|zText
condition|)
comment|/* on error bail out */
block|{
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTOFMEMORY
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iTextlen
condition|)
name|MNG_COPY
argument_list|(
name|zText
argument_list|,
name|pTemp
operator|+
literal|1
argument_list|,
name|iTextlen
argument_list|)
expr_stmt|;
name|bOke
operator|=
name|pData
operator|->
name|fProcesstext
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|MNG_TYPE_TEXT
argument_list|,
name|zKeyword
argument_list|,
name|zText
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zText
argument_list|,
name|iTextlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bOke
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_textp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iKeywordsize
operator|=
name|iKeywordlen
expr_stmt|;
operator|(
operator|(
name|mng_textp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTextsize
operator|=
name|iTextlen
expr_stmt|;
if|if
condition|(
name|iKeywordlen
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_textp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_textp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeyword
argument_list|,
name|pRawdata
argument_list|,
name|iKeywordlen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iTextlen
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_textp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zText
argument_list|,
name|iTextlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_textp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zText
argument_list|,
name|pTemp
operator|+
literal|1
argument_list|,
name|iTextlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_TEXT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_zTXt
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_ztxt
operator|)
block|{
name|mng_retcode
name|iRetcode
block|;
name|mng_uint32
name|iKeywordlen
block|,
name|iTextlen
block|;
name|mng_pchar
name|zKeyword
block|;
name|mng_uint8p
name|pTemp
block|;
name|mng_uint32
name|iCompressedsize
block|;
name|mng_uint32
name|iBufsize
block|;
name|mng_uint8p
name|pBuf
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ZTXT
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|<
literal|3
condition|)
comment|/* length must be at least 3 */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pTemp
operator|=
name|find_null
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* find the null separator */
end_comment
begin_comment
comment|/* not found inside input-data ? */
end_comment
begin_if
if|if
condition|(
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_NULLNOTFOUND
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pTemp
operator|==
name|pRawdata
condition|)
comment|/* there must be at least 1 char for keyword */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_KEYWORDNULL
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
operator|!=
literal|0
condition|)
comment|/* only deflate compression-method allowed */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOMPRESS
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|iKeywordlen
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|pTemp
operator|-
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iCompressedsize
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|iRawlen
operator|-
name|iKeywordlen
operator|-
literal|2
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|zKeyword
operator|=
literal|0
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* there's no keyword buffer yet */
end_comment
begin_expr_stmt
name|pBuf
operator|=
literal|0
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* or a temporary buffer ! */
end_comment
begin_if
if|if
condition|(
name|pData
operator|->
name|fProcesstext
condition|)
comment|/* inform the application ? */
block|{
comment|/* decompress the text */
name|iRetcode
operator|=
name|mng_inflate_buffer
argument_list|(
name|pData
argument_list|,
name|pTemp
operator|+
literal|2
argument_list|,
name|iCompressedsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBufsize
argument_list|,
operator|&
name|iTextlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|zKeyword
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTOFMEMORY
argument_list|)
expr_stmt|;
block|}
name|MNG_COPY
argument_list|(
name|zKeyword
argument_list|,
name|pRawdata
argument_list|,
name|iKeywordlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcesstext
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|MNG_TYPE_ZTXT
argument_list|,
name|zKeyword
argument_list|,
operator|(
name|mng_pchar
operator|)
name|pBuf
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
comment|/* store the fields */
operator|(
operator|(
name|mng_ztxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iKeywordsize
operator|=
name|iKeywordlen
expr_stmt|;
operator|(
operator|(
name|mng_ztxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCompression
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|pBuf
operator|)
operator|&&
operator|(
name|iCompressedsize
operator|)
condition|)
comment|/* did we not get a text-buffer yet ? */
block|{
comment|/* decompress the text */
name|iRetcode
operator|=
name|mng_inflate_buffer
argument_list|(
name|pData
argument_list|,
name|pTemp
operator|+
literal|2
argument_list|,
name|iCompressedsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBufsize
argument_list|,
operator|&
name|iTextlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
block|}
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_ztxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* on error bail out */
if|if
condition|(
operator|!
operator|(
operator|(
name|mng_ztxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeyword
condition|)
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTOFMEMORY
argument_list|)
expr_stmt|;
block|}
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_ztxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeyword
argument_list|,
name|pRawdata
argument_list|,
name|iKeywordlen
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_ztxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTextsize
operator|=
name|iTextlen
expr_stmt|;
if|if
condition|(
name|iCompressedsize
condition|)
block|{
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_ztxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zText
argument_list|,
name|iTextlen
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* on error bail out */
if|if
condition|(
operator|!
operator|(
operator|(
name|mng_ztxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zText
condition|)
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTOFMEMORY
argument_list|)
expr_stmt|;
block|}
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_ztxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zText
argument_list|,
name|pBuf
argument_list|,
name|iTextlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_expr_stmt
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* free the temporary buffers */
end_comment
begin_expr_stmt
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ZTXT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iTXt
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_itxt
operator|)
block|{
name|mng_retcode
name|iRetcode
block|;
name|mng_uint32
name|iKeywordlen
block|,
name|iTextlen
block|,
name|iLanguagelen
block|,
name|iTranslationlen
block|;
name|mng_pchar
name|zKeyword
block|,
name|zLanguage
block|,
name|zTranslation
block|;
name|mng_uint8p
name|pNull1
block|,
name|pNull2
block|,
name|pNull3
block|;
name|mng_uint32
name|iCompressedsize
block|;
name|mng_uint8
name|iCompressionflag
block|;
name|mng_uint32
name|iBufsize
block|;
name|mng_uint8p
name|pBuf
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ITXT
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|<
literal|6
condition|)
comment|/* length must be at least 6 */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pNull1
operator|=
name|find_null
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* find the null separators */
end_comment
begin_expr_stmt
name|pNull2
operator|=
name|find_null
argument_list|(
name|pNull1
operator|+
literal|3
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pNull3
operator|=
name|find_null
argument_list|(
name|pNull2
operator|+
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* not found inside input-data ? */
end_comment
begin_if
if|if
condition|(
operator|(
operator|(
name|pNull1
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
operator|)
operator|||
operator|(
operator|(
name|pNull2
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
operator|)
operator|||
operator|(
operator|(
name|pNull3
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_NULLNOTFOUND
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pNull1
operator|==
name|pRawdata
condition|)
comment|/* there must be at least 1 char for keyword */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_KEYWORDNULL
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* compression or not ? */
end_comment
begin_if
if|if
condition|(
operator|(
operator|*
operator|(
name|pNull1
operator|+
literal|1
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pNull1
operator|+
literal|1
operator|)
operator|!=
literal|1
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOMPRESS
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|*
operator|(
name|pNull1
operator|+
literal|2
operator|)
operator|!=
literal|0
condition|)
comment|/* only deflate compression-method allowed */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOMPRESS
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|iKeywordlen
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|pNull1
operator|-
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iLanguagelen
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|pNull2
operator|-
name|pNull1
operator|-
literal|3
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iTranslationlen
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|pNull3
operator|-
name|pNull2
operator|-
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iCompressedsize
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|iRawlen
operator|-
name|iKeywordlen
operator|-
name|iLanguagelen
operator|-
name|iTranslationlen
operator|-
literal|5
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iCompressionflag
operator|=
operator|*
operator|(
name|pNull1
operator|+
literal|1
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|zKeyword
operator|=
literal|0
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* no buffers acquired yet */
end_comment
begin_expr_stmt
name|zLanguage
operator|=
literal|0
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|zTranslation
operator|=
literal|0
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pBuf
operator|=
literal|0
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iTextlen
operator|=
literal|0
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|pData
operator|->
name|fProcesstext
condition|)
comment|/* inform the application ? */
block|{
if|if
condition|(
name|iCompressionflag
condition|)
comment|/* decompress the text ? */
block|{
name|iRetcode
operator|=
name|mng_inflate_buffer
argument_list|(
name|pData
argument_list|,
name|pNull3
operator|+
literal|1
argument_list|,
name|iCompressedsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBufsize
argument_list|,
operator|&
name|iTextlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffer */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
block|}
else|else
block|{
name|iTextlen
operator|=
name|iCompressedsize
expr_stmt|;
name|iBufsize
operator|=
name|iTextlen
operator|+
literal|1
expr_stmt|;
comment|/* plus 1 for terminator byte!!! */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pBuf
argument_list|,
name|pNull3
operator|+
literal|1
argument_list|,
name|iTextlen
argument_list|)
expr_stmt|;
block|}
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
name|zLanguage
argument_list|,
name|iLanguagelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
name|zTranslation
argument_list|,
name|iTranslationlen
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* on error bail out */
if|if
condition|(
operator|(
operator|!
name|zKeyword
operator|)
operator|||
operator|(
operator|!
name|zLanguage
operator|)
operator|||
operator|(
operator|!
name|zTranslation
operator|)
condition|)
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zTranslation
argument_list|,
name|iTranslationlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zLanguage
argument_list|,
name|iLanguagelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTOFMEMORY
argument_list|)
expr_stmt|;
block|}
name|MNG_COPY
argument_list|(
name|zKeyword
argument_list|,
name|pRawdata
argument_list|,
name|iKeywordlen
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|zLanguage
argument_list|,
name|pNull1
operator|+
literal|3
argument_list|,
name|iLanguagelen
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|zTranslation
argument_list|,
name|pNull2
operator|+
literal|1
argument_list|,
name|iTranslationlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcesstext
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|MNG_TYPE_ITXT
argument_list|,
name|zKeyword
argument_list|,
operator|(
name|mng_pchar
operator|)
name|pBuf
argument_list|,
name|zLanguage
argument_list|,
name|zTranslation
argument_list|)
condition|)
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zTranslation
argument_list|,
name|iTranslationlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zLanguage
argument_list|,
name|iLanguagelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zTranslation
argument_list|,
name|iTranslationlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zLanguage
argument_list|,
name|iLanguagelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
comment|/* store the fields */
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iKeywordsize
operator|=
name|iKeywordlen
expr_stmt|;
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLanguagesize
operator|=
name|iLanguagelen
expr_stmt|;
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTranslationsize
operator|=
name|iTranslationlen
expr_stmt|;
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCompressionflag
operator|=
operator|*
operator|(
name|pNull1
operator|+
literal|1
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCompressionmethod
operator|=
operator|*
operator|(
name|pNull1
operator|+
literal|2
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|pBuf
operator|)
operator|&&
operator|(
name|iCompressedsize
operator|)
condition|)
comment|/* did we not get a text-buffer yet ? */
block|{
if|if
condition|(
name|iCompressionflag
condition|)
comment|/* decompress the text ? */
block|{
name|iRetcode
operator|=
name|mng_inflate_buffer
argument_list|(
name|pData
argument_list|,
name|pNull3
operator|+
literal|1
argument_list|,
name|iCompressedsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBufsize
argument_list|,
operator|&
name|iTextlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zTranslation
argument_list|,
name|iTranslationlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zLanguage
argument_list|,
name|iLanguagelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
block|}
else|else
block|{
name|iTextlen
operator|=
name|iCompressedsize
expr_stmt|;
name|iBufsize
operator|=
name|iTextlen
operator|+
literal|1
expr_stmt|;
comment|/* plus 1 for terminator byte!!! */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pBuf
argument_list|,
name|pNull3
operator|+
literal|1
argument_list|,
name|iTextlen
argument_list|)
expr_stmt|;
block|}
block|}
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zLanguage
argument_list|,
name|iLanguagelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zTranslation
argument_list|,
name|iTranslationlen
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* on error bail out */
if|if
condition|(
operator|(
operator|!
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeyword
operator|)
operator|||
operator|(
operator|!
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zLanguage
operator|)
operator|||
operator|(
operator|!
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zTranslation
operator|)
condition|)
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zTranslation
argument_list|,
name|iTranslationlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zLanguage
argument_list|,
name|iLanguagelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTOFMEMORY
argument_list|)
expr_stmt|;
block|}
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeyword
argument_list|,
name|pRawdata
argument_list|,
name|iKeywordlen
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zLanguage
argument_list|,
name|pNull1
operator|+
literal|3
argument_list|,
name|iLanguagelen
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zTranslation
argument_list|,
name|pNull2
operator|+
literal|1
argument_list|,
name|iTranslationlen
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTextsize
operator|=
name|iTextlen
expr_stmt|;
if|if
condition|(
name|iTextlen
condition|)
block|{
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zText
argument_list|,
name|iTextlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zText
condition|)
block|{
comment|/* don't forget to drop the temp buffers */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zTranslation
argument_list|,
name|iTranslationlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zLanguage
argument_list|,
name|iLanguagelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTOFMEMORY
argument_list|)
expr_stmt|;
block|}
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_itxtp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zText
argument_list|,
name|pBuf
argument_list|,
name|iTextlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_comment
comment|/* free the temporary buffers */
end_comment
begin_expr_stmt
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zTranslation
argument_list|,
name|iTranslationlen
operator|+
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zLanguage
argument_list|,
name|iLanguagelen
operator|+
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeyword
argument_list|,
name|iKeywordlen
operator|+
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ITXT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_bKGD
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_bkgd
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
name|mng_imagep
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
block|;
name|mng_imagedatap
name|pBuf
block|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_BKGD
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAA
operator|)
condition|)
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|bHasIDAT
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|>
literal|6
condition|)
comment|/* it just can't be bigger than that! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_comment
comment|/* length checks */
end_comment
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasJHDR
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
literal|8
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
literal|12
operator|)
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|2
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
literal|10
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
literal|14
operator|)
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|6
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
comment|/* MNG_INCLUDE_JNG */
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|0
operator|)
operator|||
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|4
operator|)
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|2
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|2
operator|)
operator|||
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|6
operator|)
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|6
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|3
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|1
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|iRawlen
operator|!=
literal|6
condition|)
comment|/* global is always 16-bit RGB ! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|pData
operator|->
name|bHasBKGD
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate bKGD available */
else|else
name|pData
operator|->
name|bHasglobalBKGD
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|!=
literal|0
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_if
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* if no object dump it in obj 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
end_if
begin_expr_stmt
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* address object buffer */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasJHDR
condition|)
block|{
name|pBuf
operator|->
name|bHasBKGD
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* tell the object it's got bKGD now */
switch|switch
condition|(
name|pData
operator|->
name|iJHDRcolortype
condition|)
comment|/* store fields for future reference */
block|{
case|case
literal|8
case|:
empty_stmt|;
comment|/* gray */
case|case
literal|12
case|:
block|{
comment|/* graya */
name|pBuf
operator|->
name|iBKGDgray
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|10
case|:
empty_stmt|;
comment|/* rgb */
case|case
literal|14
case|:
block|{
comment|/* rgba */
name|pBuf
operator|->
name|iBKGDred
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iBKGDgreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iBKGDblue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
elseif|else
endif|#
directive|endif
comment|/* MNG_INCLUDE_JNG */
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
block|{
name|pBuf
operator|->
name|bHasBKGD
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* tell the object it's got bKGD now */
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
comment|/* store fields for future reference */
block|{
case|case
literal|0
case|:
empty_stmt|;
comment|/* gray */
case|case
literal|4
case|:
block|{
comment|/* graya */
name|pBuf
operator|->
name|iBKGDgray
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
empty_stmt|;
comment|/* rgb */
case|case
literal|6
case|:
block|{
comment|/* rgba */
name|pBuf
operator|->
name|iBKGDred
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iBKGDgreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|iBKGDblue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
name|pBuf
operator|->
name|iBKGDindex
operator|=
operator|*
name|pRawdata
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
comment|/* store as global */
block|{
if|if
condition|(
name|iRawlen
condition|)
block|{
name|pData
operator|->
name|iGlobalBKGDred
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iGlobalBKGDgreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iGlobalBKGDblue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
block|{
comment|/* create an animation object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_bkgd
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iGlobalBKGDred
argument_list|,
name|pData
operator|->
name|iGlobalBKGDgreen
argument_list|,
name|pData
operator|->
name|iGlobalBKGDblue
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iType
operator|=
name|pData
operator|->
name|iColortype
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
switch|switch
condition|(
name|iRawlen
condition|)
comment|/* guess from length */
block|{
case|case
literal|1
case|:
block|{
comment|/* indexed */
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iType
operator|=
literal|3
expr_stmt|;
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iIndex
operator|=
operator|*
name|pRawdata
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* gray */
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iType
operator|=
literal|0
expr_stmt|;
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iGray
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|6
case|:
block|{
comment|/* rgb */
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iType
operator|=
literal|2
expr_stmt|;
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRed
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iGreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_bkgdp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBlue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_BKGD
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_pHYs
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_phys
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PHYS
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAA
operator|)
condition|)
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|bHasIDAT
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* it's 9 bytes or empty; no more, no less! */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|9
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|0
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* TODO: something !!! */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_physp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
operator|(
operator|(
name|mng_physp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSizex
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_physp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSizey
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_physp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iUnit
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PHYS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sBIT
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_sbit
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SBIT
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAT
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJDAA
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasPLTE
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
comment|/* it just can't be bigger than that! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_comment
comment|/* length checks */
end_comment
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasJHDR
condition|)
block|{
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
literal|8
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|1
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
literal|10
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|3
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
literal|12
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|2
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
literal|14
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|4
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
comment|/* MNG_INCLUDE_JNG */
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|0
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|1
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|2
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|3
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|3
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|3
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|4
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|2
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
literal|6
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|4
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* global = empty or RGBA */
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|4
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* TODO: something !!! */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_sbitp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
name|pData
operator|->
name|bHasJHDR
condition|)
operator|(
operator|(
name|mng_sbitp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iType
operator|=
name|pData
operator|->
name|iJHDRcolortype
expr_stmt|;
elseif|else
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|bHasIHDR
condition|)
operator|(
operator|(
name|mng_sbitp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iType
operator|=
name|pData
operator|->
name|iColortype
expr_stmt|;
else|else
comment|/* global ! */
operator|(
operator|(
name|mng_sbitp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iType
operator|=
literal|6
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|0
condition|)
operator|(
operator|(
name|mng_sbitp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aBits
index|[
literal|0
index|]
operator|=
operator|*
name|pRawdata
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|1
condition|)
operator|(
operator|(
name|mng_sbitp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aBits
index|[
literal|1
index|]
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|2
condition|)
operator|(
operator|(
name|mng_sbitp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aBits
index|[
literal|2
index|]
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|3
condition|)
operator|(
operator|(
name|mng_sbitp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aBits
index|[
literal|3
index|]
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SBIT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sPLT
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_splt
operator|)
block|{
name|mng_uint8p
name|pTemp
block|;
name|mng_uint32
name|iNamelen
block|;
name|mng_uint8
name|iSampledepth
block|;
name|mng_uint32
name|iRemain
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SPLT
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasIDAT
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
condition|)
block|{
name|pTemp
operator|=
name|find_null
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
comment|/* find null-separator */
comment|/* not found inside input-data ? */
if|if
condition|(
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_NULLNOTFOUND
argument_list|)
expr_stmt|;
name|iNamelen
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|pTemp
operator|-
name|pRawdata
argument_list|)
expr_stmt|;
name|iSampledepth
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
expr_stmt|;
name|iRemain
operator|=
operator|(
name|iRawlen
operator|-
literal|2
operator|-
name|iNamelen
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|iSampledepth
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|iSampledepth
operator|!=
literal|2
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVSAMPLEDEPTH
argument_list|)
expr_stmt|;
comment|/* check remaining length */
if|if
condition|(
operator|(
operator|(
name|iSampledepth
operator|==
literal|1
operator|)
operator|&&
operator|(
name|iRemain
operator|%
literal|6
operator|!=
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|iSampledepth
operator|==
literal|2
operator|)
operator|&&
operator|(
name|iRemain
operator|%
literal|10
operator|!=
literal|0
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pTemp
operator|=
name|MNG_NULL
expr_stmt|;
name|iNamelen
operator|=
literal|0
expr_stmt|;
name|iSampledepth
operator|=
literal|0
expr_stmt|;
name|iRemain
operator|=
literal|0
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* TODO: something !!! */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_spltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
operator|(
operator|(
name|mng_spltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
operator|=
name|iNamelen
expr_stmt|;
operator|(
operator|(
name|mng_spltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSampledepth
operator|=
name|iSampledepth
expr_stmt|;
if|if
condition|(
name|iSampledepth
operator|==
literal|1
condition|)
operator|(
operator|(
name|mng_spltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iEntrycount
operator|=
name|iRemain
operator|/
literal|6
expr_stmt|;
else|else
operator|(
operator|(
name|mng_spltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iEntrycount
operator|=
name|iRemain
operator|/
literal|10
expr_stmt|;
if|if
condition|(
name|iNamelen
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_spltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
name|iNamelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_spltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
name|pRawdata
argument_list|,
name|iNamelen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRemain
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_spltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pEntries
argument_list|,
name|iRemain
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_spltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pEntries
argument_list|,
name|pTemp
operator|+
literal|2
argument_list|,
name|iRemain
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SPLT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_hIST
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_hist
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_HIST
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasPLTE
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasIDAT
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* length oke ? */
end_comment
begin_if
if|if
condition|(
operator|(
operator|(
name|iRawlen
operator|&
literal|0x01
operator|)
operator|!=
literal|0
operator|)
operator|||
operator|(
operator|(
name|iRawlen
operator|>>
literal|1
operator|)
operator|!=
name|pData
operator|->
name|iPLTEcount
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* TODO: something !!! */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
name|mng_uint32
name|iX
decl_stmt|;
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_histp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iEntrycount
operator|=
name|iRawlen
operator|>>
literal|1
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
operator|(
name|iRawlen
operator|>>
literal|1
operator|)
condition|;
name|iX
operator|++
control|)
block|{
operator|(
operator|(
name|mng_histp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
index|[
name|iX
index|]
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pRawdata
operator|+=
literal|2
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_HIST
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_tIME
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_time
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_TIME
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|!=
literal|7
condition|)
comment|/* length must be exactly 7 */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/*  if (pData->fProcesstime) */
end_comment
begin_comment
comment|/* inform the application ? */
end_comment
begin_comment
comment|/*  {      pData->fProcesstime ((mng_handle)pData, );   } */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_timep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iYear
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_timep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMonth
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_timep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDay
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_timep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iHour
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_timep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMinute
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|5
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_timep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSecond
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|6
operator|)
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_TIME
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_mhdr
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MHDR
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|eSigtype
operator|!=
name|mng_it_mng
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CHUNKNOTALLOWED
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasheader
condition|)
comment|/* can only be the first chunk! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* correct length ? */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_OLD_VERSIONS
end_ifndef
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|28
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|12
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|28
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasMHDR
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* oh boy, a real MNG */
end_comment
begin_expr_stmt
name|pData
operator|->
name|bHasheader
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* we've got a header */
end_comment
begin_expr_stmt
name|pData
operator|->
name|eImagetype
operator|=
name|mng_it_mng
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* fill header fields */
end_comment
begin_expr_stmt
name|pData
operator|->
name|iWidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iHeight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iTicks
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_OLD_VERSIONS
end_ifndef
begin_if
if|if
condition|(
name|iRawlen
operator|==
literal|28
condition|)
comment|/* proper MHDR ? */
block|{
endif|#
directive|endif
name|pData
operator|->
name|iLayercount
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iFramecount
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iPlaytime
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|20
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iSimplicity
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|24
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_OLD_VERSIONS
name|pData
operator|->
name|bPreDraft48
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
else|else
comment|/* probably pre-draft48 then */
block|{
name|pData
operator|->
name|iLayercount
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iFramecount
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iPlaytime
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iSimplicity
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|bPreDraft48
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* predict alpha-depth */
end_comment
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iSimplicity
operator|&
literal|0x00000001
operator|)
operator|==
literal|0
condition|)
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
name|pData
operator|->
name|iAlphadepth
operator|=
literal|16
expr_stmt|;
end_if
begin_comment
comment|/* no indicators = assume the worst */
end_comment
begin_else
else|#
directive|else
end_else
begin_expr_stmt
name|pData
operator|->
name|iAlphadepth
operator|=
literal|8
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* anything else = assume the worst */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_elseif
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iSimplicity
operator|&
literal|0x00000008
operator|)
operator|==
literal|0
condition|)
name|pData
operator|->
name|iAlphadepth
operator|=
literal|0
expr_stmt|;
end_elseif
begin_comment
comment|/* no transparency at all */
end_comment
begin_elseif
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iSimplicity
operator|&
literal|0x00000140
operator|)
operator|==
literal|0x00000040
condition|)
name|pData
operator|->
name|iAlphadepth
operator|=
literal|1
expr_stmt|;
end_elseif
begin_comment
comment|/* no semi-transparency guaranteed */
end_comment
begin_else
else|else
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
name|pData
operator|->
name|iAlphadepth
operator|=
literal|16
expr_stmt|;
end_else
begin_comment
comment|/* anything else = assume the worst */
end_comment
begin_else
else|#
directive|else
end_else
begin_expr_stmt
name|pData
operator|->
name|iAlphadepth
operator|=
literal|8
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* anything else = assume the worst */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_comment
comment|/* can we handle the complexity ? */
end_comment
begin_if
if|if
condition|(
name|pData
operator|->
name|iSimplicity
operator|&
literal|0x0000FC00
condition|)
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|iSimplicity
operator|&
literal|0x0000FC10
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_MNGTOOCOMPLEX
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* fits on maximum canvas ? */
end_comment
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iWidth
operator|>
name|pData
operator|->
name|iMaxwidth
operator|)
operator|||
operator|(
name|pData
operator|->
name|iHeight
operator|>
name|pData
operator|->
name|iMaxheight
operator|)
condition|)
name|MNG_WARNING
argument_list|(
name|pData
argument_list|,
name|MNG_IMAGETOOLARGE
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|fProcessheader
condition|)
comment|/* inform the app ? */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessheader
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|pData
operator|->
name|iWidth
argument_list|,
name|pData
operator|->
name|iHeight
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|iImagelevel
operator|++
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* one level deeper */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_mhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iWidth
operator|=
name|pData
operator|->
name|iWidth
expr_stmt|;
operator|(
operator|(
name|mng_mhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iHeight
operator|=
name|pData
operator|->
name|iHeight
expr_stmt|;
operator|(
operator|(
name|mng_mhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTicks
operator|=
name|pData
operator|->
name|iTicks
expr_stmt|;
operator|(
operator|(
name|mng_mhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLayercount
operator|=
name|pData
operator|->
name|iLayercount
expr_stmt|;
operator|(
operator|(
name|mng_mhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFramecount
operator|=
name|pData
operator|->
name|iFramecount
expr_stmt|;
operator|(
operator|(
name|mng_mhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iPlaytime
operator|=
name|pData
operator|->
name|iPlaytime
expr_stmt|;
operator|(
operator|(
name|mng_mhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSimplicity
operator|=
name|pData
operator|->
name|iSimplicity
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_mend
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MEND
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|>
literal|0
condition|)
comment|/* must not contain data! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* do something */
name|mng_retcode
name|iRetcode
init|=
name|mng_process_display_mend
argument_list|(
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iTotalframes
condition|)
comment|/* save totals */
name|pData
operator|->
name|iTotalframes
operator|=
name|pData
operator|->
name|iFrameseq
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iTotallayers
condition|)
name|pData
operator|->
name|iTotallayers
operator|=
name|pData
operator|->
name|iLayerseq
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iTotalplaytime
condition|)
name|pData
operator|->
name|iTotalplaytime
operator|=
name|pData
operator|->
name|iFrametime
expr_stmt|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_expr_stmt
name|pData
operator|->
name|bHasMHDR
operator|=
name|MNG_FALSE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* end of the line, bro! */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MEND
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_LOOP
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_loop
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_LOOP
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
operator|!
name|pData
operator|->
name|bCacheplayback
condition|)
comment|/* must store playback info to work!! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_LOOPWITHCACHEOFF
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|>=
literal|5
condition|)
comment|/* length checks */
block|{
if|if
condition|(
name|iRawlen
operator|>=
literal|6
condition|)
block|{
if|if
condition|(
operator|(
name|iRawlen
operator|-
literal|6
operator|)
operator|%
literal|4
operator|!=
literal|0
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_uint8
name|iLevel
decl_stmt|;
name|mng_uint32
name|iRepeat
decl_stmt|;
name|mng_uint8
name|iTermination
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iItermin
init|=
literal|1
decl_stmt|;
name|mng_uint32
name|iItermax
init|=
literal|0x7fffffffL
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|pData
operator|->
name|bHasLOOP
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate we're inside a loop */
name|iLevel
operator|=
operator|*
name|pRawdata
expr_stmt|;
comment|/* determine the fields for processing */
ifndef|#
directive|ifndef
name|MNG_NO_OLD_VERSIONS
if|if
condition|(
name|pData
operator|->
name|bPreDraft48
condition|)
block|{
name|iTermination
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
expr_stmt|;
name|iRepeat
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|iRepeat
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>=
literal|6
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_OLD_VERSIONS
if|if
condition|(
operator|!
name|pData
operator|->
name|bPreDraft48
condition|)
endif|#
directive|endif
name|iTermination
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|5
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>=
literal|10
condition|)
block|{
name|iItermin
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>=
literal|14
condition|)
block|{
name|iItermax
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|10
argument_list|)
expr_stmt|;
comment|/* TODO: process signals */
block|}
block|}
block|}
comment|/* create the LOOP ani-object */
name|iRetcode
operator|=
name|mng_create_ani_loop
argument_list|(
name|pData
argument_list|,
name|iLevel
argument_list|,
name|iRepeat
argument_list|,
name|iTermination
argument_list|,
name|iItermin
argument_list|,
name|iItermax
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* skip till matching ENDL if iteration=0 */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
operator|&&
operator|(
name|iRepeat
operator|==
literal|0
operator|)
condition|)
name|pData
operator|->
name|bSkipping
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
name|iRawlen
operator|>=
literal|5
condition|)
comment|/* store the fields */
block|{
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLevel
operator|=
operator|*
name|pRawdata
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_OLD_VERSIONS
if|if
condition|(
name|pData
operator|->
name|bPreDraft48
condition|)
block|{
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTermination
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRepeat
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRepeat
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>=
literal|6
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_OLD_VERSIONS
if|if
condition|(
operator|!
name|pData
operator|->
name|bPreDraft48
condition|)
endif|#
directive|endif
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTermination
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|5
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>=
literal|10
condition|)
block|{
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iItermin
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|6
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_LOOP_SIGNALS_SUPPORTED
if|if
condition|(
name|iRawlen
operator|>=
literal|14
condition|)
block|{
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iItermax
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|10
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
operator|(
name|iRawlen
operator|-
literal|14
operator|)
operator|/
literal|4
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pSignals
argument_list|,
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|<<
literal|2
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_BIGENDIAN_SUPPORTED
block|{
name|mng_uint32
name|iX
decl_stmt|;
name|mng_uint8p
name|pIn
init|=
name|pRawdata
operator|+
literal|14
decl_stmt|;
name|mng_uint32p
name|pOut
init|=
call|(
name|mng_uint32p
call|)
argument_list|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
argument_list|)
operator|->
name|pSignals
decl_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
operator|*
name|pOut
operator|++
operator|=
name|mng_get_uint32
argument_list|(
name|pIn
argument_list|)
expr_stmt|;
name|pIn
operator|+=
literal|4
expr_stmt|;
block|}
block|}
else|#
directive|else
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pSignals
argument_list|,
name|pRawdata
operator|+
literal|14
argument_list|,
operator|(
operator|(
name|mng_loopp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|<<
literal|2
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* !MNG_BIGENDIAN_SUPPORTED */
block|}
block|}
endif|#
directive|endif
block|}
block|}
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_LOOP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_LOOP
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_endl
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ENDL
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|!=
literal|1
condition|)
comment|/* length must be exactly 1 */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
if|if
condition|(
name|pData
operator|->
name|bHasLOOP
condition|)
comment|/* are we really processing a loop ? */
block|{
name|mng_uint8
name|iLevel
init|=
operator|*
name|pRawdata
decl_stmt|;
comment|/* get the nest level */
comment|/* create an ENDL animation object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_endl
argument_list|(
name|pData
argument_list|,
name|iLevel
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/*      {         mng_ani_endlp pENDL = (mng_ani_endlp)pData->pLastaniobj;          iRetcode = pENDL->sHeader.fProcess (pData, pENDL);          if (iRetcode)           return iRetcode;       } */
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_NOMATCHINGLOOP
argument_list|)
expr_stmt|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_endlp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLevel
operator|=
operator|*
name|pRawdata
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ENDL
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DEFI
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_defi
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DEFI
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* check the length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|3
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|4
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|12
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|28
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
name|pData
operator|->
name|iDEFIobjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|2
condition|)
block|{
name|pData
operator|->
name|bDEFIhasdonotshow
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iDEFIdonotshow
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
expr_stmt|;
block|}
else|else
block|{
name|pData
operator|->
name|bDEFIhasdonotshow
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iDEFIdonotshow
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>
literal|3
condition|)
block|{
name|pData
operator|->
name|bDEFIhasconcrete
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iDEFIconcrete
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
expr_stmt|;
block|}
else|else
block|{
name|pData
operator|->
name|bDEFIhasconcrete
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iDEFIconcrete
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
block|{
name|pData
operator|->
name|bDEFIhasloca
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iDEFIlocax
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDEFIlocay
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pData
operator|->
name|bDEFIhasloca
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iDEFIlocax
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iDEFIlocay
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>
literal|12
condition|)
block|{
name|pData
operator|->
name|bDEFIhasclip
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iDEFIclipl
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDEFIclipr
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDEFIclipt
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|20
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDEFIclipb
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|24
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pData
operator|->
name|bDEFIhasclip
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iDEFIclipl
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iDEFIclipr
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iDEFIclipt
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iDEFIclipb
operator|=
literal|0
expr_stmt|;
block|}
comment|/* create an animation object */
name|iRetcode
operator|=
name|mng_create_ani_defi
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* do display processing */
name|iRetcode
operator|=
name|mng_process_display_defi
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|2
condition|)
block|{
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasdonotshow
operator|=
name|MNG_TRUE
expr_stmt|;
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDonotshow
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
expr_stmt|;
block|}
else|else
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasdonotshow
operator|=
name|MNG_FALSE
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|3
condition|)
block|{
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasconcrete
operator|=
name|MNG_TRUE
expr_stmt|;
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iConcrete
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
expr_stmt|;
block|}
else|else
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasconcrete
operator|=
name|MNG_FALSE
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
block|{
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasloca
operator|=
name|MNG_TRUE
expr_stmt|;
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iXlocation
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iYlocation
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasloca
operator|=
name|MNG_FALSE
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|12
condition|)
block|{
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasclip
operator|=
name|MNG_TRUE
expr_stmt|;
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLeftcb
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRightcb
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTopcb
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|20
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBottomcb
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|24
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
operator|(
name|mng_defip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasclip
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DEFI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BASI
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_basi
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_BASI
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* check the length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|13
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|19
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|21
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|22
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasBASI
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* inside a BASI-IEND block now */
end_comment
begin_comment
comment|/* store interesting fields */
end_comment
begin_expr_stmt
name|pData
operator|->
name|iDatawidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iDataheight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iBitdepth
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iColortype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iCompression
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|10
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iFilter
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|11
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iInterlace
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
expr_stmt|;
end_expr_stmt
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_NO_1_2_4BIT_SUPPORT
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_NO_16BIT_SUPPORT
argument_list|)
end_if
begin_expr_stmt
name|pData
operator|->
name|iPNGmult
operator|=
literal|1
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iPNGdepth
operator|=
name|pData
operator|->
name|iBitdepth
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_NO_1_2_4BIT_SUPPORT
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<
literal|8
condition|)
name|pData
operator|->
name|iBitdepth
operator|=
literal|8
expr_stmt|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_NO_16BIT_SUPPORT
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
block|{
name|pData
operator|->
name|iBitdepth
operator|=
literal|8
expr_stmt|;
name|pData
operator|->
name|iPNGmult
operator|=
literal|2
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|8
operator|)
comment|/* parameter validity checks */
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|4
operator|)
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|!=
literal|16
operator|)
endif|#
directive|endif
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAY
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_INDEXED
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAYA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOLORTYPE
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_INDEXED
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|>
literal|8
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGB
operator|)
operator|||
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|<
literal|8
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|iCompression
operator|!=
name|MNG_COMPRESSION_DEFLATE
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOMPRESS
argument_list|)
expr_stmt|;
end_if
begin_if
if|#
directive|if
name|defined
argument_list|(
name|FILTER192
argument_list|)
operator|||
name|defined
argument_list|(
name|FILTER193
argument_list|)
end_if
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_ADAPTIVE
operator|)
operator|&&
if|#
directive|if
name|defined
argument_list|(
name|FILTER192
argument_list|)
operator|&&
name|defined
argument_list|(
name|FILTER193
argument_list|)
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_DIFFERING
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_NOFILTER
operator|)
condition|)
else|#
directive|else
ifdef|#
directive|ifdef
name|FILTER192
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_DIFFERING
operator|)
end_if
begin_else
unit|)
else|#
directive|else
end_else
begin_expr_stmt
operator|(
name|pData
operator|->
name|iFilter
operator|!=
name|MNG_FILTER_NOFILTER
operator|)
end_expr_stmt
begin_endif
unit|)
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_expr_stmt
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFILTER
argument_list|)
expr_stmt|;
end_expr_stmt
begin_else
else|#
directive|else
end_else
begin_if
if|if
condition|(
name|pData
operator|->
name|iFilter
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFILTER
argument_list|)
expr_stmt|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iInterlace
operator|!=
name|MNG_INTERLACE_NONE
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iInterlace
operator|!=
name|MNG_INTERLACE_ADAM7
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDINTERLACE
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|iImagelevel
operator|++
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* one level deeper */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_uint16
name|iRed
init|=
literal|0
decl_stmt|;
name|mng_uint16
name|iGreen
init|=
literal|0
decl_stmt|;
name|mng_uint16
name|iBlue
init|=
literal|0
decl_stmt|;
name|mng_bool
name|bHasalpha
init|=
name|MNG_FALSE
decl_stmt|;
name|mng_uint16
name|iAlpha
init|=
literal|0xFFFF
decl_stmt|;
name|mng_uint8
name|iViewable
init|=
literal|0
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|13
condition|)
comment|/* get remaining fields, if any */
block|{
name|iRed
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|13
argument_list|)
expr_stmt|;
name|iGreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|15
argument_list|)
expr_stmt|;
name|iBlue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|17
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>
literal|19
condition|)
block|{
name|bHasalpha
operator|=
name|MNG_TRUE
expr_stmt|;
name|iAlpha
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|19
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>
literal|21
condition|)
name|iViewable
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|21
operator|)
expr_stmt|;
comment|/* create an animation object */
name|iRetcode
operator|=
name|mng_create_ani_basi
argument_list|(
name|pData
argument_list|,
name|iRed
argument_list|,
name|iGreen
argument_list|,
name|iBlue
argument_list|,
name|bHasalpha
argument_list|,
name|iAlpha
argument_list|,
name|iViewable
argument_list|)
expr_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_basi (pData, iRed, iGreen, iBlue,                                            bHasalpha, iAlpha, iViewable); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iWidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iHeight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
operator|>
literal|8
condition|)
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBitdepth
operator|=
literal|8
expr_stmt|;
else|else
endif|#
directive|endif
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBitdepth
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iColortype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCompression
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|10
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFilter
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|11
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iInterlace
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|13
condition|)
block|{
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRed
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|13
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iGreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|15
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBlue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|17
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>
literal|19
condition|)
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iAlpha
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|19
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|21
condition|)
operator|(
operator|(
name|mng_basip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iViewable
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|21
operator|)
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_BASI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLON
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_clon
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CLON
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* check the length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|4
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|5
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|6
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|7
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|16
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_uint16
name|iSourceid
decl_stmt|,
name|iCloneid
decl_stmt|;
name|mng_uint8
name|iClonetype
init|=
literal|0
decl_stmt|;
name|mng_bool
name|bHasdonotshow
init|=
name|MNG_FALSE
decl_stmt|;
name|mng_uint8
name|iDonotshow
init|=
literal|0
decl_stmt|;
name|mng_uint8
name|iConcrete
init|=
literal|0
decl_stmt|;
name|mng_bool
name|bHasloca
init|=
name|MNG_FALSE
decl_stmt|;
name|mng_uint8
name|iLocationtype
init|=
literal|0
decl_stmt|;
name|mng_int32
name|iLocationx
init|=
literal|0
decl_stmt|;
name|mng_int32
name|iLocationy
init|=
literal|0
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|iSourceid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|iCloneid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
name|iClonetype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|5
condition|)
block|{
name|bHasdonotshow
operator|=
name|MNG_TRUE
expr_stmt|;
name|iDonotshow
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|5
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>
literal|6
condition|)
name|iConcrete
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|6
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|7
condition|)
block|{
name|bHasloca
operator|=
name|MNG_TRUE
expr_stmt|;
name|iLocationtype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|7
operator|)
expr_stmt|;
name|iLocationx
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
name|iLocationy
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
name|iRetcode
operator|=
name|mng_create_ani_clon
argument_list|(
name|pData
argument_list|,
name|iSourceid
argument_list|,
name|iCloneid
argument_list|,
name|iClonetype
argument_list|,
name|bHasdonotshow
argument_list|,
name|iDonotshow
argument_list|,
name|iConcrete
argument_list|,
name|bHasloca
argument_list|,
name|iLocationtype
argument_list|,
name|iLocationx
argument_list|,
name|iLocationy
argument_list|)
expr_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_clon (pData, iSourceid, iCloneid, iClonetype,                                            bHasdonotshow, iDonotshow, iConcrete,                                            bHasloca, iLocationtype, iLocationx,                                            iLocationy); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSourceid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCloneid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iClonetype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|5
condition|)
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDonotshow
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|5
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|6
condition|)
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iConcrete
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|6
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|7
condition|)
block|{
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasloca
operator|=
name|MNG_TRUE
expr_stmt|;
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLocationtype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|7
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLocationx
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLocationy
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|(
name|mng_clonp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bHasloca
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CLON
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_PAST
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_past
operator|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
name|mng_retcode
name|iRetcode
block|;
name|mng_uint16
name|iTargetid
block|;
name|mng_uint8
name|iTargettype
block|;
name|mng_int32
name|iTargetx
block|;
name|mng_int32
name|iTargety
block|;
name|mng_uint32
name|iCount
block|;
name|mng_uint32
name|iSize
block|;
name|mng_ptr
name|pSources
block|;
name|mng_uint32
name|iX
block|;
name|mng_past_sourcep
name|pSource
block|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PAST
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* check the length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|<
literal|41
operator|)
operator|||
operator|(
operator|(
operator|(
name|iRawlen
operator|-
literal|11
operator|)
operator|%
literal|30
operator|)
operator|!=
literal|0
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
end_if
begin_expr_stmt
name|iTargetid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iTargettype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iTargetx
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|3
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iTargety
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|7
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iCount
operator|=
operator|(
operator|(
name|iRawlen
operator|-
literal|11
operator|)
operator|/
literal|30
operator|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* how many entries again? */
end_comment
begin_expr_stmt
name|iSize
operator|=
name|iCount
operator|*
sizeof|sizeof
argument_list|(
name|mng_past_source
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pRawdata
operator|+=
literal|11
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* get a buffer for all the source blocks */
end_comment
begin_expr_stmt
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pSources
argument_list|,
name|iSize
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pSource
operator|=
operator|(
name|mng_past_sourcep
operator|)
name|pSources
expr_stmt|;
end_expr_stmt
begin_for
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iCount
condition|;
name|iX
operator|++
control|)
comment|/* now copy the source blocks */
block|{
name|pSource
operator|->
name|iSourceid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pSource
operator|->
name|iComposition
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
expr_stmt|;
name|pSource
operator|->
name|iOrientation
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
expr_stmt|;
name|pSource
operator|->
name|iOffsettype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
name|pSource
operator|->
name|iOffsetx
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|)
expr_stmt|;
name|pSource
operator|->
name|iOffsety
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|9
argument_list|)
expr_stmt|;
name|pSource
operator|->
name|iBoundarytype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|13
operator|)
expr_stmt|;
name|pSource
operator|->
name|iBoundaryl
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|14
argument_list|)
expr_stmt|;
name|pSource
operator|->
name|iBoundaryr
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|18
argument_list|)
expr_stmt|;
name|pSource
operator|->
name|iBoundaryt
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|22
argument_list|)
expr_stmt|;
name|pSource
operator|->
name|iBoundaryb
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|26
argument_list|)
expr_stmt|;
name|pSource
operator|++
expr_stmt|;
name|pRawdata
operator|+=
literal|30
expr_stmt|;
block|}
end_for
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* create playback object */
name|iRetcode
operator|=
name|mng_create_ani_past
argument_list|(
name|pData
argument_list|,
name|iTargetid
argument_list|,
name|iTargettype
argument_list|,
name|iTargetx
argument_list|,
name|iTargety
argument_list|,
name|iCount
argument_list|,
name|pSources
argument_list|)
expr_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_past (pData, iTargetid, iTargettype, iTargetx,                                            iTargety, iCount, pSources); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pSources
argument_list|,
name|iSize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pSources
argument_list|,
name|iSize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
comment|/* store the fields */
operator|(
operator|(
name|mng_pastp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDestid
operator|=
name|iTargetid
expr_stmt|;
operator|(
operator|(
name|mng_pastp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTargettype
operator|=
name|iTargettype
expr_stmt|;
operator|(
operator|(
name|mng_pastp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTargetx
operator|=
name|iTargetx
expr_stmt|;
operator|(
operator|(
name|mng_pastp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTargety
operator|=
name|iTargety
expr_stmt|;
operator|(
operator|(
name|mng_pastp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
name|iCount
expr_stmt|;
comment|/* get a buffer& copy the source blocks */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_pastp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pSources
argument_list|,
name|iSize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_pastp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pSources
argument_list|,
name|pSources
argument_list|,
name|iSize
argument_list|)
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
end_if
begin_comment
comment|/* free the source block buffer */
end_comment
begin_expr_stmt
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pSources
argument_list|,
name|iSize
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PAST
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DISC
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_disc
operator|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
name|mng_uint32
name|iCount
block|;
name|mng_uint16p
name|pIds
operator|=
name|MNG_NULL
block|;
name|mng_retcode
name|iRetcode
block|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DISC
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|%
literal|2
operator|)
operator|!=
literal|0
condition|)
comment|/* check the length */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
end_if
begin_expr_stmt
name|iCount
operator|=
operator|(
name|iRawlen
operator|/
sizeof|sizeof
argument_list|(
name|mng_uint16
argument_list|)
operator|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iCount
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pIds
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_BIGENDIAN_SUPPORTED
block|{
name|mng_uint32
name|iX
decl_stmt|;
name|mng_uint8p
name|pIn
init|=
name|pRawdata
decl_stmt|;
name|mng_uint16p
name|pOut
init|=
name|pIds
decl_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
operator|*
name|pOut
operator|++
operator|=
name|mng_get_uint16
argument_list|(
name|pIn
argument_list|)
expr_stmt|;
name|pIn
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|#
directive|else
name|MNG_COPY
argument_list|(
name|pIds
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* !MNG_BIGENDIAN_SUPPORTED */
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* create playback object */
name|iRetcode
operator|=
name|mng_create_ani_disc
argument_list|(
name|pData
argument_list|,
name|iCount
argument_list|,
name|pIds
argument_list|)
expr_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_disc (pData, iCount, pIds); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_discp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
name|iCount
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_discp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pObjectids
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_discp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pObjectids
argument_list|,
name|pIds
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
end_if
begin_if
if|if
condition|(
name|iRawlen
condition|)
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pIds
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DISC
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BACK
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_back
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_BACK
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* check the length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|6
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|7
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|9
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|10
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
comment|/* retrieve the fields */
name|pData
operator|->
name|bHasBACK
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iBACKred
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iBACKgreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iBACKblue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|6
condition|)
name|pData
operator|->
name|iBACKmandatory
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|6
operator|)
expr_stmt|;
else|else
name|pData
operator|->
name|iBACKmandatory
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|7
condition|)
name|pData
operator|->
name|iBACKimageid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|7
argument_list|)
expr_stmt|;
else|else
name|pData
operator|->
name|iBACKimageid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|9
condition|)
name|pData
operator|->
name|iBACKtile
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
expr_stmt|;
else|else
name|pData
operator|->
name|iBACKtile
operator|=
literal|0
expr_stmt|;
name|iRetcode
operator|=
name|mng_create_ani_back
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iBACKred
argument_list|,
name|pData
operator|->
name|iBACKgreen
argument_list|,
name|pData
operator|->
name|iBACKblue
argument_list|,
name|pData
operator|->
name|iBACKmandatory
argument_list|,
name|pData
operator|->
name|iBACKimageid
argument_list|,
name|pData
operator|->
name|iBACKtile
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_backp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iRed
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_backp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iGreen
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_backp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBlue
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|6
condition|)
operator|(
operator|(
name|mng_backp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMandatory
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|6
operator|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|7
condition|)
operator|(
operator|(
name|mng_backp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iImageid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|9
condition|)
operator|(
operator|(
name|mng_backp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTile
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_BACK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_fram
operator|)
block|{
name|mng_uint8p
name|pTemp
block|;
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
name|mng_uint32
name|iNamelen
block|;
endif|#
directive|endif
name|mng_uint32
name|iRemain
block|;
name|mng_uint32
name|iRequired
operator|=
literal|0
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_FRAM
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|<=
literal|1
condition|)
comment|/* only framing-mode ? */
block|{
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
name|iNamelen
operator|=
literal|0
expr_stmt|;
comment|/* indicate so */
endif|#
directive|endif
name|iRemain
operator|=
literal|0
expr_stmt|;
name|pTemp
operator|=
name|MNG_NULL
expr_stmt|;
block|}
else|else
block|{
name|pTemp
operator|=
name|find_null
argument_list|(
name|pRawdata
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* find null-separator */
comment|/* not found inside input-data ? */
if|if
condition|(
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
condition|)
name|pTemp
operator|=
name|pRawdata
operator|+
name|iRawlen
expr_stmt|;
comment|/* than remainder is name */
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
name|iNamelen
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|iRemain
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|iRawlen
operator|-
operator|(
name|pTemp
operator|-
name|pRawdata
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRemain
condition|)
comment|/* if there is remaining data it's less 1 byte */
name|iRemain
operator|--
expr_stmt|;
if|if
condition|(
operator|(
name|iRemain
operator|)
operator|&&
operator|(
name|iRemain
operator|<
literal|4
operator|)
condition|)
comment|/* remains must be empty or at least 4 bytes */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRemain
condition|)
block|{
name|iRequired
operator|=
literal|4
expr_stmt|;
comment|/* calculate and check required remaining length */
if|if
condition|(
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
condition|)
block|{
name|iRequired
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
condition|)
block|{
name|iRequired
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
name|pTemp
operator|+
literal|3
operator|)
condition|)
block|{
name|iRequired
operator|+=
literal|17
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
name|pTemp
operator|+
literal|4
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|iRemain
operator|-
name|iRequired
operator|)
operator|%
literal|4
operator|!=
literal|0
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|iRemain
operator|!=
name|iRequired
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_uint8p
name|pWork
init|=
name|pTemp
decl_stmt|;
name|mng_uint8
name|iFramemode
init|=
literal|0
decl_stmt|;
name|mng_uint8
name|iChangedelay
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iDelay
init|=
literal|0
decl_stmt|;
name|mng_uint8
name|iChangetimeout
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iTimeout
init|=
literal|0
decl_stmt|;
name|mng_uint8
name|iChangeclipping
init|=
literal|0
decl_stmt|;
name|mng_uint8
name|iCliptype
init|=
literal|0
decl_stmt|;
name|mng_int32
name|iClipl
init|=
literal|0
decl_stmt|;
name|mng_int32
name|iClipr
init|=
literal|0
decl_stmt|;
name|mng_int32
name|iClipt
init|=
literal|0
decl_stmt|;
name|mng_int32
name|iClipb
init|=
literal|0
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
if|if
condition|(
name|iRawlen
condition|)
comment|/* any data specified ? */
block|{
if|if
condition|(
operator|*
operator|(
name|pRawdata
operator|)
condition|)
comment|/* save the new framing mode ? */
block|{
name|iFramemode
operator|=
operator|*
operator|(
name|pRawdata
operator|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_OLD_VERSIONS
if|if
condition|(
name|pData
operator|->
name|bPreDraft48
condition|)
comment|/* old style input-stream ? */
block|{
switch|switch
condition|(
name|iFramemode
condition|)
block|{
case|case
literal|0
case|:
block|{
break|break;
block|}
case|case
literal|1
case|:
block|{
name|iFramemode
operator|=
literal|3
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|iFramemode
operator|=
literal|4
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
name|iFramemode
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|iFramemode
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|5
case|:
block|{
name|iFramemode
operator|=
literal|2
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|iFramemode
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
endif|#
directive|endif
block|}
if|if
condition|(
name|iRemain
condition|)
block|{
name|iChangedelay
operator|=
operator|*
operator|(
name|pWork
operator|+
literal|1
operator|)
expr_stmt|;
name|iChangetimeout
operator|=
operator|*
operator|(
name|pWork
operator|+
literal|2
operator|)
expr_stmt|;
name|iChangeclipping
operator|=
operator|*
operator|(
name|pWork
operator|+
literal|3
operator|)
expr_stmt|;
name|pWork
operator|+=
literal|5
expr_stmt|;
if|if
condition|(
name|iChangedelay
condition|)
comment|/* delay changed ? */
block|{
name|iDelay
operator|=
name|mng_get_uint32
argument_list|(
name|pWork
argument_list|)
expr_stmt|;
name|pWork
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|iChangetimeout
condition|)
comment|/* timeout changed ? */
block|{
name|iTimeout
operator|=
name|mng_get_uint32
argument_list|(
name|pWork
argument_list|)
expr_stmt|;
name|pWork
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|iChangeclipping
condition|)
comment|/* clipping changed ? */
block|{
name|iCliptype
operator|=
operator|*
name|pWork
expr_stmt|;
name|iClipl
operator|=
name|mng_get_int32
argument_list|(
name|pWork
operator|+
literal|1
argument_list|)
expr_stmt|;
name|iClipr
operator|=
name|mng_get_int32
argument_list|(
name|pWork
operator|+
literal|5
argument_list|)
expr_stmt|;
name|iClipt
operator|=
name|mng_get_int32
argument_list|(
name|pWork
operator|+
literal|9
argument_list|)
expr_stmt|;
name|iClipb
operator|=
name|mng_get_int32
argument_list|(
name|pWork
operator|+
literal|13
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|iRetcode
operator|=
name|mng_create_ani_fram
argument_list|(
name|pData
argument_list|,
name|iFramemode
argument_list|,
name|iChangedelay
argument_list|,
name|iDelay
argument_list|,
name|iChangetimeout
argument_list|,
name|iTimeout
argument_list|,
name|iChangeclipping
argument_list|,
name|iCliptype
argument_list|,
name|iClipl
argument_list|,
name|iClipr
argument_list|,
name|iClipt
argument_list|,
name|iClipb
argument_list|)
expr_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_fram (pData, iFramemode, iChangedelay, iDelay,                                            iChangetimeout, iTimeout,                                            iChangeclipping, iCliptype,                                            iClipl, iClipr, iClipt, iClipb); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
name|mng_uint8
name|iFramemode
init|=
operator|*
operator|(
name|pRawdata
operator|)
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_OLD_VERSIONS
if|if
condition|(
name|pData
operator|->
name|bPreDraft48
condition|)
comment|/* old style input-stream ? */
block|{
switch|switch
condition|(
name|iFramemode
condition|)
block|{
case|case
literal|1
case|:
block|{
name|iFramemode
operator|=
literal|3
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|iFramemode
operator|=
literal|4
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
name|iFramemode
operator|=
literal|5
expr_stmt|;
break|break;
block|}
comment|/* TODO: provision for mode=5 ??? */
case|case
literal|4
case|:
block|{
name|iFramemode
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|5
case|:
block|{
name|iFramemode
operator|=
literal|2
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|iFramemode
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
endif|#
directive|endif
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMode
operator|=
name|iFramemode
expr_stmt|;
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
operator|=
name|iNamelen
expr_stmt|;
if|if
condition|(
name|iNamelen
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
name|iNamelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
name|pRawdata
operator|+
literal|1
argument_list|,
name|iNamelen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRemain
condition|)
block|{
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChangedelay
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChangetimeout
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChangeclipping
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|3
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChangesyncid
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|4
operator|)
expr_stmt|;
name|pTemp
operator|+=
literal|5
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChangedelay
condition|)
block|{
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDelay
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChangetimeout
condition|)
block|{
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTimeout
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChangeclipping
condition|)
block|{
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBoundarytype
operator|=
operator|*
name|pTemp
expr_stmt|;
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBoundaryl
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|1
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBoundaryr
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|5
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBoundaryt
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|9
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBoundaryb
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|13
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|17
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChangesyncid
condition|)
block|{
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
operator|(
name|iRemain
operator|-
name|iRequired
operator|)
operator|/
literal|4
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pSyncids
argument_list|,
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|*
literal|4
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_BIGENDIAN_SUPPORTED
block|{
name|mng_uint32
name|iX
decl_stmt|;
name|mng_uint32p
name|pOut
init|=
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pSyncids
decl_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
operator|*
name|pOut
operator|++
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
block|}
block|}
else|#
directive|else
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pSyncids
argument_list|,
name|pTemp
argument_list|,
operator|(
operator|(
name|mng_framp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|*
literal|4
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* !MNG_BIGENDIAN_SUPPORTED */
block|}
block|}
block|}
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_FRAM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MOVE
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_move
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MOVE
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|!=
literal|13
condition|)
comment|/* check the length */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
comment|/* create a MOVE animation object */
name|iRetcode
operator|=
name|mng_create_ani_move
argument_list|(
name|pData
argument_list|,
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
argument_list|,
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
argument_list|,
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
argument_list|,
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|)
argument_list|,
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|9
argument_list|)
argument_list|)
expr_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_move (pData,                                            mng_get_uint16 (pRawdata),                                            mng_get_uint16 (pRawdata+2),                                            *(pRawdata+4),                                            mng_get_int32 (pRawdata+5),                                            mng_get_int32 (pRawdata+9)); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_movep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFirstid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_movep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLastid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_movep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMovetype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_movep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMovex
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_movep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMovey
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|9
argument_list|)
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MOVE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLIP
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_clip
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CLIP
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|!=
literal|21
condition|)
comment|/* check the length */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
comment|/* create a CLIP animation object */
name|iRetcode
operator|=
name|mng_create_ani_clip
argument_list|(
name|pData
argument_list|,
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
argument_list|,
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
argument_list|,
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
argument_list|,
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|)
argument_list|,
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|9
argument_list|)
argument_list|,
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|13
argument_list|)
argument_list|,
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|17
argument_list|)
argument_list|)
expr_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_clip (pData,                                            mng_get_uint16 (pRawdata),                                            mng_get_uint16 (pRawdata+2),                                            *(pRawdata+4),                                            mng_get_int32 (pRawdata+5),                                            mng_get_int32 (pRawdata+9),                                            mng_get_int32 (pRawdata+13),                                            mng_get_int32 (pRawdata+17)); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_clipp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFirstid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_clipp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLastid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_clipp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCliptype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_clipp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iClipl
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_clipp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iClipr
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|9
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_clipp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iClipt
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|13
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_clipp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iClipb
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|17
argument_list|)
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CLIP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SHOW
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_show
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SHOW
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* check the length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|4
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|5
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
if|if
condition|(
name|iRawlen
condition|)
comment|/* determine parameters if any */
block|{
name|pData
operator|->
name|iSHOWfromid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|2
condition|)
name|pData
operator|->
name|iSHOWtoid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
else|else
name|pData
operator|->
name|iSHOWtoid
operator|=
name|pData
operator|->
name|iSHOWfromid
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
name|pData
operator|->
name|iSHOWmode
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
else|else
name|pData
operator|->
name|iSHOWmode
operator|=
literal|0
expr_stmt|;
block|}
else|else
comment|/* use defaults then */
block|{
name|pData
operator|->
name|iSHOWmode
operator|=
literal|2
expr_stmt|;
name|pData
operator|->
name|iSHOWfromid
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iSHOWtoid
operator|=
literal|65535
expr_stmt|;
block|}
comment|/* create a SHOW animation object */
name|iRetcode
operator|=
name|mng_create_ani_show
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iSHOWfromid
argument_list|,
name|pData
operator|->
name|iSHOWtoid
argument_list|,
name|pData
operator|->
name|iSHOWmode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
name|iRetcode
operator|=
name|mng_process_display_show
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_showp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
operator|(
operator|(
name|mng_showp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFirstid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|2
condition|)
operator|(
operator|(
name|mng_showp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLastid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
else|else
operator|(
operator|(
name|mng_showp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLastid
operator|=
operator|(
operator|(
name|mng_showp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFirstid
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
operator|(
operator|(
name|mng_showp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMode
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SHOW
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_TERM
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_term
operator|)
block|{
name|mng_uint8
name|iTermaction
block|;
name|mng_uint8
name|iIteraction
operator|=
literal|0
block|;
name|mng_uint32
name|iDelay
operator|=
literal|0
block|;
name|mng_uint32
name|iItermax
operator|=
literal|0
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_TERM
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* should be behind MHDR or SAVE !! */
end_comment
begin_if
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasSAVE
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iChunkseq
operator|>
literal|2
operator|)
condition|)
block|{
name|pData
operator|->
name|bMisplacedTERM
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate we found a misplaced TERM */
comment|/* and send a warning signal!!! */
name|MNG_WARNING
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
block|}
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasLOOP
condition|)
comment|/* no way, jose! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasTERM
condition|)
comment|/* only 1 allowed! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_MULTIPLEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* check the length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|10
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasTERM
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iTermaction
operator|=
operator|*
name|pRawdata
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* get the fields */
end_comment
begin_if
if|if
condition|(
name|iRawlen
operator|>
literal|1
condition|)
block|{
name|iIteraction
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
expr_stmt|;
name|iDelay
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
name|iItermax
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|6
argument_list|)
expr_stmt|;
block|}
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|fProcessterm
condition|)
comment|/* inform the app ? */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessterm
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|iTermaction
argument_list|,
name|iIteraction
argument_list|,
name|iDelay
argument_list|,
name|iItermax
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* create the TERM ani-object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_term
argument_list|(
name|pData
argument_list|,
name|iTermaction
argument_list|,
name|iIteraction
argument_list|,
name|iDelay
argument_list|,
name|iItermax
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* save for future reference */
name|pData
operator|->
name|pTermaniobj
operator|=
name|pData
operator|->
name|pLastaniobj
expr_stmt|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_termp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTermaction
operator|=
name|iTermaction
expr_stmt|;
operator|(
operator|(
name|mng_termp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iIteraction
operator|=
name|iIteraction
expr_stmt|;
operator|(
operator|(
name|mng_termp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDelay
operator|=
name|iDelay
expr_stmt|;
operator|(
operator|(
name|mng_termp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iItermax
operator|=
name|iItermax
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_TERM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SAVE
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_save
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SAVE
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasSAVE
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasSAVE
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|pData
operator|->
name|fProcesssave
condition|)
comment|/* inform the application ? */
block|{
name|mng_bool
name|bOke
init|=
name|pData
operator|->
name|fProcesssave
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|bOke
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
comment|/* TODO: something with the parameters */
comment|/* create a SAVE animation object */
name|iRetcode
operator|=
name|mng_create_ani_save
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
name|iRetcode
operator|=
name|mng_process_display_save
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_savep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
comment|/* not empty ? */
block|{
name|mng_uint8
name|iOtype
init|=
operator|*
name|pRawdata
decl_stmt|;
name|mng_uint8
name|iEtype
decl_stmt|;
name|mng_uint32
name|iCount
init|=
literal|0
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint8p
name|pNull
decl_stmt|;
name|mng_uint32
name|iLen
decl_stmt|;
name|mng_uint32
name|iOffset
index|[
literal|2
index|]
decl_stmt|;
name|mng_uint32
name|iStarttime
index|[
literal|2
index|]
decl_stmt|;
name|mng_uint32
name|iFramenr
decl_stmt|;
name|mng_uint32
name|iLayernr
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
name|mng_save_entryp
name|pEntry
init|=
name|MNG_NULL
decl_stmt|;
name|mng_uint32
name|iNamesize
decl_stmt|;
if|if
condition|(
operator|(
name|iOtype
operator|!=
literal|4
operator|)
operator|&&
operator|(
name|iOtype
operator|!=
literal|8
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVOFFSETSIZE
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_savep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iOffsettype
operator|=
name|iOtype
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
literal|2
condition|;
name|iX
operator|++
control|)
comment|/* do this twice to get the count first ! */
block|{
name|pTemp
operator|=
name|pRawdata
operator|+
literal|1
expr_stmt|;
name|iLen
operator|=
name|iRawlen
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|iX
condition|)
comment|/* second run ? */
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pEntry
argument_list|,
operator|(
name|iCount
operator|*
sizeof|sizeof
argument_list|(
name|mng_save_entry
argument_list|)
operator|)
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_savep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
name|iCount
expr_stmt|;
operator|(
operator|(
name|mng_savep
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pEntries
operator|=
name|pEntry
expr_stmt|;
block|}
while|while
condition|(
name|iLen
condition|)
comment|/* anything left ? */
block|{
name|iEtype
operator|=
operator|*
name|pTemp
expr_stmt|;
comment|/* entrytype */
if|if
condition|(
operator|(
name|iEtype
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|iEtype
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|iEtype
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|iEtype
operator|!=
literal|3
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVENTRYTYPE
argument_list|)
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
if|if
condition|(
name|iEtype
operator|>
literal|1
condition|)
block|{
name|iOffset
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|iOffset
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|iStarttime
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|iStarttime
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|iLayernr
operator|=
literal|0
expr_stmt|;
name|iFramenr
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|iOtype
operator|==
literal|4
condition|)
block|{
name|iOffset
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|iOffset
index|[
literal|1
index|]
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|iOffset
index|[
literal|0
index|]
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|iOffset
index|[
literal|1
index|]
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|iEtype
operator|>
literal|0
condition|)
block|{
name|iStarttime
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|iStarttime
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|iLayernr
operator|=
literal|0
expr_stmt|;
name|iFramenr
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|iOtype
operator|==
literal|4
condition|)
block|{
name|iStarttime
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|iStarttime
index|[
literal|1
index|]
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
operator|+
literal|0
argument_list|)
expr_stmt|;
name|iLayernr
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iFramenr
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|12
expr_stmt|;
block|}
else|else
block|{
name|iStarttime
index|[
literal|0
index|]
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
operator|+
literal|0
argument_list|)
expr_stmt|;
name|iStarttime
index|[
literal|1
index|]
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iLayernr
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|)
expr_stmt|;
name|iFramenr
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|16
expr_stmt|;
block|}
block|}
block|}
name|pNull
operator|=
name|find_null
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
comment|/* get the name length */
if|if
condition|(
operator|(
name|pNull
operator|-
name|pRawdata
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iRawlen
condition|)
block|{
name|iNamesize
operator|=
name|iLen
expr_stmt|;
comment|/* no null found; so end of SAVE */
name|iLen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|iNamesize
operator|=
name|pNull
operator|-
name|pTemp
expr_stmt|;
comment|/* should be another entry */
name|iLen
operator|-=
name|iNamesize
expr_stmt|;
if|if
condition|(
operator|!
name|iLen
condition|)
comment|/* must not end with a null ! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_ENDWITHNULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pEntry
condition|)
block|{
name|iCount
operator|++
expr_stmt|;
block|}
else|else
block|{
name|pEntry
operator|->
name|iEntrytype
operator|=
name|iEtype
expr_stmt|;
name|pEntry
operator|->
name|iOffset
index|[
literal|0
index|]
operator|=
name|iOffset
index|[
literal|0
index|]
expr_stmt|;
name|pEntry
operator|->
name|iOffset
index|[
literal|1
index|]
operator|=
name|iOffset
index|[
literal|1
index|]
expr_stmt|;
name|pEntry
operator|->
name|iStarttime
index|[
literal|0
index|]
operator|=
name|iStarttime
index|[
literal|0
index|]
expr_stmt|;
name|pEntry
operator|->
name|iStarttime
index|[
literal|1
index|]
operator|=
name|iStarttime
index|[
literal|1
index|]
expr_stmt|;
name|pEntry
operator|->
name|iLayernr
operator|=
name|iLayernr
expr_stmt|;
name|pEntry
operator|->
name|iFramenr
operator|=
name|iFramenr
expr_stmt|;
name|pEntry
operator|->
name|iNamesize
operator|=
name|iNamesize
expr_stmt|;
if|if
condition|(
name|iNamesize
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pEntry
operator|->
name|zName
argument_list|,
name|iNamesize
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pEntry
operator|->
name|zName
argument_list|,
name|pTemp
argument_list|,
name|iNamesize
argument_list|)
expr_stmt|;
block|}
name|pEntry
operator|++
expr_stmt|;
block|}
name|pTemp
operator|+=
name|iNamesize
expr_stmt|;
block|}
block|}
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SAVE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SEEK
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_seek
operator|)
block|{
name|mng_retcode
name|iRetcode
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SEEK
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
operator|!
name|pData
operator|->
name|bHasSAVE
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_comment
comment|/* create a SEEK animation object */
end_comment
begin_expr_stmt
name|iRetcode
operator|=
name|mng_create_ani_seek
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
operator|(
name|mng_pchar
operator|)
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_if
if|if
condition|(
name|pData
operator|->
name|fProcessseek
condition|)
comment|/* inform the app ? */
block|{
name|mng_bool
name|bOke
decl_stmt|;
name|mng_pchar
name|zName
decl_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|zName
argument_list|,
name|iRawlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
name|MNG_COPY
argument_list|(
name|zName
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|bOke
operator|=
name|pData
operator|->
name|fProcessseek
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|zName
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zName
argument_list|,
name|iRawlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bOke
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_comment
comment|/* do display processing of the SEEK */
end_comment
begin_expr_stmt
name|iRetcode
operator|=
name|mng_process_display_seek
argument_list|(
name|pData
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_seekp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
operator|=
name|iRawlen
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_seekp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
name|iRawlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_seekp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_SEEK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_eXPI
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_expi
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_EXPI
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|<
literal|3
condition|)
comment|/* check the length */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* TODO: something !!! */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_expip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSnapshotid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_expip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
operator|=
name|iRawlen
operator|-
literal|2
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mng_expip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_expip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
operator|(
operator|(
name|mng_expip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_expip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zName
argument_list|,
name|pRawdata
operator|+
literal|2
argument_list|,
operator|(
operator|(
name|mng_expip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNamesize
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_EXPI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_fPRI
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_fpri
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_FPRI
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|!=
literal|2
condition|)
comment|/* must be two bytes long */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* TODO: something !!! */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_fprip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDeltatype
operator|=
operator|*
name|pRawdata
expr_stmt|;
operator|(
operator|(
name|mng_fprip
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iPriority
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_FPRI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_nEED
end_ifndef
begin_function
unit|MNG_LOCAL
DECL|function|CheckKeyword
name|mng_bool
name|CheckKeyword
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint8p
name|pKeyword
parameter_list|)
block|{
name|mng_chunkid
name|handled_chunks
index|[]
init|=
block|{
name|MNG_UINT_BACK
block|,
comment|/* keep it sorted !!!! */
name|MNG_UINT_BASI
block|,
name|MNG_UINT_CLIP
block|,
name|MNG_UINT_CLON
block|,
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
comment|/* TODO:    MNG_UINT_DBYK,  */
endif|#
directive|endif
name|MNG_UINT_DEFI
block|,
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
name|MNG_UINT_DHDR
block|,
endif|#
directive|endif
name|MNG_UINT_DISC
block|,
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
comment|/* TODO:    MNG_UINT_DROP,  */
endif|#
directive|endif
name|MNG_UINT_ENDL
block|,
name|MNG_UINT_FRAM
block|,
name|MNG_UINT_IDAT
block|,
name|MNG_UINT_IEND
block|,
name|MNG_UINT_IHDR
block|,
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
name|MNG_UINT_IJNG
block|,
endif|#
directive|endif
name|MNG_UINT_IPNG
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
name|MNG_UINT_JDAA
block|,
name|MNG_UINT_JDAT
block|,
name|MNG_UINT_JHDR
block|,
comment|/* TODO:    MNG_UINT_JSEP,  */
name|MNG_UINT_JdAA
block|,
endif|#
directive|endif
name|MNG_UINT_LOOP
block|,
name|MNG_UINT_MAGN
block|,
name|MNG_UINT_MEND
block|,
name|MNG_UINT_MHDR
block|,
name|MNG_UINT_MOVE
block|,
comment|/* TODO:    MNG_UINT_ORDR,  */
name|MNG_UINT_PAST
block|,
name|MNG_UINT_PLTE
block|,
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
name|MNG_UINT_PPLT
block|,
name|MNG_UINT_PROM
block|,
endif|#
directive|endif
name|MNG_UINT_SAVE
block|,
name|MNG_UINT_SEEK
block|,
name|MNG_UINT_SHOW
block|,
name|MNG_UINT_TERM
block|,
ifdef|#
directive|ifdef
name|MNG_INCLUDE_ANG_PROPOSAL
name|MNG_UINT_adAT
block|,
name|MNG_UINT_ahDR
block|,
endif|#
directive|endif
name|MNG_UINT_bKGD
block|,
name|MNG_UINT_cHRM
block|,
comment|/* TODO:    MNG_UINT_eXPI,  */
name|MNG_UINT_evNT
block|,
comment|/* TODO:    MNG_UINT_fPRI,  */
name|MNG_UINT_gAMA
block|,
comment|/* TODO:    MNG_UINT_hIST,  */
name|MNG_UINT_iCCP
block|,
name|MNG_UINT_iTXt
block|,
ifdef|#
directive|ifdef
name|MNG_INCLUDE_MPNG_PROPOSAL
name|MNG_UINT_mpNG
block|,
endif|#
directive|endif
name|MNG_UINT_nEED
block|,
comment|/* TODO:    MNG_UINT_oFFs,  */
comment|/* TODO:    MNG_UINT_pCAL,  */
comment|/* TODO:    MNG_UINT_pHYg,  */
comment|/* TODO:    MNG_UINT_pHYs,  */
comment|/* TODO:    MNG_UINT_sBIT,  */
comment|/* TODO:    MNG_UINT_sCAL,  */
comment|/* TODO:    MNG_UINT_sPLT,  */
name|MNG_UINT_sRGB
block|,
name|MNG_UINT_tEXt
block|,
name|MNG_UINT_tIME
block|,
name|MNG_UINT_tRNS
block|,
name|MNG_UINT_zTXt
block|,   }
decl_stmt|;
name|mng_bool
name|bOke
init|=
name|MNG_FALSE
decl_stmt|;
if|if
condition|(
name|pData
operator|->
name|fProcessneed
condition|)
comment|/* does the app handle it ? */
name|bOke
operator|=
name|pData
operator|->
name|fProcessneed
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
operator|(
name|mng_pchar
operator|)
name|pKeyword
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bOke
condition|)
block|{
comment|/* find the keyword length */
name|mng_uint8p
name|pNull
init|=
name|find_null
argument_list|(
name|pKeyword
argument_list|)
decl_stmt|;
if|if
condition|(
name|pNull
operator|-
name|pKeyword
operator|==
literal|4
condition|)
comment|/* test a chunk ? */
block|{
comment|/* get the chunk-id */
name|mng_chunkid
name|iChunkid
init|=
operator|(
operator|*
name|pKeyword
operator|<<
literal|24
operator|)
operator|+
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
operator|+
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|2
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|3
operator|)
operator|)
decl_stmt|;
comment|/* binary search variables */
name|mng_int32
name|iTop
decl_stmt|,
name|iLower
decl_stmt|,
name|iUpper
decl_stmt|,
name|iMiddle
decl_stmt|;
comment|/* determine max index of table */
name|iTop
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|handled_chunks
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|handled_chunks
index|[
literal|0
index|]
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
comment|/* binary search; with 52 chunks, worst-case is 7 comparisons */
name|iLower
operator|=
literal|0
expr_stmt|;
name|iMiddle
operator|=
name|iTop
operator|>>
literal|1
expr_stmt|;
name|iUpper
operator|=
name|iTop
expr_stmt|;
do|do
comment|/* the binary search itself */
block|{
if|if
condition|(
name|handled_chunks
index|[
name|iMiddle
index|]
operator|<
name|iChunkid
condition|)
name|iLower
operator|=
name|iMiddle
operator|+
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|handled_chunks
index|[
name|iMiddle
index|]
operator|>
name|iChunkid
condition|)
name|iUpper
operator|=
name|iMiddle
operator|-
literal|1
expr_stmt|;
else|else
block|{
name|bOke
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
name|iMiddle
operator|=
operator|(
name|iLower
operator|+
name|iUpper
operator|)
operator|>>
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|iLower
operator|<=
name|iUpper
condition|)
do|;
block|}
comment|/* test draft ? */
if|if
condition|(
operator|(
operator|!
name|bOke
operator|)
operator|&&
operator|(
name|pNull
operator|-
name|pKeyword
operator|==
literal|8
operator|)
operator|&&
operator|(
operator|*
name|pKeyword
operator|==
literal|'d'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|1
operator|)
operator|==
literal|'r'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|2
operator|)
operator|==
literal|'a'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|3
operator|)
operator|==
literal|'f'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|4
operator|)
operator|==
literal|'t'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|5
operator|)
operator|==
literal|' '
operator|)
condition|)
block|{
name|mng_uint32
name|iDraft
decl_stmt|;
name|iDraft
operator|=
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|6
operator|)
operator|-
literal|'0'
operator|)
operator|*
literal|10
operator|+
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|7
operator|)
operator|-
literal|'0'
operator|)
expr_stmt|;
name|bOke
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iDraft
operator|<=
name|MNG_MNG_DRAFT
argument_list|)
expr_stmt|;
block|}
comment|/* test MNG 1.0/1.1 ? */
if|if
condition|(
operator|(
operator|!
name|bOke
operator|)
operator|&&
operator|(
name|pNull
operator|-
name|pKeyword
operator|==
literal|7
operator|)
operator|&&
operator|(
operator|*
name|pKeyword
operator|==
literal|'M'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|1
operator|)
operator|==
literal|'N'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|2
operator|)
operator|==
literal|'G'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|3
operator|)
operator|==
literal|'-'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|4
operator|)
operator|==
literal|'1'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|5
operator|)
operator|==
literal|'.'
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|6
operator|)
operator|==
literal|'0'
operator|)
operator|||
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|6
operator|)
operator|==
literal|'1'
operator|)
operator|)
condition|)
name|bOke
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* test CACHEOFF ? */
if|if
condition|(
operator|(
operator|!
name|bOke
operator|)
operator|&&
operator|(
name|pNull
operator|-
name|pKeyword
operator|==
literal|8
operator|)
operator|&&
operator|(
operator|*
name|pKeyword
operator|==
literal|'C'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|1
operator|)
operator|==
literal|'A'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|2
operator|)
operator|==
literal|'C'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|3
operator|)
operator|==
literal|'H'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|4
operator|)
operator|==
literal|'E'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|5
operator|)
operator|==
literal|'O'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|6
operator|)
operator|==
literal|'F'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|pKeyword
operator|+
literal|7
operator|)
operator|==
literal|'F'
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|pFirstaniobj
condition|)
comment|/* only if caching hasn't started yet ! */
block|{
name|bOke
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|bCacheplayback
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bStorechunks
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
block|}
block|}
return|return
name|bOke
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_nEED
end_ifndef
begin_macro
DECL|function|READ_CHUNK
name|READ_CHUNK
argument_list|(
argument|mng_read_need
argument_list|)
end_macro
begin_block
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_NEED
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|<
literal|1
condition|)
comment|/* check the length */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|{
comment|/* let's check it */
name|mng_bool
name|bOke
init|=
name|MNG_TRUE
decl_stmt|;
name|mng_pchar
name|zKeywords
decl_stmt|;
name|mng_uint8p
name|pNull
decl_stmt|,
name|pTemp
decl_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|zKeywords
argument_list|,
name|iRawlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
name|MNG_COPY
argument_list|(
name|zKeywords
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|pTemp
operator|=
operator|(
name|mng_uint8p
operator|)
name|zKeywords
expr_stmt|;
name|pNull
operator|=
name|find_null
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|bOke
operator|)
operator|&&
operator|(
name|pNull
operator|<
operator|(
name|mng_uint8p
operator|)
name|zKeywords
operator|+
name|iRawlen
operator|)
condition|)
block|{
name|bOke
operator|=
name|CheckKeyword
argument_list|(
name|pData
argument_list|,
name|pTemp
argument_list|)
expr_stmt|;
name|pTemp
operator|=
name|pNull
operator|+
literal|1
expr_stmt|;
name|pNull
operator|=
name|find_null
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bOke
condition|)
name|bOke
operator|=
name|CheckKeyword
argument_list|(
name|pData
argument_list|,
name|pTemp
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|zKeywords
argument_list|,
name|iRawlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bOke
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_UNSUPPORTEDNEED
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_needp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iKeywordssize
operator|=
name|iRawlen
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_needp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeywords
argument_list|,
name|iRawlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_needp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeywords
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* MNG_STORE_CHUNKS */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_NEED
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
comment|/* done */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_pHYg
end_ifndef
begin_macro
DECL|function|READ_CHUNK
name|READ_CHUNK
argument_list|(
argument|mng_read_phyg
argument_list|)
end_macro
begin_block
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PHYG
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
comment|/* it's 9 bytes or empty; no more, no less! */
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|9
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|0
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
block|{
comment|/* TODO: something !!! */
block|}
endif|#
directive|endif
comment|/* MNG_SUPPORT_DISPLAY */
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_phygp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
operator|(
operator|(
name|mng_phygp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSizex
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_phygp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSizey
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_phygp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iUnit
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* MNG_STORE_CHUNKS */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PHYG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
comment|/* done */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_macro
DECL|function|READ_CHUNK
name|READ_CHUNK
argument_list|(
argument|mng_read_jhdr
argument_list|)
end_macro
begin_block
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_JHDR
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
name|pData
operator|->
name|eSigtype
operator|!=
name|mng_it_jng
operator|)
operator|&&
operator|(
name|pData
operator|->
name|eSigtype
operator|!=
name|mng_it_mng
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_CHUNKNOTALLOWED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|eSigtype
operator|==
name|mng_it_jng
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iChunkseq
operator|>
literal|1
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|!=
literal|16
condition|)
comment|/* length oke ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
comment|/* inside a JHDR-IEND block now */
name|pData
operator|->
name|bHasJHDR
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* and store interesting fields */
name|pData
operator|->
name|iDatawidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDataheight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iJHDRcolortype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
expr_stmt|;
name|pData
operator|->
name|iJHDRimgbitdepth
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
expr_stmt|;
name|pData
operator|->
name|iJHDRimgcompression
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|10
operator|)
expr_stmt|;
name|pData
operator|->
name|iJHDRimginterlace
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|11
operator|)
expr_stmt|;
name|pData
operator|->
name|iJHDRalphabitdepth
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
expr_stmt|;
name|pData
operator|->
name|iJHDRalphacompression
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|13
operator|)
expr_stmt|;
name|pData
operator|->
name|iJHDRalphafilter
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|14
operator|)
expr_stmt|;
name|pData
operator|->
name|iJHDRalphainterlace
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|15
operator|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_NO_1_2_4BIT_SUPPORT
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_NO_16BIT_SUPPORT
argument_list|)
name|pData
operator|->
name|iPNGmult
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iPNGdepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_NO_1_2_4BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iJHDRalphabitdepth
operator|<
literal|8
condition|)
name|pData
operator|->
name|iJHDRalphabitdepth
operator|=
literal|8
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iJHDRalphabitdepth
operator|>
literal|8
condition|)
block|{
name|pData
operator|->
name|iPNGmult
operator|=
literal|2
expr_stmt|;
name|pData
operator|->
name|iJHDRalphabitdepth
operator|=
literal|8
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* parameter validity checks */
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|!=
name|MNG_COLORTYPE_JPEGGRAY
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLOR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|!=
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOLORTYPE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRimgbitdepth
operator|!=
name|MNG_BITDEPTH_JPEG8
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRimgbitdepth
operator|!=
name|MNG_BITDEPTH_JPEG12
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRimgbitdepth
operator|!=
name|MNG_BITDEPTH_JPEG8AND12
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iJHDRimgcompression
operator|!=
name|MNG_COMPRESSION_BASELINEJPEG
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOMPRESS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRimginterlace
operator|!=
name|MNG_INTERLACE_SEQUENTIAL
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRimginterlace
operator|!=
name|MNG_INTERLACE_PROGRESSIVE
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDINTERLACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRalphabitdepth
operator|!=
name|MNG_BITDEPTH_8
operator|)
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
operator|&&
operator|(
name|pData
operator|->
name|iJHDRalphabitdepth
operator|!=
name|MNG_BITDEPTH_1
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRalphabitdepth
operator|!=
name|MNG_BITDEPTH_2
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRalphabitdepth
operator|!=
name|MNG_BITDEPTH_4
operator|)
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
operator|&&
operator|(
name|pData
operator|->
name|iJHDRalphabitdepth
operator|!=
name|MNG_BITDEPTH_16
operator|)
endif|#
directive|endif
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRalphacompression
operator|!=
name|MNG_COMPRESSION_DEFLATE
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRalphacompression
operator|!=
name|MNG_COMPRESSION_BASELINEJPEG
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOMPRESS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRalphacompression
operator|==
name|MNG_COMPRESSION_BASELINEJPEG
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRalphabitdepth
operator|!=
name|MNG_BITDEPTH_8
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|FILTER192
argument_list|)
operator|||
name|defined
argument_list|(
name|FILTER193
argument_list|)
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRalphafilter
operator|!=
name|MNG_FILTER_ADAPTIVE
operator|)
operator|&&
if|#
directive|if
name|defined
argument_list|(
name|FILTER192
argument_list|)
operator|&&
name|defined
argument_list|(
name|FILTER193
argument_list|)
operator|(
name|pData
operator|->
name|iJHDRalphafilter
operator|!=
name|MNG_FILTER_DIFFERING
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRalphafilter
operator|!=
name|MNG_FILTER_NOFILTER
operator|)
condition|)
else|#
directive|else
ifdef|#
directive|ifdef
name|FILTER192
operator|(
name|pData
operator|->
name|iJHDRalphafilter
operator|!=
name|MNG_FILTER_DIFFERING
operator|)
block|)
else|#
directive|else
operator|(
name|pData
operator|->
name|iJHDRalphafilter
operator|!=
name|MNG_FILTER_NOFILTER
operator|)
block|)
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_expr_stmt
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFILTER
argument_list|)
expr_stmt|;
end_expr_stmt
begin_else
else|#
directive|else
end_else
begin_if
if|if
condition|(
name|pData
operator|->
name|iJHDRalphafilter
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFILTER
argument_list|)
expr_stmt|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRalphainterlace
operator|!=
name|MNG_INTERLACE_NONE
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iJHDRalphainterlace
operator|!=
name|MNG_INTERLACE_ADAM7
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDINTERLACE
argument_list|)
expr_stmt|;
end_if
begin_block
unit|}   else
block|{
if|if
condition|(
name|pData
operator|->
name|iJHDRalphabitdepth
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iJHDRalphacompression
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOMPRESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iJHDRalphafilter
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFILTER
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iJHDRalphainterlace
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDINTERLACE
argument_list|)
expr_stmt|;
block|}
end_block
begin_if
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasheader
condition|)
comment|/* first chunk ? */
block|{
name|pData
operator|->
name|bHasheader
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* we've got a header */
name|pData
operator|->
name|eImagetype
operator|=
name|mng_it_jng
expr_stmt|;
comment|/* then this must be a JNG */
name|pData
operator|->
name|iWidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iHeight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
comment|/* predict alpha-depth ! */
if|if
condition|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
condition|)
name|pData
operator|->
name|iAlphadepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
else|else
name|pData
operator|->
name|iAlphadepth
operator|=
literal|0
expr_stmt|;
comment|/* fits on maximum canvas ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iWidth
operator|>
name|pData
operator|->
name|iMaxwidth
operator|)
operator|||
operator|(
name|pData
operator|->
name|iHeight
operator|>
name|pData
operator|->
name|iMaxheight
operator|)
condition|)
name|MNG_WARNING
argument_list|(
name|pData
argument_list|,
name|MNG_IMAGETOOLARGE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|fProcessheader
condition|)
comment|/* inform the app ? */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessheader
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|pData
operator|->
name|iWidth
argument_list|,
name|pData
operator|->
name|iHeight
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
block|}
end_if
begin_expr_stmt
name|pData
operator|->
name|iColortype
operator|=
literal|0
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* fake grayscale for other routines */
end_comment
begin_expr_stmt
name|pData
operator|->
name|iImagelevel
operator|++
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* one level deeper */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
init|=
name|mng_process_display_jhdr
argument_list|(
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iWidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iHeight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iColortype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iImagesampledepth
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iImagecompression
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|10
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iImageinterlace
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|11
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iAlphasampledepth
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
operator|>
literal|8
condition|)
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iAlphasampledepth
operator|=
literal|8
expr_stmt|;
endif|#
directive|endif
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iAlphacompression
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|13
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iAlphafilter
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|14
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_jhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iAlphainterlace
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|15
operator|)
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_JHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_else
unit|}
else|#
directive|else
end_else
begin_define
DECL|macro|read_jhdr
define|#
directive|define
name|read_jhdr
value|0
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_jdaa
operator|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
specifier|volatile
name|mng_retcode
name|iRetcode
block|;
name|iRetcode
operator|=
name|MNG_NOERROR
block|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_JDAA
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|pData
operator|->
name|bHasJSEP
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|iJHDRalphacompression
operator|!=
name|MNG_COMPRESSION_BASELINEJPEG
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iRawlen
operator|==
literal|0
condition|)
comment|/* can never be empty */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasJDAA
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* got some JDAA now, don't we */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_expr_stmt
name|iRetcode
operator|=
name|mng_process_display_jdaa
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_jdaap
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_jdaap
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDatasize
operator|=
name|iRawlen
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
comment|/* is there any data ? */
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_jdaap
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pData
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_jdaap
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_JDAA
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_else
unit|}
else|#
directive|else
end_else
begin_define
DECL|macro|read_jdaa
define|#
directive|define
name|read_jdaa
value|0
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_jdat
operator|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
specifier|volatile
name|mng_retcode
name|iRetcode
block|;
name|iRetcode
operator|=
name|MNG_NOERROR
block|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_JDAT
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|==
literal|0
condition|)
comment|/* can never be empty */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasJDAT
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* got some JDAT now, don't we */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_expr_stmt
name|iRetcode
operator|=
name|mng_process_display_jdat
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_jdatp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|bEmpty
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iRawlen
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_jdatp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDatasize
operator|=
name|iRawlen
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
comment|/* is there any data ? */
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_jdatp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pData
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_jdatp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_JDAT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_else
unit|}
else|#
directive|else
end_else
begin_define
DECL|macro|read_jdat
define|#
directive|define
name|read_jdat
value|0
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_jsep
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_JSEP
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasJHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
comment|/* must be empty ! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasJSEP
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* indicate we've had the 8-/12-bit separator */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_JSEP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_else
unit|}
else|#
directive|else
end_else
begin_define
DECL|macro|read_jsep
define|#
directive|define
name|read_jsep
value|0
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_dhdr
operator|)
block|{
name|mng_uint8
name|iImagetype
block|,
name|iDeltatype
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DHDR
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasMHDR
condition|)
comment|/* sequence checks */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_if
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* check for valid length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|!=
literal|4
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|12
operator|)
operator|&&
operator|(
name|iRawlen
operator|!=
literal|20
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|iImagetype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* check fields for validity */
end_comment
begin_expr_stmt
name|iDeltatype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iImagetype
operator|>
name|MNG_IMAGETYPE_JNG
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVIMAGETYPE
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|iDeltatype
operator|>
name|MNG_DELTATYPE_NOCHANGE
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVDELTATYPE
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
operator|)
operator|&&
operator|(
name|iRawlen
operator|>
literal|12
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_NOCHANGE
operator|)
operator|&&
operator|(
name|iRawlen
operator|>
literal|4
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pData
operator|->
name|bHasDHDR
operator|=
name|MNG_TRUE
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* inside a DHDR-IEND block now */
end_comment
begin_expr_stmt
name|pData
operator|->
name|iDeltatype
operator|=
name|iDeltatype
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|pData
operator|->
name|iImagelevel
operator|++
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* one level deeper */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_uint16
name|iObjectid
init|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
decl_stmt|;
name|mng_uint32
name|iBlockwidth
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iBlockheight
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iBlockx
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iBlocky
init|=
literal|0
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
block|{
name|iBlockwidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iBlockheight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>
literal|12
condition|)
block|{
name|iBlockx
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
name|iBlocky
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|)
expr_stmt|;
block|}
name|iRetcode
operator|=
name|mng_create_ani_dhdr
argument_list|(
name|pData
argument_list|,
name|iObjectid
argument_list|,
name|iImagetype
argument_list|,
name|iDeltatype
argument_list|,
name|iBlockwidth
argument_list|,
name|iBlockheight
argument_list|,
name|iBlockx
argument_list|,
name|iBlocky
argument_list|)
expr_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_dhdr (pData, iObjectid, iImagetype, iDeltatype,                                            iBlockwidth, iBlockheight, iBlockx, iBlocky); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_dhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_dhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iImagetype
operator|=
name|iImagetype
expr_stmt|;
operator|(
operator|(
name|mng_dhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDeltatype
operator|=
name|iDeltatype
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
block|{
operator|(
operator|(
name|mng_dhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBlockwidth
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_dhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBlockheight
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRawlen
operator|>
literal|12
condition|)
block|{
operator|(
operator|(
name|mng_dhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBlockx
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_dhdrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iBlocky
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_prom
operator|)
block|{
name|mng_uint8
name|iColortype
block|;
name|mng_uint8
name|iSampledepth
block|;
name|mng_uint8
name|iFilltype
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PROM
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|!=
literal|3
condition|)
comment|/* gotta be exactly 3 bytes */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|iColortype
operator|=
operator|*
name|pRawdata
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* check fields for validity */
end_comment
begin_expr_stmt
name|iSampledepth
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iFilltype
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAY
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_INDEXED
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAYA
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOLORTYPE
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_NO_16BIT_SUPPORT
end_ifdef
begin_if
if|if
condition|(
name|iSampledepth
operator|==
name|MNG_BITDEPTH_16
condition|)
name|iSampledepth
operator|=
name|MNG_BITDEPTH_8
expr_stmt|;
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_if
if|if
condition|(
operator|(
name|iSampledepth
operator|!=
name|MNG_BITDEPTH_1
operator|)
operator|&&
operator|(
name|iSampledepth
operator|!=
name|MNG_BITDEPTH_2
operator|)
operator|&&
operator|(
name|iSampledepth
operator|!=
name|MNG_BITDEPTH_4
operator|)
operator|&&
operator|(
name|iSampledepth
operator|!=
name|MNG_BITDEPTH_8
operator|)
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
operator|&&
operator|(
name|iSampledepth
operator|!=
name|MNG_BITDEPTH_16
operator|)
endif|#
directive|endif
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVSAMPLEDEPTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|(
name|iFilltype
operator|!=
name|MNG_FILLMETHOD_LEFTBITREPLICATE
operator|)
operator|&&
operator|(
name|iFilltype
operator|!=
name|MNG_FILLMETHOD_ZEROFILL
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVFILLMETHOD
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_prom
argument_list|(
name|pData
argument_list|,
name|iSampledepth
argument_list|,
name|iColortype
argument_list|,
name|iFilltype
argument_list|)
decl_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_prom (pData, iSampledepth,                                            iColortype, iFilltype); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_promp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iColortype
operator|=
name|iColortype
expr_stmt|;
operator|(
operator|(
name|mng_promp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iSampledepth
operator|=
name|iSampledepth
expr_stmt|;
operator|(
operator|(
name|mng_promp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFilltype
operator|=
name|iFilltype
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PROM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_ipng
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IPNG
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
comment|/* gotta be empty */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_ipng
argument_list|(
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
name|iRetcode
operator|=
name|mng_process_display_ipng
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IPNG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_pplt
operator|)
block|{
name|mng_uint8
name|iDeltatype
block|;
name|mng_uint8p
name|pTemp
block|;
name|mng_uint32
name|iLen
block|;
name|mng_uint8
name|iX
block|,
name|iM
block|;
name|mng_uint32
name|iY
block|;
name|mng_uint32
name|iMax
block|;
name|mng_rgbpaltab
name|aIndexentries
block|;
name|mng_uint8arr
name|aAlphaentries
block|;
name|mng_uint8arr
name|aUsedentries
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PPLT
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|<
literal|1
condition|)
comment|/* must have at least 1 byte */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|iDeltatype
operator|=
operator|*
name|pRawdata
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* valid ? */
end_comment
begin_if
if|if
condition|(
name|iDeltatype
operator|>
name|MNG_DELTATYPE_DELTARGBA
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVDELTATYPE
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* must be indexed color ! */
end_comment
begin_if
if|if
condition|(
name|pData
operator|->
name|iColortype
operator|!=
name|MNG_COLORTYPE_INDEXED
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOLORTYPE
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|pTemp
operator|=
name|pRawdata
operator|+
literal|1
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iLen
operator|=
name|iRawlen
operator|-
literal|1
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iMax
operator|=
literal|0
expr_stmt|;
end_expr_stmt
begin_for
for|for
control|(
name|iY
operator|=
literal|0
init|;
name|iY
operator|<
literal|256
condition|;
name|iY
operator|++
control|)
comment|/* reset arrays */
block|{
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iRed
operator|=
literal|0
expr_stmt|;
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iGreen
operator|=
literal|0
expr_stmt|;
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iBlue
operator|=
literal|0
expr_stmt|;
name|aAlphaentries
index|[
name|iY
index|]
operator|=
literal|255
expr_stmt|;
name|aUsedentries
index|[
name|iY
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_for
begin_while
while|while
condition|(
name|iLen
condition|)
comment|/* as long as there are entries left ... */
block|{
name|mng_uint32
name|iDiff
decl_stmt|;
if|if
condition|(
name|iLen
operator|<
literal|2
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
name|iX
operator|=
operator|*
name|pTemp
expr_stmt|;
comment|/* get start and end index */
name|iM
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|iM
operator|<
name|iX
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDINDEX
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mng_uint32
operator|)
name|iM
operator|>=
name|iMax
condition|)
comment|/* determine highest used index */
name|iMax
operator|=
operator|(
name|mng_uint32
operator|)
name|iM
operator|+
literal|1
expr_stmt|;
name|pTemp
operator|+=
literal|2
expr_stmt|;
name|iLen
operator|-=
literal|2
expr_stmt|;
name|iDiff
operator|=
operator|(
name|iM
operator|-
name|iX
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACERGB
operator|)
operator|||
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_DELTARGB
operator|)
condition|)
name|iDiff
operator|=
name|iDiff
operator|*
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACERGBA
operator|)
operator|||
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_DELTARGBA
operator|)
condition|)
name|iDiff
operator|=
name|iDiff
operator|*
literal|4
expr_stmt|;
if|if
condition|(
name|iLen
operator|<
name|iDiff
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACERGB
operator|)
operator|||
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_DELTARGB
operator|)
condition|)
block|{
for|for
control|(
name|iY
operator|=
operator|(
name|mng_uint32
operator|)
name|iX
init|;
name|iY
operator|<=
operator|(
name|mng_uint32
operator|)
name|iM
condition|;
name|iY
operator|++
control|)
block|{
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iRed
operator|=
operator|*
name|pTemp
expr_stmt|;
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iGreen
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
expr_stmt|;
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iBlue
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
expr_stmt|;
name|aUsedentries
index|[
name|iY
index|]
operator|=
literal|1
expr_stmt|;
name|pTemp
operator|+=
literal|3
expr_stmt|;
name|iLen
operator|-=
literal|3
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACEALPHA
operator|)
operator|||
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_DELTAALPHA
operator|)
condition|)
block|{
for|for
control|(
name|iY
operator|=
operator|(
name|mng_uint32
operator|)
name|iX
init|;
name|iY
operator|<=
operator|(
name|mng_uint32
operator|)
name|iM
condition|;
name|iY
operator|++
control|)
block|{
name|aAlphaentries
index|[
name|iY
index|]
operator|=
operator|*
name|pTemp
expr_stmt|;
name|aUsedentries
index|[
name|iY
index|]
operator|=
literal|1
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
name|iLen
operator|--
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|iY
operator|=
operator|(
name|mng_uint32
operator|)
name|iX
init|;
name|iY
operator|<=
operator|(
name|mng_uint32
operator|)
name|iM
condition|;
name|iY
operator|++
control|)
block|{
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iRed
operator|=
operator|*
name|pTemp
expr_stmt|;
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iGreen
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
expr_stmt|;
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iBlue
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
expr_stmt|;
name|aAlphaentries
index|[
name|iY
index|]
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|3
operator|)
expr_stmt|;
name|aUsedentries
index|[
name|iY
index|]
operator|=
literal|1
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
name|iLen
operator|-=
literal|4
expr_stmt|;
block|}
block|}
block|}
end_while
begin_switch
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
comment|/* check maximum allowed entries for bitdepth */
block|{
case|case
name|MNG_BITDEPTH_1
case|:
block|{
if|if
condition|(
name|iMax
operator|>
literal|2
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDINDEX
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|MNG_BITDEPTH_2
case|:
block|{
if|if
condition|(
name|iMax
operator|>
literal|4
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDINDEX
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|MNG_BITDEPTH_4
case|:
block|{
if|if
condition|(
name|iMax
operator|>
literal|16
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDINDEX
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_switch
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* create animation object */
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_pplt
argument_list|(
name|pData
argument_list|,
name|iDeltatype
argument_list|,
name|iMax
argument_list|,
name|aIndexentries
argument_list|,
name|aAlphaentries
argument_list|,
name|aUsedentries
argument_list|)
decl_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_pplt (pData, iDeltatype, iMax, aIndexentries,                                            aAlphaentries, aUsedentries); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_ppltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDeltatype
operator|=
name|iDeltatype
expr_stmt|;
operator|(
operator|(
name|mng_ppltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
name|iMax
expr_stmt|;
for|for
control|(
name|iY
operator|=
literal|0
init|;
name|iY
operator|<
literal|256
condition|;
name|iY
operator|++
control|)
block|{
operator|(
operator|(
name|mng_ppltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
index|[
name|iY
index|]
operator|.
name|iRed
operator|=
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iRed
expr_stmt|;
operator|(
operator|(
name|mng_ppltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
index|[
name|iY
index|]
operator|.
name|iGreen
operator|=
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iGreen
expr_stmt|;
operator|(
operator|(
name|mng_ppltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
index|[
name|iY
index|]
operator|.
name|iBlue
operator|=
name|aIndexentries
index|[
name|iY
index|]
operator|.
name|iBlue
expr_stmt|;
operator|(
operator|(
name|mng_ppltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
index|[
name|iY
index|]
operator|.
name|iAlpha
operator|=
name|aAlphaentries
index|[
name|iY
index|]
expr_stmt|;
operator|(
operator|(
name|mng_ppltp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|aEntries
index|[
name|iY
index|]
operator|.
name|bUsed
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|aUsedentries
index|[
name|iY
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_PPLT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_ijng
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IJNG
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|!=
literal|0
condition|)
comment|/* gotta be empty */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
init|=
name|mng_create_ani_ijng
argument_list|(
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
name|iRetcode
operator|=
name|mng_process_display_ijng
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_IJNG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_drop
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DROP
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* check length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|<
literal|4
operator|)
operator|||
operator|(
operator|(
name|iRawlen
operator|%
literal|4
operator|)
operator|!=
literal|0
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* TODO: something !!! */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_dropp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
name|iRawlen
operator|/
literal|4
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
name|mng_uint32
name|iX
decl_stmt|;
name|mng_uint8p
name|pTemp
init|=
name|pRawdata
decl_stmt|;
name|mng_uint32p
name|pEntry
decl_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pEntry
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_dropp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pChunknames
operator|=
operator|(
name|mng_ptr
operator|)
name|pEntry
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iRawlen
operator|/
literal|4
condition|;
name|iX
operator|++
control|)
block|{
operator|*
name|pEntry
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
name|pEntry
operator|++
expr_stmt|;
block|}
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DROP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DBYK
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_dbyk
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DBYK
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|<
literal|6
condition|)
comment|/* must be at least 6 long */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* TODO: something !!! */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_dbykp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChunkname
operator|=
name|mng_get_uint32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_dbykp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iPolarity
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
operator|(
operator|(
name|mng_dbykp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iKeywordssize
operator|=
name|iRawlen
operator|-
literal|5
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|5
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_dbykp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeywords
argument_list|,
name|iRawlen
operator|-
literal|4
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_dbykp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|zKeywords
argument_list|,
name|pRawdata
operator|+
literal|5
argument_list|,
name|iRawlen
operator|-
literal|5
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DBYK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_ORDR
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_ordr
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ORDR
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* check length */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|<
literal|5
operator|)
operator|||
operator|(
operator|(
name|iRawlen
operator|%
literal|5
operator|)
operator|!=
literal|0
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
comment|/* TODO: something !!! */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_ordrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
name|iRawlen
operator|/
literal|5
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
block|{
name|mng_uint32
name|iX
decl_stmt|;
name|mng_ordr_entryp
name|pEntry
decl_stmt|;
name|mng_uint8p
name|pTemp
init|=
name|pRawdata
decl_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pEntry
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_ordrp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pEntries
operator|=
name|pEntry
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iRawlen
operator|/
literal|5
condition|;
name|iX
operator|++
control|)
block|{
name|pEntry
operator|->
name|iChunkname
operator|=
name|mng_get_uint32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|pEntry
operator|->
name|iOrdertype
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|4
operator|)
expr_stmt|;
name|pTemp
operator|+=
literal|5
expr_stmt|;
name|pEntry
operator|++
expr_stmt|;
block|}
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_ORDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_magn
operator|)
block|{
name|mng_uint16
name|iFirstid
block|,
name|iLastid
block|;
name|mng_uint8
name|iMethodX
block|,
name|iMethodY
block|;
name|mng_uint16
name|iMX
block|,
name|iMY
block|,
name|iML
block|,
name|iMR
block|,
name|iMT
block|,
name|iMB
block|;
name|mng_bool
name|bFaulty
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MAGN
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasIHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* check length */
end_comment
begin_if
if|if
condition|(
name|iRawlen
operator|>
literal|20
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_comment
comment|/* following is an ugly hack to allow faulty layout caused by previous      versions of libmng and MNGeye, which wrote MAGN with a 16-bit      MethodX/MethodY (as opposed to the proper 8-bit as defined in the spec!) */
end_comment
begin_if
if|if
condition|(
operator|(
name|iRawlen
operator|==
literal|6
operator|)
operator|||
operator|(
name|iRawlen
operator|==
literal|8
operator|)
operator|||
operator|(
name|iRawlen
operator|==
literal|10
operator|)
operator|||
operator|(
name|iRawlen
operator|==
literal|12
operator|)
operator|||
operator|(
name|iRawlen
operator|==
literal|14
operator|)
operator|||
operator|(
name|iRawlen
operator|==
literal|16
operator|)
operator|||
operator|(
name|iRawlen
operator|==
literal|20
operator|)
condition|)
name|bFaulty
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* these lengths are all wrong */
elseif|else
comment|/* length 18 can be right or wrong !!! */
if|if
condition|(
operator|(
name|iRawlen
operator|==
literal|18
operator|)
operator|&&
operator|(
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
operator|<=
literal|5
operator|)
operator|&&
operator|(
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|6
argument_list|)
operator|<
literal|256
operator|)
operator|&&
operator|(
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
operator|<
literal|256
operator|)
operator|&&
operator|(
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|10
argument_list|)
operator|<
literal|256
operator|)
operator|&&
operator|(
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
operator|<
literal|256
operator|)
operator|&&
operator|(
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|14
argument_list|)
operator|<
literal|256
operator|)
operator|&&
operator|(
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|)
operator|<
literal|256
operator|)
condition|)
name|bFaulty
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* this is very likely the wrong layout */
else|else
name|bFaulty
operator|=
name|MNG_FALSE
expr_stmt|;
end_if
begin_comment
comment|/* all other cases are handled as right */
end_comment
begin_if
if|if
condition|(
name|bFaulty
condition|)
comment|/* wrong layout ? */
block|{
if|if
condition|(
name|iRawlen
operator|>
literal|0
condition|)
comment|/* get the fields */
name|iFirstid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
else|else
name|iFirstid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|2
condition|)
name|iLastid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
else|else
name|iLastid
operator|=
name|iFirstid
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
name|iMethodX
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|iMethodX
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|6
condition|)
name|iMX
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|6
argument_list|)
expr_stmt|;
else|else
name|iMX
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|8
condition|)
name|iMY
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
else|else
name|iMY
operator|=
name|iMX
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|10
condition|)
name|iML
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|10
argument_list|)
expr_stmt|;
else|else
name|iML
operator|=
name|iMX
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|12
condition|)
name|iMR
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|)
expr_stmt|;
else|else
name|iMR
operator|=
name|iMX
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|14
condition|)
name|iMT
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|14
argument_list|)
expr_stmt|;
else|else
name|iMT
operator|=
name|iMY
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|16
condition|)
name|iMB
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|)
expr_stmt|;
else|else
name|iMB
operator|=
name|iMY
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|18
condition|)
name|iMethodY
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|18
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|iMethodY
operator|=
name|iMethodX
expr_stmt|;
block|}
else|else
comment|/* proper layout !!!! */
block|{
if|if
condition|(
name|iRawlen
operator|>
literal|0
condition|)
comment|/* get the fields */
name|iFirstid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
else|else
name|iFirstid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|2
condition|)
name|iLastid
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|)
expr_stmt|;
else|else
name|iLastid
operator|=
name|iFirstid
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|4
condition|)
name|iMethodX
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
expr_stmt|;
else|else
name|iMethodX
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|5
condition|)
name|iMX
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|)
expr_stmt|;
else|else
name|iMX
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|7
condition|)
name|iMY
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|7
argument_list|)
expr_stmt|;
else|else
name|iMY
operator|=
name|iMX
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|9
condition|)
name|iML
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|9
argument_list|)
expr_stmt|;
else|else
name|iML
operator|=
name|iMX
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|11
condition|)
name|iMR
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|11
argument_list|)
expr_stmt|;
else|else
name|iMR
operator|=
name|iMX
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|13
condition|)
name|iMT
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|13
argument_list|)
expr_stmt|;
else|else
name|iMT
operator|=
name|iMY
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|15
condition|)
name|iMB
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|15
argument_list|)
expr_stmt|;
else|else
name|iMB
operator|=
name|iMY
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
literal|17
condition|)
name|iMethodY
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|17
operator|)
expr_stmt|;
else|else
name|iMethodY
operator|=
name|iMethodX
expr_stmt|;
block|}
end_if
begin_comment
comment|/* check field validity */
end_comment
begin_if
if|if
condition|(
operator|(
name|iMethodX
operator|>
literal|5
operator|)
operator|||
operator|(
name|iMethodY
operator|>
literal|5
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDMETHOD
argument_list|)
expr_stmt|;
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
name|iRetcode
operator|=
name|mng_create_ani_magn
argument_list|(
name|pData
argument_list|,
name|iFirstid
argument_list|,
name|iLastid
argument_list|,
name|iMethodX
argument_list|,
name|iMX
argument_list|,
name|iMY
argument_list|,
name|iML
argument_list|,
name|iMR
argument_list|,
name|iMT
argument_list|,
name|iMB
argument_list|,
name|iMethodY
argument_list|)
expr_stmt|;
comment|/*    if (!iRetcode)       iRetcode = mng_process_display_magn (pData, iFirstid, iLastid, iMethodX,                                            iMX, iMY, iML, iMR, iMT, iMB, iMethodY); */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFirstid
operator|=
name|iFirstid
expr_stmt|;
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iLastid
operator|=
name|iLastid
expr_stmt|;
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMethodX
operator|=
name|iMethodX
expr_stmt|;
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMX
operator|=
name|iMX
expr_stmt|;
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMY
operator|=
name|iMY
expr_stmt|;
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iML
operator|=
name|iML
expr_stmt|;
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMR
operator|=
name|iMR
expr_stmt|;
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMT
operator|=
name|iMT
expr_stmt|;
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMB
operator|=
name|iMB
expr_stmt|;
operator|(
operator|(
name|mng_magnp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iMethodY
operator|=
name|iMethodY
expr_stmt|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MAGN
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_MPNG_PROPOSAL
end_ifdef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_mpng
operator|)
block|{
name|mng_uint32
name|iFramewidth
block|;
name|mng_uint32
name|iFrameheight
block|;
name|mng_uint16
name|iTickspersec
block|;
name|mng_uint32
name|iFramessize
block|;
name|mng_uint32
name|iCompressedsize
block|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
name|mng_retcode
name|iRetcode
block|;
name|mng_uint16
name|iNumplays
block|;
name|mng_uint32
name|iBufsize
block|;
name|mng_uint8p
name|pBuf
operator|=
literal|0
block|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MPNG
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasIHDR
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|<
literal|41
condition|)
comment|/* length must be at least 41 */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|iFramewidth
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iFramewidth
operator|==
literal|0
condition|)
comment|/* frame_width must not be zero */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDWIDTH
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|iFrameheight
operator|=
name|mng_get_int32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iFrameheight
operator|==
literal|0
condition|)
comment|/* frame_height must not be zero */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDHEIGHT
argument_list|)
expr_stmt|;
end_if
begin_expr_stmt
name|iTickspersec
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|10
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iTickspersec
operator|==
literal|0
condition|)
comment|/* delay_den must not be zero */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDFIELDVAL
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
operator|!=
literal|0
condition|)
comment|/* only deflate compression-method allowed */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOMPRESS
argument_list|)
expr_stmt|;
end_if
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
end_if
begin_expr_stmt
name|iNumplays
operator|=
name|mng_get_uint16
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|iCompressedsize
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
name|iRawlen
operator|-
literal|13
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_block
block|{
name|iRetcode
operator|=
name|mng_inflate_buffer
argument_list|(
name|pData
argument_list|,
name|pRawdata
operator|+
literal|13
argument_list|,
name|iCompressedsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBufsize
argument_list|,
operator|&
name|iFramessize
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
if|if
condition|(
name|iFramessize
operator|%
literal|26
condition|)
block|{
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
name|iRetcode
operator|=
name|mng_create_mpng_obj
argument_list|(
name|pData
argument_list|,
name|iFramewidth
argument_list|,
name|iFrameheight
argument_list|,
name|iNumplays
argument_list|,
name|iTickspersec
argument_list|,
name|iFramessize
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the fields */
operator|(
operator|(
name|mng_mpngp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFramewidth
operator|=
name|iFramewidth
expr_stmt|;
operator|(
operator|(
name|mng_mpngp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFrameheight
operator|=
name|iFrameheight
expr_stmt|;
operator|(
operator|(
name|mng_mpngp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iNumplays
operator|=
name|iNumplays
expr_stmt|;
operator|(
operator|(
name|mng_mpngp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iTickspersec
operator|=
name|iTickspersec
expr_stmt|;
operator|(
operator|(
name|mng_mpngp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCompressionmethod
operator|=
operator|*
operator|(
name|pRawdata
operator|+
literal|14
operator|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SUPPORT_DISPLAY
name|iRetcode
operator|=
name|mng_inflate_buffer
argument_list|(
name|pData
argument_list|,
name|pRawdata
operator|+
literal|13
argument_list|,
name|iCompressedsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBufsize
argument_list|,
operator|&
name|iFramessize
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
block|{
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
return|return
name|iRetcode
return|;
block|}
if|if
condition|(
name|iFramessize
operator|%
literal|26
condition|)
block|{
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|iFramessize
condition|)
block|{
name|MNG_ALLOCX
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_mpngp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pFrames
argument_list|,
name|iFramessize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mng_mpngp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pFrames
operator|==
literal|0
condition|)
block|{
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTOFMEMORY
argument_list|)
expr_stmt|;
block|}
operator|(
operator|(
name|mng_mpngp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iFramessize
operator|=
name|iFramessize
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_mpngp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pFrames
argument_list|,
name|pBuf
argument_list|,
name|iFramessize
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_STORE_CHUNKS
argument_list|)
end_if
begin_expr_stmt
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBufsize
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_MPNG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_evNT
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_evnt
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_EVNT
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|bHasSAVE
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
name|iRawlen
operator|<
literal|2
condition|)
comment|/* must have at least 1 entry ! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
end_if
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_SUPPORT_DYNAMICMNG
argument_list|)
end_if
begin_block
block|{
if|if
condition|(
name|iRawlen
condition|)
comment|/* not empty ? */
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint8p
name|pNull
decl_stmt|;
name|mng_uint32
name|iLen
decl_stmt|;
name|mng_uint8
name|iEventtype
decl_stmt|;
name|mng_uint8
name|iMasktype
decl_stmt|;
name|mng_int32
name|iLeft
decl_stmt|;
name|mng_int32
name|iRight
decl_stmt|;
name|mng_int32
name|iTop
decl_stmt|;
name|mng_int32
name|iBottom
decl_stmt|;
name|mng_uint16
name|iObjectid
decl_stmt|;
name|mng_uint8
name|iIndex
decl_stmt|;
name|mng_uint32
name|iNamesize
decl_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
name|iLen
operator|=
name|iRawlen
expr_stmt|;
while|while
condition|(
name|iLen
condition|)
comment|/* anything left ? */
block|{
name|iEventtype
operator|=
operator|*
name|pTemp
expr_stmt|;
comment|/* eventtype */
if|if
condition|(
name|iEventtype
operator|>
literal|5
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDEVENT
argument_list|)
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
name|iMasktype
operator|=
operator|*
name|pTemp
expr_stmt|;
comment|/* masktype */
if|if
condition|(
name|iMasktype
operator|>
literal|5
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDMASK
argument_list|)
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
name|iLen
operator|-=
literal|2
expr_stmt|;
name|iLeft
operator|=
literal|0
expr_stmt|;
name|iRight
operator|=
literal|0
expr_stmt|;
name|iTop
operator|=
literal|0
expr_stmt|;
name|iBottom
operator|=
literal|0
expr_stmt|;
name|iObjectid
operator|=
literal|0
expr_stmt|;
name|iIndex
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|iMasktype
condition|)
block|{
case|case
literal|1
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|16
condition|)
block|{
name|iLeft
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|iRight
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iTop
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|)
expr_stmt|;
name|iBottom
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|16
expr_stmt|;
name|iLen
operator|-=
literal|16
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|2
condition|)
block|{
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|2
expr_stmt|;
name|iLen
operator|-=
literal|2
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|3
condition|)
block|{
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|iIndex
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
expr_stmt|;
name|pTemp
operator|+=
literal|3
expr_stmt|;
name|iLen
operator|-=
literal|3
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|18
condition|)
block|{
name|iLeft
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|iRight
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iTop
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|)
expr_stmt|;
name|iBottom
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|)
expr_stmt|;
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pTemp
operator|+
literal|16
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|18
expr_stmt|;
name|iLen
operator|-=
literal|18
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|5
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|19
condition|)
block|{
name|iLeft
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|iRight
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iTop
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|)
expr_stmt|;
name|iBottom
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|)
expr_stmt|;
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pTemp
operator|+
literal|16
argument_list|)
expr_stmt|;
name|iIndex
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|18
operator|)
expr_stmt|;
name|pTemp
operator|+=
literal|19
expr_stmt|;
name|iLen
operator|-=
literal|19
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|pNull
operator|=
name|find_null
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
comment|/* get the name length */
if|if
condition|(
operator|(
name|pNull
operator|-
name|pTemp
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iLen
condition|)
block|{
name|iNamesize
operator|=
name|iLen
expr_stmt|;
comment|/* no null found; so end of evNT */
name|iLen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|iNamesize
operator|=
name|pNull
operator|-
name|pTemp
expr_stmt|;
comment|/* should be another entry */
name|iLen
operator|=
name|iLen
operator|-
name|iNamesize
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|iLen
condition|)
comment|/* must not end with a null ! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_ENDWITHNULL
argument_list|)
expr_stmt|;
block|}
name|iRetcode
operator|=
name|mng_create_event
argument_list|(
name|pData
argument_list|,
name|iEventtype
argument_list|,
name|iMasktype
argument_list|,
name|iLeft
argument_list|,
name|iRight
argument_list|,
name|iTop
argument_list|,
name|iBottom
argument_list|,
name|iObjectid
argument_list|,
name|iIndex
argument_list|,
name|iNamesize
argument_list|,
operator|(
name|mng_pchar
operator|)
name|pTemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
name|pTemp
operator|=
name|pTemp
operator|+
name|iNamesize
operator|+
literal|1
expr_stmt|;
block|}
block|}
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_DISPLAY&& MNG_SUPPORT_DYNAMICMNG */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
name|iRawlen
condition|)
comment|/* not empty ? */
block|{
name|mng_uint32
name|iX
decl_stmt|;
name|mng_uint32
name|iCount
init|=
literal|0
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint8p
name|pNull
decl_stmt|;
name|mng_uint32
name|iLen
decl_stmt|;
name|mng_uint8
name|iEventtype
decl_stmt|;
name|mng_uint8
name|iMasktype
decl_stmt|;
name|mng_int32
name|iLeft
decl_stmt|;
name|mng_int32
name|iRight
decl_stmt|;
name|mng_int32
name|iTop
decl_stmt|;
name|mng_int32
name|iBottom
decl_stmt|;
name|mng_uint16
name|iObjectid
decl_stmt|;
name|mng_uint8
name|iIndex
decl_stmt|;
name|mng_uint32
name|iNamesize
decl_stmt|;
name|mng_evnt_entryp
name|pEntry
init|=
name|MNG_NULL
decl_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
literal|2
condition|;
name|iX
operator|++
control|)
comment|/* do this twice to get the count first ! */
block|{
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
name|iLen
operator|=
name|iRawlen
expr_stmt|;
if|if
condition|(
name|iX
condition|)
comment|/* second run ? */
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pEntry
argument_list|,
operator|(
name|iCount
operator|*
sizeof|sizeof
argument_list|(
name|mng_evnt_entry
argument_list|)
operator|)
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_evntp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iCount
operator|=
name|iCount
expr_stmt|;
operator|(
operator|(
name|mng_evntp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pEntries
operator|=
name|pEntry
expr_stmt|;
block|}
while|while
condition|(
name|iLen
condition|)
comment|/* anything left ? */
block|{
name|iEventtype
operator|=
operator|*
name|pTemp
expr_stmt|;
comment|/* eventtype */
if|if
condition|(
name|iEventtype
operator|>
literal|5
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDEVENT
argument_list|)
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
name|iMasktype
operator|=
operator|*
name|pTemp
expr_stmt|;
comment|/* masktype */
if|if
condition|(
name|iMasktype
operator|>
literal|5
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDMASK
argument_list|)
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
name|iLen
operator|-=
literal|2
expr_stmt|;
name|iLeft
operator|=
literal|0
expr_stmt|;
name|iRight
operator|=
literal|0
expr_stmt|;
name|iTop
operator|=
literal|0
expr_stmt|;
name|iBottom
operator|=
literal|0
expr_stmt|;
name|iObjectid
operator|=
literal|0
expr_stmt|;
name|iIndex
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|iMasktype
condition|)
block|{
case|case
literal|1
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|16
condition|)
block|{
name|iLeft
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|iRight
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iTop
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|)
expr_stmt|;
name|iBottom
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|16
expr_stmt|;
name|iLen
operator|-=
literal|16
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|2
condition|)
block|{
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|2
expr_stmt|;
name|iLen
operator|-=
literal|2
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|3
condition|)
block|{
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|iIndex
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
expr_stmt|;
name|pTemp
operator|+=
literal|3
expr_stmt|;
name|iLen
operator|-=
literal|3
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|18
condition|)
block|{
name|iLeft
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|iRight
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iTop
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|)
expr_stmt|;
name|iBottom
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|)
expr_stmt|;
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pTemp
operator|+
literal|16
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|18
expr_stmt|;
name|iLen
operator|-=
literal|18
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|5
case|:
block|{
if|if
condition|(
name|iLen
operator|>
literal|19
condition|)
block|{
name|iLeft
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
name|iRight
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|iTop
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|)
expr_stmt|;
name|iBottom
operator|=
name|mng_get_int32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|)
expr_stmt|;
name|iObjectid
operator|=
name|mng_get_uint16
argument_list|(
name|pTemp
operator|+
literal|16
argument_list|)
expr_stmt|;
name|iIndex
operator|=
operator|*
operator|(
name|pTemp
operator|+
literal|18
operator|)
expr_stmt|;
name|pTemp
operator|+=
literal|19
expr_stmt|;
name|iLen
operator|-=
literal|19
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDLENGTH
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|pNull
operator|=
name|find_null
argument_list|(
name|pTemp
argument_list|)
expr_stmt|;
comment|/* get the name length */
if|if
condition|(
operator|(
name|pNull
operator|-
name|pTemp
operator|)
operator|>
operator|(
name|mng_int32
operator|)
name|iLen
condition|)
block|{
name|iNamesize
operator|=
name|iLen
expr_stmt|;
comment|/* no null found; so end of evNT */
name|iLen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|iNamesize
operator|=
name|pNull
operator|-
name|pTemp
expr_stmt|;
comment|/* should be another entry */
name|iLen
operator|=
name|iLen
operator|-
name|iNamesize
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|iLen
condition|)
comment|/* must not end with a null ! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_ENDWITHNULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|iX
condition|)
block|{
name|iCount
operator|++
expr_stmt|;
block|}
else|else
block|{
name|pEntry
operator|->
name|iEventtype
operator|=
name|iEventtype
expr_stmt|;
name|pEntry
operator|->
name|iMasktype
operator|=
name|iMasktype
expr_stmt|;
name|pEntry
operator|->
name|iLeft
operator|=
name|iLeft
expr_stmt|;
name|pEntry
operator|->
name|iRight
operator|=
name|iRight
expr_stmt|;
name|pEntry
operator|->
name|iTop
operator|=
name|iTop
expr_stmt|;
name|pEntry
operator|->
name|iBottom
operator|=
name|iBottom
expr_stmt|;
name|pEntry
operator|->
name|iObjectid
operator|=
name|iObjectid
expr_stmt|;
name|pEntry
operator|->
name|iIndex
operator|=
name|iIndex
expr_stmt|;
name|pEntry
operator|->
name|iSegmentnamesize
operator|=
name|iNamesize
expr_stmt|;
if|if
condition|(
name|iNamesize
condition|)
block|{
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pEntry
operator|->
name|zSegmentname
argument_list|,
name|iNamesize
operator|+
literal|1
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pEntry
operator|->
name|zSegmentname
argument_list|,
name|pTemp
argument_list|,
name|iNamesize
argument_list|)
expr_stmt|;
block|}
name|pEntry
operator|++
expr_stmt|;
block|}
name|pTemp
operator|=
name|pTemp
operator|+
name|iNamesize
operator|+
literal|1
expr_stmt|;
block|}
block|}
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_EVNT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifndef
begin_expr_stmt
unit|READ_CHUNK
DECL|function|READ_CHUNK
operator|(
name|mng_read_unknown
operator|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_UNKNOWN
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
comment|/* sequence checks */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasBASI
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
condition|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_SEQUENCEERROR
argument_list|)
expr_stmt|;
end_expr_stmt
begin_comment
comment|/* critical chunk ? */
end_comment
begin_if
if|if
condition|(
operator|(
operator|(
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|iChunkname
operator|&
literal|0x20000000
operator|)
operator|==
literal|0
operator|)
ifdef|#
directive|ifdef
name|MNG_SKIPCHUNK_SAVE
operator|&&
operator|(
name|pData
operator|->
name|iChunkname
operator|!=
name|MNG_UINT_SAVE
operator|)
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SKIPCHUNK_SEEK
operator|&&
operator|(
name|pData
operator|->
name|iChunkname
operator|!=
name|MNG_UINT_SEEK
operator|)
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SKIPCHUNK_DBYK
operator|&&
operator|(
name|pData
operator|->
name|iChunkname
operator|!=
name|MNG_UINT_DBYK
operator|)
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SKIPCHUNK_ORDR
operator|&&
operator|(
name|pData
operator|->
name|iChunkname
operator|!=
name|MNG_UINT_ORDR
operator|)
endif|#
directive|endif
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_UNKNOWNCRITICAL
argument_list|)
expr_stmt|;
end_if
begin_if
if|if
condition|(
name|pData
operator|->
name|fProcessunknown
condition|)
comment|/* let the app handle it ? */
block|{
name|mng_bool
name|bOke
init|=
name|pData
operator|->
name|fProcessunknown
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
operator|(
name|mng_ptr
operator|)
name|pRawdata
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|bOke
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_STORE_CHUNKS
end_ifdef
begin_if
if|if
condition|(
name|pData
operator|->
name|bStorechunks
condition|)
block|{
comment|/* initialize storage */
name|mng_retcode
name|iRetcode
init|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pHeader
operator|)
operator|->
name|fCreate
argument_list|(
name|pData
argument_list|,
name|pHeader
argument_list|,
name|ppChunk
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* store the length */
operator|(
operator|(
name|mng_chunk_headerp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iChunkname
operator|=
name|pData
operator|->
name|iChunkname
expr_stmt|;
operator|(
operator|(
name|mng_unknown_chunkp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|iDatasize
operator|=
name|iRawlen
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|==
literal|0
condition|)
comment|/* any data at all ? */
operator|(
operator|(
name|mng_unknown_chunkp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pData
operator|=
literal|0
expr_stmt|;
else|else
block|{
comment|/* then store it */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
operator|(
operator|(
name|mng_unknown_chunkp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pData
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
operator|(
operator|(
name|mng_unknown_chunkp
operator|)
operator|*
name|ppChunk
operator|)
operator|->
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_STORE_CHUNKS */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_UNKNOWN
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
comment|/* done */
end_comment
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_READ_PROCS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * chunk write functions                                                  * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_WRITE_PROCS
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_expr_stmt
unit|WRITE_CHUNK
DECL|function|WRITE_CHUNK
operator|(
name|mng_write_ihdr
operator|)
block|{
name|mng_ihdrp
name|pIHDR
block|;
name|mng_uint8p
name|pRawdata
block|;
name|mng_uint32
name|iRawlen
block|;
name|mng_retcode
name|iRetcode
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IHDR
argument_list|,
name|MNG_LC_START
argument_list|)
block|;
endif|#
directive|endif
name|pIHDR
operator|=
operator|(
name|mng_ihdrp
operator|)
name|pChunk
block|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
block|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|13
block|;
comment|/* fill the output buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pIHDR
operator|->
name|iWidth
argument_list|)
block|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pIHDR
operator|->
name|iHeight
argument_list|)
block|;
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
operator|=
name|pIHDR
operator|->
name|iBitdepth
block|;
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
operator|=
name|pIHDR
operator|->
name|iColortype
block|;
operator|*
operator|(
name|pRawdata
operator|+
literal|10
operator|)
operator|=
name|pIHDR
operator|->
name|iCompression
block|;
operator|*
operator|(
name|pRawdata
operator|+
literal|11
operator|)
operator|=
name|pIHDR
operator|->
name|iFilter
block|;
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
operator|=
name|pIHDR
operator|->
name|iInterlace
block|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pIHDR
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
block|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IHDR
argument_list|,
name|MNG_LC_END
argument_list|)
block|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_expr_stmt
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_plte
argument_list|)
end_macro
begin_block
block|{
name|mng_pltep
name|pPLTE
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PLTE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pPLTE
operator|=
operator|(
name|mng_pltep
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pPLTE
operator|->
name|bEmpty
condition|)
comment|/* write empty chunk ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPLTE
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pPLTE
operator|->
name|iEntrycount
operator|*
literal|3
expr_stmt|;
comment|/* fill the output buffer */
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pPLTE
operator|->
name|iEntrycount
condition|;
name|iX
operator|++
control|)
block|{
operator|*
name|pTemp
operator|=
name|pPLTE
operator|->
name|aEntries
index|[
name|iX
index|]
operator|.
name|iRed
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
operator|=
name|pPLTE
operator|->
name|aEntries
index|[
name|iX
index|]
operator|.
name|iGreen
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
operator|=
name|pPLTE
operator|->
name|aEntries
index|[
name|iX
index|]
operator|.
name|iBlue
expr_stmt|;
name|pTemp
operator|+=
literal|3
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPLTE
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PLTE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_idat
argument_list|)
end_macro
begin_block
block|{
name|mng_idatp
name|pIDAT
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IDAT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pIDAT
operator|=
operator|(
name|mng_idatp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pIDAT
operator|->
name|bEmpty
condition|)
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pIDAT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pIDAT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|pIDAT
operator|->
name|iDatasize
argument_list|,
name|pIDAT
operator|->
name|pData
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IDAT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_iend
argument_list|)
end_macro
begin_block
block|{
name|mng_iendp
name|pIEND
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IEND
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pIEND
operator|=
operator|(
name|mng_iendp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pIEND
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IEND
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_trns
argument_list|)
end_macro
begin_block
block|{
name|mng_trnsp
name|pTRNS
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_TRNS
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pTRNS
operator|=
operator|(
name|mng_trnsp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pTRNS
operator|->
name|bEmpty
condition|)
comment|/* write empty chunk ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pTRNS
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pTRNS
operator|->
name|bGlobal
condition|)
comment|/* write global chunk ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pTRNS
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|pTRNS
operator|->
name|iRawlen
argument_list|,
operator|(
name|mng_uint8p
operator|)
name|pTRNS
operator|->
name|aRawdata
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer */
name|iRawlen
operator|=
literal|0
expr_stmt|;
comment|/* and default size */
switch|switch
condition|(
name|pTRNS
operator|->
name|iType
condition|)
block|{
case|case
literal|0
case|:
block|{
name|iRawlen
operator|=
literal|2
expr_stmt|;
comment|/* fill the size& output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pTRNS
operator|->
name|iGray
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|iRawlen
operator|=
literal|6
expr_stmt|;
comment|/* fill the size& output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pTRNS
operator|->
name|iRed
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pTRNS
operator|->
name|iGreen
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pTRNS
operator|->
name|iBlue
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* init output buffer size */
name|iRawlen
operator|=
name|pTRNS
operator|->
name|iCount
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the output buffer */
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pTRNS
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
operator|*
name|pTemp
operator|=
name|pTRNS
operator|->
name|aEntries
index|[
name|iX
index|]
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
block|}
break|break;
block|}
block|}
comment|/* write the chunk */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pTRNS
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_TRNS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_gama
argument_list|)
end_macro
begin_block
block|{
name|mng_gamap
name|pGAMA
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_GAMA
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pGAMA
operator|=
operator|(
name|mng_gamap
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pGAMA
operator|->
name|bEmpty
condition|)
comment|/* write empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pGAMA
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|4
expr_stmt|;
comment|/* fill the buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pGAMA
operator|->
name|iGamma
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pGAMA
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_GAMA
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_chrm
argument_list|)
end_macro
begin_block
block|{
name|mng_chrmp
name|pCHRM
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_CHRM
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pCHRM
operator|=
operator|(
name|mng_chrmp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pCHRM
operator|->
name|bEmpty
condition|)
comment|/* write empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pCHRM
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|32
expr_stmt|;
comment|/* fill the buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pCHRM
operator|->
name|iWhitepointx
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pCHRM
operator|->
name|iWhitepointy
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|,
name|pCHRM
operator|->
name|iRedx
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|,
name|pCHRM
operator|->
name|iRedy
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|,
name|pCHRM
operator|->
name|iGreenx
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|20
argument_list|,
name|pCHRM
operator|->
name|iGreeny
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|24
argument_list|,
name|pCHRM
operator|->
name|iBluex
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|28
argument_list|,
name|pCHRM
operator|->
name|iBluey
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pCHRM
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_CHRM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_srgb
argument_list|)
end_macro
begin_block
block|{
name|mng_srgbp
name|pSRGB
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SRGB
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pSRGB
operator|=
operator|(
name|mng_srgbp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pSRGB
operator|->
name|bEmpty
condition|)
comment|/* write empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSRGB
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|1
expr_stmt|;
comment|/* fill the buffer */
operator|*
name|pRawdata
operator|=
name|pSRGB
operator|->
name|iRenderingintent
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSRGB
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SRGB
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_iccp
argument_list|)
end_macro
begin_block
block|{
name|mng_iccpp
name|pICCP
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint8p
name|pBuf
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iBuflen
decl_stmt|;
name|mng_uint32
name|iReallen
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ICCP
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pICCP
operator|=
operator|(
name|mng_iccpp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pICCP
operator|->
name|bEmpty
condition|)
comment|/* write empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pICCP
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* compress the profile */
name|iRetcode
operator|=
name|deflate_buffer
argument_list|(
name|pData
argument_list|,
name|pICCP
operator|->
name|pProfile
argument_list|,
name|pICCP
operator|->
name|iProfilesize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBuflen
argument_list|,
operator|&
name|iReallen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* still oke ? */
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pICCP
operator|->
name|iNamesize
operator|+
literal|2
operator|+
name|iReallen
expr_stmt|;
comment|/* requires large buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the buffer */
if|if
condition|(
name|pICCP
operator|->
name|iNamesize
condition|)
block|{
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pICCP
operator|->
name|zName
argument_list|,
name|pICCP
operator|->
name|iNamesize
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
name|pICCP
operator|->
name|iNamesize
expr_stmt|;
block|}
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
operator|=
name|pICCP
operator|->
name|iCompression
expr_stmt|;
name|pTemp
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|iReallen
condition|)
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pBuf
argument_list|,
name|iReallen
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pICCP
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
comment|/* drop the temp buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBuflen
argument_list|)
expr_stmt|;
comment|/* always drop the extra buffer */
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ICCP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_tEXt
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_text
argument_list|)
end_macro
begin_block
block|{
name|mng_textp
name|pTEXT
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_TEXT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pTEXT
operator|=
operator|(
name|mng_textp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pTEXT
operator|->
name|iKeywordsize
operator|+
literal|1
operator|+
name|pTEXT
operator|->
name|iTextsize
expr_stmt|;
comment|/* requires large buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the buffer */
if|if
condition|(
name|pTEXT
operator|->
name|iKeywordsize
condition|)
block|{
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pTEXT
operator|->
name|zKeyword
argument_list|,
name|pTEXT
operator|->
name|iKeywordsize
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
name|pTEXT
operator|->
name|iKeywordsize
expr_stmt|;
block|}
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
name|pTemp
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|pTEXT
operator|->
name|iTextsize
condition|)
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pTEXT
operator|->
name|zText
argument_list|,
name|pTEXT
operator|->
name|iTextsize
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pTEXT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
comment|/* drop the temp buffer ? */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_TEXT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_zTXt
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_ztxt
argument_list|)
end_macro
begin_block
block|{
name|mng_ztxtp
name|pZTXT
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint8p
name|pBuf
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iBuflen
decl_stmt|;
name|mng_uint32
name|iReallen
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ZTXT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pZTXT
operator|=
operator|(
name|mng_ztxtp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
comment|/* compress the text */
name|iRetcode
operator|=
name|deflate_buffer
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_uint8p
operator|)
name|pZTXT
operator|->
name|zText
argument_list|,
name|pZTXT
operator|->
name|iTextsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBuflen
argument_list|,
operator|&
name|iReallen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* all ok ? */
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pZTXT
operator|->
name|iKeywordsize
operator|+
literal|2
operator|+
name|iReallen
expr_stmt|;
comment|/* requires large buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the buffer */
if|if
condition|(
name|pZTXT
operator|->
name|iKeywordsize
condition|)
block|{
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pZTXT
operator|->
name|zKeyword
argument_list|,
name|pZTXT
operator|->
name|iKeywordsize
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
name|pZTXT
operator|->
name|iKeywordsize
expr_stmt|;
block|}
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
comment|/* terminator zero */
name|pTemp
operator|++
expr_stmt|;
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
comment|/* compression type */
name|pTemp
operator|++
expr_stmt|;
if|if
condition|(
name|iReallen
condition|)
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pBuf
argument_list|,
name|iReallen
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pZTXT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
comment|/* drop the temp buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBuflen
argument_list|)
expr_stmt|;
comment|/* always drop the compression buffer */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ZTXT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iTXt
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_itxt
argument_list|)
end_macro
begin_block
block|{
name|mng_itxtp
name|pITXT
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint8p
name|pBuf
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iBuflen
decl_stmt|;
name|mng_uint32
name|iReallen
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ITXT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pITXT
operator|=
operator|(
name|mng_itxtp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pITXT
operator|->
name|iCompressionflag
condition|)
comment|/* compress the text */
name|iRetcode
operator|=
name|deflate_buffer
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_uint8p
operator|)
name|pITXT
operator|->
name|zText
argument_list|,
name|pITXT
operator|->
name|iTextsize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBuflen
argument_list|,
operator|&
name|iReallen
argument_list|)
expr_stmt|;
else|else
name|iRetcode
operator|=
name|MNG_NOERROR
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* all ok ? */
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pITXT
operator|->
name|iKeywordsize
operator|+
name|pITXT
operator|->
name|iLanguagesize
operator|+
name|pITXT
operator|->
name|iTranslationsize
operator|+
literal|5
expr_stmt|;
if|if
condition|(
name|pITXT
operator|->
name|iCompressionflag
condition|)
name|iRawlen
operator|=
name|iRawlen
operator|+
name|iReallen
expr_stmt|;
else|else
name|iRawlen
operator|=
name|iRawlen
operator|+
name|pITXT
operator|->
name|iTextsize
expr_stmt|;
comment|/* requires large buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the buffer */
if|if
condition|(
name|pITXT
operator|->
name|iKeywordsize
condition|)
block|{
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pITXT
operator|->
name|zKeyword
argument_list|,
name|pITXT
operator|->
name|iKeywordsize
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
name|pITXT
operator|->
name|iKeywordsize
expr_stmt|;
block|}
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
operator|*
name|pTemp
operator|=
name|pITXT
operator|->
name|iCompressionflag
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
operator|*
name|pTemp
operator|=
name|pITXT
operator|->
name|iCompressionmethod
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
if|if
condition|(
name|pITXT
operator|->
name|iLanguagesize
condition|)
block|{
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pITXT
operator|->
name|zLanguage
argument_list|,
name|pITXT
operator|->
name|iLanguagesize
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
name|pITXT
operator|->
name|iLanguagesize
expr_stmt|;
block|}
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
if|if
condition|(
name|pITXT
operator|->
name|iTranslationsize
condition|)
block|{
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pITXT
operator|->
name|zTranslation
argument_list|,
name|pITXT
operator|->
name|iTranslationsize
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
name|pITXT
operator|->
name|iTranslationsize
expr_stmt|;
block|}
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
if|if
condition|(
name|pITXT
operator|->
name|iCompressionflag
condition|)
block|{
if|if
condition|(
name|iReallen
condition|)
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pBuf
argument_list|,
name|iReallen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pITXT
operator|->
name|iTextsize
condition|)
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pITXT
operator|->
name|zText
argument_list|,
name|pITXT
operator|->
name|iTextsize
argument_list|)
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pITXT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
comment|/* drop the temp buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBuflen
argument_list|)
expr_stmt|;
comment|/* always drop the compression buffer */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ITXT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_bKGD
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_bkgd
argument_list|)
end_macro
begin_block
block|{
name|mng_bkgdp
name|pBKGD
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_BKGD
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pBKGD
operator|=
operator|(
name|mng_bkgdp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pBKGD
operator|->
name|bEmpty
condition|)
comment|/* write empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pBKGD
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|0
expr_stmt|;
comment|/* and default size */
switch|switch
condition|(
name|pBKGD
operator|->
name|iType
condition|)
block|{
case|case
literal|0
case|:
block|{
comment|/* gray */
name|iRawlen
operator|=
literal|2
expr_stmt|;
comment|/* fill the size& output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pBKGD
operator|->
name|iGray
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
name|iRawlen
operator|=
literal|6
expr_stmt|;
comment|/* fill the size& output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pBKGD
operator|->
name|iRed
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pBKGD
operator|->
name|iGreen
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pBKGD
operator|->
name|iBlue
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
name|iRawlen
operator|=
literal|1
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pBKGD
operator|->
name|iIndex
expr_stmt|;
break|break;
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pBKGD
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_BKGD
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_pHYs
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_phys
argument_list|)
end_macro
begin_block
block|{
name|mng_physp
name|pPHYS
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PHYS
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pPHYS
operator|=
operator|(
name|mng_physp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pPHYS
operator|->
name|bEmpty
condition|)
comment|/* write empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPHYS
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|9
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pPHYS
operator|->
name|iSizex
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pPHYS
operator|->
name|iSizey
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
operator|=
name|pPHYS
operator|->
name|iUnit
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPHYS
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PHYS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sBIT
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_sbit
argument_list|)
end_macro
begin_block
block|{
name|mng_sbitp
name|pSBIT
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SBIT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pSBIT
operator|=
operator|(
name|mng_sbitp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pSBIT
operator|->
name|bEmpty
condition|)
comment|/* write empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSBIT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|0
expr_stmt|;
comment|/* and default size */
switch|switch
condition|(
name|pSBIT
operator|->
name|iType
condition|)
block|{
case|case
literal|0
case|:
block|{
comment|/* gray */
name|iRawlen
operator|=
literal|1
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
name|iRawlen
operator|=
literal|3
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|1
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|2
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
name|iRawlen
operator|=
literal|3
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|2
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
comment|/* gray + alpha */
name|iRawlen
operator|=
literal|2
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|1
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|6
case|:
block|{
comment|/* rgb + alpha */
name|iRawlen
operator|=
literal|4
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|1
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|2
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|3
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|10
case|:
block|{
comment|/* jpeg gray */
name|iRawlen
operator|=
literal|1
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|12
case|:
block|{
comment|/* jpeg rgb */
name|iRawlen
operator|=
literal|3
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|1
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|2
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|14
case|:
block|{
comment|/* jpeg gray + alpha */
name|iRawlen
operator|=
literal|2
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|1
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|16
case|:
block|{
comment|/* jpeg rgb + alpha */
name|iRawlen
operator|=
literal|4
expr_stmt|;
comment|/* fill the size& output buffer */
operator|*
name|pRawdata
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|1
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|2
index|]
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
operator|=
name|pSBIT
operator|->
name|aBits
index|[
literal|3
index|]
expr_stmt|;
break|break;
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSBIT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SBIT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sPLT
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_splt
argument_list|)
end_macro
begin_block
block|{
name|mng_spltp
name|pSPLT
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint32
name|iEntrieslen
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SPLT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pSPLT
operator|=
operator|(
name|mng_spltp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iEntrieslen
operator|=
operator|(
operator|(
name|pSPLT
operator|->
name|iSampledepth
operator|>>
literal|3
operator|)
operator|*
literal|4
operator|+
literal|2
operator|)
operator|*
name|pSPLT
operator|->
name|iEntrycount
expr_stmt|;
name|iRawlen
operator|=
name|pSPLT
operator|->
name|iNamesize
operator|+
literal|2
operator|+
name|iEntrieslen
expr_stmt|;
comment|/* requires large buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the buffer */
if|if
condition|(
name|pSPLT
operator|->
name|iNamesize
condition|)
block|{
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pSPLT
operator|->
name|zName
argument_list|,
name|pSPLT
operator|->
name|iNamesize
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
name|pSPLT
operator|->
name|iNamesize
expr_stmt|;
block|}
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
operator|=
name|pSPLT
operator|->
name|iSampledepth
expr_stmt|;
name|pTemp
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pSPLT
operator|->
name|iEntrycount
condition|)
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pSPLT
operator|->
name|pEntries
argument_list|,
name|iEntrieslen
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSPLT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
comment|/* drop the temp buffer ? */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SPLT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_hIST
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_hist
argument_list|)
end_macro
begin_block
block|{
name|mng_histp
name|pHIST
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_HIST
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pHIST
operator|=
operator|(
name|mng_histp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pHIST
operator|->
name|iEntrycount
operator|<<
literal|1
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the output buffer */
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pHIST
operator|->
name|iEntrycount
condition|;
name|iX
operator|++
control|)
block|{
name|mng_put_uint16
argument_list|(
name|pTemp
argument_list|,
name|pHIST
operator|->
name|aEntries
index|[
name|iX
index|]
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|2
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pHIST
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_HIST
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_tIME
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_time
argument_list|)
end_macro
begin_block
block|{
name|mng_timep
name|pTIME
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_TIME
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pTIME
operator|=
operator|(
name|mng_timep
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|7
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pTIME
operator|->
name|iYear
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
operator|=
name|pTIME
operator|->
name|iMonth
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
operator|=
name|pTIME
operator|->
name|iDay
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
operator|=
name|pTIME
operator|->
name|iHour
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|5
operator|)
operator|=
name|pTIME
operator|->
name|iMinute
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|6
operator|)
operator|=
name|pTIME
operator|->
name|iSecond
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pTIME
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_TIME
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_mhdr
argument_list|)
end_macro
begin_block
block|{
name|mng_mhdrp
name|pMHDR
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MHDR
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pMHDR
operator|=
operator|(
name|mng_mhdrp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|28
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pMHDR
operator|->
name|iWidth
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pMHDR
operator|->
name|iHeight
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|,
name|pMHDR
operator|->
name|iTicks
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|,
name|pMHDR
operator|->
name|iLayercount
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|,
name|pMHDR
operator|->
name|iFramecount
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|20
argument_list|,
name|pMHDR
operator|->
name|iPlaytime
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|24
argument_list|,
name|pMHDR
operator|->
name|iSimplicity
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pMHDR
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_mend
argument_list|)
end_macro
begin_block
block|{
name|mng_mendp
name|pMEND
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MEND
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pMEND
operator|=
operator|(
name|mng_mendp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pMEND
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MEND
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_loop
argument_list|)
end_macro
begin_block
block|{
name|mng_loopp
name|pLOOP
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_LOOP_SIGNALS_SUPPORTED
name|mng_uint8p
name|pTemp1
decl_stmt|;
name|mng_uint32p
name|pTemp2
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_LOOP
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pLOOP
operator|=
operator|(
name|mng_loopp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|5
expr_stmt|;
comment|/* fill the output buffer */
operator|*
name|pRawdata
operator|=
name|pLOOP
operator|->
name|iLevel
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|1
argument_list|,
name|pLOOP
operator|->
name|iRepeat
argument_list|)
expr_stmt|;
if|if
condition|(
name|pLOOP
operator|->
name|iTermination
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|5
operator|)
operator|=
name|pLOOP
operator|->
name|iTermination
expr_stmt|;
if|if
condition|(
operator|(
name|pLOOP
operator|->
name|iCount
operator|)
operator|||
operator|(
name|pLOOP
operator|->
name|iItermin
operator|!=
literal|1
operator|)
operator|||
operator|(
name|pLOOP
operator|->
name|iItermax
operator|!=
literal|0x7FFFFFFFL
operator|)
condition|)
block|{
name|iRawlen
operator|+=
literal|8
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|6
argument_list|,
name|pLOOP
operator|->
name|iItermin
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|10
argument_list|,
name|pLOOP
operator|->
name|iItermax
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_LOOP_SIGNALS_SUPPORTED
if|if
condition|(
name|pLOOP
operator|->
name|iCount
condition|)
block|{
name|iRawlen
operator|+=
name|pLOOP
operator|->
name|iCount
operator|*
literal|4
expr_stmt|;
name|pTemp1
operator|=
name|pRawdata
operator|+
literal|14
expr_stmt|;
name|pTemp2
operator|=
name|pLOOP
operator|->
name|pSignals
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pLOOP
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
name|mng_put_uint32
argument_list|(
name|pTemp1
argument_list|,
operator|*
name|pTemp2
argument_list|)
expr_stmt|;
name|pTemp1
operator|+=
literal|4
expr_stmt|;
name|pTemp2
operator|++
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pLOOP
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_LOOP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_endl
argument_list|)
end_macro
begin_block
block|{
name|mng_endlp
name|pENDL
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ENDL
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pENDL
operator|=
operator|(
name|mng_endlp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|1
expr_stmt|;
operator|*
name|pRawdata
operator|=
name|pENDL
operator|->
name|iLevel
expr_stmt|;
comment|/* fill the output buffer */
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pENDL
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ENDL
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_defi
argument_list|)
end_macro
begin_block
block|{
name|mng_defip
name|pDEFI
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DEFI
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pDEFI
operator|=
operator|(
name|mng_defip
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|2
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pDEFI
operator|->
name|iObjectid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pDEFI
operator|->
name|iDonotshow
operator|)
operator|||
operator|(
name|pDEFI
operator|->
name|iConcrete
operator|)
operator|||
operator|(
name|pDEFI
operator|->
name|bHasloca
operator|)
operator|||
operator|(
name|pDEFI
operator|->
name|bHasclip
operator|)
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
operator|=
name|pDEFI
operator|->
name|iDonotshow
expr_stmt|;
if|if
condition|(
operator|(
name|pDEFI
operator|->
name|iConcrete
operator|)
operator|||
operator|(
name|pDEFI
operator|->
name|bHasloca
operator|)
operator|||
operator|(
name|pDEFI
operator|->
name|bHasclip
operator|)
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
operator|=
name|pDEFI
operator|->
name|iConcrete
expr_stmt|;
if|if
condition|(
operator|(
name|pDEFI
operator|->
name|bHasloca
operator|)
operator|||
operator|(
name|pDEFI
operator|->
name|bHasclip
operator|)
condition|)
block|{
name|iRawlen
operator|+=
literal|8
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pDEFI
operator|->
name|iXlocation
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|,
name|pDEFI
operator|->
name|iYlocation
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDEFI
operator|->
name|bHasclip
condition|)
block|{
name|iRawlen
operator|+=
literal|16
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|,
name|pDEFI
operator|->
name|iLeftcb
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|,
name|pDEFI
operator|->
name|iRightcb
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|20
argument_list|,
name|pDEFI
operator|->
name|iTopcb
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|24
argument_list|,
name|pDEFI
operator|->
name|iBottomcb
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pDEFI
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DEFI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_basi
argument_list|)
end_macro
begin_block
block|{
name|mng_basip
name|pBASI
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_bool
name|bOpaque
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_BASI
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pBASI
operator|=
operator|(
name|mng_basip
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pBASI
operator|->
name|iBitdepth
operator|<=
literal|8
condition|)
comment|/* determine opacity alpha-field */
endif|#
directive|endif
name|bOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pBASI
operator|->
name|iAlpha
operator|==
literal|0xFF
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
else|else
name|bOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pBASI
operator|->
name|iAlpha
operator|==
literal|0xFFFF
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|13
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pBASI
operator|->
name|iWidth
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pBASI
operator|->
name|iHeight
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
operator|=
name|pBASI
operator|->
name|iBitdepth
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
operator|=
name|pBASI
operator|->
name|iColortype
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|10
operator|)
operator|=
name|pBASI
operator|->
name|iCompression
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|11
operator|)
operator|=
name|pBASI
operator|->
name|iFilter
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
operator|=
name|pBASI
operator|->
name|iInterlace
expr_stmt|;
if|if
condition|(
operator|(
name|pBASI
operator|->
name|iRed
operator|)
operator|||
operator|(
name|pBASI
operator|->
name|iGreen
operator|)
operator|||
operator|(
name|pBASI
operator|->
name|iBlue
operator|)
operator|||
operator|(
operator|!
name|bOpaque
operator|)
operator|||
operator|(
name|pBASI
operator|->
name|iViewable
operator|)
condition|)
block|{
name|iRawlen
operator|+=
literal|6
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|13
argument_list|,
name|pBASI
operator|->
name|iRed
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|15
argument_list|,
name|pBASI
operator|->
name|iGreen
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|17
argument_list|,
name|pBASI
operator|->
name|iBlue
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|bOpaque
operator|)
operator|||
operator|(
name|pBASI
operator|->
name|iViewable
operator|)
condition|)
block|{
name|iRawlen
operator|+=
literal|2
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|19
argument_list|,
name|pBASI
operator|->
name|iAlpha
argument_list|)
expr_stmt|;
if|if
condition|(
name|pBASI
operator|->
name|iViewable
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|21
operator|)
operator|=
name|pBASI
operator|->
name|iViewable
expr_stmt|;
block|}
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pBASI
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_BASI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_clon
argument_list|)
end_macro
begin_block
block|{
name|mng_clonp
name|pCLON
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_CLON
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pCLON
operator|=
operator|(
name|mng_clonp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|4
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pCLON
operator|->
name|iSourceid
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pCLON
operator|->
name|iCloneid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pCLON
operator|->
name|iClonetype
operator|)
operator|||
operator|(
name|pCLON
operator|->
name|iDonotshow
operator|)
operator|||
operator|(
name|pCLON
operator|->
name|iConcrete
operator|)
operator|||
operator|(
name|pCLON
operator|->
name|bHasloca
operator|)
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
operator|=
name|pCLON
operator|->
name|iClonetype
expr_stmt|;
if|if
condition|(
operator|(
name|pCLON
operator|->
name|iDonotshow
operator|)
operator|||
operator|(
name|pCLON
operator|->
name|iConcrete
operator|)
operator|||
operator|(
name|pCLON
operator|->
name|bHasloca
operator|)
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|5
operator|)
operator|=
name|pCLON
operator|->
name|iDonotshow
expr_stmt|;
if|if
condition|(
operator|(
name|pCLON
operator|->
name|iConcrete
operator|)
operator|||
operator|(
name|pCLON
operator|->
name|bHasloca
operator|)
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|6
operator|)
operator|=
name|pCLON
operator|->
name|iConcrete
expr_stmt|;
if|if
condition|(
name|pCLON
operator|->
name|bHasloca
condition|)
block|{
name|iRawlen
operator|+=
literal|9
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|7
operator|)
operator|=
name|pCLON
operator|->
name|iLocationtype
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|,
name|pCLON
operator|->
name|iLocationx
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|,
name|pCLON
operator|->
name|iLocationy
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pCLON
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_CLON
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_PAST
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_past
argument_list|)
end_macro
begin_block
block|{
name|mng_pastp
name|pPAST
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_past_sourcep
name|pSource
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PAST
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pPAST
operator|=
operator|(
name|mng_pastp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|11
operator|+
operator|(
literal|30
operator|*
name|pPAST
operator|->
name|iCount
operator|)
expr_stmt|;
comment|/* requires large buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pPAST
operator|->
name|iDestid
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
operator|=
name|pPAST
operator|->
name|iTargettype
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|3
argument_list|,
name|pPAST
operator|->
name|iTargetx
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|7
argument_list|,
name|pPAST
operator|->
name|iTargety
argument_list|)
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
operator|+
literal|11
expr_stmt|;
name|pSource
operator|=
name|pPAST
operator|->
name|pSources
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pPAST
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
name|mng_put_uint16
argument_list|(
name|pTemp
argument_list|,
name|pSource
operator|->
name|iSourceid
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
operator|=
name|pSource
operator|->
name|iComposition
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|3
operator|)
operator|=
name|pSource
operator|->
name|iOrientation
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|4
operator|)
operator|=
name|pSource
operator|->
name|iOffsettype
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|5
argument_list|,
name|pSource
operator|->
name|iOffsetx
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|9
argument_list|,
name|pSource
operator|->
name|iOffsety
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|13
operator|)
operator|=
name|pSource
operator|->
name|iBoundarytype
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|14
argument_list|,
name|pSource
operator|->
name|iBoundaryl
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|18
argument_list|,
name|pSource
operator|->
name|iBoundaryr
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|22
argument_list|,
name|pSource
operator|->
name|iBoundaryt
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|26
argument_list|,
name|pSource
operator|->
name|iBoundaryb
argument_list|)
expr_stmt|;
name|pSource
operator|++
expr_stmt|;
name|pTemp
operator|+=
literal|30
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPAST
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
comment|/* free temporary buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PAST
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_disc
argument_list|)
end_macro
begin_block
block|{
name|mng_discp
name|pDISC
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
name|mng_uint8p
name|pTemp1
decl_stmt|;
name|mng_uint16p
name|pTemp2
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DISC
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pDISC
operator|=
operator|(
name|mng_discp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pDISC
operator|->
name|iCount
operator|<<
literal|1
expr_stmt|;
name|pTemp1
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the output buffer */
name|pTemp2
operator|=
name|pDISC
operator|->
name|pObjectids
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pDISC
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
name|mng_put_uint16
argument_list|(
name|pTemp1
argument_list|,
operator|*
name|pTemp2
argument_list|)
expr_stmt|;
name|pTemp2
operator|++
expr_stmt|;
name|pTemp1
operator|+=
literal|2
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pDISC
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DISC
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_back
argument_list|)
end_macro
begin_block
block|{
name|mng_backp
name|pBACK
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_BACK
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pBACK
operator|=
operator|(
name|mng_backp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|6
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pBACK
operator|->
name|iRed
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pBACK
operator|->
name|iGreen
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pBACK
operator|->
name|iBlue
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pBACK
operator|->
name|iMandatory
operator|)
operator|||
operator|(
name|pBACK
operator|->
name|iImageid
operator|)
operator|||
operator|(
name|pBACK
operator|->
name|iTile
operator|)
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|6
operator|)
operator|=
name|pBACK
operator|->
name|iMandatory
expr_stmt|;
if|if
condition|(
operator|(
name|pBACK
operator|->
name|iImageid
operator|)
operator|||
operator|(
name|pBACK
operator|->
name|iTile
operator|)
condition|)
block|{
name|iRawlen
operator|+=
literal|2
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|7
argument_list|,
name|pBACK
operator|->
name|iImageid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pBACK
operator|->
name|iTile
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
operator|=
name|pBACK
operator|->
name|iTile
expr_stmt|;
block|}
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pBACK
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_BACK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_fram
argument_list|)
end_macro
begin_block
block|{
name|mng_framp
name|pFRAM
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint32p
name|pTemp2
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_FRAM
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pFRAM
operator|=
operator|(
name|mng_framp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pFRAM
operator|->
name|bEmpty
condition|)
comment|/* empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pFRAM
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|1
expr_stmt|;
comment|/* fill the output buffer */
operator|*
name|pRawdata
operator|=
name|pFRAM
operator|->
name|iMode
expr_stmt|;
if|if
condition|(
operator|(
name|pFRAM
operator|->
name|iNamesize
operator|)
operator|||
operator|(
name|pFRAM
operator|->
name|iChangedelay
operator|)
operator|||
operator|(
name|pFRAM
operator|->
name|iChangetimeout
operator|)
operator|||
operator|(
name|pFRAM
operator|->
name|iChangeclipping
operator|)
operator|||
operator|(
name|pFRAM
operator|->
name|iChangesyncid
operator|)
condition|)
block|{
if|if
condition|(
name|pFRAM
operator|->
name|iNamesize
condition|)
name|MNG_COPY
argument_list|(
name|pRawdata
operator|+
literal|1
argument_list|,
name|pFRAM
operator|->
name|zName
argument_list|,
name|pFRAM
operator|->
name|iNamesize
argument_list|)
expr_stmt|;
name|iRawlen
operator|+=
name|pFRAM
operator|->
name|iNamesize
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
operator|+
name|pFRAM
operator|->
name|iNamesize
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|pFRAM
operator|->
name|iChangedelay
operator|)
operator|||
operator|(
name|pFRAM
operator|->
name|iChangetimeout
operator|)
operator|||
operator|(
name|pFRAM
operator|->
name|iChangeclipping
operator|)
operator|||
operator|(
name|pFRAM
operator|->
name|iChangesyncid
operator|)
condition|)
block|{
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
operator|=
name|pFRAM
operator|->
name|iChangedelay
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
operator|=
name|pFRAM
operator|->
name|iChangetimeout
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|3
operator|)
operator|=
name|pFRAM
operator|->
name|iChangeclipping
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|4
operator|)
operator|=
name|pFRAM
operator|->
name|iChangesyncid
expr_stmt|;
name|iRawlen
operator|+=
literal|5
expr_stmt|;
name|pTemp
operator|+=
literal|5
expr_stmt|;
if|if
condition|(
name|pFRAM
operator|->
name|iChangedelay
condition|)
block|{
name|mng_put_uint32
argument_list|(
name|pTemp
argument_list|,
name|pFRAM
operator|->
name|iDelay
argument_list|)
expr_stmt|;
name|iRawlen
operator|+=
literal|4
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|pFRAM
operator|->
name|iChangetimeout
condition|)
block|{
name|mng_put_uint32
argument_list|(
name|pTemp
argument_list|,
name|pFRAM
operator|->
name|iTimeout
argument_list|)
expr_stmt|;
name|iRawlen
operator|+=
literal|4
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|pFRAM
operator|->
name|iChangeclipping
condition|)
block|{
operator|*
name|pTemp
operator|=
name|pFRAM
operator|->
name|iBoundarytype
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|1
argument_list|,
name|pFRAM
operator|->
name|iBoundaryl
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|5
argument_list|,
name|pFRAM
operator|->
name|iBoundaryr
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|9
argument_list|,
name|pFRAM
operator|->
name|iBoundaryt
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|13
argument_list|,
name|pFRAM
operator|->
name|iBoundaryb
argument_list|)
expr_stmt|;
name|iRawlen
operator|+=
literal|17
expr_stmt|;
name|pTemp
operator|+=
literal|17
expr_stmt|;
block|}
if|if
condition|(
name|pFRAM
operator|->
name|iChangesyncid
condition|)
block|{
name|iRawlen
operator|+=
name|pFRAM
operator|->
name|iCount
operator|*
literal|4
expr_stmt|;
name|pTemp2
operator|=
name|pFRAM
operator|->
name|pSyncids
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pFRAM
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
name|mng_put_uint32
argument_list|(
name|pTemp
argument_list|,
operator|*
name|pTemp2
argument_list|)
expr_stmt|;
name|pTemp2
operator|++
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pFRAM
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_FRAM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_move
argument_list|)
end_macro
begin_block
block|{
name|mng_movep
name|pMOVE
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MOVE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pMOVE
operator|=
operator|(
name|mng_movep
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|13
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pMOVE
operator|->
name|iFirstid
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pMOVE
operator|->
name|iLastid
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
operator|=
name|pMOVE
operator|->
name|iMovetype
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|,
name|pMOVE
operator|->
name|iMovex
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|9
argument_list|,
name|pMOVE
operator|->
name|iMovey
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pMOVE
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MOVE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_clip
argument_list|)
end_macro
begin_block
block|{
name|mng_clipp
name|pCLIP
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_CLIP
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pCLIP
operator|=
operator|(
name|mng_clipp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|21
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pCLIP
operator|->
name|iFirstid
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pCLIP
operator|->
name|iLastid
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
operator|=
name|pCLIP
operator|->
name|iCliptype
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|,
name|pCLIP
operator|->
name|iClipl
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|9
argument_list|,
name|pCLIP
operator|->
name|iClipr
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|13
argument_list|,
name|pCLIP
operator|->
name|iClipt
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pRawdata
operator|+
literal|17
argument_list|,
name|pCLIP
operator|->
name|iClipb
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pCLIP
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_CLIP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_show
argument_list|)
end_macro
begin_block
block|{
name|mng_showp
name|pSHOW
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SHOW
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pSHOW
operator|=
operator|(
name|mng_showp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pSHOW
operator|->
name|bEmpty
condition|)
comment|/* empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSHOW
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|2
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pSHOW
operator|->
name|iFirstid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pSHOW
operator|->
name|iLastid
operator|!=
name|pSHOW
operator|->
name|iFirstid
operator|)
operator|||
operator|(
name|pSHOW
operator|->
name|iMode
operator|)
condition|)
block|{
name|iRawlen
operator|+=
literal|2
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pSHOW
operator|->
name|iLastid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSHOW
operator|->
name|iMode
condition|)
block|{
name|iRawlen
operator|++
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
operator|=
name|pSHOW
operator|->
name|iMode
expr_stmt|;
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSHOW
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SHOW
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_term
argument_list|)
end_macro
begin_block
block|{
name|mng_termp
name|pTERM
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_TERM
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pTERM
operator|=
operator|(
name|mng_termp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|1
expr_stmt|;
operator|*
name|pRawdata
operator|=
name|pTERM
operator|->
name|iTermaction
expr_stmt|;
comment|/* fill the output buffer */
if|if
condition|(
name|pTERM
operator|->
name|iTermaction
operator|==
literal|3
condition|)
block|{
name|iRawlen
operator|=
literal|10
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
operator|=
name|pTERM
operator|->
name|iIteraction
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pTERM
operator|->
name|iDelay
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|6
argument_list|,
name|pTERM
operator|->
name|iItermax
argument_list|)
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pTERM
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_TERM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SAVE
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_save
argument_list|)
end_macro
begin_block
block|{
name|mng_savep
name|pSAVE
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_save_entryp
name|pEntry
decl_stmt|;
name|mng_uint32
name|iEntrysize
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SAVE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pSAVE
operator|=
operator|(
name|mng_savep
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pSAVE
operator|->
name|bEmpty
condition|)
comment|/* empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSAVE
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|1
expr_stmt|;
operator|*
name|pRawdata
operator|=
name|pSAVE
operator|->
name|iOffsettype
expr_stmt|;
comment|/* fill the output buffer */
if|if
condition|(
name|pSAVE
operator|->
name|iOffsettype
operator|==
literal|16
condition|)
name|iEntrysize
operator|=
literal|25
expr_stmt|;
else|else
name|iEntrysize
operator|=
literal|17
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
operator|+
literal|1
expr_stmt|;
name|pEntry
operator|=
name|pSAVE
operator|->
name|pEntries
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pSAVE
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
if|if
condition|(
name|iX
condition|)
comment|/* put separator null-byte, except the first */
block|{
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
name|iRawlen
operator|++
expr_stmt|;
block|}
name|iRawlen
operator|+=
name|iEntrysize
operator|+
name|pEntry
operator|->
name|iNamesize
expr_stmt|;
operator|*
name|pTemp
operator|=
name|pEntry
operator|->
name|iEntrytype
expr_stmt|;
if|if
condition|(
name|pSAVE
operator|->
name|iOffsettype
operator|==
literal|16
condition|)
block|{
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|1
argument_list|,
name|pEntry
operator|->
name|iOffset
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|5
argument_list|,
name|pEntry
operator|->
name|iOffset
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|9
argument_list|,
name|pEntry
operator|->
name|iStarttime
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|13
argument_list|,
name|pEntry
operator|->
name|iStarttime
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|17
argument_list|,
name|pEntry
operator|->
name|iLayernr
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|21
argument_list|,
name|pEntry
operator|->
name|iFramenr
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|25
expr_stmt|;
block|}
else|else
block|{
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|1
argument_list|,
name|pEntry
operator|->
name|iOffset
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|5
argument_list|,
name|pEntry
operator|->
name|iStarttime
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|9
argument_list|,
name|pEntry
operator|->
name|iLayernr
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pTemp
operator|+
literal|13
argument_list|,
name|pEntry
operator|->
name|iFramenr
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|17
expr_stmt|;
block|}
if|if
condition|(
name|pEntry
operator|->
name|iNamesize
condition|)
block|{
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pEntry
operator|->
name|zName
argument_list|,
name|pEntry
operator|->
name|iNamesize
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
name|pEntry
operator|->
name|iNamesize
expr_stmt|;
block|}
name|pEntry
operator|++
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSAVE
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SAVE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SEEK
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_seek
argument_list|)
end_macro
begin_block
block|{
name|mng_seekp
name|pSEEK
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SEEK
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pSEEK
operator|=
operator|(
name|mng_seekp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pSEEK
operator|->
name|iNamesize
expr_stmt|;
if|if
condition|(
name|iRawlen
condition|)
comment|/* fill the output buffer */
name|MNG_COPY
argument_list|(
name|pRawdata
argument_list|,
name|pSEEK
operator|->
name|zName
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pSEEK
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_SEEK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_eXPI
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_expi
argument_list|)
end_macro
begin_block
block|{
name|mng_expip
name|pEXPI
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_EXPI
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pEXPI
operator|=
operator|(
name|mng_expip
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|2
operator|+
name|pEXPI
operator|->
name|iNamesize
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pEXPI
operator|->
name|iSnapshotid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pEXPI
operator|->
name|iNamesize
condition|)
name|MNG_COPY
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pEXPI
operator|->
name|zName
argument_list|,
name|pEXPI
operator|->
name|iNamesize
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pEXPI
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_EXPI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_fPRI
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_fpri
argument_list|)
end_macro
begin_block
block|{
name|mng_fprip
name|pFPRI
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_FPRI
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pFPRI
operator|=
operator|(
name|mng_fprip
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|2
expr_stmt|;
operator|*
name|pRawdata
operator|=
name|pFPRI
operator|->
name|iDeltatype
expr_stmt|;
comment|/* fill the output buffer */
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
operator|=
name|pFPRI
operator|->
name|iPriority
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pFPRI
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_FPRI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_nEED
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_need
argument_list|)
end_macro
begin_block
block|{
name|mng_needp
name|pNEED
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_NEED
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pNEED
operator|=
operator|(
name|mng_needp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pNEED
operator|->
name|iKeywordssize
expr_stmt|;
comment|/* fill the output buffer */
if|if
condition|(
name|pNEED
operator|->
name|iKeywordssize
condition|)
name|MNG_COPY
argument_list|(
name|pRawdata
argument_list|,
name|pNEED
operator|->
name|zKeywords
argument_list|,
name|pNEED
operator|->
name|iKeywordssize
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pNEED
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_NEED
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_pHYg
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_phyg
argument_list|)
end_macro
begin_block
block|{
name|mng_phygp
name|pPHYG
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PHYG
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pPHYG
operator|=
operator|(
name|mng_phygp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pPHYG
operator|->
name|bEmpty
condition|)
comment|/* write empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPHYG
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|9
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pPHYG
operator|->
name|iSizex
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pPHYG
operator|->
name|iSizey
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
operator|=
name|pPHYG
operator|->
name|iUnit
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPHYG
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PHYG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* B004 */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_comment
comment|/* B004 */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_jhdr
argument_list|)
end_macro
begin_block
block|{
name|mng_jhdrp
name|pJHDR
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_JHDR
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pJHDR
operator|=
operator|(
name|mng_jhdrp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|16
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pJHDR
operator|->
name|iWidth
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pJHDR
operator|->
name|iHeight
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|8
operator|)
operator|=
name|pJHDR
operator|->
name|iColortype
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|9
operator|)
operator|=
name|pJHDR
operator|->
name|iImagesampledepth
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|10
operator|)
operator|=
name|pJHDR
operator|->
name|iImagecompression
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|11
operator|)
operator|=
name|pJHDR
operator|->
name|iImageinterlace
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
operator|=
name|pJHDR
operator|->
name|iAlphasampledepth
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|13
operator|)
operator|=
name|pJHDR
operator|->
name|iAlphacompression
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|14
operator|)
operator|=
name|pJHDR
operator|->
name|iAlphafilter
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|15
operator|)
operator|=
name|pJHDR
operator|->
name|iAlphainterlace
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pJHDR
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_JHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_else
else|#
directive|else
end_else
begin_define
DECL|macro|write_jhdr
define|#
directive|define
name|write_jhdr
value|0
end_define
begin_comment
comment|/* B004 */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_comment
comment|/* B004 */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_jdaa
argument_list|)
end_macro
begin_block
block|{
name|mng_jdatp
name|pJDAA
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_JDAA
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pJDAA
operator|=
operator|(
name|mng_jdaap
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pJDAA
operator|->
name|bEmpty
condition|)
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pJDAA
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pJDAA
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|pJDAA
operator|->
name|iDatasize
argument_list|,
name|pJDAA
operator|->
name|pData
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_JDAA
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_else
else|#
directive|else
end_else
begin_define
DECL|macro|write_jdaa
define|#
directive|define
name|write_jdaa
value|0
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* B004 */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_comment
comment|/* B004 */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_jdat
argument_list|)
end_macro
begin_block
block|{
name|mng_jdatp
name|pJDAT
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_JDAT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pJDAT
operator|=
operator|(
name|mng_jdatp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
name|pJDAT
operator|->
name|bEmpty
condition|)
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pJDAT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pJDAT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|pJDAT
operator|->
name|iDatasize
argument_list|,
name|pJDAT
operator|->
name|pData
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_JDAT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_else
else|#
directive|else
end_else
begin_define
DECL|macro|write_jdat
define|#
directive|define
name|write_jdat
value|0
end_define
begin_comment
comment|/* B004 */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_comment
comment|/* B004 */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* B004 */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_comment
comment|/* B004 */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_jsep
argument_list|)
end_macro
begin_block
block|{
name|mng_jsepp
name|pJSEP
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_JSEP
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pJSEP
operator|=
operator|(
name|mng_jsepp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pJSEP
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_JSEP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_else
else|#
directive|else
end_else
begin_define
DECL|macro|write_jsep
define|#
directive|define
name|write_jsep
value|0
end_define
begin_comment
comment|/* B004 */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_comment
comment|/* B004 */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_dhdr
argument_list|)
end_macro
begin_block
block|{
name|mng_dhdrp
name|pDHDR
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DHDR
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pDHDR
operator|=
operator|(
name|mng_dhdrp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|4
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pDHDR
operator|->
name|iObjectid
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
operator|=
name|pDHDR
operator|->
name|iImagetype
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|3
operator|)
operator|=
name|pDHDR
operator|->
name|iDeltatype
expr_stmt|;
if|if
condition|(
name|pDHDR
operator|->
name|iDeltatype
operator|!=
literal|7
condition|)
block|{
name|iRawlen
operator|+=
literal|8
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pDHDR
operator|->
name|iBlockwidth
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|,
name|pDHDR
operator|->
name|iBlockheight
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDHDR
operator|->
name|iDeltatype
operator|!=
literal|0
condition|)
block|{
name|iRawlen
operator|+=
literal|8
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|,
name|pDHDR
operator|->
name|iBlockx
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|,
name|pDHDR
operator|->
name|iBlocky
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pDHDR
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_prom
argument_list|)
end_macro
begin_block
block|{
name|mng_promp
name|pPROM
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PROM
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pPROM
operator|=
operator|(
name|mng_promp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|3
expr_stmt|;
operator|*
name|pRawdata
operator|=
name|pPROM
operator|->
name|iColortype
expr_stmt|;
comment|/* fill the output buffer */
operator|*
operator|(
name|pRawdata
operator|+
literal|1
operator|)
operator|=
name|pPROM
operator|->
name|iSampledepth
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|2
operator|)
operator|=
name|pPROM
operator|->
name|iFilltype
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPROM
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PROM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_ipng
argument_list|)
end_macro
begin_block
block|{
name|mng_ipngp
name|pIPNG
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IPNG
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pIPNG
operator|=
operator|(
name|mng_ipngp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pIPNG
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IPNG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_pplt
argument_list|)
end_macro
begin_block
block|{
name|mng_ppltp
name|pPPLT
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_pplt_entryp
name|pEntry
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
name|mng_bool
name|bHasgroup
decl_stmt|;
name|mng_uint8p
name|pLastid
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PPLT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pPPLT
operator|=
operator|(
name|mng_ppltp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|1
expr_stmt|;
operator|*
name|pRawdata
operator|=
name|pPPLT
operator|->
name|iDeltatype
expr_stmt|;
comment|/* fill the output buffer */
name|pTemp
operator|=
name|pRawdata
operator|+
literal|1
expr_stmt|;
name|bHasgroup
operator|=
name|MNG_FALSE
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pPPLT
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
name|pEntry
operator|=
operator|&
name|pPPLT
operator|->
name|aEntries
index|[
name|iX
index|]
expr_stmt|;
if|if
condition|(
name|pEntry
operator|->
name|bUsed
condition|)
comment|/* valid entry ? */
block|{
if|if
condition|(
operator|!
name|bHasgroup
condition|)
comment|/* start a new group ? */
block|{
name|bHasgroup
operator|=
name|MNG_TRUE
expr_stmt|;
name|pLastid
operator|=
name|pTemp
operator|+
literal|1
expr_stmt|;
operator|*
name|pTemp
operator|=
operator|(
name|mng_uint8
operator|)
name|iX
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
operator|=
literal|0
expr_stmt|;
name|pTemp
operator|+=
literal|2
expr_stmt|;
name|iRawlen
operator|+=
literal|2
expr_stmt|;
block|}
switch|switch
condition|(
name|pPPLT
operator|->
name|iDeltatype
condition|)
comment|/* add group-entry depending on type */
block|{
case|case
literal|0
case|:
empty_stmt|;
case|case
literal|1
case|:
block|{
operator|*
name|pTemp
operator|=
name|pEntry
operator|->
name|iRed
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
operator|=
name|pEntry
operator|->
name|iGreen
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
operator|=
name|pEntry
operator|->
name|iBlue
expr_stmt|;
name|pTemp
operator|+=
literal|3
expr_stmt|;
name|iRawlen
operator|+=
literal|3
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
empty_stmt|;
case|case
literal|3
case|:
block|{
operator|*
name|pTemp
operator|=
name|pEntry
operator|->
name|iAlpha
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
name|iRawlen
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
empty_stmt|;
case|case
literal|5
case|:
block|{
operator|*
name|pTemp
operator|=
name|pEntry
operator|->
name|iRed
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
operator|=
name|pEntry
operator|->
name|iGreen
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
operator|=
name|pEntry
operator|->
name|iBlue
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|3
operator|)
operator|=
name|pEntry
operator|->
name|iAlpha
expr_stmt|;
name|pTemp
operator|+=
literal|4
expr_stmt|;
name|iRawlen
operator|+=
literal|4
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|bHasgroup
condition|)
comment|/* finish off a group ? */
operator|*
name|pLastid
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|iX
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bHasgroup
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|bHasgroup
condition|)
comment|/* last group unfinished ? */
operator|*
name|pLastid
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pPPLT
operator|->
name|iCount
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* write the output buffer */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPPLT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_PPLT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_ijng
argument_list|)
end_macro
begin_block
block|{
name|mng_ijngp
name|pIJNG
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IJNG
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pIJNG
operator|=
operator|(
name|mng_ijngp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pIJNG
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_IJNG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_drop
argument_list|)
end_macro
begin_block
block|{
name|mng_dropp
name|pDROP
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
name|mng_uint8p
name|pTemp1
decl_stmt|;
name|mng_chunkidp
name|pTemp2
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DROP
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pDROP
operator|=
operator|(
name|mng_dropp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pDROP
operator|->
name|iCount
operator|<<
literal|2
expr_stmt|;
name|pTemp1
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the output buffer */
name|pTemp2
operator|=
name|pDROP
operator|->
name|pChunknames
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pDROP
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
name|mng_put_uint32
argument_list|(
name|pTemp1
argument_list|,
operator|(
name|mng_uint32
operator|)
operator|*
name|pTemp2
argument_list|)
expr_stmt|;
name|pTemp2
operator|++
expr_stmt|;
name|pTemp1
operator|+=
literal|4
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pDROP
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DROP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DBYK
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_dbyk
argument_list|)
end_macro
begin_block
block|{
name|mng_dbykp
name|pDBYK
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DBYK
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pDBYK
operator|=
operator|(
name|mng_dbykp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|5
operator|+
name|pDBYK
operator|->
name|iKeywordssize
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pDBYK
operator|->
name|iChunkname
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
operator|=
name|pDBYK
operator|->
name|iPolarity
expr_stmt|;
if|if
condition|(
name|pDBYK
operator|->
name|iKeywordssize
condition|)
name|MNG_COPY
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|,
name|pDBYK
operator|->
name|zKeywords
argument_list|,
name|pDBYK
operator|->
name|iKeywordssize
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pDBYK
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_DBYK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_ORDR
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_ordr
argument_list|)
end_macro
begin_block
block|{
name|mng_ordrp
name|pORDR
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_ordr_entryp
name|pEntry
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ORDR
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pORDR
operator|=
operator|(
name|mng_ordrp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
name|pORDR
operator|->
name|iCount
operator|*
literal|5
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
comment|/* fill the output buffer */
name|pEntry
operator|=
name|pORDR
operator|->
name|pEntries
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pORDR
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
name|mng_put_uint32
argument_list|(
name|pTemp
argument_list|,
name|pEntry
operator|->
name|iChunkname
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|4
operator|)
operator|=
name|pEntry
operator|->
name|iOrdertype
expr_stmt|;
name|pTemp
operator|+=
literal|5
expr_stmt|;
name|pEntry
operator|++
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pORDR
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_ORDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_magn
argument_list|)
end_macro
begin_block
block|{
name|mng_magnp
name|pMAGN
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MAGN
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pMAGN
operator|=
operator|(
name|mng_magnp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|18
expr_stmt|;
comment|/* fill the output buffer */
name|mng_put_uint16
argument_list|(
name|pRawdata
argument_list|,
name|pMAGN
operator|->
name|iFirstid
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|2
argument_list|,
name|pMAGN
operator|->
name|iLastid
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|4
operator|)
operator|=
name|pMAGN
operator|->
name|iMethodX
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|5
argument_list|,
name|pMAGN
operator|->
name|iMX
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|7
argument_list|,
name|pMAGN
operator|->
name|iMY
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|9
argument_list|,
name|pMAGN
operator|->
name|iML
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|11
argument_list|,
name|pMAGN
operator|->
name|iMR
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|13
argument_list|,
name|pMAGN
operator|->
name|iMT
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|15
argument_list|,
name|pMAGN
operator|->
name|iMB
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|17
operator|)
operator|=
name|pMAGN
operator|->
name|iMethodY
expr_stmt|;
comment|/* optimize length */
if|if
condition|(
name|pMAGN
operator|->
name|iMethodY
operator|==
name|pMAGN
operator|->
name|iMethodX
condition|)
block|{
name|iRawlen
operator|--
expr_stmt|;
if|if
condition|(
name|pMAGN
operator|->
name|iMB
operator|==
name|pMAGN
operator|->
name|iMY
condition|)
block|{
name|iRawlen
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|pMAGN
operator|->
name|iMT
operator|==
name|pMAGN
operator|->
name|iMY
condition|)
block|{
name|iRawlen
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|pMAGN
operator|->
name|iMR
operator|==
name|pMAGN
operator|->
name|iMX
condition|)
block|{
name|iRawlen
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|pMAGN
operator|->
name|iML
operator|==
name|pMAGN
operator|->
name|iMX
condition|)
block|{
name|iRawlen
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|pMAGN
operator|->
name|iMY
operator|==
name|pMAGN
operator|->
name|iMX
condition|)
block|{
name|iRawlen
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|pMAGN
operator|->
name|iMX
operator|==
literal|1
condition|)
block|{
name|iRawlen
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|pMAGN
operator|->
name|iMethodX
operator|==
literal|0
condition|)
block|{
name|iRawlen
operator|--
expr_stmt|;
if|if
condition|(
name|pMAGN
operator|->
name|iLastid
operator|==
name|pMAGN
operator|->
name|iFirstid
condition|)
block|{
name|iRawlen
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|pMAGN
operator|->
name|iFirstid
operator|==
literal|0
condition|)
name|iRawlen
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
block|}
block|}
block|}
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pMAGN
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MAGN
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_MPNG_PROPOSAL
end_ifdef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_mpng
argument_list|)
end_macro
begin_block
block|{
name|mng_mpngp
name|pMPNG
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint8p
name|pBuf
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iBuflen
decl_stmt|;
name|mng_uint32
name|iReallen
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MPNG
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pMPNG
operator|=
operator|(
name|mng_mpngp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
comment|/* compress the frame structures */
name|iRetcode
operator|=
name|deflate_buffer
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_uint8p
operator|)
name|pMPNG
operator|->
name|pFrames
argument_list|,
name|pMPNG
operator|->
name|iFramessize
argument_list|,
operator|&
name|pBuf
argument_list|,
operator|&
name|iBuflen
argument_list|,
operator|&
name|iReallen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* all ok ? */
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|15
operator|+
name|iReallen
expr_stmt|;
comment|/* requires large buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
comment|/* fill the buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pMPNG
operator|->
name|iFramewidth
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pMPNG
operator|->
name|iFrameheight
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|,
name|pMPNG
operator|->
name|iNumplays
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pRawdata
operator|+
literal|10
argument_list|,
name|pMPNG
operator|->
name|iTickspersec
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|12
operator|)
operator|=
name|pMPNG
operator|->
name|iCompressionmethod
expr_stmt|;
if|if
condition|(
name|iReallen
condition|)
name|MNG_COPY
argument_list|(
name|pRawdata
operator|+
literal|13
argument_list|,
name|pBuf
argument_list|,
name|iReallen
argument_list|)
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pMPNG
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
comment|/* drop the temp buffer ? */
if|if
condition|(
name|iRawlen
operator|>
name|pData
operator|->
name|iWritebufsize
condition|)
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pRawdata
argument_list|,
name|iRawlen
argument_list|)
expr_stmt|;
block|}
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBuflen
argument_list|)
expr_stmt|;
comment|/* always drop the compression buffer */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_MPNG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_ANG_PROPOSAL
end_ifdef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_ahdr
argument_list|)
end_macro
begin_block
block|{
name|mng_ahdrp
name|pAHDR
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_AHDR
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pAHDR
operator|=
operator|(
name|mng_ahdrp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|22
expr_stmt|;
comment|/* fill the buffer */
name|mng_put_uint32
argument_list|(
name|pRawdata
argument_list|,
name|pAHDR
operator|->
name|iNumframes
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|4
argument_list|,
name|pAHDR
operator|->
name|iTickspersec
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|8
argument_list|,
name|pAHDR
operator|->
name|iNumplays
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|12
argument_list|,
name|pAHDR
operator|->
name|iTilewidth
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pRawdata
operator|+
literal|16
argument_list|,
name|pAHDR
operator|->
name|iTileheight
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|20
operator|)
operator|=
name|pAHDR
operator|->
name|iInterlace
expr_stmt|;
operator|*
operator|(
name|pRawdata
operator|+
literal|21
operator|)
operator|=
name|pAHDR
operator|->
name|iStillused
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pAHDR
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_AHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_ANG_PROPOSAL
end_ifdef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_adat
argument_list|)
end_macro
begin_block
block|{
comment|/* TODO: something */
return|return
name|MNG_NOERROR
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_evNT
end_ifndef
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_evnt
argument_list|)
end_macro
begin_block
block|{
name|mng_evntp
name|pEVNT
decl_stmt|;
name|mng_uint8p
name|pRawdata
decl_stmt|;
name|mng_uint32
name|iRawlen
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_evnt_entryp
name|pEntry
decl_stmt|;
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
name|mng_uint32
name|iNamesize
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_EVNT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pEVNT
operator|=
operator|(
name|mng_evntp
operator|)
name|pChunk
expr_stmt|;
comment|/* address the proper chunk */
if|if
condition|(
operator|!
name|pEVNT
operator|->
name|iCount
condition|)
comment|/* empty ? */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pEVNT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|pRawdata
operator|=
name|pData
operator|->
name|pWritebuf
operator|+
literal|8
expr_stmt|;
comment|/* init output buffer& size */
name|iRawlen
operator|=
literal|0
expr_stmt|;
name|pTemp
operator|=
name|pRawdata
expr_stmt|;
name|pEntry
operator|=
name|pEVNT
operator|->
name|pEntries
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pEVNT
operator|->
name|iCount
condition|;
name|iX
operator|++
control|)
block|{
if|if
condition|(
name|iX
condition|)
comment|/* put separator null-byte, except the first */
block|{
operator|*
name|pTemp
operator|=
literal|0
expr_stmt|;
name|pTemp
operator|++
expr_stmt|;
name|iRawlen
operator|++
expr_stmt|;
block|}
operator|*
name|pTemp
operator|=
name|pEntry
operator|->
name|iEventtype
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|1
operator|)
operator|=
name|pEntry
operator|->
name|iMasktype
expr_stmt|;
name|pTemp
operator|+=
literal|2
expr_stmt|;
name|iRawlen
operator|+=
literal|2
expr_stmt|;
switch|switch
condition|(
name|pEntry
operator|->
name|iMasktype
condition|)
block|{
case|case
literal|1
case|:
block|{
name|mng_put_int32
argument_list|(
name|pTemp
argument_list|,
name|pEntry
operator|->
name|iLeft
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|,
name|pEntry
operator|->
name|iRight
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|,
name|pEntry
operator|->
name|iTop
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|,
name|pEntry
operator|->
name|iBottom
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|16
expr_stmt|;
name|iRawlen
operator|+=
literal|16
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|mng_put_uint16
argument_list|(
name|pTemp
argument_list|,
name|pEntry
operator|->
name|iObjectid
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|2
expr_stmt|;
name|iRawlen
operator|+=
literal|2
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
name|mng_put_uint16
argument_list|(
name|pTemp
argument_list|,
name|pEntry
operator|->
name|iObjectid
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|2
operator|)
operator|=
name|pEntry
operator|->
name|iIndex
expr_stmt|;
name|pTemp
operator|+=
literal|3
expr_stmt|;
name|iRawlen
operator|+=
literal|3
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|mng_put_int32
argument_list|(
name|pTemp
argument_list|,
name|pEntry
operator|->
name|iLeft
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|,
name|pEntry
operator|->
name|iRight
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|,
name|pEntry
operator|->
name|iTop
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|,
name|pEntry
operator|->
name|iBottom
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pTemp
operator|+
literal|16
argument_list|,
name|pEntry
operator|->
name|iObjectid
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
literal|18
expr_stmt|;
name|iRawlen
operator|+=
literal|18
expr_stmt|;
break|break;
block|}
case|case
literal|5
case|:
block|{
name|mng_put_int32
argument_list|(
name|pTemp
argument_list|,
name|pEntry
operator|->
name|iLeft
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|4
argument_list|,
name|pEntry
operator|->
name|iRight
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|8
argument_list|,
name|pEntry
operator|->
name|iTop
argument_list|)
expr_stmt|;
name|mng_put_int32
argument_list|(
name|pTemp
operator|+
literal|12
argument_list|,
name|pEntry
operator|->
name|iBottom
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pTemp
operator|+
literal|16
argument_list|,
name|pEntry
operator|->
name|iObjectid
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pTemp
operator|+
literal|18
operator|)
operator|=
name|pEntry
operator|->
name|iIndex
expr_stmt|;
name|pTemp
operator|+=
literal|19
expr_stmt|;
name|iRawlen
operator|+=
literal|19
expr_stmt|;
break|break;
block|}
block|}
name|iNamesize
operator|=
name|pEntry
operator|->
name|iSegmentnamesize
expr_stmt|;
if|if
condition|(
name|iNamesize
condition|)
block|{
name|MNG_COPY
argument_list|(
name|pTemp
argument_list|,
name|pEntry
operator|->
name|zSegmentname
argument_list|,
name|iNamesize
argument_list|)
expr_stmt|;
name|pTemp
operator|+=
name|iNamesize
expr_stmt|;
name|iRawlen
operator|+=
name|iNamesize
expr_stmt|;
block|}
name|pEntry
operator|++
expr_stmt|;
block|}
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pEVNT
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_EVNT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_macro
DECL|function|WRITE_CHUNK
name|WRITE_CHUNK
argument_list|(
argument|mng_write_unknown
argument_list|)
end_macro
begin_block
block|{
name|mng_unknown_chunkp
name|pUnknown
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_UNKNOWN
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* address the proper chunk */
name|pUnknown
operator|=
operator|(
name|mng_unknown_chunkp
operator|)
name|pChunk
expr_stmt|;
comment|/* and write it */
name|iRetcode
operator|=
name|write_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pUnknown
operator|->
name|sHeader
operator|.
name|iChunkname
argument_list|,
name|pUnknown
operator|->
name|iDatasize
argument_list|,
name|pUnknown
operator|->
name|pData
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_UNKNOWN
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_block
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_WRITE_PROCS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* * end of file                                                            * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
end_unit
