begin_unit
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *             For conditions of distribution and use,                    * */
end_comment
begin_comment
comment|/* *                see copyright notice in libmng.h                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * project   : libmng                                                     * */
end_comment
begin_comment
comment|/* * file      : libmng_write.c            copyright (c) 2000-2004 G.Juyn   * */
end_comment
begin_comment
comment|/* * version   : 1.0.9                                                      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * purpose   : Write management (implementation)                          * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * author    : G.Juyn                                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * comment   : implementation of the write management routines            * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * changes   : 0.5.1 - 05/08/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed strict-ANSI stuff                                * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/12/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed trace to macro for callback error-reporting      * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - moved the actual write_graphic functionality from        * */
end_comment
begin_comment
comment|/* *               mng_hlapi to its appropriate function here               * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/19/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed writing of signature                               * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.2 - 08/05/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed file-prefixes                                    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.5 - 08/19/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B597134 - libmng pollutes the linker namespace           * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.8 - 07/06/2004 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added conditionals around openstream/closestream         * */
end_comment
begin_comment
comment|/* *             - defend against using undefined Open/Closestream function * */
end_comment
begin_comment
comment|/* *             1.0.8 - 08/02/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added conditional to allow easier writing of large MNG's * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.9 - 09/25/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - replaced MNG_TWEAK_LARGE_FILES with permanent solution   * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/20/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - cleaned up macro-invocations (thanks to D. Airlie)       * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_include
include|#
directive|include
file|"libmng.h"
end_include
begin_include
include|#
directive|include
file|"libmng_data.h"
end_include
begin_include
include|#
directive|include
file|"libmng_error.h"
end_include
begin_include
include|#
directive|include
file|"libmng_trace.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|__BORLANDC__
end_ifdef
begin_pragma
pragma|#
directive|pragma
name|hdrstop
end_pragma
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"libmng_memory.h"
end_include
begin_include
include|#
directive|include
file|"libmng_chunks.h"
end_include
begin_include
include|#
directive|include
file|"libmng_chunk_io.h"
end_include
begin_include
include|#
directive|include
file|"libmng_write.h"
end_include
begin_if
if|#
directive|if
name|defined
argument_list|(
name|__BORLANDC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_STRICT_ANSI
argument_list|)
end_if
begin_pragma
pragma|#
directive|pragma
name|option
name|-
name|A
end_pragma
begin_comment
comment|/* force ANSI-C */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_READ
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_SUPPORT_WRITE
argument_list|)
end_if
begin_function
DECL|function|mng_drop_chunks
name|mng_retcode
name|mng_drop_chunks
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_chunkp
name|pChunk
decl_stmt|;
name|mng_chunkp
name|pNext
decl_stmt|;
name|mng_cleanupchunk
name|fCleanup
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_DROP_CHUNKS
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pChunk
operator|=
name|pData
operator|->
name|pFirstchunk
expr_stmt|;
comment|/* and get first stored chunk (if any) */
while|while
condition|(
name|pChunk
condition|)
comment|/* more chunks to discard ? */
block|{
name|pNext
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pChunk
operator|)
operator|->
name|pNext
expr_stmt|;
comment|/* call appropriate cleanup */
name|fCleanup
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pChunk
operator|)
operator|->
name|fCleanup
expr_stmt|;
name|fCleanup
argument_list|(
name|pData
argument_list|,
name|pChunk
argument_list|)
expr_stmt|;
name|pChunk
operator|=
name|pNext
expr_stmt|;
comment|/* neeeext */
block|}
name|pData
operator|->
name|pFirstchunk
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|pLastchunk
operator|=
name|MNG_NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_DROP_CHUNKS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SUPPORT_READ || MNG_SUPPORT_WRITE */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_WRITE_PROCS
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_write_graphic
name|mng_retcode
name|mng_write_graphic
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_chunkp
name|pChunk
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint32
name|iWritten
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_GRAPHIC
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pChunk
operator|=
name|pData
operator|->
name|pFirstchunk
expr_stmt|;
comment|/* we'll start with the first, thank you */
if|if
condition|(
name|pChunk
condition|)
comment|/* is there anything to write ? */
block|{
comment|/* open the file */
if|if
condition|(
operator|!
name|pData
operator|->
name|bWriting
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_OPEN_CLOSE_STREAM
if|if
condition|(
name|pData
operator|->
name|fOpenstream
operator|&&
operator|!
name|pData
operator|->
name|fOpenstream
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|{
name|pData
operator|->
name|bWriting
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate writing */
name|pData
operator|->
name|iWritebufsize
operator|=
literal|32768
expr_stmt|;
comment|/* get a temporary write buffer */
comment|/* reserve 12 bytes for length, chunkname& crc */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
argument_list|,
name|pData
operator|->
name|iWritebufsize
operator|+
literal|12
argument_list|)
expr_stmt|;
comment|/* write the signature */
if|if
condition|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pChunk
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_IHDR
condition|)
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
argument_list|,
name|PNG_SIG
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pChunk
operator|)
operator|->
name|iChunkname
operator|==
name|MNG_UINT_JHDR
condition|)
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
argument_list|,
name|JNG_SIG
argument_list|)
expr_stmt|;
else|else
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
argument_list|,
name|MNG_SIG
argument_list|)
expr_stmt|;
name|mng_put_uint32
argument_list|(
name|pData
operator|->
name|pWritebuf
operator|+
literal|4
argument_list|,
name|POST_SIG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|fWritedata
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
argument_list|,
literal|8
argument_list|,
operator|&
name|iWritten
argument_list|)
condition|)
block|{
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
argument_list|,
name|pData
operator|->
name|iWritebufsize
operator|+
literal|12
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iWritten
operator|!=
literal|8
condition|)
comment|/* disk full ? */
block|{
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
argument_list|,
name|pData
operator|->
name|iWritebufsize
operator|+
literal|12
argument_list|)
expr_stmt|;
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OUTPUTERROR
argument_list|)
expr_stmt|;
block|}
block|}
block|}
while|while
condition|(
name|pChunk
condition|)
comment|/* so long as there's something to write */
block|{
comment|/* let's call its output routine */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pChunk
operator|)
operator|->
name|fWrite
argument_list|(
name|pData
argument_list|,
name|pChunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* neeeext */
name|pChunk
operator|=
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pChunk
operator|)
operator|->
name|pNext
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bCreating
condition|)
block|{
comment|/* free the temporary buffer */
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pWritebuf
argument_list|,
name|pData
operator|->
name|iWritebufsize
operator|+
literal|12
argument_list|)
expr_stmt|;
name|pData
operator|->
name|bWriting
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* done writing */
comment|/* close the stream now */
ifndef|#
directive|ifndef
name|MNG_NO_OPEN_CLOSE_STREAM
if|if
condition|(
name|pData
operator|->
name|fClosestream
operator|&&
operator|!
name|pData
operator|->
name|fClosestream
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
comment|/* cleanup the written chunks */
name|iRetcode
operator|=
name|mng_drop_chunks
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_WRITE_GRAPHIC
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_WRITE_PROCS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* * end of file                                                            * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
end_unit
