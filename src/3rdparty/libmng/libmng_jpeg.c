begin_unit
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *             For conditions of distribution and use,                    * */
end_comment
begin_comment
comment|/* *                see copyright notice in libmng.h                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * project   : libmng                                                     * */
end_comment
begin_comment
comment|/* * file      : libmng_jpeg.c             copyright (c) 2000-2004 G.Juyn   * */
end_comment
begin_comment
comment|/* * version   : 1.0.9                                                      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * purpose   : JPEG library interface (implementation)                    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * author    : G.Juyn                                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * comment   : implementation of the JPEG library interface               * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * changes   : 0.5.1 - 05/08/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed strict-ANSI stuff                                * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/22/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - implemented all the JNG routines                         * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/17/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added tracing of JPEG calls                              * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/24/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed inclusion of IJG read/write code                   * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/29/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed some 64-bit warnings                               * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.2 - 08/05/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed file-prefixes                                    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for JDAA                                   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.1 - 04/19/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added export of JPEG functions for DLL                   * */
end_comment
begin_comment
comment|/* *             1.0.1 - 04/22/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed memory-leaks (Thanks Gregg!)                       * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.4 - 06/22/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B526138 - returned IJGSRC6B calling convention to        * */
end_comment
begin_comment
comment|/* *               default for MSVC                                         * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.5 - 24/02/2003 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B683152 - libjpeg suspension not always honored correctly* */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.6 - 03/04/2003 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed some compiler-warnings                             * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.8 - 08/01/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for 3+byte pixelsize for JPEG's            * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/20/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - cleaned up macro-invocations (thanks to D. Airlie)       * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_include
include|#
directive|include
file|"libmng.h"
end_include
begin_include
include|#
directive|include
file|"libmng_data.h"
end_include
begin_include
include|#
directive|include
file|"libmng_error.h"
end_include
begin_include
include|#
directive|include
file|"libmng_trace.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|__BORLANDC__
end_ifdef
begin_pragma
pragma|#
directive|pragma
name|hdrstop
end_pragma
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"libmng_memory.h"
end_include
begin_include
include|#
directive|include
file|"libmng_pixels.h"
end_include
begin_include
include|#
directive|include
file|"libmng_jpeg.h"
end_include
begin_if
if|#
directive|if
name|defined
argument_list|(
name|__BORLANDC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_STRICT_ANSI
argument_list|)
end_if
begin_pragma
pragma|#
directive|pragma
name|option
name|-
name|A
end_pragma
begin_comment
comment|/* force ANSI-C */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_JNG
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_INCLUDE_DISPLAY_PROCS
argument_list|)
end_if
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Local IJG callback routines (source-manager, error-manager and such)   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_IJG6B
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_DEFINE_JPEG_STDCALL
end_ifdef
begin_decl_stmt
DECL|function|mng_init_source
name|void
name|MNG_DECL
name|mng_init_source
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|)
else|#
directive|else
name|void
name|mng_init_source
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|)
endif|#
directive|endif
block|{
return|return;
comment|/* nothing needed */
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_DEFINE_JPEG_STDCALL
end_ifdef
begin_decl_stmt
DECL|function|mng_fill_input_buffer
name|boolean
name|MNG_DECL
name|mng_fill_input_buffer
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|)
else|#
directive|else
name|boolean
name|mng_fill_input_buffer
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|)
endif|#
directive|endif
block|{
return|return
name|FALSE
return|;
comment|/* force IJG routine to return to caller */
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_DEFINE_JPEG_STDCALL
end_ifdef
begin_decl_stmt
DECL|function|mng_skip_input_data
name|void
name|MNG_DECL
name|mng_skip_input_data
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|,
name|long
name|num_bytes
argument_list|)
else|#
directive|else
name|void
name|mng_skip_input_data
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|,
name|long
name|num_bytes
argument_list|)
endif|#
directive|endif
block|{
if|if
condition|(
name|num_bytes
operator|>
literal|0
condition|)
comment|/* ignore fony calls */
block|{
comment|/* address my generic structure */
name|mng_datap
name|pData
init|=
operator|(
name|mng_datap
operator|)
name|cinfo
operator|->
name|client_data
decl_stmt|;
comment|/* address source manager */
name|mngjpeg_sourcep
name|pSrc
init|=
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
decl_stmt|;
comment|/* problem scenario ? */
if|if
condition|(
name|pSrc
operator|->
name|bytes_in_buffer
operator|<
operator|(
name|size_t
operator|)
name|num_bytes
condition|)
block|{
comment|/* tell the boss we need to skip some data! */
name|pData
operator|->
name|iJPEGtoskip
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
operator|(
name|size_t
operator|)
name|num_bytes
operator|-
name|pSrc
operator|->
name|bytes_in_buffer
argument_list|)
expr_stmt|;
name|pSrc
operator|->
name|bytes_in_buffer
operator|=
literal|0
expr_stmt|;
comment|/* let the JPEG lib suspend */
name|pSrc
operator|->
name|next_input_byte
operator|=
name|MNG_NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* simply advance in the buffer */
name|pSrc
operator|->
name|bytes_in_buffer
operator|-=
name|num_bytes
expr_stmt|;
name|pSrc
operator|->
name|next_input_byte
operator|+=
name|num_bytes
expr_stmt|;
block|}
block|}
return|return;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_DEFINE_JPEG_STDCALL
end_ifdef
begin_decl_stmt
DECL|function|mng_skip_input_data2
name|void
name|MNG_DECL
name|mng_skip_input_data2
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|,
name|long
name|num_bytes
argument_list|)
else|#
directive|else
name|void
name|mng_skip_input_data2
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|,
name|long
name|num_bytes
argument_list|)
endif|#
directive|endif
block|{
if|if
condition|(
name|num_bytes
operator|>
literal|0
condition|)
comment|/* ignore fony calls */
block|{
comment|/* address my generic structure */
name|mng_datap
name|pData
init|=
operator|(
name|mng_datap
operator|)
name|cinfo
operator|->
name|client_data
decl_stmt|;
comment|/* address source manager */
name|mngjpeg_sourcep
name|pSrc
init|=
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
decl_stmt|;
comment|/* problem scenario ? */
if|if
condition|(
name|pSrc
operator|->
name|bytes_in_buffer
operator|<
operator|(
name|size_t
operator|)
name|num_bytes
condition|)
block|{
comment|/* tell the boss we need to skip some data! */
name|pData
operator|->
name|iJPEGtoskip2
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
operator|(
name|size_t
operator|)
name|num_bytes
operator|-
name|pSrc
operator|->
name|bytes_in_buffer
argument_list|)
expr_stmt|;
name|pSrc
operator|->
name|bytes_in_buffer
operator|=
literal|0
expr_stmt|;
comment|/* let the JPEG lib suspend */
name|pSrc
operator|->
name|next_input_byte
operator|=
name|MNG_NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* simply advance in the buffer */
name|pSrc
operator|->
name|bytes_in_buffer
operator|-=
name|num_bytes
expr_stmt|;
name|pSrc
operator|->
name|next_input_byte
operator|+=
name|num_bytes
expr_stmt|;
block|}
block|}
return|return;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_DEFINE_JPEG_STDCALL
end_ifdef
begin_decl_stmt
DECL|function|mng_term_source
name|void
name|MNG_DECL
name|mng_term_source
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|)
else|#
directive|else
name|void
name|mng_term_source
argument_list|(
name|j_decompress_ptr
name|cinfo
argument_list|)
endif|#
directive|endif
block|{
return|return;
comment|/* nothing needed */
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_USE_SETJMP
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_DEFINE_JPEG_STDCALL
end_ifdef
begin_decl_stmt
DECL|function|mng_error_exit
name|void
name|MNG_DECL
name|mng_error_exit
argument_list|(
name|j_common_ptr
name|cinfo
argument_list|)
else|#
directive|else
name|void
name|mng_error_exit
argument_list|(
name|j_common_ptr
name|cinfo
argument_list|)
endif|#
directive|endif
block|{
comment|/* address my generic structure */
name|mng_datap
name|pData
init|=
operator|(
name|mng_datap
operator|)
name|cinfo
operator|->
name|client_data
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_ERROR_TELLTALE
comment|/* fill the message text ??? */
call|(
modifier|*
name|cinfo
operator|->
name|err
operator|->
name|output_message
call|)
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* return to the point of no return... */
name|longjmp
argument_list|(
name|pData
operator|->
name|sErrorbuf
argument_list|,
name|cinfo
operator|->
name|err
operator|->
name|msg_code
argument_list|)
expr_stmt|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_USE_SETJMP */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_USE_SETJMP
end_ifdef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_DEFINE_JPEG_STDCALL
end_ifdef
begin_decl_stmt
DECL|function|mng_output_message
name|void
name|MNG_DECL
name|mng_output_message
argument_list|(
name|j_common_ptr
name|cinfo
argument_list|)
else|#
directive|else
name|void
name|mng_output_message
argument_list|(
name|j_common_ptr
name|cinfo
argument_list|)
endif|#
directive|endif
block|{
return|return;
comment|/* just do nothing ! */
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_USE_SETJMP */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_IJG6B */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Global JPEG routines                                                   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mngjpeg_initialize
name|mng_retcode
name|mngjpeg_initialize
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_INITIALIZE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* allocate space for JPEG structures if necessary */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
if|if
condition|(
name|pData
operator|->
name|pJPEGderr
operator|==
name|MNG_NULL
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGderr
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_error
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|pJPEGdsrc
operator|==
name|MNG_NULL
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGdsrc
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_source
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|pJPEGdinfo
operator|==
name|MNG_NULL
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGdinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_decomp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* enable reverse addressing */
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|client_data
operator|=
name|pData
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|pJPEGderr2
operator|==
name|MNG_NULL
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGderr2
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_error
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|pJPEGdsrc2
operator|==
name|MNG_NULL
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGdsrc2
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_source
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|pJPEGdinfo2
operator|==
name|MNG_NULL
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGdinfo2
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_decomp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* enable reverse addressing */
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|client_data
operator|=
name|pData
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_WRITE
if|if
condition|(
name|pData
operator|->
name|pJPEGcerr
operator|==
name|MNG_NULL
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGcerr
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_error
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|pJPEGcinfo
operator|==
name|MNG_NULL
condition|)
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGcinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_comp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* enable reverse addressing */
name|pData
operator|->
name|pJPEGcinfo
operator|->
name|client_data
operator|=
name|pData
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|pJPEGbuf
operator|==
name|MNG_NULL
condition|)
comment|/* initialize temporary buffers */
block|{
name|pData
operator|->
name|iJPEGbufmax
operator|=
name|MNG_JPEG_MAXBUF
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGbuf
argument_list|,
name|pData
operator|->
name|iJPEGbufmax
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pData
operator|->
name|pJPEGbuf2
operator|==
name|MNG_NULL
condition|)
block|{
name|pData
operator|->
name|iJPEGbufmax2
operator|=
name|MNG_JPEG_MAXBUF
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGbuf2
argument_list|,
name|pData
operator|->
name|iJPEGbufmax2
argument_list|)
expr_stmt|;
block|}
name|pData
operator|->
name|pJPEGcurrent
operator|=
name|pData
operator|->
name|pJPEGbuf
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|pJPEGrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|iJPEGrowlen
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iJPEGtoskip
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|pJPEGcurrent2
operator|=
name|pData
operator|->
name|pJPEGbuf2
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain2
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|pJPEGrow2
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|iJPEGrowlen2
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iJPEGtoskip2
operator|=
literal|0
expr_stmt|;
comment|/* not doing anything yet ! */
name|pData
operator|->
name|bJPEGcompress
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecompress
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGhasheader
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecostarted
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGscanstarted
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGscanending
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecompress2
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGhasheader2
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecostarted2
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGscanstarted2
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iJPEGrow
operator|=
literal|0
expr_stmt|;
comment|/* zero input/output lines */
name|pData
operator|->
name|iJPEGalpharow
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iJPEGrgbrow
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iJPEGdisprow
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_INITIALIZE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mngjpeg_cleanup
name|mng_retcode
name|mngjpeg_cleanup
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_IJG6B
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_USE_SETJMP
argument_list|)
name|mng_retcode
name|iRetcode
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_CLEANUP
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_IJG6B
ifdef|#
directive|ifdef
name|MNG_USE_SETJMP
name|iRetcode
operator|=
name|setjmp
argument_list|(
name|pData
operator|->
name|sErrorbuf
argument_list|)
expr_stmt|;
comment|/* setup local JPEG error-recovery */
if|if
condition|(
name|iRetcode
operator|!=
literal|0
condition|)
comment|/* got here from longjmp ? */
name|MNG_ERRORJ
argument_list|(
name|pData
argument_list|,
name|iRetcode
argument_list|)
expr_stmt|;
comment|/* then IJG-lib issued an error */
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
comment|/* still decompressing something ? */
if|if
condition|(
name|pData
operator|->
name|bJPEGdecompress
condition|)
name|jpeg_destroy_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bJPEGdecompress2
condition|)
name|jpeg_destroy_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_WRITE
if|if
condition|(
name|pData
operator|->
name|bJPEGcompress
condition|)
comment|/* still compressing something ? */
name|jpeg_destroy_compress
argument_list|(
name|pData
operator|->
name|pJPEGcinfo
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* MNG_INCLUDE_IJG6B */
comment|/* cleanup temporary buffers */
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGbuf2
argument_list|,
name|pData
operator|->
name|iJPEGbufmax2
argument_list|)
expr_stmt|;
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGbuf
argument_list|,
name|pData
operator|->
name|iJPEGbufmax
argument_list|)
expr_stmt|;
comment|/* cleanup space for JPEG structures */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_WRITE
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGcinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_comp
argument_list|)
argument_list|)
expr_stmt|;
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGcerr
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_error
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGdinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_decomp
argument_list|)
argument_list|)
expr_stmt|;
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGdsrc
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_source
argument_list|)
argument_list|)
expr_stmt|;
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGderr
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_error
argument_list|)
argument_list|)
expr_stmt|;
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGdinfo2
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_decomp
argument_list|)
argument_list|)
expr_stmt|;
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGdsrc2
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_source
argument_list|)
argument_list|)
expr_stmt|;
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGderr2
argument_list|,
sizeof|sizeof
argument_list|(
name|mngjpeg_error
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGrow2
argument_list|,
name|pData
operator|->
name|iJPEGrowlen2
argument_list|)
expr_stmt|;
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGrow
argument_list|,
name|pData
operator|->
name|iJPEGrowlen
argument_list|)
expr_stmt|;
comment|/* whatever we were doing ... */
comment|/* we don't anymore ... */
name|pData
operator|->
name|bJPEGcompress
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecompress
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGhasheader
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecostarted
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGscanstarted
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGscanending
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecompress2
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGhasheader2
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecostarted2
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGscanstarted2
operator|=
name|MNG_FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_CLEANUP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * JPEG decompression routines (JDAT)                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_function
DECL|function|mngjpeg_decompressinit
name|mng_retcode
name|mngjpeg_decompressinit
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_IJG6B
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_USE_SETJMP
argument_list|)
name|mng_retcode
name|iRetcode
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSINIT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_IJG6B
comment|/* allocate and initialize a JPEG decompression object */
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|err
operator|=
name|jpeg_std_error
argument_list|(
name|pData
operator|->
name|pJPEGderr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_USE_SETJMP
comment|/* setup local JPEG error-routines */
name|pData
operator|->
name|pJPEGderr
operator|->
name|error_exit
operator|=
name|mng_error_exit
expr_stmt|;
name|pData
operator|->
name|pJPEGderr
operator|->
name|output_message
operator|=
name|mng_output_message
expr_stmt|;
name|iRetcode
operator|=
name|setjmp
argument_list|(
name|pData
operator|->
name|sErrorbuf
argument_list|)
expr_stmt|;
comment|/* setup local JPEG error-recovery */
if|if
condition|(
name|iRetcode
operator|!=
literal|0
condition|)
comment|/* got here from longjmp ? */
name|MNG_ERRORJ
argument_list|(
name|pData
argument_list|,
name|iRetcode
argument_list|)
expr_stmt|;
comment|/* then IJG-lib issued an error */
endif|#
directive|endif
comment|/* MNG_USE_SETJMP */
comment|/* allocate and initialize a JPEG decompression object (continued) */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSINIT
argument_list|,
argument|MNG_LC_JPEG_CREATE_DECOMPRESS
argument_list|)
endif|#
directive|endif
name|jpeg_create_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
expr_stmt|;
name|pData
operator|->
name|bJPEGdecompress
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate it's initialized */
comment|/* specify the source of the compressed data (eg, a file) */
comment|/* no, not a file; we have buffered input */
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|=
name|pData
operator|->
name|pJPEGdsrc
expr_stmt|;
comment|/* use the default handler */
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|resync_to_restart
operator|=
name|jpeg_resync_to_restart
expr_stmt|;
comment|/* setup local source routine& parms */
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|init_source
operator|=
name|mng_init_source
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|fill_input_buffer
operator|=
name|mng_fill_input_buffer
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|skip_input_data
operator|=
name|mng_skip_input_data
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|term_source
operator|=
name|mng_term_source
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|next_input_byte
operator|=
name|pData
operator|->
name|pJPEGcurrent
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|bytes_in_buffer
operator|=
name|pData
operator|->
name|iJPEGbufremain
expr_stmt|;
endif|#
directive|endif
comment|/* MNG_INCLUDE_IJG6B */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSINIT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_function
DECL|function|mngjpeg_decompressdata
name|mng_retcode
name|mngjpeg_decompressdata
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint32
name|iRawsize
parameter_list|,
name|mng_uint8p
name|pRawdata
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint32
name|iRemain
decl_stmt|;
name|mng_uint8p
name|pWork
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_IJG6B
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_USE_SETJMP
argument_list|)
name|iRetcode
operator|=
name|setjmp
argument_list|(
name|pData
operator|->
name|sErrorbuf
argument_list|)
expr_stmt|;
comment|/* initialize local JPEG error-recovery */
if|if
condition|(
name|iRetcode
operator|!=
literal|0
condition|)
comment|/* got here from longjmp ? */
name|MNG_ERRORJ
argument_list|(
name|pData
argument_list|,
name|iRetcode
argument_list|)
expr_stmt|;
comment|/* then IJG-lib issued an error */
endif|#
directive|endif
name|pWork
operator|=
name|pRawdata
expr_stmt|;
name|iRemain
operator|=
name|iRawsize
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iJPEGtoskip
condition|)
comment|/* JPEG-lib told us to skip some more data ? */
block|{
if|if
condition|(
name|iRemain
operator|>
name|pData
operator|->
name|iJPEGtoskip
condition|)
comment|/* enough data in this buffer ? */
block|{
name|iRemain
operator|-=
name|pData
operator|->
name|iJPEGtoskip
expr_stmt|;
comment|/* skip enough to access the next byte */
name|pWork
operator|+=
name|pData
operator|->
name|iJPEGtoskip
expr_stmt|;
name|pData
operator|->
name|iJPEGtoskip
operator|=
literal|0
expr_stmt|;
comment|/* no more to skip then */
block|}
else|else
block|{
name|pData
operator|->
name|iJPEGtoskip
operator|-=
name|iRemain
expr_stmt|;
comment|/* skip all data in the buffer */
name|iRemain
operator|=
literal|0
expr_stmt|;
comment|/* and indicate this accordingly */
block|}
comment|/* the skip set current-pointer to NULL ! */
name|pData
operator|->
name|pJPEGcurrent
operator|=
name|pData
operator|->
name|pJPEGbuf
expr_stmt|;
block|}
while|while
condition|(
name|iRemain
condition|)
comment|/* repeat until no more input-bytes */
block|{
comment|/* need to shift anything ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|pJPEGcurrent
operator|>
name|pData
operator|->
name|pJPEGbuf
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pJPEGcurrent
operator|-
name|pData
operator|->
name|pJPEGbuf
operator|+
name|pData
operator|->
name|iJPEGbufremain
operator|+
name|iRemain
operator|>
name|pData
operator|->
name|iJPEGbufmax
operator|)
condition|)
block|{
if|if
condition|(
name|pData
operator|->
name|iJPEGbufremain
operator|>
literal|0
condition|)
comment|/* then do so */
name|MNG_COPY
argument_list|(
name|pData
operator|->
name|pJPEGbuf
argument_list|,
name|pData
operator|->
name|pJPEGcurrent
argument_list|,
name|pData
operator|->
name|iJPEGbufremain
argument_list|)
expr_stmt|;
name|pData
operator|->
name|pJPEGcurrent
operator|=
name|pData
operator|->
name|pJPEGbuf
expr_stmt|;
block|}
comment|/* does the remaining input fit into the buffer ? */
if|if
condition|(
name|pData
operator|->
name|iJPEGbufremain
operator|+
name|iRemain
operator|<=
name|pData
operator|->
name|iJPEGbufmax
condition|)
block|{
comment|/* move the lot */
name|MNG_COPY
argument_list|(
operator|(
name|pData
operator|->
name|pJPEGcurrent
operator|+
name|pData
operator|->
name|iJPEGbufremain
operator|)
argument_list|,
name|pWork
argument_list|,
name|iRemain
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain
operator|+=
name|iRemain
expr_stmt|;
comment|/* adjust remaining_bytes counter */
name|iRemain
operator|=
literal|0
expr_stmt|;
comment|/* and indicate there's no input left */
block|}
else|else
block|{
comment|/* calculate what does fit */
name|mng_uint32
name|iFits
init|=
name|pData
operator|->
name|iJPEGbufmax
operator|-
name|pData
operator|->
name|iJPEGbufremain
decl_stmt|;
if|if
condition|(
name|iFits
operator|<=
literal|0
condition|)
comment|/* no space is just bugger 'm all */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_JPEGBUFTOOSMALL
argument_list|)
expr_stmt|;
comment|/* move that */
name|MNG_COPY
argument_list|(
operator|(
name|pData
operator|->
name|pJPEGcurrent
operator|+
name|pData
operator|->
name|iJPEGbufremain
operator|)
argument_list|,
name|pWork
argument_list|,
name|iFits
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain
operator|+=
name|iFits
expr_stmt|;
comment|/* adjust remain_bytes counter */
name|iRemain
operator|-=
name|iFits
expr_stmt|;
comment|/* and the input-parms */
name|pWork
operator|+=
name|iFits
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_INCLUDE_IJG6B
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|next_input_byte
operator|=
name|pData
operator|->
name|pJPEGcurrent
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|bytes_in_buffer
operator|=
name|pData
operator|->
name|iJPEGbufremain
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|bJPEGhasheader
condition|)
comment|/* haven't got the header yet ? */
block|{
comment|/* call jpeg_read_header() to obtain image info */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_READ_HEADER
argument_list|)
endif|#
directive|endif
if|if
condition|(
name|jpeg_read_header
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|,
name|TRUE
argument_list|)
operator|!=
name|JPEG_SUSPENDED
condition|)
block|{
comment|/* indicate the header's oke */
name|pData
operator|->
name|bJPEGhasheader
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* let's do some sanity checks ! */
if|if
condition|(
operator|(
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|image_width
operator|!=
name|pData
operator|->
name|iDatawidth
operator|)
operator|||
operator|(
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|image_height
operator|!=
name|pData
operator|->
name|iDataheight
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_JPEGPARMSERR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGGRAY
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|jpeg_color_space
operator|!=
name|JCS_GRAYSCALE
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_JPEGPARMSERR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGCOLOR
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|jpeg_color_space
operator|!=
name|JCS_YCbCr
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_JPEGPARMSERR
argument_list|)
expr_stmt|;
comment|/* indicate whether or not it's progressive */
name|pData
operator|->
name|bJPEGprogressive
operator|=
operator|(
name|mng_bool
operator|)
name|jpeg_has_multiple_scans
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
expr_stmt|;
comment|/* progressive+alpha can't display "on-the-fly"!! */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGprogressive
operator|)
operator|&&
operator|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
condition|)
name|pData
operator|->
name|fDisplayrow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* allocate a row of JPEG-samples */
if|if
condition|(
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|jpeg_color_space
operator|==
name|JCS_YCbCr
condition|)
name|pData
operator|->
name|iJPEGrowlen
operator|=
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|image_width
operator|*
name|RGB_PIXELSIZE
expr_stmt|;
else|else
name|pData
operator|->
name|iJPEGrowlen
operator|=
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|image_width
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGrow
argument_list|,
name|pData
operator|->
name|iJPEGrowlen
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iJPEGrgbrow
operator|=
literal|0
expr_stmt|;
comment|/* quite empty up to now */
block|}
name|pData
operator|->
name|pJPEGcurrent
operator|=
operator|(
name|mng_uint8p
operator|)
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|next_input_byte
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain
operator|=
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|bytes_in_buffer
expr_stmt|;
block|}
comment|/* decompress not started ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGhasheader
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bJPEGdecostarted
operator|)
condition|)
block|{
comment|/* set parameters for decompression */
if|if
condition|(
name|pData
operator|->
name|bJPEGprogressive
condition|)
comment|/* progressive display ? */
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|buffered_image
operator|=
name|TRUE
expr_stmt|;
comment|/* jpeg_start_decompress(...); */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_START_DECOMPRESS
argument_list|)
endif|#
directive|endif
if|if
condition|(
name|jpeg_start_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
operator|==
name|TRUE
condition|)
comment|/* indicate it started */
name|pData
operator|->
name|bJPEGdecostarted
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|pJPEGcurrent
operator|=
operator|(
name|mng_uint8p
operator|)
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|next_input_byte
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain
operator|=
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|bytes_in_buffer
expr_stmt|;
block|}
comment|/* process some scanlines ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGhasheader
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bJPEGdecostarted
operator|)
operator|&&
operator|(
operator|(
operator|!
name|jpeg_input_complete
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
operator|)
operator|||
operator|(
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|output_scanline
operator|<
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|output_height
operator|)
operator|||
operator|(
operator|(
name|pData
operator|->
name|bJPEGprogressive
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bJPEGscanending
operator|)
operator|)
operator|)
condition|)
block|{
name|mng_int32
name|iLines
init|=
literal|0
decl_stmt|;
comment|/* for (each output pass) */
do|do
block|{
comment|/* address the row output buffer */
name|JSAMPROW
name|pRow
init|=
operator|(
name|JSAMPROW
operator|)
name|pData
operator|->
name|pJPEGrow
decl_stmt|;
comment|/* init new pass ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGprogressive
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bJPEGscanstarted
operator|)
condition|)
block|{
name|pData
operator|->
name|bJPEGscanstarted
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* adjust output decompression parameters if required */
comment|/* nop */
comment|/* start a new output pass */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_START_OUTPUT
argument_list|)
endif|#
directive|endif
name|jpeg_start_output
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|,
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|input_scan_number
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iJPEGrow
operator|=
literal|0
expr_stmt|;
comment|/* start at row 0 in the image again */
block|}
comment|/* while (scan lines remain to be read) */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bJPEGprogressive
operator|)
operator|||
operator|(
operator|!
name|pData
operator|->
name|bJPEGscanending
operator|)
condition|)
block|{
do|do
block|{
comment|/*   jpeg_read_scanlines(...); */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_READ_SCANLINES
argument_list|)
endif|#
directive|endif
name|iLines
operator|=
name|jpeg_read_scanlines
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|,
operator|(
name|JSAMPARRAY
operator|)
operator|&
name|pRow
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pData
operator|->
name|pJPEGcurrent
operator|=
operator|(
name|mng_uint8p
operator|)
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|next_input_byte
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain
operator|=
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|bytes_in_buffer
expr_stmt|;
if|if
condition|(
name|iLines
operator|>
literal|0
condition|)
comment|/* got something ? */
block|{
if|if
condition|(
name|pData
operator|->
name|fStorerow2
condition|)
comment|/* store in object ? */
block|{
name|iRetcode
operator|=
operator|(
operator|(
name|mng_storerow
operator|)
name|pData
operator|->
name|fStorerow2
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
block|}
do|while
condition|(
operator|(
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|output_scanline
operator|<
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|output_height
operator|)
operator|&&
operator|(
name|iLines
operator|>
literal|0
operator|)
condition|)
do|;
comment|/* until end-of-image or not enough input-data */
block|}
comment|/* terminate output pass */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGprogressive
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|output_scanline
operator|>=
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|output_height
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_FINISH_OUTPUT
argument_list|)
endif|#
directive|endif
if|if
condition|(
name|jpeg_finish_output
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
operator|!=
name|JPEG_SUSPENDED
condition|)
block|{
comment|/* this scan has ended */
name|pData
operator|->
name|bJPEGscanstarted
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGscanending
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
else|else
block|{
name|pData
operator|->
name|bJPEGscanending
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
operator|(
operator|!
name|jpeg_input_complete
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
operator|)
operator|&&
operator|(
name|iLines
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bJPEGscanending
operator|)
condition|)
do|;
block|}
comment|/* end of image ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGhasheader
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bJPEGdecostarted
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bJPEGscanending
operator|)
operator|&&
operator|(
name|jpeg_input_complete
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|input_scan_number
operator|==
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|output_scan_number
operator|)
condition|)
block|{
comment|/* jpeg_finish_decompress(...); */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_FINISH_DECOMPRESS
argument_list|)
endif|#
directive|endif
if|if
condition|(
name|jpeg_finish_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
operator|==
name|TRUE
condition|)
block|{
comment|/* indicate it's done */
name|pData
operator|->
name|bJPEGhasheader
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecostarted
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|pJPEGcurrent
operator|=
operator|(
name|mng_uint8p
operator|)
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|next_input_byte
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain
operator|=
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|pJPEGdinfo
operator|->
name|src
operator|->
name|bytes_in_buffer
expr_stmt|;
comment|/* remaining fluff is an error ! */
if|if
condition|(
operator|(
name|pData
operator|->
name|iJPEGbufremain
operator|>
literal|0
operator|)
operator|||
operator|(
name|iRemain
operator|>
literal|0
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_TOOMUCHJDAT
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* MNG_INCLUDE_IJG6B */
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_function
DECL|function|mngjpeg_decompressfree
name|mng_retcode
name|mngjpeg_decompressfree
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_IJG6B
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_USE_SETJMP
argument_list|)
name|mng_retcode
name|iRetcode
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSFREE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_IJG6B
ifdef|#
directive|ifdef
name|MNG_USE_SETJMP
name|iRetcode
operator|=
name|setjmp
argument_list|(
name|pData
operator|->
name|sErrorbuf
argument_list|)
expr_stmt|;
comment|/* setup local JPEG error-recovery */
if|if
condition|(
name|iRetcode
operator|!=
literal|0
condition|)
comment|/* got here from longjmp ? */
name|MNG_ERRORJ
argument_list|(
name|pData
argument_list|,
name|iRetcode
argument_list|)
expr_stmt|;
comment|/* then IJG-lib issued an error */
endif|#
directive|endif
comment|/* free the row of JPEG-samples*/
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGrow
argument_list|,
name|pData
operator|->
name|iJPEGrowlen
argument_list|)
expr_stmt|;
comment|/* release the JPEG decompression object */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSFREE
argument_list|,
argument|MNG_LC_JPEG_DESTROY_DECOMPRESS
argument_list|)
endif|#
directive|endif
name|jpeg_destroy_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo
argument_list|)
expr_stmt|;
name|pData
operator|->
name|bJPEGdecompress
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* indicate it's done */
endif|#
directive|endif
comment|/* MNG_INCLUDE_IJG6B */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSFREE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * JPEG decompression routines (JDAA)                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_function
DECL|function|mngjpeg_decompressinit2
name|mng_retcode
name|mngjpeg_decompressinit2
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_IJG6B
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_USE_SETJMP
argument_list|)
name|mng_retcode
name|iRetcode
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSINIT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_IJG6B
comment|/* allocate and initialize a JPEG decompression object */
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|err
operator|=
name|jpeg_std_error
argument_list|(
name|pData
operator|->
name|pJPEGderr2
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_USE_SETJMP
comment|/* setup local JPEG error-routines */
name|pData
operator|->
name|pJPEGderr2
operator|->
name|error_exit
operator|=
name|mng_error_exit
expr_stmt|;
name|pData
operator|->
name|pJPEGderr2
operator|->
name|output_message
operator|=
name|mng_output_message
expr_stmt|;
name|iRetcode
operator|=
name|setjmp
argument_list|(
name|pData
operator|->
name|sErrorbuf
argument_list|)
expr_stmt|;
comment|/* setup local JPEG error-recovery */
if|if
condition|(
name|iRetcode
operator|!=
literal|0
condition|)
comment|/* got here from longjmp ? */
name|MNG_ERRORJ
argument_list|(
name|pData
argument_list|,
name|iRetcode
argument_list|)
expr_stmt|;
comment|/* then IJG-lib issued an error */
endif|#
directive|endif
comment|/* MNG_USE_SETJMP */
comment|/* allocate and initialize a JPEG decompression object (continued) */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSINIT
argument_list|,
argument|MNG_LC_JPEG_CREATE_DECOMPRESS
argument_list|)
endif|#
directive|endif
name|jpeg_create_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
expr_stmt|;
name|pData
operator|->
name|bJPEGdecompress2
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate it's initialized */
comment|/* specify the source of the compressed data (eg, a file) */
comment|/* no, not a file; we have buffered input */
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|=
name|pData
operator|->
name|pJPEGdsrc2
expr_stmt|;
comment|/* use the default handler */
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|resync_to_restart
operator|=
name|jpeg_resync_to_restart
expr_stmt|;
comment|/* setup local source routine& parms */
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|init_source
operator|=
name|mng_init_source
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|fill_input_buffer
operator|=
name|mng_fill_input_buffer
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|skip_input_data
operator|=
name|mng_skip_input_data2
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|term_source
operator|=
name|mng_term_source
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|next_input_byte
operator|=
name|pData
operator|->
name|pJPEGcurrent2
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|bytes_in_buffer
operator|=
name|pData
operator|->
name|iJPEGbufremain2
expr_stmt|;
endif|#
directive|endif
comment|/* MNG_INCLUDE_IJG6B */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSINIT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_function
DECL|function|mngjpeg_decompressdata2
name|mng_retcode
name|mngjpeg_decompressdata2
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint32
name|iRawsize
parameter_list|,
name|mng_uint8p
name|pRawdata
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint32
name|iRemain
decl_stmt|;
name|mng_uint8p
name|pWork
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_IJG6B
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_USE_SETJMP
argument_list|)
name|iRetcode
operator|=
name|setjmp
argument_list|(
name|pData
operator|->
name|sErrorbuf
argument_list|)
expr_stmt|;
comment|/* initialize local JPEG error-recovery */
if|if
condition|(
name|iRetcode
operator|!=
literal|0
condition|)
comment|/* got here from longjmp ? */
name|MNG_ERRORJ
argument_list|(
name|pData
argument_list|,
name|iRetcode
argument_list|)
expr_stmt|;
comment|/* then IJG-lib issued an error */
endif|#
directive|endif
name|pWork
operator|=
name|pRawdata
expr_stmt|;
name|iRemain
operator|=
name|iRawsize
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iJPEGtoskip2
condition|)
comment|/* JPEG-lib told us to skip some more data ? */
block|{
if|if
condition|(
name|iRemain
operator|>
name|pData
operator|->
name|iJPEGtoskip2
condition|)
comment|/* enough data in this buffer ? */
block|{
name|iRemain
operator|-=
name|pData
operator|->
name|iJPEGtoskip2
expr_stmt|;
comment|/* skip enough to access the next byte */
name|pWork
operator|+=
name|pData
operator|->
name|iJPEGtoskip2
expr_stmt|;
name|pData
operator|->
name|iJPEGtoskip2
operator|=
literal|0
expr_stmt|;
comment|/* no more to skip then */
block|}
else|else
block|{
name|pData
operator|->
name|iJPEGtoskip2
operator|-=
name|iRemain
expr_stmt|;
comment|/* skip all data in the buffer */
name|iRemain
operator|=
literal|0
expr_stmt|;
comment|/* and indicate this accordingly */
block|}
comment|/* the skip set current-pointer to NULL ! */
name|pData
operator|->
name|pJPEGcurrent2
operator|=
name|pData
operator|->
name|pJPEGbuf2
expr_stmt|;
block|}
while|while
condition|(
name|iRemain
condition|)
comment|/* repeat until no more input-bytes */
block|{
comment|/* need to shift anything ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|pJPEGcurrent2
operator|>
name|pData
operator|->
name|pJPEGbuf2
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pJPEGcurrent2
operator|-
name|pData
operator|->
name|pJPEGbuf2
operator|+
name|pData
operator|->
name|iJPEGbufremain2
operator|+
name|iRemain
operator|>
name|pData
operator|->
name|iJPEGbufmax2
operator|)
condition|)
block|{
if|if
condition|(
name|pData
operator|->
name|iJPEGbufremain2
operator|>
literal|0
condition|)
comment|/* then do so */
name|MNG_COPY
argument_list|(
name|pData
operator|->
name|pJPEGbuf2
argument_list|,
name|pData
operator|->
name|pJPEGcurrent2
argument_list|,
name|pData
operator|->
name|iJPEGbufremain2
argument_list|)
expr_stmt|;
name|pData
operator|->
name|pJPEGcurrent2
operator|=
name|pData
operator|->
name|pJPEGbuf2
expr_stmt|;
block|}
comment|/* does the remaining input fit into the buffer ? */
if|if
condition|(
name|pData
operator|->
name|iJPEGbufremain2
operator|+
name|iRemain
operator|<=
name|pData
operator|->
name|iJPEGbufmax2
condition|)
block|{
comment|/* move the lot */
name|MNG_COPY
argument_list|(
operator|(
name|pData
operator|->
name|pJPEGcurrent2
operator|+
name|pData
operator|->
name|iJPEGbufremain2
operator|)
argument_list|,
name|pWork
argument_list|,
name|iRemain
argument_list|)
expr_stmt|;
comment|/* adjust remaining_bytes counter */
name|pData
operator|->
name|iJPEGbufremain2
operator|+=
name|iRemain
expr_stmt|;
name|iRemain
operator|=
literal|0
expr_stmt|;
comment|/* and indicate there's no input left */
block|}
else|else
block|{
comment|/* calculate what does fit */
name|mng_uint32
name|iFits
init|=
name|pData
operator|->
name|iJPEGbufmax2
operator|-
name|pData
operator|->
name|iJPEGbufremain2
decl_stmt|;
if|if
condition|(
name|iFits
operator|<=
literal|0
condition|)
comment|/* no space is just bugger 'm all */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_JPEGBUFTOOSMALL
argument_list|)
expr_stmt|;
comment|/* move that */
name|MNG_COPY
argument_list|(
operator|(
name|pData
operator|->
name|pJPEGcurrent2
operator|+
name|pData
operator|->
name|iJPEGbufremain2
operator|)
argument_list|,
name|pWork
argument_list|,
name|iFits
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain2
operator|+=
name|iFits
expr_stmt|;
comment|/* adjust remain_bytes counter */
name|iRemain
operator|-=
name|iFits
expr_stmt|;
comment|/* and the input-parms */
name|pWork
operator|+=
name|iFits
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_INCLUDE_IJG6B
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|next_input_byte
operator|=
name|pData
operator|->
name|pJPEGcurrent2
expr_stmt|;
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|bytes_in_buffer
operator|=
name|pData
operator|->
name|iJPEGbufremain2
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|bJPEGhasheader2
condition|)
comment|/* haven't got the header yet ? */
block|{
comment|/* call jpeg_read_header() to obtain image info */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_READ_HEADER
argument_list|)
endif|#
directive|endif
if|if
condition|(
name|jpeg_read_header
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|,
name|TRUE
argument_list|)
operator|!=
name|JPEG_SUSPENDED
condition|)
block|{
comment|/* indicate the header's oke */
name|pData
operator|->
name|bJPEGhasheader2
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* let's do some sanity checks ! */
if|if
condition|(
operator|(
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|image_width
operator|!=
name|pData
operator|->
name|iDatawidth
operator|)
operator|||
operator|(
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|image_height
operator|!=
name|pData
operator|->
name|iDataheight
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_JPEGPARMSERR
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|jpeg_color_space
operator|!=
name|JCS_GRAYSCALE
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_JPEGPARMSERR
argument_list|)
expr_stmt|;
comment|/* indicate whether or not it's progressive */
name|pData
operator|->
name|bJPEGprogressive2
operator|=
operator|(
name|mng_bool
operator|)
name|jpeg_has_multiple_scans
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bJPEGprogressive2
condition|)
comment|/* progressive alphachannel not allowed !!! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_JPEGPARMSERR
argument_list|)
expr_stmt|;
comment|/* allocate a row of JPEG-samples */
if|if
condition|(
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|jpeg_color_space
operator|==
name|JCS_YCbCr
condition|)
name|pData
operator|->
name|iJPEGrowlen2
operator|=
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|image_width
operator|*
name|RGB_PIXELSIZE
expr_stmt|;
else|else
name|pData
operator|->
name|iJPEGrowlen2
operator|=
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|image_width
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGrow2
argument_list|,
name|pData
operator|->
name|iJPEGrowlen2
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iJPEGalpharow
operator|=
literal|0
expr_stmt|;
comment|/* quite empty up to now */
block|}
name|pData
operator|->
name|pJPEGcurrent2
operator|=
operator|(
name|mng_uint8p
operator|)
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|next_input_byte
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain2
operator|=
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|bytes_in_buffer
expr_stmt|;
block|}
comment|/* decompress not started ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGhasheader2
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bJPEGdecostarted2
operator|)
condition|)
block|{
comment|/* set parameters for decompression */
if|if
condition|(
name|pData
operator|->
name|bJPEGprogressive2
condition|)
comment|/* progressive display ? */
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|buffered_image
operator|=
name|TRUE
expr_stmt|;
comment|/* jpeg_start_decompress(...); */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_START_DECOMPRESS
argument_list|)
endif|#
directive|endif
if|if
condition|(
name|jpeg_start_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
operator|==
name|TRUE
condition|)
comment|/* indicate it started */
name|pData
operator|->
name|bJPEGdecostarted2
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|pJPEGcurrent2
operator|=
operator|(
name|mng_uint8p
operator|)
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|next_input_byte
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain2
operator|=
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|bytes_in_buffer
expr_stmt|;
block|}
comment|/* process some scanlines ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGhasheader2
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bJPEGdecostarted2
operator|)
operator|&&
operator|(
operator|(
operator|!
name|jpeg_input_complete
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
operator|)
operator|||
operator|(
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|output_scanline
operator|<
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|output_height
operator|)
operator|)
condition|)
block|{
name|mng_int32
name|iLines
decl_stmt|;
comment|/* for (each output pass) */
do|do
block|{
comment|/* address the row output buffer */
name|JSAMPROW
name|pRow
init|=
operator|(
name|JSAMPROW
operator|)
name|pData
operator|->
name|pJPEGrow2
decl_stmt|;
comment|/* init new pass ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGprogressive2
operator|)
operator|&&
operator|(
operator|(
operator|!
name|pData
operator|->
name|bJPEGscanstarted2
operator|)
operator|||
operator|(
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|output_scanline
operator|>=
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|output_height
operator|)
operator|)
condition|)
block|{
name|pData
operator|->
name|bJPEGscanstarted2
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* adjust output decompression parameters if required */
comment|/* nop */
comment|/* start a new output pass */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_START_OUTPUT
argument_list|)
endif|#
directive|endif
name|jpeg_start_output
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|,
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|input_scan_number
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iJPEGrow
operator|=
literal|0
expr_stmt|;
comment|/* start at row 0 in the image again */
block|}
comment|/* while (scan lines remain to be read) */
do|do
block|{
comment|/*   jpeg_read_scanlines(...); */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_READ_SCANLINES
argument_list|)
endif|#
directive|endif
name|iLines
operator|=
name|jpeg_read_scanlines
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|,
operator|(
name|JSAMPARRAY
operator|)
operator|&
name|pRow
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pData
operator|->
name|pJPEGcurrent2
operator|=
operator|(
name|mng_uint8p
operator|)
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|next_input_byte
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain2
operator|=
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|bytes_in_buffer
expr_stmt|;
if|if
condition|(
name|iLines
operator|>
literal|0
condition|)
comment|/* got something ? */
block|{
if|if
condition|(
name|pData
operator|->
name|fStorerow3
condition|)
comment|/* store in object ? */
block|{
name|iRetcode
operator|=
operator|(
operator|(
name|mng_storerow
operator|)
name|pData
operator|->
name|fStorerow3
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
block|}
do|while
condition|(
operator|(
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|output_scanline
operator|<
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|output_height
operator|)
operator|&&
operator|(
name|iLines
operator|>
literal|0
operator|)
condition|)
do|;
comment|/* until end-of-image or not enough input-data */
comment|/* terminate output pass */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGprogressive2
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|output_scanline
operator|>=
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|output_height
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_FINISH_OUTPUT
argument_list|)
endif|#
directive|endif
if|if
condition|(
name|jpeg_finish_output
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
operator|==
name|JPEG_SUSPENDED
condition|)
name|jpeg_finish_output
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
expr_stmt|;
comment|/* this scan has ended */
name|pData
operator|->
name|bJPEGscanstarted2
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|(
operator|!
name|jpeg_input_complete
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
operator|)
operator|&&
operator|(
name|iLines
operator|>
literal|0
operator|)
condition|)
do|;
block|}
comment|/* end of image ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bJPEGhasheader2
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bJPEGdecostarted2
operator|)
operator|&&
operator|(
name|jpeg_input_complete
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|input_scan_number
operator|==
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|output_scan_number
operator|)
condition|)
block|{
comment|/* jpeg_finish_decompress(...); */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
argument|MNG_LC_JPEG_FINISH_DECOMPRESS
argument_list|)
endif|#
directive|endif
if|if
condition|(
name|jpeg_finish_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
operator|==
name|TRUE
condition|)
block|{
comment|/* indicate it's done */
name|pData
operator|->
name|bJPEGhasheader2
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bJPEGdecostarted2
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|pJPEGcurrent2
operator|=
operator|(
name|mng_uint8p
operator|)
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|next_input_byte
expr_stmt|;
name|pData
operator|->
name|iJPEGbufremain2
operator|=
operator|(
name|mng_uint32
operator|)
name|pData
operator|->
name|pJPEGdinfo2
operator|->
name|src
operator|->
name|bytes_in_buffer
expr_stmt|;
comment|/* remaining fluff is an error ! */
if|if
condition|(
operator|(
name|pData
operator|->
name|iJPEGbufremain2
operator|>
literal|0
operator|)
operator|||
operator|(
name|iRemain
operator|>
literal|0
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_TOOMUCHJDAT
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* MNG_INCLUDE_IJG6B */
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSDATA
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG_READ
end_ifdef
begin_function
DECL|function|mngjpeg_decompressfree2
name|mng_retcode
name|mngjpeg_decompressfree2
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_IJG6B
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_USE_SETJMP
argument_list|)
name|mng_retcode
name|iRetcode
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSFREE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_IJG6B
ifdef|#
directive|ifdef
name|MNG_USE_SETJMP
name|iRetcode
operator|=
name|setjmp
argument_list|(
name|pData
operator|->
name|sErrorbuf
argument_list|)
expr_stmt|;
comment|/* setup local JPEG error-recovery */
if|if
condition|(
name|iRetcode
operator|!=
literal|0
condition|)
comment|/* got here from longjmp ? */
name|MNG_ERRORJ
argument_list|(
name|pData
argument_list|,
name|iRetcode
argument_list|)
expr_stmt|;
comment|/* then IJG-lib issued an error */
endif|#
directive|endif
comment|/* free the row of JPEG-samples*/
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pJPEGrow2
argument_list|,
name|pData
operator|->
name|iJPEGrowlen2
argument_list|)
expr_stmt|;
comment|/* release the JPEG decompression object */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
argument|pData
argument_list|,
argument|MNG_FN_JPEG_DECOMPRESSFREE
argument_list|,
argument|MNG_LC_JPEG_DESTROY_DECOMPRESS
argument_list|)
endif|#
directive|endif
name|jpeg_destroy_decompress
argument_list|(
name|pData
operator|->
name|pJPEGdinfo2
argument_list|)
expr_stmt|;
name|pData
operator|->
name|bJPEGdecompress2
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* indicate it's done */
endif|#
directive|endif
comment|/* MNG_INCLUDE_IJG6B */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_JPEG_DECOMPRESSFREE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG_READ */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG&& MNG_INCLUDE_DISPLAY_PROCS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* * end of file                                                            * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
end_unit
