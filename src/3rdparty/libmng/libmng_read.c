begin_unit
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *             For conditions of distribution and use,                    * */
end_comment
begin_comment
comment|/* *                see copyright notice in libmng.h                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * project   : libmng                                                     * */
end_comment
begin_comment
comment|/* * file      : libmng_read.c             copyright (c) 2000-2007 G.Juyn   * */
end_comment
begin_comment
comment|/* * version   : 1.0.10                                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * purpose   : Read logic (implementation)                                * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * author    : G.Juyn                                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * comment   : implementation of the high-level read logic                * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * changes   : 0.5.1 - 05/08/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed strict-ANSI stuff                                * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/11/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added callback error-reporting support                   * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/12/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed trace to macro for callback error-reporting      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/19/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - cleaned up some code regarding mixed support             * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/20/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for JNG                                    * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/31/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed up punctuation (contribution by Tim Rowley)        * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed progressive-display processing                   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/08/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed read-processing for improved I/O-suspension      * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/14/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed EOF processing behavior                          * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/14/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed default readbuffer size from 1024 to 4200        * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.2 - 07/27/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B110320 - fixed GCC warning about mix-sized pointer math * */
end_comment
begin_comment
comment|/* *             0.9.2 - 07/31/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B110546 - fixed for improperly returning UNEXPECTEDEOF   * */
end_comment
begin_comment
comment|/* *             0.9.2 - 08/04/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B111096 - fixed large-buffer read-suspension             * */
end_comment
begin_comment
comment|/* *             0.9.2 - 08/05/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed file-prefixes                                    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/26/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added MAGN chunk                                         * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/11/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - removed test-MaGN                                        * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for JDAA                                   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.5 - 01/23/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed timing-problem with switching framing_modes        * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.4 - 06/22/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B495443 - incorrect suspend check in read_databuffer     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.5 - 07/04/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added errorcode for extreme chunk-sizes                  * */
end_comment
begin_comment
comment|/* *             1.0.5 - 07/08/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B578572 - removed eMNGma hack (thanks Dimitri!)          * */
end_comment
begin_comment
comment|/* *             1.0.5 - 07/16/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B581625 - large chunks fail with suspension reads        * */
end_comment
begin_comment
comment|/* *             1.0.5 - 08/19/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B597134 - libmng pollutes the linker namespace           * */
end_comment
begin_comment
comment|/* *             - added HLAPI function to copy chunks                      * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/16/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added event handling for dynamic MNG                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.6 - 05/25/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added MNG_SKIPCHUNK_cHNK footprint optimizations         * */
end_comment
begin_comment
comment|/* *             1.0.6 - 07/07/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added MNG_NO_DELTA_PNG reduction                         * */
end_comment
begin_comment
comment|/* *             - skip additional code when MNG_INCLUDE_JNG is not enabled * */
end_comment
begin_comment
comment|/* *             1.0.6 - 07/29/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added conditionals around PAST chunk support             * */
end_comment
begin_comment
comment|/* *             1.0.6 - 08/17/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added conditionals around non-VLC chunk support          * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.7 - 03/10/2004 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added conditionals around openstream/closestream         * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.8 - 04/08/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added CRC existence& checking flags                     * */
end_comment
begin_comment
comment|/* *             1.0.8 - 04/11/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added data-push mechanisms for specialized decoders      * */
end_comment
begin_comment
comment|/* *             1.0.8 - 07/06/2004 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - defend against using undefined closestream function      * */
end_comment
begin_comment
comment|/* *             1.0.8 - 07/28/2004 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added check for extreme chunk-lengths                    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.9 - 09/16/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed chunk pushing mechanism                            * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/05/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added conditional MNG_OPTIMIZE_CHUNKINITFREE             * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/06/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added conditional MNG_OPTIMIZE_CHUNKASSIGN               * */
end_comment
begin_comment
comment|/* *             - added conditional MNG_OPTIMIZE_CHUNKREADER               * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/20/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - cleaned up macro-invocations (thanks to D. Airlie)       * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/31/2004 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - removed stray characters from #ifdef directive           * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.10 - 04/08/2007 - G.Juyn                               * */
end_comment
begin_comment
comment|/* *             - added support for mPNG proposal                          * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_include
include|#
directive|include
file|"libmng.h"
end_include
begin_include
include|#
directive|include
file|"libmng_data.h"
end_include
begin_include
include|#
directive|include
file|"libmng_error.h"
end_include
begin_include
include|#
directive|include
file|"libmng_trace.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|__BORLANDC__
end_ifdef
begin_pragma
pragma|#
directive|pragma
name|hdrstop
end_pragma
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"libmng_memory.h"
end_include
begin_include
include|#
directive|include
file|"libmng_objects.h"
end_include
begin_include
include|#
directive|include
file|"libmng_object_prc.h"
end_include
begin_include
include|#
directive|include
file|"libmng_chunks.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_CHUNKREADER
end_ifdef
begin_include
include|#
directive|include
file|"libmng_chunk_descr.h"
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"libmng_chunk_prc.h"
end_include
begin_include
include|#
directive|include
file|"libmng_chunk_io.h"
end_include
begin_include
include|#
directive|include
file|"libmng_display.h"
end_include
begin_include
include|#
directive|include
file|"libmng_read.h"
end_include
begin_if
if|#
directive|if
name|defined
argument_list|(
name|__BORLANDC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_STRICT_ANSI
argument_list|)
end_if
begin_pragma
pragma|#
directive|pragma
name|option
name|-
name|A
end_pragma
begin_comment
comment|/* force ANSI-C */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_READ_PROCS
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_process_eof
name|mng_retcode
name|mng_process_eof
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|bEOF
condition|)
comment|/* haven't closed the stream yet ? */
block|{
name|pData
operator|->
name|bEOF
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* now we do! */
ifndef|#
directive|ifndef
name|MNG_NO_OPEN_CLOSE_STREAM
if|if
condition|(
name|pData
operator|->
name|fClosestream
operator|&&
operator|!
name|pData
operator|->
name|fClosestream
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|)
condition|)
block|{
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_release_pushdata
name|mng_retcode
name|mng_release_pushdata
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_pushdatap
name|pFirst
init|=
name|pData
operator|->
name|pFirstpushdata
decl_stmt|;
name|mng_pushdatap
name|pNext
init|=
name|pFirst
operator|->
name|pNext
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_RELEASE_PUSHDATA
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|pFirstpushdata
operator|=
name|pNext
expr_stmt|;
comment|/* next becomes the first */
if|if
condition|(
operator|!
name|pNext
condition|)
comment|/* no next? => no last! */
name|pData
operator|->
name|pLastpushdata
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* buffer owned and release callback defined? */
if|if
condition|(
operator|(
name|pFirst
operator|->
name|bOwned
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fReleasedata
operator|)
condition|)
name|pData
operator|->
name|fReleasedata
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pFirst
operator|->
name|pData
argument_list|,
name|pFirst
operator|->
name|iLength
argument_list|)
expr_stmt|;
else|else
comment|/* otherwise use internal free mechanism */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pFirst
operator|->
name|pData
argument_list|,
name|pFirst
operator|->
name|iLength
argument_list|)
expr_stmt|;
comment|/* and free it */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pFirst
argument_list|,
sizeof|sizeof
argument_list|(
name|mng_pushdata
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_RELEASE_PUSHDATA
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_release_pushchunk
name|mng_retcode
name|mng_release_pushchunk
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_pushdatap
name|pFirst
init|=
name|pData
operator|->
name|pFirstpushchunk
decl_stmt|;
name|mng_pushdatap
name|pNext
init|=
name|pFirst
operator|->
name|pNext
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_RELEASE_PUSHCHUNK
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|pFirstpushchunk
operator|=
name|pNext
expr_stmt|;
comment|/* next becomes the first */
if|if
condition|(
operator|!
name|pNext
condition|)
comment|/* no next? => no last! */
name|pData
operator|->
name|pLastpushchunk
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* buffer owned and release callback defined? */
if|if
condition|(
operator|(
name|pFirst
operator|->
name|bOwned
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fReleasedata
operator|)
condition|)
name|pData
operator|->
name|fReleasedata
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pFirst
operator|->
name|pData
argument_list|,
name|pFirst
operator|->
name|iLength
argument_list|)
expr_stmt|;
else|else
comment|/* otherwise use internal free mechanism */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pFirst
operator|->
name|pData
argument_list|,
name|pFirst
operator|->
name|iLength
argument_list|)
expr_stmt|;
comment|/* and free it */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pFirst
argument_list|,
sizeof|sizeof
argument_list|(
name|mng_pushdata
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_RELEASE_PUSHCHUNK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|read_data
name|MNG_LOCAL
name|mng_retcode
name|read_data
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint8p
name|pBuf
parameter_list|,
name|mng_uint32
name|iSize
parameter_list|,
name|mng_uint32
modifier|*
name|iRead
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_uint32
name|iTempsize
init|=
name|iSize
decl_stmt|;
name|mng_uint8p
name|pTempbuf
init|=
name|pBuf
decl_stmt|;
name|mng_pushdatap
name|pPush
init|=
name|pData
operator|->
name|pFirstpushdata
decl_stmt|;
name|mng_uint32
name|iPushsize
init|=
literal|0
decl_stmt|;
operator|*
name|iRead
operator|=
literal|0
expr_stmt|;
comment|/* nothing yet */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DATA
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
name|pPush
condition|)
comment|/* calculate size of pushed data */
block|{
name|iPushsize
operator|+=
name|pPush
operator|->
name|iRemaining
expr_stmt|;
name|pPush
operator|=
name|pPush
operator|->
name|pNext
expr_stmt|;
block|}
if|if
condition|(
name|iTempsize
operator|<=
name|iPushsize
condition|)
comment|/* got enough push data? */
block|{
while|while
condition|(
name|iTempsize
condition|)
block|{
name|pPush
operator|=
name|pData
operator|->
name|pFirstpushdata
expr_stmt|;
comment|/* enough data remaining in this buffer? */
if|if
condition|(
name|pPush
operator|->
name|iRemaining
operator|<=
name|iTempsize
condition|)
block|{
comment|/* no: then copy what we've got */
name|MNG_COPY
argument_list|(
name|pTempbuf
argument_list|,
name|pPush
operator|->
name|pDatanext
argument_list|,
name|pPush
operator|->
name|iRemaining
argument_list|)
expr_stmt|;
comment|/* move pointers& lengths */
name|pTempbuf
operator|+=
name|pPush
operator|->
name|iRemaining
expr_stmt|;
operator|*
name|iRead
operator|+=
name|pPush
operator|->
name|iRemaining
expr_stmt|;
name|iTempsize
operator|-=
name|pPush
operator|->
name|iRemaining
expr_stmt|;
comment|/* release the depleted buffer */
name|iRetcode
operator|=
name|mng_release_pushdata
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
block|}
else|else
block|{
comment|/* copy the needed bytes */
name|MNG_COPY
argument_list|(
name|pTempbuf
argument_list|,
name|pPush
operator|->
name|pDatanext
argument_list|,
name|iTempsize
argument_list|)
expr_stmt|;
comment|/* move pointers& lengths */
name|pPush
operator|->
name|iRemaining
operator|-=
name|iTempsize
expr_stmt|;
name|pPush
operator|->
name|pDatanext
operator|+=
name|iTempsize
expr_stmt|;
name|pTempbuf
operator|+=
name|iTempsize
expr_stmt|;
operator|*
name|iRead
operator|+=
name|iTempsize
expr_stmt|;
name|iTempsize
operator|=
literal|0
expr_stmt|;
comment|/* all done!!! */
block|}
block|}
block|}
else|else
block|{
name|mng_uint32
name|iTempread
init|=
literal|0
decl_stmt|;
comment|/* get it from the app then */
if|if
condition|(
operator|!
name|pData
operator|->
name|fReaddata
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|pTempbuf
argument_list|,
name|iTempsize
argument_list|,
operator|&
name|iTempread
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPIOERROR
argument_list|)
expr_stmt|;
operator|*
name|iRead
operator|+=
name|iTempread
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DATA
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|read_databuffer
name|MNG_LOCAL
name|mng_retcode
name|read_databuffer
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint8p
name|pBuf
parameter_list|,
name|mng_uint8p
modifier|*
name|pBufnext
parameter_list|,
name|mng_uint32
name|iSize
parameter_list|,
name|mng_uint32
modifier|*
name|iRead
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DATABUFFER
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|bSuspensionmode
condition|)
block|{
name|mng_uint8p
name|pTemp
decl_stmt|;
name|mng_uint32
name|iTemp
decl_stmt|;
operator|*
name|iRead
operator|=
literal|0
expr_stmt|;
comment|/* let's be negative about the outcome */
if|if
condition|(
operator|!
name|pData
operator|->
name|pSuspendbuf
condition|)
comment|/* need to create a suspension buffer ? */
block|{
name|pData
operator|->
name|iSuspendbufsize
operator|=
name|MNG_SUSPENDBUFFERSIZE
expr_stmt|;
comment|/* so, create it */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pSuspendbuf
argument_list|,
name|pData
operator|->
name|iSuspendbufsize
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iSuspendbufleft
operator|=
literal|0
expr_stmt|;
comment|/* make sure to fill it first time */
name|pData
operator|->
name|pSuspendbufnext
operator|=
name|pData
operator|->
name|pSuspendbuf
expr_stmt|;
block|}
comment|/* more than our buffer can hold ? */
if|if
condition|(
name|iSize
operator|>
name|pData
operator|->
name|iSuspendbufsize
condition|)
block|{
name|mng_uint32
name|iRemain
decl_stmt|;
if|if
condition|(
operator|!
operator|*
name|pBufnext
condition|)
comment|/* first time ? */
block|{
if|if
condition|(
name|pData
operator|->
name|iSuspendbufleft
condition|)
comment|/* do we have some data left ? */
block|{
comment|/* then copy it */
name|MNG_COPY
argument_list|(
name|pBuf
argument_list|,
name|pData
operator|->
name|pSuspendbufnext
argument_list|,
name|pData
operator|->
name|iSuspendbufleft
argument_list|)
expr_stmt|;
comment|/* fixup variables */
operator|*
name|pBufnext
operator|=
name|pBuf
operator|+
name|pData
operator|->
name|iSuspendbufleft
expr_stmt|;
name|pData
operator|->
name|pSuspendbufnext
operator|=
name|pData
operator|->
name|pSuspendbuf
expr_stmt|;
name|pData
operator|->
name|iSuspendbufleft
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pBufnext
operator|=
name|pBuf
expr_stmt|;
block|}
block|}
comment|/* calculate how much to get */
name|iRemain
operator|=
name|iSize
operator|-
call|(
name|mng_uint32
call|)
argument_list|(
operator|*
name|pBufnext
operator|-
name|pBuf
argument_list|)
expr_stmt|;
comment|/* let's go get it */
name|iRetcode
operator|=
name|read_data
argument_list|(
name|pData
argument_list|,
operator|*
name|pBufnext
argument_list|,
name|iRemain
argument_list|,
operator|&
name|iTemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
comment|/* first read after suspension return 0 means EOF */
if|if
condition|(
operator|(
name|pData
operator|->
name|iSuspendpoint
operator|)
operator|&&
operator|(
name|iTemp
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* that makes it final */
name|mng_retcode
name|iRetcode
init|=
name|mng_process_eof
argument_list|(
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* indicate the source is depleted */
operator|*
name|iRead
operator|=
name|iSize
operator|-
name|iRemain
operator|+
name|iTemp
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|iTemp
operator|<
name|iRemain
condition|)
comment|/* suspension required ? */
block|{
operator|*
name|pBufnext
operator|=
operator|*
name|pBufnext
operator|+
name|iTemp
expr_stmt|;
name|pData
operator|->
name|bSuspended
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
else|else
block|{
operator|*
name|iRead
operator|=
name|iSize
expr_stmt|;
comment|/* got it all now ! */
block|}
block|}
block|}
else|else
block|{
comment|/* need to read some more ? */
while|while
condition|(
operator|(
operator|!
name|pData
operator|->
name|bSuspended
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bEOF
operator|)
operator|&&
operator|(
name|iSize
operator|>
name|pData
operator|->
name|iSuspendbufleft
operator|)
condition|)
block|{
comment|/* not enough space left in buffer ? */
if|if
condition|(
name|pData
operator|->
name|iSuspendbufsize
operator|-
name|pData
operator|->
name|iSuspendbufleft
operator|-
call|(
name|mng_uint32
call|)
argument_list|(
name|pData
operator|->
name|pSuspendbufnext
operator|-
name|pData
operator|->
name|pSuspendbuf
argument_list|)
operator|<
name|MNG_SUSPENDREQUESTSIZE
condition|)
block|{
if|if
condition|(
name|pData
operator|->
name|iSuspendbufleft
condition|)
comment|/* then lets shift (if there's anything left) */
name|MNG_COPY
argument_list|(
name|pData
operator|->
name|pSuspendbuf
argument_list|,
name|pData
operator|->
name|pSuspendbufnext
argument_list|,
name|pData
operator|->
name|iSuspendbufleft
argument_list|)
expr_stmt|;
comment|/* adjust running pointer */
name|pData
operator|->
name|pSuspendbufnext
operator|=
name|pData
operator|->
name|pSuspendbuf
expr_stmt|;
block|}
comment|/* still not enough room ? */
if|if
condition|(
name|pData
operator|->
name|iSuspendbufsize
operator|-
name|pData
operator|->
name|iSuspendbufleft
operator|<
name|MNG_SUSPENDREQUESTSIZE
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INTERNALERROR
argument_list|)
expr_stmt|;
comment|/* now read some more data */
name|pTemp
operator|=
name|pData
operator|->
name|pSuspendbufnext
operator|+
name|pData
operator|->
name|iSuspendbufleft
expr_stmt|;
name|iRetcode
operator|=
name|read_data
argument_list|(
name|pData
argument_list|,
name|pTemp
argument_list|,
name|MNG_SUSPENDREQUESTSIZE
argument_list|,
operator|&
name|iTemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
comment|/* adjust fill-counter */
name|pData
operator|->
name|iSuspendbufleft
operator|+=
name|iTemp
expr_stmt|;
comment|/* first read after suspension returning 0 means EOF */
if|if
condition|(
operator|(
name|pData
operator|->
name|iSuspendpoint
operator|)
operator|&&
operator|(
name|iTemp
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* that makes it final */
name|mng_retcode
name|iRetcode
init|=
name|mng_process_eof
argument_list|(
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
name|pData
operator|->
name|iSuspendbufleft
condition|)
comment|/* return the leftover scraps */
name|MNG_COPY
argument_list|(
name|pBuf
argument_list|,
name|pData
operator|->
name|pSuspendbufnext
argument_list|,
name|pData
operator|->
name|iSuspendbufleft
argument_list|)
expr_stmt|;
comment|/* and indicate so */
operator|*
name|iRead
operator|=
name|pData
operator|->
name|iSuspendbufleft
expr_stmt|;
name|pData
operator|->
name|pSuspendbufnext
operator|=
name|pData
operator|->
name|pSuspendbuf
expr_stmt|;
name|pData
operator|->
name|iSuspendbufleft
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* suspension required ? */
if|if
condition|(
operator|(
name|iSize
operator|>
name|pData
operator|->
name|iSuspendbufleft
operator|)
operator|&&
operator|(
name|iTemp
operator|<
name|MNG_SUSPENDREQUESTSIZE
operator|)
condition|)
name|pData
operator|->
name|bSuspended
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
name|pData
operator|->
name|iSuspendpoint
operator|=
literal|0
expr_stmt|;
comment|/* reset it here in case we loop back */
block|}
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bSuspended
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bEOF
operator|)
condition|)
block|{
comment|/* return the data ! */
name|MNG_COPY
argument_list|(
name|pBuf
argument_list|,
name|pData
operator|->
name|pSuspendbufnext
argument_list|,
name|iSize
argument_list|)
expr_stmt|;
operator|*
name|iRead
operator|=
name|iSize
expr_stmt|;
comment|/* returned it all */
comment|/* adjust suspension-buffer variables */
name|pData
operator|->
name|pSuspendbufnext
operator|+=
name|iSize
expr_stmt|;
name|pData
operator|->
name|iSuspendbufleft
operator|-=
name|iSize
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|iRetcode
operator|=
name|read_data
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_ptr
operator|)
name|pBuf
argument_list|,
name|iSize
argument_list|,
name|iRead
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
if|if
condition|(
operator|*
name|iRead
operator|==
literal|0
condition|)
comment|/* suspension required ? */
name|pData
operator|->
name|bSuspended
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
name|pData
operator|->
name|iSuspendpoint
operator|=
literal|0
expr_stmt|;
comment|/* safely reset it here ! */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_DATABUFFER
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|process_raw_chunk
name|MNG_LOCAL
name|mng_retcode
name|process_raw_chunk
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint8p
name|pBuf
parameter_list|,
name|mng_uint32
name|iBuflen
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
comment|/* the table-idea& binary search code was adapted from      libpng 1.1.0 (pngread.c) */
comment|/* NOTE1: the table must remain sorted by chunkname, otherwise the binary      search will break !!! (ps. watch upper-/lower-case chunknames !!) */
comment|/* NOTE2: the layout must remain equal to the header part of all the      chunk-structures (yes, that means even the pNext and pPrev fields;      it's wasting a bit of space, but hey, the code is a lot easier) */
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_CHUNKINITFREE
name|mng_chunk_header
name|mng_chunk_unknown
init|=
block|{
name|MNG_UINT_HUH
block|,
name|mng_init_general
block|,
name|mng_free_unknown
block|,
name|mng_read_unknown
block|,
name|mng_write_unknown
block|,
name|mng_assign_unknown
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_unknown_chunk
operator|)
block|}
decl_stmt|;
else|#
directive|else
name|mng_chunk_header
name|mng_chunk_unknown
init|=
block|{
name|MNG_UINT_HUH
block|,
name|mng_init_unknown
block|,
name|mng_free_unknown
block|,
name|mng_read_unknown
block|,
name|mng_write_unknown
block|,
name|mng_assign_unknown
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_CHUNKINITFREE
name|mng_chunk_header
name|mng_chunk_table
index|[]
init|=
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BACK
block|{
name|MNG_UINT_BACK
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_back
block|,
name|mng_write_back
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_back
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BASI
block|{
name|MNG_UINT_BASI
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_basi
block|,
name|mng_write_basi
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_basi
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLIP
block|{
name|MNG_UINT_CLIP
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_clip
block|,
name|mng_write_clip
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_clip
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLON
block|{
name|MNG_UINT_CLON
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_clon
block|,
name|mng_write_clon
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_clon
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DBYK
block|{
name|MNG_UINT_DBYK
block|,
name|mng_init_general
block|,
name|mng_free_dbyk
block|,
name|mng_read_dbyk
block|,
name|mng_write_dbyk
block|,
name|mng_assign_dbyk
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_dbyk
operator|)
block|}
block|,
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DEFI
block|{
name|MNG_UINT_DEFI
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_defi
block|,
name|mng_write_defi
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_defi
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
block|{
name|MNG_UINT_DHDR
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_dhdr
block|,
name|mng_write_dhdr
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_dhdr
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DISC
block|{
name|MNG_UINT_DISC
block|,
name|mng_init_general
block|,
name|mng_free_disc
block|,
name|mng_read_disc
block|,
name|mng_write_disc
block|,
name|mng_assign_disc
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_disc
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DROP
block|{
name|MNG_UINT_DROP
block|,
name|mng_init_general
block|,
name|mng_free_drop
block|,
name|mng_read_drop
block|,
name|mng_write_drop
block|,
name|mng_assign_drop
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_drop
operator|)
block|}
block|,
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_LOOP
block|{
name|MNG_UINT_ENDL
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_endl
block|,
name|mng_write_endl
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_endl
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
block|{
name|MNG_UINT_FRAM
block|,
name|mng_init_general
block|,
name|mng_free_fram
block|,
name|mng_read_fram
block|,
name|mng_write_fram
block|,
name|mng_assign_fram
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_fram
operator|)
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_IDAT
block|,
name|mng_init_general
block|,
name|mng_free_idat
block|,
name|mng_read_idat
block|,
name|mng_write_idat
block|,
name|mng_assign_idat
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_idat
operator|)
block|}
block|,
comment|/* 12-th element! */
block|{
name|MNG_UINT_IEND
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_iend
block|,
name|mng_write_iend
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_iend
operator|)
block|}
block|,
block|{
name|MNG_UINT_IHDR
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_ihdr
block|,
name|mng_write_ihdr
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_ihdr
operator|)
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
block|{
name|MNG_UINT_IJNG
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_ijng
block|,
name|mng_write_ijng
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_ijng
operator|)
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_IPNG
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_ipng
block|,
name|mng_write_ipng
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_ipng
operator|)
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
block|{
name|MNG_UINT_JDAA
block|,
name|mng_init_general
block|,
name|mng_free_jdaa
block|,
name|mng_read_jdaa
block|,
name|mng_write_jdaa
block|,
name|mng_assign_jdaa
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_jdaa
operator|)
block|}
block|,
block|{
name|MNG_UINT_JDAT
block|,
name|mng_init_general
block|,
name|mng_free_jdat
block|,
name|mng_read_jdat
block|,
name|mng_write_jdat
block|,
name|mng_assign_jdat
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_jdat
operator|)
block|}
block|,
block|{
name|MNG_UINT_JHDR
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_jhdr
block|,
name|mng_write_jhdr
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_jhdr
operator|)
block|}
block|,
block|{
name|MNG_UINT_JSEP
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_jsep
block|,
name|mng_write_jsep
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_jsep
operator|)
block|}
block|,
block|{
name|MNG_UINT_JdAA
block|,
name|mng_init_general
block|,
name|mng_free_jdaa
block|,
name|mng_read_jdaa
block|,
name|mng_write_jdaa
block|,
name|mng_assign_jdaa
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_jdaa
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_LOOP
block|{
name|MNG_UINT_LOOP
block|,
name|mng_init_general
block|,
name|mng_free_loop
block|,
name|mng_read_loop
block|,
name|mng_write_loop
block|,
name|mng_assign_loop
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_loop
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
block|{
name|MNG_UINT_MAGN
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_magn
block|,
name|mng_write_magn
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_magn
operator|)
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_MEND
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_mend
block|,
name|mng_write_mend
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_mend
operator|)
block|}
block|,
block|{
name|MNG_UINT_MHDR
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_mhdr
block|,
name|mng_write_mhdr
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_mhdr
operator|)
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MOVE
block|{
name|MNG_UINT_MOVE
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_move
block|,
name|mng_write_move
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_move
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_ORDR
block|{
name|MNG_UINT_ORDR
block|,
name|mng_init_general
block|,
name|mng_free_ordr
block|,
name|mng_read_ordr
block|,
name|mng_write_ordr
block|,
name|mng_assign_ordr
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_ordr
operator|)
block|}
block|,
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_PAST
block|{
name|MNG_UINT_PAST
block|,
name|mng_init_general
block|,
name|mng_free_past
block|,
name|mng_read_past
block|,
name|mng_write_past
block|,
name|mng_assign_past
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_past
operator|)
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_PLTE
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_plte
block|,
name|mng_write_plte
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_plte
operator|)
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
block|{
name|MNG_UINT_PPLT
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_pplt
block|,
name|mng_write_pplt
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_pplt
operator|)
block|}
block|,
block|{
name|MNG_UINT_PROM
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_prom
block|,
name|mng_write_prom
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_prom
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SAVE
block|{
name|MNG_UINT_SAVE
block|,
name|mng_init_general
block|,
name|mng_free_save
block|,
name|mng_read_save
block|,
name|mng_write_save
block|,
name|mng_assign_save
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_save
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SEEK
block|{
name|MNG_UINT_SEEK
block|,
name|mng_init_general
block|,
name|mng_free_seek
block|,
name|mng_read_seek
block|,
name|mng_write_seek
block|,
name|mng_assign_seek
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_seek
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SHOW
block|{
name|MNG_UINT_SHOW
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_show
block|,
name|mng_write_show
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_show
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_TERM
block|{
name|MNG_UINT_TERM
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_term
block|,
name|mng_write_term
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_term
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_bKGD
block|{
name|MNG_UINT_bKGD
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_bkgd
block|,
name|mng_write_bkgd
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_bkgd
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
block|{
name|MNG_UINT_cHRM
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_chrm
block|,
name|mng_write_chrm
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_chrm
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_eXPI
block|{
name|MNG_UINT_eXPI
block|,
name|mng_init_general
block|,
name|mng_free_expi
block|,
name|mng_read_expi
block|,
name|mng_write_expi
block|,
name|mng_assign_expi
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_expi
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_evNT
block|{
name|MNG_UINT_evNT
block|,
name|mng_init_general
block|,
name|mng_free_evnt
block|,
name|mng_read_evnt
block|,
name|mng_write_evnt
block|,
name|mng_assign_evnt
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_evnt
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_fPRI
block|{
name|MNG_UINT_fPRI
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_fpri
block|,
name|mng_write_fpri
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_fpri
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_gAMA
block|{
name|MNG_UINT_gAMA
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_gama
block|,
name|mng_write_gama
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_gama
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_hIST
block|{
name|MNG_UINT_hIST
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_hist
block|,
name|mng_write_hist
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_hist
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
block|{
name|MNG_UINT_iCCP
block|,
name|mng_init_general
block|,
name|mng_free_iccp
block|,
name|mng_read_iccp
block|,
name|mng_write_iccp
block|,
name|mng_assign_iccp
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_iccp
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iTXt
block|{
name|MNG_UINT_iTXt
block|,
name|mng_init_general
block|,
name|mng_free_itxt
block|,
name|mng_read_itxt
block|,
name|mng_write_itxt
block|,
name|mng_assign_itxt
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_itxt
operator|)
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_MPNG_PROPOSAL
block|{
name|MNG_UINT_mpNG
block|,
name|mng_init_general
block|,
name|mng_free_mpng
block|,
name|mng_read_mpng
block|,
name|mng_write_mpng
block|,
name|mng_assign_mpng
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_mpng
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_nEED
block|{
name|MNG_UINT_nEED
block|,
name|mng_init_general
block|,
name|mng_free_need
block|,
name|mng_read_need
block|,
name|mng_write_need
block|,
name|mng_assign_need
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_need
operator|)
block|}
block|,
endif|#
directive|endif
comment|/* TODO:     {MNG_UINT_oFFs, 0, 0, 0, 0, 0, 0},  */
comment|/* TODO:     {MNG_UINT_pCAL, 0, 0, 0, 0, 0, 0},  */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_pHYg
block|{
name|MNG_UINT_pHYg
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_phyg
block|,
name|mng_write_phyg
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_phyg
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_pHYs
block|{
name|MNG_UINT_pHYs
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_phys
block|,
name|mng_write_phys
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_phys
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sBIT
block|{
name|MNG_UINT_sBIT
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_sbit
block|,
name|mng_write_sbit
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_sbit
operator|)
block|}
block|,
endif|#
directive|endif
comment|/* TODO:     {MNG_UINT_sCAL, 0, 0, 0, 0, 0, 0},  */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sPLT
block|{
name|MNG_UINT_sPLT
block|,
name|mng_init_general
block|,
name|mng_free_splt
block|,
name|mng_read_splt
block|,
name|mng_write_splt
block|,
name|mng_assign_splt
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_splt
operator|)
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_sRGB
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_srgb
block|,
name|mng_write_srgb
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_srgb
operator|)
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_tEXt
block|{
name|MNG_UINT_tEXt
block|,
name|mng_init_general
block|,
name|mng_free_text
block|,
name|mng_read_text
block|,
name|mng_write_text
block|,
name|mng_assign_text
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_text
operator|)
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_tIME
block|{
name|MNG_UINT_tIME
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_time
block|,
name|mng_write_time
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_time
operator|)
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_tRNS
block|,
name|mng_init_general
block|,
name|mng_free_general
block|,
name|mng_read_trns
block|,
name|mng_write_trns
block|,
name|mng_assign_general
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_trns
operator|)
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_zTXt
block|{
name|MNG_UINT_zTXt
block|,
name|mng_init_general
block|,
name|mng_free_ztxt
block|,
name|mng_read_ztxt
block|,
name|mng_write_ztxt
block|,
name|mng_assign_ztxt
block|,
literal|0
block|,
literal|0
block|,
expr|sizeof
operator|(
name|mng_ztxt
operator|)
block|}
block|,
endif|#
directive|endif
block|}
decl_stmt|;
else|#
directive|else
comment|/* MNG_OPTIMIZE_CHUNKINITFREE */
name|mng_chunk_header
name|mng_chunk_table
index|[]
init|=
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BACK
block|{
name|MNG_UINT_BACK
block|,
name|mng_init_back
block|,
name|mng_free_back
block|,
name|mng_read_back
block|,
name|mng_write_back
block|,
name|mng_assign_back
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BASI
block|{
name|MNG_UINT_BASI
block|,
name|mng_init_basi
block|,
name|mng_free_basi
block|,
name|mng_read_basi
block|,
name|mng_write_basi
block|,
name|mng_assign_basi
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLIP
block|{
name|MNG_UINT_CLIP
block|,
name|mng_init_clip
block|,
name|mng_free_clip
block|,
name|mng_read_clip
block|,
name|mng_write_clip
block|,
name|mng_assign_clip
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLON
block|{
name|MNG_UINT_CLON
block|,
name|mng_init_clon
block|,
name|mng_free_clon
block|,
name|mng_read_clon
block|,
name|mng_write_clon
block|,
name|mng_assign_clon
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DBYK
block|{
name|MNG_UINT_DBYK
block|,
name|mng_init_dbyk
block|,
name|mng_free_dbyk
block|,
name|mng_read_dbyk
block|,
name|mng_write_dbyk
block|,
name|mng_assign_dbyk
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DEFI
block|{
name|MNG_UINT_DEFI
block|,
name|mng_init_defi
block|,
name|mng_free_defi
block|,
name|mng_read_defi
block|,
name|mng_write_defi
block|,
name|mng_assign_defi
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
block|{
name|MNG_UINT_DHDR
block|,
name|mng_init_dhdr
block|,
name|mng_free_dhdr
block|,
name|mng_read_dhdr
block|,
name|mng_write_dhdr
block|,
name|mng_assign_dhdr
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DISC
block|{
name|MNG_UINT_DISC
block|,
name|mng_init_disc
block|,
name|mng_free_disc
block|,
name|mng_read_disc
block|,
name|mng_write_disc
block|,
name|mng_assign_disc
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DROP
block|{
name|MNG_UINT_DROP
block|,
name|mng_init_drop
block|,
name|mng_free_drop
block|,
name|mng_read_drop
block|,
name|mng_write_drop
block|,
name|mng_assign_drop
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_LOOP
block|{
name|MNG_UINT_ENDL
block|,
name|mng_init_endl
block|,
name|mng_free_endl
block|,
name|mng_read_endl
block|,
name|mng_write_endl
block|,
name|mng_assign_endl
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
block|{
name|MNG_UINT_FRAM
block|,
name|mng_init_fram
block|,
name|mng_free_fram
block|,
name|mng_read_fram
block|,
name|mng_write_fram
block|,
name|mng_assign_fram
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_IDAT
block|,
name|mng_init_idat
block|,
name|mng_free_idat
block|,
name|mng_read_idat
block|,
name|mng_write_idat
block|,
name|mng_assign_idat
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 12-th element! */
block|{
name|MNG_UINT_IEND
block|,
name|mng_init_iend
block|,
name|mng_free_iend
block|,
name|mng_read_iend
block|,
name|mng_write_iend
block|,
name|mng_assign_iend
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|MNG_UINT_IHDR
block|,
name|mng_init_ihdr
block|,
name|mng_free_ihdr
block|,
name|mng_read_ihdr
block|,
name|mng_write_ihdr
block|,
name|mng_assign_ihdr
block|,
literal|0
block|,
literal|0
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
block|{
name|MNG_UINT_IJNG
block|,
name|mng_init_ijng
block|,
name|mng_free_ijng
block|,
name|mng_read_ijng
block|,
name|mng_write_ijng
block|,
name|mng_assign_ijng
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_IPNG
block|,
name|mng_init_ipng
block|,
name|mng_free_ipng
block|,
name|mng_read_ipng
block|,
name|mng_write_ipng
block|,
name|mng_assign_ipng
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
block|{
name|MNG_UINT_JDAA
block|,
name|mng_init_jdaa
block|,
name|mng_free_jdaa
block|,
name|mng_read_jdaa
block|,
name|mng_write_jdaa
block|,
name|mng_assign_jdaa
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|MNG_UINT_JDAT
block|,
name|mng_init_jdat
block|,
name|mng_free_jdat
block|,
name|mng_read_jdat
block|,
name|mng_write_jdat
block|,
name|mng_assign_jdat
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|MNG_UINT_JHDR
block|,
name|mng_init_jhdr
block|,
name|mng_free_jhdr
block|,
name|mng_read_jhdr
block|,
name|mng_write_jhdr
block|,
name|mng_assign_jhdr
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|MNG_UINT_JSEP
block|,
name|mng_init_jsep
block|,
name|mng_free_jsep
block|,
name|mng_read_jsep
block|,
name|mng_write_jsep
block|,
name|mng_assign_jsep
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|MNG_UINT_JdAA
block|,
name|mng_init_jdaa
block|,
name|mng_free_jdaa
block|,
name|mng_read_jdaa
block|,
name|mng_write_jdaa
block|,
name|mng_assign_jdaa
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_LOOP
block|{
name|MNG_UINT_LOOP
block|,
name|mng_init_loop
block|,
name|mng_free_loop
block|,
name|mng_read_loop
block|,
name|mng_write_loop
block|,
name|mng_assign_loop
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
block|{
name|MNG_UINT_MAGN
block|,
name|mng_init_magn
block|,
name|mng_free_magn
block|,
name|mng_read_magn
block|,
name|mng_write_magn
block|,
name|mng_assign_magn
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_MEND
block|,
name|mng_init_mend
block|,
name|mng_free_mend
block|,
name|mng_read_mend
block|,
name|mng_write_mend
block|,
name|mng_assign_mend
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|MNG_UINT_MHDR
block|,
name|mng_init_mhdr
block|,
name|mng_free_mhdr
block|,
name|mng_read_mhdr
block|,
name|mng_write_mhdr
block|,
name|mng_assign_mhdr
block|,
literal|0
block|,
literal|0
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MOVE
block|{
name|MNG_UINT_MOVE
block|,
name|mng_init_move
block|,
name|mng_free_move
block|,
name|mng_read_move
block|,
name|mng_write_move
block|,
name|mng_assign_move
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_ORDR
block|{
name|MNG_UINT_ORDR
block|,
name|mng_init_ordr
block|,
name|mng_free_ordr
block|,
name|mng_read_ordr
block|,
name|mng_write_ordr
block|,
name|mng_assign_ordr
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_PAST
block|{
name|MNG_UINT_PAST
block|,
name|mng_init_past
block|,
name|mng_free_past
block|,
name|mng_read_past
block|,
name|mng_write_past
block|,
name|mng_assign_past
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_PLTE
block|,
name|mng_init_plte
block|,
name|mng_free_plte
block|,
name|mng_read_plte
block|,
name|mng_write_plte
block|,
name|mng_assign_plte
block|,
literal|0
block|,
literal|0
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
block|{
name|MNG_UINT_PPLT
block|,
name|mng_init_pplt
block|,
name|mng_free_pplt
block|,
name|mng_read_pplt
block|,
name|mng_write_pplt
block|,
name|mng_assign_pplt
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|MNG_UINT_PROM
block|,
name|mng_init_prom
block|,
name|mng_free_prom
block|,
name|mng_read_prom
block|,
name|mng_write_prom
block|,
name|mng_assign_prom
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SAVE
block|{
name|MNG_UINT_SAVE
block|,
name|mng_init_save
block|,
name|mng_free_save
block|,
name|mng_read_save
block|,
name|mng_write_save
block|,
name|mng_assign_save
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SEEK
block|{
name|MNG_UINT_SEEK
block|,
name|mng_init_seek
block|,
name|mng_free_seek
block|,
name|mng_read_seek
block|,
name|mng_write_seek
block|,
name|mng_assign_seek
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SHOW
block|{
name|MNG_UINT_SHOW
block|,
name|mng_init_show
block|,
name|mng_free_show
block|,
name|mng_read_show
block|,
name|mng_write_show
block|,
name|mng_assign_show
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_TERM
block|{
name|MNG_UINT_TERM
block|,
name|mng_init_term
block|,
name|mng_free_term
block|,
name|mng_read_term
block|,
name|mng_write_term
block|,
name|mng_assign_term
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_bKGD
block|{
name|MNG_UINT_bKGD
block|,
name|mng_init_bkgd
block|,
name|mng_free_bkgd
block|,
name|mng_read_bkgd
block|,
name|mng_write_bkgd
block|,
name|mng_assign_bkgd
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
block|{
name|MNG_UINT_cHRM
block|,
name|mng_init_chrm
block|,
name|mng_free_chrm
block|,
name|mng_read_chrm
block|,
name|mng_write_chrm
block|,
name|mng_assign_chrm
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_eXPI
block|{
name|MNG_UINT_eXPI
block|,
name|mng_init_expi
block|,
name|mng_free_expi
block|,
name|mng_read_expi
block|,
name|mng_write_expi
block|,
name|mng_assign_expi
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_evNT
block|{
name|MNG_UINT_evNT
block|,
name|mng_init_evnt
block|,
name|mng_free_evnt
block|,
name|mng_read_evnt
block|,
name|mng_write_evnt
block|,
name|mng_assign_evnt
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_fPRI
block|{
name|MNG_UINT_fPRI
block|,
name|mng_init_fpri
block|,
name|mng_free_fpri
block|,
name|mng_read_fpri
block|,
name|mng_write_fpri
block|,
name|mng_assign_fpri
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_gAMA
block|{
name|MNG_UINT_gAMA
block|,
name|mng_init_gama
block|,
name|mng_free_gama
block|,
name|mng_read_gama
block|,
name|mng_write_gama
block|,
name|mng_assign_gama
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_hIST
block|{
name|MNG_UINT_hIST
block|,
name|mng_init_hist
block|,
name|mng_free_hist
block|,
name|mng_read_hist
block|,
name|mng_write_hist
block|,
name|mng_assign_hist
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
block|{
name|MNG_UINT_iCCP
block|,
name|mng_init_iccp
block|,
name|mng_free_iccp
block|,
name|mng_read_iccp
block|,
name|mng_write_iccp
block|,
name|mng_assign_iccp
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iTXt
block|{
name|MNG_UINT_iTXt
block|,
name|mng_init_itxt
block|,
name|mng_free_itxt
block|,
name|mng_read_itxt
block|,
name|mng_write_itxt
block|,
name|mng_assign_itxt
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_nEED
block|{
name|MNG_UINT_nEED
block|,
name|mng_init_need
block|,
name|mng_free_need
block|,
name|mng_read_need
block|,
name|mng_write_need
block|,
name|mng_assign_need
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
comment|/* TODO:     {MNG_UINT_oFFs, 0, 0, 0, 0, 0, 0},  */
comment|/* TODO:     {MNG_UINT_pCAL, 0, 0, 0, 0, 0, 0},  */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_pHYg
block|{
name|MNG_UINT_pHYg
block|,
name|mng_init_phyg
block|,
name|mng_free_phyg
block|,
name|mng_read_phyg
block|,
name|mng_write_phyg
block|,
name|mng_assign_phyg
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_pHYs
block|{
name|MNG_UINT_pHYs
block|,
name|mng_init_phys
block|,
name|mng_free_phys
block|,
name|mng_read_phys
block|,
name|mng_write_phys
block|,
name|mng_assign_phys
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sBIT
block|{
name|MNG_UINT_sBIT
block|,
name|mng_init_sbit
block|,
name|mng_free_sbit
block|,
name|mng_read_sbit
block|,
name|mng_write_sbit
block|,
name|mng_assign_sbit
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
comment|/* TODO:     {MNG_UINT_sCAL, 0, 0, 0, 0, 0, 0},  */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sPLT
block|{
name|MNG_UINT_sPLT
block|,
name|mng_init_splt
block|,
name|mng_free_splt
block|,
name|mng_read_splt
block|,
name|mng_write_splt
block|,
name|mng_assign_splt
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_sRGB
block|,
name|mng_init_srgb
block|,
name|mng_free_srgb
block|,
name|mng_read_srgb
block|,
name|mng_write_srgb
block|,
name|mng_assign_srgb
block|,
literal|0
block|,
literal|0
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_tEXt
block|{
name|MNG_UINT_tEXt
block|,
name|mng_init_text
block|,
name|mng_free_text
block|,
name|mng_read_text
block|,
name|mng_write_text
block|,
name|mng_assign_text
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_tIME
block|{
name|MNG_UINT_tIME
block|,
name|mng_init_time
block|,
name|mng_free_time
block|,
name|mng_read_time
block|,
name|mng_write_time
block|,
name|mng_assign_time
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|MNG_UINT_tRNS
block|,
name|mng_init_trns
block|,
name|mng_free_trns
block|,
name|mng_read_trns
block|,
name|mng_write_trns
block|,
name|mng_assign_trns
block|,
literal|0
block|,
literal|0
block|}
block|,
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_zTXt
block|{
name|MNG_UINT_zTXt
block|,
name|mng_init_ztxt
block|,
name|mng_free_ztxt
block|,
name|mng_read_ztxt
block|,
name|mng_write_ztxt
block|,
name|mng_assign_ztxt
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|}
decl_stmt|;
endif|#
directive|endif
comment|/* MNG_OPTIMIZE_CHUNKINITFREE */
comment|/* binary search variables */
name|mng_int32
name|iTop
decl_stmt|,
name|iLower
decl_stmt|,
name|iUpper
decl_stmt|,
name|iMiddle
decl_stmt|;
name|mng_chunk_headerp
name|pEntry
decl_stmt|;
comment|/* pointer to found entry */
else|#
directive|else
name|mng_chunk_header
name|sEntry
decl_stmt|;
comment|/* temp chunk-header */
endif|#
directive|endif
comment|/* MNG_OPTIMIZE_CHUNKREADER */
name|mng_chunkid
name|iChunkname
decl_stmt|;
comment|/* the chunk's tag */
name|mng_chunkp
name|pChunk
decl_stmt|;
comment|/* chunk structure (if #define MNG_STORE_CHUNKS) */
name|mng_retcode
name|iRetcode
decl_stmt|;
comment|/* temporary error-code */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_RAW_CHUNK
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* reset timer indicator on read-cycle */
if|if
condition|(
operator|(
name|pData
operator|->
name|bReading
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bDisplaying
operator|)
condition|)
name|pData
operator|->
name|bTimerset
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* get the chunkname */
name|iChunkname
operator|=
call|(
name|mng_chunkid
call|)
argument_list|(
name|mng_get_uint32
argument_list|(
name|pBuf
argument_list|)
argument_list|)
expr_stmt|;
name|pBuf
operator|+=
sizeof|sizeof
argument_list|(
name|mng_chunkid
argument_list|)
expr_stmt|;
comment|/* adjust the buffer */
name|iBuflen
operator|-=
sizeof|sizeof
argument_list|(
name|mng_chunkid
argument_list|)
expr_stmt|;
name|pChunk
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
comment|/* determine max index of table */
name|iTop
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|mng_chunk_table
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|mng_chunk_table
index|[
literal|0
index|]
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
comment|/* binary search; with 54 chunks, worst-case is 7 comparisons */
name|iLower
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
name|iMiddle
operator|=
literal|11
expr_stmt|;
comment|/* start with the IDAT entry */
else|#
directive|else
name|iMiddle
operator|=
literal|8
expr_stmt|;
endif|#
directive|endif
name|iUpper
operator|=
name|iTop
expr_stmt|;
name|pEntry
operator|=
literal|0
expr_stmt|;
comment|/* no goods yet! */
do|do
comment|/* the binary search itself */
block|{
if|if
condition|(
name|mng_chunk_table
index|[
name|iMiddle
index|]
operator|.
name|iChunkname
operator|<
name|iChunkname
condition|)
name|iLower
operator|=
name|iMiddle
operator|+
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|mng_chunk_table
index|[
name|iMiddle
index|]
operator|.
name|iChunkname
operator|>
name|iChunkname
condition|)
name|iUpper
operator|=
name|iMiddle
operator|-
literal|1
expr_stmt|;
else|else
block|{
name|pEntry
operator|=
operator|&
name|mng_chunk_table
index|[
name|iMiddle
index|]
expr_stmt|;
break|break;
block|}
name|iMiddle
operator|=
operator|(
name|iLower
operator|+
name|iUpper
operator|)
operator|>>
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|iLower
operator|<=
name|iUpper
condition|)
do|;
if|if
condition|(
operator|!
name|pEntry
condition|)
comment|/* unknown chunk ? */
name|pEntry
operator|=
operator|&
name|mng_chunk_unknown
expr_stmt|;
comment|/* make it so! */
else|#
directive|else
comment|/* MNG_OPTIMIZE_CHUNKREADER */
name|mng_get_chunkheader
argument_list|(
name|iChunkname
argument_list|,
operator|&
name|sEntry
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* MNG_OPTIMIZE_CHUNKREADER */
name|pData
operator|->
name|iChunkname
operator|=
name|iChunkname
expr_stmt|;
comment|/* keep track of where we are */
name|pData
operator|->
name|iChunkseq
operator|++
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
if|if
condition|(
name|pEntry
operator|->
name|fRead
condition|)
comment|/* read-callback available ? */
block|{
name|iRetcode
operator|=
name|pEntry
operator|->
name|fRead
argument_list|(
name|pData
argument_list|,
name|pEntry
argument_list|,
name|iBuflen
argument_list|,
operator|(
name|mng_ptr
operator|)
name|pBuf
argument_list|,
operator|&
name|pChunk
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* everything oke ? */
block|{
comment|/* remember unknown chunk's id */
if|if
condition|(
operator|(
name|pChunk
operator|)
operator|&&
operator|(
name|pEntry
operator|->
name|iChunkname
operator|==
name|MNG_UINT_HUH
operator|)
condition|)
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pChunk
operator|)
operator|->
name|iChunkname
operator|=
name|iChunkname
expr_stmt|;
block|}
block|}
else|#
directive|else
comment|/* MNG_OPTIMIZE_CHUNKREADER */
if|if
condition|(
name|sEntry
operator|.
name|fRead
condition|)
comment|/* read-callback available ? */
block|{
name|iRetcode
operator|=
name|sEntry
operator|.
name|fRead
argument_list|(
name|pData
argument_list|,
operator|&
name|sEntry
argument_list|,
name|iBuflen
argument_list|,
operator|(
name|mng_ptr
operator|)
name|pBuf
argument_list|,
operator|&
name|pChunk
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_CHUNKREADER
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* everything oke ? */
block|{
comment|/* remember unknown chunk's id */
if|if
condition|(
operator|(
name|pChunk
operator|)
operator|&&
operator|(
name|sEntry
operator|.
name|iChunkname
operator|==
name|MNG_UINT_HUH
operator|)
condition|)
operator|(
operator|(
name|mng_chunk_headerp
operator|)
name|pChunk
operator|)
operator|->
name|iChunkname
operator|=
name|iChunkname
expr_stmt|;
block|}
endif|#
directive|endif
block|}
endif|#
directive|endif
comment|/* MNG_OPTIMIZE_CHUNKREADER */
else|else
name|iRetcode
operator|=
name|MNG_NOERROR
expr_stmt|;
if|if
condition|(
name|pChunk
condition|)
comment|/* store this chunk ? */
name|mng_add_chunk
argument_list|(
name|pData
argument_list|,
name|pChunk
argument_list|)
expr_stmt|;
comment|/* do it */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
comment|/* implicit EOF ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasIHDR
operator|)
condition|)
endif|#
directive|endif
name|iRetcode
operator|=
name|mng_process_eof
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* then do some EOF processing */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_RAW_CHUNK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|check_chunk_crc
name|MNG_LOCAL
name|mng_retcode
name|check_chunk_crc
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint8p
name|pBuf
parameter_list|,
name|mng_uint32
name|iBuflen
parameter_list|)
block|{
name|mng_uint32
name|iCrc
decl_stmt|;
comment|/* calculated CRC */
name|mng_bool
name|bDiscard
init|=
name|MNG_FALSE
decl_stmt|;
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CHUNK_CRC
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_INPUT
condition|)
comment|/* crc included ? */
block|{
name|mng_bool
name|bCritical
init|=
call|(
name|mng_bool
call|)
argument_list|(
operator|(
operator|*
name|pBuf
operator|&
literal|0x20
operator|)
operator|==
literal|0
argument_list|)
decl_stmt|;
name|mng_uint32
name|iL
init|=
name|iBuflen
operator|-
call|(
name|mng_uint32
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|iCrc
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|bCritical
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_CRITICAL
operator|)
operator|)
operator|||
operator|(
operator|(
operator|!
name|bCritical
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_ANCILLARY
operator|)
operator|)
condition|)
block|{
comment|/* calculate the crc */
name|iCrc
operator|=
name|mng_crc
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iL
argument_list|)
expr_stmt|;
comment|/* and check it */
if|if
condition|(
operator|!
operator|(
name|iCrc
operator|==
name|mng_get_uint32
argument_list|(
name|pBuf
operator|+
name|iL
argument_list|)
operator|)
condition|)
block|{
name|mng_bool
name|bWarning
init|=
name|MNG_FALSE
decl_stmt|;
name|mng_bool
name|bError
init|=
name|MNG_FALSE
decl_stmt|;
if|if
condition|(
name|bCritical
condition|)
block|{
switch|switch
condition|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_CRITICAL
condition|)
block|{
case|case
name|MNG_CRC_CRITICAL_WARNING
case|:
block|{
name|bWarning
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
name|MNG_CRC_CRITICAL_ERROR
case|:
block|{
name|bError
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_ANCILLARY
condition|)
block|{
case|case
name|MNG_CRC_ANCILLARY_DISCARD
case|:
block|{
name|bDiscard
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
name|MNG_CRC_ANCILLARY_WARNING
case|:
block|{
name|bWarning
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
name|MNG_CRC_ANCILLARY_ERROR
case|:
block|{
name|bError
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|bWarning
condition|)
name|MNG_WARNING
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCRC
argument_list|)
expr_stmt|;
if|if
condition|(
name|bError
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCRC
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|bDiscard
condition|)
comment|/* still processing ? */
name|iRetcode
operator|=
name|process_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no crc => straight onto processing */
name|iRetcode
operator|=
name|process_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBuflen
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CHUNK_CRC
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|read_chunk
name|MNG_LOCAL
name|mng_retcode
name|read_chunk
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_uint32
name|iBufmax
init|=
name|pData
operator|->
name|iReadbufsize
decl_stmt|;
name|mng_uint8p
name|pBuf
init|=
name|pData
operator|->
name|pReadbuf
decl_stmt|;
name|mng_uint32
name|iBuflen
init|=
literal|0
decl_stmt|;
comment|/* number of bytes requested */
name|mng_uint32
name|iRead
init|=
literal|0
decl_stmt|;
comment|/* number of bytes read */
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CHUNK
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
if|if
condition|(
name|pData
operator|->
name|pCurraniobj
condition|)
comment|/* processing an animation object ? */
block|{
do|do
comment|/* process it then */
block|{
name|iRetcode
operator|=
operator|(
operator|(
name|mng_object_headerp
operator|)
name|pData
operator|->
name|pCurraniobj
operator|)
operator|->
name|fProcess
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pCurraniobj
argument_list|)
expr_stmt|;
comment|/* refresh needed ? */
comment|/*      if ((!iRetcode)&& (!pData->bTimerset)&& (pData->bNeedrefresh))         iRetcode = display_progressive_refresh (pData, 1); */
comment|/* can we advance to next object ? */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pCurraniobj
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSectionwait
operator|)
condition|)
block|{
comment|/* reset timer indicator on read-cycle */
if|if
condition|(
operator|(
name|pData
operator|->
name|bReading
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bDisplaying
operator|)
condition|)
name|pData
operator|->
name|bTimerset
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|pCurraniobj
operator|=
operator|(
operator|(
name|mng_object_headerp
operator|)
name|pData
operator|->
name|pCurraniobj
operator|)
operator|->
name|pNext
expr_stmt|;
comment|/* TERM processing to be done ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|pCurraniobj
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasTERM
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
condition|)
name|iRetcode
operator|=
name|mng_process_display_mend
argument_list|(
name|pData
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* until error or a break or no more objects */
do|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pCurraniobj
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSectionwait
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bFreezing
operator|)
condition|)
do|;
block|}
else|else
block|{
if|if
condition|(
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* do we need to finish something first ? */
block|{
switch|switch
condition|(
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* return to broken display routine */
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
case|case
literal|1
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_fram2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
case|case
literal|2
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_ihdr
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SHOW
case|case
literal|3
case|:
empty_stmt|;
comment|/* same as 4 !!! */
case|case
literal|4
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_show
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLON
case|case
literal|5
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_clon2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
case|case
literal|7
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_jhdr
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
case|case
literal|6
case|:
empty_stmt|;
comment|/* same as 8 !!! */
case|case
literal|8
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_iend
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
case|case
literal|9
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_magn2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
case|case
literal|10
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_mend2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_PAST
case|case
literal|11
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_past2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
endif|#
directive|endif
comment|/* MNG_SUPPORT_DISPLAY */
comment|/* can we continue processing now, or do we */
comment|/* need to wait for the timer to finish (again) ? */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSectionwait
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bEOF
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|!
name|pData
operator|->
name|bEOF
condition|)
endif|#
directive|endif
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
comment|/* freezing in progress ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bFreezing
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iSuspendpoint
operator|==
literal|0
operator|)
condition|)
name|pData
operator|->
name|bRunning
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* then this is the right moment to do it */
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|iSuspendpoint
operator|<=
literal|2
condition|)
block|{
name|iBuflen
operator|=
sizeof|sizeof
argument_list|(
name|mng_uint32
argument_list|)
expr_stmt|;
comment|/* read length */
name|iRetcode
operator|=
name|read_databuffer
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
operator|&
name|pData
operator|->
name|pReadbufnext
argument_list|,
name|iBuflen
argument_list|,
operator|&
name|iRead
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* bail on errors */
return|return
name|iRetcode
return|;
if|if
condition|(
name|pData
operator|->
name|bSuspended
condition|)
comment|/* suspended ? */
name|pData
operator|->
name|iSuspendpoint
operator|=
literal|2
expr_stmt|;
else|else
comment|/* save the length */
block|{
name|pData
operator|->
name|iChunklen
operator|=
name|mng_get_uint32
argument_list|(
name|pBuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iChunklen
operator|>
literal|0x7ffffff
condition|)
return|return
name|MNG_INVALIDLENGTH
return|;
block|}
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bSuspended
condition|)
comment|/* still going ? */
block|{
comment|/* previously suspended or not eof ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iSuspendpoint
operator|>
literal|2
operator|)
operator|||
operator|(
name|iRead
operator|==
name|iBuflen
operator|)
condition|)
block|{
comment|/* determine length chunkname + data (+ crc) */
if|if
condition|(
name|pData
operator|->
name|iCrcmode
operator|&
name|MNG_CRC_INPUT
condition|)
name|iBuflen
operator|=
name|pData
operator|->
name|iChunklen
operator|+
call|(
name|mng_uint32
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|mng_chunkid
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|mng_uint32
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|iBuflen
operator|=
name|pData
operator|->
name|iChunklen
operator|+
call|(
name|mng_uint32
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|mng_chunkid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do we have enough data in the current push buffer ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|pFirstpushdata
operator|)
operator|&&
operator|(
name|iBuflen
operator|<=
name|pData
operator|->
name|pFirstpushdata
operator|->
name|iRemaining
operator|)
condition|)
block|{
name|mng_pushdatap
name|pPush
init|=
name|pData
operator|->
name|pFirstpushdata
decl_stmt|;
name|pBuf
operator|=
name|pPush
operator|->
name|pDatanext
expr_stmt|;
name|pPush
operator|->
name|pDatanext
operator|+=
name|iBuflen
expr_stmt|;
name|pPush
operator|->
name|iRemaining
operator|-=
name|iBuflen
expr_stmt|;
name|pData
operator|->
name|iSuspendpoint
operator|=
literal|0
expr_stmt|;
comment|/* safely reset this here ! */
name|iRetcode
operator|=
name|check_chunk_crc
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBuflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
if|if
condition|(
operator|!
name|pPush
operator|->
name|iRemaining
condition|)
comment|/* buffer depleted? then release it */
name|iRetcode
operator|=
name|mng_release_pushdata
argument_list|(
name|pData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|iBuflen
operator|<
name|iBufmax
condition|)
comment|/* does it fit in default buffer ? */
block|{
comment|/* note that we don't use the full size                                           so there's always a zero-byte at the                                           very end !!! */
name|iRetcode
operator|=
name|read_databuffer
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
operator|&
name|pData
operator|->
name|pReadbufnext
argument_list|,
name|iBuflen
argument_list|,
operator|&
name|iRead
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* bail on errors */
return|return
name|iRetcode
return|;
if|if
condition|(
name|pData
operator|->
name|bSuspended
condition|)
comment|/* suspended ? */
name|pData
operator|->
name|iSuspendpoint
operator|=
literal|3
expr_stmt|;
else|else
block|{
if|if
condition|(
name|iRead
operator|!=
name|iBuflen
condition|)
comment|/* did we get all the data ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_UNEXPECTEDEOF
argument_list|)
expr_stmt|;
name|iRetcode
operator|=
name|check_chunk_crc
argument_list|(
name|pData
argument_list|,
name|pBuf
argument_list|,
name|iBuflen
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|iBuflen
operator|>
literal|16777216
condition|)
comment|/* is the length incredible? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_IMPROBABLELENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iSuspendpoint
condition|)
comment|/* create additional large buffer ? */
block|{
comment|/* again reserve space for the last zero-byte */
name|pData
operator|->
name|iLargebufsize
operator|=
name|iBuflen
operator|+
literal|1
expr_stmt|;
name|pData
operator|->
name|pLargebufnext
operator|=
name|MNG_NULL
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pLargebuf
argument_list|,
name|pData
operator|->
name|iLargebufsize
argument_list|)
expr_stmt|;
block|}
name|iRetcode
operator|=
name|read_databuffer
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pLargebuf
argument_list|,
operator|&
name|pData
operator|->
name|pLargebufnext
argument_list|,
name|iBuflen
argument_list|,
operator|&
name|iRead
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
if|if
condition|(
name|pData
operator|->
name|bSuspended
condition|)
comment|/* suspended ? */
name|pData
operator|->
name|iSuspendpoint
operator|=
literal|4
expr_stmt|;
else|else
block|{
if|if
condition|(
name|iRead
operator|!=
name|iBuflen
condition|)
comment|/* did we get all the data ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_UNEXPECTEDEOF
argument_list|)
expr_stmt|;
name|iRetcode
operator|=
name|check_chunk_crc
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pLargebuf
argument_list|,
name|iBuflen
argument_list|)
expr_stmt|;
comment|/* cleanup additional large buffer */
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pLargebuf
argument_list|,
name|pData
operator|->
name|iLargebufsize
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
else|else
block|{
comment|/* that's final */
name|iRetcode
operator|=
name|mng_process_eof
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
operator|(
name|iRead
operator|!=
literal|0
operator|)
operator|||
comment|/* did we get an unexpected eof ? */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
operator|(
name|pData
operator|->
name|bHasIHDR
operator|||
name|pData
operator|->
name|bHasMHDR
operator|||
name|pData
operator|->
name|bHasJHDR
operator|)
condition|)
else|#
directive|else
operator|(
name|pData
operator|->
name|bHasIHDR
operator|||
name|pData
operator|->
name|bHasMHDR
operator|)
block|)
endif|#
directive|endif
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_UNEXPECTEDEOF
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
end_ifdef
begin_comment
comment|/* refresh needed ? */
end_comment
begin_if
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSuspended
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bNeedrefresh
operator|)
condition|)
block|{
name|iRetcode
operator|=
name|mng_display_progressive_refresh
argument_list|(
name|pData
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
end_if
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_CHUNK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_comment
unit|}
comment|/* ************************************************************************** */
end_comment
begin_function
unit|MNG_LOCAL
DECL|function|process_pushedchunk
name|mng_retcode
name|process_pushedchunk
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_pushdatap
name|pPush
decl_stmt|;
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
if|if
condition|(
name|pData
operator|->
name|pCurraniobj
condition|)
comment|/* processing an animation object ? */
block|{
do|do
comment|/* process it then */
block|{
name|iRetcode
operator|=
operator|(
operator|(
name|mng_object_headerp
operator|)
name|pData
operator|->
name|pCurraniobj
operator|)
operator|->
name|fProcess
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pCurraniobj
argument_list|)
expr_stmt|;
comment|/* refresh needed ? */
comment|/*      if ((!iRetcode)&& (!pData->bTimerset)&& (pData->bNeedrefresh))         iRetcode = display_progressive_refresh (pData, 1); */
comment|/* can we advance to next object ? */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pCurraniobj
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSectionwait
operator|)
condition|)
block|{
comment|/* reset timer indicator on read-cycle */
if|if
condition|(
operator|(
name|pData
operator|->
name|bReading
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bDisplaying
operator|)
condition|)
name|pData
operator|->
name|bTimerset
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|pCurraniobj
operator|=
operator|(
operator|(
name|mng_object_headerp
operator|)
name|pData
operator|->
name|pCurraniobj
operator|)
operator|->
name|pNext
expr_stmt|;
comment|/* TERM processing to be done ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|pCurraniobj
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasTERM
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bHasMHDR
operator|)
condition|)
name|iRetcode
operator|=
name|mng_process_display_mend
argument_list|(
name|pData
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* until error or a break or no more objects */
do|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pCurraniobj
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSectionwait
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bFreezing
operator|)
condition|)
do|;
block|}
else|else
block|{
if|if
condition|(
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* do we need to finish something first ? */
block|{
switch|switch
condition|(
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* return to broken display routine */
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
case|case
literal|1
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_fram2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
case|case
literal|2
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_ihdr
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SHOW
case|case
literal|3
case|:
empty_stmt|;
comment|/* same as 4 !!! */
case|case
literal|4
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_show
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLON
case|case
literal|5
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_clon2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
case|case
literal|7
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_jhdr
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
case|case
literal|6
case|:
empty_stmt|;
comment|/* same as 8 !!! */
case|case
literal|8
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_iend
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
case|case
literal|9
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_magn2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
case|case
literal|10
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_mend2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_PAST
case|case
literal|11
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_past2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
endif|#
directive|endif
comment|/* MNG_SUPPORT_DISPLAY */
comment|/* can we continue processing now, or do we */
comment|/* need to wait for the timer to finish (again) ? */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSectionwait
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bEOF
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|!
name|pData
operator|->
name|bEOF
condition|)
endif|#
directive|endif
block|{
name|pData
operator|->
name|iSuspendpoint
operator|=
literal|0
expr_stmt|;
comment|/* safely reset it here ! */
name|pPush
operator|=
name|pData
operator|->
name|pFirstpushchunk
expr_stmt|;
name|iRetcode
operator|=
name|process_raw_chunk
argument_list|(
name|pData
argument_list|,
name|pPush
operator|->
name|pData
argument_list|,
name|pPush
operator|->
name|iLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
comment|/* refresh needed ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSuspended
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bNeedrefresh
operator|)
condition|)
block|{
name|iRetcode
operator|=
name|mng_display_progressive_refresh
argument_list|(
name|pData
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
endif|#
directive|endif
block|}
return|return
name|mng_release_pushchunk
argument_list|(
name|pData
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_read_graphic
name|mng_retcode
name|mng_read_graphic
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_uint32
name|iBuflen
decl_stmt|;
comment|/* number of bytes requested */
name|mng_uint32
name|iRead
decl_stmt|;
comment|/* number of bytes read */
name|mng_retcode
name|iRetcode
decl_stmt|;
comment|/* temporary error-code */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_GRAPHIC
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|pReadbuf
condition|)
comment|/* buffer allocated ? */
block|{
name|pData
operator|->
name|iReadbufsize
operator|=
literal|4200
expr_stmt|;
comment|/* allocate a default read buffer */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pReadbuf
argument_list|,
name|pData
operator|->
name|iReadbufsize
argument_list|)
expr_stmt|;
block|}
comment|/* haven't processed the signature ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHavesig
operator|)
operator|||
operator|(
name|pData
operator|->
name|iSuspendpoint
operator|==
literal|1
operator|)
condition|)
block|{
name|iBuflen
operator|=
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|mng_uint32
argument_list|)
expr_stmt|;
comment|/* read signature */
name|iRetcode
operator|=
name|read_databuffer
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pReadbuf
argument_list|,
operator|&
name|pData
operator|->
name|pReadbufnext
argument_list|,
name|iBuflen
argument_list|,
operator|&
name|iRead
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
if|if
condition|(
name|pData
operator|->
name|bSuspended
condition|)
comment|/* input suspension ? */
name|pData
operator|->
name|iSuspendpoint
operator|=
literal|1
expr_stmt|;
else|else
block|{
if|if
condition|(
name|iRead
operator|!=
name|iBuflen
condition|)
comment|/* full signature received ? */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_UNEXPECTEDEOF
argument_list|)
expr_stmt|;
comment|/* is it a valid signature ? */
if|if
condition|(
name|mng_get_uint32
argument_list|(
name|pData
operator|->
name|pReadbuf
argument_list|)
operator|==
name|PNG_SIG
condition|)
name|pData
operator|->
name|eSigtype
operator|=
name|mng_it_png
expr_stmt|;
elseif|else
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
name|mng_get_uint32
argument_list|(
name|pData
operator|->
name|pReadbuf
argument_list|)
operator|==
name|JNG_SIG
condition|)
name|pData
operator|->
name|eSigtype
operator|=
name|mng_it_jng
expr_stmt|;
elseif|else
endif|#
directive|endif
if|if
condition|(
name|mng_get_uint32
argument_list|(
name|pData
operator|->
name|pReadbuf
argument_list|)
operator|==
name|MNG_SIG
condition|)
name|pData
operator|->
name|eSigtype
operator|=
name|mng_it_mng
expr_stmt|;
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDSIG
argument_list|)
expr_stmt|;
comment|/* all of it ? */
if|if
condition|(
name|mng_get_uint32
argument_list|(
name|pData
operator|->
name|pReadbuf
operator|+
literal|4
argument_list|)
operator|!=
name|POST_SIG
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDSIG
argument_list|)
expr_stmt|;
name|pData
operator|->
name|bHavesig
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bSuspended
condition|)
comment|/* still going ? */
block|{
do|do
block|{
comment|/* reset timer during mng_read() ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bReading
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bDisplaying
operator|)
condition|)
name|pData
operator|->
name|bTimerset
operator|=
name|MNG_FALSE
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|pFirstpushchunk
condition|)
comment|/* chunks pushed ? */
name|iRetcode
operator|=
name|process_pushedchunk
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* process the pushed chunk */
else|else
name|iRetcode
operator|=
name|read_chunk
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* read& process a chunk */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DISPLAY
comment|/* until EOF or a break-request */
do|while
condition|(
operator|(
operator|(
operator|!
name|pData
operator|->
name|bEOF
operator|)
operator|||
operator|(
name|pData
operator|->
name|pCurraniobj
operator|)
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSuspended
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSectionwait
operator|)
operator|&&
operator|(
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|||
operator|(
operator|(
name|pData
operator|->
name|bReading
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bDisplaying
operator|)
operator|)
operator|)
condition|)
do|;
else|#
directive|else
while|while
condition|(
operator|(
operator|!
name|pData
operator|->
name|bEOF
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSuspended
operator|)
condition|)
empty_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_READ_GRAPHIC
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_READ_PROCS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* * end of file                                                            * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
end_unit
