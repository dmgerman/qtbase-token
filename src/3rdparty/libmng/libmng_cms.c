begin_unit
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *             For conditions of distribution and use,                    * */
end_comment
begin_comment
comment|/* *                see copyright notice in libmng.h                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * project   : libmng                                                     * */
end_comment
begin_comment
comment|/* * file      : libmng_cms.c              copyright (c) 2000-2004 G.Juyn   * */
end_comment
begin_comment
comment|/* * version   : 1.0.9                                                      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * purpose   : color management routines (implementation)                 * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * author    : G.Juyn                                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * comment   : implementation of the color management routines            * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * changes   : 0.5.1 - 05/01/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B001(105795) - fixed a typo and misconception about      * */
end_comment
begin_comment
comment|/* *               freeing allocated gamma-table. (reported by Marti Maria) * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/08/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed strict-ANSI stuff                                * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/09/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - filled application-based color-management routines       * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/11/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added creatememprofile                                   * */
end_comment
begin_comment
comment|/* *             - added callback error-reporting support                   * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/12/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed trace to macro for callback error-reporting      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.2 - 06/10/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed some compilation-warnings (contrib Jason Morris)   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/21/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed problem with color-correction for stored images    * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/23/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed problem with incorrect gamma-correction            * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.2 - 08/05/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed file-prefixes                                    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/31/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed sRGB precedence for gamma_only corection           * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.4 - 12/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed mixup of data-& function-pointers (thanks Dimitri)* */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.1 - 03/31/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - ignore gamma=0 (see png-list for more info)              * */
end_comment
begin_comment
comment|/* *             1.0.1 - 04/25/2001 - G.Juyn (reported by Gregg Kelly)      * */
end_comment
begin_comment
comment|/* *             - fixed problem with cms profile being created multiple    * */
end_comment
begin_comment
comment|/* *               times when both iCCP& cHRM/gAMA are present             * */
end_comment
begin_comment
comment|/* *             1.0.1 - 04/25/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - moved mng_clear_cms to libmng_cms                        * */
end_comment
begin_comment
comment|/* *             1.0.1 - 05/02/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added "default" sRGB generation (Thanks Marti!)          * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.5 - 08/19/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B597134 - libmng pollutes the linker namespace           * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/19/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - optimized color-correction routines                      * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/23/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added in-memory color-correction of abstract images      * */
end_comment
begin_comment
comment|/* *             1.0.5 - 11/08/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed issues in init_app_cms()                           * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.6 - 04/11/2003 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B719420 - fixed several MNG_APP_CMS problems             * */
end_comment
begin_comment
comment|/* *             1.0.6 - 07/11/2003 - G. R-P                                * */
end_comment
begin_comment
comment|/* *             - added conditional MNG_SKIPCHUNK_cHRM/iCCP                * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/20/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - cleaned up macro-invocations (thanks to D. Airlie)       * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_include
include|#
directive|include
file|"libmng.h"
end_include
begin_include
include|#
directive|include
file|"libmng_data.h"
end_include
begin_include
include|#
directive|include
file|"libmng_error.h"
end_include
begin_include
include|#
directive|include
file|"libmng_trace.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|__BORLANDC__
end_ifdef
begin_pragma
pragma|#
directive|pragma
name|hdrstop
end_pragma
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"libmng_objects.h"
end_include
begin_include
include|#
directive|include
file|"libmng_cms.h"
end_include
begin_if
if|#
directive|if
name|defined
argument_list|(
name|__BORLANDC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_STRICT_ANSI
argument_list|)
end_if
begin_pragma
pragma|#
directive|pragma
name|option
name|-
name|A
end_pragma
begin_comment
comment|/* force ANSI-C */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_DISPLAY_PROCS
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Little CMS helper routines                                             * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_LCMS
end_ifdef
begin_define
DECL|macro|MNG_CMS_FLAGS
define|#
directive|define
name|MNG_CMS_FLAGS
value|0
end_define
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mnglcms_initlibrary
name|void
name|mnglcms_initlibrary
parameter_list|()
block|{
name|cmsErrorAction
argument_list|(
name|LCMS_ERROR_IGNORE
argument_list|)
expr_stmt|;
comment|/* LCMS should ignore errors! */
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mnglcms_createfileprofile
name|mng_cmsprof
name|mnglcms_createfileprofile
parameter_list|(
name|mng_pchar
name|zFilename
parameter_list|)
block|{
return|return
name|cmsOpenProfileFromFile
argument_list|(
name|zFilename
argument_list|,
literal|"r"
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mnglcms_creatememprofile
name|mng_cmsprof
name|mnglcms_creatememprofile
parameter_list|(
name|mng_uint32
name|iProfilesize
parameter_list|,
name|mng_ptr
name|pProfile
parameter_list|)
block|{
return|return
name|cmsOpenProfileFromMem
argument_list|(
name|pProfile
argument_list|,
name|iProfilesize
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mnglcms_createsrgbprofile
name|mng_cmsprof
name|mnglcms_createsrgbprofile
parameter_list|(
name|void
parameter_list|)
block|{
name|cmsCIExyY
name|D65
decl_stmt|;
name|cmsCIExyYTRIPLE
name|Rec709Primaries
init|=
block|{
block|{
literal|0.6400
block|,
literal|0.3300
block|,
literal|1.0
block|}
block|,
block|{
literal|0.3000
block|,
literal|0.6000
block|,
literal|1.0
block|}
block|,
block|{
literal|0.1500
block|,
literal|0.0600
block|,
literal|1.0
block|}
block|}
decl_stmt|;
name|LPGAMMATABLE
name|Gamma24
index|[
literal|3
index|]
decl_stmt|;
name|mng_cmsprof
name|hsRGB
decl_stmt|;
name|cmsWhitePointFromTemp
argument_list|(
literal|6504
argument_list|,
operator|&
name|D65
argument_list|)
expr_stmt|;
name|Gamma24
index|[
literal|0
index|]
operator|=
name|Gamma24
index|[
literal|1
index|]
operator|=
name|Gamma24
index|[
literal|2
index|]
operator|=
name|cmsBuildGamma
argument_list|(
literal|256
argument_list|,
literal|2.4
argument_list|)
expr_stmt|;
name|hsRGB
operator|=
name|cmsCreateRGBProfile
argument_list|(
operator|&
name|D65
argument_list|,
operator|&
name|Rec709Primaries
argument_list|,
name|Gamma24
argument_list|)
expr_stmt|;
name|cmsFreeGamma
argument_list|(
name|Gamma24
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|hsRGB
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mnglcms_freeprofile
name|void
name|mnglcms_freeprofile
parameter_list|(
name|mng_cmsprof
name|hProf
parameter_list|)
block|{
name|cmsCloseProfile
argument_list|(
name|hProf
argument_list|)
expr_stmt|;
return|return;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mnglcms_freetransform
name|void
name|mnglcms_freetransform
parameter_list|(
name|mng_cmstrans
name|hTrans
parameter_list|)
block|{
comment|/* B001 start */
name|cmsDeleteTransform
argument_list|(
name|hTrans
argument_list|)
expr_stmt|;
comment|/* B001 end */
return|return;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_clear_cms
name|mng_retcode
name|mng_clear_cms
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CLEAR_CMS
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|hTrans
condition|)
comment|/* transformation still active ? */
name|mnglcms_freetransform
argument_list|(
name|pData
operator|->
name|hTrans
argument_list|)
expr_stmt|;
name|pData
operator|->
name|hTrans
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|hProf1
condition|)
comment|/* file profile still active ? */
name|mnglcms_freeprofile
argument_list|(
name|pData
operator|->
name|hProf1
argument_list|)
expr_stmt|;
name|pData
operator|->
name|hProf1
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CLEAR_CMS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_LCMS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Color-management initialization& correction routines                  * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_LCMS
end_ifdef
begin_function
DECL|function|mng_init_full_cms
name|mng_retcode
name|mng_init_full_cms
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_bool
name|bGlobal
parameter_list|,
name|mng_bool
name|bObject
parameter_list|,
name|mng_bool
name|bRetrobj
parameter_list|)
block|{
name|mng_cmsprof
name|hProf
decl_stmt|;
name|mng_cmstrans
name|hTrans
decl_stmt|;
name|mng_imagep
name|pImage
init|=
name|MNG_NULL
decl_stmt|;
name|mng_imagedatap
name|pBuf
init|=
name|MNG_NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INIT_FULL_CMS
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bObject
condition|)
comment|/* use object if present ? */
block|{
comment|/* current object ? */
if|if
condition|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
condition|)
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
else|else
comment|/* if not; use object 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
block|}
if|if
condition|(
name|bRetrobj
condition|)
comment|/* retrieving from an object ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pRetrieveobj
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* are we using an object ? */
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* then address the buffer */
if|if
condition|(
operator|(
operator|!
name|pBuf
operator|)
operator|||
operator|(
operator|!
name|pBuf
operator|->
name|bCorrected
operator|)
condition|)
comment|/* is the buffer already corrected ? */
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
if|if
condition|(
operator|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasICCP
operator|)
operator|)
operator|||
operator|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalICCP
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|hProf2
condition|)
comment|/* output profile not defined ? */
block|{
comment|/* then assume sRGB !! */
name|pData
operator|->
name|hProf2
operator|=
name|mnglcms_createsrgbprofile
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|hProf2
condition|)
comment|/* handle error ? */
name|MNG_ERRORL
argument_list|(
name|pData
argument_list|,
name|MNG_LCMS_NOHANDLE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasICCP
operator|)
condition|)
comment|/* generate a profile handle */
name|hProf
operator|=
name|cmsOpenProfileFromMem
argument_list|(
name|pBuf
operator|->
name|pProfile
argument_list|,
name|pBuf
operator|->
name|iProfilesize
argument_list|)
expr_stmt|;
else|else
name|hProf
operator|=
name|cmsOpenProfileFromMem
argument_list|(
name|pData
operator|->
name|pGlobalProfile
argument_list|,
name|pData
operator|->
name|iGlobalProfilesize
argument_list|)
expr_stmt|;
name|pData
operator|->
name|hProf1
operator|=
name|hProf
expr_stmt|;
comment|/* save for future use */
if|if
condition|(
operator|!
name|hProf
condition|)
comment|/* handle error ? */
name|MNG_ERRORL
argument_list|(
name|pData
argument_list|,
name|MNG_LCMS_NOHANDLE
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|bIsRGBA16
condition|)
comment|/* 16-bit intermediates ? */
name|hTrans
operator|=
name|cmsCreateTransform
argument_list|(
name|hProf
argument_list|,
name|TYPE_RGBA_16_SE
argument_list|,
name|pData
operator|->
name|hProf2
argument_list|,
name|TYPE_RGBA_16_SE
argument_list|,
name|INTENT_PERCEPTUAL
argument_list|,
name|MNG_CMS_FLAGS
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|hTrans
operator|=
name|cmsCreateTransform
argument_list|(
name|hProf
argument_list|,
name|TYPE_RGBA_8
argument_list|,
name|pData
operator|->
name|hProf2
argument_list|,
name|TYPE_RGBA_8
argument_list|,
name|INTENT_PERCEPTUAL
argument_list|,
name|MNG_CMS_FLAGS
argument_list|)
expr_stmt|;
name|pData
operator|->
name|hTrans
operator|=
name|hTrans
expr_stmt|;
comment|/* save for future use */
if|if
condition|(
operator|!
name|hTrans
condition|)
comment|/* handle error ? */
name|MNG_ERRORL
argument_list|(
name|pData
argument_list|,
name|MNG_LCMS_NOTRANS
argument_list|)
expr_stmt|;
comment|/* load color-correction routine */
name|pData
operator|->
name|fCorrectrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_correct_full_cms
expr_stmt|;
return|return
name|MNG_NOERROR
return|;
comment|/* and done */
block|}
elseif|else
endif|#
directive|endif
if|if
condition|(
operator|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasSRGB
operator|)
operator|)
operator|||
operator|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalSRGB
operator|)
operator|)
condition|)
block|{
name|mng_uint8
name|iIntent
decl_stmt|;
if|if
condition|(
name|pData
operator|->
name|bIssRGB
condition|)
comment|/* sRGB system ? */
return|return
name|MNG_NOERROR
return|;
comment|/* no conversion required */
if|if
condition|(
operator|!
name|pData
operator|->
name|hProf3
condition|)
comment|/* sRGB profile not defined ? */
block|{
comment|/* then create it implicitly !! */
name|pData
operator|->
name|hProf3
operator|=
name|mnglcms_createsrgbprofile
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|hProf3
condition|)
comment|/* handle error ? */
name|MNG_ERRORL
argument_list|(
name|pData
argument_list|,
name|MNG_LCMS_NOHANDLE
argument_list|)
expr_stmt|;
block|}
name|hProf
operator|=
name|pData
operator|->
name|hProf3
expr_stmt|;
comment|/* convert from sRGB profile */
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasSRGB
operator|)
condition|)
comment|/* determine rendering intent */
name|iIntent
operator|=
name|pBuf
operator|->
name|iRenderingintent
expr_stmt|;
else|else
name|iIntent
operator|=
name|pData
operator|->
name|iGlobalRendintent
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bIsRGBA16
condition|)
comment|/* 16-bit intermediates ? */
name|hTrans
operator|=
name|cmsCreateTransform
argument_list|(
name|hProf
argument_list|,
name|TYPE_RGBA_16_SE
argument_list|,
name|pData
operator|->
name|hProf2
argument_list|,
name|TYPE_RGBA_16_SE
argument_list|,
name|iIntent
argument_list|,
name|MNG_CMS_FLAGS
argument_list|)
expr_stmt|;
else|else
name|hTrans
operator|=
name|cmsCreateTransform
argument_list|(
name|hProf
argument_list|,
name|TYPE_RGBA_8
argument_list|,
name|pData
operator|->
name|hProf2
argument_list|,
name|TYPE_RGBA_8
argument_list|,
name|iIntent
argument_list|,
name|MNG_CMS_FLAGS
argument_list|)
expr_stmt|;
name|pData
operator|->
name|hTrans
operator|=
name|hTrans
expr_stmt|;
comment|/* save for future use */
if|if
condition|(
operator|!
name|hTrans
condition|)
comment|/* handle error ? */
name|MNG_ERRORL
argument_list|(
name|pData
argument_list|,
name|MNG_LCMS_NOTRANS
argument_list|)
expr_stmt|;
comment|/* load color-correction routine */
name|pData
operator|->
name|fCorrectrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_correct_full_cms
expr_stmt|;
return|return
name|MNG_NOERROR
return|;
comment|/* and done */
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasCHRM
operator|)
operator|)
operator|||
operator|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalCHRM
operator|)
operator|)
operator|)
operator|&&
operator|(
operator|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasGAMA
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|iGamma
operator|>
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalGAMA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iGlobalGamma
operator|>
literal|0
operator|)
operator|)
operator|)
condition|)
block|{
name|mng_CIExyY
name|sWhitepoint
decl_stmt|;
name|mng_CIExyYTRIPLE
name|sPrimaries
decl_stmt|;
name|mng_gammatabp
name|pGammatable
index|[
literal|3
index|]
decl_stmt|;
name|mng_float
name|dGamma
decl_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|hProf2
condition|)
comment|/* output profile not defined ? */
block|{
comment|/* then assume sRGB !! */
name|pData
operator|->
name|hProf2
operator|=
name|mnglcms_createsrgbprofile
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|hProf2
condition|)
comment|/* handle error ? */
name|MNG_ERRORL
argument_list|(
name|pData
argument_list|,
name|MNG_LCMS_NOHANDLE
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasCHRM
operator|)
condition|)
comment|/* local cHRM ? */
block|{
name|sWhitepoint
operator|.
name|x
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iWhitepointx
operator|/
literal|100000
expr_stmt|;
name|sWhitepoint
operator|.
name|y
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iWhitepointy
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Red
operator|.
name|x
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iPrimaryredx
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Red
operator|.
name|y
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iPrimaryredy
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Green
operator|.
name|x
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iPrimarygreenx
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Green
operator|.
name|y
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iPrimarygreeny
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Blue
operator|.
name|x
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iPrimarybluex
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Blue
operator|.
name|y
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iPrimarybluey
operator|/
literal|100000
expr_stmt|;
block|}
else|else
block|{
name|sWhitepoint
operator|.
name|x
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalWhitepointx
operator|/
literal|100000
expr_stmt|;
name|sWhitepoint
operator|.
name|y
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalWhitepointy
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Red
operator|.
name|x
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalPrimaryredx
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Red
operator|.
name|y
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalPrimaryredy
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Green
operator|.
name|x
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalPrimarygreenx
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Green
operator|.
name|y
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalPrimarygreeny
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Blue
operator|.
name|x
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalPrimarybluex
operator|/
literal|100000
expr_stmt|;
name|sPrimaries
operator|.
name|Blue
operator|.
name|y
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalPrimarybluey
operator|/
literal|100000
expr_stmt|;
block|}
endif|#
directive|endif
name|sWhitepoint
operator|.
name|Y
operator|=
comment|/* Y component is always 1.0 */
name|sPrimaries
operator|.
name|Red
operator|.
name|Y
operator|=
name|sPrimaries
operator|.
name|Green
operator|.
name|Y
operator|=
name|sPrimaries
operator|.
name|Blue
operator|.
name|Y
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasGAMA
operator|)
condition|)
comment|/* get the gamma value */
name|dGamma
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iGamma
operator|/
literal|100000
expr_stmt|;
else|else
name|dGamma
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalGamma
operator|/
literal|100000
expr_stmt|;
name|dGamma
operator|=
name|pData
operator|->
name|dViewgamma
operator|/
name|dGamma
expr_stmt|;
name|pGammatable
index|[
literal|0
index|]
operator|=
comment|/* and build the lookup tables */
name|pGammatable
index|[
literal|1
index|]
operator|=
name|pGammatable
index|[
literal|2
index|]
operator|=
name|cmsBuildGamma
argument_list|(
literal|256
argument_list|,
name|dGamma
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pGammatable
index|[
literal|0
index|]
condition|)
comment|/* enough memory ? */
name|MNG_ERRORL
argument_list|(
name|pData
argument_list|,
name|MNG_LCMS_NOMEM
argument_list|)
expr_stmt|;
comment|/* create the profile */
name|hProf
operator|=
name|cmsCreateRGBProfile
argument_list|(
operator|&
name|sWhitepoint
argument_list|,
operator|&
name|sPrimaries
argument_list|,
name|pGammatable
argument_list|)
expr_stmt|;
name|cmsFreeGamma
argument_list|(
name|pGammatable
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* free the temporary gamma tables ? */
comment|/* yes! but just the one! */
name|pData
operator|->
name|hProf1
operator|=
name|hProf
expr_stmt|;
comment|/* save for future use */
if|if
condition|(
operator|!
name|hProf
condition|)
comment|/* handle error ? */
name|MNG_ERRORL
argument_list|(
name|pData
argument_list|,
name|MNG_LCMS_NOHANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bIsRGBA16
condition|)
comment|/* 16-bit intermediates ? */
name|hTrans
operator|=
name|cmsCreateTransform
argument_list|(
name|hProf
argument_list|,
name|TYPE_RGBA_16_SE
argument_list|,
name|pData
operator|->
name|hProf2
argument_list|,
name|TYPE_RGBA_16_SE
argument_list|,
name|INTENT_PERCEPTUAL
argument_list|,
name|MNG_CMS_FLAGS
argument_list|)
expr_stmt|;
else|else
name|hTrans
operator|=
name|cmsCreateTransform
argument_list|(
name|hProf
argument_list|,
name|TYPE_RGBA_8
argument_list|,
name|pData
operator|->
name|hProf2
argument_list|,
name|TYPE_RGBA_8
argument_list|,
name|INTENT_PERCEPTUAL
argument_list|,
name|MNG_CMS_FLAGS
argument_list|)
expr_stmt|;
name|pData
operator|->
name|hTrans
operator|=
name|hTrans
expr_stmt|;
comment|/* save for future use */
if|if
condition|(
operator|!
name|hTrans
condition|)
comment|/* handle error ? */
name|MNG_ERRORL
argument_list|(
name|pData
argument_list|,
name|MNG_LCMS_NOTRANS
argument_list|)
expr_stmt|;
comment|/* load color-correction routine */
name|pData
operator|->
name|fCorrectrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_correct_full_cms
expr_stmt|;
return|return
name|MNG_NOERROR
return|;
comment|/* and done */
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INIT_FULL_CMS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* if we get here, we'll only do gamma */
return|return
name|mng_init_gamma_only
argument_list|(
name|pData
argument_list|,
name|bGlobal
argument_list|,
name|bObject
argument_list|,
name|bRetrobj
argument_list|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_LCMS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_LCMS
end_ifdef
begin_function
DECL|function|mng_correct_full_cms
name|mng_retcode
name|mng_correct_full_cms
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CORRECT_FULL_CMS
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cmsDoTransform
argument_list|(
name|pData
operator|->
name|hTrans
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|iRowsamples
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CORRECT_FULL_CMS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_LCMS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_GAMMA_ONLY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_APP_CMS
argument_list|)
end_if
begin_function
DECL|function|mng_init_gamma_only
name|mng_retcode
name|mng_init_gamma_only
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_bool
name|bGlobal
parameter_list|,
name|mng_bool
name|bObject
parameter_list|,
name|mng_bool
name|bRetrobj
parameter_list|)
block|{
name|mng_float
name|dGamma
decl_stmt|;
name|mng_imagep
name|pImage
init|=
name|MNG_NULL
decl_stmt|;
name|mng_imagedatap
name|pBuf
init|=
name|MNG_NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INIT_GAMMA_ONLY
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bObject
condition|)
comment|/* use object if present ? */
block|{
comment|/* current object ? */
if|if
condition|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
condition|)
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
else|else
comment|/* if not; use object 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
block|}
if|if
condition|(
name|bRetrobj
condition|)
comment|/* retrieving from an object ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pRetrieveobj
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* are we using an object ? */
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* then address the buffer */
if|if
condition|(
operator|(
operator|!
name|pBuf
operator|)
operator|||
operator|(
operator|!
name|pBuf
operator|->
name|bCorrected
operator|)
condition|)
comment|/* is the buffer already corrected ? */
block|{
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasSRGB
operator|)
condition|)
comment|/* get the gamma value */
name|dGamma
operator|=
literal|0.45455
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasGAMA
operator|)
condition|)
name|dGamma
operator|=
operator|(
name|mng_float
operator|)
name|pBuf
operator|->
name|iGamma
operator|/
literal|100000
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalSRGB
operator|)
condition|)
name|dGamma
operator|=
literal|0.45455
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalGAMA
operator|)
condition|)
name|dGamma
operator|=
operator|(
name|mng_float
operator|)
name|pData
operator|->
name|iGlobalGamma
operator|/
literal|100000
expr_stmt|;
else|else
name|dGamma
operator|=
name|pData
operator|->
name|dDfltimggamma
expr_stmt|;
if|if
condition|(
name|dGamma
operator|>
literal|0
condition|)
comment|/* ignore gamma=0 */
block|{
name|dGamma
operator|=
name|pData
operator|->
name|dViewgamma
operator|/
operator|(
name|dGamma
operator|*
name|pData
operator|->
name|dDisplaygamma
operator|)
expr_stmt|;
if|if
condition|(
name|dGamma
operator|!=
name|pData
operator|->
name|dLastgamma
condition|)
comment|/* lookup table needs to be computed ? */
block|{
name|mng_int32
name|iX
decl_stmt|;
name|pData
operator|->
name|aGammatab
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|1
init|;
name|iX
operator|<=
literal|255
condition|;
name|iX
operator|++
control|)
name|pData
operator|->
name|aGammatab
index|[
name|iX
index|]
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pow
argument_list|(
name|iX
operator|/
literal|255.0
argument_list|,
name|dGamma
argument_list|)
operator|*
literal|255
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|pData
operator|->
name|dLastgamma
operator|=
name|dGamma
expr_stmt|;
comment|/* keep for next time */
block|}
comment|/* load color-correction routine */
name|pData
operator|->
name|fCorrectrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_correct_gamma_only
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INIT_GAMMA_ONLY
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_GAMMA_ONLY || MNG_FULL_CMS || MNG_APP_CMS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_if
if|#
directive|if
name|defined
argument_list|(
name|MNG_GAMMA_ONLY
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_APP_CMS
argument_list|)
end_if
begin_function
DECL|function|mng_correct_gamma_only
name|mng_retcode
name|mng_correct_gamma_only
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_uint8p
name|pWork
decl_stmt|;
name|mng_int32
name|iX
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CORRECT_GAMMA_ONLY
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pWork
operator|=
name|pData
operator|->
name|pRGBArow
expr_stmt|;
comment|/* address intermediate row */
if|if
condition|(
name|pData
operator|->
name|bIsRGBA16
condition|)
comment|/* 16-bit intermediate row ? */
block|{
comment|/* TODO: 16-bit precision gamma processing */
comment|/* we'll just do the high-order byte for now */
comment|/* convert all samples in the row */
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iRowsamples
condition|;
name|iX
operator|++
control|)
block|{
comment|/* using the precalculated gamma lookup table */
operator|*
name|pWork
operator|=
name|pData
operator|->
name|aGammatab
index|[
operator|*
name|pWork
index|]
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|2
operator|)
operator|=
name|pData
operator|->
name|aGammatab
index|[
operator|*
operator|(
name|pWork
operator|+
literal|2
operator|)
index|]
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|4
operator|)
operator|=
name|pData
operator|->
name|aGammatab
index|[
operator|*
operator|(
name|pWork
operator|+
literal|4
operator|)
index|]
expr_stmt|;
name|pWork
operator|+=
literal|8
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* convert all samples in the row */
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iRowsamples
condition|;
name|iX
operator|++
control|)
block|{
comment|/* using the precalculated gamma lookup table */
operator|*
name|pWork
operator|=
name|pData
operator|->
name|aGammatab
index|[
operator|*
name|pWork
index|]
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|1
operator|)
operator|=
name|pData
operator|->
name|aGammatab
index|[
operator|*
operator|(
name|pWork
operator|+
literal|1
operator|)
index|]
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|2
operator|)
operator|=
name|pData
operator|->
name|aGammatab
index|[
operator|*
operator|(
name|pWork
operator|+
literal|2
operator|)
index|]
expr_stmt|;
name|pWork
operator|+=
literal|4
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CORRECT_GAMMA_ONLY
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_GAMMA_ONLY || MNG_FULL_CMS || MNG_APP_CMS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_APP_CMS
end_ifdef
begin_function
DECL|function|mng_init_app_cms
name|mng_retcode
name|mng_init_app_cms
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_bool
name|bGlobal
parameter_list|,
name|mng_bool
name|bObject
parameter_list|,
name|mng_bool
name|bRetrobj
parameter_list|)
block|{
name|mng_imagep
name|pImage
init|=
name|MNG_NULL
decl_stmt|;
name|mng_imagedatap
name|pBuf
init|=
name|MNG_NULL
decl_stmt|;
name|mng_bool
name|bDone
init|=
name|MNG_FALSE
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INIT_APP_CMS
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bObject
condition|)
comment|/* use object if present ? */
block|{
comment|/* current object ? */
if|if
condition|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
condition|)
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
else|else
comment|/* if not; use object 0 */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
block|}
if|if
condition|(
name|bRetrobj
condition|)
comment|/* retrieving from an object ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pRetrieveobj
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* are we using an object ? */
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* then address the buffer */
if|if
condition|(
operator|(
operator|!
name|pBuf
operator|)
operator|||
operator|(
operator|!
name|pBuf
operator|->
name|bCorrected
operator|)
condition|)
comment|/* is the buffer already corrected ? */
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
if|if
condition|(
operator|(
name|pData
operator|->
name|fProcessiccp
operator|)
operator|&&
operator|(
operator|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasICCP
operator|)
operator|)
operator|||
operator|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalICCP
operator|)
operator|)
operator|)
condition|)
block|{
name|mng_uint32
name|iProfilesize
decl_stmt|;
name|mng_ptr
name|pProfile
decl_stmt|;
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasICCP
operator|)
condition|)
comment|/* get the right profile */
block|{
name|iProfilesize
operator|=
name|pBuf
operator|->
name|iProfilesize
expr_stmt|;
name|pProfile
operator|=
name|pBuf
operator|->
name|pProfile
expr_stmt|;
block|}
else|else
block|{
name|iProfilesize
operator|=
name|pData
operator|->
name|iGlobalProfilesize
expr_stmt|;
name|pProfile
operator|=
name|pData
operator|->
name|pGlobalProfile
expr_stmt|;
block|}
comment|/* inform the app */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessiccp
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|iProfilesize
argument_list|,
name|pProfile
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPCMSERROR
argument_list|)
expr_stmt|;
comment|/* load color-correction routine */
name|pData
operator|->
name|fCorrectrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_correct_app_cms
expr_stmt|;
name|bDone
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|(
name|pData
operator|->
name|fProcesssrgb
operator|)
operator|&&
operator|(
operator|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasSRGB
operator|)
operator|)
operator|||
operator|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalSRGB
operator|)
operator|)
operator|)
condition|)
block|{
name|mng_uint8
name|iIntent
decl_stmt|;
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasSRGB
operator|)
condition|)
comment|/* determine rendering intent */
name|iIntent
operator|=
name|pBuf
operator|->
name|iRenderingintent
expr_stmt|;
else|else
name|iIntent
operator|=
name|pData
operator|->
name|iGlobalRendintent
expr_stmt|;
comment|/* inform the app */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcesssrgb
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|iIntent
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPCMSERROR
argument_list|)
expr_stmt|;
comment|/* load color-correction routine */
name|pData
operator|->
name|fCorrectrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_correct_app_cms
expr_stmt|;
name|bDone
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
if|if
condition|(
operator|(
name|pData
operator|->
name|fProcesschroma
operator|)
operator|&&
operator|(
operator|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasCHRM
operator|)
operator|)
operator|||
operator|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalCHRM
operator|)
operator|)
operator|)
condition|)
block|{
name|mng_uint32
name|iWhitepointx
decl_stmt|,
name|iWhitepointy
decl_stmt|;
name|mng_uint32
name|iPrimaryredx
decl_stmt|,
name|iPrimaryredy
decl_stmt|;
name|mng_uint32
name|iPrimarygreenx
decl_stmt|,
name|iPrimarygreeny
decl_stmt|;
name|mng_uint32
name|iPrimarybluex
decl_stmt|,
name|iPrimarybluey
decl_stmt|;
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasCHRM
operator|)
condition|)
comment|/* local cHRM ? */
block|{
name|iWhitepointx
operator|=
name|pBuf
operator|->
name|iWhitepointx
expr_stmt|;
name|iWhitepointy
operator|=
name|pBuf
operator|->
name|iWhitepointy
expr_stmt|;
name|iPrimaryredx
operator|=
name|pBuf
operator|->
name|iPrimaryredx
expr_stmt|;
name|iPrimaryredy
operator|=
name|pBuf
operator|->
name|iPrimaryredy
expr_stmt|;
name|iPrimarygreenx
operator|=
name|pBuf
operator|->
name|iPrimarygreenx
expr_stmt|;
name|iPrimarygreeny
operator|=
name|pBuf
operator|->
name|iPrimarygreeny
expr_stmt|;
name|iPrimarybluex
operator|=
name|pBuf
operator|->
name|iPrimarybluex
expr_stmt|;
name|iPrimarybluey
operator|=
name|pBuf
operator|->
name|iPrimarybluey
expr_stmt|;
block|}
else|else
block|{
name|iWhitepointx
operator|=
name|pData
operator|->
name|iGlobalWhitepointx
expr_stmt|;
name|iWhitepointy
operator|=
name|pData
operator|->
name|iGlobalWhitepointy
expr_stmt|;
name|iPrimaryredx
operator|=
name|pData
operator|->
name|iGlobalPrimaryredx
expr_stmt|;
name|iPrimaryredy
operator|=
name|pData
operator|->
name|iGlobalPrimaryredy
expr_stmt|;
name|iPrimarygreenx
operator|=
name|pData
operator|->
name|iGlobalPrimarygreenx
expr_stmt|;
name|iPrimarygreeny
operator|=
name|pData
operator|->
name|iGlobalPrimarygreeny
expr_stmt|;
name|iPrimarybluex
operator|=
name|pData
operator|->
name|iGlobalPrimarybluex
expr_stmt|;
name|iPrimarybluey
operator|=
name|pData
operator|->
name|iGlobalPrimarybluey
expr_stmt|;
block|}
comment|/* inform the app */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcesschroma
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|iWhitepointx
argument_list|,
name|iWhitepointy
argument_list|,
name|iPrimaryredx
argument_list|,
name|iPrimaryredy
argument_list|,
name|iPrimarygreenx
argument_list|,
name|iPrimarygreeny
argument_list|,
name|iPrimarybluex
argument_list|,
name|iPrimarybluey
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPCMSERROR
argument_list|)
expr_stmt|;
comment|/* load color-correction routine */
name|pData
operator|->
name|fCorrectrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_correct_app_cms
expr_stmt|;
name|bDone
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|(
name|pData
operator|->
name|fProcessgamma
operator|)
operator|&&
operator|(
operator|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasGAMA
operator|)
operator|)
operator|||
operator|(
operator|(
name|bGlobal
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasglobalGAMA
operator|)
operator|)
operator|)
condition|)
block|{
name|mng_uint32
name|iGamma
decl_stmt|;
if|if
condition|(
operator|(
name|pBuf
operator|)
operator|&&
operator|(
name|pBuf
operator|->
name|bHasGAMA
operator|)
condition|)
comment|/* get the gamma value */
name|iGamma
operator|=
name|pBuf
operator|->
name|iGamma
expr_stmt|;
else|else
name|iGamma
operator|=
name|pData
operator|->
name|iGlobalGamma
expr_stmt|;
comment|/* inform the app */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessgamma
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|iGamma
argument_list|)
condition|)
block|{
comment|/* app wants us to use internal routines ! */
name|iRetcode
operator|=
name|mng_init_gamma_only
argument_list|(
name|pData
argument_list|,
name|bGlobal
argument_list|,
name|bObject
argument_list|,
name|bRetrobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
else|else
block|{
comment|/* load color-correction routine */
name|pData
operator|->
name|fCorrectrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_correct_app_cms
expr_stmt|;
block|}
name|bDone
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bDone
condition|)
comment|/* no color-info at all ? */
block|{
comment|/* then use default image gamma ! */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessgamma
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
call|(
name|mng_uint32
call|)
argument_list|(
operator|(
name|pData
operator|->
name|dDfltimggamma
operator|*
literal|100000
operator|)
operator|+
literal|0.5
argument_list|)
argument_list|)
condition|)
block|{
comment|/* app wants us to use internal routines ! */
name|iRetcode
operator|=
name|mng_init_gamma_only
argument_list|(
name|pData
argument_list|,
name|bGlobal
argument_list|,
name|bObject
argument_list|,
name|bRetrobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
else|else
block|{
comment|/* load color-correction routine */
name|pData
operator|->
name|fCorrectrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_correct_app_cms
expr_stmt|;
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INIT_APP_CMS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_APP_CMS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_APP_CMS
end_ifdef
begin_function
DECL|function|mng_correct_app_cms
name|mng_retcode
name|mng_correct_app_cms
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CORRECT_APP_CMS
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|fProcessarow
condition|)
comment|/* let the app do something with our row */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessarow
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|iRowsamples
argument_list|,
name|pData
operator|->
name|bIsRGBA16
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPCMSERROR
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CORRECT_APP_CMS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_APP_CMS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_DISPLAY_PROCS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* * end of file                                                            * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
end_unit
