begin_unit
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *             For conditions of distribution and use,                    * */
end_comment
begin_comment
comment|/* *                see copyright notice in libmng.h                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * project   : libmng                                                     * */
end_comment
begin_comment
comment|/* * file      : libmng_display.c          copyright (c) 2000-2007 G.Juyn   * */
end_comment
begin_comment
comment|/* * version   : 1.0.10                                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * purpose   : Display management (implementation)                        * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * author    : G.Juyn                                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * comment   : implementation of the display management routines          * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * changes   : 0.5.1 - 05/08/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed strict-ANSI stuff                                * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/11/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added callback error-reporting support                   * */
end_comment
begin_comment
comment|/* *             - fixed frame_delay misalignment                           * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/12/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added sanity check for frozen status                     * */
end_comment
begin_comment
comment|/* *             - changed trace to macro for callback error-reporting      * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/13/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed display_mend to reset state to initial or SAVE   * */
end_comment
begin_comment
comment|/* *             - added eMNGma hack (will be removed in 1.0.0 !!!)         * */
end_comment
begin_comment
comment|/* *             - added TERM animation object pointer (easier reference)   * */
end_comment
begin_comment
comment|/* *             - added process_save& process_seek routines               * */
end_comment
begin_comment
comment|/* *             0.5.1 - 05/14/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added save_state and restore_state for SAVE/SEEK/TERM    * */
end_comment
begin_comment
comment|/* *               processing                                               * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/20/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added JNG support (JHDR/JDAT)                            * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/23/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed problem with DEFI clipping                         * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/30/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added delta-image support (DHDR,PROM,IPNG,IJNG)          * */
end_comment
begin_comment
comment|/* *             0.5.2 - 05/31/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed pointer confusion (contributed by Tim Rowley)      * */
end_comment
begin_comment
comment|/* *             0.5.2 - 06/03/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed makeup for Linux gcc compile                       * */
end_comment
begin_comment
comment|/* *             0.5.2 - 06/05/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for RGB8_A8 canvasstyle                    * */
end_comment
begin_comment
comment|/* *             0.5.2 - 06/09/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed timer-handling to run with Mozilla (Tim Rowley)    * */
end_comment
begin_comment
comment|/* *             0.5.2 - 06/10/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed some compilation-warnings (contrib Jason Morris)   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/12/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed display of stored JNG images                       * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/13/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed problem with BASI-IEND as object 0                 * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed progressive-display processing                   * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/17/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed delta-image processing                           * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/20/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed some minor stuff                                   * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/21/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added speed-modifier to timing routine                   * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/22/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for PPLT chunk processing                  * */
end_comment
begin_comment
comment|/* *             0.5.3 - 06/29/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - swapped refresh parameters                               * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.0 - 06/30/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed refresh parameters to 'x,y,width,height'         * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/07/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - implemented support for freeze/reset/resume& go_xxxx    * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/08/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added support for improved timing                        * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/14/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed EOF processing behavior                          * */
end_comment
begin_comment
comment|/* *             - fixed TERM delay processing                              * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/15/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed freeze& reset processing                          * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed storage of images during mng_read()                * */
end_comment
begin_comment
comment|/* *             - fixed support for mng_display() after mng_read()         * */
end_comment
begin_comment
comment|/* *             0.9.1 - 07/24/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed reading of still-images                            * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.2 - 08/05/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - changed file-prefixes                                    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/07/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B111300 - fixup for improved portability                 * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/21/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed TERM processing delay of 0 msecs                   * */
end_comment
begin_comment
comment|/* *             0.9.3 - 08/26/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added MAGN chunk                                         * */
end_comment
begin_comment
comment|/* *             0.9.3 - 09/10/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed problem with no refresh after TERM                 * */
end_comment
begin_comment
comment|/* *             - fixed DEFI behavior                                      * */
end_comment
begin_comment
comment|/* *             0.9.3 - 09/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed timing& refresh behavior for single PNG/JNG       * */
end_comment
begin_comment
comment|/* *             0.9.3 - 09/19/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - refixed timing& refresh behavior for single PNG/JNG     * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/02/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed timing again (this is getting boring...)           * */
end_comment
begin_comment
comment|/* *             - refixed problem with no refresh after TERM               * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added JDAA chunk                                         * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/17/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed support for bKGD                                   * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/18/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed delta-processing behavior                          * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/19/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added storage for pixel-/alpha-sampledepth for delta's   * */
end_comment
begin_comment
comment|/* *             0.9.3 - 10/27/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed separate read()& display() processing             * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.4 - 10/31/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed possible loop in display_resume() (Thanks Vova!)   * */
end_comment
begin_comment
comment|/* *             0.9.4 - 11/20/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed unwanted repetition in mng_readdisplay()           * */
end_comment
begin_comment
comment|/* *             0.9.4 - 11/24/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - moved restore of object 0 to libmng_display              * */
end_comment
begin_comment
comment|/* *             - added restore of object 0 to TERM processing !!!         * */
end_comment
begin_comment
comment|/* *             - fixed TERM delay processing                              * */
end_comment
begin_comment
comment|/* *             - fixed TERM end processing (count = 0)                    * */
end_comment
begin_comment
comment|/* *             0.9.4 - 12/16/2000 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed mixup of data-& function-pointers (thanks Dimitri)* */
end_comment
begin_comment
comment|/* *             0.9.4 -  1/18/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - removed test filter-methods 1& 65                       * */
end_comment
begin_comment
comment|/* *             - set default level-set for filtertype=64 to all zeroes    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             0.9.5 -  1/20/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed compiler-warnings Mozilla (thanks Tim)             * */
end_comment
begin_comment
comment|/* *             0.9.5 -  1/23/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed timing-problem with switching framing_modes        * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.1 - 02/08/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added MEND processing callback                           * */
end_comment
begin_comment
comment|/* *             1.0.1 - 02/13/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed first FRAM_MODE=4 timing problem                   * */
end_comment
begin_comment
comment|/* *             1.0.1 - 04/21/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed memory-leak for JNGs with alpha (Thanks Gregg!)    * */
end_comment
begin_comment
comment|/* *             - added BGRA8 canvas with premultiplied alpha              * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.2 - 06/25/2001 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed memory-leak with delta-images (Thanks Michael!)    * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.5 - 08/15/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - completed PROM support                                   * */
end_comment
begin_comment
comment|/* *             - completed delta-image support                            * */
end_comment
begin_comment
comment|/* *             1.0.5 - 08/19/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B597134 - libmng pollutes the linker namespace           * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/13/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed read/write of MAGN chunk                           * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/15/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed LOOP iteration=0 special case                      * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/19/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed color-correction for restore-background handling   * */
end_comment
begin_comment
comment|/* *             - optimized restore-background for bKGD cases              * */
end_comment
begin_comment
comment|/* *             - cleaned up some old stuff                                * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/20/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - finished support for BACK image& tiling                 * */
end_comment
begin_comment
comment|/* *             - added support for PAST                                   * */
end_comment
begin_comment
comment|/* *             1.0.5 - 09/22/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added bgrx8 canvas (filler byte)                         * */
end_comment
begin_comment
comment|/* *             1.0.5 - 10/05/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed dropping mix of frozen/unfrozen objects            * */
end_comment
begin_comment
comment|/* *             1.0.5 - 10/07/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added proposed change in handling of TERM-& if-delay    * */
end_comment
begin_comment
comment|/* *             - added another fix for misplaced TERM chunk               * */
end_comment
begin_comment
comment|/* *             - completed support for condition=2 in TERM chunk          * */
end_comment
begin_comment
comment|/* *             1.0.5 - 10/18/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed clipping-problem with BACK tiling (Thanks Sakura!) * */
end_comment
begin_comment
comment|/* *             1.0.5 - 10/20/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed processing for multiple objects in MAGN            * */
end_comment
begin_comment
comment|/* *             - fixed display of visible target of PAST operation        * */
end_comment
begin_comment
comment|/* *             1.0.5 - 10/30/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - modified TERM/MEND processing for max(1, TERM_delay,     * */
end_comment
begin_comment
comment|/* *               interframe_delay)                                        * */
end_comment
begin_comment
comment|/* *             1.0.5 - 11/04/2002 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed layer-& frame-counting during read()              * */
end_comment
begin_comment
comment|/* *             - fixed goframe/golayer/gotime processing                  * */
end_comment
begin_comment
comment|/* *             1.0.5 - 01/19/2003 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - B654627 - fixed SEGV when no gettickcount callback       * */
end_comment
begin_comment
comment|/* *             - B664383 - fixed typo                                     * */
end_comment
begin_comment
comment|/* *             - finalized changes in TERM/final_delay to elected proposal* */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.6 - 05/11/2003 - G. Juyn                               * */
end_comment
begin_comment
comment|/* *             - added conditionals around canvas update routines         * */
end_comment
begin_comment
comment|/* *             1.0.6 - 05/25/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added MNG_SKIPCHUNK_cHNK footprint optimizations         * */
end_comment
begin_comment
comment|/* *             1.0.6 - 07/07/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added conditionals around some JNG-supporting code       * */
end_comment
begin_comment
comment|/* *             - added conditionals around 16-bit supporting code         * */
end_comment
begin_comment
comment|/* *             - reversed some loops to use decrementing counter          * */
end_comment
begin_comment
comment|/* *             - combined init functions into one function                * */
end_comment
begin_comment
comment|/* *             1.0.6 - 07/10/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - replaced nested switches with simple init setup function * */
end_comment
begin_comment
comment|/* *             1.0.6 - 07/29/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added conditionals around PAST chunk support             * */
end_comment
begin_comment
comment|/* *             1.0.6 - 08/17/2003 - G.R-P                                 * */
end_comment
begin_comment
comment|/* *             - added conditionals around non-VLC chunk support          * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.7 - 11/27/2003 - R.A                                   * */
end_comment
begin_comment
comment|/* *             - added CANVAS_RGB565 and CANVAS_BGR565                    * */
end_comment
begin_comment
comment|/* *             1.0.7 - 12/06/2003 - R.A                                   * */
end_comment
begin_comment
comment|/* *             - added CANVAS_RGBA565 and CANVAS_BGRA565                  * */
end_comment
begin_comment
comment|/* *             1.0.7 - 01/25/2004 - J.S                                   * */
end_comment
begin_comment
comment|/* *             - added premultiplied alpha canvas' for RGBA, ARGB, ABGR   * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.8 - 03/31/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - fixed problem with PAST usage where source> dest        * */
end_comment
begin_comment
comment|/* *             1.0.8 - 05/04/2004 - G.R-P.                                * */
end_comment
begin_comment
comment|/* *             - fixed misplaced 16-bit conditionals                      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.9 - 09/18/2004 - G.R-P.                                * */
end_comment
begin_comment
comment|/* *             - revised some SKIPCHUNK conditionals                      * */
end_comment
begin_comment
comment|/* *             1.0.9 - 10/10/2004 - G.R-P.                                * */
end_comment
begin_comment
comment|/* *             - added MNG_NO_1_2_4BIT_SUPPORT                            * */
end_comment
begin_comment
comment|/* *             1.0.9 - 10/14/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added bgr565_a8 canvas-style (thanks to J. Elvander)     * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/11/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - added conditional MNG_OPTIMIZE_DISPLAYCALLS              * */
end_comment
begin_comment
comment|/* *             1.0.9 - 12/20/2004 - G.Juyn                                * */
end_comment
begin_comment
comment|/* *             - cleaned up macro-invocations (thanks to D. Airlie)       * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* *             1.0.10 - 07/06/2005 - G.R-P.                               * */
end_comment
begin_comment
comment|/* *             - added more SKIPCHUNK conditionals                        * */
end_comment
begin_comment
comment|/* *             1.0.10 - 12/28/2005 - G.R-P.                               * */
end_comment
begin_comment
comment|/* *             - added missing SKIPCHUNK_MAGN conditional                 * */
end_comment
begin_comment
comment|/* *             1.0.10 - 03/07/2006 - (thanks to W. Manthey)               * */
end_comment
begin_comment
comment|/* *             - added CANVAS_RGB555 and CANVAS_BGR555                    * */
end_comment
begin_comment
comment|/* *             1.0.10 - 04/08/2007 - G.Juyn                               * */
end_comment
begin_comment
comment|/* *             - fixed several compiler warnings                          * */
end_comment
begin_comment
comment|/* *             1.0.10 - 04/08/2007 - G.Juyn                               * */
end_comment
begin_comment
comment|/* *             - added support for mPNG proposal                          * */
end_comment
begin_comment
comment|/* *             1.0.10 - 04/12/2007 - G.Juyn                               * */
end_comment
begin_comment
comment|/* *             - added support for ANG proposal                           * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_include
include|#
directive|include
file|"libmng.h"
end_include
begin_include
include|#
directive|include
file|"libmng_data.h"
end_include
begin_include
include|#
directive|include
file|"libmng_error.h"
end_include
begin_include
include|#
directive|include
file|"libmng_trace.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|__BORLANDC__
end_ifdef
begin_pragma
pragma|#
directive|pragma
name|hdrstop
end_pragma
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"libmng_chunks.h"
end_include
begin_include
include|#
directive|include
file|"libmng_objects.h"
end_include
begin_include
include|#
directive|include
file|"libmng_object_prc.h"
end_include
begin_include
include|#
directive|include
file|"libmng_memory.h"
end_include
begin_include
include|#
directive|include
file|"libmng_zlib.h"
end_include
begin_include
include|#
directive|include
file|"libmng_jpeg.h"
end_include
begin_include
include|#
directive|include
file|"libmng_cms.h"
end_include
begin_include
include|#
directive|include
file|"libmng_pixels.h"
end_include
begin_include
include|#
directive|include
file|"libmng_display.h"
end_include
begin_if
if|#
directive|if
name|defined
argument_list|(
name|__BORLANDC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|MNG_STRICT_ANSI
argument_list|)
end_if
begin_pragma
pragma|#
directive|pragma
name|option
name|-
name|A
end_pragma
begin_comment
comment|/* force ANSI-C */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_DISPLAY_PROCS
end_ifdef
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|set_delay
name|MNG_LOCAL
name|mng_retcode
name|set_delay
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint32
name|iInterval
parameter_list|)
block|{
if|if
condition|(
operator|!
name|iInterval
condition|)
comment|/* at least 1 msec please! */
name|iInterval
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bRunning
condition|)
comment|/* only when really displaying */
if|if
condition|(
operator|!
name|pData
operator|->
name|fSettimer
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|iInterval
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPTIMERERROR
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DYNAMICMNG
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bDynamic
operator|)
operator|||
operator|(
name|pData
operator|->
name|bRunning
operator|)
condition|)
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|bRunning
condition|)
endif|#
directive|endif
name|pData
operator|->
name|bTimerset
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* and indicate so */
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|calculate_delay
name|MNG_LOCAL
name|mng_uint32
name|calculate_delay
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint32
name|iDelay
parameter_list|)
block|{
name|mng_uint32
name|iTicks
init|=
name|pData
operator|->
name|iTicks
decl_stmt|;
name|mng_uint32
name|iWaitfor
init|=
literal|1
decl_stmt|;
comment|/* default non-MNG delay */
if|if
condition|(
operator|!
name|iTicks
condition|)
comment|/* tick_count not specified ? */
if|if
condition|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_mng
condition|)
name|iTicks
operator|=
literal|1000
expr_stmt|;
if|if
condition|(
name|iTicks
condition|)
block|{
switch|switch
condition|(
name|pData
operator|->
name|iSpeed
condition|)
comment|/* honor speed modifier */
block|{
case|case
name|mng_st_fast
case|:
block|{
name|iWaitfor
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
operator|(
literal|500
operator|*
name|iDelay
operator|)
operator|/
name|iTicks
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|mng_st_slow
case|:
block|{
name|iWaitfor
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
operator|(
literal|3000
operator|*
name|iDelay
operator|)
operator|/
name|iTicks
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|mng_st_slowest
case|:
block|{
name|iWaitfor
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
operator|(
literal|8000
operator|*
name|iDelay
operator|)
operator|/
name|iTicks
argument_list|)
expr_stmt|;
break|break;
block|}
default|default :
block|{
name|iWaitfor
operator|=
call|(
name|mng_uint32
call|)
argument_list|(
operator|(
literal|1000
operator|*
name|iDelay
operator|)
operator|/
name|iTicks
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|iWaitfor
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Progressive display refresh - does the call to the refresh callback    * */
end_comment
begin_comment
comment|/* * and sets the timer to allow the app to perform the actual refresh to   * */
end_comment
begin_comment
comment|/* * the screen (eg. process its main message-loop)                         * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_display_progressive_refresh
name|mng_retcode
name|mng_display_progressive_refresh
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint32
name|iInterval
parameter_list|)
block|{
block|{
comment|/* let the app refresh first ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iUpdatetop
operator|<
name|pData
operator|->
name|iUpdatebottom
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iUpdateleft
operator|<
name|pData
operator|->
name|iUpdateright
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|fRefresh
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|pData
operator|->
name|iUpdateleft
argument_list|,
name|pData
operator|->
name|iUpdatetop
argument_list|,
name|pData
operator|->
name|iUpdateright
operator|-
name|pData
operator|->
name|iUpdateleft
argument_list|,
name|pData
operator|->
name|iUpdatebottom
operator|-
name|pData
operator|->
name|iUpdatetop
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iUpdateleft
operator|=
literal|0
expr_stmt|;
comment|/* reset update-region */
name|pData
operator|->
name|iUpdateright
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iUpdatetop
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iUpdatebottom
operator|=
literal|0
expr_stmt|;
comment|/* reset refreshneeded indicator */
name|pData
operator|->
name|bNeedrefresh
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* interval requested ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bFreezing
operator|)
operator|&&
operator|(
name|iInterval
operator|)
condition|)
block|{
comment|/* setup the timer */
name|mng_retcode
name|iRetcode
init|=
name|set_delay
argument_list|(
name|pData
argument_list|,
name|iInterval
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
block|}
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Generic display routines                                               * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|interframe_delay
name|MNG_LOCAL
name|mng_retcode
name|interframe_delay
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_uint32
name|iWaitfor
init|=
literal|0
decl_stmt|;
name|mng_uint32
name|iInterval
decl_stmt|;
name|mng_uint32
name|iRuninterval
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INTERFRAME_DELAY
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
if|if
condition|(
name|pData
operator|->
name|iFramedelay
operator|>
literal|0
operator|||
name|pData
operator|->
name|bForcedelay
condition|)
comment|/* real delay ? */
block|{
comment|/* let the app refresh first ? */
name|pData
operator|->
name|bForcedelay
operator|=
name|MNG_FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iUpdatetop
operator|<
name|pData
operator|->
name|iUpdatebottom
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iUpdateleft
operator|<
name|pData
operator|->
name|iUpdateright
operator|)
condition|)
if|if
condition|(
operator|!
name|pData
operator|->
name|fRefresh
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|pData
operator|->
name|iUpdateleft
argument_list|,
name|pData
operator|->
name|iUpdatetop
argument_list|,
name|pData
operator|->
name|iUpdateright
operator|-
name|pData
operator|->
name|iUpdateleft
argument_list|,
name|pData
operator|->
name|iUpdatebottom
operator|-
name|pData
operator|->
name|iUpdatetop
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iUpdateleft
operator|=
literal|0
expr_stmt|;
comment|/* reset update-region */
name|pData
operator|->
name|iUpdateright
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iUpdatetop
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iUpdatebottom
operator|=
literal|0
expr_stmt|;
comment|/* reset refreshneeded indicator */
name|pData
operator|->
name|bNeedrefresh
operator|=
name|MNG_FALSE
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_TERM
if|if
condition|(
name|pData
operator|->
name|bOnlyfirstframe
condition|)
comment|/* only processing first frame after TERM ? */
block|{
name|pData
operator|->
name|iFramesafterTERM
operator|++
expr_stmt|;
comment|/* did we do a frame yet ? */
if|if
condition|(
name|pData
operator|->
name|iFramesafterTERM
operator|>
literal|1
condition|)
block|{
comment|/* then that's it; just stop right here ! */
name|pData
operator|->
name|pCurraniobj
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|bRunning
operator|=
name|MNG_FALSE
expr_stmt|;
return|return
name|MNG_NOERROR
return|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|fGettickcount
condition|)
block|{
comment|/* get current tickcount */
name|pData
operator|->
name|iRuntime
operator|=
name|pData
operator|->
name|fGettickcount
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|)
expr_stmt|;
comment|/* calculate interval since last sync-point */
if|if
condition|(
name|pData
operator|->
name|iRuntime
operator|<
name|pData
operator|->
name|iSynctime
condition|)
name|iRuninterval
operator|=
name|pData
operator|->
name|iRuntime
operator|+
operator|~
name|pData
operator|->
name|iSynctime
operator|+
literal|1
expr_stmt|;
else|else
name|iRuninterval
operator|=
name|pData
operator|->
name|iRuntime
operator|-
name|pData
operator|->
name|iSynctime
expr_stmt|;
comment|/* calculate actual run-time */
if|if
condition|(
name|pData
operator|->
name|iRuntime
operator|<
name|pData
operator|->
name|iStarttime
condition|)
name|pData
operator|->
name|iRuntime
operator|=
name|pData
operator|->
name|iRuntime
operator|+
operator|~
name|pData
operator|->
name|iStarttime
operator|+
literal|1
expr_stmt|;
else|else
name|pData
operator|->
name|iRuntime
operator|=
name|pData
operator|->
name|iRuntime
operator|-
name|pData
operator|->
name|iStarttime
expr_stmt|;
block|}
else|else
block|{
name|iRuninterval
operator|=
literal|0
expr_stmt|;
block|}
name|iWaitfor
operator|=
name|calculate_delay
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iFramedelay
argument_list|)
expr_stmt|;
if|if
condition|(
name|iWaitfor
operator|>
name|iRuninterval
condition|)
comment|/* delay necessary ? */
name|iInterval
operator|=
name|iWaitfor
operator|-
name|iRuninterval
expr_stmt|;
else|else
name|iInterval
operator|=
literal|1
expr_stmt|;
comment|/* force app to process messageloop */
comment|/* set the timer ? */
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|||
operator|(
name|pData
operator|->
name|bSearching
operator|)
operator|||
operator|(
name|pData
operator|->
name|bReading
operator|)
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
condition|)
block|{
name|iRetcode
operator|=
name|set_delay
argument_list|(
name|pData
argument_list|,
name|iInterval
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bSkipping
condition|)
comment|/* increase frametime in advance */
name|pData
operator|->
name|iFrametime
operator|=
name|pData
operator|->
name|iFrametime
operator|+
name|iWaitfor
expr_stmt|;
comment|/* setup for next delay */
name|pData
operator|->
name|iFramedelay
operator|=
name|pData
operator|->
name|iNextdelay
expr_stmt|;
name|pData
operator|->
name|iAccumdelay
operator|+=
name|pData
operator|->
name|iFramedelay
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_INTERFRAME_DELAY
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|set_display_routine
name|MNG_LOCAL
name|void
name|set_display_routine
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
comment|/* actively running ? */
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|||
operator|(
name|pData
operator|->
name|bSearching
operator|)
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
condition|)
block|{
switch|switch
condition|(
name|pData
operator|->
name|iCanvasstyle
condition|)
comment|/* determine display routine */
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_RGB8
case|case
name|MNG_CANVAS_RGB8
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_rgb8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_RGBA8
case|case
name|MNG_CANVAS_RGBA8
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_rgba8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_RGBA8_PM
case|case
name|MNG_CANVAS_RGBA8_PM
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_rgba8_pm
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_ARGB8
case|case
name|MNG_CANVAS_ARGB8
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_argb8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_ARGB8_PM
case|case
name|MNG_CANVAS_ARGB8_PM
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_argb8_pm
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_RGB8_A8
case|case
name|MNG_CANVAS_RGB8_A8
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_rgb8_a8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGR8
case|case
name|MNG_CANVAS_BGR8
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_bgr8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGRX8
case|case
name|MNG_CANVAS_BGRX8
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_bgrx8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGRA8
case|case
name|MNG_CANVAS_BGRA8
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_bgra8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGRA8_PM
case|case
name|MNG_CANVAS_BGRA8_PM
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_bgra8_pm
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_ABGR8
case|case
name|MNG_CANVAS_ABGR8
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_abgr8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_ABGR8_PM
case|case
name|MNG_CANVAS_ABGR8_PM
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_abgr8_pm
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_RGB565
case|case
name|MNG_CANVAS_RGB565
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_rgb565
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_RGBA565
case|case
name|MNG_CANVAS_RGBA565
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_rgba565
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGR565
case|case
name|MNG_CANVAS_BGR565
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_bgr565
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGRA565
case|case
name|MNG_CANVAS_BGRA565
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_bgra565
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGR565_A8
case|case
name|MNG_CANVAS_BGR565_A8
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_bgr565_a8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_RGB555
case|case
name|MNG_CANVAS_RGB555
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_rgb555
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGR555
case|case
name|MNG_CANVAS_BGR555
case|:
block|{
name|pData
operator|->
name|fDisplayrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_display_bgr555
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
comment|/*      case MNG_CANVAS_RGB16   : { pData->fDisplayrow = (mng_fptr)mng_display_rgb16;    break; } */
comment|/*      case MNG_CANVAS_RGBA16  : { pData->fDisplayrow = (mng_fptr)mng_display_rgba16;   break; } */
comment|/*      case MNG_CANVAS_ARGB16  : { pData->fDisplayrow = (mng_fptr)mng_display_argb16;   break; } */
comment|/*      case MNG_CANVAS_BGR16   : { pData->fDisplayrow = (mng_fptr)mng_display_bgr16;    break; } */
comment|/*      case MNG_CANVAS_BGRA16  : { pData->fDisplayrow = (mng_fptr)mng_display_bgra16;   break; } */
comment|/*      case MNG_CANVAS_ABGR16  : { pData->fDisplayrow = (mng_fptr)mng_display_abgr16;   break; } */
endif|#
directive|endif
comment|/*      case MNG_CANVAS_INDEX8  : { pData->fDisplayrow = (mng_fptr)mng_display_index8;   break; } */
comment|/*      case MNG_CANVAS_INDEXA8 : { pData->fDisplayrow = (mng_fptr)mng_display_indexa8;  break; } */
comment|/*      case MNG_CANVAS_AINDEX8 : { pData->fDisplayrow = (mng_fptr)mng_display_aindex8;  break; } */
comment|/*      case MNG_CANVAS_GRAY8   : { pData->fDisplayrow = (mng_fptr)mng_display_gray8;    break; } */
comment|/*      case MNG_CANVAS_AGRAY8  : { pData->fDisplayrow = (mng_fptr)mng_display_agray8;   break; } */
comment|/*      case MNG_CANVAS_GRAYA8  : { pData->fDisplayrow = (mng_fptr)mng_display_graya8;   break; } */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
comment|/*      case MNG_CANVAS_GRAY16  : { pData->fDisplayrow = (mng_fptr)mng_display_gray16;   break; } */
comment|/*      case MNG_CANVAS_GRAYA16 : { pData->fDisplayrow = (mng_fptr)mng_display_graya16;  break; } */
comment|/*      case MNG_CANVAS_AGRAY16 : { pData->fDisplayrow = (mng_fptr)mng_display_agray16;  break; } */
endif|#
directive|endif
comment|/*      case MNG_CANVAS_DX15    : { pData->fDisplayrow = (mng_fptr)mng_display_dx15;     break; } */
comment|/*      case MNG_CANVAS_DX16    : { pData->fDisplayrow = (mng_fptr)mng_display_dx16;     break; } */
block|}
block|}
return|return;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|load_bkgdlayer
name|MNG_LOCAL
name|mng_retcode
name|load_bkgdlayer
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_LOAD_BKGDLAYER
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* actively running ? */
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|||
operator|(
name|pData
operator|->
name|bSearching
operator|)
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
condition|)
block|{
name|mng_int32
name|iY
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_bool
name|bColorcorr
init|=
name|MNG_FALSE
decl_stmt|;
comment|/* save values */
name|mng_int32
name|iDestl
init|=
name|pData
operator|->
name|iDestl
decl_stmt|;
name|mng_int32
name|iDestr
init|=
name|pData
operator|->
name|iDestr
decl_stmt|;
name|mng_int32
name|iDestt
init|=
name|pData
operator|->
name|iDestt
decl_stmt|;
name|mng_int32
name|iDestb
init|=
name|pData
operator|->
name|iDestb
decl_stmt|;
name|mng_int32
name|iSourcel
init|=
name|pData
operator|->
name|iSourcel
decl_stmt|;
name|mng_int32
name|iSourcer
init|=
name|pData
operator|->
name|iSourcer
decl_stmt|;
name|mng_int32
name|iSourcet
init|=
name|pData
operator|->
name|iSourcet
decl_stmt|;
name|mng_int32
name|iSourceb
init|=
name|pData
operator|->
name|iSourceb
decl_stmt|;
name|mng_int8
name|iPass
init|=
name|pData
operator|->
name|iPass
decl_stmt|;
name|mng_int32
name|iRow
init|=
name|pData
operator|->
name|iRow
decl_stmt|;
name|mng_int32
name|iRowinc
init|=
name|pData
operator|->
name|iRowinc
decl_stmt|;
name|mng_int32
name|iCol
init|=
name|pData
operator|->
name|iCol
decl_stmt|;
name|mng_int32
name|iColinc
init|=
name|pData
operator|->
name|iColinc
decl_stmt|;
name|mng_int32
name|iRowsamples
init|=
name|pData
operator|->
name|iRowsamples
decl_stmt|;
name|mng_int32
name|iRowsize
init|=
name|pData
operator|->
name|iRowsize
decl_stmt|;
name|mng_uint8p
name|pPrevrow
init|=
name|pData
operator|->
name|pPrevrow
decl_stmt|;
name|mng_uint8p
name|pRGBArow
init|=
name|pData
operator|->
name|pRGBArow
decl_stmt|;
name|mng_bool
name|bIsRGBA16
init|=
name|pData
operator|->
name|bIsRGBA16
decl_stmt|;
name|mng_bool
name|bIsOpaque
init|=
name|pData
operator|->
name|bIsOpaque
decl_stmt|;
name|mng_fptr
name|fCorrectrow
init|=
name|pData
operator|->
name|fCorrectrow
decl_stmt|;
name|mng_fptr
name|fDisplayrow
init|=
name|pData
operator|->
name|fDisplayrow
decl_stmt|;
name|mng_fptr
name|fRetrieverow
init|=
name|pData
operator|->
name|fRetrieverow
decl_stmt|;
name|mng_objectp
name|pCurrentobj
init|=
name|pData
operator|->
name|pCurrentobj
decl_stmt|;
name|mng_objectp
name|pRetrieveobj
init|=
name|pData
operator|->
name|pRetrieveobj
decl_stmt|;
name|pData
operator|->
name|iDestl
operator|=
literal|0
expr_stmt|;
comment|/* determine clipping region */
name|pData
operator|->
name|iDestt
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iDestr
operator|=
name|pData
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|pData
operator|->
name|iHeight
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
if|if
condition|(
name|pData
operator|->
name|bFrameclipping
condition|)
comment|/* frame clipping specified ? */
block|{
name|pData
operator|->
name|iDestl
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestl
argument_list|,
name|pData
operator|->
name|iFrameclipl
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestt
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestt
argument_list|,
name|pData
operator|->
name|iFrameclipt
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestr
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestr
argument_list|,
name|pData
operator|->
name|iFrameclipr
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestb
argument_list|,
name|pData
operator|->
name|iFrameclipb
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* anything to clear ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDestr
operator|>=
name|pData
operator|->
name|iDestl
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDestb
operator|>=
name|pData
operator|->
name|iDestt
operator|)
condition|)
block|{
name|pData
operator|->
name|iPass
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* these are the object's dimensions now */
name|pData
operator|->
name|iRow
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iRowinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iCol
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iColinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iRowsamples
operator|=
name|pData
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iRowsize
operator|=
name|pData
operator|->
name|iRowsamples
operator|<<
literal|2
expr_stmt|;
name|pData
operator|->
name|bIsRGBA16
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* let's keep it simple ! */
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iSourcel
operator|=
literal|0
expr_stmt|;
comment|/* source relative to destination */
name|pData
operator|->
name|iSourcer
operator|=
name|pData
operator|->
name|iDestr
operator|-
name|pData
operator|->
name|iDestl
expr_stmt|;
name|pData
operator|->
name|iSourcet
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iSourceb
operator|=
name|pData
operator|->
name|iDestb
operator|-
name|pData
operator|->
name|iDestt
expr_stmt|;
name|set_display_routine
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* determine display routine */
comment|/* default restore using preset BG color */
name|pData
operator|->
name|fRestbkgdrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_restore_bkgd_bgcolor
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_bKGD
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_png
operator|)
operator|||
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_jng
operator|)
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bUseBKGD
operator|)
condition|)
block|{
comment|/* prefer bKGD in PNG/JNG */
if|if
condition|(
operator|!
name|pData
operator|->
name|pCurrentobj
condition|)
name|pData
operator|->
name|pCurrentobj
operator|=
name|pData
operator|->
name|pObjzero
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
operator|)
operator|->
name|pImgbuf
operator|->
name|bHasBKGD
condition|)
block|{
name|pData
operator|->
name|fRestbkgdrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_restore_bkgd_bkgd
expr_stmt|;
name|bColorcorr
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|fGetbkgdline
condition|)
comment|/* background-canvas-access callback set ? */
block|{
switch|switch
condition|(
name|pData
operator|->
name|iBkgdstyle
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_RGB8
case|case
name|MNG_CANVAS_RGB8
case|:
block|{
name|pData
operator|->
name|fRestbkgdrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_restore_bkgd_rgb8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGR8
case|case
name|MNG_CANVAS_BGR8
case|:
block|{
name|pData
operator|->
name|fRestbkgdrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_restore_bkgd_bgr8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGRX8
case|case
name|MNG_CANVAS_BGRX8
case|:
block|{
name|pData
operator|->
name|fRestbkgdrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_restore_bkgd_bgrx8
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_BGR565
case|case
name|MNG_CANVAS_BGR565
case|:
block|{
name|pData
operator|->
name|fRestbkgdrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_restore_bkgd_bgr565
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCANVAS_RGB565
case|case
name|MNG_CANVAS_RGB565
case|:
block|{
name|pData
operator|->
name|fRestbkgdrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_restore_bkgd_rgb565
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
comment|/*        case MNG_CANVAS_RGB16   : { pData->fRestbkgdrow = (mng_fptr)mng_restore_bkgd_rgb16;   break; } */
comment|/*        case MNG_CANVAS_BGR16   : { pData->fRestbkgdrow = (mng_fptr)mng_restore_bkgd_bgr16;   break; } */
endif|#
directive|endif
comment|/*        case MNG_CANVAS_INDEX8  : { pData->fRestbkgdrow = (mng_fptr)mng_restore_bkgd_index8;  break; } */
comment|/*        case MNG_CANVAS_GRAY8   : { pData->fRestbkgdrow = (mng_fptr)mng_restore_bkgd_gray8;   break; } */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
comment|/*        case MNG_CANVAS_GRAY16  : { pData->fRestbkgdrow = (mng_fptr)mng_restore_bkgd_gray16;  break; } */
endif|#
directive|endif
comment|/*        case MNG_CANVAS_DX15    : { pData->fRestbkgdrow = (mng_fptr)mng_restore_bkgd_dx15;    break; } */
comment|/*        case MNG_CANVAS_DX16    : { pData->fRestbkgdrow = (mng_fptr)mng_restore_bkgd_dx16;    break; } */
block|}
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BACK
if|if
condition|(
name|pData
operator|->
name|bHasBACK
condition|)
block|{
comment|/* background image ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iBACKmandatory
operator|&
literal|0x02
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBACKimageid
operator|)
condition|)
block|{
name|pData
operator|->
name|fRestbkgdrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_restore_bkgd_backcolor
expr_stmt|;
name|bColorcorr
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
elseif|else
comment|/* background color ? */
if|if
condition|(
name|pData
operator|->
name|iBACKmandatory
operator|&
literal|0x01
condition|)
block|{
name|pData
operator|->
name|fRestbkgdrow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_restore_bkgd_backcolor
expr_stmt|;
name|bColorcorr
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|pData
operator|->
name|fCorrectrow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* default no color-correction */
if|if
condition|(
name|bColorcorr
condition|)
comment|/* do we have to do color-correction ? */
block|{
ifdef|#
directive|ifdef
name|MNG_NO_CMS
name|iRetcode
operator|=
name|MNG_NOERROR
expr_stmt|;
else|#
directive|else
if|#
directive|if
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
comment|/* determine color-management routine */
name|iRetcode
operator|=
name|mng_init_full_cms
argument_list|(
name|pData
argument_list|,
name|MNG_TRUE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|MNG_GAMMA_ONLY
argument_list|)
name|iRetcode
operator|=
name|mng_init_gamma_only
argument_list|(
name|pData
argument_list|,
name|MNG_TRUE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|MNG_APP_CMS
argument_list|)
name|iRetcode
operator|=
name|mng_init_app_cms
argument_list|(
name|pData
argument_list|,
name|MNG_TRUE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
endif|#
directive|endif
comment|/* MNG_NO_CMS */
block|}
comment|/* get a temporary row-buffer */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
name|iY
operator|=
name|pData
operator|->
name|iDestt
expr_stmt|;
comment|/* this is where we start */
name|iRetcode
operator|=
name|MNG_NOERROR
expr_stmt|;
comment|/* so far, so good */
while|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|iY
operator|<
name|pData
operator|->
name|iDestb
operator|)
condition|)
block|{
comment|/* restore a background row */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_restbkgdrow
operator|)
name|pData
operator|->
name|fRestbkgdrow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
comment|/* color correction ? */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fCorrectrow
operator|)
condition|)
name|iRetcode
operator|=
operator|(
operator|(
name|mng_correctrow
operator|)
name|pData
operator|->
name|fCorrectrow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* so... display it */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_displayrow
operator|)
name|pData
operator|->
name|fDisplayrow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
name|iRetcode
operator|=
name|mng_next_row
argument_list|(
name|pData
argument_list|)
expr_stmt|;
name|iY
operator|++
expr_stmt|;
comment|/* and next line */
block|}
comment|/* drop the temporary row-buffer */
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
comment|/* cleanup cms stuff */
if|if
condition|(
name|bColorcorr
condition|)
comment|/* did we do color-correction ? */
block|{
name|iRetcode
operator|=
name|mng_clear_cms
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BACK
comment|/* background image ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasBACK
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBACKmandatory
operator|&
literal|0x02
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBACKimageid
operator|)
condition|)
block|{
name|mng_imagep
name|pImage
decl_stmt|;
comment|/* let's find that object then */
name|pData
operator|->
name|pRetrieveobj
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iBACKimageid
argument_list|)
expr_stmt|;
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pRetrieveobj
expr_stmt|;
comment|/* exists, viewable and visible ? */
if|if
condition|(
operator|(
name|pImage
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|bViewable
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|bVisible
operator|)
condition|)
block|{
comment|/* will it fall within the target region ? */
if|if
condition|(
operator|(
name|pImage
operator|->
name|iPosx
operator|<
name|pData
operator|->
name|iDestr
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|iPosy
operator|<
name|pData
operator|->
name|iDestb
operator|)
operator|&&
operator|(
operator|(
name|pData
operator|->
name|iBACKtile
operator|)
operator|||
operator|(
operator|(
name|pImage
operator|->
name|iPosx
operator|+
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
operator|>=
name|pData
operator|->
name|iDestl
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|iPosy
operator|+
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iHeight
operator|>=
name|pData
operator|->
name|iDestt
operator|)
operator|)
operator|)
operator|&&
operator|(
operator|(
operator|!
name|pImage
operator|->
name|bClipped
operator|)
operator|||
operator|(
operator|(
name|pImage
operator|->
name|iClipl
operator|<=
name|pImage
operator|->
name|iClipr
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|iClipt
operator|<=
name|pImage
operator|->
name|iClipb
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|iClipl
operator|<
name|pData
operator|->
name|iDestr
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|iClipr
operator|>=
name|pData
operator|->
name|iDestl
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|iClipt
operator|<
name|pData
operator|->
name|iDestb
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|iClipb
operator|>=
name|pData
operator|->
name|iDestt
operator|)
operator|)
operator|)
condition|)
block|{
comment|/* right; we've got ourselves something to do */
if|if
condition|(
name|pImage
operator|->
name|bClipped
condition|)
comment|/* clip output region with image's clipping region ? */
block|{
if|if
condition|(
name|pImage
operator|->
name|iClipl
operator|>
name|pData
operator|->
name|iDestl
condition|)
name|pData
operator|->
name|iDestl
operator|=
name|pImage
operator|->
name|iClipl
expr_stmt|;
if|if
condition|(
name|pImage
operator|->
name|iClipr
operator|<
name|pData
operator|->
name|iDestr
condition|)
name|pData
operator|->
name|iDestr
operator|=
name|pImage
operator|->
name|iClipr
expr_stmt|;
if|if
condition|(
name|pImage
operator|->
name|iClipt
operator|>
name|pData
operator|->
name|iDestt
condition|)
name|pData
operator|->
name|iDestt
operator|=
name|pImage
operator|->
name|iClipt
expr_stmt|;
if|if
condition|(
name|pImage
operator|->
name|iClipb
operator|<
name|pData
operator|->
name|iDestb
condition|)
name|pData
operator|->
name|iDestb
operator|=
name|pImage
operator|->
name|iClipb
expr_stmt|;
block|}
comment|/* image offset does some extra clipping too ! */
if|if
condition|(
name|pImage
operator|->
name|iPosx
operator|>
name|pData
operator|->
name|iDestl
condition|)
name|pData
operator|->
name|iDestl
operator|=
name|pImage
operator|->
name|iPosx
expr_stmt|;
if|if
condition|(
name|pImage
operator|->
name|iPosy
operator|>
name|pData
operator|->
name|iDestt
condition|)
name|pData
operator|->
name|iDestt
operator|=
name|pImage
operator|->
name|iPosy
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iBACKtile
condition|)
comment|/* without tiling further clipping is needed */
block|{
if|if
condition|(
name|pImage
operator|->
name|iPosx
operator|+
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
operator|<
name|pData
operator|->
name|iDestr
condition|)
name|pData
operator|->
name|iDestr
operator|=
name|pImage
operator|->
name|iPosx
operator|+
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
expr_stmt|;
if|if
condition|(
name|pImage
operator|->
name|iPosy
operator|+
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iHeight
operator|<
name|pData
operator|->
name|iDestb
condition|)
name|pData
operator|->
name|iDestb
operator|=
name|pImage
operator|->
name|iPosy
operator|+
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iHeight
expr_stmt|;
block|}
name|pData
operator|->
name|iSourcel
operator|=
literal|0
expr_stmt|;
comment|/* source relative to destination */
name|pData
operator|->
name|iSourcer
operator|=
name|pData
operator|->
name|iDestr
operator|-
name|pData
operator|->
name|iDestl
expr_stmt|;
name|pData
operator|->
name|iSourcet
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iSourceb
operator|=
name|pData
operator|->
name|iDestb
operator|-
name|pData
operator|->
name|iDestt
expr_stmt|;
comment|/* 16-bit background ? */
ifdef|#
directive|ifdef
name|MNG_NO_16BIT_SUPPORT
name|pData
operator|->
name|bIsRGBA16
operator|=
name|MNG_FALSE
expr_stmt|;
else|#
directive|else
name|pData
operator|->
name|bIsRGBA16
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* let restore routine know the offsets !!! */
name|pData
operator|->
name|iBackimgoffsx
operator|=
name|pImage
operator|->
name|iPosx
expr_stmt|;
name|pData
operator|->
name|iBackimgoffsy
operator|=
name|pImage
operator|->
name|iPosy
expr_stmt|;
name|pData
operator|->
name|iBackimgwidth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iBackimgheight
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iHeight
expr_stmt|;
name|pData
operator|->
name|iRow
operator|=
literal|0
expr_stmt|;
comment|/* start at the top again !! */
comment|/* determine background object retrieval routine */
switch|switch
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iColortype
condition|)
block|{
case|case
literal|0
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasTRNS
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasTRNS
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_idx8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasTRNS
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|6
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|8
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
literal|10
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
literal|12
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|14
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_NO_CMS
name|iRetcode
operator|=
name|MNG_NOERROR
expr_stmt|;
else|#
directive|else
if|#
directive|if
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
comment|/* determine color-management routine */
name|iRetcode
operator|=
name|mng_init_full_cms
argument_list|(
name|pData
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|MNG_GAMMA_ONLY
argument_list|)
name|iRetcode
operator|=
name|mng_init_gamma_only
argument_list|(
name|pData
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|MNG_APP_CMS
argument_list|)
name|iRetcode
operator|=
name|mng_init_app_cms
argument_list|(
name|pData
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
endif|#
directive|endif
comment|/* MNG_NO_CMS */
comment|/* get temporary row-buffers */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pPrevrow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
name|iY
operator|=
name|pData
operator|->
name|iDestt
expr_stmt|;
comment|/* this is where we start */
name|iRetcode
operator|=
name|MNG_NOERROR
expr_stmt|;
comment|/* so far, so good */
while|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|iY
operator|<
name|pData
operator|->
name|iDestb
operator|)
condition|)
block|{
comment|/* restore a background row */
name|iRetcode
operator|=
name|mng_restore_bkgd_backimage
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* color correction ? */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fCorrectrow
operator|)
condition|)
name|iRetcode
operator|=
operator|(
operator|(
name|mng_correctrow
operator|)
name|pData
operator|->
name|fCorrectrow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* so... display it */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_displayrow
operator|)
name|pData
operator|->
name|fDisplayrow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
name|iRetcode
operator|=
name|mng_next_row
argument_list|(
name|pData
argument_list|)
expr_stmt|;
name|iY
operator|++
expr_stmt|;
comment|/* and next line */
block|}
comment|/* drop temporary row-buffers */
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pPrevrow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
comment|/* cleanup cms stuff */
name|iRetcode
operator|=
name|mng_clear_cms
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
endif|#
directive|endif
block|}
block|}
block|}
endif|#
directive|endif
block|}
name|pData
operator|->
name|iDestl
operator|=
name|iDestl
expr_stmt|;
comment|/* restore values */
name|pData
operator|->
name|iDestr
operator|=
name|iDestr
expr_stmt|;
name|pData
operator|->
name|iDestt
operator|=
name|iDestt
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|iDestb
expr_stmt|;
name|pData
operator|->
name|iSourcel
operator|=
name|iSourcel
expr_stmt|;
name|pData
operator|->
name|iSourcer
operator|=
name|iSourcer
expr_stmt|;
name|pData
operator|->
name|iSourcet
operator|=
name|iSourcet
expr_stmt|;
name|pData
operator|->
name|iSourceb
operator|=
name|iSourceb
expr_stmt|;
name|pData
operator|->
name|iPass
operator|=
name|iPass
expr_stmt|;
name|pData
operator|->
name|iRow
operator|=
name|iRow
expr_stmt|;
name|pData
operator|->
name|iRowinc
operator|=
name|iRowinc
expr_stmt|;
name|pData
operator|->
name|iCol
operator|=
name|iCol
expr_stmt|;
name|pData
operator|->
name|iColinc
operator|=
name|iColinc
expr_stmt|;
name|pData
operator|->
name|iRowsamples
operator|=
name|iRowsamples
expr_stmt|;
name|pData
operator|->
name|iRowsize
operator|=
name|iRowsize
expr_stmt|;
name|pData
operator|->
name|pPrevrow
operator|=
name|pPrevrow
expr_stmt|;
name|pData
operator|->
name|pRGBArow
operator|=
name|pRGBArow
expr_stmt|;
name|pData
operator|->
name|bIsRGBA16
operator|=
name|bIsRGBA16
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|bIsOpaque
expr_stmt|;
name|pData
operator|->
name|fCorrectrow
operator|=
name|fCorrectrow
expr_stmt|;
name|pData
operator|->
name|fDisplayrow
operator|=
name|fDisplayrow
expr_stmt|;
name|pData
operator|->
name|fRetrieverow
operator|=
name|fRetrieverow
expr_stmt|;
name|pData
operator|->
name|pCurrentobj
operator|=
name|pCurrentobj
expr_stmt|;
name|pData
operator|->
name|pRetrieveobj
operator|=
name|pRetrieveobj
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_LOAD_BKGDLAYER
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|clear_canvas
name|MNG_LOCAL
name|mng_retcode
name|clear_canvas
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_int32
name|iY
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CLEAR_CANVAS
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|iDestl
operator|=
literal|0
expr_stmt|;
comment|/* clipping region is full canvas! */
name|pData
operator|->
name|iDestt
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iDestr
operator|=
name|pData
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|pData
operator|->
name|iHeight
expr_stmt|;
name|pData
operator|->
name|iSourcel
operator|=
literal|0
expr_stmt|;
comment|/* source is same as destination */
name|pData
operator|->
name|iSourcer
operator|=
name|pData
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iSourcet
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iSourceb
operator|=
name|pData
operator|->
name|iHeight
expr_stmt|;
name|pData
operator|->
name|iPass
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* these are the object's dimensions now */
name|pData
operator|->
name|iRow
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iRowinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iCol
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iColinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iRowsamples
operator|=
name|pData
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iRowsize
operator|=
name|pData
operator|->
name|iRowsamples
operator|<<
literal|2
expr_stmt|;
name|pData
operator|->
name|bIsRGBA16
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* let's keep it simple ! */
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
name|set_display_routine
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* determine display routine */
comment|/* get a temporary row-buffer */
comment|/* it's transparent black by default!! */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
name|iY
operator|=
name|pData
operator|->
name|iDestt
expr_stmt|;
comment|/* this is where we start */
name|iRetcode
operator|=
name|MNG_NOERROR
expr_stmt|;
comment|/* so far, so good */
while|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|iY
operator|<
name|pData
operator|->
name|iDestb
operator|)
condition|)
block|{
comment|/* clear a row then */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_displayrow
operator|)
name|pData
operator|->
name|fDisplayrow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
name|iRetcode
operator|=
name|mng_next_row
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* adjust variables for next row */
name|iY
operator|++
expr_stmt|;
comment|/* and next line */
block|}
comment|/* drop the temporary row-buffer */
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_CLEAR_CANVAS
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|next_frame
name|MNG_LOCAL
name|mng_retcode
name|next_frame
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_uint8
name|iFramemode
parameter_list|,
name|mng_uint8
name|iChangedelay
parameter_list|,
name|mng_uint32
name|iDelay
parameter_list|,
name|mng_uint8
name|iChangetimeout
parameter_list|,
name|mng_uint32
name|iTimeout
parameter_list|,
name|mng_uint8
name|iChangeclipping
parameter_list|,
name|mng_uint8
name|iCliptype
parameter_list|,
name|mng_int32
name|iClipl
parameter_list|,
name|mng_int32
name|iClipr
parameter_list|,
name|mng_int32
name|iClipt
parameter_list|,
name|mng_int32
name|iClipb
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_NEXT_FRAME
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* no previous break here ? */
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
name|mng_uint8
name|iOldmode
init|=
name|pData
operator|->
name|iFramemode
decl_stmt|;
comment|/* interframe delay required ? */
if|if
condition|(
operator|(
name|iOldmode
operator|==
literal|2
operator|)
operator|||
operator|(
name|iOldmode
operator|==
literal|4
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pData
operator|->
name|iFrameseq
operator|)
operator|&&
operator|(
name|iFramemode
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|iFramemode
operator|!=
literal|3
operator|)
condition|)
name|iRetcode
operator|=
name|interframe_delay
argument_list|(
name|pData
argument_list|)
expr_stmt|;
else|else
name|pData
operator|->
name|iFramedelay
operator|=
name|pData
operator|->
name|iNextdelay
expr_stmt|;
block|}
else|else
block|{
comment|/* delay before inserting background layer? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bFramedone
operator|)
operator|&&
operator|(
name|iFramemode
operator|==
literal|4
operator|)
condition|)
name|iRetcode
operator|=
name|interframe_delay
argument_list|(
name|pData
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* now we'll assume we're in the next frame! */
if|if
condition|(
name|iFramemode
condition|)
comment|/* save the new framing mode ? */
block|{
name|pData
operator|->
name|iFRAMmode
operator|=
name|iFramemode
expr_stmt|;
name|pData
operator|->
name|iFramemode
operator|=
name|iFramemode
expr_stmt|;
block|}
else|else
comment|/* reload default */
name|pData
operator|->
name|iFramemode
operator|=
name|pData
operator|->
name|iFRAMmode
expr_stmt|;
if|if
condition|(
name|iChangedelay
condition|)
comment|/* delay changed ? */
block|{
name|pData
operator|->
name|iNextdelay
operator|=
name|iDelay
expr_stmt|;
comment|/* for *after* next subframe */
if|if
condition|(
operator|(
name|iOldmode
operator|==
literal|2
operator|)
operator|||
operator|(
name|iOldmode
operator|==
literal|4
operator|)
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
name|pData
operator|->
name|iFRAMdelay
expr_stmt|;
if|if
condition|(
name|iChangedelay
operator|==
literal|2
condition|)
comment|/* also overall ? */
name|pData
operator|->
name|iFRAMdelay
operator|=
name|iDelay
expr_stmt|;
block|}
else|else
block|{
comment|/* reload default */
name|pData
operator|->
name|iNextdelay
operator|=
name|pData
operator|->
name|iFRAMdelay
expr_stmt|;
block|}
if|if
condition|(
name|iChangetimeout
condition|)
comment|/* timeout changed ? */
block|{
comment|/* for next subframe */
name|pData
operator|->
name|iFrametimeout
operator|=
name|iTimeout
expr_stmt|;
if|if
condition|(
operator|(
name|iChangetimeout
operator|==
literal|2
operator|)
operator|||
comment|/* also overall ? */
operator|(
name|iChangetimeout
operator|==
literal|4
operator|)
operator|||
operator|(
name|iChangetimeout
operator|==
literal|6
operator|)
operator|||
operator|(
name|iChangetimeout
operator|==
literal|8
operator|)
condition|)
name|pData
operator|->
name|iFRAMtimeout
operator|=
name|iTimeout
expr_stmt|;
block|}
else|else
comment|/* reload default */
name|pData
operator|->
name|iFrametimeout
operator|=
name|pData
operator|->
name|iFRAMtimeout
expr_stmt|;
if|if
condition|(
name|iChangeclipping
condition|)
comment|/* clipping changed ? */
block|{
name|pData
operator|->
name|bFrameclipping
operator|=
name|MNG_TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|iCliptype
condition|)
comment|/* absolute ? */
block|{
name|pData
operator|->
name|iFrameclipl
operator|=
name|iClipl
expr_stmt|;
name|pData
operator|->
name|iFrameclipr
operator|=
name|iClipr
expr_stmt|;
name|pData
operator|->
name|iFrameclipt
operator|=
name|iClipt
expr_stmt|;
name|pData
operator|->
name|iFrameclipb
operator|=
name|iClipb
expr_stmt|;
block|}
else|else
comment|/* relative */
block|{
name|pData
operator|->
name|iFrameclipl
operator|=
name|pData
operator|->
name|iFrameclipl
operator|+
name|iClipl
expr_stmt|;
name|pData
operator|->
name|iFrameclipr
operator|=
name|pData
operator|->
name|iFrameclipr
operator|+
name|iClipr
expr_stmt|;
name|pData
operator|->
name|iFrameclipt
operator|=
name|pData
operator|->
name|iFrameclipt
operator|+
name|iClipt
expr_stmt|;
name|pData
operator|->
name|iFrameclipb
operator|=
name|pData
operator|->
name|iFrameclipb
operator|+
name|iClipb
expr_stmt|;
block|}
if|if
condition|(
name|iChangeclipping
operator|==
literal|2
condition|)
comment|/* also overall ? */
block|{
name|pData
operator|->
name|bFRAMclipping
operator|=
name|MNG_TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|iCliptype
condition|)
comment|/* absolute ? */
block|{
name|pData
operator|->
name|iFRAMclipl
operator|=
name|iClipl
expr_stmt|;
name|pData
operator|->
name|iFRAMclipr
operator|=
name|iClipr
expr_stmt|;
name|pData
operator|->
name|iFRAMclipt
operator|=
name|iClipt
expr_stmt|;
name|pData
operator|->
name|iFRAMclipb
operator|=
name|iClipb
expr_stmt|;
block|}
else|else
comment|/* relative */
block|{
name|pData
operator|->
name|iFRAMclipl
operator|=
name|pData
operator|->
name|iFRAMclipl
operator|+
name|iClipl
expr_stmt|;
name|pData
operator|->
name|iFRAMclipr
operator|=
name|pData
operator|->
name|iFRAMclipr
operator|+
name|iClipr
expr_stmt|;
name|pData
operator|->
name|iFRAMclipt
operator|=
name|pData
operator|->
name|iFRAMclipt
operator|+
name|iClipt
expr_stmt|;
name|pData
operator|->
name|iFRAMclipb
operator|=
name|pData
operator|->
name|iFRAMclipb
operator|+
name|iClipb
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* reload defaults */
name|pData
operator|->
name|bFrameclipping
operator|=
name|pData
operator|->
name|bFRAMclipping
expr_stmt|;
name|pData
operator|->
name|iFrameclipl
operator|=
name|pData
operator|->
name|iFRAMclipl
expr_stmt|;
name|pData
operator|->
name|iFrameclipr
operator|=
name|pData
operator|->
name|iFRAMclipr
expr_stmt|;
name|pData
operator|->
name|iFrameclipt
operator|=
name|pData
operator|->
name|iFRAMclipt
expr_stmt|;
name|pData
operator|->
name|iFrameclipb
operator|=
name|pData
operator|->
name|iFRAMclipb
expr_stmt|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer still off ? */
block|{
if|if
condition|(
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
operator|(
name|pData
operator|->
name|iFramemode
operator|==
literal|4
operator|)
operator|||
comment|/* insert background layer after a new frame */
endif|#
directive|endif
operator|(
operator|!
name|pData
operator|->
name|iLayerseq
operator|)
condition|)
comment|/* and certainly before the very first layer */
name|iRetcode
operator|=
name|load_bkgdlayer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
name|pData
operator|->
name|iFrameseq
operator|++
expr_stmt|;
comment|/* count the frame ! */
name|pData
operator|->
name|bFramedone
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* and indicate we've done one */
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_NEXT_FRAME
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|next_layer
name|MNG_LOCAL
name|mng_retcode
name|next_layer
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_imagep
name|pImage
decl_stmt|;
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_NEXT_LAYER
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
if|if
condition|(
operator|!
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* no previous break here ? */
block|{
comment|/* interframe delay required ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_mng
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iLayerseq
operator|)
operator|&&
operator|(
operator|(
name|pData
operator|->
name|iFramemode
operator|==
literal|1
operator|)
operator|||
operator|(
name|pData
operator|->
name|iFramemode
operator|==
literal|3
operator|)
operator|)
condition|)
name|iRetcode
operator|=
name|interframe_delay
argument_list|(
name|pData
argument_list|)
expr_stmt|;
else|else
name|pData
operator|->
name|iFramedelay
operator|=
name|pData
operator|->
name|iNextdelay
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer still off ? */
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iLayerseq
condition|)
comment|/* restore background for the very first layer ? */
block|{
comment|/* wait till IDAT/JDAT for PNGs& JNGs !!! */
if|if
condition|(
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_png
operator|)
operator|||
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_jng
operator|)
condition|)
name|pData
operator|->
name|bRestorebkgd
operator|=
name|MNG_TRUE
expr_stmt|;
else|else
block|{
comment|/* for MNG we do it right away */
name|iRetcode
operator|=
name|load_bkgdlayer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iLayerseq
operator|++
expr_stmt|;
comment|/* and it counts as a layer then ! */
block|}
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
elseif|else
if|if
condition|(
name|pData
operator|->
name|iFramemode
operator|==
literal|3
condition|)
comment|/* restore background for each layer ? */
name|iRetcode
operator|=
name|load_bkgdlayer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* processing a delta-image ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
expr_stmt|;
else|else
endif|#
directive|endif
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
expr_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* not an active object ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* determine display rectangle */
name|pData
operator|->
name|iDestl
operator|=
name|MAX_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
literal|0
argument_list|,
name|pImage
operator|->
name|iPosx
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestt
operator|=
name|MAX_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
literal|0
argument_list|,
name|pImage
operator|->
name|iPosy
argument_list|)
expr_stmt|;
comment|/* is it a valid buffer ? */
if|if
condition|(
operator|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iHeight
operator|)
condition|)
block|{
name|pData
operator|->
name|iDestr
operator|=
name|MIN_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
name|pData
operator|->
name|iWidth
argument_list|,
name|pImage
operator|->
name|iPosx
operator|+
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|MIN_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
name|pData
operator|->
name|iHeight
argument_list|,
name|pImage
operator|->
name|iPosy
operator|+
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iHeight
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* it's a single image ! */
block|{
name|pData
operator|->
name|iDestr
operator|=
name|MIN_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
name|pData
operator|->
name|iWidth
argument_list|,
operator|(
name|mng_int32
operator|)
name|pData
operator|->
name|iDatawidth
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|MIN_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
name|pData
operator|->
name|iHeight
argument_list|,
operator|(
name|mng_int32
operator|)
name|pData
operator|->
name|iDataheight
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
if|if
condition|(
name|pData
operator|->
name|bFrameclipping
condition|)
comment|/* frame clipping specified ? */
block|{
name|pData
operator|->
name|iDestl
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestl
argument_list|,
name|pData
operator|->
name|iFrameclipl
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestt
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestt
argument_list|,
name|pData
operator|->
name|iFrameclipt
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestr
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestr
argument_list|,
name|pData
operator|->
name|iFrameclipr
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestb
argument_list|,
name|pData
operator|->
name|iFrameclipb
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|pImage
operator|->
name|bClipped
condition|)
comment|/* is the image clipped itself ? */
block|{
name|pData
operator|->
name|iDestl
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestl
argument_list|,
name|pImage
operator|->
name|iClipl
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestt
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestt
argument_list|,
name|pImage
operator|->
name|iClipt
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestr
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestr
argument_list|,
name|pImage
operator|->
name|iClipr
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestb
argument_list|,
name|pImage
operator|->
name|iClipb
argument_list|)
expr_stmt|;
block|}
comment|/* determine source starting point */
name|pData
operator|->
name|iSourcel
operator|=
name|MAX_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
literal|0
argument_list|,
name|pData
operator|->
name|iDestl
operator|-
name|pImage
operator|->
name|iPosx
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iSourcet
operator|=
name|MAX_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
literal|0
argument_list|,
name|pData
operator|->
name|iDestt
operator|-
name|pImage
operator|->
name|iPosy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iHeight
operator|)
condition|)
block|{
comment|/* and maximum size  */
name|pData
operator|->
name|iSourcer
operator|=
name|MIN_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
argument_list|,
name|pData
operator|->
name|iSourcel
operator|+
name|pData
operator|->
name|iDestr
operator|-
name|pData
operator|->
name|iDestl
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iSourceb
operator|=
name|MIN_COORD
argument_list|(
operator|(
name|mng_int32
operator|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|iHeight
argument_list|,
name|pData
operator|->
name|iSourcet
operator|+
name|pData
operator|->
name|iDestb
operator|-
name|pData
operator|->
name|iDestt
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* it's a single image ! */
block|{
name|pData
operator|->
name|iSourcer
operator|=
name|pData
operator|->
name|iSourcel
operator|+
name|pData
operator|->
name|iDestr
operator|-
name|pData
operator|->
name|iDestl
expr_stmt|;
name|pData
operator|->
name|iSourceb
operator|=
name|pData
operator|->
name|iSourcet
operator|+
name|pData
operator|->
name|iDestb
operator|-
name|pData
operator|->
name|iDestt
expr_stmt|;
block|}
name|pData
operator|->
name|iLayerseq
operator|++
expr_stmt|;
comment|/* count the layer ! */
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_NEXT_LAYER
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_display_image
name|mng_retcode
name|mng_display_image
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_imagep
name|pImage
parameter_list|,
name|mng_bool
name|bLayeradvanced
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_DISPLAY_IMAGE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* actively running ? */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|||
operator|(
name|pData
operator|->
name|bSearching
operator|)
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
condition|)
block|{
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|iBreakpoint
operator|)
operator|&&
comment|/* needs magnification ? */
operator|(
operator|(
name|pImage
operator|->
name|iMAGN_MethodX
operator|)
operator|||
operator|(
name|pImage
operator|->
name|iMAGN_MethodY
operator|)
operator|)
condition|)
block|{
name|iRetcode
operator|=
name|mng_magnify_imageobject
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
endif|#
directive|endif
name|pData
operator|->
name|pRetrieveobj
operator|=
name|pImage
expr_stmt|;
comment|/* so retrieve-row and color-correction can find it */
if|if
condition|(
operator|!
name|bLayeradvanced
condition|)
comment|/* need to advance the layer ? */
block|{
name|mng_imagep
name|pSave
init|=
name|pData
operator|->
name|pCurrentobj
decl_stmt|;
name|pData
operator|->
name|pCurrentobj
operator|=
name|pImage
expr_stmt|;
name|next_layer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* advance to next layer */
name|pData
operator|->
name|pCurrentobj
operator|=
name|pSave
expr_stmt|;
block|}
comment|/* need to restore the background ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bRestorebkgd
operator|)
condition|)
block|{
name|mng_imagep
name|pSave
init|=
name|pData
operator|->
name|pCurrentobj
decl_stmt|;
name|pData
operator|->
name|pCurrentobj
operator|=
name|pImage
expr_stmt|;
name|pData
operator|->
name|bRestorebkgd
operator|=
name|MNG_FALSE
expr_stmt|;
name|iRetcode
operator|=
name|load_bkgdlayer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
name|pData
operator|->
name|pCurrentobj
operator|=
name|pSave
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
name|pData
operator|->
name|iLayerseq
operator|++
expr_stmt|;
comment|/* and it counts as a layer then ! */
block|}
comment|/* actively running ? */
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|||
operator|(
name|pData
operator|->
name|bSearching
operator|)
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
comment|/* all systems still go ? */
block|{
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* let's make absolutely sure... */
comment|/* anything to display ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDestr
operator|>=
name|pData
operator|->
name|iDestl
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDestb
operator|>=
name|pData
operator|->
name|iDestt
operator|)
condition|)
block|{
name|mng_int32
name|iY
decl_stmt|;
name|set_display_routine
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* determine display routine */
comment|/* and image-buffer retrieval routine */
switch|switch
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iColortype
condition|)
block|{
case|case
literal|0
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasTRNS
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasTRNS
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_idx8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pImage
operator|->
name|pImgbuf
operator|->
name|bHasTRNS
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|6
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|8
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
literal|10
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
literal|12
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|14
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
block|}
name|pData
operator|->
name|iPass
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* these are the object's dimensions now */
name|pData
operator|->
name|iRow
operator|=
name|pData
operator|->
name|iSourcet
expr_stmt|;
name|pData
operator|->
name|iRowinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iCol
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iColinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iRowsamples
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iRowsize
operator|=
name|pData
operator|->
name|iRowsamples
operator|<<
literal|2
expr_stmt|;
name|pData
operator|->
name|bIsRGBA16
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* adjust for 16-bit object ? */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
condition|)
block|{
name|pData
operator|->
name|bIsRGBA16
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iRowsize
operator|=
name|pData
operator|->
name|iRowsamples
operator|<<
literal|3
expr_stmt|;
block|}
endif|#
directive|endif
name|pData
operator|->
name|fCorrectrow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* default no color-correction */
ifdef|#
directive|ifdef
name|MNG_NO_CMS
name|iRetcode
operator|=
name|MNG_NOERROR
expr_stmt|;
else|#
directive|else
if|#
directive|if
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
comment|/* determine color-management routine */
name|iRetcode
operator|=
name|mng_init_full_cms
argument_list|(
name|pData
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|MNG_GAMMA_ONLY
argument_list|)
name|iRetcode
operator|=
name|mng_init_gamma_only
argument_list|(
name|pData
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|MNG_APP_CMS
argument_list|)
name|iRetcode
operator|=
name|mng_init_app_cms
argument_list|(
name|pData
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
endif|#
directive|endif
comment|/* MNG_NO_CMS */
comment|/* get a temporary row-buffer */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
name|iY
operator|=
name|pData
operator|->
name|iSourcet
expr_stmt|;
comment|/* this is where we start */
while|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|iY
operator|<
name|pData
operator|->
name|iSourceb
operator|)
condition|)
block|{
comment|/* get a row */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_retrieverow
operator|)
name|pData
operator|->
name|fRetrieverow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
comment|/* color correction ? */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fCorrectrow
operator|)
condition|)
name|iRetcode
operator|=
operator|(
operator|(
name|mng_correctrow
operator|)
name|pData
operator|->
name|fCorrectrow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* so... display it */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_displayrow
operator|)
name|pData
operator|->
name|fDisplayrow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* adjust variables for next row */
name|iRetcode
operator|=
name|mng_next_row
argument_list|(
name|pData
argument_list|)
expr_stmt|;
name|iY
operator|++
expr_stmt|;
comment|/* and next line */
block|}
comment|/* drop the temporary row-buffer */
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pData
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
comment|/* cleanup cms stuff */
name|iRetcode
operator|=
name|mng_clear_cms
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
endif|#
directive|endif
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_DISPLAY_IMAGE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
comment|/* whehehe, this is good ! */
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_function
DECL|function|mng_execute_delta_image
name|mng_retcode
name|mng_execute_delta_image
parameter_list|(
name|mng_datap
name|pData
parameter_list|,
name|mng_imagep
name|pTarget
parameter_list|,
name|mng_imagep
name|pDelta
parameter_list|)
block|{
name|mng_imagedatap
name|pBuftarget
init|=
name|pTarget
operator|->
name|pImgbuf
decl_stmt|;
name|mng_imagedatap
name|pBufdelta
init|=
name|pDelta
operator|->
name|pImgbuf
decl_stmt|;
name|mng_uint32
name|iY
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_ptr
name|pSaveRGBA
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_EXECUTE_DELTA_IMAGE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* actively running ? */
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|||
operator|(
name|pData
operator|->
name|bSearching
operator|)
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
condition|)
block|{
if|if
condition|(
name|pBufdelta
operator|->
name|bHasPLTE
condition|)
comment|/* palette in delta ? */
block|{
name|mng_uint32
name|iX
decl_stmt|;
comment|/* new palette larger than old one ? */
if|if
condition|(
operator|(
operator|!
name|pBuftarget
operator|->
name|bHasPLTE
operator|)
operator|||
operator|(
name|pBuftarget
operator|->
name|iPLTEcount
operator|<
name|pBufdelta
operator|->
name|iPLTEcount
operator|)
condition|)
name|pBuftarget
operator|->
name|iPLTEcount
operator|=
name|pBufdelta
operator|->
name|iPLTEcount
expr_stmt|;
comment|/* it's definitely got a PLTE now */
name|pBuftarget
operator|->
name|bHasPLTE
operator|=
name|MNG_TRUE
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pBufdelta
operator|->
name|iPLTEcount
condition|;
name|iX
operator|++
control|)
block|{
name|pBuftarget
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
name|pBufdelta
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
expr_stmt|;
name|pBuftarget
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
name|pBufdelta
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
expr_stmt|;
name|pBuftarget
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
name|pBufdelta
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pBufdelta
operator|->
name|bHasTRNS
condition|)
comment|/* cheap transparency in delta ? */
block|{
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
comment|/* drop it into the target */
block|{
case|case
literal|0
case|:
block|{
comment|/* gray */
name|pBuftarget
operator|->
name|iTRNSgray
operator|=
name|pBufdelta
operator|->
name|iTRNSgray
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNSred
operator|=
literal|0
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNSgreen
operator|=
literal|0
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNSblue
operator|=
literal|0
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNScount
operator|=
literal|0
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
name|pBuftarget
operator|->
name|iTRNSgray
operator|=
literal|0
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNSred
operator|=
name|pBufdelta
operator|->
name|iTRNSred
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNSgreen
operator|=
name|pBufdelta
operator|->
name|iTRNSgreen
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNSblue
operator|=
name|pBufdelta
operator|->
name|iTRNSblue
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNScount
operator|=
literal|0
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
name|pBuftarget
operator|->
name|iTRNSgray
operator|=
literal|0
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNSred
operator|=
literal|0
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNSgreen
operator|=
literal|0
expr_stmt|;
name|pBuftarget
operator|->
name|iTRNSblue
operator|=
literal|0
expr_stmt|;
comment|/* existing range smaller than new one ? */
if|if
condition|(
operator|(
operator|!
name|pBuftarget
operator|->
name|bHasTRNS
operator|)
operator|||
operator|(
name|pBuftarget
operator|->
name|iTRNScount
operator|<
name|pBufdelta
operator|->
name|iTRNScount
operator|)
condition|)
name|pBuftarget
operator|->
name|iTRNScount
operator|=
name|pBufdelta
operator|->
name|iTRNScount
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pBuftarget
operator|->
name|aTRNSentries
argument_list|,
name|pBufdelta
operator|->
name|aTRNSentries
argument_list|,
name|pBufdelta
operator|->
name|iTRNScount
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|pBuftarget
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* tell it it's got a tRNS now */
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_bKGD
if|if
condition|(
name|pBufdelta
operator|->
name|bHasBKGD
condition|)
comment|/* bkgd in source ? */
block|{
comment|/* drop it onto the target */
name|pBuftarget
operator|->
name|bHasBKGD
operator|=
name|MNG_TRUE
expr_stmt|;
name|pBuftarget
operator|->
name|iBKGDindex
operator|=
name|pBufdelta
operator|->
name|iBKGDindex
expr_stmt|;
name|pBuftarget
operator|->
name|iBKGDgray
operator|=
name|pBufdelta
operator|->
name|iBKGDgray
expr_stmt|;
name|pBuftarget
operator|->
name|iBKGDred
operator|=
name|pBufdelta
operator|->
name|iBKGDred
expr_stmt|;
name|pBuftarget
operator|->
name|iBKGDgreen
operator|=
name|pBufdelta
operator|->
name|iBKGDgreen
expr_stmt|;
name|pBuftarget
operator|->
name|iBKGDblue
operator|=
name|pBufdelta
operator|->
name|iBKGDblue
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|pBufdelta
operator|->
name|bHasGAMA
condition|)
comment|/* gamma in source ? */
block|{
name|pBuftarget
operator|->
name|bHasGAMA
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* drop it onto the target */
name|pBuftarget
operator|->
name|iGamma
operator|=
name|pBufdelta
operator|->
name|iGamma
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
if|if
condition|(
name|pBufdelta
operator|->
name|bHasCHRM
condition|)
comment|/* chroma in delta ? */
block|{
comment|/* drop it onto the target */
name|pBuftarget
operator|->
name|bHasCHRM
operator|=
name|MNG_TRUE
expr_stmt|;
name|pBuftarget
operator|->
name|iWhitepointx
operator|=
name|pBufdelta
operator|->
name|iWhitepointx
expr_stmt|;
name|pBuftarget
operator|->
name|iWhitepointy
operator|=
name|pBufdelta
operator|->
name|iWhitepointy
expr_stmt|;
name|pBuftarget
operator|->
name|iPrimaryredx
operator|=
name|pBufdelta
operator|->
name|iPrimaryredx
expr_stmt|;
name|pBuftarget
operator|->
name|iPrimaryredy
operator|=
name|pBufdelta
operator|->
name|iPrimaryredy
expr_stmt|;
name|pBuftarget
operator|->
name|iPrimarygreenx
operator|=
name|pBufdelta
operator|->
name|iPrimarygreenx
expr_stmt|;
name|pBuftarget
operator|->
name|iPrimarygreeny
operator|=
name|pBufdelta
operator|->
name|iPrimarygreeny
expr_stmt|;
name|pBuftarget
operator|->
name|iPrimarybluex
operator|=
name|pBufdelta
operator|->
name|iPrimarybluex
expr_stmt|;
name|pBuftarget
operator|->
name|iPrimarybluey
operator|=
name|pBufdelta
operator|->
name|iPrimarybluey
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sRGB
if|if
condition|(
name|pBufdelta
operator|->
name|bHasSRGB
condition|)
comment|/* sRGB in delta ? */
block|{
comment|/* drop it onto the target */
name|pBuftarget
operator|->
name|bHasSRGB
operator|=
name|MNG_TRUE
expr_stmt|;
name|pBuftarget
operator|->
name|iRenderingintent
operator|=
name|pBufdelta
operator|->
name|iRenderingintent
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
if|if
condition|(
name|pBufdelta
operator|->
name|bHasICCP
condition|)
comment|/* ICC profile in delta ? */
block|{
name|pBuftarget
operator|->
name|bHasICCP
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* drop it onto the target */
if|if
condition|(
name|pBuftarget
operator|->
name|pProfile
condition|)
comment|/* profile existed ? */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pBuftarget
operator|->
name|pProfile
argument_list|,
name|pBuftarget
operator|->
name|iProfilesize
argument_list|)
expr_stmt|;
comment|/* allocate a buffer& copy it */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pBuftarget
operator|->
name|pProfile
argument_list|,
name|pBufdelta
operator|->
name|iProfilesize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pBuftarget
operator|->
name|pProfile
argument_list|,
name|pBufdelta
operator|->
name|pProfile
argument_list|,
name|pBufdelta
operator|->
name|iProfilesize
argument_list|)
expr_stmt|;
comment|/* store its length as well */
name|pBuftarget
operator|->
name|iProfilesize
operator|=
name|pBufdelta
operator|->
name|iProfilesize
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* need to execute delta pixels ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bDeltaimmediate
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDeltatype
operator|!=
name|MNG_DELTATYPE_NOCHANGE
operator|)
condition|)
block|{
name|pData
operator|->
name|fScalerow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* not needed by default */
switch|switch
condition|(
name|pBufdelta
operator|->
name|iBitdepth
condition|)
comment|/* determine scaling routine */
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g1_g2
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g1_g4
expr_stmt|;
break|break;
block|}
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g1_g8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g1_g16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|2
case|:
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g2_g1
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g2_g4
expr_stmt|;
break|break;
block|}
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g2_g8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g2_g16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g4_g1
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g4_g2
expr_stmt|;
break|break;
block|}
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g4_g8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g4_g16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
switch|switch
condition|(
name|pBufdelta
operator|->
name|iColortype
condition|)
block|{
case|case
literal|0
case|:
empty_stmt|;
case|case
literal|3
case|:
empty_stmt|;
case|case
literal|8
case|:
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g8_g1
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g8_g2
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g8_g4
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g8_g16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|2
case|:
empty_stmt|;
case|case
literal|10
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pBuftarget
operator|->
name|iBitdepth
operator|==
literal|16
condition|)
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_rgb8_rgb16
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|4
case|:
empty_stmt|;
case|case
literal|12
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pBuftarget
operator|->
name|iBitdepth
operator|==
literal|16
condition|)
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_ga8_ga16
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|6
case|:
empty_stmt|;
case|case
literal|14
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pBuftarget
operator|->
name|iBitdepth
operator|==
literal|16
condition|)
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_rgba8_rgba16
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
block|}
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
switch|switch
condition|(
name|pBufdelta
operator|->
name|iColortype
condition|)
block|{
case|case
literal|0
case|:
empty_stmt|;
case|case
literal|3
case|:
empty_stmt|;
case|case
literal|8
case|:
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g16_g1
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g16_g2
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g16_g4
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_g16_g8
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
case|case
literal|2
case|:
empty_stmt|;
case|case
literal|10
case|:
block|{
if|if
condition|(
name|pBuftarget
operator|->
name|iBitdepth
operator|==
literal|8
condition|)
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_rgb16_rgb8
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
empty_stmt|;
case|case
literal|12
case|:
block|{
if|if
condition|(
name|pBuftarget
operator|->
name|iBitdepth
operator|==
literal|8
condition|)
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_ga16_ga8
expr_stmt|;
break|break;
block|}
case|case
literal|6
case|:
empty_stmt|;
case|case
literal|14
case|:
block|{
if|if
condition|(
name|pBuftarget
operator|->
name|iBitdepth
operator|==
literal|8
condition|)
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_rgba16_rgba8
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
endif|#
directive|endif
block|}
name|pData
operator|->
name|fDeltarow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* let's assume there's nothing to do */
switch|switch
condition|(
name|pBuftarget
operator|->
name|iColortype
condition|)
comment|/* determine delta processing routine */
block|{
case|case
literal|0
case|:
empty_stmt|;
case|case
literal|8
case|:
block|{
comment|/* gray */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|0
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|3
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|8
operator|)
condition|)
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_g1_g1
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_g2_g2
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_g4_g4
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_g8_g8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_g16_g16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
break|break;
block|}
case|case
literal|2
case|:
empty_stmt|;
case|case
literal|10
case|:
block|{
comment|/* rgb */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|2
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|10
operator|)
condition|)
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgb8_rgb8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgb16_rgb16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed; abuse gray routines */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|0
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|3
operator|)
condition|)
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_g1_g1
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_g2_g2
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_g4_g4
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_g8_g8
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
break|break;
block|}
case|case
literal|4
case|:
empty_stmt|;
case|case
literal|12
case|:
block|{
comment|/* gray + alpha */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|4
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|12
operator|)
condition|)
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_ga8_ga8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_ga16_ga16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORREPLACE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|0
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|3
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|8
operator|)
condition|)
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_ga8_g8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_ga16_g16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAREPLACE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|0
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|3
operator|)
condition|)
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_ga8_a8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_ga16_a16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
break|break;
block|}
case|case
literal|6
case|:
empty_stmt|;
case|case
literal|14
case|:
block|{
comment|/* rgb + alpha */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|6
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|14
operator|)
condition|)
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgba8_rgba8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgba16_rgba16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORREPLACE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|2
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|10
operator|)
condition|)
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgba8_rgb8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgba16_rgb16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAREPLACE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|0
operator|)
operator|||
operator|(
name|pBufdelta
operator|->
name|iColortype
operator|==
literal|3
operator|)
condition|)
block|{
switch|switch
condition|(
name|pBuftarget
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgba8_a8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgba16_a16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
block|}
block|}
break|break;
block|}
block|}
if|if
condition|(
name|pData
operator|->
name|fDeltarow
condition|)
comment|/* do we need to take action ? */
block|{
name|pData
operator|->
name|iPass
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* setup row dimensions and stuff */
name|pData
operator|->
name|iRow
operator|=
name|pData
operator|->
name|iDeltaBlocky
expr_stmt|;
name|pData
operator|->
name|iRowinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iCol
operator|=
name|pData
operator|->
name|iDeltaBlockx
expr_stmt|;
name|pData
operator|->
name|iColinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iRowsamples
operator|=
name|pBufdelta
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iRowsize
operator|=
name|pBuftarget
operator|->
name|iRowsize
expr_stmt|;
comment|/* indicate where to retrieve& where to store */
name|pData
operator|->
name|pRetrieveobj
operator|=
operator|(
name|mng_objectp
operator|)
name|pDelta
expr_stmt|;
name|pData
operator|->
name|pStoreobj
operator|=
operator|(
name|mng_objectp
operator|)
name|pTarget
expr_stmt|;
name|pSaveRGBA
operator|=
name|pData
operator|->
name|pRGBArow
expr_stmt|;
comment|/* save current temp-buffer! */
comment|/* get a temporary row-buffer */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
operator|(
name|pBufdelta
operator|->
name|iRowsize
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|iY
operator|=
literal|0
expr_stmt|;
comment|/* this is where we start */
name|iRetcode
operator|=
name|MNG_NOERROR
expr_stmt|;
comment|/* still oke for now */
while|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|iY
operator|<
name|pBufdelta
operator|->
name|iHeight
operator|)
condition|)
block|{
comment|/* get a row */
name|mng_uint8p
name|pWork
init|=
name|pBufdelta
operator|->
name|pImgdata
operator|+
operator|(
name|iY
operator|*
name|pBufdelta
operator|->
name|iRowsize
operator|)
decl_stmt|;
name|MNG_COPY
argument_list|(
name|pData
operator|->
name|pRGBArow
argument_list|,
name|pWork
argument_list|,
name|pBufdelta
operator|->
name|iRowsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|fScalerow
condition|)
comment|/* scale it (if necessary) */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_scalerow
operator|)
name|pData
operator|->
name|fScalerow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* and... execute it */
name|iRetcode
operator|=
operator|(
operator|(
name|mng_deltarow
operator|)
name|pData
operator|->
name|fDeltarow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* adjust variables for next row */
name|iRetcode
operator|=
name|mng_next_row
argument_list|(
name|pData
argument_list|)
expr_stmt|;
name|iY
operator|++
expr_stmt|;
comment|/* and next line */
block|}
comment|/* drop the temporary row-buffer */
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
operator|(
name|pBufdelta
operator|->
name|iRowsize
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|pData
operator|->
name|pRGBArow
operator|=
name|pSaveRGBA
expr_stmt|;
comment|/* restore saved temp-buffer! */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDDELTA
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_EXECUTE_DELTA_IMAGE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_NO_DELTA_PNG */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SAVE
end_ifndef
begin_function
DECL|function|save_state
name|MNG_LOCAL
name|mng_retcode
name|save_state
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_savedatap
name|pSave
decl_stmt|;
name|mng_imagep
name|pImage
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_SAVE_STATE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|pSavedata
condition|)
comment|/* sanity check */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INTERNALERROR
argument_list|)
expr_stmt|;
comment|/* get a buffer for saving */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pSavedata
argument_list|,
sizeof|sizeof
argument_list|(
name|mng_savedata
argument_list|)
argument_list|)
expr_stmt|;
name|pSave
operator|=
name|pData
operator|->
name|pSavedata
expr_stmt|;
comment|/* address it more directly */
comment|/* and copy global data from the main struct */
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_READ
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_SUPPORT_WRITE
argument_list|)
name|pSave
operator|->
name|bHasglobalPLTE
operator|=
name|pData
operator|->
name|bHasglobalPLTE
expr_stmt|;
name|pSave
operator|->
name|bHasglobalTRNS
operator|=
name|pData
operator|->
name|bHasglobalTRNS
expr_stmt|;
name|pSave
operator|->
name|bHasglobalGAMA
operator|=
name|pData
operator|->
name|bHasglobalGAMA
expr_stmt|;
name|pSave
operator|->
name|bHasglobalCHRM
operator|=
name|pData
operator|->
name|bHasglobalCHRM
expr_stmt|;
name|pSave
operator|->
name|bHasglobalSRGB
operator|=
name|pData
operator|->
name|bHasglobalSRGB
expr_stmt|;
name|pSave
operator|->
name|bHasglobalICCP
operator|=
name|pData
operator|->
name|bHasglobalICCP
expr_stmt|;
name|pSave
operator|->
name|bHasglobalBKGD
operator|=
name|pData
operator|->
name|bHasglobalBKGD
expr_stmt|;
endif|#
directive|endif
comment|/* MNG_SUPPORT_READ || MNG_SUPPORT_WRITE */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BACK
name|pSave
operator|->
name|iBACKred
operator|=
name|pData
operator|->
name|iBACKred
expr_stmt|;
name|pSave
operator|->
name|iBACKgreen
operator|=
name|pData
operator|->
name|iBACKgreen
expr_stmt|;
name|pSave
operator|->
name|iBACKblue
operator|=
name|pData
operator|->
name|iBACKblue
expr_stmt|;
name|pSave
operator|->
name|iBACKmandatory
operator|=
name|pData
operator|->
name|iBACKmandatory
expr_stmt|;
name|pSave
operator|->
name|iBACKimageid
operator|=
name|pData
operator|->
name|iBACKimageid
expr_stmt|;
name|pSave
operator|->
name|iBACKtile
operator|=
name|pData
operator|->
name|iBACKtile
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
name|pSave
operator|->
name|iFRAMmode
operator|=
name|pData
operator|->
name|iFRAMmode
expr_stmt|;
name|pSave
operator|->
name|iFRAMdelay
operator|=
name|pData
operator|->
name|iFRAMdelay
expr_stmt|;
name|pSave
operator|->
name|iFRAMtimeout
operator|=
name|pData
operator|->
name|iFRAMtimeout
expr_stmt|;
name|pSave
operator|->
name|bFRAMclipping
operator|=
name|pData
operator|->
name|bFRAMclipping
expr_stmt|;
name|pSave
operator|->
name|iFRAMclipl
operator|=
name|pData
operator|->
name|iFRAMclipl
expr_stmt|;
name|pSave
operator|->
name|iFRAMclipr
operator|=
name|pData
operator|->
name|iFRAMclipr
expr_stmt|;
name|pSave
operator|->
name|iFRAMclipt
operator|=
name|pData
operator|->
name|iFRAMclipt
expr_stmt|;
name|pSave
operator|->
name|iFRAMclipb
operator|=
name|pData
operator|->
name|iFRAMclipb
expr_stmt|;
endif|#
directive|endif
name|pSave
operator|->
name|iGlobalPLTEcount
operator|=
name|pData
operator|->
name|iGlobalPLTEcount
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pSave
operator|->
name|aGlobalPLTEentries
argument_list|,
name|pData
operator|->
name|aGlobalPLTEentries
argument_list|,
sizeof|sizeof
argument_list|(
name|mng_rgbpaltab
argument_list|)
argument_list|)
expr_stmt|;
name|pSave
operator|->
name|iGlobalTRNSrawlen
operator|=
name|pData
operator|->
name|iGlobalTRNSrawlen
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pSave
operator|->
name|aGlobalTRNSrawdata
argument_list|,
name|pData
operator|->
name|aGlobalTRNSrawdata
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|pSave
operator|->
name|iGlobalGamma
operator|=
name|pData
operator|->
name|iGlobalGamma
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
name|pSave
operator|->
name|iGlobalWhitepointx
operator|=
name|pData
operator|->
name|iGlobalWhitepointx
expr_stmt|;
name|pSave
operator|->
name|iGlobalWhitepointy
operator|=
name|pData
operator|->
name|iGlobalWhitepointy
expr_stmt|;
name|pSave
operator|->
name|iGlobalPrimaryredx
operator|=
name|pData
operator|->
name|iGlobalPrimaryredx
expr_stmt|;
name|pSave
operator|->
name|iGlobalPrimaryredy
operator|=
name|pData
operator|->
name|iGlobalPrimaryredy
expr_stmt|;
name|pSave
operator|->
name|iGlobalPrimarygreenx
operator|=
name|pData
operator|->
name|iGlobalPrimarygreenx
expr_stmt|;
name|pSave
operator|->
name|iGlobalPrimarygreeny
operator|=
name|pData
operator|->
name|iGlobalPrimarygreeny
expr_stmt|;
name|pSave
operator|->
name|iGlobalPrimarybluex
operator|=
name|pData
operator|->
name|iGlobalPrimarybluex
expr_stmt|;
name|pSave
operator|->
name|iGlobalPrimarybluey
operator|=
name|pData
operator|->
name|iGlobalPrimarybluey
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_sRGB
name|pSave
operator|->
name|iGlobalRendintent
operator|=
name|pData
operator|->
name|iGlobalRendintent
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
name|pSave
operator|->
name|iGlobalProfilesize
operator|=
name|pData
operator|->
name|iGlobalProfilesize
expr_stmt|;
if|if
condition|(
name|pSave
operator|->
name|iGlobalProfilesize
condition|)
comment|/* has a profile ? */
block|{
comment|/* then copy that ! */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pSave
operator|->
name|pGlobalProfile
argument_list|,
name|pSave
operator|->
name|iGlobalProfilesize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pSave
operator|->
name|pGlobalProfile
argument_list|,
name|pData
operator|->
name|pGlobalProfile
argument_list|,
name|pSave
operator|->
name|iGlobalProfilesize
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_bKGD
name|pSave
operator|->
name|iGlobalBKGDred
operator|=
name|pData
operator|->
name|iGlobalBKGDred
expr_stmt|;
name|pSave
operator|->
name|iGlobalBKGDgreen
operator|=
name|pData
operator|->
name|iGlobalBKGDgreen
expr_stmt|;
name|pSave
operator|->
name|iGlobalBKGDblue
operator|=
name|pData
operator|->
name|iGlobalBKGDblue
expr_stmt|;
endif|#
directive|endif
comment|/* freeze current image objects */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pFirstimgobj
expr_stmt|;
while|while
condition|(
name|pImage
condition|)
block|{
comment|/* freeze the object AND its buffer */
name|pImage
operator|->
name|bFrozen
operator|=
name|MNG_TRUE
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|bFrozen
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* neeeext */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pImage
operator|->
name|sHeader
operator|.
name|pNext
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_SAVE_STATE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_reset_objzero
name|mng_retcode
name|mng_reset_objzero
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_imagep
name|pImage
init|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
decl_stmt|;
name|mng_retcode
name|iRetcode
init|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MNG_TRUE
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_TRUE
expr_stmt|;
name|pImage
operator|->
name|bViewable
operator|=
name|MNG_TRUE
expr_stmt|;
name|pImage
operator|->
name|iPosx
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iPosy
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|bClipped
operator|=
name|MNG_FALSE
expr_stmt|;
name|pImage
operator|->
name|iClipl
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iClipr
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iClipt
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iClipb
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
name|pImage
operator|->
name|iMAGN_MethodX
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MethodY
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MX
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MY
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iMAGN_ML
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MR
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MT
operator|=
literal|0
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MB
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|restore_state
name|MNG_LOCAL
name|mng_retcode
name|restore_state
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SAVE
name|mng_savedatap
name|pSave
decl_stmt|;
endif|#
directive|endif
name|mng_imagep
name|pImage
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_RESTORE_STATE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* restore object 0 status !!! */
name|iRetcode
operator|=
name|mng_reset_objzero
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* fresh cycle; fake no frames done yet */
name|pData
operator|->
name|bFramedone
operator|=
name|MNG_FALSE
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SAVE
if|if
condition|(
name|pData
operator|->
name|pSavedata
condition|)
comment|/* do we have a saved state ? */
block|{
name|pSave
operator|=
name|pData
operator|->
name|pSavedata
expr_stmt|;
comment|/* address it more directly */
comment|/* and copy it back to the main struct */
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_READ
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_SUPPORT_WRITE
argument_list|)
name|pData
operator|->
name|bHasglobalPLTE
operator|=
name|pSave
operator|->
name|bHasglobalPLTE
expr_stmt|;
name|pData
operator|->
name|bHasglobalTRNS
operator|=
name|pSave
operator|->
name|bHasglobalTRNS
expr_stmt|;
name|pData
operator|->
name|bHasglobalGAMA
operator|=
name|pSave
operator|->
name|bHasglobalGAMA
expr_stmt|;
name|pData
operator|->
name|bHasglobalCHRM
operator|=
name|pSave
operator|->
name|bHasglobalCHRM
expr_stmt|;
name|pData
operator|->
name|bHasglobalSRGB
operator|=
name|pSave
operator|->
name|bHasglobalSRGB
expr_stmt|;
name|pData
operator|->
name|bHasglobalICCP
operator|=
name|pSave
operator|->
name|bHasglobalICCP
expr_stmt|;
name|pData
operator|->
name|bHasglobalBKGD
operator|=
name|pSave
operator|->
name|bHasglobalBKGD
expr_stmt|;
endif|#
directive|endif
comment|/* MNG_SUPPORT_READ || MNG_SUPPORT_WRITE */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BACK
name|pData
operator|->
name|iBACKred
operator|=
name|pSave
operator|->
name|iBACKred
expr_stmt|;
name|pData
operator|->
name|iBACKgreen
operator|=
name|pSave
operator|->
name|iBACKgreen
expr_stmt|;
name|pData
operator|->
name|iBACKblue
operator|=
name|pSave
operator|->
name|iBACKblue
expr_stmt|;
name|pData
operator|->
name|iBACKmandatory
operator|=
name|pSave
operator|->
name|iBACKmandatory
expr_stmt|;
name|pData
operator|->
name|iBACKimageid
operator|=
name|pSave
operator|->
name|iBACKimageid
expr_stmt|;
name|pData
operator|->
name|iBACKtile
operator|=
name|pSave
operator|->
name|iBACKtile
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
name|pData
operator|->
name|iFRAMmode
operator|=
name|pSave
operator|->
name|iFRAMmode
expr_stmt|;
comment|/*    pData->iFRAMdelay           = pSave->iFRAMdelay; */
name|pData
operator|->
name|iFRAMtimeout
operator|=
name|pSave
operator|->
name|iFRAMtimeout
expr_stmt|;
name|pData
operator|->
name|bFRAMclipping
operator|=
name|pSave
operator|->
name|bFRAMclipping
expr_stmt|;
name|pData
operator|->
name|iFRAMclipl
operator|=
name|pSave
operator|->
name|iFRAMclipl
expr_stmt|;
name|pData
operator|->
name|iFRAMclipr
operator|=
name|pSave
operator|->
name|iFRAMclipr
expr_stmt|;
name|pData
operator|->
name|iFRAMclipt
operator|=
name|pSave
operator|->
name|iFRAMclipt
expr_stmt|;
name|pData
operator|->
name|iFRAMclipb
operator|=
name|pSave
operator|->
name|iFRAMclipb
expr_stmt|;
comment|/* NOOOOOOOOOOOO */
comment|/*    pData->iFramemode           = pSave->iFRAMmode;     pData->iFramedelay          = pSave->iFRAMdelay;     pData->iFrametimeout        = pSave->iFRAMtimeout;     pData->bFrameclipping       = pSave->bFRAMclipping;     pData->iFrameclipl          = pSave->iFRAMclipl;     pData->iFrameclipr          = pSave->iFRAMclipr;     pData->iFrameclipt          = pSave->iFRAMclipt;     pData->iFrameclipb          = pSave->iFRAMclipb; */
comment|/*    pData->iNextdelay           = pSave->iFRAMdelay; */
name|pData
operator|->
name|iNextdelay
operator|=
name|pData
operator|->
name|iFramedelay
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|iGlobalPLTEcount
operator|=
name|pSave
operator|->
name|iGlobalPLTEcount
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pData
operator|->
name|aGlobalPLTEentries
argument_list|,
name|pSave
operator|->
name|aGlobalPLTEentries
argument_list|,
sizeof|sizeof
argument_list|(
name|mng_rgbpaltab
argument_list|)
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iGlobalTRNSrawlen
operator|=
name|pSave
operator|->
name|iGlobalTRNSrawlen
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pData
operator|->
name|aGlobalTRNSrawdata
argument_list|,
name|pSave
operator|->
name|aGlobalTRNSrawdata
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iGlobalGamma
operator|=
name|pSave
operator|->
name|iGlobalGamma
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
name|pData
operator|->
name|iGlobalWhitepointx
operator|=
name|pSave
operator|->
name|iGlobalWhitepointx
expr_stmt|;
name|pData
operator|->
name|iGlobalWhitepointy
operator|=
name|pSave
operator|->
name|iGlobalWhitepointy
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimaryredx
operator|=
name|pSave
operator|->
name|iGlobalPrimaryredx
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimaryredy
operator|=
name|pSave
operator|->
name|iGlobalPrimaryredy
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarygreenx
operator|=
name|pSave
operator|->
name|iGlobalPrimarygreenx
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarygreeny
operator|=
name|pSave
operator|->
name|iGlobalPrimarygreeny
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarybluex
operator|=
name|pSave
operator|->
name|iGlobalPrimarybluex
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarybluey
operator|=
name|pSave
operator|->
name|iGlobalPrimarybluey
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|iGlobalRendintent
operator|=
name|pSave
operator|->
name|iGlobalRendintent
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
name|pData
operator|->
name|iGlobalProfilesize
operator|=
name|pSave
operator|->
name|iGlobalProfilesize
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iGlobalProfilesize
condition|)
comment|/* has a profile ? */
block|{
comment|/* then copy that ! */
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pGlobalProfile
argument_list|,
name|pData
operator|->
name|iGlobalProfilesize
argument_list|)
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pData
operator|->
name|pGlobalProfile
argument_list|,
name|pSave
operator|->
name|pGlobalProfile
argument_list|,
name|pData
operator|->
name|iGlobalProfilesize
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_bKGD
name|pData
operator|->
name|iGlobalBKGDred
operator|=
name|pSave
operator|->
name|iGlobalBKGDred
expr_stmt|;
name|pData
operator|->
name|iGlobalBKGDgreen
operator|=
name|pSave
operator|->
name|iGlobalBKGDgreen
expr_stmt|;
name|pData
operator|->
name|iGlobalBKGDblue
operator|=
name|pSave
operator|->
name|iGlobalBKGDblue
expr_stmt|;
endif|#
directive|endif
block|}
else|else
comment|/* no saved-data; so reset the lot */
endif|#
directive|endif
comment|/* SKIPCHUNK_SAVE */
block|{
if|#
directive|if
name|defined
argument_list|(
name|MNG_SUPPORT_READ
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_SUPPORT_WRITE
argument_list|)
name|pData
operator|->
name|bHasglobalPLTE
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasglobalTRNS
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasglobalGAMA
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasglobalCHRM
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasglobalSRGB
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasglobalICCP
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasglobalBKGD
operator|=
name|MNG_FALSE
expr_stmt|;
endif|#
directive|endif
comment|/* MNG_SUPPORT_READ || MNG_SUPPORT_WRITE */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_TERM
if|if
condition|(
operator|!
name|pData
operator|->
name|bMisplacedTERM
condition|)
comment|/* backward compatible ugliness !!! */
block|{
name|pData
operator|->
name|iBACKred
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iBACKgreen
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iBACKblue
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iBACKmandatory
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iBACKimageid
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iBACKtile
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
name|pData
operator|->
name|iFRAMmode
operator|=
literal|1
expr_stmt|;
comment|/*    pData->iFRAMdelay           = 1; */
name|pData
operator|->
name|iFRAMtimeout
operator|=
literal|0x7fffffffl
expr_stmt|;
name|pData
operator|->
name|bFRAMclipping
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iFRAMclipl
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iFRAMclipr
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iFRAMclipt
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iFRAMclipb
operator|=
literal|0
expr_stmt|;
comment|/* NOOOOOOOOOOOO */
comment|/*    pData->iFramemode           = 1;     pData->iFramedelay          = 1;     pData->iFrametimeout        = 0x7fffffffl;     pData->bFrameclipping       = MNG_FALSE;     pData->iFrameclipl          = 0;     pData->iFrameclipr          = 0;     pData->iFrameclipt          = 0;     pData->iFrameclipb          = 0; */
comment|/*    pData->iNextdelay           = 1; */
name|pData
operator|->
name|iNextdelay
operator|=
name|pData
operator|->
name|iFramedelay
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|iGlobalPLTEcount
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalTRNSrawlen
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalGamma
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_cHRM
name|pData
operator|->
name|iGlobalWhitepointx
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalWhitepointy
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimaryredx
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimaryredy
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarygreenx
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarygreeny
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarybluex
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalPrimarybluey
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|iGlobalRendintent
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_iCCP
if|if
condition|(
name|pData
operator|->
name|iGlobalProfilesize
condition|)
comment|/* free a previous profile ? */
name|MNG_FREE
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pGlobalProfile
argument_list|,
name|pData
operator|->
name|iGlobalProfilesize
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iGlobalProfilesize
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_bKGD
name|pData
operator|->
name|iGlobalBKGDred
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalBKGDgreen
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iGlobalBKGDblue
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
block|}
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_TERM
if|if
condition|(
operator|!
name|pData
operator|->
name|bMisplacedTERM
condition|)
comment|/* backward compatible ugliness !!! */
block|{
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pFirstimgobj
expr_stmt|;
comment|/* drop un-frozen image objects */
while|while
condition|(
name|pImage
condition|)
block|{
name|mng_imagep
name|pNext
init|=
operator|(
name|mng_imagep
operator|)
name|pImage
operator|->
name|sHeader
operator|.
name|pNext
decl_stmt|;
if|if
condition|(
operator|!
name|pImage
operator|->
name|bFrozen
condition|)
comment|/* is it un-frozen ? */
block|{
name|mng_imagep
name|pPrev
init|=
operator|(
name|mng_imagep
operator|)
name|pImage
operator|->
name|sHeader
operator|.
name|pPrev
decl_stmt|;
if|if
condition|(
name|pPrev
condition|)
comment|/* unlink it */
name|pPrev
operator|->
name|sHeader
operator|.
name|pNext
operator|=
name|pNext
expr_stmt|;
else|else
name|pData
operator|->
name|pFirstimgobj
operator|=
name|pNext
expr_stmt|;
if|if
condition|(
name|pNext
condition|)
name|pNext
operator|->
name|sHeader
operator|.
name|pPrev
operator|=
name|pPrev
expr_stmt|;
else|else
name|pData
operator|->
name|pLastimgobj
operator|=
name|pPrev
expr_stmt|;
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|bFrozen
condition|)
comment|/* buffer frozen ? */
block|{
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|iRefcount
operator|<
literal|2
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INTERNALERROR
argument_list|)
expr_stmt|;
comment|/* decrease ref counter */
name|pImage
operator|->
name|pImgbuf
operator|->
name|iRefcount
operator|--
expr_stmt|;
comment|/* just cleanup the object then */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
sizeof|sizeof
argument_list|(
name|mng_image
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* free the image buffer */
name|iRetcode
operator|=
name|mng_free_imagedataobject
argument_list|(
name|pData
argument_list|,
name|pImage
operator|->
name|pImgbuf
argument_list|)
expr_stmt|;
comment|/* and cleanup the object */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
sizeof|sizeof
argument_list|(
name|mng_image
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
name|pImage
operator|=
name|pNext
expr_stmt|;
comment|/* neeeext */
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_RESTORE_STATE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * General display processing routine                                     * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_process_display
name|mng_retcode
name|mng_process_display
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* not broken previously ? */
block|{
if|if
condition|(
operator|(
name|pData
operator|->
name|iRequestframe
operator|)
operator|||
operator|(
name|pData
operator|->
name|iRequestlayer
operator|)
operator|||
operator|(
name|pData
operator|->
name|iRequesttime
operator|)
condition|)
block|{
name|pData
operator|->
name|bSearching
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* indicate we're searching */
name|iRetcode
operator|=
name|clear_canvas
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* make the canvas virgin black ?!? */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* let's start from the top, shall we */
name|pData
operator|->
name|pCurraniobj
operator|=
name|pData
operator|->
name|pFirstaniobj
expr_stmt|;
block|}
block|}
do|do
comment|/* process the objects */
block|{
if|if
condition|(
name|pData
operator|->
name|bSearching
condition|)
comment|/* clear timer-flag when searching !!! */
name|pData
operator|->
name|bTimerset
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* do we need to finish something first ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iBreakpoint
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBreakpoint
operator|<
literal|99
operator|)
condition|)
block|{
switch|switch
condition|(
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* return to broken display routine */
block|{
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
case|case
literal|1
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_fram2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SHOW
case|case
literal|3
case|:
empty_stmt|;
comment|/* same as 4 !!! */
case|case
literal|4
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_show
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLON
case|case
literal|5
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_clon2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
case|case
literal|9
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_magn2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|10
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_mend2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_PAST
case|case
literal|11
case|:
block|{
name|iRetcode
operator|=
name|mng_process_display_past2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default :
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INTERNALERROR
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|pData
operator|->
name|pCurraniobj
condition|)
name|iRetcode
operator|=
operator|(
operator|(
name|mng_object_headerp
operator|)
name|pData
operator|->
name|pCurraniobj
operator|)
operator|->
name|fProcess
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pCurraniobj
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
comment|/* reset breakpoint flag ? */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* can we advance to next object ? */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pCurraniobj
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSectionwait
operator|)
condition|)
block|{
name|pData
operator|->
name|pCurraniobj
operator|=
operator|(
operator|(
name|mng_object_headerp
operator|)
name|pData
operator|->
name|pCurraniobj
operator|)
operator|->
name|pNext
expr_stmt|;
comment|/* MEND processing to be done ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_mng
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|pCurraniobj
operator|)
condition|)
name|iRetcode
operator|=
name|mng_process_display_mend
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|pCurraniobj
condition|)
comment|/* refresh after last image ? */
name|pData
operator|->
name|bNeedrefresh
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|pData
operator|->
name|bSearching
condition|)
comment|/* are we looking for something ? */
block|{
if|if
condition|(
operator|(
name|pData
operator|->
name|iRequestframe
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iRequestframe
operator|<=
name|pData
operator|->
name|iFrameseq
operator|)
condition|)
block|{
name|pData
operator|->
name|iRequestframe
operator|=
literal|0
expr_stmt|;
comment|/* found the frame ! */
name|pData
operator|->
name|bSearching
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iRequestlayer
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iRequestlayer
operator|<=
name|pData
operator|->
name|iLayerseq
operator|)
condition|)
block|{
name|pData
operator|->
name|iRequestlayer
operator|=
literal|0
expr_stmt|;
comment|/* found the layer ! */
name|pData
operator|->
name|bSearching
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iRequesttime
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iRequesttime
operator|<=
name|pData
operator|->
name|iFrametime
operator|)
condition|)
block|{
name|pData
operator|->
name|iRequesttime
operator|=
literal|0
expr_stmt|;
comment|/* found the playtime ! */
name|pData
operator|->
name|bSearching
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
block|}
block|}
comment|/* until error or a break or no more objects */
do|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pCurraniobj
operator|)
operator|&&
operator|(
operator|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|)
operator|||
operator|(
name|pData
operator|->
name|bSearching
operator|)
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSectionwait
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bFreezing
operator|)
condition|)
do|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* refresh needed ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bNeedrefresh
operator|)
condition|)
block|{
name|iRetcode
operator|=
name|mng_display_progressive_refresh
argument_list|(
name|pData
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
comment|/* timer break ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|iBreakpoint
operator|)
condition|)
name|pData
operator|->
name|iBreakpoint
operator|=
literal|99
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* reset if no timer break */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|pCurraniobj
operator|)
condition|)
name|pData
operator|->
name|bRunning
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* all done now ! */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* * Chunk display processing routines                                      * */
end_comment
begin_comment
comment|/* *                                                                        * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_FOOTPRINT_INIT
end_ifdef
begin_function
DECL|function|mng_png_imgtype
name|png_imgtype
name|mng_png_imgtype
parameter_list|(
name|mng_uint8
name|colortype
parameter_list|,
name|mng_uint8
name|bitdepth
parameter_list|)
block|{
name|png_imgtype
name|ret
decl_stmt|;
switch|switch
condition|(
name|bitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
name|png_imgtype
name|imgtype
index|[]
init|=
block|{
name|png_g1
block|,
name|png_none
block|,
name|png_none
block|,
name|png_idx1
block|}
decl_stmt|;
name|ret
operator|=
name|imgtype
index|[
name|colortype
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|png_imgtype
name|imgtype
index|[]
init|=
block|{
name|png_g2
block|,
name|png_none
block|,
name|png_none
block|,
name|png_idx2
block|}
decl_stmt|;
name|ret
operator|=
name|imgtype
index|[
name|colortype
index|]
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|png_imgtype
name|imgtype
index|[]
init|=
block|{
name|png_g4
block|,
name|png_none
block|,
name|png_none
block|,
name|png_idx4
block|}
decl_stmt|;
name|ret
operator|=
name|imgtype
index|[
name|colortype
index|]
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
case|case
literal|8
case|:
block|{
name|png_imgtype
name|imgtype
index|[]
init|=
block|{
name|png_g8
block|,
name|png_none
block|,
name|png_rgb8
block|,
name|png_idx8
block|,
name|png_ga8
block|,
name|png_none
block|,
name|png_rgba8
block|}
decl_stmt|;
name|ret
operator|=
name|imgtype
index|[
name|colortype
index|]
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|png_imgtype
name|imgtype
index|[]
init|=
block|{
name|png_g16
block|,
name|png_none
block|,
name|png_rgb16
block|,
name|png_none
block|,
name|png_ga16
block|,
name|png_none
block|,
name|png_rgba16
block|}
decl_stmt|;
name|ret
operator|=
name|imgtype
index|[
name|colortype
index|]
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|ret
operator|=
name|png_none
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_OPTIMIZE_FOOTPRINT_INIT */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_process_display_ihdr
name|mng_retcode
name|mng_process_display_ihdr
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
comment|/* address the current "object" if any */
name|mng_imagep
name|pImage
init|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IHDR
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasDHDR
condition|)
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* do nothing by default */
name|pData
operator|->
name|fDisplayrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fCorrectrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fStorerow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fProcessrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fDifferrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|pStoreobj
operator|=
name|MNG_NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* not previously broken ? */
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* is a delta-image ? */
block|{
if|if
condition|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
condition|)
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|,
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iCompression
argument_list|,
name|pData
operator|->
name|iFilter
argument_list|,
name|pData
operator|->
name|iInterlace
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
operator|)
condition|)
block|{
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iPixelsampledepth
operator|=
name|pData
operator|->
name|iBitdepth
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iAlphasampledepth
operator|=
name|pData
operator|->
name|iBitdepth
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAREPLACE
operator|)
condition|)
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iAlphasampledepth
operator|=
name|pData
operator|->
name|iBitdepth
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORREPLACE
operator|)
condition|)
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iPixelsampledepth
operator|=
name|pData
operator|->
name|iBitdepth
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
block|{
comment|/* process immediately if bitdepth& colortype are equal */
name|pData
operator|->
name|bDeltaimmediate
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|(
name|pData
operator|->
name|iBitdepth
operator|==
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|==
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|)
argument_list|)
expr_stmt|;
comment|/* be sure to reset object 0 */
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|,
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iCompression
argument_list|,
name|pData
operator|->
name|iFilter
argument_list|,
name|pData
operator|->
name|iInterlace
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
name|pImage
condition|)
comment|/* update object buffer ? */
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|,
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iCompression
argument_list|,
name|pData
operator|->
name|iFilter
argument_list|,
name|pData
operator|->
name|iInterlace
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
else|else
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|,
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iCompression
argument_list|,
name|pData
operator|->
name|iFilter
argument_list|,
name|pData
operator|->
name|iInterlace
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasDHDR
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|pImage
condition|)
comment|/* real object ? */
name|pData
operator|->
name|pStoreobj
operator|=
name|pImage
expr_stmt|;
comment|/* tell the row routines */
else|else
comment|/* otherwise use object 0 */
name|pData
operator|->
name|pStoreobj
operator|=
name|pData
operator|->
name|pObjzero
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_INCLUDE_MPNG_PROPOSAL
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|MNG_INCLUDE_ANG_PROPOSAL
argument_list|)
if|if
condition|(
comment|/* display "on-the-fly" ? */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
operator|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pStoreobj
operator|)
operator|->
name|iMAGN_MethodX
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pStoreobj
operator|)
operator|->
name|iMAGN_MethodY
operator|==
literal|0
operator|)
operator|&&
endif|#
directive|endif
operator|(
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_png
operator|)
operator|||
operator|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pStoreobj
operator|)
operator|->
name|bVisible
operator|)
operator|)
condition|)
block|{
name|next_layer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* that's a new layer then ! */
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer break ? */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|2
expr_stmt|;
else|else
block|{
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* anything to display ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDestr
operator|>
name|pData
operator|->
name|iDestl
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDestb
operator|>
name|pData
operator|->
name|iDestt
operator|)
condition|)
name|set_display_routine
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* then determine display routine */
block|}
block|}
endif|#
directive|endif
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
comment|/* no timer break ? */
block|{
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_FOOTPRINT_INIT
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rowproc
expr_stmt|;
name|pData
operator|->
name|ePng_imgtype
operator|=
name|mng_png_imgtype
argument_list|(
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|)
expr_stmt|;
else|#
directive|else
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
comment|/* determine row initialization routine */
block|{
case|case
literal|0
case|:
block|{
comment|/* gray */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g1_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g1_i
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g2_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g2_i
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g4_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g4_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx1_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx1_i
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx2_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx2_i
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx4_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx4_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx8_i
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
comment|/* gray+alpha */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|6
case|:
block|{
comment|/* rgb+alpha */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
block|}
endif|#
directive|endif
comment|/* MNG_OPTIMIZE_FOOTPRINT_INIT */
name|pData
operator|->
name|iFilterofs
operator|=
literal|0
expr_stmt|;
comment|/* determine filter characteristics */
name|pData
operator|->
name|iLevel0
operator|=
literal|0
expr_stmt|;
comment|/* default levels */
name|pData
operator|->
name|iLevel1
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iLevel2
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iLevel3
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FILTER192
comment|/* leveling& differing ? */
if|if
condition|(
name|pData
operator|->
name|iFilter
operator|==
name|MNG_FILTER_DIFFERING
condition|)
block|{
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
block|{
case|case
literal|0
case|:
block|{
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<=
literal|8
condition|)
name|pData
operator|->
name|iFilterofs
operator|=
literal|1
expr_stmt|;
else|else
name|pData
operator|->
name|iFilterofs
operator|=
literal|2
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<=
literal|8
condition|)
name|pData
operator|->
name|iFilterofs
operator|=
literal|3
expr_stmt|;
else|else
name|pData
operator|->
name|iFilterofs
operator|=
literal|6
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
name|pData
operator|->
name|iFilterofs
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<=
literal|8
condition|)
name|pData
operator|->
name|iFilterofs
operator|=
literal|2
expr_stmt|;
else|else
name|pData
operator|->
name|iFilterofs
operator|=
literal|4
expr_stmt|;
break|break;
block|}
case|case
literal|6
case|:
block|{
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<=
literal|8
condition|)
name|pData
operator|->
name|iFilterofs
operator|=
literal|4
expr_stmt|;
else|else
name|pData
operator|->
name|iFilterofs
operator|=
literal|8
expr_stmt|;
break|break;
block|}
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FILTER193
comment|/* no adaptive filtering ? */
if|if
condition|(
name|pData
operator|->
name|iFilter
operator|==
name|MNG_FILTER_NOFILTER
condition|)
name|pData
operator|->
name|iPixelofs
operator|=
name|pData
operator|->
name|iFilterofs
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|iPixelofs
operator|=
name|pData
operator|->
name|iFilterofs
operator|+
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_MPNG_PROPOSAL
end_ifdef
begin_function
DECL|function|mng_process_display_mpng
name|mng_retcode
name|mng_process_display_mpng
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MPNG
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|iAlphadepth
operator|=
literal|8
expr_stmt|;
comment|/* assume transparency !! */
if|if
condition|(
name|pData
operator|->
name|fProcessheader
condition|)
comment|/* inform the app (creating the output canvas) ? */
block|{
name|pData
operator|->
name|iWidth
operator|=
operator|(
operator|(
name|mng_mpng_objp
operator|)
name|pData
operator|->
name|pMPNG
operator|)
operator|->
name|iFramewidth
expr_stmt|;
name|pData
operator|->
name|iHeight
operator|=
operator|(
operator|(
name|mng_mpng_objp
operator|)
name|pData
operator|->
name|pMPNG
operator|)
operator|->
name|iFrameheight
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessheader
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|pData
operator|->
name|iWidth
argument_list|,
name|pData
operator|->
name|iHeight
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
block|}
name|next_layer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* first mPNG layer then ! */
name|pData
operator|->
name|bTimerset
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iDestr
operator|>
name|pData
operator|->
name|iDestl
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDestb
operator|>
name|pData
operator|->
name|iDestt
operator|)
condition|)
name|set_display_routine
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* then determine display routine */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MPNG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_ANG_PROPOSAL
end_ifdef
begin_function
DECL|function|mng_process_display_ang
name|mng_retcode
name|mng_process_display_ang
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_ANG
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|fProcessheader
condition|)
comment|/* inform the app (creating the output canvas) ? */
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessheader
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|pData
operator|->
name|iWidth
argument_list|,
name|pData
operator|->
name|iHeight
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
block|}
name|next_layer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* first mPNG layer then ! */
name|pData
operator|->
name|bTimerset
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iDestr
operator|>
name|pData
operator|->
name|iDestl
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDestb
operator|>
name|pData
operator|->
name|iDestt
operator|)
condition|)
name|set_display_routine
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* then determine display routine */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_ANG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_idat
name|mng_retcode
name|mng_process_display_idat
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint32
name|iRawlen
argument_list|,
name|mng_uint8p
name|pRawdata
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_idat
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IDAT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|MNG_INCLUDE_MPNG_PROPOSAL
argument_list|)
operator|||
name|defined
argument_list|(
name|MNG_INCLUDE_ANG_PROPOSAL
argument_list|)
if|if
condition|(
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_png
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iLayerseq
operator|<=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|pData
operator|->
name|fProcessheader
condition|)
comment|/* inform the app (creating the output canvas) ? */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessheader
argument_list|(
operator|(
operator|(
name|mng_handle
operator|)
name|pData
operator|)
argument_list|,
name|pData
operator|->
name|iWidth
argument_list|,
name|pData
operator|->
name|iHeight
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
name|next_layer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* first regular PNG layer then ! */
name|pData
operator|->
name|bTimerset
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|pData
operator|->
name|iDestr
operator|>
name|pData
operator|->
name|iDestl
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDestb
operator|>
name|pData
operator|->
name|iDestt
operator|)
condition|)
name|set_display_routine
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* then determine display routine */
block|}
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|bRestorebkgd
condition|)
comment|/* need to restore the background ? */
block|{
name|pData
operator|->
name|bRestorebkgd
operator|=
name|MNG_FALSE
expr_stmt|;
name|iRetcode
operator|=
name|load_bkgdlayer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
name|pData
operator|->
name|iLayerseq
operator|++
expr_stmt|;
comment|/* and it counts as a layer then ! */
block|}
if|if
condition|(
name|pData
operator|->
name|fInitrowproc
condition|)
comment|/* need to initialize row processing? */
block|{
name|iRetcode
operator|=
operator|(
operator|(
name|mng_initrowproc
operator|)
name|pData
operator|->
name|fInitrowproc
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
name|pData
operator|->
name|fInitrowproc
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* only call this once !!! */
block|}
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bInflating
operator|)
condition|)
comment|/* initialize inflate */
name|iRetcode
operator|=
name|mngzlib_inflateinit
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* all ok? then inflate, my man */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|iRetcode
operator|=
name|mngzlib_inflaterows
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
else|#
directive|else
name|iRetcode
operator|=
name|mngzlib_inflaterows
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iRawlen
argument_list|,
name|pData
operator|->
name|pRawdata
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IDAT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_process_display_iend
name|mng_retcode
name|mng_process_display_iend
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|,
name|iRetcode2
decl_stmt|;
name|mng_bool
name|bDodisplay
init|=
name|MNG_FALSE
decl_stmt|;
name|mng_bool
name|bMagnify
init|=
name|MNG_FALSE
decl_stmt|;
name|mng_bool
name|bCleanup
init|=
call|(
name|mng_bool
call|)
argument_list|(
name|pData
operator|->
name|iBreakpoint
operator|!=
literal|0
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IEND
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
comment|/* progressive+alpha JNG can be displayed now */
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasJHDR
operator|)
operator|&&
operator|(
operator|(
name|pData
operator|->
name|bJPEGprogressive
operator|)
operator|||
operator|(
name|pData
operator|->
name|bJPEGprogressive2
operator|)
operator|)
operator|&&
operator|(
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_jng
operator|)
operator|||
operator|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pStoreobj
operator|)
operator|->
name|bVisible
operator|)
operator|)
operator|&&
operator|(
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
condition|)
name|bDodisplay
operator|=
name|MNG_TRUE
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
if|if
condition|(
operator|(
name|pData
operator|->
name|pStoreobj
operator|)
operator|&&
comment|/* on-the-fly magnification ? */
operator|(
operator|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pStoreobj
operator|)
operator|->
name|iMAGN_MethodX
operator|)
operator|||
operator|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pStoreobj
operator|)
operator|->
name|iMAGN_MethodY
operator|)
operator|)
condition|)
name|bMagnify
operator|=
name|MNG_TRUE
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasBASI
operator|)
operator|||
comment|/* was it a BASI stream */
operator|(
name|bDodisplay
operator|)
operator|||
comment|/* or should we display the JNG */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
operator|(
name|bMagnify
operator|)
operator|||
comment|/* or should we magnify it */
endif|#
directive|endif
comment|/* or did we get broken here last time ? */
operator|(
operator|(
name|pData
operator|->
name|iBreakpoint
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBreakpoint
operator|!=
literal|8
operator|)
operator|)
condition|)
block|{
name|mng_imagep
name|pImage
init|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
decl_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* or was it object 0 ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* display it now then ? */
if|if
condition|(
operator|(
name|pImage
operator|->
name|bVisible
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|bViewable
operator|)
condition|)
block|{
comment|/* ok, so do it */
name|iRetcode
operator|=
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|bDodisplay
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer break ? */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|6
expr_stmt|;
block|}
block|}
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
comment|/* was it a DHDR stream */
operator|(
name|pData
operator|->
name|iBreakpoint
operator|==
literal|8
operator|)
condition|)
comment|/* or did we get broken here last time ? */
block|{
name|mng_imagep
name|pImage
init|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
decl_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iBreakpoint
condition|)
block|{
comment|/* perform the delta operations needed */
name|iRetcode
operator|=
name|mng_execute_delta_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
comment|/* display it now then ? */
if|if
condition|(
operator|(
name|pImage
operator|->
name|bVisible
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|bViewable
operator|)
condition|)
block|{
comment|/* ok, so do it */
name|iRetcode
operator|=
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer break ? */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|8
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
comment|/* can we continue ? */
block|{
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* clear this flag now ! */
ifdef|#
directive|ifdef
name|MNG_INCLUDE_MPNG_PROPOSAL
if|if
condition|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_mpng
condition|)
block|{
name|pData
operator|->
name|pCurraniobj
operator|=
name|pData
operator|->
name|pFirstaniobj
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_ANG_PROPOSAL
if|if
condition|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_ang
condition|)
block|{
name|pData
operator|->
name|pCurraniobj
operator|=
name|pData
operator|->
name|pFirstaniobj
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
comment|/* cleanup object 0 */
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pData
operator|->
name|bInflating
condition|)
comment|/* if we've been inflating */
block|{
comment|/* cleanup row-processing, */
name|iRetcode
operator|=
name|mng_cleanup_rowproc
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* also cleanup inflate! */
name|iRetcode2
operator|=
name|mngzlib_inflatefree
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
name|iRetcode2
condition|)
return|return
name|iRetcode2
return|;
block|}
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
name|pData
operator|->
name|bJPEGdecompress
condition|)
comment|/* if we've been decompressing JDAT */
block|{
comment|/* cleanup row-processing, */
name|iRetcode
operator|=
name|mng_cleanup_rowproc
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* also cleanup decompress! */
name|iRetcode2
operator|=
name|mngjpeg_decompressfree
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
name|iRetcode2
condition|)
return|return
name|iRetcode2
return|;
block|}
if|if
condition|(
name|pData
operator|->
name|bJPEGdecompress2
condition|)
comment|/* if we've been decompressing JDAA */
block|{
comment|/* cleanup row-processing, */
name|iRetcode
operator|=
name|mng_cleanup_rowproc
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* also cleanup decompress! */
name|iRetcode2
operator|=
name|mngjpeg_decompressfree2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
if|if
condition|(
name|iRetcode2
condition|)
return|return
name|iRetcode2
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|bCleanup
condition|)
comment|/* if we got broken last time we need to cleanup */
block|{
name|pData
operator|->
name|bHasIHDR
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* IEND signals the end for most ... */
name|pData
operator|->
name|bHasBASI
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasDHDR
operator|=
name|MNG_FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
name|pData
operator|->
name|bHasJHDR
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasJSEP
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasJDAA
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasJDAT
operator|=
name|MNG_FALSE
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|bHasPLTE
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasTRNS
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasGAMA
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasCHRM
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasSRGB
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasICCP
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasBKGD
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bHasIDAT
operator|=
name|MNG_FALSE
expr_stmt|;
block|}
comment|/* if the image was displayed on the fly, */
comment|/* we'll have to make the app refresh */
if|if
condition|(
operator|(
name|pData
operator|->
name|eImagetype
operator|!=
name|mng_it_mng
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fDisplayrow
operator|)
condition|)
name|pData
operator|->
name|bNeedrefresh
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IEND
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* change in the MNG spec with regards to TERM delay& interframe_delay    as proposed by Adam M. Costello (option 4) and finalized by official vote    during december 2002 / check the 'mng-list' archives for more details */
end_comment
begin_function
DECL|function|mng_process_display_mend
name|mng_retcode
name|mng_process_display_mend
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MEND
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|bForcedelay
operator|=
name|pData
operator|->
name|iAccumdelay
condition|?
name|MNG_FALSE
else|:
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iAccumdelay
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DYNAMICMNG
if|if
condition|(
name|pData
operator|->
name|bStopafterseek
condition|)
comment|/* need to stop after this ? */
block|{
name|pData
operator|->
name|bFreezing
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* stop processing on this one */
name|pData
operator|->
name|bRunningevent
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bStopafterseek
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bNeedrefresh
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* make sure the last bit is displayed ! */
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_TERM
comment|/* TERM processed ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bDisplaying
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bHasTERM
operator|)
operator|&&
operator|(
name|pData
operator|->
name|pTermaniobj
operator|)
condition|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_ani_termp
name|pTERM
decl_stmt|;
comment|/* get the right animation object ! */
name|pTERM
operator|=
operator|(
name|mng_ani_termp
operator|)
name|pData
operator|->
name|pTermaniobj
expr_stmt|;
name|pData
operator|->
name|iIterations
operator|++
expr_stmt|;
comment|/* increase iteration count */
switch|switch
condition|(
name|pTERM
operator|->
name|iTermaction
condition|)
comment|/* determine what to do! */
block|{
case|case
literal|0
case|:
block|{
comment|/* show last frame indefinitly */
break|break;
comment|/* piece of cake, that is... */
block|}
case|case
literal|1
case|:
block|{
comment|/* cease displaying anything */
comment|/* max(1, TERM delay, interframe_delay) */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
if|if
condition|(
name|pTERM
operator|->
name|iDelay
operator|>
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
name|pTERM
operator|->
name|iDelay
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
name|iRetcode
operator|=
name|interframe_delay
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* no interframe_delay? then fake it */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
condition|)
name|iRetcode
operator|=
name|set_delay
argument_list|(
name|pData
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|10
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* show first image after TERM */
name|iRetcode
operator|=
name|restore_state
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* notify the app ? */
if|if
condition|(
name|pData
operator|->
name|fProcessmend
condition|)
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessmend
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|iIterations
argument_list|,
literal|0
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
comment|/* show first frame after TERM chunk */
name|pData
operator|->
name|pCurraniobj
operator|=
name|pTERM
expr_stmt|;
name|pData
operator|->
name|bOnlyfirstframe
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iFramesafterTERM
operator|=
literal|0
expr_stmt|;
comment|/* max(1, TERM delay, interframe_delay) */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
if|if
condition|(
name|pTERM
operator|->
name|iDelay
operator|>
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
name|pTERM
operator|->
name|iDelay
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* repeat */
if|if
condition|(
operator|(
name|pTERM
operator|->
name|iItermax
operator|)
operator|&&
operator|(
name|pTERM
operator|->
name|iItermax
operator|<
literal|0x7FFFFFFF
operator|)
condition|)
name|pTERM
operator|->
name|iItermax
operator|--
expr_stmt|;
if|if
condition|(
name|pTERM
operator|->
name|iItermax
condition|)
comment|/* go back to TERM ? */
block|{
comment|/* restore to initial or SAVE state */
name|iRetcode
operator|=
name|restore_state
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* notify the app ? */
if|if
condition|(
name|pData
operator|->
name|fProcessmend
condition|)
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessmend
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|iIterations
argument_list|,
name|pTERM
operator|->
name|iItermax
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
comment|/* restart from TERM chunk */
name|pData
operator|->
name|pCurraniobj
operator|=
name|pTERM
expr_stmt|;
if|if
condition|(
name|pTERM
operator|->
name|iDelay
condition|)
comment|/* set the delay (?) */
block|{
comment|/* max(1, TERM delay, interframe_delay) */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
if|if
condition|(
name|pTERM
operator|->
name|iDelay
operator|>
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
name|pTERM
operator|->
name|iDelay
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|bNeedrefresh
operator|=
name|MNG_TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|pTERM
operator|->
name|iIteraction
condition|)
block|{
case|case
literal|0
case|:
block|{
comment|/* show last frame indefinitly */
break|break;
comment|/* piece of cake, that is... */
block|}
case|case
literal|1
case|:
block|{
comment|/* cease displaying anything */
comment|/* max(1, TERM delay, interframe_delay) */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
if|if
condition|(
name|pTERM
operator|->
name|iDelay
operator|>
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
name|pTERM
operator|->
name|iDelay
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
name|iRetcode
operator|=
name|interframe_delay
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* no interframe_delay? then fake it */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
condition|)
name|iRetcode
operator|=
name|set_delay
argument_list|(
name|pData
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|10
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* show first image after TERM */
name|iRetcode
operator|=
name|restore_state
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* on error bail out */
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
comment|/* notify the app ? */
if|if
condition|(
name|pData
operator|->
name|fProcessmend
condition|)
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessmend
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
name|pData
operator|->
name|iIterations
argument_list|,
literal|0
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
comment|/* show first frame after TERM chunk */
name|pData
operator|->
name|pCurraniobj
operator|=
name|pTERM
expr_stmt|;
name|pData
operator|->
name|bOnlyfirstframe
operator|=
name|MNG_TRUE
expr_stmt|;
name|pData
operator|->
name|iFramesafterTERM
operator|=
literal|0
expr_stmt|;
comment|/* max(1, TERM delay, interframe_delay) */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
if|if
condition|(
name|pTERM
operator|->
name|iDelay
operator|>
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
name|pTERM
operator|->
name|iDelay
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|iFramedelay
condition|)
name|pData
operator|->
name|iFramedelay
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
block|}
block|}
break|break;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* MNG_SKIPCHUNK_TERM */
comment|/* just reading ? */
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bDisplaying
operator|)
operator|&&
operator|(
name|pData
operator|->
name|bReading
operator|)
condition|)
if|if
condition|(
name|pData
operator|->
name|fProcessmend
condition|)
comment|/* inform the app ? */
if|if
condition|(
operator|!
name|pData
operator|->
name|fProcessmend
argument_list|(
operator|(
name|mng_handle
operator|)
name|pData
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_APPMISCERROR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pData
operator|->
name|pCurraniobj
condition|)
comment|/* always let the app refresh at the end ! */
name|pData
operator|->
name|bNeedrefresh
operator|=
name|MNG_TRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MEND
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_process_display_mend2
name|mng_retcode
name|mng_process_display_mend2
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MEND
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
name|pData
operator|->
name|bFrameclipping
operator|=
name|MNG_FALSE
expr_stmt|;
comment|/* nothing to do but restore the app background */
endif|#
directive|endif
name|load_bkgdlayer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MEND
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DEFI
end_ifndef
begin_function
DECL|function|mng_process_display_defi
name|mng_retcode
name|mng_process_display_defi
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_imagep
name|pImage
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_DEFI
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|iDEFIobjectid
condition|)
comment|/* object id=0 ? */
block|{
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bDEFIhasdonotshow
condition|)
name|pImage
operator|->
name|bVisible
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pData
operator|->
name|iDEFIdonotshow
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bDEFIhasloca
condition|)
block|{
name|pImage
operator|->
name|iPosx
operator|=
name|pData
operator|->
name|iDEFIlocax
expr_stmt|;
name|pImage
operator|->
name|iPosy
operator|=
name|pData
operator|->
name|iDEFIlocay
expr_stmt|;
block|}
if|if
condition|(
name|pData
operator|->
name|bDEFIhasclip
condition|)
block|{
name|pImage
operator|->
name|bClipped
operator|=
name|pData
operator|->
name|bDEFIhasclip
expr_stmt|;
name|pImage
operator|->
name|iClipl
operator|=
name|pData
operator|->
name|iDEFIclipl
expr_stmt|;
name|pImage
operator|->
name|iClipr
operator|=
name|pData
operator|->
name|iDEFIclipr
expr_stmt|;
name|pImage
operator|->
name|iClipt
operator|=
name|pData
operator|->
name|iDEFIclipt
expr_stmt|;
name|pImage
operator|->
name|iClipb
operator|=
name|pData
operator|->
name|iDEFIclipb
expr_stmt|;
block|}
name|pData
operator|->
name|pCurrentobj
operator|=
literal|0
expr_stmt|;
comment|/* not a real object ! */
block|}
else|else
block|{
comment|/* already exists ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iDEFIobjectid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* if not; create new */
block|{
name|mng_retcode
name|iRetcode
init|=
name|mng_create_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iDEFIobjectid
argument_list|,
call|(
name|mng_bool
call|)
argument_list|(
name|pData
operator|->
name|iDEFIconcrete
operator|==
literal|1
argument_list|)
argument_list|,
call|(
name|mng_bool
call|)
argument_list|(
name|pData
operator|->
name|iDEFIdonotshow
operator|==
literal|0
argument_list|)
argument_list|,
name|MNG_FALSE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|pData
operator|->
name|iDEFIlocax
argument_list|,
name|pData
operator|->
name|iDEFIlocay
argument_list|,
name|pData
operator|->
name|bDEFIhasclip
argument_list|,
name|pData
operator|->
name|iDEFIclipl
argument_list|,
name|pData
operator|->
name|iDEFIclipr
argument_list|,
name|pData
operator|->
name|iDEFIclipt
argument_list|,
name|pData
operator|->
name|iDEFIclipb
argument_list|,
operator|&
name|pImage
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
else|else
block|{
comment|/* exists; then set new info */
if|if
condition|(
name|pData
operator|->
name|bDEFIhasdonotshow
condition|)
name|pImage
operator|->
name|bVisible
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pData
operator|->
name|iDEFIdonotshow
operator|==
literal|0
argument_list|)
expr_stmt|;
name|pImage
operator|->
name|bViewable
operator|=
name|MNG_FALSE
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bDEFIhasloca
condition|)
block|{
name|pImage
operator|->
name|iPosx
operator|=
name|pData
operator|->
name|iDEFIlocax
expr_stmt|;
name|pImage
operator|->
name|iPosy
operator|=
name|pData
operator|->
name|iDEFIlocay
expr_stmt|;
block|}
if|if
condition|(
name|pData
operator|->
name|bDEFIhasclip
condition|)
block|{
name|pImage
operator|->
name|bClipped
operator|=
name|pData
operator|->
name|bDEFIhasclip
expr_stmt|;
name|pImage
operator|->
name|iClipl
operator|=
name|pData
operator|->
name|iDEFIclipl
expr_stmt|;
name|pImage
operator|->
name|iClipr
operator|=
name|pData
operator|->
name|iDEFIclipr
expr_stmt|;
name|pImage
operator|->
name|iClipt
operator|=
name|pData
operator|->
name|iDEFIclipt
expr_stmt|;
name|pImage
operator|->
name|iClipb
operator|=
name|pData
operator|->
name|iDEFIclipb
expr_stmt|;
block|}
if|if
condition|(
name|pData
operator|->
name|bDEFIhasconcrete
condition|)
name|pImage
operator|->
name|pImgbuf
operator|->
name|bConcrete
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pData
operator|->
name|iDEFIconcrete
operator|==
literal|1
argument_list|)
expr_stmt|;
block|}
name|pData
operator|->
name|pCurrentobj
operator|=
name|pImage
expr_stmt|;
comment|/* others may want to know this */
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_DEFI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_BASI
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_basi
name|mng_retcode
name|mng_process_display_basi
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint16
name|iRed
argument_list|,
name|mng_uint16
name|iGreen
argument_list|,
name|mng_uint16
name|iBlue
argument_list|,
name|mng_bool
name|bHasalpha
argument_list|,
name|mng_uint16
name|iAlpha
argument_list|,
name|mng_uint8
name|iViewable
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_basi
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
comment|/* address the current "object" if any */
name|mng_imagep
name|pImage
init|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
decl_stmt|;
name|mng_uint8p
name|pWork
decl_stmt|;
name|mng_uint32
name|iX
decl_stmt|;
name|mng_imagedatap
name|pBuf
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_BASI
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pImage
condition|)
comment|/* or is it an "on-the-fly" image ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* address the object-buffer */
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
name|pData
operator|->
name|fDisplayrow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* do nothing by default */
name|pData
operator|->
name|fCorrectrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fStorerow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fProcessrow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* set parms now that they're known */
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|,
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iCompression
argument_list|,
name|pData
operator|->
name|iFilter
argument_list|,
name|pData
operator|->
name|iInterlace
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* save the viewable flag */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pImage
operator|->
name|bViewable
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iViewable
operator|==
literal|1
argument_list|)
expr_stmt|;
else|#
directive|else
name|pImage
operator|->
name|bViewable
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pData
operator|->
name|iBASIviewable
operator|==
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pBuf
operator|->
name|bViewable
operator|=
name|pImage
operator|->
name|bViewable
expr_stmt|;
name|pData
operator|->
name|pStoreobj
operator|=
name|pImage
expr_stmt|;
comment|/* let row-routines know which object */
name|pWork
operator|=
name|pBuf
operator|->
name|pImgdata
expr_stmt|;
comment|/* fill the object-buffer with the specified                                           "color" sample */
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
comment|/* depending on color_type& bit_depth */
block|{
case|case
literal|0
case|:
block|{
comment|/* gray */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|==
literal|16
condition|)
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|mng_put_uint16
argument_list|(
name|pWork
argument_list|,
name|iRed
argument_list|)
expr_stmt|;
else|#
directive|else
name|mng_put_uint16
argument_list|(
name|pWork
argument_list|,
name|pData
operator|->
name|iBASIred
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pWork
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
operator|*
name|pWork
operator|=
operator|(
name|mng_uint8
operator|)
name|iRed
expr_stmt|;
else|#
directive|else
operator|*
name|pWork
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIred
expr_stmt|;
endif|#
directive|endif
name|pWork
operator|++
expr_stmt|;
block|}
block|}
comment|/* force tRNS ? */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
operator|(
name|bHasalpha
operator|)
operator|&&
operator|(
operator|!
name|iAlpha
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bBASIhasalpha
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|iBASIalpha
operator|)
condition|)
endif|#
directive|endif
block|{
name|pBuf
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pBuf
operator|->
name|iTRNSgray
operator|=
name|iRed
expr_stmt|;
else|#
directive|else
name|pBuf
operator|->
name|iTRNSgray
operator|=
name|pData
operator|->
name|iBASIred
expr_stmt|;
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|==
literal|16
condition|)
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|mng_put_uint16
argument_list|(
name|pWork
argument_list|,
name|iRed
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|2
argument_list|,
name|iGreen
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|4
argument_list|,
name|iBlue
argument_list|)
expr_stmt|;
else|#
directive|else
name|mng_put_uint16
argument_list|(
name|pWork
argument_list|,
name|pData
operator|->
name|iBASIred
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|2
argument_list|,
name|pData
operator|->
name|iBASIgreen
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|4
argument_list|,
name|pData
operator|->
name|iBASIblue
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pWork
operator|+=
literal|6
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
operator|*
name|pWork
operator|=
operator|(
name|mng_uint8
operator|)
name|iRed
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|1
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|iGreen
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|2
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|iBlue
expr_stmt|;
else|#
directive|else
operator|*
name|pWork
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIred
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|1
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIgreen
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|2
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIblue
expr_stmt|;
endif|#
directive|endif
name|pWork
operator|+=
literal|3
expr_stmt|;
block|}
block|}
comment|/* force tRNS ? */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
operator|(
name|bHasalpha
operator|)
operator|&&
operator|(
operator|!
name|iAlpha
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bBASIhasalpha
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|iBASIalpha
operator|)
condition|)
endif|#
directive|endif
block|{
name|pBuf
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pBuf
operator|->
name|iTRNSred
operator|=
name|iRed
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|=
name|iGreen
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|=
name|iBlue
expr_stmt|;
else|#
directive|else
name|pBuf
operator|->
name|iTRNSred
operator|=
name|pData
operator|->
name|iBASIred
expr_stmt|;
name|pBuf
operator|->
name|iTRNSgreen
operator|=
name|pData
operator|->
name|iBASIgreen
expr_stmt|;
name|pBuf
operator|->
name|iTRNSblue
operator|=
name|pData
operator|->
name|iBASIblue
expr_stmt|;
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
name|pBuf
operator|->
name|bHasPLTE
operator|=
name|MNG_TRUE
expr_stmt|;
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|1
case|:
block|{
name|pBuf
operator|->
name|iPLTEcount
operator|=
literal|2
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pBuf
operator|->
name|iPLTEcount
operator|=
literal|4
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pBuf
operator|->
name|iPLTEcount
operator|=
literal|16
expr_stmt|;
break|break;
block|}
case|case
literal|8
case|:
block|{
name|pBuf
operator|->
name|iPLTEcount
operator|=
literal|256
expr_stmt|;
break|break;
block|}
default|default :
block|{
name|pBuf
operator|->
name|iPLTEcount
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pBuf
operator|->
name|aPLTEentries
index|[
literal|0
index|]
operator|.
name|iRed
operator|=
operator|(
name|mng_uint8
operator|)
name|iRed
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
literal|0
index|]
operator|.
name|iGreen
operator|=
operator|(
name|mng_uint8
operator|)
name|iGreen
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
literal|0
index|]
operator|.
name|iBlue
operator|=
operator|(
name|mng_uint8
operator|)
name|iBlue
expr_stmt|;
else|#
directive|else
name|pBuf
operator|->
name|aPLTEentries
index|[
literal|0
index|]
operator|.
name|iRed
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIred
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
literal|0
index|]
operator|.
name|iGreen
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIgreen
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
literal|0
index|]
operator|.
name|iBlue
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIblue
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|iX
operator|=
literal|1
init|;
name|iX
operator|<
name|pBuf
operator|->
name|iPLTEcount
condition|;
name|iX
operator|++
control|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
literal|0
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
literal|0
expr_stmt|;
block|}
comment|/* force tRNS ? */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
operator|(
name|bHasalpha
operator|)
operator|&&
operator|(
name|iAlpha
operator|<
literal|255
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|bBASIhasalpha
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBASIalpha
operator|<
literal|255
operator|)
condition|)
endif|#
directive|endif
block|{
name|pBuf
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
name|pBuf
operator|->
name|iTRNScount
operator|=
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pBuf
operator|->
name|aTRNSentries
index|[
literal|0
index|]
operator|=
operator|(
name|mng_uint8
operator|)
name|iAlpha
expr_stmt|;
else|#
directive|else
name|pBuf
operator|->
name|aTRNSentries
index|[
literal|0
index|]
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIalpha
expr_stmt|;
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
comment|/* gray+alpha */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|==
literal|16
condition|)
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|mng_put_uint16
argument_list|(
name|pWork
argument_list|,
name|iRed
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|2
argument_list|,
name|iAlpha
argument_list|)
expr_stmt|;
else|#
directive|else
name|mng_put_uint16
argument_list|(
name|pWork
argument_list|,
name|pData
operator|->
name|iBASIred
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|2
argument_list|,
name|pData
operator|->
name|iBASIalpha
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pWork
operator|+=
literal|4
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
operator|*
name|pWork
operator|=
operator|(
name|mng_uint8
operator|)
name|iRed
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|1
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|iAlpha
expr_stmt|;
else|#
directive|else
operator|*
name|pWork
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIred
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|1
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIalpha
expr_stmt|;
endif|#
directive|endif
name|pWork
operator|+=
literal|2
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
literal|6
case|:
block|{
comment|/* rgb+alpha */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|==
literal|16
condition|)
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|mng_put_uint16
argument_list|(
name|pWork
argument_list|,
name|iRed
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|2
argument_list|,
name|iGreen
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|4
argument_list|,
name|iBlue
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|6
argument_list|,
name|iAlpha
argument_list|)
expr_stmt|;
else|#
directive|else
name|mng_put_uint16
argument_list|(
name|pWork
argument_list|,
name|pData
operator|->
name|iBASIred
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|2
argument_list|,
name|pData
operator|->
name|iBASIgreen
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|4
argument_list|,
name|pData
operator|->
name|iBASIblue
argument_list|)
expr_stmt|;
name|mng_put_uint16
argument_list|(
name|pWork
operator|+
literal|6
argument_list|,
name|pData
operator|->
name|iBASIalpha
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pWork
operator|+=
literal|8
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iDatawidth
operator|*
name|pData
operator|->
name|iDataheight
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
operator|*
name|pWork
operator|=
operator|(
name|mng_uint8
operator|)
name|iRed
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|1
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|iGreen
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|2
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|iBlue
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|3
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|iAlpha
expr_stmt|;
else|#
directive|else
operator|*
name|pWork
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIred
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|1
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIgreen
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|2
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIblue
expr_stmt|;
operator|*
operator|(
name|pWork
operator|+
literal|3
operator|)
operator|=
operator|(
name|mng_uint8
operator|)
name|pData
operator|->
name|iBASIalpha
expr_stmt|;
endif|#
directive|endif
name|pWork
operator|+=
literal|4
expr_stmt|;
block|}
block|}
break|break;
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_FOOTPRINT_INIT
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rowproc
expr_stmt|;
name|pData
operator|->
name|ePng_imgtype
operator|=
name|mng_png_imgtype
argument_list|(
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|)
expr_stmt|;
else|#
directive|else
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
comment|/* determine row initialization routine */
block|{
comment|/* just to accomodate IDAT if it arrives */
case|case
literal|0
case|:
block|{
comment|/* gray */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g1_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g1_i
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g2_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g2_i
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g4_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g4_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx1_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx1_i
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx2_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx2_i
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx4_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx4_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx8_i
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
comment|/* gray+alpha */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|6
case|:
block|{
comment|/* rgb+alpha */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
block|}
endif|#
directive|endif
comment|/* MNG_OPTIMIZE_FOOTPRINT_INIT */
name|pData
operator|->
name|iFilterofs
operator|=
literal|0
expr_stmt|;
comment|/* determine filter characteristics */
name|pData
operator|->
name|iLevel0
operator|=
literal|0
expr_stmt|;
comment|/* default levels */
name|pData
operator|->
name|iLevel1
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iLevel2
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iLevel3
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FILTER192
if|if
condition|(
name|pData
operator|->
name|iFilter
operator|==
literal|0xC0
condition|)
comment|/* leveling& differing ? */
block|{
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
block|{
case|case
literal|0
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<=
literal|8
condition|)
endif|#
directive|endif
name|pData
operator|->
name|iFilterofs
operator|=
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
else|else
name|pData
operator|->
name|iFilterofs
operator|=
literal|2
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|2
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<=
literal|8
condition|)
endif|#
directive|endif
name|pData
operator|->
name|iFilterofs
operator|=
literal|3
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
else|else
name|pData
operator|->
name|iFilterofs
operator|=
literal|6
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|3
case|:
block|{
name|pData
operator|->
name|iFilterofs
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<=
literal|8
condition|)
endif|#
directive|endif
name|pData
operator|->
name|iFilterofs
operator|=
literal|2
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
else|else
name|pData
operator|->
name|iFilterofs
operator|=
literal|4
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|6
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|pData
operator|->
name|iBitdepth
operator|<=
literal|8
condition|)
endif|#
directive|endif
name|pData
operator|->
name|iFilterofs
operator|=
literal|4
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
else|else
name|pData
operator|->
name|iFilterofs
operator|=
literal|8
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FILTER193
if|if
condition|(
name|pData
operator|->
name|iFilter
operator|==
literal|0xC1
condition|)
comment|/* no adaptive filtering ? */
name|pData
operator|->
name|iPixelofs
operator|=
name|pData
operator|->
name|iFilterofs
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|iPixelofs
operator|=
name|pData
operator|->
name|iFilterofs
operator|+
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_BASI
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLON
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_clon
name|mng_retcode
name|mng_process_display_clon
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint16
name|iSourceid
argument_list|,
name|mng_uint16
name|iCloneid
argument_list|,
name|mng_uint8
name|iClonetype
argument_list|,
name|mng_bool
name|bHasdonotshow
argument_list|,
name|mng_uint8
name|iDonotshow
argument_list|,
name|mng_uint8
name|iConcrete
argument_list|,
name|mng_bool
name|bHasloca
argument_list|,
name|mng_uint8
name|iLocationtype
argument_list|,
name|mng_int32
name|iLocationx
argument_list|,
name|mng_int32
name|iLocationy
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_clon
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_imagep
name|pSource
decl_stmt|,
name|pClone
decl_stmt|;
name|mng_bool
name|bVisible
decl_stmt|,
name|bAbstract
decl_stmt|;
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_CLON
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
comment|/* locate the source object first */
name|pSource
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iSourceid
argument_list|)
expr_stmt|;
comment|/* check if the clone exists */
name|pClone
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iCloneid
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* locate the source object first */
name|pSource
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iCLONsourceid
argument_list|)
expr_stmt|;
comment|/* check if the clone exists */
name|pClone
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iCLONcloneid
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pSource
condition|)
comment|/* source must exist ! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OBJECTUNKNOWN
argument_list|)
expr_stmt|;
if|if
condition|(
name|pClone
condition|)
comment|/* clone must not exist ! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OBJECTEXISTS
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|bHasdonotshow
condition|)
comment|/* DoNotShow flag filled ? */
name|bVisible
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iDonotshow
operator|==
literal|0
argument_list|)
expr_stmt|;
else|else
name|bVisible
operator|=
name|pSource
operator|->
name|bVisible
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|bCLONhasdonotshow
condition|)
comment|/* DoNotShow flag filled ? */
name|bVisible
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pData
operator|->
name|iCLONdonotshow
operator|==
literal|0
argument_list|)
expr_stmt|;
else|else
name|bVisible
operator|=
name|pSource
operator|->
name|bVisible
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|bAbstract
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|iConcrete
operator|==
literal|1
argument_list|)
expr_stmt|;
else|#
directive|else
name|bAbstract
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pData
operator|->
name|iCLONconcrete
operator|==
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
switch|switch
condition|(
name|iClonetype
condition|)
comment|/* determine action to take */
block|{
case|case
literal|0
case|:
block|{
comment|/* full clone */
name|iRetcode
operator|=
name|mng_clone_imageobject
argument_list|(
name|pData
argument_list|,
name|iCloneid
argument_list|,
name|MNG_FALSE
argument_list|,
name|bVisible
argument_list|,
name|bAbstract
argument_list|,
name|bHasloca
argument_list|,
name|iLocationtype
argument_list|,
name|iLocationx
argument_list|,
name|iLocationy
argument_list|,
name|pSource
argument_list|,
operator|&
name|pClone
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|1
case|:
block|{
comment|/* partial clone */
name|iRetcode
operator|=
name|mng_clone_imageobject
argument_list|(
name|pData
argument_list|,
name|iCloneid
argument_list|,
name|MNG_TRUE
argument_list|,
name|bVisible
argument_list|,
name|bAbstract
argument_list|,
name|bHasloca
argument_list|,
name|iLocationtype
argument_list|,
name|iLocationx
argument_list|,
name|iLocationy
argument_list|,
name|pSource
argument_list|,
operator|&
name|pClone
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* renumber object */
name|iRetcode
operator|=
name|mng_renum_imageobject
argument_list|(
name|pData
argument_list|,
name|pSource
argument_list|,
name|iCloneid
argument_list|,
name|bVisible
argument_list|,
name|bAbstract
argument_list|,
name|bHasloca
argument_list|,
name|iLocationtype
argument_list|,
name|iLocationx
argument_list|,
name|iLocationy
argument_list|)
expr_stmt|;
name|pClone
operator|=
name|pSource
expr_stmt|;
break|break;
block|}
block|}
else|#
directive|else
switch|switch
condition|(
name|pData
operator|->
name|iCLONclonetype
condition|)
comment|/* determine action to take */
block|{
case|case
literal|0
case|:
block|{
comment|/* full clone */
name|iRetcode
operator|=
name|mng_clone_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iCLONcloneid
argument_list|,
name|MNG_FALSE
argument_list|,
name|bVisible
argument_list|,
name|bAbstract
argument_list|,
name|pData
operator|->
name|bCLONhasloca
argument_list|,
name|pData
operator|->
name|iCLONlocationtype
argument_list|,
name|pData
operator|->
name|iCLONlocationx
argument_list|,
name|pData
operator|->
name|iCLONlocationy
argument_list|,
name|pSource
argument_list|,
operator|&
name|pClone
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|1
case|:
block|{
comment|/* partial clone */
name|iRetcode
operator|=
name|mng_clone_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iCLONcloneid
argument_list|,
name|MNG_TRUE
argument_list|,
name|bVisible
argument_list|,
name|bAbstract
argument_list|,
name|pData
operator|->
name|bCLONhasloca
argument_list|,
name|pData
operator|->
name|iCLONlocationtype
argument_list|,
name|pData
operator|->
name|iCLONlocationx
argument_list|,
name|pData
operator|->
name|iCLONlocationy
argument_list|,
name|pSource
argument_list|,
operator|&
name|pClone
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* renumber object */
name|iRetcode
operator|=
name|mng_renum_imageobject
argument_list|(
name|pData
argument_list|,
name|pSource
argument_list|,
name|pData
operator|->
name|iCLONcloneid
argument_list|,
name|bVisible
argument_list|,
name|bAbstract
argument_list|,
name|pData
operator|->
name|bCLONhasloca
argument_list|,
name|pData
operator|->
name|iCLONlocationtype
argument_list|,
name|pData
operator|->
name|iCLONlocationx
argument_list|,
name|pData
operator|->
name|iCLONlocationy
argument_list|)
expr_stmt|;
name|pClone
operator|=
name|pSource
expr_stmt|;
break|break;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* display on the fly ? */
if|if
condition|(
operator|(
name|pClone
operator|->
name|bViewable
operator|)
operator|&&
operator|(
name|pClone
operator|->
name|bVisible
operator|)
condition|)
block|{
name|pData
operator|->
name|pLastclone
operator|=
name|pClone
expr_stmt|;
comment|/* remember in case of timer break ! */
comment|/* display it */
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pClone
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer break ? */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|5
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_CLON
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_process_display_clon2
name|mng_retcode
name|mng_process_display_clon2
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_CLON
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* only called after timer break ! */
name|mng_display_image
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pLastclone
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_CLON
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_DISC
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_disc
name|mng_retcode
name|mng_process_display_disc
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint32
name|iCount
argument_list|,
name|mng_uint16p
name|pIds
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_disc
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_uint32
name|iX
decl_stmt|;
name|mng_imagep
name|pImage
decl_stmt|;
name|mng_uint32
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_DISC
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|iCount
condition|)
comment|/* specific list ? */
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|iDISCcount
condition|)
comment|/* specific list ? */
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|mng_uint16p
name|pWork
init|=
name|pIds
decl_stmt|;
else|#
directive|else
name|mng_uint16p
name|pWork
init|=
name|pData
operator|->
name|pDISCids
decl_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
comment|/* iterate the list */
for|for
control|(
name|iX
operator|=
name|iCount
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iCount
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
else|#
directive|else
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
comment|/* iterate the list */
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iDISCcount
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iDISCcount
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
endif|#
directive|endif
block|{
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
operator|*
name|pWork
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* found the object ? */
block|{
comment|/* then drop it */
name|iRetcode
operator|=
name|mng_free_imageobject
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
block|}
else|else
comment|/* empty: drop all un-frozen objects */
block|{
name|mng_imagep
name|pNext
init|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pFirstimgobj
decl_stmt|;
while|while
condition|(
name|pNext
condition|)
comment|/* any left ? */
block|{
name|pImage
operator|=
name|pNext
expr_stmt|;
name|pNext
operator|=
name|pImage
operator|->
name|sHeader
operator|.
name|pNext
expr_stmt|;
if|if
condition|(
operator|!
name|pImage
operator|->
name|bFrozen
condition|)
comment|/* not frozen ? */
block|{
comment|/* then drop it */
name|iRetcode
operator|=
name|mng_free_imageobject
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_DISC
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_FRAM
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_fram
name|mng_retcode
name|mng_process_display_fram
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint8
name|iFramemode
argument_list|,
name|mng_uint8
name|iChangedelay
argument_list|,
name|mng_uint32
name|iDelay
argument_list|,
name|mng_uint8
name|iChangetimeout
argument_list|,
name|mng_uint32
name|iTimeout
argument_list|,
name|mng_uint8
name|iChangeclipping
argument_list|,
name|mng_uint8
name|iCliptype
argument_list|,
name|mng_int32
name|iClipl
argument_list|,
name|mng_int32
name|iClipr
argument_list|,
name|mng_int32
name|iClipt
argument_list|,
name|mng_int32
name|iClipb
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_fram
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_FRAM
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* advance a frame then */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|iRetcode
operator|=
name|next_frame
argument_list|(
name|pData
argument_list|,
name|iFramemode
argument_list|,
name|iChangedelay
argument_list|,
name|iDelay
argument_list|,
name|iChangetimeout
argument_list|,
name|iTimeout
argument_list|,
name|iChangeclipping
argument_list|,
name|iCliptype
argument_list|,
name|iClipl
argument_list|,
name|iClipr
argument_list|,
name|iClipt
argument_list|,
name|iClipb
argument_list|)
expr_stmt|;
else|#
directive|else
name|iRetcode
operator|=
name|next_frame
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iTempFramemode
argument_list|,
name|pData
operator|->
name|iTempChangedelay
argument_list|,
name|pData
operator|->
name|iTempDelay
argument_list|,
name|pData
operator|->
name|iTempChangetimeout
argument_list|,
name|pData
operator|->
name|iTempTimeout
argument_list|,
name|pData
operator|->
name|iTempChangeclipping
argument_list|,
name|pData
operator|->
name|iTempCliptype
argument_list|,
name|pData
operator|->
name|iTempClipl
argument_list|,
name|pData
operator|->
name|iTempClipr
argument_list|,
name|pData
operator|->
name|iTempClipt
argument_list|,
name|pData
operator|->
name|iTempClipb
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer break ? */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_FRAM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_decl_stmt
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_process_display_fram2
name|mng_retcode
name|mng_process_display_fram2
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_FRAM
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* again; after the break */
name|iRetcode
operator|=
name|next_frame
argument_list|(
name|pData
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* not again! */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_FRAM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|iRetcode
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MOVE
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_move
name|mng_retcode
name|mng_process_display_move
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint16
name|iFromid
argument_list|,
name|mng_uint16
name|iToid
argument_list|,
name|mng_uint8
name|iMovetype
argument_list|,
name|mng_int32
name|iMovex
argument_list|,
name|mng_int32
name|iMovey
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_move
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_uint16
name|iX
decl_stmt|;
name|mng_imagep
name|pImage
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MOVE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* iterate the list */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
for|for
control|(
name|iX
operator|=
name|iFromid
init|;
name|iX
operator|<=
name|iToid
condition|;
name|iX
operator|++
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iMOVEfromid
init|;
name|iX
operator|<=
name|pData
operator|->
name|iMOVEtoid
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
if|if
condition|(
operator|!
name|iX
condition|)
comment|/* object id=0 ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
else|else
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iX
argument_list|)
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* object exists ? */
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
switch|switch
condition|(
name|iMovetype
condition|)
else|#
directive|else
switch|switch
condition|(
name|pData
operator|->
name|iMOVEmovetype
condition|)
endif|#
directive|endif
block|{
case|case
literal|0
case|:
block|{
comment|/* absolute */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pImage
operator|->
name|iPosx
operator|=
name|iMovex
expr_stmt|;
name|pImage
operator|->
name|iPosy
operator|=
name|iMovey
expr_stmt|;
else|#
directive|else
name|pImage
operator|->
name|iPosx
operator|=
name|pData
operator|->
name|iMOVEmovex
expr_stmt|;
name|pImage
operator|->
name|iPosy
operator|=
name|pData
operator|->
name|iMOVEmovey
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|1
case|:
block|{
comment|/* relative */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pImage
operator|->
name|iPosx
operator|=
name|pImage
operator|->
name|iPosx
operator|+
name|iMovex
expr_stmt|;
name|pImage
operator|->
name|iPosy
operator|=
name|pImage
operator|->
name|iPosy
operator|+
name|iMovey
expr_stmt|;
else|#
directive|else
name|pImage
operator|->
name|iPosx
operator|=
name|pImage
operator|->
name|iPosx
operator|+
name|pData
operator|->
name|iMOVEmovex
expr_stmt|;
name|pImage
operator|->
name|iPosy
operator|=
name|pImage
operator|->
name|iPosy
operator|+
name|pData
operator|->
name|iMOVEmovey
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MOVE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_CLIP
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_clip
name|mng_retcode
name|mng_process_display_clip
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint16
name|iFromid
argument_list|,
name|mng_uint16
name|iToid
argument_list|,
name|mng_uint8
name|iCliptype
argument_list|,
name|mng_int32
name|iClipl
argument_list|,
name|mng_int32
name|iClipr
argument_list|,
name|mng_int32
name|iClipt
argument_list|,
name|mng_int32
name|iClipb
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_clip
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_uint16
name|iX
decl_stmt|;
name|mng_imagep
name|pImage
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_CLIP
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* iterate the list */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
for|for
control|(
name|iX
operator|=
name|iFromid
init|;
name|iX
operator|<=
name|iToid
condition|;
name|iX
operator|++
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iCLIPfromid
init|;
name|iX
operator|<=
name|pData
operator|->
name|iCLIPtoid
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
if|if
condition|(
operator|!
name|iX
condition|)
comment|/* object id=0 ? */
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
else|else
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iX
argument_list|)
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* object exists ? */
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
switch|switch
condition|(
name|iCliptype
condition|)
else|#
directive|else
switch|switch
condition|(
name|pData
operator|->
name|iCLIPcliptype
condition|)
endif|#
directive|endif
block|{
case|case
literal|0
case|:
block|{
comment|/* absolute */
name|pImage
operator|->
name|bClipped
operator|=
name|MNG_TRUE
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pImage
operator|->
name|iClipl
operator|=
name|iClipl
expr_stmt|;
name|pImage
operator|->
name|iClipr
operator|=
name|iClipr
expr_stmt|;
name|pImage
operator|->
name|iClipt
operator|=
name|iClipt
expr_stmt|;
name|pImage
operator|->
name|iClipb
operator|=
name|iClipb
expr_stmt|;
else|#
directive|else
name|pImage
operator|->
name|iClipl
operator|=
name|pData
operator|->
name|iCLIPclipl
expr_stmt|;
name|pImage
operator|->
name|iClipr
operator|=
name|pData
operator|->
name|iCLIPclipr
expr_stmt|;
name|pImage
operator|->
name|iClipt
operator|=
name|pData
operator|->
name|iCLIPclipt
expr_stmt|;
name|pImage
operator|->
name|iClipb
operator|=
name|pData
operator|->
name|iCLIPclipb
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|1
case|:
block|{
comment|/* relative */
name|pImage
operator|->
name|bClipped
operator|=
name|MNG_TRUE
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pImage
operator|->
name|iClipl
operator|=
name|pImage
operator|->
name|iClipl
operator|+
name|iClipl
expr_stmt|;
name|pImage
operator|->
name|iClipr
operator|=
name|pImage
operator|->
name|iClipr
operator|+
name|iClipr
expr_stmt|;
name|pImage
operator|->
name|iClipt
operator|=
name|pImage
operator|->
name|iClipt
operator|+
name|iClipt
expr_stmt|;
name|pImage
operator|->
name|iClipb
operator|=
name|pImage
operator|->
name|iClipb
operator|+
name|iClipb
expr_stmt|;
else|#
directive|else
name|pImage
operator|->
name|iClipl
operator|=
name|pImage
operator|->
name|iClipl
operator|+
name|pData
operator|->
name|iCLIPclipl
expr_stmt|;
name|pImage
operator|->
name|iClipr
operator|=
name|pImage
operator|->
name|iClipr
operator|+
name|pData
operator|->
name|iCLIPclipr
expr_stmt|;
name|pImage
operator|->
name|iClipt
operator|=
name|pImage
operator|->
name|iClipt
operator|+
name|pData
operator|->
name|iCLIPclipt
expr_stmt|;
name|pImage
operator|->
name|iClipb
operator|=
name|pImage
operator|->
name|iClipb
operator|+
name|pData
operator|->
name|iCLIPclipb
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_CLIP
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SHOW
end_ifndef
begin_function
DECL|function|mng_process_display_show
name|mng_retcode
name|mng_process_display_show
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_int16
name|iX
decl_stmt|,
name|iS
decl_stmt|,
name|iFrom
decl_stmt|,
name|iTo
decl_stmt|;
name|mng_imagep
name|pImage
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_SHOW
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* TODO: optimization for the cases where "abs (iTo - iFrom)" is rather high;      especially where ((iFrom==1)&& (iTo==65535)); eg. an empty SHOW !!! */
if|if
condition|(
name|pData
operator|->
name|iBreakpoint
operator|==
literal|3
condition|)
comment|/* previously broken during cycle-mode ? */
block|{
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iSHOWnextid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* still there ? */
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* let's not go through this again! */
block|}
else|else
block|{
if|if
condition|(
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* previously broken at other point ? */
block|{
comment|/* restore last parms */
name|iFrom
operator|=
operator|(
name|mng_int16
operator|)
name|pData
operator|->
name|iSHOWfromid
expr_stmt|;
name|iTo
operator|=
operator|(
name|mng_int16
operator|)
name|pData
operator|->
name|iSHOWtoid
expr_stmt|;
name|iX
operator|=
operator|(
name|mng_int16
operator|)
name|pData
operator|->
name|iSHOWnextid
expr_stmt|;
name|iS
operator|=
operator|(
name|mng_int16
operator|)
name|pData
operator|->
name|iSHOWskip
expr_stmt|;
block|}
else|else
block|{
comment|/* regular sequence ? */
if|if
condition|(
name|pData
operator|->
name|iSHOWtoid
operator|>=
name|pData
operator|->
name|iSHOWfromid
condition|)
name|iS
operator|=
literal|1
expr_stmt|;
else|else
comment|/* reverse sequence ! */
name|iS
operator|=
operator|-
literal|1
expr_stmt|;
name|iFrom
operator|=
operator|(
name|mng_int16
operator|)
name|pData
operator|->
name|iSHOWfromid
expr_stmt|;
name|iTo
operator|=
operator|(
name|mng_int16
operator|)
name|pData
operator|->
name|iSHOWtoid
expr_stmt|;
name|iX
operator|=
name|iFrom
expr_stmt|;
name|pData
operator|->
name|iSHOWfromid
operator|=
operator|(
name|mng_uint16
operator|)
name|iFrom
expr_stmt|;
name|pData
operator|->
name|iSHOWtoid
operator|=
operator|(
name|mng_uint16
operator|)
name|iTo
expr_stmt|;
name|pData
operator|->
name|iSHOWskip
operator|=
name|iS
expr_stmt|;
block|}
comment|/* cycle mode ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iSHOWmode
operator|==
literal|6
operator|)
operator|||
operator|(
name|pData
operator|->
name|iSHOWmode
operator|==
literal|7
operator|)
condition|)
block|{
name|mng_uint16
name|iTrigger
init|=
literal|0
decl_stmt|;
name|mng_uint16
name|iFound
init|=
literal|0
decl_stmt|;
name|mng_uint16
name|iPass
init|=
literal|0
decl_stmt|;
name|mng_imagep
name|pFound
init|=
literal|0
decl_stmt|;
do|do
block|{
name|iPass
operator|++
expr_stmt|;
comment|/* lets prevent endless loops when there                                           are no potential candidates in the list! */
if|if
condition|(
name|iS
operator|>
literal|0
condition|)
comment|/* forward ? */
block|{
for|for
control|(
name|iX
operator|=
name|iFrom
init|;
name|iX
operator|<=
name|iTo
condition|;
name|iX
operator|+=
name|iS
control|)
block|{
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_uint16
operator|)
name|iX
argument_list|)
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* object exists ? */
block|{
if|if
condition|(
name|iFound
condition|)
comment|/* already found a candidate ? */
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_FALSE
expr_stmt|;
elseif|else
if|if
condition|(
name|iTrigger
condition|)
comment|/* found the trigger ? */
block|{
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_TRUE
expr_stmt|;
name|iFound
operator|=
name|iX
expr_stmt|;
name|pFound
operator|=
name|pImage
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pImage
operator|->
name|bVisible
condition|)
comment|/* ok, this is the trigger */
block|{
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_FALSE
expr_stmt|;
name|iTrigger
operator|=
name|iX
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
for|for
control|(
name|iX
operator|=
name|iFrom
init|;
name|iX
operator|>=
name|iTo
condition|;
name|iX
operator|+=
name|iS
control|)
block|{
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_uint16
operator|)
name|iX
argument_list|)
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* object exists ? */
block|{
if|if
condition|(
name|iFound
condition|)
comment|/* already found a candidate ? */
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_FALSE
expr_stmt|;
elseif|else
if|if
condition|(
name|iTrigger
condition|)
comment|/* found the trigger ? */
block|{
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_TRUE
expr_stmt|;
name|iFound
operator|=
name|iX
expr_stmt|;
name|pFound
operator|=
name|pImage
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pImage
operator|->
name|bVisible
condition|)
comment|/* ok, this is the trigger */
block|{
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_FALSE
expr_stmt|;
name|iTrigger
operator|=
name|iX
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
operator|!
name|iTrigger
condition|)
comment|/* did not find a trigger ? */
name|iTrigger
operator|=
literal|1
expr_stmt|;
comment|/* then fake it so the first image                                           gets nominated */
block|}
comment|/* cycle back to beginning ? */
do|while
condition|(
operator|(
name|iPass
operator|<
literal|2
operator|)
operator|&&
operator|(
name|iTrigger
operator|)
operator|&&
operator|(
operator|!
name|iFound
operator|)
condition|)
do|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* just a sanity precaution */
comment|/* display it ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iSHOWmode
operator|==
literal|6
operator|)
operator|&&
operator|(
name|pFound
operator|)
condition|)
block|{
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pFound
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer set ? */
block|{
name|pData
operator|->
name|iBreakpoint
operator|=
literal|3
expr_stmt|;
name|pData
operator|->
name|iSHOWnextid
operator|=
name|iFound
expr_stmt|;
comment|/* save it for after the break */
block|}
block|}
block|}
else|else
block|{
do|do
block|{
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iX
argument_list|)
expr_stmt|;
if|if
condition|(
name|pImage
condition|)
comment|/* object exists ? */
block|{
if|if
condition|(
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* did we get broken last time ? */
block|{
comment|/* could only happen in the display routine */
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* only once inside this loop please ! */
block|}
else|else
block|{
switch|switch
condition|(
name|pData
operator|->
name|iSHOWmode
condition|)
comment|/* do what ? */
block|{
case|case
literal|0
case|:
block|{
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_TRUE
expr_stmt|;
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|1
case|:
block|{
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
name|pImage
operator|->
name|bVisible
condition|)
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
name|pImage
operator|->
name|bVisible
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pImage
operator|->
name|bVisible
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pImage
operator|->
name|bVisible
argument_list|)
expr_stmt|;
if|if
condition|(
name|pImage
operator|->
name|bVisible
condition|)
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|5
case|:
block|{
name|pImage
operator|->
name|bVisible
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pImage
operator|->
name|bVisible
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
comment|/* next ? */
name|iX
operator|+=
name|iS
expr_stmt|;
block|}
comment|/* continue ? */
do|while
condition|(
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
operator|&&
operator|(
operator|(
operator|(
name|iS
operator|>
literal|0
operator|)
operator|&&
operator|(
name|iX
operator|<=
name|iTo
operator|)
operator|)
operator|||
operator|(
operator|(
name|iS
operator|<
literal|0
operator|)
operator|&&
operator|(
name|iX
operator|>=
name|iTo
operator|)
operator|)
operator|)
condition|)
do|;
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer set ? */
block|{
name|pData
operator|->
name|iBreakpoint
operator|=
literal|4
expr_stmt|;
name|pData
operator|->
name|iSHOWnextid
operator|=
name|iX
expr_stmt|;
comment|/* save for next time */
block|}
else|else
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_SHOW
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SAVE
end_ifndef
begin_function
DECL|function|mng_process_display_save
name|mng_retcode
name|mng_process_display_save
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_SAVE
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|iRetcode
operator|=
name|save_state
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* save the current state */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_SAVE
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_SEEK
end_ifndef
begin_function
DECL|function|mng_process_display_seek
name|mng_retcode
name|mng_process_display_seek
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_SEEK
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DYNAMICMNG
if|if
condition|(
name|pData
operator|->
name|bStopafterseek
condition|)
comment|/* need to stop after this SEEK ? */
block|{
name|pData
operator|->
name|bFreezing
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* stop processing on this one */
name|pData
operator|->
name|bRunningevent
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bStopafterseek
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|bNeedrefresh
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* make sure the last bit is displayed ! */
block|}
else|else
endif|#
directive|endif
block|{
comment|/* restore the initial or SAVE state */
name|mng_retcode
name|iRetcode
init|=
name|restore_state
argument_list|(
name|pData
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_DYNAMICMNG
comment|/* stop after next SEEK ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|bDynamic
operator|)
operator|||
operator|(
name|pData
operator|->
name|bRunningevent
operator|)
condition|)
name|pData
operator|->
name|bStopafterseek
operator|=
name|MNG_TRUE
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_SEEK
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_function
DECL|function|mng_process_display_jhdr
name|mng_retcode
name|mng_process_display_jhdr
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
comment|/* address the current "object" if any */
name|mng_imagep
name|pImage
init|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pCurrentobj
decl_stmt|;
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_JHDR
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasDHDR
condition|)
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* do nothing by default */
name|pData
operator|->
name|fDisplayrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fCorrectrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fStorerow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fProcessrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fDifferrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fStorerow2
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fStorerow3
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|pStoreobj
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* initialize important work-parms */
name|pData
operator|->
name|iJPEGrow
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iJPEGalpharow
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iJPEGrgbrow
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iRowmax
operator|=
literal|0
expr_stmt|;
comment|/* so init_rowproc does the right thing ! */
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|iBreakpoint
condition|)
comment|/* not previously broken ? */
block|{
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
name|pData
operator|->
name|bHasDHDR
condition|)
comment|/* delta-image ? */
block|{
if|if
condition|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
condition|)
block|{
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iJHDRimgbitdepth
argument_list|,
name|pData
operator|->
name|iJHDRcolortype
argument_list|,
name|pData
operator|->
name|iJHDRalphacompression
argument_list|,
name|pData
operator|->
name|iJHDRalphafilter
argument_list|,
name|pData
operator|->
name|iJHDRalphainterlace
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iAlphabitdepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iJHDRcompression
operator|=
name|pData
operator|->
name|iJHDRimgcompression
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iJHDRinterlace
operator|=
name|pData
operator|->
name|iJHDRimginterlace
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iAlphasampledepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
operator|)
condition|)
block|{
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iPixelsampledepth
operator|=
name|pData
operator|->
name|iJHDRimgbitdepth
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iAlphasampledepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAREPLACE
operator|)
condition|)
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iAlphasampledepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORREPLACE
operator|)
condition|)
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iPixelsampledepth
operator|=
name|pData
operator|->
name|iJHDRimgbitdepth
expr_stmt|;
block|}
else|else
endif|#
directive|endif
comment|/* MNG_NO_DELTA_PNG */
block|{
if|if
condition|(
name|pImage
condition|)
comment|/* update object buffer ? */
block|{
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iJHDRimgbitdepth
argument_list|,
name|pData
operator|->
name|iJHDRcolortype
argument_list|,
name|pData
operator|->
name|iJHDRalphacompression
argument_list|,
name|pData
operator|->
name|iJHDRalphafilter
argument_list|,
name|pData
operator|->
name|iJHDRalphainterlace
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|iAlphabitdepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|iJHDRcompression
operator|=
name|pData
operator|->
name|iJHDRimgcompression
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|iJHDRinterlace
operator|=
name|pData
operator|->
name|iJHDRimginterlace
expr_stmt|;
name|pImage
operator|->
name|pImgbuf
operator|->
name|iAlphasampledepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
block|}
else|else
comment|/* update object 0 */
block|{
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iJHDRimgbitdepth
argument_list|,
name|pData
operator|->
name|iJHDRcolortype
argument_list|,
name|pData
operator|->
name|iJHDRalphacompression
argument_list|,
name|pData
operator|->
name|iJHDRalphafilter
argument_list|,
name|pData
operator|->
name|iJHDRalphainterlace
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
operator|)
operator|->
name|pImgbuf
operator|->
name|iAlphabitdepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
operator|)
operator|->
name|pImgbuf
operator|->
name|iJHDRcompression
operator|=
name|pData
operator|->
name|iJHDRimgcompression
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
operator|)
operator|->
name|pImgbuf
operator|->
name|iJHDRinterlace
operator|=
name|pData
operator|->
name|iJHDRimginterlace
expr_stmt|;
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
operator|)
operator|->
name|pImgbuf
operator|->
name|iAlphasampledepth
operator|=
name|pData
operator|->
name|iJHDRalphabitdepth
expr_stmt|;
block|}
block|}
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bHasDHDR
condition|)
block|{
comment|/* we're always storing a JPEG */
if|if
condition|(
name|pImage
condition|)
comment|/* real object ? */
name|pData
operator|->
name|pStoreobj
operator|=
name|pImage
expr_stmt|;
comment|/* tell the row routines */
else|else
comment|/* otherwise use object 0 */
name|pData
operator|->
name|pStoreobj
operator|=
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* display "on-the-fly" ? */
if|if
condition|(
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
operator|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pStoreobj
operator|)
operator|->
name|iMAGN_MethodX
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pStoreobj
operator|)
operator|->
name|iMAGN_MethodY
operator|==
literal|0
operator|)
operator|&&
endif|#
directive|endif
operator|(
operator|(
name|pData
operator|->
name|eImagetype
operator|==
name|mng_it_jng
operator|)
operator|||
operator|(
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pStoreobj
operator|)
operator|->
name|bVisible
operator|)
operator|)
condition|)
block|{
name|next_layer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* that's a new layer then ! */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* timer break ? */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|7
expr_stmt|;
elseif|else
if|if
condition|(
name|pData
operator|->
name|bRunning
condition|)
comment|/* still running ? */
block|{
comment|/* anything to display ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDestr
operator|>
name|pData
operator|->
name|iDestl
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDestb
operator|>
name|pData
operator|->
name|iDestt
operator|)
condition|)
block|{
name|set_display_routine
argument_list|(
name|pData
argument_list|)
expr_stmt|;
comment|/* then determine display routine */
comment|/* display from the object we store in */
name|pData
operator|->
name|pRetrieveobj
operator|=
name|pData
operator|->
name|pStoreobj
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bTimerset
condition|)
comment|/* no timer break ? */
block|{
comment|/* default row initialization ! */
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_FOOTPRINT_INIT
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_none
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rowproc
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|pData
operator|->
name|bHasDHDR
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
operator|)
condition|)
block|{
comment|/* 8-bit JPEG ? */
if|if
condition|(
name|pData
operator|->
name|iJHDRimgbitdepth
operator|==
literal|8
condition|)
block|{
comment|/* intermediate row is 8-bit deep */
name|pData
operator|->
name|bIsRGBA16
operator|=
name|MNG_FALSE
expr_stmt|;
name|pData
operator|->
name|iRowsamples
operator|=
name|pData
operator|->
name|iDatawidth
expr_stmt|;
switch|switch
condition|(
name|pData
operator|->
name|iJHDRcolortype
condition|)
comment|/* determine pixel processing routines */
block|{
case|case
name|MNG_COLORTYPE_JPEGGRAY
case|:
block|{
name|pData
operator|->
name|fStorerow2
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_store_jpeg_g8
expr_stmt|;
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
name|MNG_COLORTYPE_JPEGCOLOR
case|:
block|{
name|pData
operator|->
name|fStorerow2
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_store_jpeg_rgb8
expr_stmt|;
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
name|MNG_COLORTYPE_JPEGGRAYA
case|:
block|{
name|pData
operator|->
name|fStorerow2
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_store_jpeg_ga8
expr_stmt|;
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
name|MNG_COLORTYPE_JPEGCOLORA
case|:
block|{
name|pData
operator|->
name|fStorerow2
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_store_jpeg_rgba8
expr_stmt|;
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
block|}
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
else|else
block|{
name|pData
operator|->
name|bIsRGBA16
operator|=
name|MNG_TRUE
expr_stmt|;
comment|/* intermediate row is 16-bit deep */
comment|/* TODO: 12-bit JPEG */
comment|/* TODO: 8- + 12-bit JPEG (eg. type=20) */
block|}
endif|#
directive|endif
comment|/* possible IDAT alpha-channel ? */
if|if
condition|(
name|pData
operator|->
name|iJHDRalphacompression
operator|==
name|MNG_COMPRESSION_DEFLATE
condition|)
block|{
comment|/* determine alpha processing routine */
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_FOOTPRINT_INIT
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rowproc
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|pData
operator|->
name|iJHDRalphabitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_FOOTPRINT_INIT
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_jpeg_a1_ni
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_jpeg_a2_ni
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_jpeg_a4_ni
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_jpeg_a8_ni
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_jpeg_a16_ni
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
else|#
directive|else
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a1
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a2
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a4
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
endif|#
directive|endif
block|}
block|}
elseif|else
comment|/* possible JDAA alpha-channel ? */
if|if
condition|(
name|pData
operator|->
name|iJHDRalphacompression
operator|==
name|MNG_COMPRESSION_BASELINEJPEG
condition|)
block|{
comment|/* 8-bit JPEG ? */
if|if
condition|(
name|pData
operator|->
name|iJHDRimgbitdepth
operator|==
literal|8
condition|)
block|{
if|if
condition|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
condition|)
name|pData
operator|->
name|fStorerow3
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_store_jpeg_g8_alpha
expr_stmt|;
elseif|else
if|if
condition|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
condition|)
name|pData
operator|->
name|fStorerow3
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_store_jpeg_rgb8_alpha
expr_stmt|;
block|}
else|else
block|{
comment|/* TODO: 12-bit JPEG with 8-bit JDAA */
block|}
block|}
comment|/* initialize JPEG library */
name|iRetcode
operator|=
name|mngjpeg_initialize
argument_list|(
name|pData
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
else|else
block|{
comment|/* must be alpha add/replace !! */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDeltatype
operator|!=
name|MNG_DELTATYPE_BLOCKALPHAADD
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDeltatype
operator|!=
name|MNG_DELTATYPE_BLOCKALPHAREPLACE
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVDELTATYPE
argument_list|)
expr_stmt|;
comment|/* determine alpha processing routine */
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_FOOTPRINT_INIT
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rowproc
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|pData
operator|->
name|iJHDRalphabitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_FOOTPRINT_INIT
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g1_ni
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g2_ni
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g4_ni
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g8_ni
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g16_ni
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
else|#
directive|else
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a1
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a2
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a4
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a8
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
name|pData
operator|->
name|ePng_imgtype
operator|=
name|png_jpeg_a16
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
endif|#
directive|endif
comment|/* MNG_OPTIMIZE_FOOTPRINT_INIT */
block|}
block|}
name|pData
operator|->
name|iFilterofs
operator|=
literal|0
expr_stmt|;
comment|/* determine filter characteristics */
name|pData
operator|->
name|iLevel0
operator|=
literal|0
expr_stmt|;
comment|/* default levels */
name|pData
operator|->
name|iLevel1
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iLevel2
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iLevel3
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FILTER192
comment|/* leveling& differing ? */
if|if
condition|(
name|pData
operator|->
name|iJHDRalphafilter
operator|==
literal|0xC0
condition|)
block|{
if|if
condition|(
name|pData
operator|->
name|iJHDRalphabitdepth
operator|<=
literal|8
condition|)
name|pData
operator|->
name|iFilterofs
operator|=
literal|1
expr_stmt|;
else|else
name|pData
operator|->
name|iFilterofs
operator|=
literal|2
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FILTER193
comment|/* no adaptive filtering ? */
if|if
condition|(
name|pData
operator|->
name|iJHDRalphafilter
operator|==
literal|0xC1
condition|)
name|pData
operator|->
name|iPixelofs
operator|=
name|pData
operator|->
name|iFilterofs
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|iPixelofs
operator|=
name|pData
operator|->
name|iFilterofs
operator|+
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_JHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_jdaa
name|mng_retcode
name|mng_process_display_jdaa
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint32
name|iRawlen
argument_list|,
name|mng_uint8p
name|pRawdata
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_jdaa
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_JDAA
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|bJPEGdecompress2
condition|)
comment|/* if we're not decompressing already */
block|{
if|if
condition|(
name|pData
operator|->
name|fInitrowproc
condition|)
comment|/* initialize row-processing? */
block|{
name|iRetcode
operator|=
operator|(
operator|(
name|mng_initrowproc
operator|)
name|pData
operator|->
name|fInitrowproc
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
name|pData
operator|->
name|fInitrowproc
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* only call this once !!! */
block|}
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* initialize decompress */
name|iRetcode
operator|=
name|mngjpeg_decompressinit2
argument_list|(
name|pData
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* all ok? then decompress, my man */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|iRetcode
operator|=
name|mngjpeg_decompressdata2
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
else|#
directive|else
name|iRetcode
operator|=
name|mngjpeg_decompressdata2
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iRawlen
argument_list|,
name|pData
operator|->
name|pRawdata
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_JDAA
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_jdat
name|mng_retcode
name|mng_process_display_jdat
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint32
name|iRawlen
argument_list|,
name|mng_uint8p
name|pRawdata
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_jdat
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_JDAT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|bRestorebkgd
condition|)
comment|/* need to restore the background ? */
block|{
name|pData
operator|->
name|bRestorebkgd
operator|=
name|MNG_FALSE
expr_stmt|;
name|iRetcode
operator|=
name|load_bkgdlayer
argument_list|(
name|pData
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iLayerseq
operator|++
expr_stmt|;
comment|/* and it counts as a layer then ! */
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
if|if
condition|(
operator|!
name|pData
operator|->
name|bJPEGdecompress
condition|)
comment|/* if we're not decompressing already */
block|{
if|if
condition|(
name|pData
operator|->
name|fInitrowproc
condition|)
comment|/* initialize row-processing? */
block|{
name|iRetcode
operator|=
operator|(
operator|(
name|mng_initrowproc
operator|)
name|pData
operator|->
name|fInitrowproc
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
name|pData
operator|->
name|fInitrowproc
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* only call this once !!! */
block|}
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* initialize decompress */
name|iRetcode
operator|=
name|mngjpeg_decompressinit
argument_list|(
name|pData
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* all ok? then decompress, my man */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|iRetcode
operator|=
name|mngjpeg_decompressdata
argument_list|(
name|pData
argument_list|,
name|iRawlen
argument_list|,
name|pRawdata
argument_list|)
expr_stmt|;
else|#
directive|else
name|iRetcode
operator|=
name|mngjpeg_decompressdata
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iRawlen
argument_list|,
name|pData
operator|->
name|pRawdata
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_JDAT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_JNG */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_dhdr
name|mng_retcode
name|mng_process_display_dhdr
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint16
name|iObjectid
argument_list|,
name|mng_uint8
name|iImagetype
argument_list|,
name|mng_uint8
name|iDeltatype
argument_list|,
name|mng_uint32
name|iBlockwidth
argument_list|,
name|mng_uint32
name|iBlockheight
argument_list|,
name|mng_uint32
name|iBlockx
argument_list|,
name|mng_uint32
name|iBlocky
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_dhdr
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_imagep
name|pImage
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_DHDR
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|fInitrowproc
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* do nothing by default */
name|pData
operator|->
name|fDisplayrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fCorrectrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fStorerow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fProcessrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|pStoreobj
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fDeltagetrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fDeltaaddrow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fDeltareplacerow
operator|=
name|MNG_NULL
expr_stmt|;
name|pData
operator|->
name|fDeltaputrow
operator|=
name|MNG_NULL
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iObjectid
argument_list|)
expr_stmt|;
else|#
directive|else
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iDHDRobjectid
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pImage
condition|)
comment|/* object exists ? */
block|{
if|if
condition|(
name|pImage
operator|->
name|pImgbuf
operator|->
name|bConcrete
condition|)
comment|/* is it concrete ? */
block|{
comment|/* previous magnification to be done ? */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
if|if
condition|(
operator|(
name|pImage
operator|->
name|iMAGN_MethodX
operator|)
operator|||
operator|(
name|pImage
operator|->
name|iMAGN_MethodY
operator|)
condition|)
block|{
name|iRetcode
operator|=
name|mng_magnify_imageobject
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
endif|#
directive|endif
comment|/* save delta fields */
name|pData
operator|->
name|pDeltaImage
operator|=
operator|(
name|mng_ptr
operator|)
name|pImage
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pData
operator|->
name|iDeltaImagetype
operator|=
name|iImagetype
expr_stmt|;
name|pData
operator|->
name|iDeltatype
operator|=
name|iDeltatype
expr_stmt|;
name|pData
operator|->
name|iDeltaBlockwidth
operator|=
name|iBlockwidth
expr_stmt|;
name|pData
operator|->
name|iDeltaBlockheight
operator|=
name|iBlockheight
expr_stmt|;
name|pData
operator|->
name|iDeltaBlockx
operator|=
name|iBlockx
expr_stmt|;
name|pData
operator|->
name|iDeltaBlocky
operator|=
name|iBlocky
expr_stmt|;
else|#
directive|else
name|pData
operator|->
name|iDeltaImagetype
operator|=
name|pData
operator|->
name|iDHDRimagetype
expr_stmt|;
name|pData
operator|->
name|iDeltatype
operator|=
name|pData
operator|->
name|iDHDRdeltatype
expr_stmt|;
name|pData
operator|->
name|iDeltaBlockwidth
operator|=
name|pData
operator|->
name|iDHDRblockwidth
expr_stmt|;
name|pData
operator|->
name|iDeltaBlockheight
operator|=
name|pData
operator|->
name|iDHDRblockheight
expr_stmt|;
name|pData
operator|->
name|iDeltaBlockx
operator|=
name|pData
operator|->
name|iDHDRblockx
expr_stmt|;
name|pData
operator|->
name|iDeltaBlocky
operator|=
name|pData
operator|->
name|iDHDRblocky
expr_stmt|;
endif|#
directive|endif
comment|/* restore target-object fields */
name|pData
operator|->
name|iDatawidth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iDataheight
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iHeight
expr_stmt|;
name|pData
operator|->
name|iBitdepth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
expr_stmt|;
name|pData
operator|->
name|iColortype
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iColortype
expr_stmt|;
name|pData
operator|->
name|iCompression
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iCompression
expr_stmt|;
name|pData
operator|->
name|iFilter
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iFilter
expr_stmt|;
name|pData
operator|->
name|iInterlace
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iInterlace
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELADD
operator|)
operator|||
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
operator|)
condition|)
name|pData
operator|->
name|iBitdepth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iPixelsampledepth
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAADD
operator|)
operator|||
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAREPLACE
operator|)
condition|)
name|pData
operator|->
name|iBitdepth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iAlphasampledepth
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORADD
operator|)
operator|||
operator|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORREPLACE
operator|)
condition|)
name|pData
operator|->
name|iBitdepth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iPixelsampledepth
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDHDRdeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDHDRdeltatype
operator|==
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
operator|)
condition|)
name|pData
operator|->
name|iBitdepth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iPixelsampledepth
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDHDRdeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDHDRdeltatype
operator|==
name|MNG_DELTATYPE_BLOCKALPHAREPLACE
operator|)
condition|)
name|pData
operator|->
name|iBitdepth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iAlphasampledepth
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iDHDRdeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORADD
operator|)
operator|||
operator|(
name|pData
operator|->
name|iDHDRdeltatype
operator|==
name|MNG_DELTATYPE_BLOCKCOLORREPLACE
operator|)
condition|)
name|pData
operator|->
name|iBitdepth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iPixelsampledepth
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
name|pData
operator|->
name|iJHDRimgbitdepth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iBitdepth
expr_stmt|;
name|pData
operator|->
name|iJHDRcolortype
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iColortype
expr_stmt|;
name|pData
operator|->
name|iJHDRimgcompression
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iJHDRcompression
expr_stmt|;
name|pData
operator|->
name|iJHDRimginterlace
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iJHDRinterlace
expr_stmt|;
name|pData
operator|->
name|iJHDRalphacompression
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iCompression
expr_stmt|;
name|pData
operator|->
name|iJHDRalphafilter
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iFilter
expr_stmt|;
name|pData
operator|->
name|iJHDRalphainterlace
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iInterlace
expr_stmt|;
name|pData
operator|->
name|iJHDRalphabitdepth
operator|=
name|pImage
operator|->
name|pImgbuf
operator|->
name|iAlphabitdepth
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
comment|/* block size specified ? */
if|if
condition|(
name|iDeltatype
operator|!=
name|MNG_DELTATYPE_NOCHANGE
condition|)
block|{
comment|/* block entirely within target ? */
if|if
condition|(
name|iDeltatype
operator|!=
name|MNG_DELTATYPE_REPLACE
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|iBlockx
operator|+
name|iBlockwidth
operator|)
operator|>
name|pData
operator|->
name|iDatawidth
operator|)
operator|||
operator|(
operator|(
name|iBlocky
operator|+
name|iBlockheight
operator|)
operator|>
name|pData
operator|->
name|iDataheight
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBLOCK
argument_list|)
expr_stmt|;
block|}
name|pData
operator|->
name|iDatawidth
operator|=
name|iBlockwidth
expr_stmt|;
name|pData
operator|->
name|iDataheight
operator|=
name|iBlockheight
expr_stmt|;
block|}
else|#
directive|else
comment|/* block size specified ? */
if|if
condition|(
name|pData
operator|->
name|iDHDRdeltatype
operator|!=
name|MNG_DELTATYPE_NOCHANGE
condition|)
block|{
comment|/* block entirely within target ? */
if|if
condition|(
name|pData
operator|->
name|iDHDRdeltatype
operator|!=
name|MNG_DELTATYPE_REPLACE
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|pData
operator|->
name|iDHDRblockx
operator|+
name|pData
operator|->
name|iDHDRblockwidth
operator|)
operator|>
name|pData
operator|->
name|iDatawidth
operator|)
operator|||
operator|(
operator|(
name|pData
operator|->
name|iDHDRblocky
operator|+
name|pData
operator|->
name|iDHDRblockheight
operator|)
operator|>
name|pData
operator|->
name|iDataheight
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBLOCK
argument_list|)
expr_stmt|;
block|}
name|pData
operator|->
name|iDatawidth
operator|=
name|pData
operator|->
name|iDHDRblockwidth
expr_stmt|;
name|pData
operator|->
name|iDataheight
operator|=
name|pData
operator|->
name|iDHDRblockheight
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
switch|switch
condition|(
name|iDeltatype
condition|)
comment|/* determine nr of delta-channels */
else|#
directive|else
switch|switch
condition|(
name|pData
operator|->
name|iDHDRdeltatype
condition|)
comment|/* determine nr of delta-channels */
endif|#
directive|endif
block|{
case|case
name|MNG_DELTATYPE_BLOCKALPHAADD
case|:
empty_stmt|;
case|case
name|MNG_DELTATYPE_BLOCKALPHAREPLACE
case|:
block|{
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
condition|)
block|{
name|pData
operator|->
name|iColortype
operator|=
name|MNG_COLORTYPE_GRAY
expr_stmt|;
name|pData
operator|->
name|iJHDRcolortype
operator|=
name|MNG_COLORTYPE_JPEGGRAY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGBA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
condition|)
block|{
name|pData
operator|->
name|iColortype
operator|=
name|MNG_COLORTYPE_GRAY
expr_stmt|;
name|pData
operator|->
name|iJHDRcolortype
operator|=
name|MNG_COLORTYPE_JPEGGRAY
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
condition|)
name|pData
operator|->
name|iColortype
operator|=
name|MNG_COLORTYPE_GRAY
expr_stmt|;
elseif|else
if|if
condition|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGBA
condition|)
name|pData
operator|->
name|iColortype
operator|=
name|MNG_COLORTYPE_GRAY
expr_stmt|;
endif|#
directive|endif
else|else
comment|/* target has no alpha; that sucks! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_TARGETNOALPHA
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|MNG_DELTATYPE_BLOCKCOLORADD
case|:
empty_stmt|;
case|case
name|MNG_DELTATYPE_BLOCKCOLORREPLACE
case|:
block|{
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
condition|)
block|{
name|pData
operator|->
name|iColortype
operator|=
name|MNG_COLORTYPE_GRAY
expr_stmt|;
name|pData
operator|->
name|iJHDRcolortype
operator|=
name|MNG_COLORTYPE_JPEGGRAY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGBA
operator|)
operator|||
operator|(
name|pData
operator|->
name|iJHDRcolortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
condition|)
block|{
name|pData
operator|->
name|iColortype
operator|=
name|MNG_COLORTYPE_RGB
expr_stmt|;
name|pData
operator|->
name|iJHDRcolortype
operator|=
name|MNG_COLORTYPE_JPEGCOLOR
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
condition|)
name|pData
operator|->
name|iColortype
operator|=
name|MNG_COLORTYPE_GRAY
expr_stmt|;
elseif|else
if|if
condition|(
name|pData
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGBA
condition|)
name|pData
operator|->
name|iColortype
operator|=
name|MNG_COLORTYPE_RGB
expr_stmt|;
endif|#
directive|endif
else|else
comment|/* target has no alpha; that sucks! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_TARGETNOALPHA
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* full image replace ? */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|iDeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
condition|)
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|iDHDRdeltatype
operator|==
name|MNG_DELTATYPE_REPLACE
condition|)
endif|#
directive|endif
block|{
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|,
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iCompression
argument_list|,
name|pData
operator|->
name|iFilter
argument_list|,
name|pData
operator|->
name|iInterlace
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
name|pData
operator|->
name|pStoreobj
operator|=
name|pImage
expr_stmt|;
comment|/* and store straight into this object */
block|}
else|else
block|{
name|mng_imagedatap
name|pBufzero
decl_stmt|,
name|pBuf
decl_stmt|;
comment|/* we store in object 0 and process it later */
name|pData
operator|->
name|pStoreobj
operator|=
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* make sure to initialize object 0 then */
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
argument_list|,
name|pData
operator|->
name|iDatawidth
argument_list|,
name|pData
operator|->
name|iDataheight
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|,
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iCompression
argument_list|,
name|pData
operator|->
name|iFilter
argument_list|,
name|pData
operator|->
name|iInterlace
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* copy possible palette& cheap transparency */
name|pBufzero
operator|=
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
operator|)
operator|->
name|pImgbuf
expr_stmt|;
name|pBufzero
operator|->
name|bHasPLTE
operator|=
name|pBuf
operator|->
name|bHasPLTE
expr_stmt|;
name|pBufzero
operator|->
name|bHasTRNS
operator|=
name|pBuf
operator|->
name|bHasTRNS
expr_stmt|;
if|if
condition|(
name|pBufzero
operator|->
name|bHasPLTE
condition|)
comment|/* copy palette ? */
block|{
name|mng_uint32
name|iX
decl_stmt|;
name|pBufzero
operator|->
name|iPLTEcount
operator|=
name|pBuf
operator|->
name|iPLTEcount
expr_stmt|;
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pBuf
operator|->
name|iPLTEcount
condition|;
name|iX
operator|++
control|)
block|{
name|pBufzero
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
expr_stmt|;
name|pBufzero
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
expr_stmt|;
name|pBufzero
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pBufzero
operator|->
name|bHasTRNS
condition|)
comment|/* copy cheap transparency ? */
block|{
name|pBufzero
operator|->
name|iTRNSgray
operator|=
name|pBuf
operator|->
name|iTRNSgray
expr_stmt|;
name|pBufzero
operator|->
name|iTRNSred
operator|=
name|pBuf
operator|->
name|iTRNSred
expr_stmt|;
name|pBufzero
operator|->
name|iTRNSgreen
operator|=
name|pBuf
operator|->
name|iTRNSgreen
expr_stmt|;
name|pBufzero
operator|->
name|iTRNSblue
operator|=
name|pBuf
operator|->
name|iTRNSblue
expr_stmt|;
name|pBufzero
operator|->
name|iTRNScount
operator|=
name|pBuf
operator|->
name|iTRNScount
expr_stmt|;
name|MNG_COPY
argument_list|(
name|pBufzero
operator|->
name|aTRNSentries
argument_list|,
name|pBuf
operator|->
name|aTRNSentries
argument_list|,
sizeof|sizeof
argument_list|(
name|pBufzero
operator|->
name|aTRNSentries
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* process immediately if bitdepth& colortype are equal */
name|pData
operator|->
name|bDeltaimmediate
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|(
name|pData
operator|->
name|bDisplaying
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bSkipping
operator|)
operator|&&
operator|(
operator|(
name|pData
operator|->
name|bRunning
operator|)
operator|||
operator|(
name|pData
operator|->
name|bSearching
operator|)
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iBitdepth
operator|==
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iColortype
operator|==
operator|(
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
operator|)
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_OPTIMIZE_FOOTPRINT_INIT
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rowproc
expr_stmt|;
name|pData
operator|->
name|ePng_imgtype
operator|=
name|mng_png_imgtype
argument_list|(
name|pData
operator|->
name|iColortype
argument_list|,
name|pData
operator|->
name|iBitdepth
argument_list|)
expr_stmt|;
else|#
directive|else
switch|switch
condition|(
name|pData
operator|->
name|iColortype
condition|)
comment|/* determine row initialization routine */
block|{
case|case
literal|0
case|:
block|{
comment|/* gray */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g1_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g1_i
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g2_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g2_i
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g4_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g4_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_g16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* rgb */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgb16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|3
case|:
block|{
comment|/* indexed */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_NO_1_2_4BIT_SUPPORT
case|case
literal|1
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx1_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx1_i
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx2_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx2_i
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx4_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx4_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* MNG_NO_1_2_4BIT_SUPPORT */
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_idx8_i
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
case|case
literal|4
case|:
block|{
comment|/* gray+alpha */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_ga16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
literal|6
case|:
block|{
comment|/* rgb+alpha */
switch|switch
condition|(
name|pData
operator|->
name|iBitdepth
condition|)
block|{
case|case
literal|8
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba8_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba8_i
expr_stmt|;
break|break;
block|}
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
case|case
literal|16
case|:
block|{
if|if
condition|(
operator|!
name|pData
operator|->
name|iInterlace
condition|)
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba16_ni
expr_stmt|;
else|else
name|pData
operator|->
name|fInitrowproc
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_init_rgba16_i
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
block|}
endif|#
directive|endif
comment|/* MNG_OPTIMIZE_FOOTPRINT_INIT */
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OBJNOTCONCRETE
argument_list|)
expr_stmt|;
block|}
else|else
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OBJECTUNKNOWN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_DHDR
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_prom
name|mng_retcode
name|mng_process_display_prom
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint8
name|iBitdepth
argument_list|,
name|mng_uint8
name|iColortype
argument_list|,
name|mng_uint8
name|iFilltype
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_prom
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_imagep
name|pImage
decl_stmt|;
name|mng_imagedatap
name|pBuf
decl_stmt|;
name|mng_retcode
name|iRetcode
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_PROM
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pData
operator|->
name|pDeltaImage
condition|)
comment|/* gotta have this now! */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDDELTA
argument_list|)
expr_stmt|;
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pDeltaImage
expr_stmt|;
name|pBuf
operator|=
name|pImage
operator|->
name|pImgbuf
expr_stmt|;
comment|/* can't demote bitdepth! */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|iBitdepth
operator|<
name|pBuf
operator|->
name|iBitdepth
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAY
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAY
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAYA
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_GRAYA
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGBA
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|||
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGGRAY
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_JPEGGRAY
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLOR
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGCOLOR
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLOR
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
operator|||
endif|#
directive|endif
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_INDEXED
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_INDEXED
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|iColortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOLORTYPE
argument_list|)
expr_stmt|;
name|iRetcode
operator|=
name|mng_promote_imageobject
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|iBitdepth
argument_list|,
name|iColortype
argument_list|,
name|iFilltype
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|iPROMbitdepth
operator|<
name|pBuf
operator|->
name|iBitdepth
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDBITDEPTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAY
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_GRAY
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_GRAYA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_GRAYA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGBA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
operator|||
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGGRAY
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_JPEGGRAY
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLOR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGCOLOR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLOR
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
operator|||
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_JPEGCOLORA
operator|)
operator|)
operator|||
endif|#
directive|endif
operator|(
operator|(
name|pBuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_INDEXED
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_INDEXED
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_RGB
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPROMcolortype
operator|!=
name|MNG_COLORTYPE_RGBA
operator|)
operator|)
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_INVALIDCOLORTYPE
argument_list|)
expr_stmt|;
name|iRetcode
operator|=
name|mng_promote_imageobject
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|pData
operator|->
name|iPROMbitdepth
argument_list|,
name|pData
operator|->
name|iPROMcolortype
argument_list|,
name|pData
operator|->
name|iPROMfilltype
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_PROM
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_function
DECL|function|mng_process_display_ipng
name|mng_retcode
name|mng_process_display_ipng
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IPNG
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* indicate it for what it is now */
name|pData
operator|->
name|iDeltaImagetype
operator|=
name|MNG_IMAGETYPE_PNG
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IPNG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
end_ifdef
begin_function
DECL|function|mng_process_display_ijng
name|mng_retcode
name|mng_process_display_ijng
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IJNG
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* indicate it for what it is now */
name|pData
operator|->
name|iDeltaImagetype
operator|=
name|MNG_IMAGETYPE_JNG
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_IJNG
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_pplt
name|mng_retcode
name|mng_process_display_pplt
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint8
name|iType
argument_list|,
name|mng_uint32
name|iCount
argument_list|,
name|mng_palette8ep
name|paIndexentries
argument_list|,
name|mng_uint8p
name|paAlphaentries
argument_list|,
name|mng_uint8p
name|paUsedentries
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_pplt
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_uint32
name|iX
decl_stmt|;
name|mng_imagep
name|pImage
init|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
decl_stmt|;
name|mng_imagedatap
name|pBuf
init|=
name|pImage
operator|->
name|pImgbuf
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_PPLT
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|iX
operator|=
name|iCount
expr_stmt|;
else|#
directive|else
name|iX
operator|=
name|pData
operator|->
name|iPPLTcount
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
switch|switch
condition|(
name|iType
condition|)
else|#
directive|else
switch|switch
condition|(
name|pData
operator|->
name|iPPLTtype
condition|)
endif|#
directive|endif
block|{
case|case
name|MNG_DELTATYPE_REPLACERGB
case|:
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iCount
condition|;
name|iX
operator|++
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iPPLTcount
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|paUsedentries
index|[
name|iX
index|]
condition|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iRed
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iGreen
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iBlue
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|paPPLTusedentries
index|[
name|iX
index|]
condition|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iRed
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iGreen
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iBlue
expr_stmt|;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
name|MNG_DELTATYPE_DELTARGB
case|:
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iCount
condition|;
name|iX
operator|++
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iPPLTcount
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|paUsedentries
index|[
name|iX
index|]
condition|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|+
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iRed
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|+
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iGreen
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|+
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iBlue
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|paPPLTusedentries
index|[
name|iX
index|]
condition|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|+
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iRed
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|+
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iGreen
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|+
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iBlue
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
name|MNG_DELTATYPE_REPLACEALPHA
case|:
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iCount
condition|;
name|iX
operator|++
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iPPLTcount
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|paUsedentries
index|[
name|iX
index|]
condition|)
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|=
name|paAlphaentries
index|[
name|iX
index|]
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|paPPLTusedentries
index|[
name|iX
index|]
condition|)
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|=
name|pData
operator|->
name|paPPLTalphaentries
index|[
name|iX
index|]
expr_stmt|;
block|}
endif|#
directive|endif
break|break;
block|}
case|case
name|MNG_DELTATYPE_DELTAALPHA
case|:
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iCount
condition|;
name|iX
operator|++
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iPPLTcount
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|paUsedentries
index|[
name|iX
index|]
condition|)
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|+
name|paAlphaentries
index|[
name|iX
index|]
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|paPPLTusedentries
index|[
name|iX
index|]
condition|)
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|+
name|pData
operator|->
name|paPPLTalphaentries
index|[
name|iX
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
break|break;
block|}
case|case
name|MNG_DELTATYPE_REPLACERGBA
case|:
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iCount
condition|;
name|iX
operator|++
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iPPLTcount
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|paUsedentries
index|[
name|iX
index|]
condition|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iRed
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iGreen
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iBlue
expr_stmt|;
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|=
name|paAlphaentries
index|[
name|iX
index|]
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|paPPLTusedentries
index|[
name|iX
index|]
condition|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iRed
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iGreen
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iBlue
expr_stmt|;
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|=
name|pData
operator|->
name|paPPLTalphaentries
index|[
name|iX
index|]
expr_stmt|;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
name|MNG_DELTATYPE_DELTARGBA
case|:
block|{
ifdef|#
directive|ifdef
name|MNG_DECREMENT_LOOPS
for|for
control|(
init|;
name|iX
operator|>
literal|0
condition|;
name|iX
operator|--
control|)
else|#
directive|else
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|iCount
condition|;
name|iX
operator|++
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
literal|0
init|;
name|iX
operator|<
name|pData
operator|->
name|iPPLTcount
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|paUsedentries
index|[
name|iX
index|]
condition|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|+
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iRed
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|+
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iGreen
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|+
name|paIndexentries
index|[
name|iX
index|]
operator|.
name|iBlue
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|+
name|paAlphaentries
index|[
name|iX
index|]
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|paPPLTusedentries
index|[
name|iX
index|]
condition|)
block|{
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iRed
operator|+
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iRed
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iGreen
operator|+
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iGreen
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aPLTEentries
index|[
name|iX
index|]
operator|.
name|iBlue
operator|+
name|pData
operator|->
name|paPPLTindexentries
index|[
name|iX
index|]
operator|.
name|iBlue
argument_list|)
expr_stmt|;
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|=
call|(
name|mng_uint8
call|)
argument_list|(
name|pBuf
operator|->
name|aTRNSentries
index|[
name|iX
index|]
operator|+
name|pData
operator|->
name|paPPLTalphaentries
index|[
name|iX
index|]
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
break|break;
block|}
block|}
end_decl_stmt
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_if
if|if
condition|(
operator|(
name|iType
operator|!=
name|MNG_DELTATYPE_REPLACERGB
operator|)
operator|&&
operator|(
name|iType
operator|!=
name|MNG_DELTATYPE_DELTARGB
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iPPLTtype
operator|!=
name|MNG_DELTATYPE_REPLACERGB
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPPLTtype
operator|!=
name|MNG_DELTATYPE_DELTARGB
operator|)
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|pBuf
operator|->
name|bHasTRNS
condition|)
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|iCount
operator|>
name|pBuf
operator|->
name|iTRNScount
condition|)
name|pBuf
operator|->
name|iTRNScount
operator|=
name|iCount
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|iPPLTcount
operator|>
name|pBuf
operator|->
name|iTRNScount
condition|)
name|pBuf
operator|->
name|iTRNScount
operator|=
name|pData
operator|->
name|iPPLTcount
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pBuf
operator|->
name|iTRNScount
operator|=
name|iCount
expr_stmt|;
name|pBuf
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
else|#
directive|else
name|pBuf
operator|->
name|iTRNScount
operator|=
name|pData
operator|->
name|iPPLTcount
expr_stmt|;
name|pBuf
operator|->
name|bHasTRNS
operator|=
name|MNG_TRUE
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_if
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_if
if|if
condition|(
operator|(
name|iType
operator|!=
name|MNG_DELTATYPE_REPLACEALPHA
operator|)
operator|&&
operator|(
name|iType
operator|!=
name|MNG_DELTATYPE_DELTAALPHA
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|pData
operator|->
name|iPPLTtype
operator|!=
name|MNG_DELTATYPE_REPLACEALPHA
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iPPLTtype
operator|!=
name|MNG_DELTATYPE_DELTAALPHA
operator|)
condition|)
endif|#
directive|endif
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|iCount
operator|>
name|pBuf
operator|->
name|iPLTEcount
condition|)
name|pBuf
operator|->
name|iPLTEcount
operator|=
name|iCount
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|iPPLTcount
operator|>
name|pBuf
operator|->
name|iPLTEcount
condition|)
name|pBuf
operator|->
name|iPLTEcount
operator|=
name|pData
operator|->
name|iPPLTcount
expr_stmt|;
endif|#
directive|endif
block|}
end_if
begin_ifdef
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
end_ifdef
begin_expr_stmt
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_PPLT
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
end_expr_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_return
return|return
name|MNG_NOERROR
return|;
end_return
begin_endif
unit|}
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_macro
unit|mng_retcode
DECL|function|mng_process_display_magn
name|mng_process_display_magn
argument_list|(
argument|mng_datap  pData
argument_list|,
argument|mng_uint16 iFirstid
argument_list|,
argument|mng_uint16 iLastid
argument_list|,
argument|mng_uint8  iMethodX
argument_list|,
argument|mng_uint16 iMX
argument_list|,
argument|mng_uint16 iMY
argument_list|,
argument|mng_uint16 iML
argument_list|,
argument|mng_uint16 iMR
argument_list|,
argument|mng_uint16 iMT
argument_list|,
argument|mng_uint16 iMB
argument_list|,
argument|mng_uint8  iMethodY
argument_list|)
end_macro
begin_else
else|#
directive|else
end_else
begin_function
name|mng_retcode
name|mng_process_display_magn
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
endif|#
directive|endif
block|{
name|mng_uint16
name|iX
decl_stmt|;
name|mng_imagep
name|pImage
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MAGN
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* iterate the object-ids */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
for|for
control|(
name|iX
operator|=
name|iFirstid
init|;
name|iX
operator|<=
name|iLastid
condition|;
name|iX
operator|++
control|)
else|#
directive|else
for|for
control|(
name|iX
operator|=
name|pData
operator|->
name|iMAGNfirstid
init|;
name|iX
operator|<=
name|pData
operator|->
name|iMAGNlastid
condition|;
name|iX
operator|++
control|)
endif|#
directive|endif
block|{
if|if
condition|(
name|iX
operator|==
literal|0
condition|)
comment|/* process object 0 ? */
block|{
name|pImage
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pImage
operator|->
name|iMAGN_MethodX
operator|=
name|iMethodX
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MethodY
operator|=
name|iMethodY
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MX
operator|=
name|iMX
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MY
operator|=
name|iMY
expr_stmt|;
name|pImage
operator|->
name|iMAGN_ML
operator|=
name|iML
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MR
operator|=
name|iMR
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MT
operator|=
name|iMT
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MB
operator|=
name|iMB
expr_stmt|;
else|#
directive|else
name|pImage
operator|->
name|iMAGN_MethodX
operator|=
name|pData
operator|->
name|iMAGNmethodX
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MethodY
operator|=
name|pData
operator|->
name|iMAGNmethodY
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MX
operator|=
name|pData
operator|->
name|iMAGNmX
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MY
operator|=
name|pData
operator|->
name|iMAGNmY
expr_stmt|;
name|pImage
operator|->
name|iMAGN_ML
operator|=
name|pData
operator|->
name|iMAGNmL
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MR
operator|=
name|pData
operator|->
name|iMAGNmR
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MT
operator|=
name|pData
operator|->
name|iMAGNmT
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MB
operator|=
name|pData
operator|->
name|iMAGNmB
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iX
argument_list|)
expr_stmt|;
comment|/* object exists& is not frozen ? */
if|if
condition|(
operator|(
name|pImage
operator|)
operator|&&
operator|(
operator|!
name|pImage
operator|->
name|bFrozen
operator|)
condition|)
block|{
comment|/* previous magnification to be done ? */
if|if
condition|(
operator|(
name|pImage
operator|->
name|iMAGN_MethodX
operator|)
operator|||
operator|(
name|pImage
operator|->
name|iMAGN_MethodY
operator|)
condition|)
block|{
name|mng_retcode
name|iRetcode
init|=
name|mng_magnify_imageobject
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pImage
operator|->
name|iMAGN_MethodX
operator|=
name|iMethodX
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MethodY
operator|=
name|iMethodY
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MX
operator|=
name|iMX
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MY
operator|=
name|iMY
expr_stmt|;
name|pImage
operator|->
name|iMAGN_ML
operator|=
name|iML
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MR
operator|=
name|iMR
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MT
operator|=
name|iMT
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MB
operator|=
name|iMB
expr_stmt|;
else|#
directive|else
name|pImage
operator|->
name|iMAGN_MethodX
operator|=
name|pData
operator|->
name|iMAGNmethodX
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MethodY
operator|=
name|pData
operator|->
name|iMAGNmethodY
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MX
operator|=
name|pData
operator|->
name|iMAGNmX
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MY
operator|=
name|pData
operator|->
name|iMAGNmY
expr_stmt|;
name|pImage
operator|->
name|iMAGN_ML
operator|=
name|pData
operator|->
name|iMAGNmL
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MR
operator|=
name|pData
operator|->
name|iMAGNmR
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MT
operator|=
name|pData
operator|->
name|iMAGNmT
expr_stmt|;
name|pImage
operator|->
name|iMAGN_MB
operator|=
name|pData
operator|->
name|iMAGNmB
expr_stmt|;
endif|#
directive|endif
block|}
block|}
block|}
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pData
operator|->
name|iMAGNfromid
operator|=
name|iFirstid
expr_stmt|;
name|pData
operator|->
name|iMAGNtoid
operator|=
name|iLastid
expr_stmt|;
name|iX
operator|=
name|iFirstid
expr_stmt|;
else|#
directive|else
name|pData
operator|->
name|iMAGNfromid
operator|=
name|pData
operator|->
name|iMAGNfirstid
expr_stmt|;
name|pData
operator|->
name|iMAGNtoid
operator|=
name|pData
operator|->
name|iMAGNlastid
expr_stmt|;
name|iX
operator|=
name|pData
operator|->
name|iMAGNfirstid
expr_stmt|;
endif|#
directive|endif
comment|/* iterate again for showing */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
while|while
condition|(
operator|(
name|iX
operator|<=
name|iLastid
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
condition|)
else|#
directive|else
while|while
condition|(
operator|(
name|iX
operator|<=
name|pData
operator|->
name|iMAGNlastid
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
condition|)
endif|#
directive|endif
block|{
name|pData
operator|->
name|iMAGNcurrentid
operator|=
name|iX
expr_stmt|;
if|if
condition|(
name|iX
condition|)
comment|/* only real objects ! */
block|{
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iX
argument_list|)
expr_stmt|;
comment|/* object exists& is not frozen&                                           is visible& is viewable ? */
if|if
condition|(
operator|(
name|pImage
operator|)
operator|&&
operator|(
operator|!
name|pImage
operator|->
name|bFrozen
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|bVisible
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|bViewable
operator|)
condition|)
block|{
name|mng_retcode
name|iRetcode
init|=
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|MNG_FALSE
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
block|}
block|}
name|iX
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* broken ? */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|9
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MAGN
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_function
DECL|function|mng_process_display_magn2
name|mng_retcode
name|mng_process_display_magn2
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_uint16
name|iX
decl_stmt|;
name|mng_imagep
name|pImage
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MAGN
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|iX
operator|=
name|pData
operator|->
name|iMAGNcurrentid
expr_stmt|;
comment|/* iterate again for showing */
while|while
condition|(
operator|(
name|iX
operator|<=
name|pData
operator|->
name|iMAGNtoid
operator|)
operator|&&
operator|(
operator|!
name|pData
operator|->
name|bTimerset
operator|)
condition|)
block|{
name|pData
operator|->
name|iMAGNcurrentid
operator|=
name|iX
expr_stmt|;
if|if
condition|(
name|iX
condition|)
comment|/* only real objects ! */
block|{
name|pImage
operator|=
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iX
argument_list|)
expr_stmt|;
comment|/* object exists& is not frozen&                                           is visible& is viewable ? */
if|if
condition|(
operator|(
name|pImage
operator|)
operator|&&
operator|(
operator|!
name|pImage
operator|->
name|bFrozen
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|bVisible
operator|)
operator|&&
operator|(
name|pImage
operator|->
name|bViewable
operator|)
condition|)
block|{
name|mng_retcode
name|iRetcode
init|=
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pImage
argument_list|,
name|MNG_FALSE
argument_list|)
decl_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
block|}
block|}
name|iX
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* broken ? */
name|pData
operator|->
name|iBreakpoint
operator|=
literal|9
expr_stmt|;
else|else
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* not again ! */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_MAGN
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_PAST
end_ifndef
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
end_ifndef
begin_decl_stmt
DECL|function|mng_process_display_past
name|mng_retcode
name|mng_process_display_past
argument_list|(
name|mng_datap
name|pData
argument_list|,
name|mng_uint16
name|iTargetid
argument_list|,
name|mng_uint8
name|iTargettype
argument_list|,
name|mng_int32
name|iTargetx
argument_list|,
name|mng_int32
name|iTargety
argument_list|,
name|mng_uint32
name|iCount
argument_list|,
name|mng_ptr
name|pSources
argument_list|)
else|#
directive|else
name|mng_retcode
name|mng_process_display_past
argument_list|(
name|mng_datap
name|pData
argument_list|)
endif|#
directive|endif
block|{
name|mng_retcode
name|iRetcode
init|=
name|MNG_NOERROR
decl_stmt|;
name|mng_imagep
name|pTargetimg
decl_stmt|;
name|mng_imagep
name|pSourceimg
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|mng_past_sourcep
name|pSource
init|=
operator|(
name|mng_past_sourcep
operator|)
name|pSources
decl_stmt|;
else|#
directive|else
name|mng_past_sourcep
name|pSource
init|=
operator|(
name|mng_past_sourcep
operator|)
name|pData
operator|->
name|pPASTsources
decl_stmt|;
endif|#
directive|endif
name|mng_uint32
name|iX
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_PAST
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
name|iTargetid
condition|)
comment|/* a real destination object ? */
else|#
directive|else
if|if
condition|(
name|pData
operator|->
name|iPASTtargetid
condition|)
comment|/* a real destination object ? */
endif|#
directive|endif
block|{
comment|/* let's find it then */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pTargetimg
operator|=
operator|(
name|mng_imagep
operator|)
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|iTargetid
argument_list|)
expr_stmt|;
else|#
directive|else
name|pTargetimg
operator|=
operator|(
name|mng_imagep
operator|)
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iPASTtargetid
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pTargetimg
condition|)
comment|/* if it doesn't exists; do a barf */
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OBJECTUNKNOWN
argument_list|)
expr_stmt|;
comment|/* it's gotta be abstract !!! */
if|if
condition|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|bConcrete
condition|)
name|MNG_ERROR
argument_list|(
name|pData
argument_list|,
name|MNG_OBJNOTABSTRACT
argument_list|)
expr_stmt|;
comment|/* we want 32-/64-bit RGBA to play with ! */
if|if
condition|(
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|<=
name|MNG_BITDEPTH_8
operator|)
operator|||
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAY
operator|)
operator|||
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGB
operator|)
operator|||
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_INDEXED
operator|)
operator|||
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
operator|)
condition|)
name|iRetcode
operator|=
name|mng_promote_imageobject
argument_list|(
name|pData
argument_list|,
name|pTargetimg
argument_list|,
name|MNG_BITDEPTH_8
argument_list|,
name|MNG_COLORTYPE_RGBA
argument_list|,
name|MNG_FILLMETHOD_LEFTBITREPLICATE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
name|MNG_BITDEPTH_8
operator|)
operator|&&
operator|(
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAY
operator|)
operator|||
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_RGB
operator|)
operator|||
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_GRAYA
operator|)
operator|)
condition|)
name|iRetcode
operator|=
name|mng_promote_imageobject
argument_list|(
name|pData
argument_list|,
name|pTargetimg
argument_list|,
name|MNG_BITDEPTH_16
argument_list|,
name|MNG_COLORTYPE_RGBA
argument_list|,
name|MNG_FILLMETHOD_LEFTBITREPLICATE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MNG_INCLUDE_JNG
elseif|else
if|if
condition|(
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGGRAY
operator|)
operator|||
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGCOLOR
operator|)
operator|||
operator|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iColortype
operator|==
name|MNG_COLORTYPE_JPEGGRAYA
operator|)
condition|)
name|iRetcode
operator|=
name|mng_promote_imageobject
argument_list|(
name|pData
argument_list|,
name|pTargetimg
argument_list|,
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iBitdepth
argument_list|,
name|MNG_COLORTYPE_JPEGCOLORA
argument_list|,
name|MNG_FILLMETHOD_LEFTBITREPLICATE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
comment|/* make it really abstract ? */
if|if
condition|(
operator|!
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|bCorrected
condition|)
block|{
name|iRetcode
operator|=
name|mng_colorcorrect_object
argument_list|(
name|pData
argument_list|,
name|pTargetimg
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
block|}
else|else
block|{
comment|/* pasting into object 0 !!! */
name|pTargetimg
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
comment|/* is it usable ??? */
if|if
condition|(
operator|(
name|pTargetimg
operator|->
name|bClipped
operator|)
operator|&&
operator|(
name|pTargetimg
operator|->
name|iClipr
operator|>
name|pTargetimg
operator|->
name|iPosx
operator|)
operator|&&
operator|(
name|pTargetimg
operator|->
name|iClipb
operator|>
name|pTargetimg
operator|->
name|iPosy
operator|)
condition|)
block|{
comment|/* make it 32-bit RGBA please !!! */
name|iRetcode
operator|=
name|mng_reset_object_details
argument_list|(
name|pData
argument_list|,
name|pTargetimg
argument_list|,
name|pTargetimg
operator|->
name|iClipr
operator|-
name|pTargetimg
operator|->
name|iPosx
argument_list|,
name|pTargetimg
operator|->
name|iClipb
operator|-
name|pTargetimg
operator|->
name|iPosy
argument_list|,
name|MNG_BITDEPTH_8
argument_list|,
name|MNG_COLORTYPE_RGBA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
else|else
name|pTargetimg
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* clipped beyond visibility ! */
block|}
if|if
condition|(
name|pTargetimg
condition|)
comment|/* usable destination ? */
block|{
name|mng_int32
name|iSourceY
decl_stmt|;
name|mng_int32
name|iSourceYinc
decl_stmt|;
name|mng_int32
name|iSourcerowsize
decl_stmt|;
name|mng_int32
name|iSourcesamples
decl_stmt|;
name|mng_bool
name|bSourceRGBA16
decl_stmt|;
name|mng_int32
name|iTargetY
decl_stmt|;
name|mng_int32
name|iTargetrowsize
decl_stmt|;
name|mng_int32
name|iTargetsamples
decl_stmt|;
name|mng_bool
name|bTargetRGBA16
init|=
name|MNG_FALSE
decl_stmt|;
name|mng_int32
name|iTemprowsize
decl_stmt|;
name|mng_imagedatap
name|pBuf
decl_stmt|;
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
comment|/* needs magnification ? */
if|if
condition|(
operator|(
name|pTargetimg
operator|->
name|iMAGN_MethodX
operator|)
operator|||
operator|(
name|pTargetimg
operator|->
name|iMAGN_MethodY
operator|)
condition|)
name|iRetcode
operator|=
name|mng_magnify_imageobject
argument_list|(
name|pData
argument_list|,
name|pTargetimg
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* still ok ? */
block|{
name|bTargetRGBA16
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iBitdepth
operator|>
literal|8
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
switch|switch
condition|(
name|iTargettype
condition|)
comment|/* determine target x/y */
else|#
directive|else
switch|switch
condition|(
name|pData
operator|->
name|iPASTtargettype
condition|)
comment|/* determine target x/y */
endif|#
directive|endif
block|{
case|case
literal|0
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pData
operator|->
name|iPastx
operator|=
name|iTargetx
expr_stmt|;
name|pData
operator|->
name|iPasty
operator|=
name|iTargety
expr_stmt|;
else|#
directive|else
name|pData
operator|->
name|iPastx
operator|=
name|pData
operator|->
name|iPASTtargetx
expr_stmt|;
name|pData
operator|->
name|iPasty
operator|=
name|pData
operator|->
name|iPASTtargety
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|1
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pData
operator|->
name|iPastx
operator|=
name|pTargetimg
operator|->
name|iPastx
operator|+
name|iTargetx
expr_stmt|;
name|pData
operator|->
name|iPasty
operator|=
name|pTargetimg
operator|->
name|iPasty
operator|+
name|iTargety
expr_stmt|;
else|#
directive|else
name|pData
operator|->
name|iPastx
operator|=
name|pTargetimg
operator|->
name|iPastx
operator|+
name|pData
operator|->
name|iPASTtargetx
expr_stmt|;
name|pData
operator|->
name|iPasty
operator|=
name|pTargetimg
operator|->
name|iPasty
operator|+
name|pData
operator|->
name|iPASTtargety
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
literal|2
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pData
operator|->
name|iPastx
operator|+=
name|iTargetx
expr_stmt|;
name|pData
operator|->
name|iPasty
operator|+=
name|iTargety
expr_stmt|;
else|#
directive|else
name|pData
operator|->
name|iPastx
operator|+=
name|pData
operator|->
name|iPASTtargetx
expr_stmt|;
name|pData
operator|->
name|iPasty
operator|+=
name|pData
operator|->
name|iPASTtargety
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
block|}
comment|/* save for next time ... */
name|pTargetimg
operator|->
name|iPastx
operator|=
name|pData
operator|->
name|iPastx
expr_stmt|;
name|pTargetimg
operator|->
name|iPasty
operator|=
name|pData
operator|->
name|iPasty
expr_stmt|;
comment|/* address destination for row-routines */
name|pData
operator|->
name|pStoreobj
operator|=
operator|(
name|mng_objectp
operator|)
name|pTargetimg
expr_stmt|;
name|pData
operator|->
name|pStorebuf
operator|=
operator|(
name|mng_objectp
operator|)
name|pTargetimg
operator|->
name|pImgbuf
expr_stmt|;
block|}
comment|/* process the sources one by one */
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
while|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|iX
operator|<
name|iCount
operator|)
condition|)
else|#
directive|else
while|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|iX
operator|<
name|pData
operator|->
name|iPASTcount
operator|)
condition|)
endif|#
directive|endif
block|{
comment|/* find the little bastards first */
name|pSourceimg
operator|=
operator|(
name|mng_imagep
operator|)
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|pSource
operator|->
name|iSourceid
argument_list|)
expr_stmt|;
comment|/* exists and viewable? */
if|if
condition|(
operator|(
name|pSourceimg
operator|)
operator|&&
operator|(
name|pSourceimg
operator|->
name|bViewable
operator|)
condition|)
block|{
comment|/* needs magnification ? */
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_MAGN
if|if
condition|(
operator|(
name|pSourceimg
operator|->
name|iMAGN_MethodX
operator|)
operator|||
operator|(
name|pSourceimg
operator|->
name|iMAGN_MethodY
operator|)
condition|)
name|iRetcode
operator|=
name|mng_magnify_imageobject
argument_list|(
name|pData
argument_list|,
name|pSourceimg
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* still ok ? */
block|{
name|pBuf
operator|=
operator|(
name|mng_imagedatap
operator|)
name|pSourceimg
operator|->
name|pImgbuf
expr_stmt|;
comment|/* address source for row-routines */
name|pData
operator|->
name|pRetrieveobj
operator|=
operator|(
name|mng_objectp
operator|)
name|pSourceimg
expr_stmt|;
name|pData
operator|->
name|iPass
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* init row-processing variables */
name|pData
operator|->
name|iRowinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iColinc
operator|=
literal|1
expr_stmt|;
name|pData
operator|->
name|iPixelofs
operator|=
literal|0
expr_stmt|;
name|iSourcesamples
operator|=
operator|(
name|mng_int32
operator|)
name|pBuf
operator|->
name|iWidth
expr_stmt|;
name|iSourcerowsize
operator|=
name|pBuf
operator|->
name|iRowsize
expr_stmt|;
name|bSourceRGBA16
operator|=
call|(
name|mng_bool
call|)
argument_list|(
name|pBuf
operator|->
name|iBitdepth
operator|>
literal|8
argument_list|)
expr_stmt|;
comment|/* make sure the delta-routines do the right thing */
name|pData
operator|->
name|iDeltatype
operator|=
name|MNG_DELTATYPE_BLOCKPIXELREPLACE
expr_stmt|;
switch|switch
condition|(
name|pBuf
operator|->
name|iColortype
condition|)
block|{
case|case
literal|0
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bSourceRGBA16
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pBuf
operator|->
name|bHasTRNS
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bSourceRGBA16
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pBuf
operator|->
name|bHasTRNS
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
block|{
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_idx8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
call|(
name|mng_bool
call|)
argument_list|(
operator|!
name|pBuf
operator|->
name|bHasTRNS
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bSourceRGBA16
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|6
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bSourceRGBA16
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|8
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bSourceRGBA16
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_g8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
literal|10
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bSourceRGBA16
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgb8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_TRUE
expr_stmt|;
break|break;
block|}
case|case
literal|12
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bSourceRGBA16
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_ga8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
case|case
literal|14
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bSourceRGBA16
condition|)
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fRetrieverow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_retrieve_rgba8
expr_stmt|;
name|pData
operator|->
name|bIsOpaque
operator|=
name|MNG_FALSE
expr_stmt|;
break|break;
block|}
block|}
comment|/* determine scaling */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
ifndef|#
directive|ifndef
name|MNG_NO_DELTA_PNG
if|if
condition|(
operator|(
operator|!
name|bSourceRGBA16
operator|)
operator|&&
operator|(
name|bTargetRGBA16
operator|)
condition|)
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_rgba8_rgba16
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|bSourceRGBA16
operator|)
operator|&&
operator|(
operator|!
name|bTargetRGBA16
operator|)
condition|)
name|pData
operator|->
name|fScalerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_scale_rgba16_rgba8
expr_stmt|;
else|else
endif|#
directive|endif
endif|#
directive|endif
name|pData
operator|->
name|fScalerow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* default no color-correction */
name|pData
operator|->
name|fCorrectrow
operator|=
name|MNG_NULL
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
comment|/* determine color-management routine */
name|iRetcode
operator|=
name|mng_init_full_cms
argument_list|(
name|pData
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|MNG_GAMMA_ONLY
argument_list|)
name|iRetcode
operator|=
name|mng_init_gamma_only
argument_list|(
name|pData
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|MNG_APP_CMS
argument_list|)
name|iRetcode
operator|=
name|mng_init_app_cms
argument_list|(
name|pData
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_FALSE
argument_list|,
name|MNG_TRUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* still ok ? */
block|{
name|pData
operator|->
name|fFliprow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* no flipping or tiling by default */
name|pData
operator|->
name|fTilerow
operator|=
name|MNG_NULL
expr_stmt|;
comment|/* but perhaps we do have to ... */
switch|switch
condition|(
name|pSource
operator|->
name|iOrientation
condition|)
block|{
case|case
literal|2
case|:
empty_stmt|;
case|case
literal|4
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bTargetRGBA16
condition|)
name|pData
operator|->
name|fFliprow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_flip_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fFliprow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_flip_rgba8
expr_stmt|;
break|break;
block|}
case|case
literal|8
case|:
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bTargetRGBA16
condition|)
name|pData
operator|->
name|fTilerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_tile_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fTilerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_tile_rgba8
expr_stmt|;
break|break;
block|}
block|}
comment|/* determine composition routine */
comment|/* note that we're abusing the delta-routine setup !!! */
switch|switch
condition|(
name|pSource
operator|->
name|iComposition
condition|)
block|{
case|case
literal|0
case|:
block|{
comment|/* composite over */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bTargetRGBA16
condition|)
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_composeover_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_composeover_rgba8
expr_stmt|;
break|break;
block|}
case|case
literal|1
case|:
block|{
comment|/* replace */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bTargetRGBA16
condition|)
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgba16_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_delta_rgba8_rgba8
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
comment|/* composite under */
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bTargetRGBA16
condition|)
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_composeunder_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fDeltarow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_composeunder_rgba8
expr_stmt|;
break|break;
block|}
block|}
comment|/* determine offsets& clipping */
if|if
condition|(
name|pSource
operator|->
name|iOffsettype
operator|==
literal|1
condition|)
block|{
name|pData
operator|->
name|iDestl
operator|=
name|pData
operator|->
name|iPastx
operator|+
name|pSource
operator|->
name|iOffsetx
expr_stmt|;
name|pData
operator|->
name|iDestt
operator|=
name|pData
operator|->
name|iPasty
operator|+
name|pSource
operator|->
name|iOffsety
expr_stmt|;
block|}
else|else
block|{
name|pData
operator|->
name|iDestl
operator|=
name|pSource
operator|->
name|iOffsetx
expr_stmt|;
name|pData
operator|->
name|iDestt
operator|=
name|pSource
operator|->
name|iOffsety
expr_stmt|;
block|}
name|pData
operator|->
name|iDestr
operator|=
operator|(
name|mng_int32
operator|)
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iWidth
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
operator|(
name|mng_int32
operator|)
name|pTargetimg
operator|->
name|pImgbuf
operator|->
name|iHeight
expr_stmt|;
comment|/* take the source dimension into account ? */
if|if
condition|(
name|pSource
operator|->
name|iOrientation
operator|!=
literal|8
condition|)
block|{
name|pData
operator|->
name|iDestr
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestr
argument_list|,
name|pData
operator|->
name|iDestl
operator|+
operator|(
name|mng_int32
operator|)
name|pBuf
operator|->
name|iWidth
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestb
argument_list|,
name|pData
operator|->
name|iDestt
operator|+
operator|(
name|mng_int32
operator|)
name|pBuf
operator|->
name|iHeight
argument_list|)
expr_stmt|;
block|}
comment|/* source clipping */
if|if
condition|(
name|pSource
operator|->
name|iBoundarytype
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|pData
operator|->
name|iDestl
operator|<
name|pData
operator|->
name|iPastx
operator|+
name|pSource
operator|->
name|iBoundaryl
condition|)
name|pData
operator|->
name|iSourcel
operator|=
name|pData
operator|->
name|iPastx
operator|+
name|pSource
operator|->
name|iBoundaryl
operator|-
name|pData
operator|->
name|iDestl
expr_stmt|;
else|else
name|pData
operator|->
name|iSourcel
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iDestt
operator|<
name|pData
operator|->
name|iPasty
operator|+
name|pSource
operator|->
name|iBoundaryt
condition|)
name|pData
operator|->
name|iSourcet
operator|=
name|pData
operator|->
name|iPasty
operator|+
name|pSource
operator|->
name|iBoundaryt
operator|-
name|pData
operator|->
name|iDestt
expr_stmt|;
else|else
name|pData
operator|->
name|iSourcet
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iDestl
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestl
argument_list|,
name|pData
operator|->
name|iPastx
operator|+
name|pSource
operator|->
name|iBoundaryl
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestt
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestt
argument_list|,
name|pData
operator|->
name|iPasty
operator|+
name|pSource
operator|->
name|iBoundaryt
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestr
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestr
argument_list|,
name|pData
operator|->
name|iPastx
operator|+
name|pSource
operator|->
name|iBoundaryr
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestb
argument_list|,
name|pData
operator|->
name|iPasty
operator|+
name|pSource
operator|->
name|iBoundaryb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pData
operator|->
name|iDestl
operator|<
name|pSource
operator|->
name|iBoundaryl
condition|)
name|pData
operator|->
name|iSourcel
operator|=
name|pSource
operator|->
name|iBoundaryl
operator|-
name|pData
operator|->
name|iDestl
expr_stmt|;
else|else
name|pData
operator|->
name|iSourcel
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pData
operator|->
name|iDestt
operator|<
name|pSource
operator|->
name|iBoundaryt
condition|)
name|pData
operator|->
name|iSourcet
operator|=
name|pSource
operator|->
name|iBoundaryt
operator|-
name|pData
operator|->
name|iDestt
expr_stmt|;
else|else
name|pData
operator|->
name|iSourcet
operator|=
literal|0
expr_stmt|;
name|pData
operator|->
name|iDestl
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestl
argument_list|,
name|pSource
operator|->
name|iBoundaryl
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestt
operator|=
name|MAX_COORD
argument_list|(
name|pData
operator|->
name|iDestt
argument_list|,
name|pSource
operator|->
name|iBoundaryt
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestr
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestr
argument_list|,
name|pSource
operator|->
name|iBoundaryr
argument_list|)
expr_stmt|;
name|pData
operator|->
name|iDestb
operator|=
name|MIN_COORD
argument_list|(
name|pData
operator|->
name|iDestb
argument_list|,
name|pSource
operator|->
name|iBoundaryb
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pData
operator|->
name|iSourcel
condition|)
comment|/* indent source ? */
block|{
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bTargetRGBA16
condition|)
comment|/* abuse tiling routine to shift source-pixels */
name|pData
operator|->
name|fTilerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_tile_rgba16
expr_stmt|;
else|else
endif|#
directive|endif
name|pData
operator|->
name|fTilerow
operator|=
operator|(
name|mng_fptr
operator|)
name|mng_tile_rgba8
expr_stmt|;
block|}
comment|/* anything to display ? */
if|if
condition|(
operator|(
name|pData
operator|->
name|iDestl
operator|<=
name|pData
operator|->
name|iDestr
operator|)
operator|&&
operator|(
name|pData
operator|->
name|iDestt
operator|<=
name|pData
operator|->
name|iDestb
operator|)
condition|)
block|{
comment|/* init variables for the loop */
if|if
condition|(
operator|(
name|pSource
operator|->
name|iOrientation
operator|==
literal|2
operator|)
operator|||
operator|(
name|pSource
operator|->
name|iOrientation
operator|==
literal|6
operator|)
condition|)
block|{
name|iSourceY
operator|=
operator|(
name|mng_int32
operator|)
name|pBuf
operator|->
name|iHeight
operator|-
literal|1
operator|-
name|pData
operator|->
name|iSourcet
expr_stmt|;
name|iSourceYinc
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|iSourceY
operator|=
name|pData
operator|->
name|iSourcet
expr_stmt|;
name|iSourceYinc
operator|=
literal|1
expr_stmt|;
block|}
name|iTargetY
operator|=
name|pData
operator|->
name|iDestt
expr_stmt|;
name|pData
operator|->
name|iCol
operator|=
name|pData
operator|->
name|iDestl
expr_stmt|;
name|iTargetsamples
operator|=
name|pData
operator|->
name|iDestr
operator|-
name|pData
operator|->
name|iDestl
expr_stmt|;
ifndef|#
directive|ifndef
name|MNG_NO_16BIT_SUPPORT
if|if
condition|(
name|bTargetRGBA16
condition|)
name|iTargetrowsize
operator|=
operator|(
name|iTargetsamples
operator|<<
literal|3
operator|)
expr_stmt|;
else|else
endif|#
directive|endif
name|iTargetrowsize
operator|=
operator|(
name|iTargetsamples
operator|<<
literal|2
operator|)
expr_stmt|;
comment|/* get temporary work-buffers */
if|if
condition|(
name|iSourcerowsize
operator|>
name|iTargetrowsize
condition|)
name|iTemprowsize
operator|=
name|iSourcerowsize
operator|<<
literal|1
expr_stmt|;
else|else
name|iTemprowsize
operator|=
name|iTargetrowsize
operator|<<
literal|1
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|iTemprowsize
argument_list|)
expr_stmt|;
name|MNG_ALLOC
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pWorkrow
argument_list|,
name|iTemprowsize
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|iTargetY
operator|<
name|pData
operator|->
name|iDestb
operator|)
condition|)
block|{
comment|/* get a row */
name|pData
operator|->
name|iRow
operator|=
name|iSourceY
expr_stmt|;
name|pData
operator|->
name|iRowsamples
operator|=
name|iSourcesamples
expr_stmt|;
name|pData
operator|->
name|iRowsize
operator|=
name|iSourcerowsize
expr_stmt|;
name|pData
operator|->
name|bIsRGBA16
operator|=
name|bSourceRGBA16
expr_stmt|;
name|iRetcode
operator|=
operator|(
operator|(
name|mng_retrieverow
operator|)
name|pData
operator|->
name|fRetrieverow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
comment|/* scale it (if necessary) */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fScalerow
operator|)
condition|)
name|iRetcode
operator|=
operator|(
operator|(
name|mng_scalerow
operator|)
name|pData
operator|->
name|fScalerow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
name|pData
operator|->
name|bIsRGBA16
operator|=
name|bTargetRGBA16
expr_stmt|;
comment|/* color correction (if necessary) */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fCorrectrow
operator|)
condition|)
name|iRetcode
operator|=
operator|(
operator|(
name|mng_correctrow
operator|)
name|pData
operator|->
name|fCorrectrow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
comment|/* flipping (if necessary) */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fFliprow
operator|)
condition|)
name|iRetcode
operator|=
operator|(
operator|(
name|mng_fliprow
operator|)
name|pData
operator|->
name|fFliprow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
comment|/* tiling (if necessary) */
if|if
condition|(
operator|(
operator|!
name|iRetcode
operator|)
operator|&&
operator|(
name|pData
operator|->
name|fTilerow
operator|)
condition|)
name|iRetcode
operator|=
operator|(
operator|(
name|mng_tilerow
operator|)
name|pData
operator|->
name|fTilerow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iRetcode
condition|)
comment|/* and paste..... */
block|{
name|pData
operator|->
name|iRow
operator|=
name|iTargetY
expr_stmt|;
name|pData
operator|->
name|iRowsamples
operator|=
name|iTargetsamples
expr_stmt|;
name|pData
operator|->
name|iRowsize
operator|=
name|iTargetrowsize
expr_stmt|;
name|iRetcode
operator|=
operator|(
operator|(
name|mng_deltarow
operator|)
name|pData
operator|->
name|fDeltarow
operator|)
operator|(
name|pData
operator|)
expr_stmt|;
block|}
name|iSourceY
operator|+=
name|iSourceYinc
expr_stmt|;
comment|/* and next line */
if|if
condition|(
name|iSourceY
operator|<
literal|0
condition|)
name|iSourceY
operator|=
operator|(
name|mng_int32
operator|)
name|pBuf
operator|->
name|iHeight
operator|-
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|iSourceY
operator|>=
operator|(
name|mng_int32
operator|)
name|pBuf
operator|->
name|iHeight
condition|)
name|iSourceY
operator|=
literal|0
expr_stmt|;
name|iTargetY
operator|++
expr_stmt|;
block|}
comment|/* drop the temporary row-buffer */
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pWorkrow
argument_list|,
name|iTemprowsize
argument_list|)
expr_stmt|;
name|MNG_FREEX
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|pRGBArow
argument_list|,
name|iTemprowsize
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|MNG_FULL_CMS
argument_list|)
comment|/* cleanup cms stuff */
if|if
condition|(
operator|!
name|iRetcode
condition|)
name|iRetcode
operator|=
name|mng_clear_cms
argument_list|(
name|pData
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|pSource
operator|++
expr_stmt|;
comment|/* neeeeext */
name|iX
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
if|if
condition|(
operator|!
name|iTargetid
condition|)
comment|/* did we paste into object 0 ? */
else|#
directive|else
if|if
condition|(
operator|!
name|pData
operator|->
name|iPASTtargetid
condition|)
comment|/* did we paste into object 0 ? */
endif|#
directive|endif
block|{
comment|/* display it then ! */
name|iRetcode
operator|=
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pTargetimg
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
comment|/* on error bail out */
return|return
name|iRetcode
return|;
block|}
else|else
block|{
comment|/* target is visible& viewable ? */
if|if
condition|(
operator|(
name|pTargetimg
operator|->
name|bVisible
operator|)
operator|&&
operator|(
name|pTargetimg
operator|->
name|bViewable
operator|)
condition|)
block|{
name|iRetcode
operator|=
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pTargetimg
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
block|}
block|}
block|}
if|if
condition|(
name|pData
operator|->
name|bTimerset
condition|)
comment|/* broken ? */
block|{
ifndef|#
directive|ifndef
name|MNG_OPTIMIZE_DISPLAYCALLS
name|pData
operator|->
name|iPASTid
operator|=
name|iTargetid
expr_stmt|;
else|#
directive|else
name|pData
operator|->
name|iPASTid
operator|=
name|pData
operator|->
name|iPASTtargetid
expr_stmt|;
endif|#
directive|endif
name|pData
operator|->
name|iBreakpoint
operator|=
literal|11
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_PAST
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SKIPCHUNK_PAST */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|MNG_SKIPCHUNK_PAST
end_ifndef
begin_function
DECL|function|mng_process_display_past2
name|mng_retcode
name|mng_process_display_past2
parameter_list|(
name|mng_datap
name|pData
parameter_list|)
block|{
name|mng_retcode
name|iRetcode
decl_stmt|;
name|mng_imagep
name|pTargetimg
decl_stmt|;
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_PAST
argument_list|,
name|MNG_LC_START
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pData
operator|->
name|iPASTid
condition|)
comment|/* a real destination object ? */
name|pTargetimg
operator|=
operator|(
name|mng_imagep
operator|)
name|mng_find_imageobject
argument_list|(
name|pData
argument_list|,
name|pData
operator|->
name|iPASTid
argument_list|)
expr_stmt|;
else|else
comment|/* otherwise object 0 */
name|pTargetimg
operator|=
operator|(
name|mng_imagep
operator|)
name|pData
operator|->
name|pObjzero
expr_stmt|;
name|iRetcode
operator|=
name|mng_display_image
argument_list|(
name|pData
argument_list|,
name|pTargetimg
argument_list|,
name|MNG_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iRetcode
condition|)
return|return
name|iRetcode
return|;
name|pData
operator|->
name|iBreakpoint
operator|=
literal|0
expr_stmt|;
comment|/* only once */
ifdef|#
directive|ifdef
name|MNG_SUPPORT_TRACE
name|MNG_TRACE
argument_list|(
name|pData
argument_list|,
name|MNG_FN_PROCESS_DISPLAY_PAST
argument_list|,
name|MNG_LC_END
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|MNG_NOERROR
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_SKIPCHUNK_PAST */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* MNG_INCLUDE_DISPLAY_PROCS */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
begin_comment
comment|/* * end of file                                                            * */
end_comment
begin_comment
comment|/* ************************************************************************** */
end_comment
end_unit
