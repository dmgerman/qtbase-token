begin_unit
begin_comment
comment|/*  * Copyright Â© 2009 Dan Nicholson  * Copyright Â© 2012 Intel Corporation  * Copyright Â© 2012 Ran Benita<ran234@gmail.com>  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors: Dan Nicholson<dbn.lists@gmail.com>  *          Ran Benita<ran234@gmail.com>  *          Daniel Stone<daniel@fooishbar.org>  */
end_comment
begin_include
include|#
directive|include
file|"xkbcomp-priv.h"
end_include
begin_include
include|#
directive|include
file|"rules.h"
end_include
begin_function
specifier|static
name|bool
DECL|function|compile_keymap_file
name|compile_keymap_file
parameter_list|(
name|struct
name|xkb_keymap
modifier|*
name|keymap
parameter_list|,
name|XkbFile
modifier|*
name|file
parameter_list|)
block|{
if|if
condition|(
name|file
operator|->
name|file_type
operator|!=
name|FILE_TYPE_KEYMAP
condition|)
block|{
name|log_err
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Cannot compile a %s file alone into a keymap\n"
argument_list|,
name|xkb_file_type_to_string
argument_list|(
name|file
operator|->
name|file_type
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
if|if
condition|(
operator|!
name|CompileKeymap
argument_list|(
name|file
argument_list|,
name|keymap
argument_list|,
name|MERGE_OVERRIDE
argument_list|)
condition|)
block|{
name|log_err
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Failed to compile keymap\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function
begin_function
specifier|static
name|bool
DECL|function|text_v1_keymap_new_from_names
name|text_v1_keymap_new_from_names
parameter_list|(
name|struct
name|xkb_keymap
modifier|*
name|keymap
parameter_list|,
specifier|const
name|struct
name|xkb_rule_names
modifier|*
name|rmlvo
parameter_list|)
block|{
name|bool
name|ok
decl_stmt|;
name|struct
name|xkb_component_names
name|kccgst
decl_stmt|;
name|XkbFile
modifier|*
name|file
decl_stmt|;
name|log_dbg
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Compiling from RMLVO: rules '%s', model '%s', layout '%s', "
literal|"variant '%s', options '%s'\n"
argument_list|,
name|rmlvo
operator|->
name|rules
argument_list|,
name|rmlvo
operator|->
name|model
argument_list|,
name|rmlvo
operator|->
name|layout
argument_list|,
name|rmlvo
operator|->
name|variant
argument_list|,
name|rmlvo
operator|->
name|options
argument_list|)
expr_stmt|;
name|ok
operator|=
name|xkb_components_from_rules
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
name|rmlvo
argument_list|,
operator|&
name|kccgst
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|log_err
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Couldn't look up rules '%s', model '%s', layout '%s', "
literal|"variant '%s', options '%s'\n"
argument_list|,
name|rmlvo
operator|->
name|rules
argument_list|,
name|rmlvo
operator|->
name|model
argument_list|,
name|rmlvo
operator|->
name|layout
argument_list|,
name|rmlvo
operator|->
name|variant
argument_list|,
name|rmlvo
operator|->
name|options
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|log_dbg
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Compiling from KcCGST: keycodes '%s', types '%s', "
literal|"compat '%s', symbols '%s'\n"
argument_list|,
name|kccgst
operator|.
name|keycodes
argument_list|,
name|kccgst
operator|.
name|types
argument_list|,
name|kccgst
operator|.
name|compat
argument_list|,
name|kccgst
operator|.
name|symbols
argument_list|)
expr_stmt|;
name|file
operator|=
name|XkbFileFromComponents
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
operator|&
name|kccgst
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|kccgst
operator|.
name|keycodes
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|kccgst
operator|.
name|types
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|kccgst
operator|.
name|compat
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|kccgst
operator|.
name|symbols
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|file
condition|)
block|{
name|log_err
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Failed to generate parsed XKB file from components\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|ok
operator|=
name|compile_keymap_file
argument_list|(
name|keymap
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|FreeXkbFile
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
name|ok
return|;
block|}
end_function
begin_function
specifier|static
name|bool
DECL|function|text_v1_keymap_new_from_string
name|text_v1_keymap_new_from_string
parameter_list|(
name|struct
name|xkb_keymap
modifier|*
name|keymap
parameter_list|,
specifier|const
name|char
modifier|*
name|string
parameter_list|)
block|{
name|bool
name|ok
decl_stmt|;
name|XkbFile
modifier|*
name|xkb_file
decl_stmt|;
name|xkb_file
operator|=
name|XkbParseString
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
name|string
argument_list|,
literal|"(input string)"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xkb_file
condition|)
block|{
name|log_err
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Failed to parse input xkb string\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ok
operator|=
name|compile_keymap_file
argument_list|(
name|keymap
argument_list|,
name|xkb_file
argument_list|)
expr_stmt|;
name|FreeXkbFile
argument_list|(
name|xkb_file
argument_list|)
expr_stmt|;
return|return
name|ok
return|;
block|}
end_function
begin_function
specifier|static
name|bool
DECL|function|text_v1_keymap_new_from_buffer
name|text_v1_keymap_new_from_buffer
parameter_list|(
name|struct
name|xkb_keymap
modifier|*
name|keymap
parameter_list|,
specifier|const
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|bool
name|ok
decl_stmt|;
name|XkbFile
modifier|*
name|xkb_file
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|length
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
name|log_err
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Cannot allocate memory for keymap\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* yy_scan_buffer requires two terminating zero bytes */
name|memcpy
argument_list|(
name|buf
argument_list|,
name|buffer
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|buf
index|[
name|length
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
name|length
operator|+
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|xkb_file
operator|=
name|XkbParseBuffer
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
name|buf
argument_list|,
name|length
operator|+
literal|2
argument_list|,
literal|"input"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xkb_file
condition|)
block|{
name|log_err
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Failed to parse input xkb file\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ok
operator|=
name|compile_keymap_file
argument_list|(
name|keymap
argument_list|,
name|xkb_file
argument_list|)
expr_stmt|;
name|FreeXkbFile
argument_list|(
name|xkb_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ok
return|;
block|}
end_function
begin_function
specifier|static
name|bool
DECL|function|text_v1_keymap_new_from_file
name|text_v1_keymap_new_from_file
parameter_list|(
name|struct
name|xkb_keymap
modifier|*
name|keymap
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|)
block|{
name|bool
name|ok
decl_stmt|;
name|XkbFile
modifier|*
name|xkb_file
decl_stmt|;
name|xkb_file
operator|=
name|XkbParseFile
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
name|file
argument_list|,
literal|"(unknown file)"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xkb_file
condition|)
block|{
name|log_err
argument_list|(
name|keymap
operator|->
name|ctx
argument_list|,
literal|"Failed to parse input xkb file\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|ok
operator|=
name|compile_keymap_file
argument_list|(
name|keymap
argument_list|,
name|xkb_file
argument_list|)
expr_stmt|;
name|FreeXkbFile
argument_list|(
name|xkb_file
argument_list|)
expr_stmt|;
return|return
name|ok
return|;
block|}
end_function
begin_decl_stmt
DECL|variable|text_v1_keymap_format_ops
specifier|const
name|struct
name|xkb_keymap_format_ops
name|text_v1_keymap_format_ops
init|=
block|{
operator|.
name|keymap_new_from_names
operator|=
name|text_v1_keymap_new_from_names
block|,
operator|.
name|keymap_new_from_string
operator|=
name|text_v1_keymap_new_from_string
block|,
operator|.
name|keymap_new_from_buffer
operator|=
name|text_v1_keymap_new_from_buffer
block|,
operator|.
name|keymap_new_from_file
operator|=
name|text_v1_keymap_new_from_file
block|,
operator|.
name|keymap_get_as_string
operator|=
name|text_v1_keymap_get_as_string
block|, }
decl_stmt|;
end_decl_stmt
end_unit
