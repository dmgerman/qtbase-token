begin_unit
begin_comment
comment|/*  * jmemname.c  *  * Copyright (C) 1992-1997, Thomas G. Lane.  * This file is part of the Independent JPEG Group's software.  * For conditions of distribution and use, see the accompanying README file.  *  * This file provides a generic implementation of the system-dependent  * portion of the JPEG memory manager.  This implementation assumes that  * you must explicitly construct a name for each temp file.  * Also, the problem of determining the amount of memory available  * is shoved onto the user.  */
end_comment
begin_define
DECL|macro|JPEG_INTERNALS
define|#
directive|define
name|JPEG_INTERNALS
end_define
begin_include
include|#
directive|include
file|"jinclude.h"
end_include
begin_include
include|#
directive|include
file|"jpeglib.h"
end_include
begin_include
include|#
directive|include
file|"jmemsys.h"
end_include
begin_comment
comment|/* import the system-dependent declarations */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|HAVE_STDLIB_H
end_ifndef
begin_comment
comment|/*<stdlib.h> should declare malloc(),free() */
end_comment
begin_decl_stmt
specifier|extern
name|void
modifier|*
name|malloc
name|JPP
argument_list|(
operator|(
name|size_t
name|size
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt
begin_decl_stmt
specifier|extern
name|void
name|free
name|JPP
argument_list|(
operator|(
name|void
operator|*
name|ptr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|SEEK_SET
end_ifndef
begin_comment
comment|/* pre-ANSI systems may not define this; */
end_comment
begin_define
DECL|macro|SEEK_SET
define|#
directive|define
name|SEEK_SET
value|0
end_define
begin_comment
DECL|macro|SEEK_SET
comment|/* if not, assume 0 is correct */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|DONT_USE_B_MODE
end_ifdef
begin_comment
comment|/* define mode parameters for fopen() */
end_comment
begin_define
DECL|macro|READ_BINARY
define|#
directive|define
name|READ_BINARY
value|"r"
end_define
begin_define
DECL|macro|RW_BINARY
define|#
directive|define
name|RW_BINARY
value|"w+"
end_define
begin_else
else|#
directive|else
end_else
begin_ifdef
ifdef|#
directive|ifdef
name|VMS
end_ifdef
begin_comment
comment|/* VMS is very nonstandard */
end_comment
begin_define
DECL|macro|READ_BINARY
define|#
directive|define
name|READ_BINARY
value|"rb", "ctx=stm"
end_define
begin_define
DECL|macro|RW_BINARY
define|#
directive|define
name|RW_BINARY
value|"w+b", "ctx=stm"
end_define
begin_else
else|#
directive|else
end_else
begin_comment
comment|/* standard ANSI-compliant case */
end_comment
begin_define
DECL|macro|READ_BINARY
define|#
directive|define
name|READ_BINARY
value|"rb"
end_define
begin_define
DECL|macro|RW_BINARY
define|#
directive|define
name|RW_BINARY
value|"w+b"
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/*  * Selection of a file name for a temporary file.  * This is system-dependent!  *  * The code as given is suitable for most Unix systems, and it is easily  * modified for most non-Unix systems.  Some notes:  *  1.  The temp file is created in the directory named by TEMP_DIRECTORY.  *      The default value is /usr/tmp, which is the conventional place for  *      creating large temp files on Unix.  On other systems you'll probably  *      want to change the file location.  You can do this by editing the  *      #define, or (preferred) by defining TEMP_DIRECTORY in jconfig.h.  *  *  2.  If you need to change the file name as well as its location,  *      you can override the TEMP_FILE_NAME macro.  (Note that this is  *      actually a printf format string; it must contain %s and %d.)  *      Few people should need to do this.  *  *  3.  mktemp() is used to ensure that multiple processes running  *      simultaneously won't select the same file names.  If your system  *      doesn't have mktemp(), define NO_MKTEMP to do it the hard way.  *      (If you don't have<errno.h>, also define NO_ERRNO_H.)  *  *  4.  You probably want to define NEED_SIGNAL_CATCHER so that cjpeg.c/djpeg.c  *      will cause the temp files to be removed if you stop the program early.  */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|TEMP_DIRECTORY
end_ifndef
begin_comment
comment|/* can override from jconfig.h or Makefile */
end_comment
begin_define
DECL|macro|TEMP_DIRECTORY
define|#
directive|define
name|TEMP_DIRECTORY
value|"/usr/tmp/"
end_define
begin_comment
DECL|macro|TEMP_DIRECTORY
comment|/* recommended setting for Unix */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_decl_stmt
DECL|variable|next_file_num
specifier|static
name|int
name|next_file_num
decl_stmt|;
end_decl_stmt
begin_comment
DECL|variable|next_file_num
comment|/* to distinguish among several temp files */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|NO_MKTEMP
end_ifdef
begin_ifndef
ifndef|#
directive|ifndef
name|TEMP_FILE_NAME
end_ifndef
begin_comment
comment|/* can override from jconfig.h or Makefile */
end_comment
begin_define
DECL|macro|TEMP_FILE_NAME
define|#
directive|define
name|TEMP_FILE_NAME
value|"%sJPG%03d.TMP"
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|NO_ERRNO_H
end_ifndef
begin_include
include|#
directive|include
file|<errno.h>
end_include
begin_comment
comment|/* to define ENOENT */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ANSI C specifies that errno is a macro, but on older systems it's more  * likely to be a plain int variable.  And not all versions of errno.h  * bother to declare it, so we have to in order to be most portable.  Thus:  */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|errno
end_ifndef
begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt
begin_endif
endif|#
directive|endif
end_endif
begin_macro
name|LOCAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|select_file_name
name|select_file_name
argument_list|(
argument|char * fname
argument_list|)
end_macro
begin_block
block|{
name|FILE
modifier|*
name|tfile
decl_stmt|;
comment|/* Keep generating file names till we find one that's not in use */
for|for
control|(
init|;
condition|;
control|)
block|{
name|next_file_num
operator|++
expr_stmt|;
comment|/* advance counter */
name|sprintf
argument_list|(
name|fname
argument_list|,
name|TEMP_FILE_NAME
argument_list|,
name|TEMP_DIRECTORY
argument_list|,
name|next_file_num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tfile
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
name|READ_BINARY
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/* fopen could have failed for a reason other than the file not        * being there; for example, file there but unreadable.        * If<errno.h> isn't available, then we cannot test the cause.        */
ifdef|#
directive|ifdef
name|ENOENT
if|if
condition|(
name|errno
operator|!=
name|ENOENT
condition|)
continue|continue;
endif|#
directive|endif
break|break;
block|}
name|fclose
argument_list|(
name|tfile
argument_list|)
expr_stmt|;
comment|/* oops, it's there; close tfile& try again */
block|}
block|}
end_block
begin_else
else|#
directive|else
end_else
begin_comment
comment|/* ! NO_MKTEMP */
end_comment
begin_comment
comment|/* Note that mktemp() requires the initial filename to end in six X's */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|TEMP_FILE_NAME
end_ifndef
begin_comment
comment|/* can override from jconfig.h or Makefile */
end_comment
begin_define
DECL|macro|TEMP_FILE_NAME
define|#
directive|define
name|TEMP_FILE_NAME
value|"%sJPG%dXXXXXX"
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_macro
name|LOCAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|select_file_name
name|select_file_name
argument_list|(
argument|char * fname
argument_list|)
end_macro
begin_block
block|{
name|next_file_num
operator|++
expr_stmt|;
comment|/* advance counter */
name|sprintf
argument_list|(
name|fname
argument_list|,
name|TEMP_FILE_NAME
argument_list|,
name|TEMP_DIRECTORY
argument_list|,
name|next_file_num
argument_list|)
expr_stmt|;
name|mktemp
argument_list|(
name|fname
argument_list|)
expr_stmt|;
comment|/* make sure file name is unique */
comment|/* mktemp replaces the trailing XXXXXX with a unique string of characters */
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* NO_MKTEMP */
end_comment
begin_comment
comment|/*  * Memory allocation and freeing are controlled by the regular library  * routines malloc() and free().  */
end_comment
begin_macro
name|GLOBAL
argument_list|(
argument|void *
argument_list|)
end_macro
begin_macro
DECL|function|jpeg_get_small
name|jpeg_get_small
argument_list|(
argument|j_common_ptr cinfo
argument_list|,
argument|size_t sizeofobject
argument_list|)
end_macro
begin_block
block|{
return|return
operator|(
name|void
operator|*
operator|)
name|malloc
argument_list|(
name|sizeofobject
argument_list|)
return|;
block|}
end_block
begin_macro
name|GLOBAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|jpeg_free_small
name|jpeg_free_small
argument_list|(
argument|j_common_ptr cinfo
argument_list|,
argument|void * object
argument_list|,
argument|size_t sizeofobject
argument_list|)
end_macro
begin_block
block|{
name|free
argument_list|(
name|object
argument_list|)
expr_stmt|;
block|}
end_block
begin_comment
comment|/*  * "Large" objects are treated the same as "small" ones.  * NB: although we include FAR keywords in the routine declarations,  * this file won't actually work in 80x86 small/medium model; at least,  * you probably won't be able to process useful-size images in only 64KB.  */
end_comment
begin_macro
name|GLOBAL
argument_list|(
argument|void FAR *
argument_list|)
end_macro
begin_macro
DECL|function|jpeg_get_large
name|jpeg_get_large
argument_list|(
argument|j_common_ptr cinfo
argument_list|,
argument|size_t sizeofobject
argument_list|)
end_macro
begin_block
block|{
return|return
operator|(
name|void
name|FAR
operator|*
operator|)
name|malloc
argument_list|(
name|sizeofobject
argument_list|)
return|;
block|}
end_block
begin_macro
name|GLOBAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|jpeg_free_large
name|jpeg_free_large
argument_list|(
argument|j_common_ptr cinfo
argument_list|,
argument|void FAR * object
argument_list|,
argument|size_t sizeofobject
argument_list|)
end_macro
begin_block
block|{
name|free
argument_list|(
name|object
argument_list|)
expr_stmt|;
block|}
end_block
begin_comment
comment|/*  * This routine computes the total memory space available for allocation.  * It's impossible to do this in a portable way; our current solution is  * to make the user tell us (with a default value set at compile time).  * If you can actually get the available space, it's a good idea to subtract  * a slop factor of 5% or so.  */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|DEFAULT_MAX_MEM
end_ifndef
begin_comment
comment|/* so can override from makefile */
end_comment
begin_define
DECL|macro|DEFAULT_MAX_MEM
define|#
directive|define
name|DEFAULT_MAX_MEM
value|1000000L
end_define
begin_comment
DECL|macro|DEFAULT_MAX_MEM
comment|/* default: one megabyte */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_macro
name|GLOBAL
argument_list|(
argument|long
argument_list|)
end_macro
begin_macro
DECL|function|jpeg_mem_available
name|jpeg_mem_available
argument_list|(
argument|j_common_ptr cinfo
argument_list|,
argument|long min_bytes_needed
argument_list|,
argument|long max_bytes_needed
argument_list|,
argument|long already_allocated
argument_list|)
end_macro
begin_block
block|{
return|return
name|cinfo
operator|->
name|mem
operator|->
name|max_memory_to_use
operator|-
name|already_allocated
return|;
block|}
end_block
begin_comment
comment|/*  * Backing store (temporary file) management.  * Backing store objects are only used when the value returned by  * jpeg_mem_available is less than the total space needed.  You can dispense  * with these routines if you have plenty of virtual memory; see jmemnobs.c.  */
end_comment
begin_macro
name|METHODDEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|read_backing_store
name|read_backing_store
argument_list|(
argument|j_common_ptr cinfo
argument_list|,
argument|backing_store_ptr info
argument_list|,
argument|void FAR * buffer_address
argument_list|,
argument|long file_offset
argument_list|,
argument|long byte_count
argument_list|)
end_macro
begin_block
block|{
if|if
condition|(
name|fseek
argument_list|(
name|info
operator|->
name|temp_file
argument_list|,
name|file_offset
argument_list|,
name|SEEK_SET
argument_list|)
condition|)
name|ERREXIT
argument_list|(
name|cinfo
argument_list|,
name|JERR_TFILE_SEEK
argument_list|)
expr_stmt|;
if|if
condition|(
name|JFREAD
argument_list|(
name|info
operator|->
name|temp_file
argument_list|,
name|buffer_address
argument_list|,
name|byte_count
argument_list|)
operator|!=
operator|(
name|size_t
operator|)
name|byte_count
condition|)
name|ERREXIT
argument_list|(
name|cinfo
argument_list|,
name|JERR_TFILE_READ
argument_list|)
expr_stmt|;
block|}
end_block
begin_macro
name|METHODDEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|write_backing_store
name|write_backing_store
argument_list|(
argument|j_common_ptr cinfo
argument_list|,
argument|backing_store_ptr info
argument_list|,
argument|void FAR * buffer_address
argument_list|,
argument|long file_offset
argument_list|,
argument|long byte_count
argument_list|)
end_macro
begin_block
block|{
if|if
condition|(
name|fseek
argument_list|(
name|info
operator|->
name|temp_file
argument_list|,
name|file_offset
argument_list|,
name|SEEK_SET
argument_list|)
condition|)
name|ERREXIT
argument_list|(
name|cinfo
argument_list|,
name|JERR_TFILE_SEEK
argument_list|)
expr_stmt|;
if|if
condition|(
name|JFWRITE
argument_list|(
name|info
operator|->
name|temp_file
argument_list|,
name|buffer_address
argument_list|,
name|byte_count
argument_list|)
operator|!=
operator|(
name|size_t
operator|)
name|byte_count
condition|)
name|ERREXIT
argument_list|(
name|cinfo
argument_list|,
name|JERR_TFILE_WRITE
argument_list|)
expr_stmt|;
block|}
end_block
begin_macro
name|METHODDEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|close_backing_store
name|close_backing_store
argument_list|(
argument|j_common_ptr cinfo
argument_list|,
argument|backing_store_ptr info
argument_list|)
end_macro
begin_block
block|{
name|fclose
argument_list|(
name|info
operator|->
name|temp_file
argument_list|)
expr_stmt|;
comment|/* close the file */
name|unlink
argument_list|(
name|info
operator|->
name|temp_name
argument_list|)
expr_stmt|;
comment|/* delete the file */
comment|/* If your system doesn't have unlink(), use remove() instead.  * remove() is the ANSI-standard name for this function, but if  * your system was ANSI you'd be using jmemansi.c, right?  */
name|TRACEMSS
argument_list|(
name|cinfo
argument_list|,
literal|1
argument_list|,
name|JTRC_TFILE_CLOSE
argument_list|,
name|info
operator|->
name|temp_name
argument_list|)
expr_stmt|;
block|}
end_block
begin_comment
comment|/*  * Initial opening of a backing-store object.  */
end_comment
begin_macro
name|GLOBAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|jpeg_open_backing_store
name|jpeg_open_backing_store
argument_list|(
argument|j_common_ptr cinfo
argument_list|,
argument|backing_store_ptr info
argument_list|,
argument|long total_bytes_needed
argument_list|)
end_macro
begin_block
block|{
name|select_file_name
argument_list|(
name|info
operator|->
name|temp_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|info
operator|->
name|temp_file
operator|=
name|fopen
argument_list|(
name|info
operator|->
name|temp_name
argument_list|,
name|RW_BINARY
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|ERREXITS
argument_list|(
name|cinfo
argument_list|,
name|JERR_TFILE_CREATE
argument_list|,
name|info
operator|->
name|temp_name
argument_list|)
expr_stmt|;
name|info
operator|->
name|read_backing_store
operator|=
name|read_backing_store
expr_stmt|;
name|info
operator|->
name|write_backing_store
operator|=
name|write_backing_store
expr_stmt|;
name|info
operator|->
name|close_backing_store
operator|=
name|close_backing_store
expr_stmt|;
name|TRACEMSS
argument_list|(
name|cinfo
argument_list|,
literal|1
argument_list|,
name|JTRC_TFILE_OPEN
argument_list|,
name|info
operator|->
name|temp_name
argument_list|)
expr_stmt|;
block|}
end_block
begin_comment
comment|/*  * These routines take care of any system-dependent initialization and  * cleanup required.  */
end_comment
begin_macro
name|GLOBAL
argument_list|(
argument|long
argument_list|)
end_macro
begin_macro
DECL|function|jpeg_mem_init
name|jpeg_mem_init
argument_list|(
argument|j_common_ptr cinfo
argument_list|)
end_macro
begin_block
block|{
name|next_file_num
operator|=
literal|0
expr_stmt|;
comment|/* initialize temp file name generator */
return|return
name|DEFAULT_MAX_MEM
return|;
comment|/* default for max_memory_to_use */
block|}
end_block
begin_macro
name|GLOBAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|jpeg_mem_term
name|jpeg_mem_term
argument_list|(
argument|j_common_ptr cinfo
argument_list|)
end_macro
begin_block
block|{
comment|/* no work */
block|}
end_block
end_unit
