begin_unit
begin_comment
comment|/*  * jdinput.c  *  * Copyright (C) 1991-1997, Thomas G. Lane.  * Modified 2002-2009 by Guido Vollbeding.  * This file is part of the Independent JPEG Group's software.  * For conditions of distribution and use, see the accompanying README file.  *  * This file contains input control logic for the JPEG decompressor.  * These routines are concerned with controlling the decompressor's input  * processing (marker reading and coefficient decoding).  The actual input  * reading is done in jdmarker.c, jdhuff.c, and jdarith.c.  */
end_comment
begin_define
DECL|macro|JPEG_INTERNALS
define|#
directive|define
name|JPEG_INTERNALS
end_define
begin_include
include|#
directive|include
file|"jinclude.h"
end_include
begin_include
include|#
directive|include
file|"jpeglib.h"
end_include
begin_comment
comment|/* Private state */
end_comment
begin_typedef
typedef|typedef
struct|struct
block|{
DECL|member|pub
name|struct
name|jpeg_input_controller
name|pub
decl_stmt|;
comment|/* public fields */
DECL|member|inheaders
name|int
name|inheaders
decl_stmt|;
comment|/* Nonzero until first SOS is reached */
block|}
DECL|typedef|my_input_controller
name|my_input_controller
typedef|;
end_typedef
begin_typedef
DECL|typedef|my_inputctl_ptr
typedef|typedef
name|my_input_controller
modifier|*
name|my_inputctl_ptr
typedef|;
end_typedef
begin_comment
comment|/* Forward declarations */
end_comment
begin_macro
name|METHODDEF
argument_list|(
argument|int
argument_list|)
end_macro
begin_decl_stmt
name|consume_markers
name|JPP
argument_list|(
operator|(
name|j_decompress_ptr
name|cinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*  * Routines to calculate various quantities related to the size of the image.  */
end_comment
begin_comment
comment|/*  * Compute output image dimensions and related values.  * NOTE: this is exported for possible use by application.  * Hence it mustn't do anything that can't be done twice.  */
end_comment
begin_macro
name|GLOBAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|jpeg_core_output_dimensions
name|jpeg_core_output_dimensions
argument_list|(
argument|j_decompress_ptr cinfo
argument_list|)
end_macro
begin_comment
comment|/* Do computations that are needed before master selection phase.  * This function is used for transcoding and full decompression.  */
end_comment
begin_block
block|{
ifdef|#
directive|ifdef
name|IDCT_SCALING_SUPPORTED
name|int
name|ci
decl_stmt|;
name|jpeg_component_info
modifier|*
name|compptr
decl_stmt|;
comment|/* Compute actual output image dimensions and DCT scaling choices. */
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
condition|)
block|{
comment|/* Provide 1/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|2
condition|)
block|{
comment|/* Provide 2/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|2L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|2L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|2
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|3
condition|)
block|{
comment|/* Provide 3/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|3L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|3L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|3
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|4
condition|)
block|{
comment|/* Provide 4/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|4L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|4L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|4
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|5
condition|)
block|{
comment|/* Provide 5/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|5L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|5L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|5
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|6
condition|)
block|{
comment|/* Provide 6/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|6L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|6L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|6
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|7
condition|)
block|{
comment|/* Provide 7/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|7L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|7L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|7
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|7
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|8
condition|)
block|{
comment|/* Provide 8/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|8L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|8L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|8
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|9
condition|)
block|{
comment|/* Provide 9/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|9L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|9L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|9
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|9
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|10
condition|)
block|{
comment|/* Provide 10/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|10L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|10L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|10
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|11
condition|)
block|{
comment|/* Provide 11/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|11L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|11L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|11
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|11
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|12
condition|)
block|{
comment|/* Provide 12/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|12L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|12L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|12
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|12
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|13
condition|)
block|{
comment|/* Provide 13/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|13L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|13L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|13
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|13
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|14
condition|)
block|{
comment|/* Provide 14/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|14L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|14L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|14
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|14
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cinfo
operator|->
name|scale_num
operator|*
name|cinfo
operator|->
name|block_size
operator|<=
name|cinfo
operator|->
name|scale_denom
operator|*
literal|15
condition|)
block|{
comment|/* Provide 15/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|15L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|15L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|15
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|15
expr_stmt|;
block|}
else|else
block|{
comment|/* Provide 16/block_size scaling */
name|cinfo
operator|->
name|output_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
literal|16L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
literal|16L
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
literal|16
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
literal|16
expr_stmt|;
block|}
comment|/* Recompute dimensions of components */
for|for
control|(
name|ci
operator|=
literal|0
operator|,
name|compptr
operator|=
name|cinfo
operator|->
name|comp_info
init|;
name|ci
operator|<
name|cinfo
operator|->
name|num_components
condition|;
name|ci
operator|++
operator|,
name|compptr
operator|++
control|)
block|{
name|compptr
operator|->
name|DCT_h_scaled_size
operator|=
name|cinfo
operator|->
name|min_DCT_h_scaled_size
expr_stmt|;
name|compptr
operator|->
name|DCT_v_scaled_size
operator|=
name|cinfo
operator|->
name|min_DCT_v_scaled_size
expr_stmt|;
block|}
else|#
directive|else
comment|/* !IDCT_SCALING_SUPPORTED */
comment|/* Hardwire it to "no scaling" */
name|cinfo
operator|->
name|output_width
operator|=
name|cinfo
operator|->
name|image_width
expr_stmt|;
name|cinfo
operator|->
name|output_height
operator|=
name|cinfo
operator|->
name|image_height
expr_stmt|;
comment|/* jdinput.c has already initialized DCT_scaled_size,    * and has computed unscaled downsampled_width and downsampled_height.    */
endif|#
directive|endif
comment|/* IDCT_SCALING_SUPPORTED */
block|}
end_block
begin_macro
name|LOCAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|initial_setup
name|initial_setup
argument_list|(
argument|j_decompress_ptr cinfo
argument_list|)
end_macro
begin_comment
comment|/* Called once, when first SOS marker is reached */
end_comment
begin_block
block|{
name|int
name|ci
decl_stmt|;
name|jpeg_component_info
modifier|*
name|compptr
decl_stmt|;
comment|/* Make sure image isn't bigger than I can handle */
if|if
condition|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|>
operator|(
name|long
operator|)
name|JPEG_MAX_DIMENSION
operator|||
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|>
operator|(
name|long
operator|)
name|JPEG_MAX_DIMENSION
condition|)
name|ERREXIT1
argument_list|(
name|cinfo
argument_list|,
name|JERR_IMAGE_TOO_BIG
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|JPEG_MAX_DIMENSION
argument_list|)
expr_stmt|;
comment|/* For now, precision must match compiled-in value... */
if|if
condition|(
name|cinfo
operator|->
name|data_precision
operator|!=
name|BITS_IN_JSAMPLE
condition|)
name|ERREXIT1
argument_list|(
name|cinfo
argument_list|,
name|JERR_BAD_PRECISION
argument_list|,
name|cinfo
operator|->
name|data_precision
argument_list|)
expr_stmt|;
comment|/* Check that number of components won't exceed internal array sizes */
if|if
condition|(
name|cinfo
operator|->
name|num_components
operator|>
name|MAX_COMPONENTS
condition|)
name|ERREXIT2
argument_list|(
name|cinfo
argument_list|,
name|JERR_COMPONENT_COUNT
argument_list|,
name|cinfo
operator|->
name|num_components
argument_list|,
name|MAX_COMPONENTS
argument_list|)
expr_stmt|;
comment|/* Compute maximum sampling factors; check factor validity */
name|cinfo
operator|->
name|max_h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|->
name|max_v_samp_factor
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|ci
operator|=
literal|0
operator|,
name|compptr
operator|=
name|cinfo
operator|->
name|comp_info
init|;
name|ci
operator|<
name|cinfo
operator|->
name|num_components
condition|;
name|ci
operator|++
operator|,
name|compptr
operator|++
control|)
block|{
if|if
condition|(
name|compptr
operator|->
name|h_samp_factor
operator|<=
literal|0
operator|||
name|compptr
operator|->
name|h_samp_factor
operator|>
name|MAX_SAMP_FACTOR
operator|||
name|compptr
operator|->
name|v_samp_factor
operator|<=
literal|0
operator|||
name|compptr
operator|->
name|v_samp_factor
operator|>
name|MAX_SAMP_FACTOR
condition|)
name|ERREXIT
argument_list|(
name|cinfo
argument_list|,
name|JERR_BAD_SAMPLING
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|max_h_samp_factor
operator|=
name|MAX
argument_list|(
name|cinfo
operator|->
name|max_h_samp_factor
argument_list|,
name|compptr
operator|->
name|h_samp_factor
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|max_v_samp_factor
operator|=
name|MAX
argument_list|(
name|cinfo
operator|->
name|max_v_samp_factor
argument_list|,
name|compptr
operator|->
name|v_samp_factor
argument_list|)
expr_stmt|;
block|}
comment|/* Derive block_size, natural_order, and lim_Se */
if|if
condition|(
name|cinfo
operator|->
name|is_baseline
operator|||
operator|(
name|cinfo
operator|->
name|progressive_mode
operator|&&
name|cinfo
operator|->
name|comps_in_scan
operator|)
condition|)
block|{
comment|/* no pseudo SOS marker */
name|cinfo
operator|->
name|block_size
operator|=
name|DCTSIZE
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
block|}
else|else
switch|switch
condition|(
name|cinfo
operator|->
name|Se
condition|)
block|{
case|case
operator|(
literal|1
operator|*
literal|1
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
comment|/* not needed */
name|cinfo
operator|->
name|lim_Se
operator|=
name|cinfo
operator|->
name|Se
expr_stmt|;
break|break;
case|case
operator|(
literal|2
operator|*
literal|2
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|2
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order2
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|cinfo
operator|->
name|Se
expr_stmt|;
break|break;
case|case
operator|(
literal|3
operator|*
literal|3
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|3
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order3
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|cinfo
operator|->
name|Se
expr_stmt|;
break|break;
case|case
operator|(
literal|4
operator|*
literal|4
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|4
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order4
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|cinfo
operator|->
name|Se
expr_stmt|;
break|break;
case|case
operator|(
literal|5
operator|*
literal|5
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|5
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order5
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|cinfo
operator|->
name|Se
expr_stmt|;
break|break;
case|case
operator|(
literal|6
operator|*
literal|6
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|6
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order6
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|cinfo
operator|->
name|Se
expr_stmt|;
break|break;
case|case
operator|(
literal|7
operator|*
literal|7
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|7
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order7
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|cinfo
operator|->
name|Se
expr_stmt|;
break|break;
case|case
operator|(
literal|8
operator|*
literal|8
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|8
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
break|break;
case|case
operator|(
literal|9
operator|*
literal|9
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|9
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
break|break;
case|case
operator|(
literal|10
operator|*
literal|10
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|10
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
break|break;
case|case
operator|(
literal|11
operator|*
literal|11
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|11
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
break|break;
case|case
operator|(
literal|12
operator|*
literal|12
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|12
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
break|break;
case|case
operator|(
literal|13
operator|*
literal|13
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|13
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
break|break;
case|case
operator|(
literal|14
operator|*
literal|14
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|14
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
break|break;
case|case
operator|(
literal|15
operator|*
literal|15
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|15
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
break|break;
case|case
operator|(
literal|16
operator|*
literal|16
operator|-
literal|1
operator|)
case|:
name|cinfo
operator|->
name|block_size
operator|=
literal|16
expr_stmt|;
name|cinfo
operator|->
name|natural_order
operator|=
name|jpeg_natural_order
expr_stmt|;
name|cinfo
operator|->
name|lim_Se
operator|=
name|DCTSIZE2
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|ERREXIT4
argument_list|(
name|cinfo
argument_list|,
name|JERR_BAD_PROGRESSION
argument_list|,
name|cinfo
operator|->
name|Ss
argument_list|,
name|cinfo
operator|->
name|Se
argument_list|,
name|cinfo
operator|->
name|Ah
argument_list|,
name|cinfo
operator|->
name|Al
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* We initialize DCT_scaled_size and min_DCT_scaled_size to block_size.    * In the full decompressor,    * this will be overridden by jpeg_calc_output_dimensions in jdmaster.c;    * but in the transcoder,    * jpeg_calc_output_dimensions is not used, so we must do it here.    */
name|cinfo
operator|->
name|min_DCT_h_scaled_size
operator|=
name|cinfo
operator|->
name|block_size
expr_stmt|;
name|cinfo
operator|->
name|min_DCT_v_scaled_size
operator|=
name|cinfo
operator|->
name|block_size
expr_stmt|;
comment|/* Compute dimensions of components */
for|for
control|(
name|ci
operator|=
literal|0
operator|,
name|compptr
operator|=
name|cinfo
operator|->
name|comp_info
init|;
name|ci
operator|<
name|cinfo
operator|->
name|num_components
condition|;
name|ci
operator|++
operator|,
name|compptr
operator|++
control|)
block|{
name|compptr
operator|->
name|DCT_h_scaled_size
operator|=
name|cinfo
operator|->
name|block_size
expr_stmt|;
name|compptr
operator|->
name|DCT_v_scaled_size
operator|=
name|cinfo
operator|->
name|block_size
expr_stmt|;
comment|/* Size in DCT blocks */
name|compptr
operator|->
name|width_in_blocks
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
operator|(
name|long
operator|)
name|compptr
operator|->
name|h_samp_factor
argument_list|,
call|(
name|long
call|)
argument_list|(
name|cinfo
operator|->
name|max_h_samp_factor
operator|*
name|cinfo
operator|->
name|block_size
argument_list|)
argument_list|)
expr_stmt|;
name|compptr
operator|->
name|height_in_blocks
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
operator|(
name|long
operator|)
name|compptr
operator|->
name|v_samp_factor
argument_list|,
call|(
name|long
call|)
argument_list|(
name|cinfo
operator|->
name|max_v_samp_factor
operator|*
name|cinfo
operator|->
name|block_size
argument_list|)
argument_list|)
expr_stmt|;
comment|/* downsampled_width and downsampled_height will also be overridden by      * jdmaster.c if we are doing full decompression.  The transcoder library      * doesn't use these values, but the calling application might.      */
comment|/* Size in samples */
name|compptr
operator|->
name|downsampled_width
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
operator|*
operator|(
name|long
operator|)
name|compptr
operator|->
name|h_samp_factor
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|max_h_samp_factor
argument_list|)
expr_stmt|;
name|compptr
operator|->
name|downsampled_height
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
operator|*
operator|(
name|long
operator|)
name|compptr
operator|->
name|v_samp_factor
argument_list|,
operator|(
name|long
operator|)
name|cinfo
operator|->
name|max_v_samp_factor
argument_list|)
expr_stmt|;
comment|/* Mark component needed, until color conversion says otherwise */
name|compptr
operator|->
name|component_needed
operator|=
name|TRUE
expr_stmt|;
comment|/* Mark no quantization table yet saved for component */
name|compptr
operator|->
name|quant_table
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Compute number of fully interleaved MCU rows. */
name|cinfo
operator|->
name|total_iMCU_rows
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
argument_list|,
call|(
name|long
call|)
argument_list|(
name|cinfo
operator|->
name|max_v_samp_factor
operator|*
name|cinfo
operator|->
name|block_size
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Decide whether file contains multiple scans */
if|if
condition|(
name|cinfo
operator|->
name|comps_in_scan
operator|<
name|cinfo
operator|->
name|num_components
operator|||
name|cinfo
operator|->
name|progressive_mode
condition|)
name|cinfo
operator|->
name|inputctl
operator|->
name|has_multiple_scans
operator|=
name|TRUE
expr_stmt|;
else|else
name|cinfo
operator|->
name|inputctl
operator|->
name|has_multiple_scans
operator|=
name|FALSE
expr_stmt|;
block|}
end_block
begin_macro
name|LOCAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|per_scan_setup
name|per_scan_setup
argument_list|(
argument|j_decompress_ptr cinfo
argument_list|)
end_macro
begin_comment
comment|/* Do computations that are needed before processing a JPEG scan */
end_comment
begin_comment
comment|/* cinfo->comps_in_scan and cinfo->cur_comp_info[] were set from SOS marker */
end_comment
begin_block
block|{
name|int
name|ci
decl_stmt|,
name|mcublks
decl_stmt|,
name|tmp
decl_stmt|;
name|jpeg_component_info
modifier|*
name|compptr
decl_stmt|;
if|if
condition|(
name|cinfo
operator|->
name|comps_in_scan
operator|==
literal|1
condition|)
block|{
comment|/* Noninterleaved (single-component) scan */
name|compptr
operator|=
name|cinfo
operator|->
name|cur_comp_info
index|[
literal|0
index|]
expr_stmt|;
comment|/* Overall image size in MCUs */
name|cinfo
operator|->
name|MCUs_per_row
operator|=
name|compptr
operator|->
name|width_in_blocks
expr_stmt|;
name|cinfo
operator|->
name|MCU_rows_in_scan
operator|=
name|compptr
operator|->
name|height_in_blocks
expr_stmt|;
comment|/* For noninterleaved scan, always one block per MCU */
name|compptr
operator|->
name|MCU_width
operator|=
literal|1
expr_stmt|;
name|compptr
operator|->
name|MCU_height
operator|=
literal|1
expr_stmt|;
name|compptr
operator|->
name|MCU_blocks
operator|=
literal|1
expr_stmt|;
name|compptr
operator|->
name|MCU_sample_width
operator|=
name|compptr
operator|->
name|DCT_h_scaled_size
expr_stmt|;
name|compptr
operator|->
name|last_col_width
operator|=
literal|1
expr_stmt|;
comment|/* For noninterleaved scans, it is convenient to define last_row_height      * as the number of block rows present in the last iMCU row.      */
name|tmp
operator|=
call|(
name|int
call|)
argument_list|(
name|compptr
operator|->
name|height_in_blocks
operator|%
name|compptr
operator|->
name|v_samp_factor
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0
condition|)
name|tmp
operator|=
name|compptr
operator|->
name|v_samp_factor
expr_stmt|;
name|compptr
operator|->
name|last_row_height
operator|=
name|tmp
expr_stmt|;
comment|/* Prepare array describing MCU composition */
name|cinfo
operator|->
name|blocks_in_MCU
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|->
name|MCU_membership
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* Interleaved (multi-component) scan */
if|if
condition|(
name|cinfo
operator|->
name|comps_in_scan
operator|<=
literal|0
operator|||
name|cinfo
operator|->
name|comps_in_scan
operator|>
name|MAX_COMPS_IN_SCAN
condition|)
name|ERREXIT2
argument_list|(
name|cinfo
argument_list|,
name|JERR_COMPONENT_COUNT
argument_list|,
name|cinfo
operator|->
name|comps_in_scan
argument_list|,
name|MAX_COMPS_IN_SCAN
argument_list|)
expr_stmt|;
comment|/* Overall image size in MCUs */
name|cinfo
operator|->
name|MCUs_per_row
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_width
argument_list|,
call|(
name|long
call|)
argument_list|(
name|cinfo
operator|->
name|max_h_samp_factor
operator|*
name|cinfo
operator|->
name|block_size
argument_list|)
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|MCU_rows_in_scan
operator|=
operator|(
name|JDIMENSION
operator|)
name|jdiv_round_up
argument_list|(
operator|(
name|long
operator|)
name|cinfo
operator|->
name|image_height
argument_list|,
call|(
name|long
call|)
argument_list|(
name|cinfo
operator|->
name|max_v_samp_factor
operator|*
name|cinfo
operator|->
name|block_size
argument_list|)
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|blocks_in_MCU
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ci
operator|=
literal|0
init|;
name|ci
operator|<
name|cinfo
operator|->
name|comps_in_scan
condition|;
name|ci
operator|++
control|)
block|{
name|compptr
operator|=
name|cinfo
operator|->
name|cur_comp_info
index|[
name|ci
index|]
expr_stmt|;
comment|/* Sampling factors give # of blocks of component in each MCU */
name|compptr
operator|->
name|MCU_width
operator|=
name|compptr
operator|->
name|h_samp_factor
expr_stmt|;
name|compptr
operator|->
name|MCU_height
operator|=
name|compptr
operator|->
name|v_samp_factor
expr_stmt|;
name|compptr
operator|->
name|MCU_blocks
operator|=
name|compptr
operator|->
name|MCU_width
operator|*
name|compptr
operator|->
name|MCU_height
expr_stmt|;
name|compptr
operator|->
name|MCU_sample_width
operator|=
name|compptr
operator|->
name|MCU_width
operator|*
name|compptr
operator|->
name|DCT_h_scaled_size
expr_stmt|;
comment|/* Figure number of non-dummy blocks in last MCU column& row */
name|tmp
operator|=
call|(
name|int
call|)
argument_list|(
name|compptr
operator|->
name|width_in_blocks
operator|%
name|compptr
operator|->
name|MCU_width
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0
condition|)
name|tmp
operator|=
name|compptr
operator|->
name|MCU_width
expr_stmt|;
name|compptr
operator|->
name|last_col_width
operator|=
name|tmp
expr_stmt|;
name|tmp
operator|=
call|(
name|int
call|)
argument_list|(
name|compptr
operator|->
name|height_in_blocks
operator|%
name|compptr
operator|->
name|MCU_height
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0
condition|)
name|tmp
operator|=
name|compptr
operator|->
name|MCU_height
expr_stmt|;
name|compptr
operator|->
name|last_row_height
operator|=
name|tmp
expr_stmt|;
comment|/* Prepare array describing MCU composition */
name|mcublks
operator|=
name|compptr
operator|->
name|MCU_blocks
expr_stmt|;
if|if
condition|(
name|cinfo
operator|->
name|blocks_in_MCU
operator|+
name|mcublks
operator|>
name|D_MAX_BLOCKS_IN_MCU
condition|)
name|ERREXIT
argument_list|(
name|cinfo
argument_list|,
name|JERR_BAD_MCU_SIZE
argument_list|)
expr_stmt|;
while|while
condition|(
name|mcublks
operator|--
operator|>
literal|0
condition|)
block|{
name|cinfo
operator|->
name|MCU_membership
index|[
name|cinfo
operator|->
name|blocks_in_MCU
operator|++
index|]
operator|=
name|ci
expr_stmt|;
block|}
block|}
block|}
block|}
end_block
begin_comment
comment|/*  * Save away a copy of the Q-table referenced by each component present  * in the current scan, unless already saved during a prior scan.  *  * In a multiple-scan JPEG file, the encoder could assign different components  * the same Q-table slot number, but change table definitions between scans  * so that each component uses a different Q-table.  (The IJG encoder is not  * currently capable of doing this, but other encoders might.)  Since we want  * to be able to dequantize all the components at the end of the file, this  * means that we have to save away the table actually used for each component.  * We do this by copying the table at the start of the first scan containing  * the component.  * The JPEG spec prohibits the encoder from changing the contents of a Q-table  * slot between scans of a component using that slot.  If the encoder does so  * anyway, this decoder will simply use the Q-table values that were current  * at the start of the first scan for the component.  *  * The decompressor output side looks only at the saved quant tables,  * not at the current Q-table slots.  */
end_comment
begin_macro
name|LOCAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|latch_quant_tables
name|latch_quant_tables
argument_list|(
argument|j_decompress_ptr cinfo
argument_list|)
end_macro
begin_block
block|{
name|int
name|ci
decl_stmt|,
name|qtblno
decl_stmt|;
name|jpeg_component_info
modifier|*
name|compptr
decl_stmt|;
name|JQUANT_TBL
modifier|*
name|qtbl
decl_stmt|;
for|for
control|(
name|ci
operator|=
literal|0
init|;
name|ci
operator|<
name|cinfo
operator|->
name|comps_in_scan
condition|;
name|ci
operator|++
control|)
block|{
name|compptr
operator|=
name|cinfo
operator|->
name|cur_comp_info
index|[
name|ci
index|]
expr_stmt|;
comment|/* No work if we already saved Q-table for this component */
if|if
condition|(
name|compptr
operator|->
name|quant_table
operator|!=
name|NULL
condition|)
continue|continue;
comment|/* Make sure specified quantization table is present */
name|qtblno
operator|=
name|compptr
operator|->
name|quant_tbl_no
expr_stmt|;
if|if
condition|(
name|qtblno
operator|<
literal|0
operator|||
name|qtblno
operator|>=
name|NUM_QUANT_TBLS
operator|||
name|cinfo
operator|->
name|quant_tbl_ptrs
index|[
name|qtblno
index|]
operator|==
name|NULL
condition|)
name|ERREXIT1
argument_list|(
name|cinfo
argument_list|,
name|JERR_NO_QUANT_TABLE
argument_list|,
name|qtblno
argument_list|)
expr_stmt|;
comment|/* OK, save away the quantization table */
name|qtbl
operator|=
operator|(
name|JQUANT_TBL
operator|*
operator|)
call|(
modifier|*
name|cinfo
operator|->
name|mem
operator|->
name|alloc_small
call|)
argument_list|(
operator|(
name|j_common_ptr
operator|)
name|cinfo
argument_list|,
name|JPOOL_IMAGE
argument_list|,
name|SIZEOF
argument_list|(
name|JQUANT_TBL
argument_list|)
argument_list|)
expr_stmt|;
name|MEMCOPY
argument_list|(
name|qtbl
argument_list|,
name|cinfo
operator|->
name|quant_tbl_ptrs
index|[
name|qtblno
index|]
argument_list|,
name|SIZEOF
argument_list|(
name|JQUANT_TBL
argument_list|)
argument_list|)
expr_stmt|;
name|compptr
operator|->
name|quant_table
operator|=
name|qtbl
expr_stmt|;
block|}
block|}
end_block
begin_comment
comment|/*  * Initialize the input modules to read a scan of compressed data.  * The first call to this is done by jdmaster.c after initializing  * the entire decompressor (during jpeg_start_decompress).  * Subsequent calls come from consume_markers, below.  */
end_comment
begin_macro
name|METHODDEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|start_input_pass
name|start_input_pass
argument_list|(
argument|j_decompress_ptr cinfo
argument_list|)
end_macro
begin_block
block|{
name|per_scan_setup
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
name|latch_quant_tables
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
call|(
modifier|*
name|cinfo
operator|->
name|entropy
operator|->
name|start_pass
call|)
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
call|(
modifier|*
name|cinfo
operator|->
name|coef
operator|->
name|start_input_pass
call|)
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|inputctl
operator|->
name|consume_input
operator|=
name|cinfo
operator|->
name|coef
operator|->
name|consume_data
expr_stmt|;
block|}
end_block
begin_comment
comment|/*  * Finish up after inputting a compressed-data scan.  * This is called by the coefficient controller after it's read all  * the expected data of the scan.  */
end_comment
begin_macro
name|METHODDEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|finish_input_pass
name|finish_input_pass
argument_list|(
argument|j_decompress_ptr cinfo
argument_list|)
end_macro
begin_block
block|{
name|cinfo
operator|->
name|inputctl
operator|->
name|consume_input
operator|=
name|consume_markers
expr_stmt|;
block|}
end_block
begin_comment
comment|/*  * Read JPEG markers before, between, or after compressed-data scans.  * Change state as necessary when a new scan is reached.  * Return value is JPEG_SUSPENDED, JPEG_REACHED_SOS, or JPEG_REACHED_EOI.  *  * The consume_input method pointer points either here or to the  * coefficient controller's consume_data routine, depending on whether  * we are reading a compressed data segment or inter-segment markers.  *  * Note: This function should NOT return a pseudo SOS marker (with zero  * component number) to the caller.  A pseudo marker received by  * read_markers is processed and then skipped for other markers.  */
end_comment
begin_macro
name|METHODDEF
argument_list|(
argument|int
argument_list|)
end_macro
begin_macro
DECL|function|consume_markers
name|consume_markers
argument_list|(
argument|j_decompress_ptr cinfo
argument_list|)
end_macro
begin_block
block|{
name|my_inputctl_ptr
name|inputctl
init|=
operator|(
name|my_inputctl_ptr
operator|)
name|cinfo
operator|->
name|inputctl
decl_stmt|;
name|int
name|val
decl_stmt|;
if|if
condition|(
name|inputctl
operator|->
name|pub
operator|.
name|eoi_reached
condition|)
comment|/* After hitting EOI, read no further */
return|return
name|JPEG_REACHED_EOI
return|;
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* Loop to pass pseudo SOS marker */
name|val
operator|=
call|(
modifier|*
name|cinfo
operator|->
name|marker
operator|->
name|read_markers
call|)
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|val
condition|)
block|{
case|case
name|JPEG_REACHED_SOS
case|:
comment|/* Found SOS */
if|if
condition|(
name|inputctl
operator|->
name|inheaders
condition|)
block|{
comment|/* 1st SOS */
if|if
condition|(
name|inputctl
operator|->
name|inheaders
operator|==
literal|1
condition|)
name|initial_setup
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|cinfo
operator|->
name|comps_in_scan
operator|==
literal|0
condition|)
block|{
comment|/* pseudo SOS marker */
name|inputctl
operator|->
name|inheaders
operator|=
literal|2
expr_stmt|;
break|break;
block|}
name|inputctl
operator|->
name|inheaders
operator|=
literal|0
expr_stmt|;
comment|/* Note: start_input_pass must be called by jdmaster.c 	 * before any more input can be consumed.  jdapimin.c is 	 * responsible for enforcing this sequencing. 	 */
block|}
else|else
block|{
comment|/* 2nd or later SOS marker */
if|if
condition|(
operator|!
name|inputctl
operator|->
name|pub
operator|.
name|has_multiple_scans
condition|)
name|ERREXIT
argument_list|(
name|cinfo
argument_list|,
name|JERR_EOI_EXPECTED
argument_list|)
expr_stmt|;
comment|/* Oops, I wasn't expecting this! */
if|if
condition|(
name|cinfo
operator|->
name|comps_in_scan
operator|==
literal|0
condition|)
comment|/* unexpected pseudo SOS marker */
break|break;
name|start_input_pass
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
block|}
return|return
name|val
return|;
case|case
name|JPEG_REACHED_EOI
case|:
comment|/* Found EOI */
name|inputctl
operator|->
name|pub
operator|.
name|eoi_reached
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|inputctl
operator|->
name|inheaders
condition|)
block|{
comment|/* Tables-only datastream, apparently */
if|if
condition|(
name|cinfo
operator|->
name|marker
operator|->
name|saw_SOF
condition|)
name|ERREXIT
argument_list|(
name|cinfo
argument_list|,
name|JERR_SOF_NO_SOS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Prevent infinite loop in coef ctlr's decompress_data routine 	 * if user set output_scan_number larger than number of scans. 	 */
if|if
condition|(
name|cinfo
operator|->
name|output_scan_number
operator|>
name|cinfo
operator|->
name|input_scan_number
condition|)
name|cinfo
operator|->
name|output_scan_number
operator|=
name|cinfo
operator|->
name|input_scan_number
expr_stmt|;
block|}
return|return
name|val
return|;
case|case
name|JPEG_SUSPENDED
case|:
return|return
name|val
return|;
default|default:
return|return
name|val
return|;
block|}
block|}
block|}
end_block
begin_comment
comment|/*  * Reset state to begin a fresh datastream.  */
end_comment
begin_macro
name|METHODDEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|reset_input_controller
name|reset_input_controller
argument_list|(
argument|j_decompress_ptr cinfo
argument_list|)
end_macro
begin_block
block|{
name|my_inputctl_ptr
name|inputctl
init|=
operator|(
name|my_inputctl_ptr
operator|)
name|cinfo
operator|->
name|inputctl
decl_stmt|;
name|inputctl
operator|->
name|pub
operator|.
name|consume_input
operator|=
name|consume_markers
expr_stmt|;
name|inputctl
operator|->
name|pub
operator|.
name|has_multiple_scans
operator|=
name|FALSE
expr_stmt|;
comment|/* "unknown" would be better */
name|inputctl
operator|->
name|pub
operator|.
name|eoi_reached
operator|=
name|FALSE
expr_stmt|;
name|inputctl
operator|->
name|inheaders
operator|=
literal|1
expr_stmt|;
comment|/* Reset other modules */
call|(
modifier|*
name|cinfo
operator|->
name|err
operator|->
name|reset_error_mgr
call|)
argument_list|(
operator|(
name|j_common_ptr
operator|)
name|cinfo
argument_list|)
expr_stmt|;
call|(
modifier|*
name|cinfo
operator|->
name|marker
operator|->
name|reset_marker_reader
call|)
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
comment|/* Reset progression state -- would be cleaner if entropy decoder did this */
name|cinfo
operator|->
name|coef_bits
operator|=
name|NULL
expr_stmt|;
block|}
end_block
begin_comment
comment|/*  * Initialize the input controller module.  * This is called only once, when the decompression object is created.  */
end_comment
begin_macro
name|GLOBAL
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|jinit_input_controller
name|jinit_input_controller
argument_list|(
argument|j_decompress_ptr cinfo
argument_list|)
end_macro
begin_block
block|{
name|my_inputctl_ptr
name|inputctl
decl_stmt|;
comment|/* Create subobject in permanent pool */
name|inputctl
operator|=
call|(
name|my_inputctl_ptr
call|)
argument_list|(
operator|*
name|cinfo
operator|->
name|mem
operator|->
name|alloc_small
argument_list|)
argument_list|(
operator|(
name|j_common_ptr
operator|)
name|cinfo
argument_list|,
name|JPOOL_PERMANENT
argument_list|,
name|SIZEOF
argument_list|(
name|my_input_controller
argument_list|)
argument_list|)
expr_stmt|;
name|cinfo
operator|->
name|inputctl
operator|=
operator|(
expr|struct
name|jpeg_input_controller
operator|*
operator|)
name|inputctl
expr_stmt|;
comment|/* Initialize method pointers */
name|inputctl
operator|->
name|pub
operator|.
name|consume_input
operator|=
name|consume_markers
expr_stmt|;
name|inputctl
operator|->
name|pub
operator|.
name|reset_input_controller
operator|=
name|reset_input_controller
expr_stmt|;
name|inputctl
operator|->
name|pub
operator|.
name|start_input_pass
operator|=
name|start_input_pass
expr_stmt|;
name|inputctl
operator|->
name|pub
operator|.
name|finish_input_pass
operator|=
name|finish_input_pass
expr_stmt|;
comment|/* Initialize state: can't use reset_input_controller since we don't    * want to try to reset other modules yet.    */
name|inputctl
operator|->
name|pub
operator|.
name|has_multiple_scans
operator|=
name|FALSE
expr_stmt|;
comment|/* "unknown" would be better */
name|inputctl
operator|->
name|pub
operator|.
name|eoi_reached
operator|=
name|FALSE
expr_stmt|;
name|inputctl
operator|->
name|inheaders
operator|=
literal|1
expr_stmt|;
block|}
end_block
end_unit
