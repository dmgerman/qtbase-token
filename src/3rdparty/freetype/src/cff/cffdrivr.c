begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  cffdrivr.c                                                             */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    OpenType font driver implementation (body).                          */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 1996-2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009 by */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_FREETYPE_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_DEBUG_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_STREAM_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_SFNT_H
end_include
begin_include
include|#
directive|include
include|FT_TRUETYPE_IDS_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_CID_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_POSTSCRIPT_CMAPS_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_POSTSCRIPT_INFO_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_POSTSCRIPT_NAME_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_TT_CMAP_H
end_include
begin_include
include|#
directive|include
file|"cffdrivr.h"
end_include
begin_include
include|#
directive|include
file|"cffgload.h"
end_include
begin_include
include|#
directive|include
file|"cffload.h"
end_include
begin_include
include|#
directive|include
file|"cffcmap.h"
end_include
begin_include
include|#
directive|include
file|"cfferrs.h"
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_XFREE86_NAME_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_GLYPH_DICT_H
end_include
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */
end_comment
begin_comment
comment|/* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */
end_comment
begin_comment
comment|/* messages during execution.                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_undef
DECL|macro|FT_COMPONENT
undef|#
directive|undef
name|FT_COMPONENT
end_undef
begin_define
DECL|macro|FT_COMPONENT
define|#
directive|define
name|FT_COMPONENT
value|trace_cffdriver
end_define
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/****                                                                 ****/
end_comment
begin_comment
comment|/****                                                                 ****/
end_comment
begin_comment
comment|/****                          F A C E S                              ****/
end_comment
begin_comment
comment|/****                                                                 ****/
end_comment
begin_comment
comment|/****                                                                 ****/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_undef
DECL|macro|PAIR_TAG
undef|#
directive|undef
name|PAIR_TAG
end_undef
begin_define
DECL|macro|PAIR_TAG
define|#
directive|define
name|PAIR_TAG
parameter_list|(
name|left
parameter_list|,
name|right
parameter_list|)
value|( ( (FT_ULong)left<< 16 ) | \                                      (FT_ULong)right        )
end_define
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    cff_get_kerning                                                    */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    A driver method used to return the kerning vector between two      */
end_comment
begin_comment
comment|/*    glyphs of the same face.                                           */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face        :: A handle to the source face object.                 */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    left_glyph  :: The index of the left glyph in the kern pair.       */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    right_glyph :: The index of the right glyph in the kern pair.      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Output>                                                              */
end_comment
begin_comment
comment|/*    kerning     :: The kerning vector.  This is in font units for      */
end_comment
begin_comment
comment|/*                   scalable formats, and in pixels for fixed-sizes     */
end_comment
begin_comment
comment|/*                   formats.                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Note>                                                                */
end_comment
begin_comment
comment|/*    Only horizontal layouts (left-to-right& right-to-left) are        */
end_comment
begin_comment
comment|/*    supported by this function.  Other layouts, or more sophisticated  */
end_comment
begin_comment
comment|/*    kernings, are out of scope of this method (the basic driver        */
end_comment
begin_comment
comment|/*    interface is meant to be simple).                                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    They can be implemented by format-specific interfaces.             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|cff_get_kerning
argument_list|(
argument|FT_Face     ttface
argument_list|,
comment|/* TT_Face */
argument|FT_UInt     left_glyph
argument_list|,
argument|FT_UInt     right_glyph
argument_list|,
argument|FT_Vector*  kerning
argument_list|)
end_macro
begin_block
block|{
name|TT_Face
name|face
init|=
operator|(
name|TT_Face
operator|)
name|ttface
decl_stmt|;
name|SFNT_Service
name|sfnt
init|=
operator|(
name|SFNT_Service
operator|)
name|face
operator|->
name|sfnt
decl_stmt|;
name|kerning
operator|->
name|x
operator|=
literal|0
expr_stmt|;
name|kerning
operator|->
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sfnt
condition|)
name|kerning
operator|->
name|x
operator|=
name|sfnt
operator|->
name|get_kerning
argument_list|(
name|face
argument_list|,
name|left_glyph
argument_list|,
name|right_glyph
argument_list|)
expr_stmt|;
return|return
name|CFF_Err_Ok
return|;
block|}
end_block
begin_undef
DECL|macro|PAIR_TAG
undef|#
directive|undef
name|PAIR_TAG
end_undef
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    Load_Glyph                                                         */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    A driver method used to load a glyph within a given glyph slot.    */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    slot        :: A handle to the target slot object where the glyph  */
end_comment
begin_comment
comment|/*                   will be loaded.                                     */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    size        :: A handle to the source face size at which the glyph */
end_comment
begin_comment
comment|/*                   must be scaled, loaded, etc.                        */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    glyph_index :: The index of the glyph in the font file.            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    load_flags  :: A flag indicating what to load for this glyph.  The */
end_comment
begin_comment
comment|/*                   FT_LOAD_??? constants can be used to control the    */
end_comment
begin_comment
comment|/*                   glyph loading process (e.g., whether the outline    */
end_comment
begin_comment
comment|/*                   should be scaled, whether to load bitmaps or not,   */
end_comment
begin_comment
comment|/*                   whether to hint the outline, etc).                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|Load_Glyph
argument_list|(
argument|FT_GlyphSlot  cffslot
argument_list|,
comment|/* CFF_GlyphSlot */
argument|FT_Size       cffsize
argument_list|,
comment|/* CFF_Size      */
argument|FT_UInt       glyph_index
argument_list|,
argument|FT_Int32      load_flags
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|CFF_GlyphSlot
name|slot
init|=
operator|(
name|CFF_GlyphSlot
operator|)
name|cffslot
decl_stmt|;
name|CFF_Size
name|size
init|=
operator|(
name|CFF_Size
operator|)
name|cffsize
decl_stmt|;
if|if
condition|(
operator|!
name|slot
condition|)
return|return
name|CFF_Err_Invalid_Slot_Handle
return|;
comment|/* check whether we want a scaled outline or bitmap */
if|if
condition|(
operator|!
name|size
condition|)
name|load_flags
operator||=
name|FT_LOAD_NO_SCALE
operator||
name|FT_LOAD_NO_HINTING
expr_stmt|;
comment|/* reset the size object if necessary */
if|if
condition|(
name|load_flags
operator|&
name|FT_LOAD_NO_SCALE
condition|)
name|size
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|size
condition|)
block|{
comment|/* these two objects must have the same parent */
if|if
condition|(
name|cffsize
operator|->
name|face
operator|!=
name|cffslot
operator|->
name|face
condition|)
return|return
name|CFF_Err_Invalid_Face_Handle
return|;
block|}
comment|/* now load the glyph outline if necessary */
name|error
operator|=
name|cff_slot_load
argument_list|(
name|slot
argument_list|,
name|size
argument_list|,
name|glyph_index
argument_list|,
name|load_flags
argument_list|)
expr_stmt|;
comment|/* force drop-out mode to 2 - irrelevant now */
comment|/* slot->outline.dropout_mode = 2; */
return|return
name|error
return|;
block|}
end_block
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|cff_get_advances
argument_list|(
argument|FT_Face    face
argument_list|,
argument|FT_UInt    start
argument_list|,
argument|FT_UInt    count
argument_list|,
argument|FT_Int32   flags
argument_list|,
argument|FT_Fixed*  advances
argument_list|)
end_macro
begin_block
block|{
name|FT_UInt
name|nn
decl_stmt|;
name|FT_Error
name|error
init|=
name|CFF_Err_Ok
decl_stmt|;
name|FT_GlyphSlot
name|slot
init|=
name|face
operator|->
name|glyph
decl_stmt|;
name|flags
operator||=
name|FT_LOAD_ADVANCE_ONLY
expr_stmt|;
for|for
control|(
name|nn
operator|=
literal|0
init|;
name|nn
operator|<
name|count
condition|;
name|nn
operator|++
control|)
block|{
name|error
operator|=
name|Load_Glyph
argument_list|(
name|slot
argument_list|,
name|face
operator|->
name|size
argument_list|,
name|start
operator|+
name|nn
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|advances
index|[
name|nn
index|]
operator|=
operator|(
name|flags
operator|&
name|FT_LOAD_VERTICAL_LAYOUT
operator|)
condition|?
name|slot
operator|->
name|linearVertAdvance
else|:
name|slot
operator|->
name|linearHoriAdvance
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*    *  GLYPH DICT SERVICE    *    */
end_comment
begin_function
specifier|static
name|FT_Error
DECL|function|cff_get_glyph_name
name|cff_get_glyph_name
parameter_list|(
name|CFF_Face
name|face
parameter_list|,
name|FT_UInt
name|glyph_index
parameter_list|,
name|FT_Pointer
name|buffer
parameter_list|,
name|FT_UInt
name|buffer_max
parameter_list|)
block|{
name|CFF_Font
name|font
init|=
operator|(
name|CFF_Font
operator|)
name|face
operator|->
name|extra
operator|.
name|data
decl_stmt|;
name|FT_Memory
name|memory
init|=
name|FT_FACE_MEMORY
argument_list|(
name|face
argument_list|)
decl_stmt|;
name|FT_String
modifier|*
name|gname
decl_stmt|;
name|FT_UShort
name|sid
decl_stmt|;
name|FT_Service_PsCMaps
name|psnames
decl_stmt|;
name|FT_Error
name|error
decl_stmt|;
name|FT_FACE_FIND_GLOBAL_SERVICE
argument_list|(
name|face
argument_list|,
name|psnames
argument_list|,
name|POSTSCRIPT_CMAPS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|psnames
condition|)
block|{
name|FT_ERROR
argument_list|(
operator|(
literal|"cff_get_glyph_name:"
operator|)
argument_list|)
expr_stmt|;
name|FT_ERROR
argument_list|(
operator|(
literal|" cannot get glyph name from CFF& CEF fonts\n"
operator|)
argument_list|)
expr_stmt|;
name|FT_ERROR
argument_list|(
operator|(
literal|"                   "
operator|)
argument_list|)
expr_stmt|;
name|FT_ERROR
argument_list|(
operator|(
literal|" without the `PSNames' module\n"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|CFF_Err_Unknown_File_Format
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* first, locate the sid in the charset table */
name|sid
operator|=
name|font
operator|->
name|charset
operator|.
name|sids
index|[
name|glyph_index
index|]
expr_stmt|;
comment|/* now, lookup the name itself */
name|gname
operator|=
name|cff_index_get_sid_string
argument_list|(
operator|&
name|font
operator|->
name|string_index
argument_list|,
name|sid
argument_list|,
name|psnames
argument_list|)
expr_stmt|;
if|if
condition|(
name|gname
condition|)
name|FT_STRCPYN
argument_list|(
name|buffer
argument_list|,
name|gname
argument_list|,
name|buffer_max
argument_list|)
expr_stmt|;
name|FT_FREE
argument_list|(
name|gname
argument_list|)
expr_stmt|;
name|error
operator|=
name|CFF_Err_Ok
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_function
begin_function
specifier|static
name|FT_UInt
DECL|function|cff_get_name_index
name|cff_get_name_index
parameter_list|(
name|CFF_Face
name|face
parameter_list|,
name|FT_String
modifier|*
name|glyph_name
parameter_list|)
block|{
name|CFF_Font
name|cff
decl_stmt|;
name|CFF_Charset
name|charset
decl_stmt|;
name|FT_Service_PsCMaps
name|psnames
decl_stmt|;
name|FT_Memory
name|memory
init|=
name|FT_FACE_MEMORY
argument_list|(
name|face
argument_list|)
decl_stmt|;
name|FT_String
modifier|*
name|name
decl_stmt|;
name|FT_UShort
name|sid
decl_stmt|;
name|FT_UInt
name|i
decl_stmt|;
name|FT_Int
name|result
decl_stmt|;
name|cff
operator|=
operator|(
name|CFF_FontRec
operator|*
operator|)
name|face
operator|->
name|extra
operator|.
name|data
expr_stmt|;
name|charset
operator|=
operator|&
name|cff
operator|->
name|charset
expr_stmt|;
name|FT_FACE_FIND_GLOBAL_SERVICE
argument_list|(
name|face
argument_list|,
name|psnames
argument_list|,
name|POSTSCRIPT_CMAPS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|psnames
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cff
operator|->
name|num_glyphs
condition|;
name|i
operator|++
control|)
block|{
name|sid
operator|=
name|charset
operator|->
name|sids
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|sid
operator|>
literal|390
condition|)
name|name
operator|=
name|cff_index_get_name
argument_list|(
operator|&
name|cff
operator|->
name|string_index
argument_list|,
name|sid
operator|-
literal|391
argument_list|)
expr_stmt|;
else|else
name|name
operator|=
operator|(
name|FT_String
operator|*
operator|)
name|psnames
operator|->
name|adobe_std_strings
argument_list|(
name|sid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|name
condition|)
continue|continue;
name|result
operator|=
name|ft_strcmp
argument_list|(
name|glyph_name
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|sid
operator|>
literal|390
condition|)
name|FT_FREE
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
return|return
name|i
return|;
block|}
return|return
literal|0
return|;
block|}
end_function
begin_decl_stmt
DECL|variable|cff_service_glyph_dict
specifier|static
specifier|const
name|FT_Service_GlyphDictRec
name|cff_service_glyph_dict
init|=
block|{
operator|(
name|FT_GlyphDict_GetNameFunc
operator|)
name|cff_get_glyph_name
block|,
operator|(
name|FT_GlyphDict_NameIndexFunc
operator|)
name|cff_get_name_index
block|,   }
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*    *  POSTSCRIPT INFO SERVICE    *    */
end_comment
begin_function
specifier|static
name|FT_Int
DECL|function|cff_ps_has_glyph_names
name|cff_ps_has_glyph_names
parameter_list|(
name|FT_Face
name|face
parameter_list|)
block|{
return|return
operator|(
name|face
operator|->
name|face_flags
operator|&
name|FT_FACE_FLAG_GLYPH_NAMES
operator|)
operator|>
literal|0
return|;
block|}
end_function
begin_function
specifier|static
name|FT_Error
DECL|function|cff_ps_get_font_info
name|cff_ps_get_font_info
parameter_list|(
name|CFF_Face
name|face
parameter_list|,
name|PS_FontInfoRec
modifier|*
name|afont_info
parameter_list|)
block|{
name|CFF_Font
name|cff
init|=
operator|(
name|CFF_Font
operator|)
name|face
operator|->
name|extra
operator|.
name|data
decl_stmt|;
name|FT_Error
name|error
init|=
name|FT_Err_Ok
decl_stmt|;
if|if
condition|(
name|cff
operator|&&
name|cff
operator|->
name|font_info
operator|==
name|NULL
condition|)
block|{
name|CFF_FontRecDict
name|dict
init|=
operator|&
name|cff
operator|->
name|top_font
operator|.
name|font_dict
decl_stmt|;
name|PS_FontInfoRec
modifier|*
name|font_info
decl_stmt|;
name|FT_Memory
name|memory
init|=
name|face
operator|->
name|root
operator|.
name|memory
decl_stmt|;
name|FT_Service_PsCMaps
name|psnames
init|=
operator|(
name|FT_Service_PsCMaps
operator|)
name|cff
operator|->
name|psnames
decl_stmt|;
if|if
condition|(
name|FT_ALLOC
argument_list|(
name|font_info
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|font_info
argument_list|)
argument_list|)
condition|)
goto|goto
name|Fail
goto|;
name|font_info
operator|->
name|version
operator|=
name|cff_index_get_sid_string
argument_list|(
operator|&
name|cff
operator|->
name|string_index
argument_list|,
name|dict
operator|->
name|version
argument_list|,
name|psnames
argument_list|)
expr_stmt|;
name|font_info
operator|->
name|notice
operator|=
name|cff_index_get_sid_string
argument_list|(
operator|&
name|cff
operator|->
name|string_index
argument_list|,
name|dict
operator|->
name|notice
argument_list|,
name|psnames
argument_list|)
expr_stmt|;
name|font_info
operator|->
name|full_name
operator|=
name|cff_index_get_sid_string
argument_list|(
operator|&
name|cff
operator|->
name|string_index
argument_list|,
name|dict
operator|->
name|full_name
argument_list|,
name|psnames
argument_list|)
expr_stmt|;
name|font_info
operator|->
name|family_name
operator|=
name|cff_index_get_sid_string
argument_list|(
operator|&
name|cff
operator|->
name|string_index
argument_list|,
name|dict
operator|->
name|family_name
argument_list|,
name|psnames
argument_list|)
expr_stmt|;
name|font_info
operator|->
name|weight
operator|=
name|cff_index_get_sid_string
argument_list|(
operator|&
name|cff
operator|->
name|string_index
argument_list|,
name|dict
operator|->
name|weight
argument_list|,
name|psnames
argument_list|)
expr_stmt|;
name|font_info
operator|->
name|italic_angle
operator|=
name|dict
operator|->
name|italic_angle
expr_stmt|;
name|font_info
operator|->
name|is_fixed_pitch
operator|=
name|dict
operator|->
name|is_fixed_pitch
expr_stmt|;
name|font_info
operator|->
name|underline_position
operator|=
operator|(
name|FT_Short
operator|)
name|dict
operator|->
name|underline_position
expr_stmt|;
name|font_info
operator|->
name|underline_thickness
operator|=
operator|(
name|FT_Short
operator|)
name|dict
operator|->
name|underline_thickness
expr_stmt|;
name|cff
operator|->
name|font_info
operator|=
name|font_info
expr_stmt|;
block|}
if|if
condition|(
name|cff
condition|)
operator|*
name|afont_info
operator|=
operator|*
name|cff
operator|->
name|font_info
expr_stmt|;
name|Fail
label|:
return|return
name|error
return|;
block|}
end_function
begin_decl_stmt
DECL|variable|cff_service_ps_info
specifier|static
specifier|const
name|FT_Service_PsInfoRec
name|cff_service_ps_info
init|=
block|{
operator|(
name|PS_GetFontInfoFunc
operator|)
name|cff_ps_get_font_info
block|,
operator|(
name|PS_GetFontExtraFunc
operator|)
name|NULL
block|,
operator|(
name|PS_HasGlyphNamesFunc
operator|)
name|cff_ps_has_glyph_names
block|,
operator|(
name|PS_GetFontPrivateFunc
operator|)
name|NULL
comment|/* unsupported with CFF fonts */
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*    *  POSTSCRIPT NAME SERVICE    *    */
end_comment
begin_function
specifier|static
specifier|const
name|char
modifier|*
DECL|function|cff_get_ps_name
name|cff_get_ps_name
parameter_list|(
name|CFF_Face
name|face
parameter_list|)
block|{
name|CFF_Font
name|cff
init|=
operator|(
name|CFF_Font
operator|)
name|face
operator|->
name|extra
operator|.
name|data
decl_stmt|;
return|return
operator|(
specifier|const
name|char
operator|*
operator|)
name|cff
operator|->
name|font_name
return|;
block|}
end_function
begin_decl_stmt
DECL|variable|cff_service_ps_name
specifier|static
specifier|const
name|FT_Service_PsFontNameRec
name|cff_service_ps_name
init|=
block|{
operator|(
name|FT_PsName_GetFunc
operator|)
name|cff_get_ps_name
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*    * TT CMAP INFO    *    * If the charmap is a synthetic Unicode encoding cmap or    * a Type 1 standard (or expert) encoding cmap, hide TT CMAP INFO    * service defined in SFNT module.    *    * Otherwise call the service function in the sfnt module.    *    */
end_comment
begin_function
specifier|static
name|FT_Error
DECL|function|cff_get_cmap_info
name|cff_get_cmap_info
parameter_list|(
name|FT_CharMap
name|charmap
parameter_list|,
name|TT_CMapInfo
modifier|*
name|cmap_info
parameter_list|)
block|{
name|FT_CMap
name|cmap
init|=
name|FT_CMAP
argument_list|(
name|charmap
argument_list|)
decl_stmt|;
name|FT_Error
name|error
init|=
name|CFF_Err_Ok
decl_stmt|;
name|cmap_info
operator|->
name|language
operator|=
literal|0
expr_stmt|;
name|cmap_info
operator|->
name|format
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cmap
operator|->
name|clazz
operator|!=
operator|&
name|cff_cmap_encoding_class_rec
operator|&&
name|cmap
operator|->
name|clazz
operator|!=
operator|&
name|cff_cmap_unicode_class_rec
condition|)
block|{
name|FT_Face
name|face
init|=
name|FT_CMAP_FACE
argument_list|(
name|cmap
argument_list|)
decl_stmt|;
name|FT_Library
name|library
init|=
name|FT_FACE_LIBRARY
argument_list|(
name|face
argument_list|)
decl_stmt|;
name|FT_Module
name|sfnt
init|=
name|FT_Get_Module
argument_list|(
name|library
argument_list|,
literal|"sfnt"
argument_list|)
decl_stmt|;
name|FT_Service_TTCMaps
name|service
init|=
operator|(
name|FT_Service_TTCMaps
operator|)
name|ft_module_get_service
argument_list|(
name|sfnt
argument_list|,
name|FT_SERVICE_ID_TT_CMAP
argument_list|)
decl_stmt|;
if|if
condition|(
name|service
operator|&&
name|service
operator|->
name|get_cmap_info
condition|)
name|error
operator|=
name|service
operator|->
name|get_cmap_info
argument_list|(
name|charmap
argument_list|,
name|cmap_info
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function
begin_decl_stmt
DECL|variable|cff_service_get_cmap_info
specifier|static
specifier|const
name|FT_Service_TTCMapsRec
name|cff_service_get_cmap_info
init|=
block|{
operator|(
name|TT_CMap_Info_GetFunc
operator|)
name|cff_get_cmap_info
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*    *  CID INFO SERVICE    *    */
end_comment
begin_function
specifier|static
name|FT_Error
DECL|function|cff_get_ros
name|cff_get_ros
parameter_list|(
name|CFF_Face
name|face
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|registry
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|ordering
parameter_list|,
name|FT_Int
modifier|*
name|supplement
parameter_list|)
block|{
name|FT_Error
name|error
init|=
name|CFF_Err_Ok
decl_stmt|;
name|CFF_Font
name|cff
init|=
operator|(
name|CFF_Font
operator|)
name|face
operator|->
name|extra
operator|.
name|data
decl_stmt|;
if|if
condition|(
name|cff
condition|)
block|{
name|CFF_FontRecDict
name|dict
init|=
operator|&
name|cff
operator|->
name|top_font
operator|.
name|font_dict
decl_stmt|;
name|FT_Service_PsCMaps
name|psnames
init|=
operator|(
name|FT_Service_PsCMaps
operator|)
name|cff
operator|->
name|psnames
decl_stmt|;
if|if
condition|(
name|dict
operator|->
name|cid_registry
operator|==
literal|0xFFFFU
condition|)
block|{
name|error
operator|=
name|CFF_Err_Invalid_Argument
expr_stmt|;
goto|goto
name|Fail
goto|;
block|}
if|if
condition|(
name|registry
condition|)
block|{
if|if
condition|(
name|cff
operator|->
name|registry
operator|==
name|NULL
condition|)
name|cff
operator|->
name|registry
operator|=
name|cff_index_get_sid_string
argument_list|(
operator|&
name|cff
operator|->
name|string_index
argument_list|,
name|dict
operator|->
name|cid_registry
argument_list|,
name|psnames
argument_list|)
expr_stmt|;
operator|*
name|registry
operator|=
name|cff
operator|->
name|registry
expr_stmt|;
block|}
if|if
condition|(
name|ordering
condition|)
block|{
if|if
condition|(
name|cff
operator|->
name|ordering
operator|==
name|NULL
condition|)
name|cff
operator|->
name|ordering
operator|=
name|cff_index_get_sid_string
argument_list|(
operator|&
name|cff
operator|->
name|string_index
argument_list|,
name|dict
operator|->
name|cid_ordering
argument_list|,
name|psnames
argument_list|)
expr_stmt|;
operator|*
name|ordering
operator|=
name|cff
operator|->
name|ordering
expr_stmt|;
block|}
if|if
condition|(
name|supplement
condition|)
operator|*
name|supplement
operator|=
name|dict
operator|->
name|cid_supplement
expr_stmt|;
block|}
name|Fail
label|:
return|return
name|error
return|;
block|}
end_function
begin_function
specifier|static
name|FT_Error
DECL|function|cff_get_is_cid
name|cff_get_is_cid
parameter_list|(
name|CFF_Face
name|face
parameter_list|,
name|FT_Bool
modifier|*
name|is_cid
parameter_list|)
block|{
name|FT_Error
name|error
init|=
name|CFF_Err_Ok
decl_stmt|;
name|CFF_Font
name|cff
init|=
operator|(
name|CFF_Font
operator|)
name|face
operator|->
name|extra
operator|.
name|data
decl_stmt|;
operator|*
name|is_cid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cff
condition|)
block|{
name|CFF_FontRecDict
name|dict
init|=
operator|&
name|cff
operator|->
name|top_font
operator|.
name|font_dict
decl_stmt|;
if|if
condition|(
name|dict
operator|->
name|cid_registry
operator|!=
literal|0xFFFFU
condition|)
operator|*
name|is_cid
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function
begin_function
specifier|static
name|FT_Error
DECL|function|cff_get_cid_from_glyph_index
name|cff_get_cid_from_glyph_index
parameter_list|(
name|CFF_Face
name|face
parameter_list|,
name|FT_UInt
name|glyph_index
parameter_list|,
name|FT_UInt
modifier|*
name|cid
parameter_list|)
block|{
name|FT_Error
name|error
init|=
name|CFF_Err_Ok
decl_stmt|;
name|CFF_Font
name|cff
decl_stmt|;
name|cff
operator|=
operator|(
name|CFF_Font
operator|)
name|face
operator|->
name|extra
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|cff
condition|)
block|{
name|FT_UInt
name|c
decl_stmt|;
name|CFF_FontRecDict
name|dict
init|=
operator|&
name|cff
operator|->
name|top_font
operator|.
name|font_dict
decl_stmt|;
if|if
condition|(
name|dict
operator|->
name|cid_registry
operator|==
literal|0xFFFFU
condition|)
block|{
name|error
operator|=
name|CFF_Err_Invalid_Argument
expr_stmt|;
goto|goto
name|Fail
goto|;
block|}
if|if
condition|(
name|glyph_index
operator|>
name|cff
operator|->
name|num_glyphs
condition|)
block|{
name|error
operator|=
name|CFF_Err_Invalid_Argument
expr_stmt|;
goto|goto
name|Fail
goto|;
block|}
name|c
operator|=
name|cff
operator|->
name|charset
operator|.
name|sids
index|[
name|glyph_index
index|]
expr_stmt|;
if|if
condition|(
name|cid
condition|)
operator|*
name|cid
operator|=
name|c
expr_stmt|;
block|}
name|Fail
label|:
return|return
name|error
return|;
block|}
end_function
begin_decl_stmt
DECL|variable|cff_service_cid_info
specifier|static
specifier|const
name|FT_Service_CIDRec
name|cff_service_cid_info
init|=
block|{
operator|(
name|FT_CID_GetRegistryOrderingSupplementFunc
operator|)
name|cff_get_ros
block|,
operator|(
name|FT_CID_GetIsInternallyCIDKeyedFunc
operator|)
name|cff_get_is_cid
block|,
operator|(
name|FT_CID_GetCIDFromGlyphIndexFunc
operator|)
name|cff_get_cid_from_glyph_index
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/****                                                                 ****/
end_comment
begin_comment
comment|/****                                                                 ****/
end_comment
begin_comment
comment|/****                D R I V E R  I N T E R F A C E                   ****/
end_comment
begin_comment
comment|/****                                                                 ****/
end_comment
begin_comment
comment|/****                                                                 ****/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_decl_stmt
DECL|variable|cff_services
specifier|static
specifier|const
name|FT_ServiceDescRec
name|cff_services
index|[]
init|=
block|{
block|{
name|FT_SERVICE_ID_XF86_NAME
block|,
name|FT_XF86_FORMAT_CFF
block|}
block|,
block|{
name|FT_SERVICE_ID_POSTSCRIPT_INFO
block|,
operator|&
name|cff_service_ps_info
block|}
block|,
block|{
name|FT_SERVICE_ID_POSTSCRIPT_FONT_NAME
block|,
operator|&
name|cff_service_ps_name
block|}
block|,
ifndef|#
directive|ifndef
name|FT_CONFIG_OPTION_NO_GLYPH_NAMES
block|{
name|FT_SERVICE_ID_GLYPH_DICT
block|,
operator|&
name|cff_service_glyph_dict
block|}
block|,
endif|#
directive|endif
block|{
name|FT_SERVICE_ID_TT_CMAP
block|,
operator|&
name|cff_service_get_cmap_info
block|}
block|,
block|{
name|FT_SERVICE_ID_CID
block|,
operator|&
name|cff_service_cid_info
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Module_Interface
argument_list|)
end_macro
begin_macro
name|cff_get_interface
argument_list|(
argument|FT_Module    driver
argument_list|,
comment|/* CFF_Driver */
argument|const char*  module_interface
argument_list|)
end_macro
begin_block
block|{
name|FT_Module
name|sfnt
decl_stmt|;
name|FT_Module_Interface
name|result
decl_stmt|;
name|result
operator|=
name|ft_service_list_lookup
argument_list|(
name|cff_services
argument_list|,
name|module_interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|NULL
condition|)
return|return
name|result
return|;
comment|/* we pass our request to the `sfnt' module */
name|sfnt
operator|=
name|FT_Get_Module
argument_list|(
name|driver
operator|->
name|library
argument_list|,
literal|"sfnt"
argument_list|)
expr_stmt|;
return|return
name|sfnt
condition|?
name|sfnt
operator|->
name|clazz
operator|->
name|get_interface
argument_list|(
name|sfnt
argument_list|,
name|module_interface
argument_list|)
else|:
literal|0
return|;
block|}
end_block
begin_comment
comment|/* The FT_DriverInterface structure is defined in ftdriver.h. */
end_comment
begin_decl_stmt
name|FT_CALLBACK_TABLE_DEF
DECL|variable|cff_driver_class
specifier|const
name|FT_Driver_ClassRec
name|cff_driver_class
init|=
block|{
comment|/* begin with the FT_Module_Class fields */
block|{
name|FT_MODULE_FONT_DRIVER
operator||
name|FT_MODULE_DRIVER_SCALABLE
operator||
name|FT_MODULE_DRIVER_HAS_HINTER
block|,
sizeof|sizeof
argument_list|(
name|CFF_DriverRec
argument_list|)
block|,
literal|"cff"
block|,
literal|0x10000L
block|,
literal|0x20000L
block|,
literal|0
block|,
comment|/* module-specific interface */
name|cff_driver_init
block|,
name|cff_driver_done
block|,
name|cff_get_interface
block|,     }
block|,
comment|/* now the specific driver fields */
sizeof|sizeof
argument_list|(
name|TT_FaceRec
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|CFF_SizeRec
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|CFF_GlyphSlotRec
argument_list|)
block|,
name|cff_face_init
block|,
name|cff_face_done
block|,
name|cff_size_init
block|,
name|cff_size_done
block|,
name|cff_slot_init
block|,
name|cff_slot_done
block|,
ifdef|#
directive|ifdef
name|FT_CONFIG_OPTION_OLD_INTERNALS
name|ft_stub_set_char_sizes
block|,
name|ft_stub_set_pixel_sizes
block|,
endif|#
directive|endif
name|Load_Glyph
block|,
name|cff_get_kerning
block|,
literal|0
block|,
comment|/* FT_Face_AttachFunc      */
name|cff_get_advances
block|,
comment|/* FT_Face_GetAdvancesFunc */
name|cff_size_request
block|,
ifdef|#
directive|ifdef
name|TT_CONFIG_OPTION_EMBEDDED_BITMAPS
name|cff_size_select
else|#
directive|else
literal|0
comment|/* FT_Size_SelectFunc      */
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* END */
end_comment
end_unit
