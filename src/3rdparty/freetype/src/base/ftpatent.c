begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  ftpatent.c                                                             */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    FreeType API for checking patented TrueType bytecode instructions    */
end_comment
begin_comment
comment|/*    (body).                                                              */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2007, 2008, 2010 by David Turner.                            */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_FREETYPE_H
end_include
begin_include
include|#
directive|include
include|FT_TRUETYPE_TAGS_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_OBJECTS_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_STREAM_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_SFNT_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_TRUETYPE_GLYF_H
end_include
begin_function
specifier|static
name|FT_Bool
DECL|function|_tt_check_patents_in_range
name|_tt_check_patents_in_range
parameter_list|(
name|FT_Stream
name|stream
parameter_list|,
name|FT_ULong
name|size
parameter_list|)
block|{
name|FT_Bool
name|result
init|=
name|FALSE
decl_stmt|;
name|FT_Error
name|error
decl_stmt|;
name|FT_Bytes
name|p
decl_stmt|,
name|end
decl_stmt|;
if|if
condition|(
name|FT_FRAME_ENTER
argument_list|(
name|size
argument_list|)
condition|)
return|return
literal|0
return|;
name|p
operator|=
name|stream
operator|->
name|cursor
expr_stmt|;
name|end
operator|=
name|p
operator|+
name|size
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|end
condition|)
block|{
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0x06
case|:
comment|/* SPvTL // */
case|case
literal|0x07
case|:
comment|/* SPvTL +  */
case|case
literal|0x08
case|:
comment|/* SFvTL // */
case|case
literal|0x09
case|:
comment|/* SFvTL +  */
case|case
literal|0x0A
case|:
comment|/* SPvFS    */
case|case
literal|0x0B
case|:
comment|/* SFvFS    */
name|result
operator|=
name|TRUE
expr_stmt|;
goto|goto
name|Exit
goto|;
case|case
literal|0x40
case|:
if|if
condition|(
name|p
operator|+
literal|1
operator|>=
name|end
condition|)
goto|goto
name|Exit
goto|;
name|p
operator|+=
name|p
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
break|break;
case|case
literal|0x41
case|:
if|if
condition|(
name|p
operator|+
literal|1
operator|>=
name|end
condition|)
goto|goto
name|Exit
goto|;
name|p
operator|+=
name|p
index|[
literal|1
index|]
operator|*
literal|2
operator|+
literal|2
expr_stmt|;
break|break;
case|case
literal|0x71
case|:
comment|/* DELTAP2 */
case|case
literal|0x72
case|:
comment|/* DELTAP3 */
case|case
literal|0x73
case|:
comment|/* DELTAC0 */
case|case
literal|0x74
case|:
comment|/* DELTAC1 */
case|case
literal|0x75
case|:
comment|/* DELTAC2 */
name|result
operator|=
name|TRUE
expr_stmt|;
goto|goto
name|Exit
goto|;
case|case
literal|0xB0
case|:
case|case
literal|0xB1
case|:
case|case
literal|0xB2
case|:
case|case
literal|0xB3
case|:
case|case
literal|0xB4
case|:
case|case
literal|0xB5
case|:
case|case
literal|0xB6
case|:
case|case
literal|0xB7
case|:
name|p
operator|+=
operator|(
name|p
index|[
literal|0
index|]
operator|-
literal|0xB0
operator|)
operator|+
literal|2
expr_stmt|;
break|break;
case|case
literal|0xB8
case|:
case|case
literal|0xB9
case|:
case|case
literal|0xBA
case|:
case|case
literal|0xBB
case|:
case|case
literal|0xBC
case|:
case|case
literal|0xBD
case|:
case|case
literal|0xBE
case|:
case|case
literal|0xBF
case|:
name|p
operator|+=
operator|(
name|p
index|[
literal|0
index|]
operator|-
literal|0xB8
operator|)
operator|*
literal|2
operator|+
literal|3
expr_stmt|;
break|break;
default|default:
name|p
operator|+=
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|Exit
label|:
name|FT_UNUSED
argument_list|(
name|error
argument_list|)
expr_stmt|;
name|FT_FRAME_EXIT
argument_list|()
expr_stmt|;
return|return
name|result
return|;
block|}
end_function
begin_function
specifier|static
name|FT_Bool
DECL|function|_tt_check_patents_in_table
name|_tt_check_patents_in_table
parameter_list|(
name|FT_Face
name|face
parameter_list|,
name|FT_ULong
name|tag
parameter_list|)
block|{
name|FT_Stream
name|stream
init|=
name|face
operator|->
name|stream
decl_stmt|;
name|FT_Error
name|error
init|=
name|FT_Err_Ok
decl_stmt|;
name|FT_Service_SFNT_Table
name|service
decl_stmt|;
name|FT_Bool
name|result
init|=
name|FALSE
decl_stmt|;
name|FT_FACE_FIND_SERVICE
argument_list|(
name|face
argument_list|,
name|service
argument_list|,
name|SFNT_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
condition|)
block|{
name|FT_UInt
name|i
init|=
literal|0
decl_stmt|;
name|FT_ULong
name|tag_i
init|=
literal|0
decl_stmt|,
name|offset_i
init|=
literal|0
decl_stmt|,
name|length_i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|error
operator|&&
name|tag_i
operator|!=
name|tag
condition|;
name|i
operator|++
control|)
name|error
operator|=
name|service
operator|->
name|table_info
argument_list|(
name|face
argument_list|,
name|i
argument_list|,
operator|&
name|tag_i
argument_list|,
operator|&
name|offset_i
argument_list|,
operator|&
name|length_i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
name|FT_STREAM_SEEK
argument_list|(
name|offset_i
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|result
operator|=
name|_tt_check_patents_in_range
argument_list|(
name|stream
argument_list|,
name|length_i
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
return|return
name|result
return|;
block|}
end_function
begin_function
specifier|static
name|FT_Bool
DECL|function|_tt_face_check_patents
name|_tt_face_check_patents
parameter_list|(
name|FT_Face
name|face
parameter_list|)
block|{
name|FT_Stream
name|stream
init|=
name|face
operator|->
name|stream
decl_stmt|;
name|FT_UInt
name|gindex
decl_stmt|;
name|FT_Error
name|error
decl_stmt|;
name|FT_Bool
name|result
decl_stmt|;
name|FT_Service_TTGlyf
name|service
decl_stmt|;
name|result
operator|=
name|_tt_check_patents_in_table
argument_list|(
name|face
argument_list|,
name|TTAG_fpgm
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
goto|goto
name|Exit
goto|;
name|result
operator|=
name|_tt_check_patents_in_table
argument_list|(
name|face
argument_list|,
name|TTAG_prep
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
goto|goto
name|Exit
goto|;
name|FT_FACE_FIND_SERVICE
argument_list|(
name|face
argument_list|,
name|service
argument_list|,
name|TT_GLYF
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|==
name|NULL
condition|)
goto|goto
name|Exit
goto|;
for|for
control|(
name|gindex
operator|=
literal|0
init|;
name|gindex
operator|<
operator|(
name|FT_UInt
operator|)
name|face
operator|->
name|num_glyphs
condition|;
name|gindex
operator|++
control|)
block|{
name|FT_ULong
name|offset
decl_stmt|,
name|num_ins
decl_stmt|,
name|size
decl_stmt|;
name|FT_Int
name|num_contours
decl_stmt|;
name|offset
operator|=
name|service
operator|->
name|get_location
argument_list|(
name|face
argument_list|,
name|gindex
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|FT_STREAM_SEEK
argument_list|(
name|offset
argument_list|)
operator|||
name|FT_READ_SHORT
argument_list|(
name|num_contours
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|num_contours
operator|>=
literal|0
condition|)
comment|/* simple glyph */
block|{
if|if
condition|(
name|FT_STREAM_SKIP
argument_list|(
literal|8
operator|+
name|num_contours
operator|*
literal|2
argument_list|)
condition|)
continue|continue;
block|}
else|else
comment|/* compound glyph */
block|{
name|FT_Bool
name|has_instr
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|FT_STREAM_SKIP
argument_list|(
literal|8
argument_list|)
condition|)
continue|continue;
comment|/* now read each component */
for|for
control|(
init|;
condition|;
control|)
block|{
name|FT_UInt
name|flags
decl_stmt|,
name|toskip
decl_stmt|;
if|if
condition|(
name|FT_READ_USHORT
argument_list|(
name|flags
argument_list|)
condition|)
break|break;
name|toskip
operator|=
literal|2
operator|+
literal|1
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
operator|)
operator|!=
literal|0
condition|)
comment|/* ARGS_ARE_WORDS */
name|toskip
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
operator|(
literal|1
operator|<<
literal|3
operator|)
operator|)
operator|!=
literal|0
condition|)
comment|/* WE_HAVE_A_SCALE */
name|toskip
operator|+=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|flags
operator|&
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
operator|!=
literal|0
condition|)
comment|/* WE_HAVE_X_Y_SCALE */
name|toskip
operator|+=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|flags
operator|&
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|)
operator|!=
literal|0
condition|)
comment|/* WE_HAVE_A_2x2 */
name|toskip
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
operator|(
literal|1
operator|<<
literal|8
operator|)
operator|)
operator|!=
literal|0
condition|)
comment|/* WE_HAVE_INSTRUCTIONS */
name|has_instr
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|FT_STREAM_SKIP
argument_list|(
name|toskip
argument_list|)
condition|)
goto|goto
name|NextGlyph
goto|;
if|if
condition|(
operator|(
name|flags
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
operator|)
operator|==
literal|0
condition|)
comment|/* MORE_COMPONENTS */
break|break;
block|}
if|if
condition|(
operator|!
name|has_instr
condition|)
goto|goto
name|NextGlyph
goto|;
block|}
if|if
condition|(
name|FT_READ_USHORT
argument_list|(
name|num_ins
argument_list|)
condition|)
continue|continue;
name|result
operator|=
name|_tt_check_patents_in_range
argument_list|(
name|stream
argument_list|,
name|num_ins
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
goto|goto
name|Exit
goto|;
name|NextGlyph
label|:
empty_stmt|;
block|}
name|Exit
label|:
return|return
name|result
return|;
block|}
end_function
begin_comment
comment|/* documentation is in freetype.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Bool
argument_list|)
end_macro
begin_macro
name|FT_Face_CheckTrueTypePatents
argument_list|(
argument|FT_Face  face
argument_list|)
end_macro
begin_block
block|{
name|FT_Bool
name|result
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|face
operator|&&
name|FT_IS_SFNT
argument_list|(
name|face
argument_list|)
condition|)
name|result
operator|=
name|_tt_face_check_patents
argument_list|(
name|face
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_block
begin_comment
comment|/* documentation is in freetype.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Bool
argument_list|)
end_macro
begin_macro
name|FT_Face_SetUnpatentedHinting
argument_list|(
argument|FT_Face  face
argument_list|,
argument|FT_Bool  value
argument_list|)
end_macro
begin_block
block|{
name|FT_Bool
name|result
init|=
name|FALSE
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TT_CONFIG_OPTION_UNPATENTED_HINTING
argument_list|)
operator|&&
expr|\
operator|!
name|defined
argument_list|(
name|TT_CONFIG_OPTION_BYTECODE_INTEPRETER
argument_list|)
if|if
condition|(
name|face
operator|&&
name|FT_IS_SFNT
argument_list|(
name|face
argument_list|)
condition|)
block|{
name|result
operator|=
operator|!
name|face
operator|->
name|internal
operator|->
name|ignore_unpatented_hinter
expr_stmt|;
name|face
operator|->
name|internal
operator|->
name|ignore_unpatented_hinter
operator|=
operator|!
name|value
expr_stmt|;
block|}
else|#
directive|else
name|FT_UNUSED
argument_list|(
name|face
argument_list|)
expr_stmt|;
name|FT_UNUSED
argument_list|(
name|value
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|result
return|;
block|}
end_block
begin_comment
comment|/* END */
end_comment
end_unit
