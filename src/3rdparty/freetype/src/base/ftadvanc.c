begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  ftadvanc.c                                                             */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    Quick computation of advance widths (body).                          */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2008, 2009 by                                                */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_ADVANCES_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_OBJECTS_H
end_include
begin_function
specifier|static
name|FT_Error
DECL|function|_ft_face_scale_advances
name|_ft_face_scale_advances
parameter_list|(
name|FT_Face
name|face
parameter_list|,
name|FT_Fixed
modifier|*
name|advances
parameter_list|,
name|FT_UInt
name|count
parameter_list|,
name|FT_Int32
name|flags
parameter_list|)
block|{
name|FT_Fixed
name|scale
decl_stmt|;
name|FT_UInt
name|nn
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|FT_LOAD_NO_SCALE
condition|)
return|return
name|FT_Err_Ok
return|;
if|if
condition|(
name|face
operator|->
name|size
operator|==
name|NULL
condition|)
return|return
name|FT_Err_Invalid_Size_Handle
return|;
if|if
condition|(
name|flags
operator|&
name|FT_LOAD_VERTICAL_LAYOUT
condition|)
name|scale
operator|=
name|face
operator|->
name|size
operator|->
name|metrics
operator|.
name|y_scale
expr_stmt|;
else|else
name|scale
operator|=
name|face
operator|->
name|size
operator|->
name|metrics
operator|.
name|x_scale
expr_stmt|;
comment|/* this must be the same scaling as to get linear{Hori,Vert}Advance */
comment|/* (see `FT_Load_Glyph' implementation in src/base/ftobjs.c)        */
for|for
control|(
name|nn
operator|=
literal|0
init|;
name|nn
operator|<
name|count
condition|;
name|nn
operator|++
control|)
name|advances
index|[
name|nn
index|]
operator|=
name|FT_MulDiv
argument_list|(
name|advances
index|[
name|nn
index|]
argument_list|,
name|scale
argument_list|,
literal|64
argument_list|)
expr_stmt|;
return|return
name|FT_Err_Ok
return|;
block|}
end_function
begin_comment
comment|/* at the moment, we can perform fast advance retrieval only in */
end_comment
begin_comment
comment|/* the following cases:                                         */
end_comment
begin_comment
comment|/*                                                              */
end_comment
begin_comment
comment|/*  - unscaled load                                             */
end_comment
begin_comment
comment|/*  - unhinted load                                             */
end_comment
begin_comment
comment|/*  - light-hinted load                                         */
end_comment
begin_define
DECL|macro|LOAD_ADVANCE_FAST_CHECK
define|#
directive|define
name|LOAD_ADVANCE_FAST_CHECK
parameter_list|(
name|flags
parameter_list|)
define|\
value|( flags& ( FT_LOAD_NO_SCALE | FT_LOAD_NO_HINTING )    || \             FT_LOAD_TARGET_MODE( flags ) == FT_RENDER_MODE_LIGHT )
end_define
begin_comment
comment|/* documentation is in ftadvanc.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FT_Get_Advance
argument_list|(
argument|FT_Face    face
argument_list|,
argument|FT_UInt    gindex
argument_list|,
argument|FT_Int32   flags
argument_list|,
argument|FT_Fixed  *padvance
argument_list|)
end_macro
begin_block
block|{
name|FT_Face_GetAdvancesFunc
name|func
decl_stmt|;
if|if
condition|(
operator|!
name|face
condition|)
return|return
name|FT_Err_Invalid_Face_Handle
return|;
if|if
condition|(
name|gindex
operator|>=
operator|(
name|FT_UInt
operator|)
name|face
operator|->
name|num_glyphs
condition|)
return|return
name|FT_Err_Invalid_Glyph_Index
return|;
name|func
operator|=
name|face
operator|->
name|driver
operator|->
name|clazz
operator|->
name|get_advances
expr_stmt|;
if|if
condition|(
name|func
operator|&&
name|LOAD_ADVANCE_FAST_CHECK
argument_list|(
name|flags
argument_list|)
condition|)
block|{
name|FT_Error
name|error
decl_stmt|;
name|error
operator|=
name|func
argument_list|(
name|face
argument_list|,
name|gindex
argument_list|,
literal|1
argument_list|,
name|flags
argument_list|,
name|padvance
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
return|return
name|_ft_face_scale_advances
argument_list|(
name|face
argument_list|,
name|padvance
argument_list|,
literal|1
argument_list|,
name|flags
argument_list|)
return|;
if|if
condition|(
name|error
operator|!=
name|FT_ERROR_BASE
argument_list|(
name|FT_Err_Unimplemented_Feature
argument_list|)
condition|)
return|return
name|error
return|;
block|}
return|return
name|FT_Get_Advances
argument_list|(
name|face
argument_list|,
name|gindex
argument_list|,
literal|1
argument_list|,
name|flags
argument_list|,
name|padvance
argument_list|)
return|;
block|}
end_block
begin_comment
comment|/* documentation is in ftadvanc.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FT_Get_Advances
argument_list|(
argument|FT_Face    face
argument_list|,
argument|FT_UInt    start
argument_list|,
argument|FT_UInt    count
argument_list|,
argument|FT_Int32   flags
argument_list|,
argument|FT_Fixed  *padvances
argument_list|)
end_macro
begin_block
block|{
name|FT_Face_GetAdvancesFunc
name|func
decl_stmt|;
name|FT_UInt
name|num
decl_stmt|,
name|end
decl_stmt|,
name|nn
decl_stmt|;
name|FT_Error
name|error
init|=
name|FT_Err_Ok
decl_stmt|;
if|if
condition|(
operator|!
name|face
condition|)
return|return
name|FT_Err_Invalid_Face_Handle
return|;
name|num
operator|=
operator|(
name|FT_UInt
operator|)
name|face
operator|->
name|num_glyphs
expr_stmt|;
name|end
operator|=
name|start
operator|+
name|count
expr_stmt|;
if|if
condition|(
name|start
operator|>=
name|num
operator|||
name|end
operator|<
name|start
operator|||
name|end
operator|>
name|num
condition|)
return|return
name|FT_Err_Invalid_Glyph_Index
return|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
return|return
name|FT_Err_Ok
return|;
name|func
operator|=
name|face
operator|->
name|driver
operator|->
name|clazz
operator|->
name|get_advances
expr_stmt|;
if|if
condition|(
name|func
operator|&&
name|LOAD_ADVANCE_FAST_CHECK
argument_list|(
name|flags
argument_list|)
condition|)
block|{
name|error
operator|=
name|func
argument_list|(
name|face
argument_list|,
name|start
argument_list|,
name|count
argument_list|,
name|flags
argument_list|,
name|padvances
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|error
operator|!=
name|FT_ERROR_BASE
argument_list|(
name|FT_Err_Unimplemented_Feature
argument_list|)
condition|)
return|return
name|error
return|;
block|}
name|error
operator|=
name|FT_Err_Ok
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|FT_ADVANCE_FLAG_FAST_ONLY
condition|)
return|return
name|FT_Err_Unimplemented_Feature
return|;
name|flags
operator||=
operator|(
name|FT_UInt32
operator|)
name|FT_LOAD_ADVANCE_ONLY
expr_stmt|;
for|for
control|(
name|nn
operator|=
literal|0
init|;
name|nn
operator|<
name|count
condition|;
name|nn
operator|++
control|)
block|{
name|error
operator|=
name|FT_Load_Glyph
argument_list|(
name|face
argument_list|,
name|start
operator|+
name|nn
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|padvances
index|[
name|nn
index|]
operator|=
operator|(
name|flags
operator|&
name|FT_LOAD_VERTICAL_LAYOUT
operator|)
condition|?
name|face
operator|->
name|glyph
operator|->
name|advance
operator|.
name|y
else|:
name|face
operator|->
name|glyph
operator|->
name|advance
operator|.
name|x
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|Exit
label|:
return|return
name|_ft_face_scale_advances
argument_list|(
name|face
argument_list|,
name|padvances
argument_list|,
name|count
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_block
begin_comment
comment|/* END */
end_comment
end_unit
