begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  pfrdrivr.c                                                             */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    FreeType PFR driver interface (body).                                */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2002-2004, 2006, 2008, 2010, 2011, 2013, 2014 by             */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_DEBUG_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_STREAM_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_PFR_H
end_include
begin_include
include|#
directive|include
include|FT_SERVICE_XFREE86_NAME_H
end_include
begin_include
include|#
directive|include
file|"pfrdrivr.h"
end_include
begin_include
include|#
directive|include
file|"pfrobjs.h"
end_include
begin_include
include|#
directive|include
file|"pfrerror.h"
end_include
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|pfr_get_kerning
argument_list|(
argument|FT_Face     pfrface
argument_list|,
comment|/* PFR_Face */
argument|FT_UInt     left
argument_list|,
argument|FT_UInt     right
argument_list|,
argument|FT_Vector  *avector
argument_list|)
end_macro
begin_block
block|{
name|PFR_Face
name|face
init|=
operator|(
name|PFR_Face
operator|)
name|pfrface
decl_stmt|;
name|PFR_PhyFont
name|phys
init|=
operator|&
name|face
operator|->
name|phy_font
decl_stmt|;
operator|(
name|void
operator|)
name|pfr_face_get_kerning
argument_list|(
name|pfrface
argument_list|,
name|left
argument_list|,
name|right
argument_list|,
name|avector
argument_list|)
expr_stmt|;
comment|/* convert from metrics to outline units when necessary */
if|if
condition|(
name|phys
operator|->
name|outline_resolution
operator|!=
name|phys
operator|->
name|metrics_resolution
condition|)
block|{
if|if
condition|(
name|avector
operator|->
name|x
operator|!=
literal|0
condition|)
name|avector
operator|->
name|x
operator|=
name|FT_MulDiv
argument_list|(
name|avector
operator|->
name|x
argument_list|,
name|phys
operator|->
name|outline_resolution
argument_list|,
name|phys
operator|->
name|metrics_resolution
argument_list|)
expr_stmt|;
if|if
condition|(
name|avector
operator|->
name|y
operator|!=
literal|0
condition|)
name|avector
operator|->
name|y
operator|=
name|FT_MulDiv
argument_list|(
name|avector
operator|->
name|x
argument_list|,
name|phys
operator|->
name|outline_resolution
argument_list|,
name|phys
operator|->
name|metrics_resolution
argument_list|)
expr_stmt|;
block|}
return|return
name|FT_Err_Ok
return|;
block|}
end_block
begin_comment
comment|/*   *  PFR METRICS SERVICE   *   */
end_comment
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|pfr_get_advance
argument_list|(
argument|FT_Face   pfrface
argument_list|,
comment|/* PFR_Face */
argument|FT_UInt   gindex
argument_list|,
argument|FT_Pos   *anadvance
argument_list|)
end_macro
begin_block
block|{
name|PFR_Face
name|face
init|=
operator|(
name|PFR_Face
operator|)
name|pfrface
decl_stmt|;
name|FT_Error
name|error
init|=
name|FT_ERR
argument_list|(
name|Invalid_Argument
argument_list|)
decl_stmt|;
operator|*
name|anadvance
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|gindex
condition|)
goto|goto
name|Exit
goto|;
name|gindex
operator|--
expr_stmt|;
if|if
condition|(
name|face
condition|)
block|{
name|PFR_PhyFont
name|phys
init|=
operator|&
name|face
operator|->
name|phy_font
decl_stmt|;
if|if
condition|(
name|gindex
operator|<
name|phys
operator|->
name|num_chars
condition|)
block|{
operator|*
name|anadvance
operator|=
name|phys
operator|->
name|chars
index|[
name|gindex
index|]
operator|.
name|advance
expr_stmt|;
name|error
operator|=
name|FT_Err_Ok
expr_stmt|;
block|}
block|}
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|pfr_get_metrics
argument_list|(
argument|FT_Face    pfrface
argument_list|,
comment|/* PFR_Face */
argument|FT_UInt   *anoutline_resolution
argument_list|,
argument|FT_UInt   *ametrics_resolution
argument_list|,
argument|FT_Fixed  *ametrics_x_scale
argument_list|,
argument|FT_Fixed  *ametrics_y_scale
argument_list|)
end_macro
begin_block
block|{
name|PFR_Face
name|face
init|=
operator|(
name|PFR_Face
operator|)
name|pfrface
decl_stmt|;
name|PFR_PhyFont
name|phys
init|=
operator|&
name|face
operator|->
name|phy_font
decl_stmt|;
name|FT_Fixed
name|x_scale
decl_stmt|,
name|y_scale
decl_stmt|;
name|FT_Size
name|size
init|=
name|face
operator|->
name|root
operator|.
name|size
decl_stmt|;
if|if
condition|(
name|anoutline_resolution
condition|)
operator|*
name|anoutline_resolution
operator|=
name|phys
operator|->
name|outline_resolution
expr_stmt|;
if|if
condition|(
name|ametrics_resolution
condition|)
operator|*
name|ametrics_resolution
operator|=
name|phys
operator|->
name|metrics_resolution
expr_stmt|;
name|x_scale
operator|=
literal|0x10000L
expr_stmt|;
name|y_scale
operator|=
literal|0x10000L
expr_stmt|;
if|if
condition|(
name|size
condition|)
block|{
name|x_scale
operator|=
name|FT_DivFix
argument_list|(
name|size
operator|->
name|metrics
operator|.
name|x_ppem
operator|<<
literal|6
argument_list|,
name|phys
operator|->
name|metrics_resolution
argument_list|)
expr_stmt|;
name|y_scale
operator|=
name|FT_DivFix
argument_list|(
name|size
operator|->
name|metrics
operator|.
name|y_ppem
operator|<<
literal|6
argument_list|,
name|phys
operator|->
name|metrics_resolution
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ametrics_x_scale
condition|)
operator|*
name|ametrics_x_scale
operator|=
name|x_scale
expr_stmt|;
if|if
condition|(
name|ametrics_y_scale
condition|)
operator|*
name|ametrics_y_scale
operator|=
name|y_scale
expr_stmt|;
return|return
name|FT_Err_Ok
return|;
block|}
end_block
begin_decl_stmt
specifier|static
DECL|variable|pfr_metrics_service_rec
specifier|const
name|FT_Service_PfrMetricsRec
name|pfr_metrics_service_rec
init|=
block|{
name|pfr_get_metrics
block|,
name|pfr_face_get_kerning
block|,
name|pfr_get_advance
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*   *  SERVICE LIST   *   */
end_comment
begin_decl_stmt
DECL|variable|pfr_services
specifier|static
specifier|const
name|FT_ServiceDescRec
name|pfr_services
index|[]
init|=
block|{
block|{
name|FT_SERVICE_ID_PFR_METRICS
block|,
operator|&
name|pfr_metrics_service_rec
block|}
block|,
block|{
name|FT_SERVICE_ID_XF86_NAME
block|,
name|FT_XF86_FORMAT_PFR
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Module_Interface
argument_list|)
end_macro
begin_macro
name|pfr_get_service
argument_list|(
argument|FT_Module         module
argument_list|,
argument|const FT_String*  service_id
argument_list|)
end_macro
begin_block
block|{
name|FT_UNUSED
argument_list|(
name|module
argument_list|)
expr_stmt|;
return|return
name|ft_service_list_lookup
argument_list|(
name|pfr_services
argument_list|,
name|service_id
argument_list|)
return|;
block|}
end_block
begin_decl_stmt
name|FT_CALLBACK_TABLE_DEF
DECL|variable|pfr_driver_class
specifier|const
name|FT_Driver_ClassRec
name|pfr_driver_class
init|=
block|{
block|{
name|FT_MODULE_FONT_DRIVER
operator||
name|FT_MODULE_DRIVER_SCALABLE
block|,
sizeof|sizeof
argument_list|(
name|FT_DriverRec
argument_list|)
block|,
literal|"pfr"
block|,
literal|0x10000L
block|,
literal|0x20000L
block|,
name|NULL
block|,
literal|0
block|,
comment|/* FT_Module_Constructor */
literal|0
block|,
comment|/* FT_Module_Destructor  */
name|pfr_get_service
block|}
block|,
sizeof|sizeof
argument_list|(
name|PFR_FaceRec
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|PFR_SizeRec
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|PFR_SlotRec
argument_list|)
block|,
name|pfr_face_init
block|,
name|pfr_face_done
block|,
literal|0
block|,
comment|/* FT_Size_InitFunc */
literal|0
block|,
comment|/* FT_Size_DoneFunc */
name|pfr_slot_init
block|,
name|pfr_slot_done
block|,
name|pfr_slot_load
block|,
name|pfr_get_kerning
block|,
literal|0
block|,
comment|/* FT_Face_AttachFunc      */
literal|0
block|,
comment|/* FT_Face_GetAdvancesFunc */
literal|0
block|,
comment|/* FT_Size_RequestFunc     */
literal|0
block|,
comment|/* FT_Size_SelectFunc      */
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* END */
end_comment
end_unit
