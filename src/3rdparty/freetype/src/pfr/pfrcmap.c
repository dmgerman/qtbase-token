begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  pfrcmap.c                                                              */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    FreeType PFR cmap handling (body).                                   */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2002, 2007, 2009 by                                          */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"pfrcmap.h"
end_include
begin_include
include|#
directive|include
file|"pfrobjs.h"
end_include
begin_include
include|#
directive|include
file|"pfrerror.h"
end_include
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|pfr_cmap_init
argument_list|(
argument|PFR_CMap  cmap
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
init|=
name|PFR_Err_Ok
decl_stmt|;
name|PFR_Face
name|face
init|=
operator|(
name|PFR_Face
operator|)
name|FT_CMAP_FACE
argument_list|(
name|cmap
argument_list|)
decl_stmt|;
name|cmap
operator|->
name|num_chars
operator|=
name|face
operator|->
name|phy_font
operator|.
name|num_chars
expr_stmt|;
name|cmap
operator|->
name|chars
operator|=
name|face
operator|->
name|phy_font
operator|.
name|chars
expr_stmt|;
comment|/* just for safety, check that the character entries are correctly */
comment|/* sorted in increasing character code order                       */
block|{
name|FT_UInt
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|1
init|;
name|n
operator|<
name|cmap
operator|->
name|num_chars
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|cmap
operator|->
name|chars
index|[
name|n
operator|-
literal|1
index|]
operator|.
name|char_code
operator|>=
name|cmap
operator|->
name|chars
index|[
name|n
index|]
operator|.
name|char_code
condition|)
block|{
name|error
operator|=
name|PFR_Err_Invalid_Table
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
block|}
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_macro
name|FT_CALLBACK_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|pfr_cmap_done
name|pfr_cmap_done
argument_list|(
argument|PFR_CMap  cmap
argument_list|)
end_macro
begin_block
block|{
name|cmap
operator|->
name|chars
operator|=
name|NULL
expr_stmt|;
name|cmap
operator|->
name|num_chars
operator|=
literal|0
expr_stmt|;
block|}
end_block
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_UInt
argument_list|)
end_macro
begin_macro
name|pfr_cmap_char_index
argument_list|(
argument|PFR_CMap   cmap
argument_list|,
argument|FT_UInt32  char_code
argument_list|)
end_macro
begin_block
block|{
name|FT_UInt
name|min
init|=
literal|0
decl_stmt|;
name|FT_UInt
name|max
init|=
name|cmap
operator|->
name|num_chars
decl_stmt|;
name|FT_UInt
name|mid
decl_stmt|;
name|PFR_Char
name|gchar
decl_stmt|;
while|while
condition|(
name|min
operator|<
name|max
condition|)
block|{
name|mid
operator|=
name|min
operator|+
operator|(
name|max
operator|-
name|min
operator|)
operator|/
literal|2
expr_stmt|;
name|gchar
operator|=
name|cmap
operator|->
name|chars
operator|+
name|mid
expr_stmt|;
if|if
condition|(
name|gchar
operator|->
name|char_code
operator|==
name|char_code
condition|)
return|return
name|mid
operator|+
literal|1
return|;
if|if
condition|(
name|gchar
operator|->
name|char_code
operator|<
name|char_code
condition|)
name|min
operator|=
name|mid
operator|+
literal|1
expr_stmt|;
else|else
name|max
operator|=
name|mid
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_block
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_UInt32
argument_list|)
end_macro
begin_macro
name|pfr_cmap_char_next
argument_list|(
argument|PFR_CMap    cmap
argument_list|,
argument|FT_UInt32  *pchar_code
argument_list|)
end_macro
begin_block
block|{
name|FT_UInt
name|result
init|=
literal|0
decl_stmt|;
name|FT_UInt32
name|char_code
init|=
operator|*
name|pchar_code
operator|+
literal|1
decl_stmt|;
name|Restart
label|:
block|{
name|FT_UInt
name|min
init|=
literal|0
decl_stmt|;
name|FT_UInt
name|max
init|=
name|cmap
operator|->
name|num_chars
decl_stmt|;
name|FT_UInt
name|mid
decl_stmt|;
name|PFR_Char
name|gchar
decl_stmt|;
while|while
condition|(
name|min
operator|<
name|max
condition|)
block|{
name|mid
operator|=
name|min
operator|+
operator|(
operator|(
name|max
operator|-
name|min
operator|)
operator|>>
literal|1
operator|)
expr_stmt|;
name|gchar
operator|=
name|cmap
operator|->
name|chars
operator|+
name|mid
expr_stmt|;
if|if
condition|(
name|gchar
operator|->
name|char_code
operator|==
name|char_code
condition|)
block|{
name|result
operator|=
name|mid
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
name|result
operator|++
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|char_code
operator|++
expr_stmt|;
goto|goto
name|Restart
goto|;
block|}
if|if
condition|(
name|gchar
operator|->
name|char_code
operator|<
name|char_code
condition|)
name|min
operator|=
name|mid
operator|+
literal|1
expr_stmt|;
else|else
name|max
operator|=
name|mid
expr_stmt|;
block|}
comment|/* we didn't find it, but we have a pair just above it */
name|char_code
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|min
operator|<
name|cmap
operator|->
name|num_chars
condition|)
block|{
name|gchar
operator|=
name|cmap
operator|->
name|chars
operator|+
name|min
expr_stmt|;
name|result
operator|=
name|min
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
name|result
operator|++
expr_stmt|;
name|char_code
operator|=
name|gchar
operator|->
name|char_code
expr_stmt|;
block|}
block|}
block|}
name|Exit
label|:
operator|*
name|pchar_code
operator|=
name|char_code
expr_stmt|;
return|return
name|result
return|;
block|}
end_block
begin_decl_stmt
name|FT_CALLBACK_TABLE_DEF
specifier|const
name|FT_CMap_ClassRec
DECL|variable|pfr_cmap_class_rec
name|pfr_cmap_class_rec
init|=
block|{
sizeof|sizeof
argument_list|(
name|PFR_CMapRec
argument_list|)
block|,
operator|(
name|FT_CMap_InitFunc
operator|)
name|pfr_cmap_init
block|,
operator|(
name|FT_CMap_DoneFunc
operator|)
name|pfr_cmap_done
block|,
operator|(
name|FT_CMap_CharIndexFunc
operator|)
name|pfr_cmap_char_index
block|,
operator|(
name|FT_CMap_CharNextFunc
operator|)
name|pfr_cmap_char_next
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* END */
end_comment
end_unit
