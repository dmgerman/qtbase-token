begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  ftcmru.c                                                               */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    FreeType MRU support (body).                                         */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2003, 2004, 2006, 2009 by                                    */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_CACHE_H
end_include
begin_include
include|#
directive|include
file|"ftcmru.h"
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_OBJECTS_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_DEBUG_H
end_include
begin_include
include|#
directive|include
file|"ftcerror.h"
end_include
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|FTC_MruNode_Prepend
name|FTC_MruNode_Prepend
argument_list|(
argument|FTC_MruNode  *plist
argument_list|,
argument|FTC_MruNode   node
argument_list|)
end_macro
begin_block
block|{
name|FTC_MruNode
name|first
init|=
operator|*
name|plist
decl_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|FTC_MruNode
name|last
init|=
name|first
operator|->
name|prev
decl_stmt|;
ifdef|#
directive|ifdef
name|FT_DEBUG_ERROR
block|{
name|FTC_MruNode
name|cnode
init|=
name|first
decl_stmt|;
do|do
block|{
if|if
condition|(
name|cnode
operator|==
name|node
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FTC_MruNode_Prepend: invalid action\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|cnode
operator|=
name|cnode
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|cnode
operator|!=
name|first
condition|)
do|;
block|}
endif|#
directive|endif
name|first
operator|->
name|prev
operator|=
name|node
expr_stmt|;
name|last
operator|->
name|next
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|next
operator|=
name|first
expr_stmt|;
name|node
operator|->
name|prev
operator|=
name|last
expr_stmt|;
block|}
else|else
block|{
name|node
operator|->
name|next
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|prev
operator|=
name|node
expr_stmt|;
block|}
operator|*
name|plist
operator|=
name|node
expr_stmt|;
block|}
end_block
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|FTC_MruNode_Up
name|FTC_MruNode_Up
argument_list|(
argument|FTC_MruNode  *plist
argument_list|,
argument|FTC_MruNode   node
argument_list|)
end_macro
begin_block
block|{
name|FTC_MruNode
name|first
init|=
operator|*
name|plist
decl_stmt|;
name|FT_ASSERT
argument_list|(
name|first
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
operator|!=
name|node
condition|)
block|{
name|FTC_MruNode
name|prev
decl_stmt|,
name|next
decl_stmt|,
name|last
decl_stmt|;
ifdef|#
directive|ifdef
name|FT_DEBUG_ERROR
block|{
name|FTC_MruNode
name|cnode
init|=
name|first
decl_stmt|;
do|do
block|{
if|if
condition|(
name|cnode
operator|==
name|node
condition|)
goto|goto
name|Ok
goto|;
name|cnode
operator|=
name|cnode
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|cnode
operator|!=
name|first
condition|)
do|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FTC_MruNode_Up: invalid action\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|Ok
label|:
block|}
endif|#
directive|endif
name|prev
operator|=
name|node
operator|->
name|prev
expr_stmt|;
name|next
operator|=
name|node
operator|->
name|next
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|next
expr_stmt|;
name|next
operator|->
name|prev
operator|=
name|prev
expr_stmt|;
name|last
operator|=
name|first
operator|->
name|prev
expr_stmt|;
name|last
operator|->
name|next
operator|=
name|node
expr_stmt|;
name|first
operator|->
name|prev
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|next
operator|=
name|first
expr_stmt|;
name|node
operator|->
name|prev
operator|=
name|last
expr_stmt|;
operator|*
name|plist
operator|=
name|node
expr_stmt|;
block|}
block|}
end_block
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|FTC_MruNode_Remove
name|FTC_MruNode_Remove
argument_list|(
argument|FTC_MruNode  *plist
argument_list|,
argument|FTC_MruNode   node
argument_list|)
end_macro
begin_block
block|{
name|FTC_MruNode
name|first
init|=
operator|*
name|plist
decl_stmt|;
name|FTC_MruNode
name|prev
decl_stmt|,
name|next
decl_stmt|;
name|FT_ASSERT
argument_list|(
name|first
operator|!=
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FT_DEBUG_ERROR
block|{
name|FTC_MruNode
name|cnode
init|=
name|first
decl_stmt|;
do|do
block|{
if|if
condition|(
name|cnode
operator|==
name|node
condition|)
goto|goto
name|Ok
goto|;
name|cnode
operator|=
name|cnode
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|cnode
operator|!=
name|first
condition|)
do|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FTC_MruNode_Remove: invalid action\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|Ok
label|:
block|}
endif|#
directive|endif
name|prev
operator|=
name|node
operator|->
name|prev
expr_stmt|;
name|next
operator|=
name|node
operator|->
name|next
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|next
expr_stmt|;
name|next
operator|->
name|prev
operator|=
name|prev
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|next
condition|)
block|{
name|FT_ASSERT
argument_list|(
name|first
operator|==
name|node
argument_list|)
expr_stmt|;
name|FT_ASSERT
argument_list|(
name|prev
operator|==
name|node
argument_list|)
expr_stmt|;
operator|*
name|plist
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node
operator|==
name|first
condition|)
operator|*
name|plist
operator|=
name|next
expr_stmt|;
block|}
end_block
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|FTC_MruList_Init
name|FTC_MruList_Init
argument_list|(
argument|FTC_MruList       list
argument_list|,
argument|FTC_MruListClass  clazz
argument_list|,
argument|FT_UInt           max_nodes
argument_list|,
argument|FT_Pointer        data
argument_list|,
argument|FT_Memory         memory
argument_list|)
end_macro
begin_block
block|{
name|list
operator|->
name|num_nodes
operator|=
literal|0
expr_stmt|;
name|list
operator|->
name|max_nodes
operator|=
name|max_nodes
expr_stmt|;
name|list
operator|->
name|nodes
operator|=
name|NULL
expr_stmt|;
name|list
operator|->
name|clazz
operator|=
operator|*
name|clazz
expr_stmt|;
name|list
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|list
operator|->
name|memory
operator|=
name|memory
expr_stmt|;
block|}
end_block
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|FTC_MruList_Reset
name|FTC_MruList_Reset
argument_list|(
argument|FTC_MruList  list
argument_list|)
end_macro
begin_block
block|{
while|while
condition|(
name|list
operator|->
name|nodes
condition|)
name|FTC_MruList_Remove
argument_list|(
name|list
argument_list|,
name|list
operator|->
name|nodes
argument_list|)
expr_stmt|;
name|FT_ASSERT
argument_list|(
name|list
operator|->
name|num_nodes
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_block
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|FTC_MruList_Done
name|FTC_MruList_Done
argument_list|(
argument|FTC_MruList  list
argument_list|)
end_macro
begin_block
block|{
name|FTC_MruList_Reset
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
end_block
begin_ifndef
ifndef|#
directive|ifndef
name|FTC_INLINE
end_ifndef
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FTC_MruNode
argument_list|)
end_macro
begin_macro
name|FTC_MruList_Find
argument_list|(
argument|FTC_MruList  list
argument_list|,
argument|FT_Pointer   key
argument_list|)
end_macro
begin_block
block|{
name|FTC_MruNode_CompareFunc
name|compare
init|=
name|list
operator|->
name|clazz
operator|.
name|node_compare
decl_stmt|;
name|FTC_MruNode
name|first
decl_stmt|,
name|node
decl_stmt|;
name|first
operator|=
name|list
operator|->
name|nodes
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|node
operator|=
name|first
expr_stmt|;
do|do
block|{
if|if
condition|(
name|compare
argument_list|(
name|node
argument_list|,
name|key
argument_list|)
condition|)
block|{
if|if
condition|(
name|node
operator|!=
name|first
condition|)
name|FTC_MruNode_Up
argument_list|(
operator|&
name|list
operator|->
name|nodes
argument_list|,
name|node
argument_list|)
expr_stmt|;
return|return
name|node
return|;
block|}
name|node
operator|=
name|node
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|node
operator|!=
name|first
condition|)
do|;
block|}
return|return
name|NULL
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FTC_MruList_New
argument_list|(
argument|FTC_MruList   list
argument_list|,
argument|FT_Pointer    key
argument_list|,
argument|FTC_MruNode  *anode
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|FTC_MruNode
name|node
decl_stmt|;
name|FT_Memory
name|memory
init|=
name|list
operator|->
name|memory
decl_stmt|;
if|if
condition|(
name|list
operator|->
name|num_nodes
operator|>=
name|list
operator|->
name|max_nodes
operator|&&
name|list
operator|->
name|max_nodes
operator|>
literal|0
condition|)
block|{
name|node
operator|=
name|list
operator|->
name|nodes
operator|->
name|prev
expr_stmt|;
name|FT_ASSERT
argument_list|(
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|->
name|clazz
operator|.
name|node_reset
condition|)
block|{
name|FTC_MruNode_Up
argument_list|(
operator|&
name|list
operator|->
name|nodes
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|error
operator|=
name|list
operator|->
name|clazz
operator|.
name|node_reset
argument_list|(
name|node
argument_list|,
name|key
argument_list|,
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
goto|goto
name|Exit
goto|;
block|}
name|FTC_MruNode_Remove
argument_list|(
operator|&
name|list
operator|->
name|nodes
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|list
operator|->
name|num_nodes
operator|--
expr_stmt|;
if|if
condition|(
name|list
operator|->
name|clazz
operator|.
name|node_done
condition|)
name|list
operator|->
name|clazz
operator|.
name|node_done
argument_list|(
name|node
argument_list|,
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FT_ALLOC
argument_list|(
name|node
argument_list|,
name|list
operator|->
name|clazz
operator|.
name|node_size
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|error
operator|=
name|list
operator|->
name|clazz
operator|.
name|node_init
argument_list|(
name|node
argument_list|,
name|key
argument_list|,
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Fail
goto|;
name|FTC_MruNode_Prepend
argument_list|(
operator|&
name|list
operator|->
name|nodes
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|list
operator|->
name|num_nodes
operator|++
expr_stmt|;
name|Exit
label|:
operator|*
name|anode
operator|=
name|node
expr_stmt|;
return|return
name|error
return|;
name|Fail
label|:
if|if
condition|(
name|list
operator|->
name|clazz
operator|.
name|node_done
condition|)
name|list
operator|->
name|clazz
operator|.
name|node_done
argument_list|(
name|node
argument_list|,
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
name|FT_FREE
argument_list|(
name|node
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
end_block
begin_ifndef
ifndef|#
directive|ifndef
name|FTC_INLINE
end_ifndef
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FTC_MruList_Lookup
argument_list|(
argument|FTC_MruList   list
argument_list|,
argument|FT_Pointer    key
argument_list|,
argument|FTC_MruNode  *anode
argument_list|)
end_macro
begin_block
block|{
name|FTC_MruNode
name|node
decl_stmt|;
name|node
operator|=
name|FTC_MruList_Find
argument_list|(
name|list
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|FTC_MruList_New
argument_list|(
name|list
argument_list|,
name|key
argument_list|,
name|anode
argument_list|)
return|;
operator|*
name|anode
operator|=
name|node
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* FTC_INLINE */
end_comment
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|FTC_MruList_Remove
name|FTC_MruList_Remove
argument_list|(
argument|FTC_MruList  list
argument_list|,
argument|FTC_MruNode  node
argument_list|)
end_macro
begin_block
block|{
name|FTC_MruNode_Remove
argument_list|(
operator|&
name|list
operator|->
name|nodes
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|list
operator|->
name|num_nodes
operator|--
expr_stmt|;
block|{
name|FT_Memory
name|memory
init|=
name|list
operator|->
name|memory
decl_stmt|;
if|if
condition|(
name|list
operator|->
name|clazz
operator|.
name|node_done
condition|)
name|list
operator|->
name|clazz
operator|.
name|node_done
argument_list|(
name|node
argument_list|,
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
name|FT_FREE
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
block|}
end_block
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|FTC_MruList_RemoveSelection
name|FTC_MruList_RemoveSelection
argument_list|(
argument|FTC_MruList              list
argument_list|,
argument|FTC_MruNode_CompareFunc  selection
argument_list|,
argument|FT_Pointer               key
argument_list|)
end_macro
begin_block
block|{
name|FTC_MruNode
name|first
decl_stmt|,
name|node
decl_stmt|,
name|next
decl_stmt|;
name|first
operator|=
name|list
operator|->
name|nodes
expr_stmt|;
while|while
condition|(
name|first
operator|&&
operator|(
name|selection
operator|==
name|NULL
operator|||
name|selection
argument_list|(
name|first
argument_list|,
name|key
argument_list|)
operator|)
condition|)
block|{
name|FTC_MruList_Remove
argument_list|(
name|list
argument_list|,
name|first
argument_list|)
expr_stmt|;
name|first
operator|=
name|list
operator|->
name|nodes
expr_stmt|;
block|}
if|if
condition|(
name|first
condition|)
block|{
name|node
operator|=
name|first
operator|->
name|next
expr_stmt|;
while|while
condition|(
name|node
operator|!=
name|first
condition|)
block|{
name|next
operator|=
name|node
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|selection
argument_list|(
name|node
argument_list|,
name|key
argument_list|)
condition|)
name|FTC_MruList_Remove
argument_list|(
name|list
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|next
expr_stmt|;
block|}
block|}
block|}
end_block
begin_comment
comment|/* END */
end_comment
end_unit
