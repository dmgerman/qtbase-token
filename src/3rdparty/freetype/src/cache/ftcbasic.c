begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  ftcbasic.c                                                             */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    The FreeType basic cache interface (body).                           */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2003-2007, 2009-2011, 2013, 2014 by                          */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_OBJECTS_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_DEBUG_H
end_include
begin_include
include|#
directive|include
include|FT_CACHE_H
end_include
begin_include
include|#
directive|include
file|"ftcglyph.h"
end_include
begin_include
include|#
directive|include
file|"ftcimage.h"
end_include
begin_include
include|#
directive|include
file|"ftcsbits.h"
end_include
begin_include
include|#
directive|include
file|"ftccback.h"
end_include
begin_include
include|#
directive|include
file|"ftcerror.h"
end_include
begin_define
DECL|macro|FT_COMPONENT
define|#
directive|define
name|FT_COMPONENT
value|trace_cache
end_define
begin_comment
comment|/*    *  Basic Families    *    */
end_comment
begin_typedef
DECL|struct|FTC_BasicAttrRec_
typedef|typedef
struct|struct
name|FTC_BasicAttrRec_
block|{
DECL|member|scaler
name|FTC_ScalerRec
name|scaler
decl_stmt|;
DECL|member|load_flags
name|FT_UInt
name|load_flags
decl_stmt|;
block|}
DECL|typedef|FTC_BasicAttrRec
DECL|typedef|FTC_BasicAttrs
name|FTC_BasicAttrRec
operator|,
typedef|*
name|FTC_BasicAttrs
typedef|;
end_typedef
begin_define
DECL|macro|FTC_BASIC_ATTR_COMPARE
define|#
directive|define
name|FTC_BASIC_ATTR_COMPARE
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
define|\
value|FT_BOOL( FTC_SCALER_COMPARE(&(a)->scaler,&(b)->scaler )&& \                    (a)->load_flags == (b)->load_flags               )
end_define
begin_define
DECL|macro|FTC_BASIC_ATTR_HASH
define|#
directive|define
name|FTC_BASIC_ATTR_HASH
parameter_list|(
name|a
parameter_list|)
define|\
value|( FTC_SCALER_HASH(&(a)->scaler ) + 31*(a)->load_flags )
end_define
begin_typedef
DECL|struct|FTC_BasicQueryRec_
typedef|typedef
struct|struct
name|FTC_BasicQueryRec_
block|{
DECL|member|gquery
name|FTC_GQueryRec
name|gquery
decl_stmt|;
DECL|member|attrs
name|FTC_BasicAttrRec
name|attrs
decl_stmt|;
block|}
DECL|typedef|FTC_BasicQueryRec
DECL|typedef|FTC_BasicQuery
name|FTC_BasicQueryRec
operator|,
typedef|*
name|FTC_BasicQuery
typedef|;
end_typedef
begin_typedef
DECL|struct|FTC_BasicFamilyRec_
typedef|typedef
struct|struct
name|FTC_BasicFamilyRec_
block|{
DECL|member|family
name|FTC_FamilyRec
name|family
decl_stmt|;
DECL|member|attrs
name|FTC_BasicAttrRec
name|attrs
decl_stmt|;
block|}
DECL|typedef|FTC_BasicFamilyRec
DECL|typedef|FTC_BasicFamily
name|FTC_BasicFamilyRec
operator|,
typedef|*
name|FTC_BasicFamily
typedef|;
end_typedef
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Bool
argument_list|)
end_macro
begin_macro
name|ftc_basic_family_compare
argument_list|(
argument|FTC_MruNode  ftcfamily
argument_list|,
argument|FT_Pointer   ftcquery
argument_list|)
end_macro
begin_block
block|{
name|FTC_BasicFamily
name|family
init|=
operator|(
name|FTC_BasicFamily
operator|)
name|ftcfamily
decl_stmt|;
name|FTC_BasicQuery
name|query
init|=
operator|(
name|FTC_BasicQuery
operator|)
name|ftcquery
decl_stmt|;
return|return
name|FTC_BASIC_ATTR_COMPARE
argument_list|(
operator|&
name|family
operator|->
name|attrs
argument_list|,
operator|&
name|query
operator|->
name|attrs
argument_list|)
return|;
block|}
end_block
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|ftc_basic_family_init
argument_list|(
argument|FTC_MruNode  ftcfamily
argument_list|,
argument|FT_Pointer   ftcquery
argument_list|,
argument|FT_Pointer   ftccache
argument_list|)
end_macro
begin_block
block|{
name|FTC_BasicFamily
name|family
init|=
operator|(
name|FTC_BasicFamily
operator|)
name|ftcfamily
decl_stmt|;
name|FTC_BasicQuery
name|query
init|=
operator|(
name|FTC_BasicQuery
operator|)
name|ftcquery
decl_stmt|;
name|FTC_Cache
name|cache
init|=
operator|(
name|FTC_Cache
operator|)
name|ftccache
decl_stmt|;
name|FTC_Family_Init
argument_list|(
name|FTC_FAMILY
argument_list|(
name|family
argument_list|)
argument_list|,
name|cache
argument_list|)
expr_stmt|;
name|family
operator|->
name|attrs
operator|=
name|query
operator|->
name|attrs
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_UInt
argument_list|)
end_macro
begin_macro
name|ftc_basic_family_get_count
argument_list|(
argument|FTC_Family   ftcfamily
argument_list|,
argument|FTC_Manager  manager
argument_list|)
end_macro
begin_block
block|{
name|FTC_BasicFamily
name|family
init|=
operator|(
name|FTC_BasicFamily
operator|)
name|ftcfamily
decl_stmt|;
name|FT_Error
name|error
decl_stmt|;
name|FT_Face
name|face
decl_stmt|;
name|FT_UInt
name|result
init|=
literal|0
decl_stmt|;
name|error
operator|=
name|FTC_Manager_LookupFace
argument_list|(
name|manager
argument_list|,
name|family
operator|->
name|attrs
operator|.
name|scaler
operator|.
name|face_id
argument_list|,
operator|&
name|face
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|face
condition|)
return|return
name|result
return|;
if|if
condition|(
operator|(
name|FT_ULong
operator|)
name|face
operator|->
name|num_glyphs
operator|>
name|FT_UINT_MAX
operator|||
literal|0
operator|>
name|face
operator|->
name|num_glyphs
condition|)
name|FT_TRACE1
argument_list|(
operator|(
literal|"ftc_basic_family_get_count:"
literal|" too large number of glyphs in this face, truncated\n"
operator|,
name|face
operator|->
name|num_glyphs
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|result
operator|=
operator|(
name|FT_UInt
operator|)
name|face
operator|->
name|num_glyphs
expr_stmt|;
return|return
name|result
return|;
block|}
end_block
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|ftc_basic_family_load_bitmap
argument_list|(
argument|FTC_Family   ftcfamily
argument_list|,
argument|FT_UInt      gindex
argument_list|,
argument|FTC_Manager  manager
argument_list|,
argument|FT_Face     *aface
argument_list|)
end_macro
begin_block
block|{
name|FTC_BasicFamily
name|family
init|=
operator|(
name|FTC_BasicFamily
operator|)
name|ftcfamily
decl_stmt|;
name|FT_Error
name|error
decl_stmt|;
name|FT_Size
name|size
decl_stmt|;
name|error
operator|=
name|FTC_Manager_LookupSize
argument_list|(
name|manager
argument_list|,
operator|&
name|family
operator|->
name|attrs
operator|.
name|scaler
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|FT_Face
name|face
init|=
name|size
operator|->
name|face
decl_stmt|;
name|error
operator|=
name|FT_Load_Glyph
argument_list|(
name|face
argument_list|,
name|gindex
argument_list|,
name|family
operator|->
name|attrs
operator|.
name|load_flags
operator||
name|FT_LOAD_RENDER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
operator|*
name|aface
operator|=
name|face
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_block
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|ftc_basic_family_load_glyph
argument_list|(
argument|FTC_Family  ftcfamily
argument_list|,
argument|FT_UInt     gindex
argument_list|,
argument|FTC_Cache   cache
argument_list|,
argument|FT_Glyph   *aglyph
argument_list|)
end_macro
begin_block
block|{
name|FTC_BasicFamily
name|family
init|=
operator|(
name|FTC_BasicFamily
operator|)
name|ftcfamily
decl_stmt|;
name|FT_Error
name|error
decl_stmt|;
name|FTC_Scaler
name|scaler
init|=
operator|&
name|family
operator|->
name|attrs
operator|.
name|scaler
decl_stmt|;
name|FT_Face
name|face
decl_stmt|;
name|FT_Size
name|size
decl_stmt|;
comment|/* we will now load the glyph image */
name|error
operator|=
name|FTC_Manager_LookupSize
argument_list|(
name|cache
operator|->
name|manager
argument_list|,
name|scaler
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|face
operator|=
name|size
operator|->
name|face
expr_stmt|;
name|error
operator|=
name|FT_Load_Glyph
argument_list|(
name|face
argument_list|,
name|gindex
argument_list|,
name|family
operator|->
name|attrs
operator|.
name|load_flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|face
operator|->
name|glyph
operator|->
name|format
operator|==
name|FT_GLYPH_FORMAT_BITMAP
operator|||
name|face
operator|->
name|glyph
operator|->
name|format
operator|==
name|FT_GLYPH_FORMAT_OUTLINE
condition|)
block|{
comment|/* ok, copy it */
name|FT_Glyph
name|glyph
decl_stmt|;
name|error
operator|=
name|FT_Get_Glyph
argument_list|(
name|face
operator|->
name|glyph
argument_list|,
operator|&
name|glyph
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
operator|*
name|aglyph
operator|=
name|glyph
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
else|else
name|error
operator|=
name|FT_THROW
argument_list|(
name|Invalid_Argument
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_macro
DECL|function|FT_CALLBACK_DEF
name|FT_CALLBACK_DEF
argument_list|(
argument|FT_Bool
argument_list|)
end_macro
begin_macro
name|ftc_basic_gnode_compare_faceid
argument_list|(
argument|FTC_Node    ftcgnode
argument_list|,
argument|FT_Pointer  ftcface_id
argument_list|,
argument|FTC_Cache   cache
argument_list|,
argument|FT_Bool*    list_changed
argument_list|)
end_macro
begin_block
block|{
name|FTC_GNode
name|gnode
init|=
operator|(
name|FTC_GNode
operator|)
name|ftcgnode
decl_stmt|;
name|FTC_FaceID
name|face_id
init|=
operator|(
name|FTC_FaceID
operator|)
name|ftcface_id
decl_stmt|;
name|FTC_BasicFamily
name|family
init|=
operator|(
name|FTC_BasicFamily
operator|)
name|gnode
operator|->
name|family
decl_stmt|;
name|FT_Bool
name|result
decl_stmt|;
if|if
condition|(
name|list_changed
condition|)
operator|*
name|list_changed
operator|=
name|FALSE
expr_stmt|;
name|result
operator|=
name|FT_BOOL
argument_list|(
name|family
operator|->
name|attrs
operator|.
name|scaler
operator|.
name|face_id
operator|==
name|face_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
block|{
comment|/* we must call this function to avoid this node from appearing        * in later lookups with the same face_id!        */
name|FTC_GNode_UnselectFamily
argument_list|(
name|gnode
argument_list|,
name|cache
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_block
begin_comment
comment|/*   *   * basic image cache   *   */
end_comment
begin_decl_stmt
specifier|static
DECL|variable|ftc_basic_image_family_class
specifier|const
name|FTC_IFamilyClassRec
name|ftc_basic_image_family_class
init|=
block|{
block|{
sizeof|sizeof
argument_list|(
name|FTC_BasicFamilyRec
argument_list|)
block|,
name|ftc_basic_family_compare
block|,
name|ftc_basic_family_init
block|,
literal|0
block|,
comment|/* FTC_MruNode_ResetFunc */
literal|0
comment|/* FTC_MruNode_DoneFunc  */
block|}
block|,
name|ftc_basic_family_load_glyph
block|}
decl_stmt|;
end_decl_stmt
begin_decl_stmt
specifier|static
DECL|variable|ftc_basic_image_cache_class
specifier|const
name|FTC_GCacheClassRec
name|ftc_basic_image_cache_class
init|=
block|{
block|{
name|ftc_inode_new
block|,
name|ftc_inode_weight
block|,
name|ftc_gnode_compare
block|,
name|ftc_basic_gnode_compare_faceid
block|,
name|ftc_inode_free
block|,
sizeof|sizeof
argument_list|(
name|FTC_GCacheRec
argument_list|)
block|,
name|ftc_gcache_init
block|,
name|ftc_gcache_done
block|}
block|,
operator|(
name|FTC_MruListClass
operator|)
operator|&
name|ftc_basic_image_family_class
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* documentation is in ftcache.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FTC_ImageCache_New
argument_list|(
argument|FTC_Manager      manager
argument_list|,
argument|FTC_ImageCache  *acache
argument_list|)
end_macro
begin_block
block|{
return|return
name|FTC_GCache_New
argument_list|(
name|manager
argument_list|,
operator|&
name|ftc_basic_image_cache_class
argument_list|,
operator|(
name|FTC_GCache
operator|*
operator|)
name|acache
argument_list|)
return|;
block|}
end_block
begin_comment
comment|/* documentation is in ftcache.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FTC_ImageCache_Lookup
argument_list|(
argument|FTC_ImageCache  cache
argument_list|,
argument|FTC_ImageType   type
argument_list|,
argument|FT_UInt         gindex
argument_list|,
argument|FT_Glyph       *aglyph
argument_list|,
argument|FTC_Node       *anode
argument_list|)
end_macro
begin_block
block|{
name|FTC_BasicQueryRec
name|query
decl_stmt|;
name|FTC_Node
name|node
init|=
literal|0
decl_stmt|;
comment|/* make compiler happy */
name|FT_Error
name|error
decl_stmt|;
name|FT_PtrDist
name|hash
decl_stmt|;
comment|/* some argument checks are delayed to `FTC_Cache_Lookup' */
if|if
condition|(
operator|!
name|aglyph
condition|)
block|{
name|error
operator|=
name|FT_THROW
argument_list|(
name|Invalid_Argument
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|*
name|aglyph
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|anode
condition|)
operator|*
name|anode
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
call|(
name|FT_ULong
call|)
argument_list|(
name|type
operator|->
name|flags
operator|-
name|FT_INT_MIN
argument_list|)
operator|>
name|FT_UINT_MAX
condition|)
name|FT_TRACE1
argument_list|(
operator|(
literal|"FTC_ImageCache_Lookup:"
literal|" higher bits in load_flags 0x%x are dropped\n"
operator|,
name|type
operator|->
name|flags
operator|&
operator|~
operator|(
operator|(
name|FT_ULong
operator|)
name|FT_UINT_MAX
operator|)
operator|)
argument_list|)
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|face_id
operator|=
name|type
operator|->
name|face_id
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|width
operator|=
name|type
operator|->
name|width
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|height
operator|=
name|type
operator|->
name|height
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|load_flags
operator|=
operator|(
name|FT_UInt
operator|)
name|type
operator|->
name|flags
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|pixel
operator|=
literal|1
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|x_res
operator|=
literal|0
expr_stmt|;
comment|/* make compilers happy */
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|y_res
operator|=
literal|0
expr_stmt|;
name|hash
operator|=
name|FTC_BASIC_ATTR_HASH
argument_list|(
operator|&
name|query
operator|.
name|attrs
argument_list|)
operator|+
name|gindex
expr_stmt|;
if|#
directive|if
literal|1
comment|/* inlining is about 50% faster! */
name|FTC_GCACHE_LOOKUP_CMP
argument_list|(
name|cache
argument_list|,
name|ftc_basic_family_compare
argument_list|,
name|FTC_GNode_Compare
argument_list|,
name|hash
argument_list|,
name|gindex
argument_list|,
operator|&
name|query
argument_list|,
name|node
argument_list|,
name|error
argument_list|)
expr_stmt|;
else|#
directive|else
name|error
operator|=
name|FTC_GCache_Lookup
argument_list|(
name|FTC_GCACHE
argument_list|(
name|cache
argument_list|)
argument_list|,
name|hash
argument_list|,
name|gindex
argument_list|,
name|FTC_GQUERY
argument_list|(
operator|&
name|query
argument_list|)
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|error
condition|)
block|{
operator|*
name|aglyph
operator|=
name|FTC_INODE
argument_list|(
name|node
argument_list|)
operator|->
name|glyph
expr_stmt|;
if|if
condition|(
name|anode
condition|)
block|{
operator|*
name|anode
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|ref_count
operator|++
expr_stmt|;
block|}
block|}
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/* documentation is in ftcache.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FTC_ImageCache_LookupScaler
argument_list|(
argument|FTC_ImageCache  cache
argument_list|,
argument|FTC_Scaler      scaler
argument_list|,
argument|FT_ULong        load_flags
argument_list|,
argument|FT_UInt         gindex
argument_list|,
argument|FT_Glyph       *aglyph
argument_list|,
argument|FTC_Node       *anode
argument_list|)
end_macro
begin_block
block|{
name|FTC_BasicQueryRec
name|query
decl_stmt|;
name|FTC_Node
name|node
init|=
literal|0
decl_stmt|;
comment|/* make compiler happy */
name|FT_Error
name|error
decl_stmt|;
name|FT_PtrDist
name|hash
decl_stmt|;
comment|/* some argument checks are delayed to `FTC_Cache_Lookup' */
if|if
condition|(
operator|!
name|aglyph
operator|||
operator|!
name|scaler
condition|)
block|{
name|error
operator|=
name|FT_THROW
argument_list|(
name|Invalid_Argument
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|*
name|aglyph
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|anode
condition|)
operator|*
name|anode
operator|=
name|NULL
expr_stmt|;
comment|/* `FT_Load_Glyph' and `FT_Load_Char' take FT_UInt flags */
if|if
condition|(
name|load_flags
operator|>
name|FT_UINT_MAX
condition|)
name|FT_TRACE1
argument_list|(
operator|(
literal|"FTC_ImageCache_LookupScaler:"
literal|" higher bits in load_flags 0x%x are dropped\n"
operator|,
name|load_flags
operator|&
operator|~
operator|(
operator|(
name|FT_ULong
operator|)
name|FT_UINT_MAX
operator|)
operator|)
argument_list|)
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|=
name|scaler
index|[
literal|0
index|]
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|load_flags
operator|=
operator|(
name|FT_UInt
operator|)
name|load_flags
expr_stmt|;
name|hash
operator|=
name|FTC_BASIC_ATTR_HASH
argument_list|(
operator|&
name|query
operator|.
name|attrs
argument_list|)
operator|+
name|gindex
expr_stmt|;
name|FTC_GCACHE_LOOKUP_CMP
argument_list|(
name|cache
argument_list|,
name|ftc_basic_family_compare
argument_list|,
name|FTC_GNode_Compare
argument_list|,
name|hash
argument_list|,
name|gindex
argument_list|,
operator|&
name|query
argument_list|,
name|node
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
operator|*
name|aglyph
operator|=
name|FTC_INODE
argument_list|(
name|node
argument_list|)
operator|->
name|glyph
expr_stmt|;
if|if
condition|(
name|anode
condition|)
block|{
operator|*
name|anode
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|ref_count
operator|++
expr_stmt|;
block|}
block|}
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*    *    * basic small bitmap cache    *    */
end_comment
begin_decl_stmt
specifier|static
DECL|variable|ftc_basic_sbit_family_class
specifier|const
name|FTC_SFamilyClassRec
name|ftc_basic_sbit_family_class
init|=
block|{
block|{
sizeof|sizeof
argument_list|(
name|FTC_BasicFamilyRec
argument_list|)
block|,
name|ftc_basic_family_compare
block|,
name|ftc_basic_family_init
block|,
literal|0
block|,
comment|/* FTC_MruNode_ResetFunc */
literal|0
comment|/* FTC_MruNode_DoneFunc  */
block|}
block|,
name|ftc_basic_family_get_count
block|,
name|ftc_basic_family_load_bitmap
block|}
decl_stmt|;
end_decl_stmt
begin_decl_stmt
specifier|static
DECL|variable|ftc_basic_sbit_cache_class
specifier|const
name|FTC_GCacheClassRec
name|ftc_basic_sbit_cache_class
init|=
block|{
block|{
name|ftc_snode_new
block|,
name|ftc_snode_weight
block|,
name|ftc_snode_compare
block|,
name|ftc_basic_gnode_compare_faceid
block|,
name|ftc_snode_free
block|,
sizeof|sizeof
argument_list|(
name|FTC_GCacheRec
argument_list|)
block|,
name|ftc_gcache_init
block|,
name|ftc_gcache_done
block|}
block|,
operator|(
name|FTC_MruListClass
operator|)
operator|&
name|ftc_basic_sbit_family_class
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* documentation is in ftcache.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FTC_SBitCache_New
argument_list|(
argument|FTC_Manager     manager
argument_list|,
argument|FTC_SBitCache  *acache
argument_list|)
end_macro
begin_block
block|{
return|return
name|FTC_GCache_New
argument_list|(
name|manager
argument_list|,
operator|&
name|ftc_basic_sbit_cache_class
argument_list|,
operator|(
name|FTC_GCache
operator|*
operator|)
name|acache
argument_list|)
return|;
block|}
end_block
begin_comment
comment|/* documentation is in ftcache.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FTC_SBitCache_Lookup
argument_list|(
argument|FTC_SBitCache  cache
argument_list|,
argument|FTC_ImageType  type
argument_list|,
argument|FT_UInt        gindex
argument_list|,
argument|FTC_SBit      *ansbit
argument_list|,
argument|FTC_Node      *anode
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|FTC_BasicQueryRec
name|query
decl_stmt|;
name|FTC_Node
name|node
init|=
literal|0
decl_stmt|;
comment|/* make compiler happy */
name|FT_PtrDist
name|hash
decl_stmt|;
if|if
condition|(
name|anode
condition|)
operator|*
name|anode
operator|=
name|NULL
expr_stmt|;
comment|/* other argument checks delayed to `FTC_Cache_Lookup' */
if|if
condition|(
operator|!
name|ansbit
condition|)
return|return
name|FT_THROW
argument_list|(
name|Invalid_Argument
argument_list|)
return|;
operator|*
name|ansbit
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
call|(
name|FT_ULong
call|)
argument_list|(
name|type
operator|->
name|flags
operator|-
name|FT_INT_MIN
argument_list|)
operator|>
name|FT_UINT_MAX
condition|)
name|FT_TRACE1
argument_list|(
operator|(
literal|"FTC_ImageCache_Lookup:"
literal|" higher bits in load_flags 0x%x are dropped\n"
operator|,
name|type
operator|->
name|flags
operator|&
operator|~
operator|(
operator|(
name|FT_ULong
operator|)
name|FT_UINT_MAX
operator|)
operator|)
argument_list|)
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|face_id
operator|=
name|type
operator|->
name|face_id
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|width
operator|=
name|type
operator|->
name|width
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|height
operator|=
name|type
operator|->
name|height
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|load_flags
operator|=
operator|(
name|FT_UInt
operator|)
name|type
operator|->
name|flags
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|pixel
operator|=
literal|1
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|x_res
operator|=
literal|0
expr_stmt|;
comment|/* make compilers happy */
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|.
name|y_res
operator|=
literal|0
expr_stmt|;
comment|/* beware, the hash must be the same for all glyph ranges! */
name|hash
operator|=
name|FTC_BASIC_ATTR_HASH
argument_list|(
operator|&
name|query
operator|.
name|attrs
argument_list|)
operator|+
name|gindex
operator|/
name|FTC_SBIT_ITEMS_PER_NODE
expr_stmt|;
if|#
directive|if
literal|1
comment|/* inlining is about 50% faster! */
name|FTC_GCACHE_LOOKUP_CMP
argument_list|(
name|cache
argument_list|,
name|ftc_basic_family_compare
argument_list|,
name|FTC_SNode_Compare
argument_list|,
name|hash
argument_list|,
name|gindex
argument_list|,
operator|&
name|query
argument_list|,
name|node
argument_list|,
name|error
argument_list|)
expr_stmt|;
else|#
directive|else
name|error
operator|=
name|FTC_GCache_Lookup
argument_list|(
name|FTC_GCACHE
argument_list|(
name|cache
argument_list|)
argument_list|,
name|hash
argument_list|,
name|gindex
argument_list|,
name|FTC_GQUERY
argument_list|(
operator|&
name|query
argument_list|)
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
operator|*
name|ansbit
operator|=
name|FTC_SNODE
argument_list|(
name|node
argument_list|)
operator|->
name|sbits
operator|+
operator|(
name|gindex
operator|-
name|FTC_GNODE
argument_list|(
name|node
argument_list|)
operator|->
name|gindex
operator|)
expr_stmt|;
if|if
condition|(
name|anode
condition|)
block|{
operator|*
name|anode
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|ref_count
operator|++
expr_stmt|;
block|}
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/* documentation is in ftcache.h */
end_comment
begin_macro
DECL|function|FT_EXPORT_DEF
name|FT_EXPORT_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|FTC_SBitCache_LookupScaler
argument_list|(
argument|FTC_SBitCache  cache
argument_list|,
argument|FTC_Scaler     scaler
argument_list|,
argument|FT_ULong       load_flags
argument_list|,
argument|FT_UInt        gindex
argument_list|,
argument|FTC_SBit      *ansbit
argument_list|,
argument|FTC_Node      *anode
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|FTC_BasicQueryRec
name|query
decl_stmt|;
name|FTC_Node
name|node
init|=
literal|0
decl_stmt|;
comment|/* make compiler happy */
name|FT_PtrDist
name|hash
decl_stmt|;
if|if
condition|(
name|anode
condition|)
operator|*
name|anode
operator|=
name|NULL
expr_stmt|;
comment|/* other argument checks delayed to `FTC_Cache_Lookup' */
if|if
condition|(
operator|!
name|ansbit
operator|||
operator|!
name|scaler
condition|)
return|return
name|FT_THROW
argument_list|(
name|Invalid_Argument
argument_list|)
return|;
operator|*
name|ansbit
operator|=
name|NULL
expr_stmt|;
comment|/* `FT_Load_Glyph' and `FT_Load_Char' take FT_UInt flags */
if|if
condition|(
name|load_flags
operator|>
name|FT_UINT_MAX
condition|)
name|FT_TRACE1
argument_list|(
operator|(
literal|"FTC_ImageCache_LookupScaler:"
literal|" higher bits in load_flags 0x%x are dropped\n"
operator|,
name|load_flags
operator|&
operator|~
operator|(
operator|(
name|FT_ULong
operator|)
name|FT_UINT_MAX
operator|)
operator|)
argument_list|)
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|scaler
operator|=
name|scaler
index|[
literal|0
index|]
expr_stmt|;
name|query
operator|.
name|attrs
operator|.
name|load_flags
operator|=
operator|(
name|FT_UInt
operator|)
name|load_flags
expr_stmt|;
comment|/* beware, the hash must be the same for all glyph ranges! */
name|hash
operator|=
name|FTC_BASIC_ATTR_HASH
argument_list|(
operator|&
name|query
operator|.
name|attrs
argument_list|)
operator|+
name|gindex
operator|/
name|FTC_SBIT_ITEMS_PER_NODE
expr_stmt|;
name|FTC_GCACHE_LOOKUP_CMP
argument_list|(
name|cache
argument_list|,
name|ftc_basic_family_compare
argument_list|,
name|FTC_SNode_Compare
argument_list|,
name|hash
argument_list|,
name|gindex
argument_list|,
operator|&
name|query
argument_list|,
name|node
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
operator|*
name|ansbit
operator|=
name|FTC_SNODE
argument_list|(
name|node
argument_list|)
operator|->
name|sbits
operator|+
operator|(
name|gindex
operator|-
name|FTC_GNODE
argument_list|(
name|node
argument_list|)
operator|->
name|gindex
operator|)
expr_stmt|;
if|if
condition|(
name|anode
condition|)
block|{
operator|*
name|anode
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|ref_count
operator|++
expr_stmt|;
block|}
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/* END */
end_comment
end_unit
