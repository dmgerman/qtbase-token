begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  gxvtrak.c                                                              */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    TrueTypeGX/AAT trak table validation (body).                         */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2004, 2005 by suzuki toshiya, Masatake YAMATO, Red Hat K.K., */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/* gxvalid is derived from both gxlayout module and otvalid module.        */
end_comment
begin_comment
comment|/* Development of gxlayout is supported by the Information-technology      */
end_comment
begin_comment
comment|/* Promotion Agency(IPA), Japan.                                           */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"gxvalid.h"
end_include
begin_include
include|#
directive|include
file|"gxvcommn.h"
end_include
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */
end_comment
begin_comment
comment|/* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */
end_comment
begin_comment
comment|/* messages during execution.                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_undef
DECL|macro|FT_COMPONENT
undef|#
directive|undef
name|FT_COMPONENT
end_undef
begin_define
DECL|macro|FT_COMPONENT
define|#
directive|define
name|FT_COMPONENT
value|trace_gxvtrak
end_define
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*****                      Data and Types                           *****/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*      * referred track table format specification:      * http://developer.apple.com/fonts/TTRefMan/RM06/Chap6trak.html      * last update was 1996.      * ----------------------------------------------      * [MINIMUM HEADER]: GXV_TRAK_SIZE_MIN      * version          (fixed:  32bit) = 0x00010000      * format           (uint16: 16bit) = 0 is only defined (1996)      * horizOffset      (uint16: 16bit)      * vertOffset       (uint16: 16bit)      * reserved         (uint16: 16bit) = 0      * ----------------------------------------------      * [VARIABLE BODY]:      * horizData      *   header         ( 2 + 2 + 4      *   trackTable       + nTracks * ( 4 + 2 + 2 )      *   sizeTable        + nSizes * 4 )      * ----------------------------------------------      * vertData      *   header         ( 2 + 2 + 4      *   trackTable       + nTracks * ( 4 + 2 + 2 )      *   sizeTable        + nSizes * 4 )      * ----------------------------------------------      */
end_comment
begin_typedef
DECL|struct|GXV_trak_DataRec_
typedef|typedef
struct|struct
name|GXV_trak_DataRec_
block|{
DECL|member|trackValueOffset_min
name|FT_UShort
name|trackValueOffset_min
decl_stmt|;
DECL|member|trackValueOffset_max
name|FT_UShort
name|trackValueOffset_max
decl_stmt|;
block|}
DECL|typedef|GXV_trak_DataRec
DECL|typedef|GXV_trak_Data
name|GXV_trak_DataRec
operator|,
typedef|*
name|GXV_trak_Data
typedef|;
end_typedef
begin_define
DECL|macro|GXV_TRAK_DATA
define|#
directive|define
name|GXV_TRAK_DATA
parameter_list|(
name|FIELD
parameter_list|)
value|GXV_TABLE_DATA( trak, FIELD )
end_define
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*****                      UTILITY FUNCTIONS                        *****/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_function
specifier|static
name|void
DECL|function|gxv_trak_trackTable_validate
name|gxv_trak_trackTable_validate
parameter_list|(
name|FT_Bytes
name|table
parameter_list|,
name|FT_Bytes
name|limit
parameter_list|,
name|FT_UShort
name|nTracks
parameter_list|,
name|GXV_Validator
name|gxvalid
parameter_list|)
block|{
name|FT_Bytes
name|p
init|=
name|table
decl_stmt|;
name|FT_Fixed
name|track
decl_stmt|,
name|t
decl_stmt|;
name|FT_UShort
name|nameIndex
decl_stmt|;
name|FT_UShort
name|offset
decl_stmt|;
name|FT_UShort
name|i
decl_stmt|,
name|j
decl_stmt|;
name|GXV_NAME_ENTER
argument_list|(
literal|"trackTable"
argument_list|)
expr_stmt|;
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_min
argument_list|)
operator|=
literal|0xFFFFU
expr_stmt|;
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_max
argument_list|)
operator|=
literal|0x0000
expr_stmt|;
name|GXV_LIMIT_CHECK
argument_list|(
name|nTracks
operator|*
operator|(
literal|4
operator|+
literal|2
operator|+
literal|2
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nTracks
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
name|table
operator|+
name|i
operator|*
operator|(
literal|4
operator|+
literal|2
operator|+
literal|2
operator|)
expr_stmt|;
name|track
operator|=
name|FT_NEXT_LONG
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|nameIndex
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|<
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_min
argument_list|)
condition|)
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_min
argument_list|)
operator|=
name|offset
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_max
argument_list|)
condition|)
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_max
argument_list|)
operator|=
name|offset
expr_stmt|;
name|gxv_sfntName_validate
argument_list|(
name|nameIndex
argument_list|,
literal|256
argument_list|,
literal|32767
argument_list|,
name|gxvalid
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
name|i
init|;
name|j
operator|<
name|nTracks
condition|;
name|j
operator|++
control|)
block|{
name|p
operator|=
name|table
operator|+
name|j
operator|*
operator|(
literal|4
operator|+
literal|2
operator|+
literal|2
operator|)
expr_stmt|;
name|t
operator|=
name|FT_NEXT_LONG
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|track
condition|)
name|GXV_TRACE
argument_list|(
operator|(
literal|"duplicated entries found for track value 0x%x\n"
operator|,
name|track
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|gxvalid
operator|->
name|subtable_length
operator|=
name|p
operator|-
name|table
expr_stmt|;
name|GXV_EXIT
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|gxv_trak_trackData_validate
name|gxv_trak_trackData_validate
parameter_list|(
name|FT_Bytes
name|table
parameter_list|,
name|FT_Bytes
name|limit
parameter_list|,
name|GXV_Validator
name|gxvalid
parameter_list|)
block|{
name|FT_Bytes
name|p
init|=
name|table
decl_stmt|;
name|FT_UShort
name|nTracks
decl_stmt|;
name|FT_UShort
name|nSizes
decl_stmt|;
name|FT_ULong
name|sizeTableOffset
decl_stmt|;
name|GXV_ODTECT
argument_list|(
literal|4
argument_list|,
name|odtect
argument_list|)
expr_stmt|;
name|GXV_ODTECT_INIT
argument_list|(
name|odtect
argument_list|)
expr_stmt|;
name|GXV_NAME_ENTER
argument_list|(
literal|"trackData"
argument_list|)
expr_stmt|;
comment|/* read the header of trackData */
name|GXV_LIMIT_CHECK
argument_list|(
literal|2
operator|+
literal|2
operator|+
literal|4
argument_list|)
expr_stmt|;
name|nTracks
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|nSizes
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|sizeTableOffset
operator|=
name|FT_NEXT_ULONG
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|gxv_odtect_add_range
argument_list|(
name|table
argument_list|,
name|p
operator|-
name|table
argument_list|,
literal|"trackData header"
argument_list|,
name|odtect
argument_list|)
expr_stmt|;
comment|/* validate trackTable */
name|gxv_trak_trackTable_validate
argument_list|(
name|p
argument_list|,
name|limit
argument_list|,
name|nTracks
argument_list|,
name|gxvalid
argument_list|)
expr_stmt|;
name|gxv_odtect_add_range
argument_list|(
name|p
argument_list|,
name|gxvalid
operator|->
name|subtable_length
argument_list|,
literal|"trackTable"
argument_list|,
name|odtect
argument_list|)
expr_stmt|;
comment|/* sizeTable is array of FT_Fixed, don't check contents */
name|p
operator|=
name|gxvalid
operator|->
name|root
operator|->
name|base
operator|+
name|sizeTableOffset
expr_stmt|;
name|GXV_LIMIT_CHECK
argument_list|(
name|nSizes
operator|*
literal|4
argument_list|)
expr_stmt|;
name|gxv_odtect_add_range
argument_list|(
name|p
argument_list|,
name|nSizes
operator|*
literal|4
argument_list|,
literal|"sizeTable"
argument_list|,
name|odtect
argument_list|)
expr_stmt|;
comment|/* validate trackValueOffet */
name|p
operator|=
name|gxvalid
operator|->
name|root
operator|->
name|base
operator|+
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|limit
operator|-
name|p
operator|<
name|nTracks
operator|*
name|nSizes
operator|*
literal|2
condition|)
name|GXV_TRACE
argument_list|(
operator|(
literal|"too short trackValue array\n"
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
name|gxvalid
operator|->
name|root
operator|->
name|base
operator|+
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_max
argument_list|)
expr_stmt|;
name|GXV_LIMIT_CHECK
argument_list|(
name|nSizes
operator|*
literal|2
argument_list|)
expr_stmt|;
name|gxv_odtect_add_range
argument_list|(
name|gxvalid
operator|->
name|root
operator|->
name|base
operator|+
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_min
argument_list|)
argument_list|,
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_max
argument_list|)
operator|-
name|GXV_TRAK_DATA
argument_list|(
name|trackValueOffset_min
argument_list|)
operator|+
name|nSizes
operator|*
literal|2
argument_list|,
literal|"trackValue array"
argument_list|,
name|odtect
argument_list|)
expr_stmt|;
name|gxv_odtect_validate
argument_list|(
name|odtect
argument_list|,
name|gxvalid
argument_list|)
expr_stmt|;
name|GXV_EXIT
expr_stmt|;
block|}
end_function
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*****                          trak TABLE                           *****/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|gxv_trak_validate
name|gxv_trak_validate
argument_list|(
argument|FT_Bytes      table
argument_list|,
argument|FT_Face       face
argument_list|,
argument|FT_Validator  ftvalid
argument_list|)
end_macro
begin_block
block|{
name|FT_Bytes
name|p
init|=
name|table
decl_stmt|;
name|FT_Bytes
name|limit
init|=
literal|0
decl_stmt|;
name|GXV_ValidatorRec
name|gxvalidrec
decl_stmt|;
name|GXV_Validator
name|gxvalid
init|=
operator|&
name|gxvalidrec
decl_stmt|;
name|GXV_trak_DataRec
name|trakrec
decl_stmt|;
name|GXV_trak_Data
name|trak
init|=
operator|&
name|trakrec
decl_stmt|;
name|FT_ULong
name|version
decl_stmt|;
name|FT_UShort
name|format
decl_stmt|;
name|FT_UShort
name|horizOffset
decl_stmt|;
name|FT_UShort
name|vertOffset
decl_stmt|;
name|FT_UShort
name|reserved
decl_stmt|;
name|GXV_ODTECT
argument_list|(
literal|3
argument_list|,
name|odtect
argument_list|)
expr_stmt|;
name|GXV_ODTECT_INIT
argument_list|(
name|odtect
argument_list|)
expr_stmt|;
name|gxvalid
operator|->
name|root
operator|=
name|ftvalid
expr_stmt|;
name|gxvalid
operator|->
name|table_data
operator|=
name|trak
expr_stmt|;
name|gxvalid
operator|->
name|face
operator|=
name|face
expr_stmt|;
name|limit
operator|=
name|gxvalid
operator|->
name|root
operator|->
name|limit
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"validating `trak' table\n"
operator|)
argument_list|)
expr_stmt|;
name|GXV_INIT
expr_stmt|;
name|GXV_LIMIT_CHECK
argument_list|(
literal|4
operator|+
literal|2
operator|+
literal|2
operator|+
literal|2
operator|+
literal|2
argument_list|)
expr_stmt|;
name|version
operator|=
name|FT_NEXT_ULONG
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|format
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|horizOffset
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|vertOffset
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|reserved
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|GXV_TRACE
argument_list|(
operator|(
literal|" (version = 0x%08x)\n"
operator|,
name|version
operator|)
argument_list|)
expr_stmt|;
name|GXV_TRACE
argument_list|(
operator|(
literal|" (format = 0x%04x)\n"
operator|,
name|format
operator|)
argument_list|)
expr_stmt|;
name|GXV_TRACE
argument_list|(
operator|(
literal|" (horizOffset = 0x%04x)\n"
operator|,
name|horizOffset
operator|)
argument_list|)
expr_stmt|;
name|GXV_TRACE
argument_list|(
operator|(
literal|" (vertOffset = 0x%04x)\n"
operator|,
name|vertOffset
operator|)
argument_list|)
expr_stmt|;
name|GXV_TRACE
argument_list|(
operator|(
literal|" (reserved = 0x%04x)\n"
operator|,
name|reserved
operator|)
argument_list|)
expr_stmt|;
comment|/* Version 1.0 (always:1996) */
if|if
condition|(
name|version
operator|!=
literal|0x00010000UL
condition|)
name|FT_INVALID_FORMAT
expr_stmt|;
comment|/* format 0 (always:1996) */
if|if
condition|(
name|format
operator|!=
literal|0x0000
condition|)
name|FT_INVALID_FORMAT
expr_stmt|;
name|GXV_32BIT_ALIGNMENT_VALIDATE
argument_list|(
name|horizOffset
argument_list|)
expr_stmt|;
name|GXV_32BIT_ALIGNMENT_VALIDATE
argument_list|(
name|vertOffset
argument_list|)
expr_stmt|;
comment|/* Reserved Fixed Value (always) */
if|if
condition|(
name|reserved
operator|!=
literal|0x0000
condition|)
name|FT_INVALID_DATA
expr_stmt|;
comment|/* validate trackData */
if|if
condition|(
literal|0
operator|<
name|horizOffset
condition|)
block|{
name|gxv_trak_trackData_validate
argument_list|(
name|table
operator|+
name|horizOffset
argument_list|,
name|limit
argument_list|,
name|gxvalid
argument_list|)
expr_stmt|;
name|gxv_odtect_add_range
argument_list|(
name|table
operator|+
name|horizOffset
argument_list|,
name|gxvalid
operator|->
name|subtable_length
argument_list|,
literal|"horizJustData"
argument_list|,
name|odtect
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
literal|0
operator|<
name|vertOffset
condition|)
block|{
name|gxv_trak_trackData_validate
argument_list|(
name|table
operator|+
name|vertOffset
argument_list|,
name|limit
argument_list|,
name|gxvalid
argument_list|)
expr_stmt|;
name|gxv_odtect_add_range
argument_list|(
name|table
operator|+
name|vertOffset
argument_list|,
name|gxvalid
operator|->
name|subtable_length
argument_list|,
literal|"vertJustData"
argument_list|,
name|odtect
argument_list|)
expr_stmt|;
block|}
name|gxv_odtect_validate
argument_list|(
name|odtect
argument_list|,
name|gxvalid
argument_list|)
expr_stmt|;
name|FT_TRACE4
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_block
begin_comment
comment|/* END */
end_comment
end_unit
