begin_unit
begin_comment
comment|/*  * gcc -DFT2_BUILD_LIBRARY -I../../include -o test_afm test_afm.c \  *     -L../../objs/.libs -lfreetype -lz -static  */
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_FREETYPE_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_STREAM_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_POSTSCRIPT_AUX_H
end_include
begin_function
DECL|function|dump_fontinfo
name|void
name|dump_fontinfo
parameter_list|(
name|AFM_FontInfo
name|fi
parameter_list|)
block|{
name|FT_Int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"This AFM is for %sCID font.\n\n"
argument_list|,
operator|(
name|fi
operator|->
name|IsCIDFont
operator|)
condition|?
literal|""
else|:
literal|"non-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"FontBBox: %.2f %.2f %.2f %.2f\n"
argument_list|,
name|fi
operator|->
name|FontBBox
operator|.
name|xMin
operator|/
literal|65536.
argument_list|,
name|fi
operator|->
name|FontBBox
operator|.
name|yMin
operator|/
literal|65536.
argument_list|,
name|fi
operator|->
name|FontBBox
operator|.
name|xMax
operator|/
literal|65536.
argument_list|,
name|fi
operator|->
name|FontBBox
operator|.
name|yMax
operator|/
literal|65536.
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Ascender: %.2f\n"
argument_list|,
name|fi
operator|->
name|Ascender
operator|/
literal|65536.
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Descender: %.2f\n\n"
argument_list|,
name|fi
operator|->
name|Descender
operator|/
literal|65536.
argument_list|)
expr_stmt|;
if|if
condition|(
name|fi
operator|->
name|NumTrackKern
condition|)
name|printf
argument_list|(
literal|"There are %d sets of track kernings:\n"
argument_list|,
name|fi
operator|->
name|NumTrackKern
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"There is no track kerning.\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fi
operator|->
name|NumTrackKern
condition|;
name|i
operator|++
control|)
block|{
name|AFM_TrackKern
name|tk
init|=
name|fi
operator|->
name|TrackKerns
operator|+
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"\t%2d: %5.2f %5.2f %5.2f %5.2f\n"
argument_list|,
name|tk
operator|->
name|degree
argument_list|,
name|tk
operator|->
name|min_ptsize
operator|/
literal|65536.
argument_list|,
name|tk
operator|->
name|min_kern
operator|/
literal|65536.
argument_list|,
name|tk
operator|->
name|max_ptsize
operator|/
literal|65536.
argument_list|,
name|tk
operator|->
name|max_kern
operator|/
literal|65536.
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fi
operator|->
name|NumKernPair
condition|)
name|printf
argument_list|(
literal|"There are %d kerning pairs:\n"
argument_list|,
name|fi
operator|->
name|NumKernPair
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"There is no kerning pair.\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fi
operator|->
name|NumKernPair
condition|;
name|i
operator|++
control|)
block|{
name|AFM_KernPair
name|kp
init|=
name|fi
operator|->
name|KernPairs
operator|+
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"\t%3d + %3d => (%4d, %4d)\n"
argument_list|,
name|kp
operator|->
name|index1
argument_list|,
name|kp
operator|->
name|index2
argument_list|,
name|kp
operator|->
name|x
argument_list|,
name|kp
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
name|int
DECL|function|dummy_get_index
name|dummy_get_index
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|FT_Offset
name|len
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
if|if
condition|(
name|len
condition|)
return|return
name|name
index|[
literal|0
index|]
return|;
else|else
return|return
literal|0
return|;
block|}
end_function
begin_function
name|FT_Error
DECL|function|parse_afm
name|parse_afm
parameter_list|(
name|FT_Library
name|library
parameter_list|,
name|FT_Stream
name|stream
parameter_list|,
name|AFM_FontInfo
name|fi
parameter_list|)
block|{
name|PSAux_Service
name|psaux
decl_stmt|;
name|AFM_ParserRec
name|parser
decl_stmt|;
name|FT_Error
name|error
init|=
name|FT_Err_Ok
decl_stmt|;
name|psaux
operator|=
operator|(
name|PSAux_Service
operator|)
name|FT_Get_Module_Interface
argument_list|(
name|library
argument_list|,
literal|"psaux"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|psaux
operator|||
operator|!
name|psaux
operator|->
name|afm_parser_funcs
condition|)
return|return
operator|-
literal|1
return|;
name|error
operator|=
name|FT_Stream_EnterFrame
argument_list|(
name|stream
argument_list|,
name|stream
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|error
operator|=
name|psaux
operator|->
name|afm_parser_funcs
operator|->
name|init
argument_list|(
operator|&
name|parser
argument_list|,
name|library
operator|->
name|memory
argument_list|,
name|stream
operator|->
name|cursor
argument_list|,
name|stream
operator|->
name|limit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|parser
operator|.
name|FontInfo
operator|=
name|fi
expr_stmt|;
name|parser
operator|.
name|get_index
operator|=
name|dummy_get_index
expr_stmt|;
name|error
operator|=
name|psaux
operator|->
name|afm_parser_funcs
operator|->
name|parse
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|psaux
operator|->
name|afm_parser_funcs
operator|->
name|done
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function
begin_function
DECL|function|main
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FT_Library
name|library
decl_stmt|;
name|FT_StreamRec
name|stream
decl_stmt|;
name|FT_Error
name|error
init|=
name|FT_Err_Ok
decl_stmt|;
name|AFM_FontInfoRec
name|fi
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
return|return
name|FT_Err_Invalid_Argument
return|;
name|error
operator|=
name|FT_Init_FreeType
argument_list|(
operator|&
name|library
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|FT_ZERO
argument_list|(
operator|&
name|stream
argument_list|)
expr_stmt|;
name|error
operator|=
name|FT_Stream_Open
argument_list|(
operator|&
name|stream
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
name|stream
operator|.
name|memory
operator|=
name|library
operator|->
name|memory
expr_stmt|;
name|FT_ZERO
argument_list|(
operator|&
name|fi
argument_list|)
expr_stmt|;
name|error
operator|=
name|parse_afm
argument_list|(
name|library
argument_list|,
operator|&
name|stream
argument_list|,
operator|&
name|fi
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|FT_Memory
name|memory
init|=
name|library
operator|->
name|memory
decl_stmt|;
name|dump_fontinfo
argument_list|(
operator|&
name|fi
argument_list|)
expr_stmt|;
if|if
condition|(
name|fi
operator|.
name|KernPairs
condition|)
name|FT_FREE
argument_list|(
name|fi
operator|.
name|KernPairs
argument_list|)
expr_stmt|;
if|if
condition|(
name|fi
operator|.
name|TrackKerns
condition|)
name|FT_FREE
argument_list|(
name|fi
operator|.
name|TrackKerns
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"parse error\n"
argument_list|)
expr_stmt|;
name|FT_Stream_Close
argument_list|(
operator|&
name|stream
argument_list|)
expr_stmt|;
name|Exit
label|:
name|FT_Done_FreeType
argument_list|(
name|library
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function
end_unit
