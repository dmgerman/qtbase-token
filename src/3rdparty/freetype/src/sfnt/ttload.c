begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  ttload.c                                                               */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    Load the basic TrueType tables, i.e., tables that can be either in   */
end_comment
begin_comment
comment|/*    TTF or OTF fonts (body).                                             */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 1996-2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009 by */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_DEBUG_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_STREAM_H
end_include
begin_include
include|#
directive|include
include|FT_TRUETYPE_TAGS_H
end_include
begin_include
include|#
directive|include
file|"ttload.h"
end_include
begin_include
include|#
directive|include
file|"sferrors.h"
end_include
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */
end_comment
begin_comment
comment|/* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */
end_comment
begin_comment
comment|/* messages during execution.                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_undef
DECL|macro|FT_COMPONENT
undef|#
directive|undef
name|FT_COMPONENT
end_undef
begin_define
DECL|macro|FT_COMPONENT
define|#
directive|define
name|FT_COMPONENT
value|trace_ttload
end_define
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_lookup_table                                               */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Looks for a TrueType table by name.                                */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face :: A face object handle.                                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    tag  :: The searched tag.                                          */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    A pointer to the table directory entry.  0 if not found.           */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|TT_Table
argument_list|)
end_macro
begin_macro
name|tt_face_lookup_table
argument_list|(
argument|TT_Face   face
argument_list|,
argument|FT_ULong  tag
argument_list|)
end_macro
begin_block
block|{
name|TT_Table
name|entry
decl_stmt|;
name|TT_Table
name|limit
decl_stmt|;
ifdef|#
directive|ifdef
name|FT_DEBUG_LEVEL_TRACE
name|FT_Bool
name|zero_length
init|=
name|FALSE
decl_stmt|;
endif|#
directive|endif
name|FT_TRACE4
argument_list|(
operator|(
literal|"tt_face_lookup_table: %08p, `%c%c%c%c' -- "
operator|,
name|face
operator|,
call|(
name|FT_Char
call|)
argument_list|(
name|tag
operator|>>
literal|24
argument_list|)
operator|,
call|(
name|FT_Char
call|)
argument_list|(
name|tag
operator|>>
literal|16
argument_list|)
operator|,
call|(
name|FT_Char
call|)
argument_list|(
name|tag
operator|>>
literal|8
argument_list|)
operator|,
call|(
name|FT_Char
call|)
argument_list|(
name|tag
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|entry
operator|=
name|face
operator|->
name|dir_tables
expr_stmt|;
name|limit
operator|=
name|entry
operator|+
name|face
operator|->
name|num_tables
expr_stmt|;
for|for
control|(
init|;
name|entry
operator|<
name|limit
condition|;
name|entry
operator|++
control|)
block|{
comment|/* For compatibility with Windows, we consider    */
comment|/* zero-length tables the same as missing tables. */
if|if
condition|(
name|entry
operator|->
name|Tag
operator|==
name|tag
condition|)
block|{
if|if
condition|(
name|entry
operator|->
name|Length
operator|!=
literal|0
condition|)
block|{
name|FT_TRACE4
argument_list|(
operator|(
literal|"found table.\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|entry
return|;
block|}
ifdef|#
directive|ifdef
name|FT_DEBUG_LEVEL_TRACE
name|zero_length
operator|=
name|TRUE
expr_stmt|;
endif|#
directive|endif
block|}
block|}
ifdef|#
directive|ifdef
name|FT_DEBUG_LEVEL_TRACE
if|if
condition|(
name|zero_length
condition|)
name|FT_TRACE4
argument_list|(
operator|(
literal|"ignoring empty table\n"
operator|)
argument_list|)
expr_stmt|;
else|else
name|FT_TRACE4
argument_list|(
operator|(
literal|"could not find table\n"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|NULL
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_goto_table                                                 */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Looks for a TrueType table by name, then seek a stream to it.      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: A face object handle.                                    */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    tag    :: The searched tag.                                        */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream :: The stream to seek when the table is found.              */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Output>                                                              */
end_comment
begin_comment
comment|/*    length :: The length of the table if found, undefined otherwise.   */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_goto_table
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_ULong   tag
argument_list|,
argument|FT_Stream  stream
argument_list|,
argument|FT_ULong*  length
argument_list|)
end_macro
begin_block
block|{
name|TT_Table
name|table
decl_stmt|;
name|FT_Error
name|error
decl_stmt|;
name|table
operator|=
name|tt_face_lookup_table
argument_list|(
name|face
argument_list|,
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
condition|)
block|{
if|if
condition|(
name|length
condition|)
operator|*
name|length
operator|=
name|table
operator|->
name|Length
expr_stmt|;
if|if
condition|(
name|FT_STREAM_SEEK
argument_list|(
name|table
operator|->
name|Offset
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
block|}
else|else
name|error
operator|=
name|SFNT_Err_Table_Missing
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/* Here, we                                                         */
end_comment
begin_comment
comment|/*                                                                  */
end_comment
begin_comment
comment|/* - check that `num_tables' is valid (and adjust it if necessary)  */
end_comment
begin_comment
comment|/*                                                                  */
end_comment
begin_comment
comment|/* - look for a `head' table, check its size, and parse it to check */
end_comment
begin_comment
comment|/*   whether its `magic' field is correctly set                     */
end_comment
begin_comment
comment|/*                                                                  */
end_comment
begin_comment
comment|/* - errors (except errors returned by stream handling)             */
end_comment
begin_comment
comment|/*                                                                  */
end_comment
begin_comment
comment|/*     SFNT_Err_Unknown_File_Format:                                */
end_comment
begin_comment
comment|/*       no table is defined in directory, it is not sfnt-wrapped   */
end_comment
begin_comment
comment|/*       data                                                       */
end_comment
begin_comment
comment|/*     SFNT_Err_Table_Missing:                                      */
end_comment
begin_comment
comment|/*       table directory is valid, but essential tables             */
end_comment
begin_comment
comment|/*       (head/bhed/SING) are missing                               */
end_comment
begin_comment
comment|/*                                                                  */
end_comment
begin_function
specifier|static
name|FT_Error
DECL|function|check_table_dir
name|check_table_dir
parameter_list|(
name|SFNT_Header
name|sfnt
parameter_list|,
name|FT_Stream
name|stream
parameter_list|)
block|{
name|FT_Error
name|error
decl_stmt|;
name|FT_UShort
name|nn
decl_stmt|,
name|valid_entries
init|=
literal|0
decl_stmt|;
name|FT_UInt
name|has_head
init|=
literal|0
decl_stmt|,
name|has_sing
init|=
literal|0
decl_stmt|,
name|has_meta
init|=
literal|0
decl_stmt|;
name|FT_ULong
name|offset
init|=
name|sfnt
operator|->
name|offset
operator|+
literal|12
decl_stmt|;
specifier|static
specifier|const
name|FT_Frame_Field
name|table_dir_entry_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|TT_TableRec
name|FT_FRAME_START
argument_list|(
literal|16
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|Tag
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|CheckSum
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|Offset
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|Length
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
if|if
condition|(
name|FT_STREAM_SEEK
argument_list|(
name|offset
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
for|for
control|(
name|nn
operator|=
literal|0
init|;
name|nn
operator|<
name|sfnt
operator|->
name|num_tables
condition|;
name|nn
operator|++
control|)
block|{
name|TT_TableRec
name|table
decl_stmt|;
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|table_dir_entry_fields
argument_list|,
operator|&
name|table
argument_list|)
condition|)
block|{
name|nn
operator|--
expr_stmt|;
name|FT_TRACE2
argument_list|(
operator|(
literal|"check_table_dir:"
literal|" can read only %d table%s in font (instead of %d)\n"
operator|,
name|nn
operator|,
name|nn
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
operator|,
name|sfnt
operator|->
name|num_tables
operator|)
argument_list|)
expr_stmt|;
name|sfnt
operator|->
name|num_tables
operator|=
name|nn
expr_stmt|;
break|break;
block|}
comment|/* we ignore invalid tables */
if|if
condition|(
name|table
operator|.
name|Offset
operator|+
name|table
operator|.
name|Length
operator|>
name|stream
operator|->
name|size
condition|)
block|{
name|FT_TRACE2
argument_list|(
operator|(
literal|"check_table_dir: table entry %d invalid\n"
operator|,
name|nn
operator|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
else|else
name|valid_entries
operator|++
expr_stmt|;
if|if
condition|(
name|table
operator|.
name|Tag
operator|==
name|TTAG_head
operator|||
name|table
operator|.
name|Tag
operator|==
name|TTAG_bhed
condition|)
block|{
name|FT_UInt32
name|magic
decl_stmt|;
ifndef|#
directive|ifndef
name|TT_CONFIG_OPTION_EMBEDDED_BITMAPS
if|if
condition|(
name|table
operator|.
name|Tag
operator|==
name|TTAG_head
condition|)
endif|#
directive|endif
name|has_head
operator|=
literal|1
expr_stmt|;
comment|/*          * The table length should be 0x36, but certain font tools make it          * 0x38, so we will just check that it is greater.          *          * Note that according to the specification, the table must be          * padded to 32-bit lengths, but this doesn't apply to the value of          * its `Length' field!          *          */
if|if
condition|(
name|table
operator|.
name|Length
operator|<
literal|0x36
condition|)
block|{
name|FT_TRACE2
argument_list|(
operator|(
literal|"check_table_dir: `head' table too small\n"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|SFNT_Err_Table_Missing
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|FT_STREAM_SEEK
argument_list|(
name|table
operator|.
name|Offset
operator|+
literal|12
argument_list|)
operator|||
name|FT_READ_ULONG
argument_list|(
name|magic
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|magic
operator|!=
literal|0x5F0F3CF5UL
condition|)
block|{
name|FT_TRACE2
argument_list|(
operator|(
literal|"check_table_dir:"
literal|" no magic number found in `head' table\n"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|SFNT_Err_Table_Missing
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|FT_STREAM_SEEK
argument_list|(
name|offset
operator|+
operator|(
name|nn
operator|+
literal|1
operator|)
operator|*
literal|16
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
block|}
elseif|else
if|if
condition|(
name|table
operator|.
name|Tag
operator|==
name|TTAG_SING
condition|)
name|has_sing
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|table
operator|.
name|Tag
operator|==
name|TTAG_META
condition|)
name|has_meta
operator|=
literal|1
expr_stmt|;
block|}
name|sfnt
operator|->
name|num_tables
operator|=
name|valid_entries
expr_stmt|;
if|if
condition|(
name|sfnt
operator|->
name|num_tables
operator|==
literal|0
condition|)
block|{
name|FT_TRACE2
argument_list|(
operator|(
literal|"check_table_dir: no tables found\n"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|SFNT_Err_Unknown_File_Format
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* if `sing' and `meta' tables are present, there is no `head' table */
if|if
condition|(
name|has_head
operator|||
operator|(
name|has_sing
operator|&&
name|has_meta
operator|)
condition|)
block|{
name|error
operator|=
name|SFNT_Err_Ok
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
else|else
block|{
name|FT_TRACE2
argument_list|(
operator|(
literal|"check_table_dir:"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TT_CONFIG_OPTION_EMBEDDED_BITMAPS
name|FT_TRACE2
argument_list|(
operator|(
literal|" neither `head', `bhed', nor `sing' table found\n"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|FT_TRACE2
argument_list|(
operator|(
literal|" neither `head' nor `sing' table found\n"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|error
operator|=
name|SFNT_Err_Table_Missing
expr_stmt|;
block|}
name|Exit
label|:
return|return
name|error
return|;
block|}
end_function
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_font_dir                                              */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads the header of a SFNT font file.                              */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face       :: A handle to the target face object.                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream     :: The input stream.                                    */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Output>                                                              */
end_comment
begin_comment
comment|/*    sfnt       :: The SFNT header.                                     */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Note>                                                                */
end_comment
begin_comment
comment|/*    The stream cursor must be at the beginning of the font directory.  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_font_dir
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
name|SFNT_HeaderRec
name|sfnt
decl_stmt|;
name|FT_Error
name|error
decl_stmt|;
name|FT_Memory
name|memory
init|=
name|stream
operator|->
name|memory
decl_stmt|;
name|TT_TableRec
modifier|*
name|entry
decl_stmt|;
name|FT_Int
name|nn
decl_stmt|;
specifier|static
specifier|const
name|FT_Frame_Field
name|offset_table_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|SFNT_HeaderRec
name|FT_FRAME_START
argument_list|(
literal|8
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|num_tables
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|search_range
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|entry_selector
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|range_shift
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
name|FT_TRACE2
argument_list|(
operator|(
literal|"tt_face_load_font_dir: %08p\n"
operator|,
name|face
operator|)
argument_list|)
expr_stmt|;
comment|/* read the offset table */
name|sfnt
operator|.
name|offset
operator|=
name|FT_STREAM_POS
argument_list|()
expr_stmt|;
if|if
condition|(
name|FT_READ_ULONG
argument_list|(
name|sfnt
operator|.
name|format_tag
argument_list|)
operator|||
name|FT_STREAM_READ_FIELDS
argument_list|(
name|offset_table_fields
argument_list|,
operator|&
name|sfnt
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
comment|/* many fonts don't have these fields set correctly */
if|#
directive|if
literal|0
block|if ( sfnt.search_range != 1<< ( sfnt.entry_selector + 4 )        ||          sfnt.search_range + sfnt.range_shift != sfnt.num_tables<< 4 )       return SFNT_Err_Unknown_File_Format;
endif|#
directive|endif
comment|/* load the table directory */
name|FT_TRACE2
argument_list|(
operator|(
literal|"-- Number of tables: %10u\n"
operator|,
name|sfnt
operator|.
name|num_tables
operator|)
argument_list|)
expr_stmt|;
name|FT_TRACE2
argument_list|(
operator|(
literal|"-- Format version:   0x%08lx\n"
operator|,
name|sfnt
operator|.
name|format_tag
operator|)
argument_list|)
expr_stmt|;
comment|/* check first */
name|error
operator|=
name|check_table_dir
argument_list|(
operator|&
name|sfnt
argument_list|,
name|stream
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|FT_TRACE2
argument_list|(
operator|(
literal|"tt_face_load_font_dir:"
literal|" invalid table directory for TrueType\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|face
operator|->
name|num_tables
operator|=
name|sfnt
operator|.
name|num_tables
expr_stmt|;
name|face
operator|->
name|format_tag
operator|=
name|sfnt
operator|.
name|format_tag
expr_stmt|;
if|if
condition|(
name|FT_QNEW_ARRAY
argument_list|(
name|face
operator|->
name|dir_tables
argument_list|,
name|face
operator|->
name|num_tables
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|FT_STREAM_SEEK
argument_list|(
name|sfnt
operator|.
name|offset
operator|+
literal|12
argument_list|)
operator|||
name|FT_FRAME_ENTER
argument_list|(
name|face
operator|->
name|num_tables
operator|*
literal|16L
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|entry
operator|=
name|face
operator|->
name|dir_tables
expr_stmt|;
for|for
control|(
name|nn
operator|=
literal|0
init|;
name|nn
operator|<
name|sfnt
operator|.
name|num_tables
condition|;
name|nn
operator|++
control|)
block|{
name|entry
operator|->
name|Tag
operator|=
name|FT_GET_TAG4
argument_list|()
expr_stmt|;
name|entry
operator|->
name|CheckSum
operator|=
name|FT_GET_ULONG
argument_list|()
expr_stmt|;
name|entry
operator|->
name|Offset
operator|=
name|FT_GET_LONG
argument_list|()
expr_stmt|;
name|entry
operator|->
name|Length
operator|=
name|FT_GET_LONG
argument_list|()
expr_stmt|;
comment|/* ignore invalid tables */
if|if
condition|(
name|entry
operator|->
name|Offset
operator|+
name|entry
operator|->
name|Length
operator|>
name|stream
operator|->
name|size
condition|)
continue|continue;
else|else
block|{
name|FT_TRACE2
argument_list|(
operator|(
literal|"  %c%c%c%c  -  %08lx  -  %08lx\n"
operator|,
call|(
name|FT_Char
call|)
argument_list|(
name|entry
operator|->
name|Tag
operator|>>
literal|24
argument_list|)
operator|,
call|(
name|FT_Char
call|)
argument_list|(
name|entry
operator|->
name|Tag
operator|>>
literal|16
argument_list|)
operator|,
call|(
name|FT_Char
call|)
argument_list|(
name|entry
operator|->
name|Tag
operator|>>
literal|8
argument_list|)
operator|,
call|(
name|FT_Char
call|)
argument_list|(
name|entry
operator|->
name|Tag
argument_list|)
operator|,
name|entry
operator|->
name|Offset
operator|,
name|entry
operator|->
name|Length
operator|)
argument_list|)
expr_stmt|;
name|entry
operator|++
expr_stmt|;
block|}
block|}
name|FT_FRAME_EXIT
argument_list|()
expr_stmt|;
name|FT_TRACE2
argument_list|(
operator|(
literal|"table directory loaded\n\n"
operator|)
argument_list|)
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_any                                                   */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads any font table into client memory.                           */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: The face object to look for.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    tag    :: The tag of table to load.  Use the value 0 if you want   */
end_comment
begin_comment
comment|/*              to access the whole font file, else set this parameter   */
end_comment
begin_comment
comment|/*              to a valid TrueType table tag that you can forge with    */
end_comment
begin_comment
comment|/*              the MAKE_TT_TAG macro.                                   */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    offset :: The starting offset in the table (or the file if         */
end_comment
begin_comment
comment|/*              tag == 0).                                               */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    length :: The address of the decision variable:                    */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*                If length == NULL:                                     */
end_comment
begin_comment
comment|/*                  Loads the whole table.  Returns an error if          */
end_comment
begin_comment
comment|/*                  `offset' == 0!                                       */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*                If *length == 0:                                       */
end_comment
begin_comment
comment|/*                  Exits immediately; returning the length of the given */
end_comment
begin_comment
comment|/*                  table or of the font file, depending on the value of */
end_comment
begin_comment
comment|/*                  `tag'.                                               */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*                If *length != 0:                                       */
end_comment
begin_comment
comment|/*                  Loads the next `length' bytes of table or font,      */
end_comment
begin_comment
comment|/*                  starting at offset `offset' (in table or font too).  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Output>                                                              */
end_comment
begin_comment
comment|/*    buffer :: The address of target buffer.                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_any
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_ULong   tag
argument_list|,
argument|FT_Long    offset
argument_list|,
argument|FT_Byte*   buffer
argument_list|,
argument|FT_ULong*  length
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|FT_Stream
name|stream
decl_stmt|;
name|TT_Table
name|table
decl_stmt|;
name|FT_ULong
name|size
decl_stmt|;
if|if
condition|(
name|tag
operator|!=
literal|0
condition|)
block|{
comment|/* look for tag in font directory */
name|table
operator|=
name|tt_face_lookup_table
argument_list|(
name|face
argument_list|,
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|table
condition|)
block|{
name|error
operator|=
name|SFNT_Err_Table_Missing
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|offset
operator|+=
name|table
operator|->
name|Offset
expr_stmt|;
name|size
operator|=
name|table
operator|->
name|Length
expr_stmt|;
block|}
else|else
comment|/* tag == 0 -- the user wants to access the font file directly */
name|size
operator|=
name|face
operator|->
name|root
operator|.
name|stream
operator|->
name|size
expr_stmt|;
if|if
condition|(
name|length
operator|&&
operator|*
name|length
operator|==
literal|0
condition|)
block|{
operator|*
name|length
operator|=
name|size
expr_stmt|;
return|return
name|SFNT_Err_Ok
return|;
block|}
if|if
condition|(
name|length
condition|)
name|size
operator|=
operator|*
name|length
expr_stmt|;
name|stream
operator|=
name|face
operator|->
name|root
operator|.
name|stream
expr_stmt|;
comment|/* the `if' is syntactic sugar for picky compilers */
if|if
condition|(
name|FT_STREAM_READ_AT
argument_list|(
name|offset
argument_list|,
name|buffer
argument_list|,
name|size
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_generic_header                                        */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads the TrueType table `head' or `bhed'.                         */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: A handle to the target face object.                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream :: The input stream.                                        */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_function
specifier|static
name|FT_Error
DECL|function|tt_face_load_generic_header
name|tt_face_load_generic_header
parameter_list|(
name|TT_Face
name|face
parameter_list|,
name|FT_Stream
name|stream
parameter_list|,
name|FT_ULong
name|tag
parameter_list|)
block|{
name|FT_Error
name|error
decl_stmt|;
name|TT_Header
modifier|*
name|header
decl_stmt|;
specifier|static
specifier|const
name|FT_Frame_Field
name|header_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|TT_Header
name|FT_FRAME_START
argument_list|(
literal|54
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|Table_Version
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|Font_Revision
argument_list|)
block|,
name|FT_FRAME_LONG
argument_list|(
name|CheckSum_Adjust
argument_list|)
block|,
name|FT_FRAME_LONG
argument_list|(
name|Magic_Number
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|Flags
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|Units_Per_EM
argument_list|)
block|,
name|FT_FRAME_LONG
argument_list|(
name|Created
index|[
literal|0
index|]
argument_list|)
block|,
name|FT_FRAME_LONG
argument_list|(
name|Created
index|[
literal|1
index|]
argument_list|)
block|,
name|FT_FRAME_LONG
argument_list|(
name|Modified
index|[
literal|0
index|]
argument_list|)
block|,
name|FT_FRAME_LONG
argument_list|(
name|Modified
index|[
literal|1
index|]
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|xMin
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|yMin
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|xMax
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|yMax
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|Mac_Style
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|Lowest_Rec_PPEM
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Font_Direction
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Index_To_Loc_Format
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Glyph_Data_Format
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|tag
argument_list|,
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
name|header
operator|=
operator|&
name|face
operator|->
name|header
expr_stmt|;
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|header_fields
argument_list|,
name|header
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"Units per EM: %4u\n"
operator|,
name|header
operator|->
name|Units_Per_EM
operator|)
argument_list|)
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"IndexToLoc:   %4d\n"
operator|,
name|header
operator|->
name|Index_To_Loc_Format
operator|)
argument_list|)
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_function
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_head
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
return|return
name|tt_face_load_generic_header
argument_list|(
name|face
argument_list|,
name|stream
argument_list|,
name|TTAG_head
argument_list|)
return|;
block|}
end_block
begin_ifdef
ifdef|#
directive|ifdef
name|TT_CONFIG_OPTION_EMBEDDED_BITMAPS
end_ifdef
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_bhed
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
return|return
name|tt_face_load_generic_header
argument_list|(
name|face
argument_list|,
name|stream
argument_list|,
name|TTAG_bhed
argument_list|)
return|;
block|}
end_block
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* TT_CONFIG_OPTION_EMBEDDED_BITMAPS */
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_max_profile                                           */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads the maximum profile into a face object.                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: A handle to the target face object.                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream :: The input stream.                                        */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_maxp
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|TT_MaxProfile
modifier|*
name|maxProfile
init|=
operator|&
name|face
operator|->
name|max_profile
decl_stmt|;
specifier|const
name|FT_Frame_Field
name|maxp_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|TT_MaxProfile
name|FT_FRAME_START
argument_list|(
literal|6
argument_list|)
block|,
name|FT_FRAME_LONG
argument_list|(
name|version
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|numGlyphs
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
specifier|const
name|FT_Frame_Field
name|maxp_fields_extra
index|[]
init|=
block|{
name|FT_FRAME_START
argument_list|(
literal|26
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxPoints
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxContours
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxCompositePoints
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxCompositeContours
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxZones
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxTwilightPoints
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxStorage
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxFunctionDefs
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxInstructionDefs
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxStackElements
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxSizeOfInstructions
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxComponentElements
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|maxComponentDepth
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|TTAG_maxp
argument_list|,
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|maxp_fields
argument_list|,
name|maxProfile
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|maxProfile
operator|->
name|maxPoints
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxContours
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxCompositePoints
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxCompositeContours
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxZones
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxTwilightPoints
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxStorage
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxFunctionDefs
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxInstructionDefs
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxStackElements
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxSizeOfInstructions
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxComponentElements
operator|=
literal|0
expr_stmt|;
name|maxProfile
operator|->
name|maxComponentDepth
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|maxProfile
operator|->
name|version
operator|>=
literal|0x10000L
condition|)
block|{
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|maxp_fields_extra
argument_list|,
name|maxProfile
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
comment|/* XXX: an adjustment that is necessary to load certain */
comment|/*      broken fonts like `Keystrokes MT' :-(           */
comment|/*                                                      */
comment|/*   We allocate 64 function entries by default when    */
comment|/*   the maxFunctionDefs field is null.                 */
if|if
condition|(
name|maxProfile
operator|->
name|maxFunctionDefs
operator|==
literal|0
condition|)
name|maxProfile
operator|->
name|maxFunctionDefs
operator|=
literal|64
expr_stmt|;
comment|/* we add 4 phantom points later */
if|if
condition|(
name|maxProfile
operator|->
name|maxTwilightPoints
operator|>
operator|(
literal|0xFFFFU
operator|-
literal|4
operator|)
condition|)
block|{
name|FT_TRACE0
argument_list|(
operator|(
literal|"tt_face_load_maxp:"
literal|" too much twilight points in `maxp' table;\n"
literal|"                  "
literal|" some glyphs might be rendered incorrectly\n"
operator|)
argument_list|)
expr_stmt|;
name|maxProfile
operator|->
name|maxTwilightPoints
operator|=
literal|0xFFFFU
operator|-
literal|4
expr_stmt|;
block|}
block|}
name|FT_TRACE3
argument_list|(
operator|(
literal|"numGlyphs: %u\n"
operator|,
name|maxProfile
operator|->
name|numGlyphs
operator|)
argument_list|)
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_names                                                 */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads the name records.                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: A handle to the target face object.                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream :: The input stream.                                        */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_name
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|FT_Memory
name|memory
init|=
name|stream
operator|->
name|memory
decl_stmt|;
name|FT_ULong
name|table_pos
decl_stmt|,
name|table_len
decl_stmt|;
name|FT_ULong
name|storage_start
decl_stmt|,
name|storage_limit
decl_stmt|;
name|FT_UInt
name|count
decl_stmt|;
name|TT_NameTable
name|table
decl_stmt|;
specifier|static
specifier|const
name|FT_Frame_Field
name|name_table_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|TT_NameTableRec
name|FT_FRAME_START
argument_list|(
literal|6
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|format
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|numNameRecords
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|storageOffset
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
specifier|static
specifier|const
name|FT_Frame_Field
name|name_record_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|TT_NameEntryRec
comment|/* no FT_FRAME_START */
name|FT_FRAME_USHORT
argument_list|(
name|platformID
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|encodingID
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|languageID
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|nameID
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|stringLength
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|stringOffset
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
name|table
operator|=
operator|&
name|face
operator|->
name|name_table
expr_stmt|;
name|table
operator|->
name|stream
operator|=
name|stream
expr_stmt|;
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|TTAG_name
argument_list|,
name|stream
argument_list|,
operator|&
name|table_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
name|table_pos
operator|=
name|FT_STREAM_POS
argument_list|()
expr_stmt|;
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|name_table_fields
argument_list|,
name|table
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
comment|/* Some popular Asian fonts have an invalid `storageOffset' value   */
comment|/* (it should be at least "6 + 12*num_names").  However, the string */
comment|/* offsets, computed as "storageOffset + entry->stringOffset", are  */
comment|/* valid pointers within the name table...                          */
comment|/*                                                                  */
comment|/* We thus can't check `storageOffset' right now.                   */
comment|/*                                                                  */
name|storage_start
operator|=
name|table_pos
operator|+
literal|6
operator|+
literal|12
operator|*
name|table
operator|->
name|numNameRecords
expr_stmt|;
name|storage_limit
operator|=
name|table_pos
operator|+
name|table_len
expr_stmt|;
if|if
condition|(
name|storage_start
operator|>
name|storage_limit
condition|)
block|{
name|FT_ERROR
argument_list|(
operator|(
literal|"tt_face_load_name: invalid `name' table\n"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|SFNT_Err_Name_Table_Missing
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Allocate the array of name records. */
name|count
operator|=
name|table
operator|->
name|numNameRecords
expr_stmt|;
name|table
operator|->
name|numNameRecords
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|FT_NEW_ARRAY
argument_list|(
name|table
operator|->
name|names
argument_list|,
name|count
argument_list|)
operator|||
name|FT_FRAME_ENTER
argument_list|(
name|count
operator|*
literal|12
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
comment|/* Load the name records and determine how much storage is needed */
comment|/* to hold the strings themselves.                                */
block|{
name|TT_NameEntryRec
modifier|*
name|entry
init|=
name|table
operator|->
name|names
decl_stmt|;
for|for
control|(
init|;
name|count
operator|>
literal|0
condition|;
name|count
operator|--
control|)
block|{
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|name_record_fields
argument_list|,
name|entry
argument_list|)
condition|)
continue|continue;
comment|/* check that the name is not empty */
if|if
condition|(
name|entry
operator|->
name|stringLength
operator|==
literal|0
condition|)
continue|continue;
comment|/* check that the name string is within the table */
name|entry
operator|->
name|stringOffset
operator|+=
name|table_pos
operator|+
name|table
operator|->
name|storageOffset
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|stringOffset
operator|<
name|storage_start
operator|||
name|entry
operator|->
name|stringOffset
operator|+
name|entry
operator|->
name|stringLength
operator|>
name|storage_limit
condition|)
block|{
comment|/* invalid entry - ignore it */
name|entry
operator|->
name|stringOffset
operator|=
literal|0
expr_stmt|;
name|entry
operator|->
name|stringLength
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
name|entry
operator|++
expr_stmt|;
block|}
name|table
operator|->
name|numNameRecords
operator|=
call|(
name|FT_UInt
call|)
argument_list|(
name|entry
operator|-
name|table
operator|->
name|names
argument_list|)
expr_stmt|;
block|}
name|FT_FRAME_EXIT
argument_list|()
expr_stmt|;
comment|/* everything went well, update face->num_names */
name|face
operator|->
name|num_names
operator|=
operator|(
name|FT_UShort
operator|)
name|table
operator|->
name|numNameRecords
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_free_names                                                 */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Frees the name records.                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face :: A handle to the target face object.                        */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|tt_face_free_name
name|tt_face_free_name
argument_list|(
argument|TT_Face  face
argument_list|)
end_macro
begin_block
block|{
name|FT_Memory
name|memory
init|=
name|face
operator|->
name|root
operator|.
name|driver
operator|->
name|root
operator|.
name|memory
decl_stmt|;
name|TT_NameTable
name|table
init|=
operator|&
name|face
operator|->
name|name_table
decl_stmt|;
name|TT_NameEntry
name|entry
init|=
name|table
operator|->
name|names
decl_stmt|;
name|FT_UInt
name|count
init|=
name|table
operator|->
name|numNameRecords
decl_stmt|;
if|if
condition|(
name|table
operator|->
name|names
condition|)
block|{
for|for
control|(
init|;
name|count
operator|>
literal|0
condition|;
name|count
operator|--
operator|,
name|entry
operator|++
control|)
block|{
name|FT_FREE
argument_list|(
name|entry
operator|->
name|string
argument_list|)
expr_stmt|;
name|entry
operator|->
name|stringLength
operator|=
literal|0
expr_stmt|;
block|}
comment|/* free strings table */
name|FT_FREE
argument_list|(
name|table
operator|->
name|names
argument_list|)
expr_stmt|;
block|}
name|table
operator|->
name|numNameRecords
operator|=
literal|0
expr_stmt|;
name|table
operator|->
name|format
operator|=
literal|0
expr_stmt|;
name|table
operator|->
name|storageOffset
operator|=
literal|0
expr_stmt|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_cmap                                                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads the cmap directory in a face object.  The cmaps themselves   */
end_comment
begin_comment
comment|/*    are loaded on demand in the `ttcmap.c' module.                     */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: A handle to the target face object.                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream :: A handle to the input stream.                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_cmap
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|TTAG_cmap
argument_list|,
name|stream
argument_list|,
operator|&
name|face
operator|->
name|cmap_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|FT_FRAME_EXTRACT
argument_list|(
name|face
operator|->
name|cmap_size
argument_list|,
name|face
operator|->
name|cmap_table
argument_list|)
condition|)
name|face
operator|->
name|cmap_size
operator|=
literal|0
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_os2                                                   */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads the OS2 table.                                               */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: A handle to the target face object.                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream :: A handle to the input stream.                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_os2
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|TT_OS2
modifier|*
name|os2
decl_stmt|;
specifier|const
name|FT_Frame_Field
name|os2_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|TT_OS2
name|FT_FRAME_START
argument_list|(
literal|78
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|version
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|xAvgCharWidth
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|usWeightClass
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|usWidthClass
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|fsType
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|ySubscriptXSize
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|ySubscriptYSize
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|ySubscriptXOffset
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|ySubscriptYOffset
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|ySuperscriptXSize
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|ySuperscriptYSize
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|ySuperscriptXOffset
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|ySuperscriptYOffset
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|yStrikeoutSize
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|yStrikeoutPosition
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|sFamilyClass
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|0
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|1
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|2
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|3
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|4
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|5
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|6
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|7
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|8
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|panose
index|[
literal|9
index|]
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|ulUnicodeRange1
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|ulUnicodeRange2
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|ulUnicodeRange3
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|ulUnicodeRange4
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|achVendID
index|[
literal|0
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|achVendID
index|[
literal|1
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|achVendID
index|[
literal|2
index|]
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|achVendID
index|[
literal|3
index|]
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|fsSelection
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|usFirstCharIndex
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|usLastCharIndex
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|sTypoAscender
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|sTypoDescender
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|sTypoLineGap
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|usWinAscent
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|usWinDescent
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
specifier|const
name|FT_Frame_Field
name|os2_fields_extra
index|[]
init|=
block|{
name|FT_FRAME_START
argument_list|(
literal|8
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|ulCodePageRange1
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|ulCodePageRange2
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
specifier|const
name|FT_Frame_Field
name|os2_fields_extra2
index|[]
init|=
block|{
name|FT_FRAME_START
argument_list|(
literal|10
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|sxHeight
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|sCapHeight
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|usDefaultChar
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|usBreakChar
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|usMaxContext
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
comment|/* We now support old Mac fonts where the OS/2 table doesn't  */
comment|/* exist.  Simply put, we set the `version' field to 0xFFFF   */
comment|/* and test this value each time we need to access the table. */
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|TTAG_OS2
argument_list|,
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
name|os2
operator|=
operator|&
name|face
operator|->
name|os2
expr_stmt|;
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|os2_fields
argument_list|,
name|os2
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|os2
operator|->
name|ulCodePageRange1
operator|=
literal|0
expr_stmt|;
name|os2
operator|->
name|ulCodePageRange2
operator|=
literal|0
expr_stmt|;
name|os2
operator|->
name|sxHeight
operator|=
literal|0
expr_stmt|;
name|os2
operator|->
name|sCapHeight
operator|=
literal|0
expr_stmt|;
name|os2
operator|->
name|usDefaultChar
operator|=
literal|0
expr_stmt|;
name|os2
operator|->
name|usBreakChar
operator|=
literal|0
expr_stmt|;
name|os2
operator|->
name|usMaxContext
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|os2
operator|->
name|version
operator|>=
literal|0x0001
condition|)
block|{
comment|/* only version 1 tables */
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|os2_fields_extra
argument_list|,
name|os2
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|os2
operator|->
name|version
operator|>=
literal|0x0002
condition|)
block|{
comment|/* only version 2 tables */
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|os2_fields_extra2
argument_list|,
name|os2
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
block|}
block|}
name|FT_TRACE3
argument_list|(
operator|(
literal|"sTypoAscender:  %4d\n"
operator|,
name|os2
operator|->
name|sTypoAscender
operator|)
argument_list|)
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"sTypoDescender: %4d\n"
operator|,
name|os2
operator|->
name|sTypoDescender
operator|)
argument_list|)
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"usWinAscent:    %4u\n"
operator|,
name|os2
operator|->
name|usWinAscent
operator|)
argument_list|)
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"usWinDescent:   %4u\n"
operator|,
name|os2
operator|->
name|usWinDescent
operator|)
argument_list|)
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"fsSelection:    0x%2x\n"
operator|,
name|os2
operator|->
name|fsSelection
operator|)
argument_list|)
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_postscript                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads the Postscript table.                                        */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: A handle to the target face object.                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream :: A handle to the input stream.                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_post
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|TT_Postscript
modifier|*
name|post
init|=
operator|&
name|face
operator|->
name|postscript
decl_stmt|;
specifier|static
specifier|const
name|FT_Frame_Field
name|post_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|TT_Postscript
name|FT_FRAME_START
argument_list|(
literal|32
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|FormatType
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|italicAngle
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|underlinePosition
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|underlineThickness
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|isFixedPitch
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|minMemType42
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|maxMemType42
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|minMemType1
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|maxMemType1
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|TTAG_post
argument_list|,
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|post_fields
argument_list|,
name|post
argument_list|)
condition|)
return|return
name|error
return|;
comment|/* we don't load the glyph names, we do that in another */
comment|/* module (ttpost).                                     */
name|FT_TRACE3
argument_list|(
operator|(
literal|"FormatType:   0x%x\n"
operator|,
name|post
operator|->
name|FormatType
operator|)
argument_list|)
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"isFixedPitch:   %s\n"
operator|,
name|post
operator|->
name|isFixedPitch
condition|?
literal|"  yes"
else|:
literal|"   no"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SFNT_Err_Ok
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_pclt                                                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads the PCL 5 Table.                                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: A handle to the target face object.                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream :: A handle to the input stream.                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_pclt
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
specifier|static
specifier|const
name|FT_Frame_Field
name|pclt_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|TT_PCLT
name|FT_FRAME_START
argument_list|(
literal|54
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|Version
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|FontNumber
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|Pitch
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|xHeight
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|Style
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|TypeFamily
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|CapHeight
argument_list|)
block|,
name|FT_FRAME_BYTES
argument_list|(
name|TypeFace
argument_list|,
literal|16
argument_list|)
block|,
name|FT_FRAME_BYTES
argument_list|(
name|CharacterComplement
argument_list|,
literal|8
argument_list|)
block|,
name|FT_FRAME_BYTES
argument_list|(
name|FileName
argument_list|,
literal|6
argument_list|)
block|,
name|FT_FRAME_CHAR
argument_list|(
name|StrokeWeight
argument_list|)
block|,
name|FT_FRAME_CHAR
argument_list|(
name|WidthType
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|SerifStyle
argument_list|)
block|,
name|FT_FRAME_BYTE
argument_list|(
name|Reserved
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
name|FT_Error
name|error
decl_stmt|;
name|TT_PCLT
modifier|*
name|pclt
init|=
operator|&
name|face
operator|->
name|pclt
decl_stmt|;
comment|/* optional table */
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|TTAG_PCLT
argument_list|,
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|pclt_fields
argument_list|,
name|pclt
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_gasp                                                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Loads the `gasp' table into a face object.                         */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face   :: A handle to the target face object.                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream :: The input stream.                                        */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_gasp
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|FT_Memory
name|memory
init|=
name|stream
operator|->
name|memory
decl_stmt|;
name|FT_UInt
name|j
decl_stmt|,
name|num_ranges
decl_stmt|;
name|TT_GaspRange
name|gaspranges
decl_stmt|;
comment|/* the gasp table is optional */
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|TTAG_gasp
argument_list|,
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|FT_FRAME_ENTER
argument_list|(
literal|4L
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|face
operator|->
name|gasp
operator|.
name|version
operator|=
name|FT_GET_USHORT
argument_list|()
expr_stmt|;
name|face
operator|->
name|gasp
operator|.
name|numRanges
operator|=
name|FT_GET_USHORT
argument_list|()
expr_stmt|;
name|FT_FRAME_EXIT
argument_list|()
expr_stmt|;
comment|/* only support versions 0 and 1 of the table */
if|if
condition|(
name|face
operator|->
name|gasp
operator|.
name|version
operator|>=
literal|2
condition|)
block|{
name|face
operator|->
name|gasp
operator|.
name|numRanges
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|SFNT_Err_Invalid_Table
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|num_ranges
operator|=
name|face
operator|->
name|gasp
operator|.
name|numRanges
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"numRanges: %u\n"
operator|,
name|num_ranges
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FT_QNEW_ARRAY
argument_list|(
name|gaspranges
argument_list|,
name|num_ranges
argument_list|)
operator|||
name|FT_FRAME_ENTER
argument_list|(
name|num_ranges
operator|*
literal|4L
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|face
operator|->
name|gasp
operator|.
name|gaspRanges
operator|=
name|gaspranges
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num_ranges
condition|;
name|j
operator|++
control|)
block|{
name|gaspranges
index|[
name|j
index|]
operator|.
name|maxPPEM
operator|=
name|FT_GET_USHORT
argument_list|()
expr_stmt|;
name|gaspranges
index|[
name|j
index|]
operator|.
name|gaspFlag
operator|=
name|FT_GET_USHORT
argument_list|()
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"gaspRange %d: rangeMaxPPEM %5d, rangeGaspBehavior 0x%x\n"
operator|,
name|j
operator|,
name|gaspranges
index|[
name|j
index|]
operator|.
name|maxPPEM
operator|,
name|gaspranges
index|[
name|j
index|]
operator|.
name|gaspFlag
operator|)
argument_list|)
expr_stmt|;
block|}
name|FT_FRAME_EXIT
argument_list|()
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/* END */
end_comment
end_unit
