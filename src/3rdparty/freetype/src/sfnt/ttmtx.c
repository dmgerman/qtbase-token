begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  ttmtx.c                                                                */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    Load the metrics tables common to TTF and OTF fonts (body).          */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2006-2009, 2011-2014 by                                      */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_DEBUG_H
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_STREAM_H
end_include
begin_include
include|#
directive|include
include|FT_TRUETYPE_TAGS_H
end_include
begin_include
include|#
directive|include
file|"ttmtx.h"
end_include
begin_include
include|#
directive|include
file|"sferrors.h"
end_include
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */
end_comment
begin_comment
comment|/* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */
end_comment
begin_comment
comment|/* messages during execution.                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_undef
DECL|macro|FT_COMPONENT
undef|#
directive|undef
name|FT_COMPONENT
end_undef
begin_define
DECL|macro|FT_COMPONENT
define|#
directive|define
name|FT_COMPONENT
value|trace_ttmtx
end_define
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_hmtx                                                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Load the `hmtx' or `vmtx' table into a face object.                */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face     :: A handle to the target face object.                    */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream   :: The input stream.                                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    vertical :: A boolean flag.  If set, load `vmtx'.                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_hmtx
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|,
argument|FT_Bool    vertical
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|FT_ULong
name|tag
decl_stmt|,
name|table_size
decl_stmt|;
name|FT_ULong
modifier|*
name|ptable_offset
decl_stmt|;
name|FT_ULong
modifier|*
name|ptable_size
decl_stmt|;
if|if
condition|(
name|vertical
condition|)
block|{
name|tag
operator|=
name|TTAG_vmtx
expr_stmt|;
name|ptable_offset
operator|=
operator|&
name|face
operator|->
name|vert_metrics_offset
expr_stmt|;
name|ptable_size
operator|=
operator|&
name|face
operator|->
name|vert_metrics_size
expr_stmt|;
block|}
else|else
block|{
name|tag
operator|=
name|TTAG_hmtx
expr_stmt|;
name|ptable_offset
operator|=
operator|&
name|face
operator|->
name|horz_metrics_offset
expr_stmt|;
name|ptable_size
operator|=
operator|&
name|face
operator|->
name|horz_metrics_size
expr_stmt|;
block|}
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|tag
argument_list|,
name|stream
argument_list|,
operator|&
name|table_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Fail
goto|;
operator|*
name|ptable_size
operator|=
name|table_size
expr_stmt|;
operator|*
name|ptable_offset
operator|=
name|FT_STREAM_POS
argument_list|()
expr_stmt|;
name|Fail
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_load_hhea                                                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Load the `hhea' or 'vhea' table into a face object.                */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face     :: A handle to the target face object.                    */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    stream   :: The input stream.                                      */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    vertical :: A boolean flag.  If set, load `vhea'.                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Return>                                                              */
end_comment
begin_comment
comment|/*    FreeType error code.  0 means success.                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
DECL|function|FT_LOCAL_DEF
name|FT_LOCAL_DEF
argument_list|(
argument|FT_Error
argument_list|)
end_macro
begin_macro
name|tt_face_load_hhea
argument_list|(
argument|TT_Face    face
argument_list|,
argument|FT_Stream  stream
argument_list|,
argument|FT_Bool    vertical
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|TT_HoriHeader
modifier|*
name|header
decl_stmt|;
specifier|static
specifier|const
name|FT_Frame_Field
name|metrics_header_fields
index|[]
init|=
block|{
DECL|macro|FT_STRUCTURE
undef|#
directive|undef
name|FT_STRUCTURE
DECL|macro|FT_STRUCTURE
define|#
directive|define
name|FT_STRUCTURE
value|TT_HoriHeader
name|FT_FRAME_START
argument_list|(
literal|36
argument_list|)
block|,
name|FT_FRAME_ULONG
argument_list|(
name|Version
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Ascender
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Descender
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Line_Gap
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|advance_Width_Max
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|min_Left_Side_Bearing
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|min_Right_Side_Bearing
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|xMax_Extent
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|caret_Slope_Rise
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|caret_Slope_Run
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|caret_Offset
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Reserved
index|[
literal|0
index|]
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Reserved
index|[
literal|1
index|]
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Reserved
index|[
literal|2
index|]
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|Reserved
index|[
literal|3
index|]
argument_list|)
block|,
name|FT_FRAME_SHORT
argument_list|(
name|metric_Data_Format
argument_list|)
block|,
name|FT_FRAME_USHORT
argument_list|(
name|number_Of_HMetrics
argument_list|)
block|,
name|FT_FRAME_END
block|}
decl_stmt|;
if|if
condition|(
name|vertical
condition|)
block|{
name|void
modifier|*
name|v
init|=
operator|&
name|face
operator|->
name|vertical
decl_stmt|;
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|TTAG_vhea
argument_list|,
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Fail
goto|;
name|header
operator|=
operator|(
name|TT_HoriHeader
operator|*
operator|)
name|v
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|face
operator|->
name|goto_table
argument_list|(
name|face
argument_list|,
name|TTAG_hhea
argument_list|,
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Fail
goto|;
name|header
operator|=
operator|&
name|face
operator|->
name|horizontal
expr_stmt|;
block|}
if|if
condition|(
name|FT_STREAM_READ_FIELDS
argument_list|(
name|metrics_header_fields
argument_list|,
name|header
argument_list|)
condition|)
goto|goto
name|Fail
goto|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"Ascender:          %5d\n"
operator|,
name|header
operator|->
name|Ascender
operator|)
argument_list|)
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"Descender:         %5d\n"
operator|,
name|header
operator|->
name|Descender
operator|)
argument_list|)
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"number_Of_Metrics: %5u\n"
operator|,
name|header
operator|->
name|number_Of_HMetrics
operator|)
argument_list|)
expr_stmt|;
name|header
operator|->
name|long_metrics
operator|=
name|NULL
expr_stmt|;
name|header
operator|->
name|short_metrics
operator|=
name|NULL
expr_stmt|;
name|Fail
label|:
return|return
name|error
return|;
block|}
end_block
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Function>                                                            */
end_comment
begin_comment
comment|/*    tt_face_get_metrics                                                */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Description>                                                         */
end_comment
begin_comment
comment|/*    Return the horizontal or vertical metrics in font units for a      */
end_comment
begin_comment
comment|/*    given glyph.  The values are the left side bearing (top side       */
end_comment
begin_comment
comment|/*    bearing for vertical metrics) and advance width (advance height    */
end_comment
begin_comment
comment|/*    for vertical metrics).                                             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Input>                                                               */
end_comment
begin_comment
comment|/*    face     :: A pointer to the TrueType face structure.              */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    vertical :: If set to TRUE, get vertical metrics.                  */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    gindex   :: The glyph index.                                       */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*<Output>                                                              */
end_comment
begin_comment
comment|/*    abearing :: The bearing, either left side or top side.             */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/*    aadvance :: The advance width or advance height, depending on      */
end_comment
begin_comment
comment|/*                the `vertical' flag.                                   */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|tt_face_get_metrics
name|tt_face_get_metrics
argument_list|(
argument|TT_Face     face
argument_list|,
argument|FT_Bool     vertical
argument_list|,
argument|FT_UInt     gindex
argument_list|,
argument|FT_Short   *abearing
argument_list|,
argument|FT_UShort  *aadvance
argument_list|)
end_macro
begin_block
block|{
name|FT_Error
name|error
decl_stmt|;
name|FT_Stream
name|stream
init|=
name|face
operator|->
name|root
operator|.
name|stream
decl_stmt|;
name|TT_HoriHeader
modifier|*
name|header
decl_stmt|;
name|FT_ULong
name|table_pos
decl_stmt|,
name|table_size
decl_stmt|,
name|table_end
decl_stmt|;
name|FT_UShort
name|k
decl_stmt|;
if|if
condition|(
name|vertical
condition|)
block|{
name|void
modifier|*
name|v
init|=
operator|&
name|face
operator|->
name|vertical
decl_stmt|;
name|header
operator|=
operator|(
name|TT_HoriHeader
operator|*
operator|)
name|v
expr_stmt|;
name|table_pos
operator|=
name|face
operator|->
name|vert_metrics_offset
expr_stmt|;
name|table_size
operator|=
name|face
operator|->
name|vert_metrics_size
expr_stmt|;
block|}
else|else
block|{
name|header
operator|=
operator|&
name|face
operator|->
name|horizontal
expr_stmt|;
name|table_pos
operator|=
name|face
operator|->
name|horz_metrics_offset
expr_stmt|;
name|table_size
operator|=
name|face
operator|->
name|horz_metrics_size
expr_stmt|;
block|}
name|table_end
operator|=
name|table_pos
operator|+
name|table_size
expr_stmt|;
name|k
operator|=
name|header
operator|->
name|number_Of_HMetrics
expr_stmt|;
if|if
condition|(
name|k
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|gindex
operator|<
operator|(
name|FT_UInt
operator|)
name|k
condition|)
block|{
name|table_pos
operator|+=
literal|4
operator|*
name|gindex
expr_stmt|;
if|if
condition|(
name|table_pos
operator|+
literal|4
operator|>
name|table_end
condition|)
goto|goto
name|NoData
goto|;
if|if
condition|(
name|FT_STREAM_SEEK
argument_list|(
name|table_pos
argument_list|)
operator|||
name|FT_READ_USHORT
argument_list|(
operator|*
name|aadvance
argument_list|)
operator|||
name|FT_READ_SHORT
argument_list|(
operator|*
name|abearing
argument_list|)
condition|)
goto|goto
name|NoData
goto|;
block|}
else|else
block|{
name|table_pos
operator|+=
literal|4
operator|*
operator|(
name|k
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|table_pos
operator|+
literal|4
operator|>
name|table_end
condition|)
goto|goto
name|NoData
goto|;
if|if
condition|(
name|FT_STREAM_SEEK
argument_list|(
name|table_pos
argument_list|)
operator|||
name|FT_READ_USHORT
argument_list|(
operator|*
name|aadvance
argument_list|)
condition|)
goto|goto
name|NoData
goto|;
name|table_pos
operator|+=
literal|4
operator|+
literal|2
operator|*
operator|(
name|gindex
operator|-
name|k
operator|)
expr_stmt|;
if|if
condition|(
name|table_pos
operator|+
literal|2
operator|>
name|table_end
condition|)
operator|*
name|abearing
operator|=
literal|0
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|!
name|FT_STREAM_SEEK
argument_list|(
name|table_pos
argument_list|)
condition|)
operator|(
name|void
operator|)
name|FT_READ_SHORT
argument_list|(
operator|*
name|abearing
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|NoData
label|:
operator|*
name|abearing
operator|=
literal|0
expr_stmt|;
operator|*
name|aadvance
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block
begin_comment
comment|/* END */
end_comment
end_unit
