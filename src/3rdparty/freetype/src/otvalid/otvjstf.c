begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  otvjstf.c                                                              */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    OpenType JSTF table validation (body).                               */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2004, 2007 by                                                */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"otvalid.h"
end_include
begin_include
include|#
directive|include
file|"otvcommn.h"
end_include
begin_include
include|#
directive|include
file|"otvgpos.h"
end_include
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */
end_comment
begin_comment
comment|/* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */
end_comment
begin_comment
comment|/* messages during execution.                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_undef
DECL|macro|FT_COMPONENT
undef|#
directive|undef
name|FT_COMPONENT
end_undef
begin_define
DECL|macro|FT_COMPONENT
define|#
directive|define
name|FT_COMPONENT
value|trace_otvjstf
end_define
begin_define
DECL|macro|JstfPriorityFunc
define|#
directive|define
name|JstfPriorityFunc
value|otv_JstfPriority_validate
end_define
begin_define
DECL|macro|JstfLookupFunc
define|#
directive|define
name|JstfLookupFunc
value|otv_GPOS_subtable_validate
end_define
begin_comment
comment|/* uses otvalid->extra1 (GSUB lookup count) */
end_comment
begin_comment
comment|/* uses otvalid->extra2 (GPOS lookup count) */
end_comment
begin_comment
comment|/* sets otvalid->extra1 (counter)           */
end_comment
begin_function
specifier|static
name|void
DECL|function|otv_JstfPriority_validate
name|otv_JstfPriority_validate
parameter_list|(
name|FT_Bytes
name|table
parameter_list|,
name|OTV_Validator
name|otvalid
parameter_list|)
block|{
name|FT_Bytes
name|p
init|=
name|table
decl_stmt|;
name|FT_UInt
name|table_size
decl_stmt|;
name|FT_UInt
name|gsub_lookup_count
decl_stmt|,
name|gpos_lookup_count
decl_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ShrinkageEnableGSUB
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ShrinkageDisableGSUB
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ShrinkageEnableGPOS
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ShrinkageDisableGPOS
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ExtensionEnableGSUB
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ExtensionDisableGSUB
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ExtensionEnableGPOS
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ExtensionDisableGPOS
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ShrinkageJstfMax
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ExtensionJstfMax
argument_list|)
expr_stmt|;
name|OTV_ENTER
expr_stmt|;
name|OTV_TRACE
argument_list|(
operator|(
literal|"JstfPriority table\n"
operator|)
argument_list|)
expr_stmt|;
name|OTV_LIMIT_CHECK
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|gsub_lookup_count
operator|=
name|otvalid
operator|->
name|extra1
expr_stmt|;
name|gpos_lookup_count
operator|=
name|otvalid
operator|->
name|extra2
expr_stmt|;
name|table_size
operator|=
literal|20
expr_stmt|;
name|otvalid
operator|->
name|extra1
operator|=
name|gsub_lookup_count
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ShrinkageEnableGSUB
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ShrinkageEnableGSUB
argument_list|)
expr_stmt|;
if|if
condition|(
name|ShrinkageEnableGSUB
condition|)
name|otv_x_ux
argument_list|(
name|table
operator|+
name|ShrinkageEnableGSUB
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ShrinkageDisableGSUB
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ShrinkageDisableGSUB
argument_list|)
expr_stmt|;
if|if
condition|(
name|ShrinkageDisableGSUB
condition|)
name|otv_x_ux
argument_list|(
name|table
operator|+
name|ShrinkageDisableGSUB
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|otvalid
operator|->
name|extra1
operator|=
name|gpos_lookup_count
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ShrinkageEnableGPOS
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ShrinkageEnableGPOS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ShrinkageEnableGPOS
condition|)
name|otv_x_ux
argument_list|(
name|table
operator|+
name|ShrinkageEnableGPOS
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ShrinkageDisableGPOS
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ShrinkageDisableGPOS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ShrinkageDisableGPOS
condition|)
name|otv_x_ux
argument_list|(
name|table
operator|+
name|ShrinkageDisableGPOS
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ShrinkageJstfMax
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ShrinkageJstfMax
argument_list|)
expr_stmt|;
if|if
condition|(
name|ShrinkageJstfMax
condition|)
block|{
comment|/* XXX: check lookup types? */
name|OTV_NEST2
argument_list|(
name|JstfMax
argument_list|,
name|JstfLookup
argument_list|)
expr_stmt|;
name|OTV_RUN
argument_list|(
name|table
operator|+
name|ShrinkageJstfMax
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
block|}
name|otvalid
operator|->
name|extra1
operator|=
name|gsub_lookup_count
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ExtensionEnableGSUB
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ExtensionEnableGSUB
argument_list|)
expr_stmt|;
if|if
condition|(
name|ExtensionEnableGSUB
condition|)
name|otv_x_ux
argument_list|(
name|table
operator|+
name|ExtensionEnableGSUB
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ExtensionDisableGSUB
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ExtensionDisableGSUB
argument_list|)
expr_stmt|;
if|if
condition|(
name|ExtensionDisableGSUB
condition|)
name|otv_x_ux
argument_list|(
name|table
operator|+
name|ExtensionDisableGSUB
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|otvalid
operator|->
name|extra1
operator|=
name|gpos_lookup_count
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ExtensionEnableGPOS
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ExtensionEnableGPOS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ExtensionEnableGPOS
condition|)
name|otv_x_ux
argument_list|(
name|table
operator|+
name|ExtensionEnableGPOS
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ExtensionDisableGPOS
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ExtensionDisableGPOS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ExtensionDisableGPOS
condition|)
name|otv_x_ux
argument_list|(
name|table
operator|+
name|ExtensionDisableGPOS
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ExtensionJstfMax
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ExtensionJstfMax
argument_list|)
expr_stmt|;
if|if
condition|(
name|ExtensionJstfMax
condition|)
block|{
comment|/* XXX: check lookup types? */
name|OTV_NEST2
argument_list|(
name|JstfMax
argument_list|,
name|JstfLookup
argument_list|)
expr_stmt|;
name|OTV_RUN
argument_list|(
name|table
operator|+
name|ExtensionJstfMax
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
block|}
name|otvalid
operator|->
name|extra1
operator|=
name|gsub_lookup_count
expr_stmt|;
name|otvalid
operator|->
name|extra2
operator|=
name|gpos_lookup_count
expr_stmt|;
name|OTV_EXIT
expr_stmt|;
block|}
end_function
begin_comment
comment|/* sets otvalid->extra (glyph count)               */
end_comment
begin_comment
comment|/* sets otvalid->func1 (otv_JstfPriority_validate) */
end_comment
begin_function
specifier|static
name|void
DECL|function|otv_JstfScript_validate
name|otv_JstfScript_validate
parameter_list|(
name|FT_Bytes
name|table
parameter_list|,
name|OTV_Validator
name|otvalid
parameter_list|)
block|{
name|FT_Bytes
name|p
init|=
name|table
decl_stmt|;
name|FT_UInt
name|table_size
decl_stmt|;
name|FT_UInt
name|JstfLangSysCount
decl_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|ExtGlyph
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|DefJstfLangSys
argument_list|)
expr_stmt|;
name|OTV_NAME_ENTER
argument_list|(
literal|"JstfScript"
argument_list|)
expr_stmt|;
name|OTV_LIMIT_CHECK
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|ExtGlyph
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|DefJstfLangSys
argument_list|)
expr_stmt|;
name|JstfLangSysCount
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|OTV_TRACE
argument_list|(
operator|(
literal|" (JstfLangSysCount = %d)\n"
operator|,
name|JstfLangSysCount
operator|)
argument_list|)
expr_stmt|;
name|table_size
operator|=
name|JstfLangSysCount
operator|*
literal|6
operator|+
literal|6
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|ExtGlyph
argument_list|)
expr_stmt|;
if|if
condition|(
name|ExtGlyph
condition|)
block|{
name|otvalid
operator|->
name|extra1
operator|=
name|otvalid
operator|->
name|glyph_count
expr_stmt|;
name|OTV_NEST1
argument_list|(
name|ExtenderGlyph
argument_list|)
expr_stmt|;
name|OTV_RUN
argument_list|(
name|table
operator|+
name|ExtGlyph
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
block|}
name|OTV_SIZE_CHECK
argument_list|(
name|DefJstfLangSys
argument_list|)
expr_stmt|;
if|if
condition|(
name|DefJstfLangSys
condition|)
block|{
name|OTV_NEST2
argument_list|(
name|JstfLangSys
argument_list|,
name|JstfPriority
argument_list|)
expr_stmt|;
name|OTV_RUN
argument_list|(
name|table
operator|+
name|DefJstfLangSys
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
block|}
name|OTV_LIMIT_CHECK
argument_list|(
literal|6
operator|*
name|JstfLangSysCount
argument_list|)
expr_stmt|;
comment|/* JstfLangSysRecord */
name|OTV_NEST2
argument_list|(
name|JstfLangSys
argument_list|,
name|JstfPriority
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|JstfLangSysCount
operator|>
literal|0
condition|;
name|JstfLangSysCount
operator|--
control|)
block|{
name|p
operator|+=
literal|4
expr_stmt|;
comment|/* skip JstfLangSysTag */
name|OTV_RUN
argument_list|(
name|table
operator|+
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
block|}
name|OTV_EXIT
expr_stmt|;
block|}
end_function
begin_comment
comment|/* sets otvalid->extra1 (GSUB lookup count) */
end_comment
begin_comment
comment|/* sets otvalid->extra2 (GPOS lookup count) */
end_comment
begin_comment
comment|/* sets otvalid->glyph_count                */
end_comment
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|otv_JSTF_validate
name|otv_JSTF_validate
argument_list|(
argument|FT_Bytes      table
argument_list|,
argument|FT_Bytes      gsub
argument_list|,
argument|FT_Bytes      gpos
argument_list|,
argument|FT_UInt       glyph_count
argument_list|,
argument|FT_Validator  ftvalid
argument_list|)
end_macro
begin_block
block|{
name|OTV_ValidatorRec
name|otvalidrec
decl_stmt|;
name|OTV_Validator
name|otvalid
init|=
operator|&
name|otvalidrec
decl_stmt|;
name|FT_Bytes
name|p
init|=
name|table
decl_stmt|;
name|FT_UInt
name|JstfScriptCount
decl_stmt|;
name|otvalid
operator|->
name|root
operator|=
name|ftvalid
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"validating JSTF table\n"
operator|)
argument_list|)
expr_stmt|;
name|OTV_INIT
expr_stmt|;
name|OTV_LIMIT_CHECK
argument_list|(
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|FT_NEXT_ULONG
argument_list|(
name|p
argument_list|)
operator|!=
literal|0x10000UL
condition|)
comment|/* Version */
name|FT_INVALID_FORMAT
expr_stmt|;
name|JstfScriptCount
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|" (JstfScriptCount = %d)\n"
operator|,
name|JstfScriptCount
operator|)
argument_list|)
expr_stmt|;
name|OTV_LIMIT_CHECK
argument_list|(
name|JstfScriptCount
operator|*
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|gsub
condition|)
name|otvalid
operator|->
name|extra1
operator|=
name|otv_GSUBGPOS_get_Lookup_count
argument_list|(
name|gsub
argument_list|)
expr_stmt|;
else|else
name|otvalid
operator|->
name|extra1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|gpos
condition|)
name|otvalid
operator|->
name|extra2
operator|=
name|otv_GSUBGPOS_get_Lookup_count
argument_list|(
name|gpos
argument_list|)
expr_stmt|;
else|else
name|otvalid
operator|->
name|extra2
operator|=
literal|0
expr_stmt|;
name|otvalid
operator|->
name|glyph_count
operator|=
name|glyph_count
expr_stmt|;
comment|/* JstfScriptRecord */
for|for
control|(
init|;
name|JstfScriptCount
operator|>
literal|0
condition|;
name|JstfScriptCount
operator|--
control|)
block|{
name|p
operator|+=
literal|4
expr_stmt|;
comment|/* skip JstfScriptTag */
comment|/* JstfScript */
name|otv_JstfScript_validate
argument_list|(
name|table
operator|+
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
block|}
name|FT_TRACE4
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_block
begin_comment
comment|/* END */
end_comment
end_unit
