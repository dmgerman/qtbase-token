begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  otvgdef.c                                                              */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    OpenType GDEF table validation (body).                               */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 2004, 2005, 2007 by                                          */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"otvalid.h"
end_include
begin_include
include|#
directive|include
file|"otvcommn.h"
end_include
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_comment
comment|/* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */
end_comment
begin_comment
comment|/* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */
end_comment
begin_comment
comment|/* messages during execution.                                            */
end_comment
begin_comment
comment|/*                                                                       */
end_comment
begin_undef
DECL|macro|FT_COMPONENT
undef|#
directive|undef
name|FT_COMPONENT
end_undef
begin_define
DECL|macro|FT_COMPONENT
define|#
directive|define
name|FT_COMPONENT
value|trace_otvgdef
end_define
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*****                      UTILITY FUNCTIONS                        *****/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_define
DECL|macro|AttachListFunc
define|#
directive|define
name|AttachListFunc
value|otv_O_x_Ox
end_define
begin_define
DECL|macro|LigCaretListFunc
define|#
directive|define
name|LigCaretListFunc
value|otv_O_x_Ox
end_define
begin_comment
comment|/* sets valid->extra1 (0)           */
end_comment
begin_function
specifier|static
name|void
DECL|function|otv_O_x_Ox
name|otv_O_x_Ox
parameter_list|(
name|FT_Bytes
name|table
parameter_list|,
name|OTV_Validator
name|otvalid
parameter_list|)
block|{
name|FT_Bytes
name|p
init|=
name|table
decl_stmt|;
name|FT_Bytes
name|Coverage
decl_stmt|;
name|FT_UInt
name|GlyphCount
decl_stmt|;
name|OTV_Validate_Func
name|func
decl_stmt|;
name|OTV_ENTER
expr_stmt|;
name|OTV_LIMIT_CHECK
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|Coverage
operator|=
name|table
operator|+
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|GlyphCount
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|OTV_TRACE
argument_list|(
operator|(
literal|" (GlyphCount = %d)\n"
operator|,
name|GlyphCount
operator|)
argument_list|)
expr_stmt|;
name|otv_Coverage_validate
argument_list|(
name|Coverage
argument_list|,
name|otvalid
argument_list|,
name|GlyphCount
argument_list|)
expr_stmt|;
if|if
condition|(
name|GlyphCount
operator|!=
name|otv_Coverage_get_count
argument_list|(
name|Coverage
argument_list|)
condition|)
name|FT_INVALID_DATA
expr_stmt|;
name|OTV_LIMIT_CHECK
argument_list|(
name|GlyphCount
operator|*
literal|2
argument_list|)
expr_stmt|;
name|otvalid
operator|->
name|nesting_level
operator|++
expr_stmt|;
name|func
operator|=
name|otvalid
operator|->
name|func
index|[
name|otvalid
operator|->
name|nesting_level
index|]
expr_stmt|;
name|otvalid
operator|->
name|extra1
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|GlyphCount
operator|>
literal|0
condition|;
name|GlyphCount
operator|--
control|)
name|func
argument_list|(
name|table
operator|+
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|otvalid
operator|->
name|nesting_level
operator|--
expr_stmt|;
name|OTV_EXIT
expr_stmt|;
block|}
end_function
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*****                       LIGATURE CARETS                         *****/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_define
DECL|macro|CaretValueFunc
define|#
directive|define
name|CaretValueFunc
value|otv_CaretValue_validate
end_define
begin_function
specifier|static
name|void
DECL|function|otv_CaretValue_validate
name|otv_CaretValue_validate
parameter_list|(
name|FT_Bytes
name|table
parameter_list|,
name|OTV_Validator
name|otvalid
parameter_list|)
block|{
name|FT_Bytes
name|p
init|=
name|table
decl_stmt|;
name|FT_UInt
name|CaretValueFormat
decl_stmt|;
name|OTV_ENTER
expr_stmt|;
name|OTV_LIMIT_CHECK
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|CaretValueFormat
operator|=
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|OTV_TRACE
argument_list|(
operator|(
literal|" (format = %d)\n"
operator|,
name|CaretValueFormat
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|CaretValueFormat
condition|)
block|{
case|case
literal|1
case|:
comment|/* CaretValueFormat1 */
comment|/* skip Coordinate, no test */
break|break;
case|case
literal|2
case|:
comment|/* CaretValueFormat2 */
comment|/* skip CaretValuePoint, no test */
break|break;
case|case
literal|3
case|:
comment|/* CaretValueFormat3 */
name|p
operator|+=
literal|2
expr_stmt|;
comment|/* skip Coordinate */
name|OTV_LIMIT_CHECK
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* DeviceTable */
name|otv_Device_validate
argument_list|(
name|table
operator|+
name|FT_NEXT_USHORT
argument_list|(
name|p
argument_list|)
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
break|break;
default|default:
name|FT_INVALID_FORMAT
expr_stmt|;
block|}
name|OTV_EXIT
expr_stmt|;
block|}
end_function
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*****                         GDEF TABLE                            *****/
end_comment
begin_comment
comment|/*****                                                               *****/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/*************************************************************************/
end_comment
begin_comment
comment|/* sets otvalid->glyph_count */
end_comment
begin_macro
name|FT_LOCAL_DEF
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|otv_GDEF_validate
name|otv_GDEF_validate
argument_list|(
argument|FT_Bytes      table
argument_list|,
argument|FT_Bytes      gsub
argument_list|,
argument|FT_Bytes      gpos
argument_list|,
argument|FT_UInt       glyph_count
argument_list|,
argument|FT_Validator  ftvalid
argument_list|)
end_macro
begin_block
block|{
name|OTV_ValidatorRec
name|otvalidrec
decl_stmt|;
name|OTV_Validator
name|otvalid
init|=
operator|&
name|otvalidrec
decl_stmt|;
name|FT_Bytes
name|p
init|=
name|table
decl_stmt|;
name|FT_UInt
name|table_size
decl_stmt|;
name|FT_Bool
name|need_MarkAttachClassDef
decl_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|GlyphClassDef
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|AttachListOffset
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|LigCaretListOffset
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_TABLE
argument_list|(
name|MarkAttachClassDef
argument_list|)
expr_stmt|;
name|otvalid
operator|->
name|root
operator|=
name|ftvalid
expr_stmt|;
name|FT_TRACE3
argument_list|(
operator|(
literal|"validating GDEF table\n"
operator|)
argument_list|)
expr_stmt|;
name|OTV_INIT
expr_stmt|;
name|OTV_LIMIT_CHECK
argument_list|(
literal|12
argument_list|)
expr_stmt|;
if|if
condition|(
name|FT_NEXT_ULONG
argument_list|(
name|p
argument_list|)
operator|!=
literal|0x10000UL
condition|)
comment|/* Version */
name|FT_INVALID_FORMAT
expr_stmt|;
comment|/* MarkAttachClassDef has been added to the OpenType */
comment|/* specification without increasing GDEF's version,  */
comment|/* so we use this ugly hack to find out whether the  */
comment|/* table is needed actually.                         */
name|need_MarkAttachClassDef
operator|=
name|FT_BOOL
argument_list|(
name|otv_GSUBGPOS_have_MarkAttachmentType_flag
argument_list|(
name|gsub
argument_list|)
operator|||
name|otv_GSUBGPOS_have_MarkAttachmentType_flag
argument_list|(
name|gpos
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_MarkAttachClassDef
condition|)
name|table_size
operator|=
literal|12
expr_stmt|;
comment|/* OpenType>= 1.2 */
else|else
name|table_size
operator|=
literal|10
expr_stmt|;
comment|/* OpenType< 1.2  */
name|otvalid
operator|->
name|glyph_count
operator|=
name|glyph_count
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|GlyphClassDef
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|GlyphClassDef
argument_list|)
expr_stmt|;
if|if
condition|(
name|GlyphClassDef
condition|)
name|otv_ClassDef_validate
argument_list|(
name|table
operator|+
name|GlyphClassDef
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|AttachListOffset
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|AttachListOffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|AttachListOffset
condition|)
block|{
name|OTV_NEST2
argument_list|(
name|AttachList
argument_list|,
name|AttachPoint
argument_list|)
expr_stmt|;
name|OTV_RUN
argument_list|(
name|table
operator|+
name|AttachListOffset
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
block|}
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|LigCaretListOffset
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|LigCaretListOffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|LigCaretListOffset
condition|)
block|{
name|OTV_NEST3
argument_list|(
name|LigCaretList
argument_list|,
name|LigGlyph
argument_list|,
name|CaretValue
argument_list|)
expr_stmt|;
name|OTV_RUN
argument_list|(
name|table
operator|+
name|LigCaretListOffset
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|need_MarkAttachClassDef
condition|)
block|{
name|OTV_OPTIONAL_OFFSET
argument_list|(
name|MarkAttachClassDef
argument_list|)
expr_stmt|;
name|OTV_SIZE_CHECK
argument_list|(
name|MarkAttachClassDef
argument_list|)
expr_stmt|;
if|if
condition|(
name|MarkAttachClassDef
condition|)
name|otv_ClassDef_validate
argument_list|(
name|table
operator|+
name|MarkAttachClassDef
argument_list|,
name|otvalid
argument_list|)
expr_stmt|;
block|}
name|FT_TRACE4
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_block
begin_comment
comment|/* END */
end_comment
end_unit
