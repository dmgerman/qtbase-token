begin_unit
begin_comment
comment|/***************************************************************************/
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  ftrend1.c                                                              */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*    The FreeType glyph rasterizer interface (body).                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  Copyright 1996-2001, 2002, 2003, 2005, 2006 by                         */
end_comment
begin_comment
comment|/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/*  This file is part of the FreeType project, and may only be used,       */
end_comment
begin_comment
comment|/*  modified, and distributed under the terms of the FreeType project      */
end_comment
begin_comment
comment|/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
end_comment
begin_comment
comment|/*  this file you indicate that you have read the license and              */
end_comment
begin_comment
comment|/*  understand and accept it fully.                                        */
end_comment
begin_comment
comment|/*                                                                         */
end_comment
begin_comment
comment|/***************************************************************************/
end_comment
begin_include
include|#
directive|include
file|<ft2build.h>
end_include
begin_include
include|#
directive|include
include|FT_INTERNAL_OBJECTS_H
end_include
begin_include
include|#
directive|include
include|FT_OUTLINE_H
end_include
begin_include
include|#
directive|include
file|"ftrend1.h"
end_include
begin_include
include|#
directive|include
file|"ftraster.h"
end_include
begin_include
include|#
directive|include
file|"rastpic.h"
end_include
begin_include
include|#
directive|include
file|"rasterrs.h"
end_include
begin_comment
comment|/* initialize renderer -- init its raster */
end_comment
begin_function
specifier|static
name|FT_Error
DECL|function|ft_raster1_init
name|ft_raster1_init
parameter_list|(
name|FT_Renderer
name|render
parameter_list|)
block|{
name|FT_Library
name|library
init|=
name|FT_MODULE_LIBRARY
argument_list|(
name|render
argument_list|)
decl_stmt|;
name|render
operator|->
name|clazz
operator|->
name|raster_class
operator|->
name|raster_reset
argument_list|(
name|render
operator|->
name|raster
argument_list|,
name|library
operator|->
name|raster_pool
argument_list|,
name|library
operator|->
name|raster_pool_size
argument_list|)
expr_stmt|;
return|return
name|Raster_Err_Ok
return|;
block|}
end_function
begin_comment
comment|/* set render-specific mode */
end_comment
begin_function
specifier|static
name|FT_Error
DECL|function|ft_raster1_set_mode
name|ft_raster1_set_mode
parameter_list|(
name|FT_Renderer
name|render
parameter_list|,
name|FT_ULong
name|mode_tag
parameter_list|,
name|FT_Pointer
name|data
parameter_list|)
block|{
comment|/* we simply pass it to the raster */
return|return
name|render
operator|->
name|clazz
operator|->
name|raster_class
operator|->
name|raster_set_mode
argument_list|(
name|render
operator|->
name|raster
argument_list|,
name|mode_tag
argument_list|,
name|data
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/* transform a given glyph image */
end_comment
begin_function
specifier|static
name|FT_Error
DECL|function|ft_raster1_transform
name|ft_raster1_transform
parameter_list|(
name|FT_Renderer
name|render
parameter_list|,
name|FT_GlyphSlot
name|slot
parameter_list|,
specifier|const
name|FT_Matrix
modifier|*
name|matrix
parameter_list|,
specifier|const
name|FT_Vector
modifier|*
name|delta
parameter_list|)
block|{
name|FT_Error
name|error
init|=
name|Raster_Err_Ok
decl_stmt|;
if|if
condition|(
name|slot
operator|->
name|format
operator|!=
name|render
operator|->
name|glyph_format
condition|)
block|{
name|error
operator|=
name|Raster_Err_Invalid_Argument
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|matrix
condition|)
name|FT_Outline_Transform
argument_list|(
operator|&
name|slot
operator|->
name|outline
argument_list|,
name|matrix
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
condition|)
name|FT_Outline_Translate
argument_list|(
operator|&
name|slot
operator|->
name|outline
argument_list|,
name|delta
operator|->
name|x
argument_list|,
name|delta
operator|->
name|y
argument_list|)
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_function
begin_comment
comment|/* return the glyph's control box */
end_comment
begin_function
specifier|static
name|void
DECL|function|ft_raster1_get_cbox
name|ft_raster1_get_cbox
parameter_list|(
name|FT_Renderer
name|render
parameter_list|,
name|FT_GlyphSlot
name|slot
parameter_list|,
name|FT_BBox
modifier|*
name|cbox
parameter_list|)
block|{
name|FT_MEM_ZERO
argument_list|(
name|cbox
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cbox
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|->
name|format
operator|==
name|render
operator|->
name|glyph_format
condition|)
name|FT_Outline_Get_CBox
argument_list|(
operator|&
name|slot
operator|->
name|outline
argument_list|,
name|cbox
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|/* convert a slot's glyph image into a bitmap */
end_comment
begin_function
specifier|static
name|FT_Error
DECL|function|ft_raster1_render
name|ft_raster1_render
parameter_list|(
name|FT_Renderer
name|render
parameter_list|,
name|FT_GlyphSlot
name|slot
parameter_list|,
name|FT_Render_Mode
name|mode
parameter_list|,
specifier|const
name|FT_Vector
modifier|*
name|origin
parameter_list|)
block|{
name|FT_Error
name|error
decl_stmt|;
name|FT_Outline
modifier|*
name|outline
decl_stmt|;
name|FT_BBox
name|cbox
decl_stmt|;
name|FT_UInt
name|width
decl_stmt|,
name|height
decl_stmt|,
name|pitch
decl_stmt|;
name|FT_Bitmap
modifier|*
name|bitmap
decl_stmt|;
name|FT_Memory
name|memory
decl_stmt|;
name|FT_Raster_Params
name|params
decl_stmt|;
comment|/* check glyph image format */
if|if
condition|(
name|slot
operator|->
name|format
operator|!=
name|render
operator|->
name|glyph_format
condition|)
block|{
name|error
operator|=
name|Raster_Err_Invalid_Argument
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* check rendering mode */
ifndef|#
directive|ifndef
name|FT_CONFIG_OPTION_PIC
if|if
condition|(
name|mode
operator|!=
name|FT_RENDER_MODE_MONO
condition|)
block|{
comment|/* raster1 is only capable of producing monochrome bitmaps */
if|if
condition|(
name|render
operator|->
name|clazz
operator|==
operator|&
name|ft_raster1_renderer_class
condition|)
return|return
name|Raster_Err_Cannot_Render_Glyph
return|;
block|}
else|else
block|{
comment|/* raster5 is only capable of producing 5-gray-levels bitmaps */
if|if
condition|(
name|render
operator|->
name|clazz
operator|==
operator|&
name|ft_raster5_renderer_class
condition|)
return|return
name|Raster_Err_Cannot_Render_Glyph
return|;
block|}
else|#
directive|else
comment|/* FT_CONFIG_OPTION_PIC */
comment|/* When PIC is enabled, we cannot get to the class object      */
comment|/* so instead we check the final character in the class name   */
comment|/* ("raster5" or "raster1"). Yes this is a hack.               */
comment|/* The "correct" thing to do is have different render function */
comment|/* for each of the classes.                                    */
if|if
condition|(
name|mode
operator|!=
name|FT_RENDER_MODE_MONO
condition|)
block|{
comment|/* raster1 is only capable of producing monochrome bitmaps */
if|if
condition|(
name|render
operator|->
name|clazz
operator|->
name|root
operator|.
name|module_name
index|[
literal|6
index|]
operator|==
literal|'1'
condition|)
return|return
name|Raster_Err_Cannot_Render_Glyph
return|;
block|}
else|else
block|{
comment|/* raster5 is only capable of producing 5-gray-levels bitmaps */
if|if
condition|(
name|render
operator|->
name|clazz
operator|->
name|root
operator|.
name|module_name
index|[
literal|6
index|]
operator|==
literal|'5'
condition|)
return|return
name|Raster_Err_Cannot_Render_Glyph
return|;
block|}
endif|#
directive|endif
comment|/* FT_CONFIG_OPTION_PIC */
name|outline
operator|=
operator|&
name|slot
operator|->
name|outline
expr_stmt|;
comment|/* translate the outline to the new origin if needed */
if|if
condition|(
name|origin
condition|)
name|FT_Outline_Translate
argument_list|(
name|outline
argument_list|,
name|origin
operator|->
name|x
argument_list|,
name|origin
operator|->
name|y
argument_list|)
expr_stmt|;
comment|/* compute the control box, and grid fit it */
name|FT_Outline_Get_CBox
argument_list|(
name|outline
argument_list|,
operator|&
name|cbox
argument_list|)
expr_stmt|;
name|cbox
operator|.
name|xMin
operator|=
name|FT_PIX_FLOOR
argument_list|(
name|cbox
operator|.
name|xMin
argument_list|)
expr_stmt|;
name|cbox
operator|.
name|yMin
operator|=
name|FT_PIX_FLOOR
argument_list|(
name|cbox
operator|.
name|yMin
argument_list|)
expr_stmt|;
name|cbox
operator|.
name|xMax
operator|=
name|FT_PIX_CEIL
argument_list|(
name|cbox
operator|.
name|xMax
argument_list|)
expr_stmt|;
name|cbox
operator|.
name|yMax
operator|=
name|FT_PIX_CEIL
argument_list|(
name|cbox
operator|.
name|yMax
argument_list|)
expr_stmt|;
name|width
operator|=
call|(
name|FT_UInt
call|)
argument_list|(
operator|(
name|cbox
operator|.
name|xMax
operator|-
name|cbox
operator|.
name|xMin
operator|)
operator|>>
literal|6
argument_list|)
expr_stmt|;
name|height
operator|=
call|(
name|FT_UInt
call|)
argument_list|(
operator|(
name|cbox
operator|.
name|yMax
operator|-
name|cbox
operator|.
name|yMin
operator|)
operator|>>
literal|6
argument_list|)
expr_stmt|;
name|bitmap
operator|=
operator|&
name|slot
operator|->
name|bitmap
expr_stmt|;
name|memory
operator|=
name|render
operator|->
name|root
operator|.
name|memory
expr_stmt|;
comment|/* release old bitmap buffer */
if|if
condition|(
name|slot
operator|->
name|internal
operator|->
name|flags
operator|&
name|FT_GLYPH_OWN_BITMAP
condition|)
block|{
name|FT_FREE
argument_list|(
name|bitmap
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|slot
operator|->
name|internal
operator|->
name|flags
operator|&=
operator|~
name|FT_GLYPH_OWN_BITMAP
expr_stmt|;
block|}
comment|/* allocate new one, depends on pixel format */
if|if
condition|(
operator|!
operator|(
name|mode
operator|&
name|FT_RENDER_MODE_MONO
operator|)
condition|)
block|{
comment|/* we pad to 32 bits, only for backwards compatibility with FT 1.x */
name|pitch
operator|=
name|FT_PAD_CEIL
argument_list|(
name|width
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bitmap
operator|->
name|pixel_mode
operator|=
name|FT_PIXEL_MODE_GRAY
expr_stmt|;
name|bitmap
operator|->
name|num_grays
operator|=
literal|256
expr_stmt|;
block|}
else|else
block|{
name|pitch
operator|=
operator|(
operator|(
name|width
operator|+
literal|15
operator|)
operator|>>
literal|4
operator|)
operator|<<
literal|1
expr_stmt|;
name|bitmap
operator|->
name|pixel_mode
operator|=
name|FT_PIXEL_MODE_MONO
expr_stmt|;
block|}
name|bitmap
operator|->
name|width
operator|=
name|width
expr_stmt|;
name|bitmap
operator|->
name|rows
operator|=
name|height
expr_stmt|;
name|bitmap
operator|->
name|pitch
operator|=
name|pitch
expr_stmt|;
if|if
condition|(
name|FT_ALLOC_MULT
argument_list|(
name|bitmap
operator|->
name|buffer
argument_list|,
name|pitch
argument_list|,
name|height
argument_list|)
condition|)
goto|goto
name|Exit
goto|;
name|slot
operator|->
name|internal
operator|->
name|flags
operator||=
name|FT_GLYPH_OWN_BITMAP
expr_stmt|;
comment|/* translate outline to render it into the bitmap */
name|FT_Outline_Translate
argument_list|(
name|outline
argument_list|,
operator|-
name|cbox
operator|.
name|xMin
argument_list|,
operator|-
name|cbox
operator|.
name|yMin
argument_list|)
expr_stmt|;
comment|/* set up parameters */
name|params
operator|.
name|target
operator|=
name|bitmap
expr_stmt|;
name|params
operator|.
name|source
operator|=
name|outline
expr_stmt|;
name|params
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bitmap
operator|->
name|pixel_mode
operator|==
name|FT_PIXEL_MODE_GRAY
condition|)
name|params
operator|.
name|flags
operator||=
name|FT_RASTER_FLAG_AA
expr_stmt|;
comment|/* render outline into the bitmap */
name|error
operator|=
name|render
operator|->
name|raster_render
argument_list|(
name|render
operator|->
name|raster
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|FT_Outline_Translate
argument_list|(
name|outline
argument_list|,
name|cbox
operator|.
name|xMin
argument_list|,
name|cbox
operator|.
name|yMin
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|Exit
goto|;
name|slot
operator|->
name|format
operator|=
name|FT_GLYPH_FORMAT_BITMAP
expr_stmt|;
name|slot
operator|->
name|bitmap_left
operator|=
call|(
name|FT_Int
call|)
argument_list|(
name|cbox
operator|.
name|xMin
operator|>>
literal|6
argument_list|)
expr_stmt|;
name|slot
operator|->
name|bitmap_top
operator|=
call|(
name|FT_Int
call|)
argument_list|(
name|cbox
operator|.
name|yMax
operator|>>
literal|6
argument_list|)
expr_stmt|;
name|Exit
label|:
return|return
name|error
return|;
block|}
end_function
begin_macro
name|FT_DEFINE_RENDERER
argument_list|(
argument|ft_raster1_renderer_class
argument_list|,
argument|FT_MODULE_RENDERER
argument_list|,
argument|sizeof( FT_RendererRec )
argument_list|,
literal|"raster1"
argument_list|,
literal|0x10000L
argument_list|,
literal|0x20000L
argument_list|,
literal|0
argument_list|,
comment|/* module specific interface */
argument|(FT_Module_Constructor)ft_raster1_init
argument_list|,
argument|(FT_Module_Destructor)
literal|0
argument_list|,
argument|(FT_Module_Requester)
literal|0
argument_list|,
argument|FT_GLYPH_FORMAT_OUTLINE
argument_list|,
argument|(FT_Renderer_RenderFunc)   ft_raster1_render
argument_list|,
argument|(FT_Renderer_TransformFunc)ft_raster1_transform
argument_list|,
argument|(FT_Renderer_GetCBoxFunc)  ft_raster1_get_cbox
argument_list|,
argument|(FT_Renderer_SetModeFunc)  ft_raster1_set_mode
argument_list|,
argument|(FT_Raster_Funcs*)&FT_STANDARD_RASTER_GET
argument_list|)
end_macro
begin_comment
comment|/* This renderer is _NOT_ part of the default modules; you will need */
end_comment
begin_comment
comment|/* to register it by hand in your application.  It should only be    */
end_comment
begin_comment
comment|/* used for backwards-compatibility with FT 1.x anyway.              */
end_comment
begin_comment
comment|/*                                                                   */
end_comment
begin_macro
name|FT_DEFINE_RENDERER
argument_list|(
argument|ft_raster5_renderer_class
argument_list|,
argument|FT_MODULE_RENDERER
argument_list|,
argument|sizeof( FT_RendererRec )
argument_list|,
literal|"raster5"
argument_list|,
literal|0x10000L
argument_list|,
literal|0x20000L
argument_list|,
literal|0
argument_list|,
comment|/* module specific interface */
argument|(FT_Module_Constructor)ft_raster1_init
argument_list|,
argument|(FT_Module_Destructor)
literal|0
argument_list|,
argument|(FT_Module_Requester)
literal|0
argument_list|,
argument|FT_GLYPH_FORMAT_OUTLINE
argument_list|,
argument|(FT_Renderer_RenderFunc)   ft_raster1_render
argument_list|,
argument|(FT_Renderer_TransformFunc)ft_raster1_transform
argument_list|,
argument|(FT_Renderer_GetCBoxFunc)  ft_raster1_get_cbox
argument_list|,
argument|(FT_Renderer_SetModeFunc)  ft_raster1_set_mode
argument_list|,
argument|(FT_Raster_Funcs*)&FT_STANDARD_RASTER_GET
argument_list|)
end_macro
begin_comment
comment|/* END */
end_comment
end_unit
