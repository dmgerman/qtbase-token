begin_unit
begin_comment
comment|//
end_comment
begin_comment
comment|// Copyright (c) 2012 The ANGLE Project Authors. All rights reserved.
end_comment
begin_comment
comment|// Use of this source code is governed by a BSD-style license that can be
end_comment
begin_comment
comment|// found in the LICENSE file.
end_comment
begin_comment
comment|//
end_comment
begin_include
include|#
directive|include
file|"compiler/InitializeParseContext.h"
end_include
begin_include
include|#
directive|include
file|"compiler/osinclude.h"
end_include
begin_decl_stmt
DECL|variable|GlobalParseContextIndex
name|OS_TLSIndex
name|GlobalParseContextIndex
init|=
name|OS_INVALID_TLS_INDEX
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|InitializeParseContextIndex
name|bool
name|InitializeParseContextIndex
parameter_list|()
block|{
if|if
condition|(
name|GlobalParseContextIndex
operator|!=
name|OS_INVALID_TLS_INDEX
condition|)
block|{
name|assert
argument_list|(
literal|0
operator|&&
literal|"InitializeParseContextIndex(): Parse Context already initalized"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
comment|//
comment|// Allocate a TLS index.
comment|//
name|GlobalParseContextIndex
operator|=
name|OS_AllocTLSIndex
argument_list|()
expr_stmt|;
if|if
condition|(
name|GlobalParseContextIndex
operator|==
name|OS_INVALID_TLS_INDEX
condition|)
block|{
name|assert
argument_list|(
literal|0
operator|&&
literal|"InitializeParseContextIndex(): Parse Context already initalized"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|FreeParseContextIndex
name|bool
name|FreeParseContextIndex
parameter_list|()
block|{
name|OS_TLSIndex
name|tlsiIndex
init|=
name|GlobalParseContextIndex
decl_stmt|;
if|if
condition|(
name|GlobalParseContextIndex
operator|==
name|OS_INVALID_TLS_INDEX
condition|)
block|{
name|assert
argument_list|(
literal|0
operator|&&
literal|"FreeParseContextIndex(): Parse Context index not initalized"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|GlobalParseContextIndex
operator|=
name|OS_INVALID_TLS_INDEX
expr_stmt|;
return|return
name|OS_FreeTLSIndex
argument_list|(
name|tlsiIndex
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|InitializeGlobalParseContext
name|bool
name|InitializeGlobalParseContext
parameter_list|()
block|{
if|if
condition|(
name|GlobalParseContextIndex
operator|==
name|OS_INVALID_TLS_INDEX
condition|)
block|{
name|assert
argument_list|(
literal|0
operator|&&
literal|"InitializeGlobalParseContext(): Parse Context index not initalized"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|TThreadParseContext
modifier|*
name|lpParseContext
init|=
cast|static_cast
argument_list|<
name|TThreadParseContext
operator|*
argument_list|>
argument_list|(
name|OS_GetTLSValue
argument_list|(
name|GlobalParseContextIndex
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|lpParseContext
operator|!=
literal|0
condition|)
block|{
name|assert
argument_list|(
literal|0
operator|&&
literal|"InitializeParseContextIndex(): Parse Context already initalized"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|TThreadParseContext
modifier|*
name|lpThreadData
init|=
operator|new
name|TThreadParseContext
argument_list|()
decl_stmt|;
if|if
condition|(
name|lpThreadData
operator|==
literal|0
condition|)
block|{
name|assert
argument_list|(
literal|0
operator|&&
literal|"InitializeGlobalParseContext(): Unable to create thread parse context"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|lpThreadData
operator|->
name|lpGlobalParseContext
operator|=
literal|0
expr_stmt|;
name|OS_SetTLSValue
argument_list|(
name|GlobalParseContextIndex
argument_list|,
name|lpThreadData
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|FreeParseContext
name|bool
name|FreeParseContext
parameter_list|()
block|{
if|if
condition|(
name|GlobalParseContextIndex
operator|==
name|OS_INVALID_TLS_INDEX
condition|)
block|{
name|assert
argument_list|(
literal|0
operator|&&
literal|"FreeParseContext(): Parse Context index not initalized"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|TThreadParseContext
modifier|*
name|lpParseContext
init|=
cast|static_cast
argument_list|<
name|TThreadParseContext
operator|*
argument_list|>
argument_list|(
name|OS_GetTLSValue
argument_list|(
name|GlobalParseContextIndex
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|lpParseContext
condition|)
operator|delete
name|lpParseContext
expr_stmt|;
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|GetGlobalParseContext
name|TParseContextPointer
modifier|&
name|GetGlobalParseContext
parameter_list|()
block|{
comment|//
comment|// Minimal error checking for speed
comment|//
name|TThreadParseContext
modifier|*
name|lpParseContext
init|=
cast|static_cast
argument_list|<
name|TThreadParseContext
operator|*
argument_list|>
argument_list|(
name|OS_GetTLSValue
argument_list|(
name|GlobalParseContextIndex
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|lpParseContext
operator|->
name|lpGlobalParseContext
return|;
block|}
end_function
end_unit
