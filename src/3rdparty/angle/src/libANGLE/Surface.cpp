begin_unit
begin_comment
comment|//
end_comment
begin_comment
comment|// Copyright (c) 2002-2014 The ANGLE Project Authors. All rights reserved.
end_comment
begin_comment
comment|// Use of this source code is governed by a BSD-style license that can be
end_comment
begin_comment
comment|// found in the LICENSE file.
end_comment
begin_comment
comment|//
end_comment
begin_comment
comment|// Surface.cpp: Implements the egl::Surface class, representing a drawing surface
end_comment
begin_comment
comment|// such as the client area of a window, including any back buffers.
end_comment
begin_comment
comment|// Implements EGLSurface and related functionality. [EGL 1.4] section 2.2 page 3.
end_comment
begin_include
include|#
directive|include
file|"libANGLE/Surface.h"
end_include
begin_include
include|#
directive|include
file|"libANGLE/Config.h"
end_include
begin_include
include|#
directive|include
file|"libANGLE/Framebuffer.h"
end_include
begin_include
include|#
directive|include
file|"libANGLE/Texture.h"
end_include
begin_include
include|#
directive|include
file|<EGL/eglext.h>
end_include
begin_include
include|#
directive|include
file|<iostream>
end_include
begin_namespace
DECL|namespace|egl
namespace|namespace
name|egl
block|{
DECL|function|Surface
name|Surface
operator|::
name|Surface
parameter_list|(
name|rx
operator|::
name|SurfaceImpl
modifier|*
name|impl
parameter_list|,
name|EGLint
name|surfaceType
parameter_list|,
specifier|const
name|egl
operator|::
name|Config
modifier|*
name|config
parameter_list|,
specifier|const
name|AttributeMap
modifier|&
name|attributes
parameter_list|)
member_init_list|:
name|FramebufferAttachmentObject
argument_list|()
member_init_list|,
name|mImplementation
argument_list|(
name|impl
argument_list|)
member_init_list|,
name|mDefaultFramebuffer
argument_list|(
literal|nullptr
argument_list|)
member_init_list|,
name|mCurrentCount
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|mDestroyed
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|mType
argument_list|(
name|surfaceType
argument_list|)
member_init_list|,
name|mConfig
argument_list|(
name|config
argument_list|)
member_init_list|,
name|mPostSubBufferRequested
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|mFixedSize
argument_list|(
literal|false
argument_list|)
member_init_list|,
name|mFixedWidth
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|mFixedHeight
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|mTextureFormat
argument_list|(
name|EGL_NO_TEXTURE
argument_list|)
member_init_list|,
name|mTextureTarget
argument_list|(
name|EGL_NO_TEXTURE
argument_list|)
member_init_list|,
comment|// FIXME: Determine actual pixel aspect ratio
name|mPixelAspectRatio
argument_list|(
cast|static_cast
argument_list|<
name|EGLint
argument_list|>
argument_list|(
literal|1.0
operator|*
name|EGL_DISPLAY_SCALING
argument_list|)
argument_list|)
member_init_list|,
name|mRenderBuffer
argument_list|(
name|EGL_BACK_BUFFER
argument_list|)
member_init_list|,
name|mSwapBehavior
argument_list|(
name|impl
operator|->
name|getSwapBehavior
argument_list|()
argument_list|)
member_init_list|,
name|mOrientation
argument_list|(
literal|0
argument_list|)
member_init_list|,
name|mTexture
argument_list|()
block|{
name|mPostSubBufferRequested
operator|=
operator|(
name|attributes
operator|.
name|get
argument_list|(
name|EGL_POST_SUB_BUFFER_SUPPORTED_NV
argument_list|,
name|EGL_FALSE
argument_list|)
operator|==
name|EGL_TRUE
operator|)
expr_stmt|;
name|mFlexibleSurfaceCompatibilityRequested
operator|=
operator|(
name|attributes
operator|.
name|get
argument_list|(
name|EGL_FLEXIBLE_SURFACE_COMPATIBILITY_SUPPORTED_ANGLE
argument_list|,
name|EGL_FALSE
argument_list|)
operator|==
name|EGL_TRUE
operator|)
expr_stmt|;
name|mDirectComposition
operator|=
operator|(
name|attributes
operator|.
name|get
argument_list|(
name|EGL_DIRECT_COMPOSITION_ANGLE
argument_list|,
name|EGL_FALSE
argument_list|)
operator|==
name|EGL_TRUE
operator|)
expr_stmt|;
name|mFixedSize
operator|=
operator|(
name|attributes
operator|.
name|get
argument_list|(
name|EGL_FIXED_SIZE_ANGLE
argument_list|,
name|EGL_FALSE
argument_list|)
operator|==
name|EGL_TRUE
operator|)
expr_stmt|;
if|if
condition|(
name|mFixedSize
condition|)
block|{
name|mFixedWidth
operator|=
name|attributes
operator|.
name|get
argument_list|(
name|EGL_WIDTH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mFixedHeight
operator|=
name|attributes
operator|.
name|get
argument_list|(
name|EGL_HEIGHT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mType
operator|!=
name|EGL_WINDOW_BIT
condition|)
block|{
name|mTextureFormat
operator|=
name|attributes
operator|.
name|get
argument_list|(
name|EGL_TEXTURE_FORMAT
argument_list|,
name|EGL_NO_TEXTURE
argument_list|)
expr_stmt|;
name|mTextureTarget
operator|=
name|attributes
operator|.
name|get
argument_list|(
name|EGL_TEXTURE_TARGET
argument_list|,
name|EGL_NO_TEXTURE
argument_list|)
expr_stmt|;
block|}
name|mOrientation
operator|=
name|attributes
operator|.
name|get
argument_list|(
name|EGL_SURFACE_ORIENTATION_ANGLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mDefaultFramebuffer
operator|=
name|createDefaultFramebuffer
argument_list|()
expr_stmt|;
name|ASSERT
argument_list|(
name|mDefaultFramebuffer
operator|!=
literal|nullptr
argument_list|)
expr_stmt|;
block|}
DECL|function|~Surface
name|Surface
operator|::
name|~
name|Surface
parameter_list|()
block|{
if|if
condition|(
name|mTexture
operator|.
name|get
argument_list|()
condition|)
block|{
if|if
condition|(
name|mImplementation
condition|)
block|{
name|mImplementation
operator|->
name|releaseTexImage
argument_list|(
name|EGL_BACK_BUFFER
argument_list|)
expr_stmt|;
block|}
name|mTexture
operator|->
name|releaseTexImageFromSurface
argument_list|()
expr_stmt|;
name|mTexture
operator|.
name|set
argument_list|(
literal|nullptr
argument_list|)
expr_stmt|;
block|}
name|SafeDelete
argument_list|(
name|mDefaultFramebuffer
argument_list|)
expr_stmt|;
name|SafeDelete
argument_list|(
name|mImplementation
argument_list|)
expr_stmt|;
block|}
DECL|function|setIsCurrent
name|void
name|Surface
operator|::
name|setIsCurrent
parameter_list|(
name|bool
name|isCurrent
parameter_list|)
block|{
if|if
condition|(
name|isCurrent
condition|)
block|{
name|mCurrentCount
operator|++
expr_stmt|;
block|}
else|else
block|{
name|ASSERT
argument_list|(
name|mCurrentCount
operator|>
literal|0
argument_list|)
expr_stmt|;
name|mCurrentCount
operator|--
expr_stmt|;
if|if
condition|(
name|mCurrentCount
operator|==
literal|0
operator|&&
name|mDestroyed
condition|)
block|{
operator|delete
name|this
expr_stmt|;
block|}
block|}
block|}
DECL|function|onDestroy
name|void
name|Surface
operator|::
name|onDestroy
parameter_list|()
block|{
name|mDestroyed
operator|=
literal|true
expr_stmt|;
if|if
condition|(
name|mCurrentCount
operator|==
literal|0
condition|)
block|{
operator|delete
name|this
expr_stmt|;
block|}
block|}
DECL|function|getType
name|EGLint
name|Surface
operator|::
name|getType
parameter_list|()
specifier|const
block|{
return|return
name|mType
return|;
block|}
DECL|function|swap
name|Error
name|Surface
operator|::
name|swap
parameter_list|()
block|{
return|return
name|mImplementation
operator|->
name|swap
argument_list|()
return|;
block|}
DECL|function|postSubBuffer
name|Error
name|Surface
operator|::
name|postSubBuffer
parameter_list|(
name|EGLint
name|x
parameter_list|,
name|EGLint
name|y
parameter_list|,
name|EGLint
name|width
parameter_list|,
name|EGLint
name|height
parameter_list|)
block|{
return|return
name|mImplementation
operator|->
name|postSubBuffer
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
return|;
block|}
DECL|function|querySurfacePointerANGLE
name|Error
name|Surface
operator|::
name|querySurfacePointerANGLE
parameter_list|(
name|EGLint
name|attribute
parameter_list|,
name|void
modifier|*
modifier|*
name|value
parameter_list|)
block|{
return|return
name|mImplementation
operator|->
name|querySurfacePointerANGLE
argument_list|(
name|attribute
argument_list|,
name|value
argument_list|)
return|;
block|}
DECL|function|isPostSubBufferSupported
name|EGLint
name|Surface
operator|::
name|isPostSubBufferSupported
parameter_list|()
specifier|const
block|{
return|return
name|mPostSubBufferRequested
operator|&&
name|mImplementation
operator|->
name|isPostSubBufferSupported
argument_list|()
return|;
block|}
DECL|function|setSwapInterval
name|void
name|Surface
operator|::
name|setSwapInterval
parameter_list|(
name|EGLint
name|interval
parameter_list|)
block|{
name|mImplementation
operator|->
name|setSwapInterval
argument_list|(
name|interval
argument_list|)
expr_stmt|;
block|}
DECL|function|getConfig
specifier|const
name|Config
modifier|*
name|Surface
operator|::
name|getConfig
parameter_list|()
specifier|const
block|{
return|return
name|mConfig
return|;
block|}
DECL|function|getPixelAspectRatio
name|EGLint
name|Surface
operator|::
name|getPixelAspectRatio
parameter_list|()
specifier|const
block|{
return|return
name|mPixelAspectRatio
return|;
block|}
DECL|function|getRenderBuffer
name|EGLenum
name|Surface
operator|::
name|getRenderBuffer
parameter_list|()
specifier|const
block|{
return|return
name|mRenderBuffer
return|;
block|}
DECL|function|getSwapBehavior
name|EGLenum
name|Surface
operator|::
name|getSwapBehavior
parameter_list|()
specifier|const
block|{
return|return
name|mSwapBehavior
return|;
block|}
DECL|function|getTextureFormat
name|EGLenum
name|Surface
operator|::
name|getTextureFormat
parameter_list|()
specifier|const
block|{
return|return
name|mTextureFormat
return|;
block|}
DECL|function|getTextureTarget
name|EGLenum
name|Surface
operator|::
name|getTextureTarget
parameter_list|()
specifier|const
block|{
return|return
name|mTextureTarget
return|;
block|}
DECL|function|isFixedSize
name|EGLint
name|Surface
operator|::
name|isFixedSize
parameter_list|()
specifier|const
block|{
return|return
name|mFixedSize
return|;
block|}
DECL|function|getWidth
name|EGLint
name|Surface
operator|::
name|getWidth
parameter_list|()
specifier|const
block|{
return|return
name|mFixedSize
condition|?
cast|static_cast
argument_list|<
name|EGLint
argument_list|>
argument_list|(
name|mFixedWidth
argument_list|)
else|:
name|mImplementation
operator|->
name|getWidth
argument_list|()
return|;
block|}
DECL|function|getHeight
name|EGLint
name|Surface
operator|::
name|getHeight
parameter_list|()
specifier|const
block|{
return|return
name|mFixedSize
condition|?
cast|static_cast
argument_list|<
name|EGLint
argument_list|>
argument_list|(
name|mFixedHeight
argument_list|)
else|:
name|mImplementation
operator|->
name|getHeight
argument_list|()
return|;
block|}
DECL|function|bindTexImage
name|Error
name|Surface
operator|::
name|bindTexImage
parameter_list|(
name|gl
operator|::
name|Texture
modifier|*
name|texture
parameter_list|,
name|EGLint
name|buffer
parameter_list|)
block|{
name|ASSERT
argument_list|(
operator|!
name|mTexture
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
name|texture
operator|->
name|bindTexImageFromSurface
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|mTexture
operator|.
name|set
argument_list|(
name|texture
argument_list|)
expr_stmt|;
return|return
name|mImplementation
operator|->
name|bindTexImage
argument_list|(
name|texture
argument_list|,
name|buffer
argument_list|)
return|;
block|}
DECL|function|releaseTexImage
name|Error
name|Surface
operator|::
name|releaseTexImage
parameter_list|(
name|EGLint
name|buffer
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|mTexture
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
name|mTexture
operator|->
name|releaseTexImageFromSurface
argument_list|()
expr_stmt|;
name|mTexture
operator|.
name|set
argument_list|(
literal|nullptr
argument_list|)
expr_stmt|;
return|return
name|mImplementation
operator|->
name|releaseTexImage
argument_list|(
name|buffer
argument_list|)
return|;
block|}
DECL|function|releaseTexImageFromTexture
name|void
name|Surface
operator|::
name|releaseTexImageFromTexture
parameter_list|()
block|{
name|ASSERT
argument_list|(
name|mTexture
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
name|mTexture
operator|.
name|set
argument_list|(
literal|nullptr
argument_list|)
expr_stmt|;
block|}
DECL|function|getAttachmentSize
name|gl
operator|::
name|Extents
name|Surface
operator|::
name|getAttachmentSize
parameter_list|(
specifier|const
name|gl
operator|::
name|FramebufferAttachment
operator|::
name|Target
modifier|&
comment|/*target*/
parameter_list|)
specifier|const
block|{
return|return
name|gl
operator|::
name|Extents
argument_list|(
name|getWidth
argument_list|()
argument_list|,
name|getHeight
argument_list|()
argument_list|,
literal|1
argument_list|)
return|;
block|}
DECL|function|getAttachmentInternalFormat
name|GLenum
name|Surface
operator|::
name|getAttachmentInternalFormat
parameter_list|(
specifier|const
name|gl
operator|::
name|FramebufferAttachment
operator|::
name|Target
modifier|&
name|target
parameter_list|)
specifier|const
block|{
specifier|const
name|egl
operator|::
name|Config
modifier|*
name|config
init|=
name|getConfig
argument_list|()
decl_stmt|;
return|return
operator|(
name|target
operator|.
name|binding
argument_list|()
operator|==
name|GL_BACK
condition|?
name|config
operator|->
name|renderTargetFormat
else|:
name|config
operator|->
name|depthStencilFormat
operator|)
return|;
block|}
DECL|function|getAttachmentSamples
name|GLsizei
name|Surface
operator|::
name|getAttachmentSamples
parameter_list|(
specifier|const
name|gl
operator|::
name|FramebufferAttachment
operator|::
name|Target
modifier|&
name|target
parameter_list|)
specifier|const
block|{
return|return
name|getConfig
argument_list|()
operator|->
name|samples
return|;
block|}
DECL|function|getId
name|GLuint
name|Surface
operator|::
name|getId
parameter_list|()
specifier|const
block|{
name|UNREACHABLE
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
DECL|function|createDefaultFramebuffer
name|gl
operator|::
name|Framebuffer
modifier|*
name|Surface
operator|::
name|createDefaultFramebuffer
parameter_list|()
block|{
name|gl
operator|::
name|Framebuffer
modifier|*
name|framebuffer
init|=
operator|new
name|gl
operator|::
name|Framebuffer
argument_list|(
name|mImplementation
argument_list|)
decl_stmt|;
name|GLenum
name|drawBufferState
init|=
name|GL_BACK
decl_stmt|;
name|framebuffer
operator|->
name|setDrawBuffers
argument_list|(
literal|1
argument_list|,
operator|&
name|drawBufferState
argument_list|)
expr_stmt|;
name|framebuffer
operator|->
name|setReadBuffer
argument_list|(
name|GL_BACK
argument_list|)
expr_stmt|;
name|framebuffer
operator|->
name|setAttachment
argument_list|(
name|GL_FRAMEBUFFER_DEFAULT
argument_list|,
name|GL_BACK
argument_list|,
name|gl
operator|::
name|ImageIndex
operator|::
name|MakeInvalid
argument_list|()
argument_list|,
name|this
argument_list|)
expr_stmt|;
if|if
condition|(
name|mConfig
operator|->
name|depthSize
operator|>
literal|0
condition|)
block|{
name|framebuffer
operator|->
name|setAttachment
argument_list|(
name|GL_FRAMEBUFFER_DEFAULT
argument_list|,
name|GL_DEPTH
argument_list|,
name|gl
operator|::
name|ImageIndex
operator|::
name|MakeInvalid
argument_list|()
argument_list|,
name|this
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mConfig
operator|->
name|stencilSize
operator|>
literal|0
condition|)
block|{
name|framebuffer
operator|->
name|setAttachment
argument_list|(
name|GL_FRAMEBUFFER_DEFAULT
argument_list|,
name|GL_STENCIL
argument_list|,
name|gl
operator|::
name|ImageIndex
operator|::
name|MakeInvalid
argument_list|()
argument_list|,
name|this
argument_list|)
expr_stmt|;
block|}
return|return
name|framebuffer
return|;
block|}
block|}
end_namespace
end_unit
