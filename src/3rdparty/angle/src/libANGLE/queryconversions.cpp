begin_unit
begin_comment
comment|//
end_comment
begin_comment
comment|// Copyright (c) 2014 The ANGLE Project Authors. All rights reserved.
end_comment
begin_comment
comment|// Use of this source code is governed by a BSD-style license that can be
end_comment
begin_comment
comment|// found in the LICENSE file.
end_comment
begin_comment
comment|//
end_comment
begin_comment
comment|// queryconversions.cpp: Implementation of state query cast conversions
end_comment
begin_include
include|#
directive|include
file|"libANGLE/queryconversions.h"
end_include
begin_include
include|#
directive|include
file|<vector>
end_include
begin_include
include|#
directive|include
file|"libANGLE/Context.h"
end_include
begin_include
include|#
directive|include
file|"common/utilities.h"
end_include
begin_namespace
DECL|namespace|gl
namespace|namespace
name|gl
block|{
namespace|namespace
block|{
DECL|function|ExpandFloatToInteger
name|GLint64
name|ExpandFloatToInteger
parameter_list|(
name|GLfloat
name|value
parameter_list|)
block|{
return|return
cast|static_cast
argument_list|<
name|GLint64
argument_list|>
argument_list|(
operator|(
cast|static_cast
argument_list|<
name|double
argument_list|>
argument_list|(
literal|0xFFFFFFFFULL
argument_list|)
operator|*
name|value
operator|-
literal|1.0
operator|)
operator|/
literal|2.0
argument_list|)
return|;
block|}
template|template
parameter_list|<
name|typename
name|QueryT
parameter_list|>
DECL|function|ClampToQueryRange
name|QueryT
name|ClampToQueryRange
parameter_list|(
name|GLint64
name|value
parameter_list|)
block|{
specifier|const
name|GLint64
name|min
init|=
cast|static_cast
argument_list|<
name|GLint64
argument_list|>
argument_list|(
name|std
operator|::
name|numeric_limits
argument_list|<
name|QueryT
argument_list|>
operator|::
name|min
argument_list|()
argument_list|)
decl_stmt|;
specifier|const
name|GLint64
name|max
init|=
cast|static_cast
argument_list|<
name|GLint64
argument_list|>
argument_list|(
name|std
operator|::
name|numeric_limits
argument_list|<
name|QueryT
argument_list|>
operator|::
name|max
argument_list|()
argument_list|)
decl_stmt|;
return|return
cast|static_cast
argument_list|<
name|QueryT
argument_list|>
argument_list|(
name|clamp
argument_list|(
name|value
argument_list|,
name|min
argument_list|,
name|max
argument_list|)
argument_list|)
return|;
block|}
template|template
parameter_list|<
name|typename
name|QueryT
parameter_list|,
name|typename
name|NativeT
parameter_list|>
DECL|function|CastStateValueToInt
name|QueryT
name|CastStateValueToInt
parameter_list|(
name|GLenum
name|pname
parameter_list|,
name|NativeT
name|value
parameter_list|)
block|{
name|GLenum
name|queryType
init|=
name|GLTypeToGLenum
argument_list|<
name|QueryT
argument_list|>
operator|::
name|value
decl_stmt|;
name|GLenum
name|nativeType
init|=
name|GLTypeToGLenum
argument_list|<
name|NativeT
argument_list|>
operator|::
name|value
decl_stmt|;
if|if
condition|(
name|nativeType
operator|==
name|GL_FLOAT
condition|)
block|{
comment|// RGBA color values and DepthRangeF values are converted to integer using Equation 2.4 from Table 4.5
if|if
condition|(
name|pname
operator|==
name|GL_DEPTH_RANGE
operator|||
name|pname
operator|==
name|GL_COLOR_CLEAR_VALUE
operator|||
name|pname
operator|==
name|GL_DEPTH_CLEAR_VALUE
operator|||
name|pname
operator|==
name|GL_BLEND_COLOR
condition|)
block|{
return|return
name|ClampToQueryRange
argument_list|<
name|QueryT
argument_list|>
argument_list|(
name|ExpandFloatToInteger
argument_list|(
cast|static_cast
argument_list|<
name|GLfloat
argument_list|>
argument_list|(
name|value
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|gl
operator|::
name|iround
argument_list|<
name|QueryT
argument_list|>
argument_list|(
cast|static_cast
argument_list|<
name|GLfloat
argument_list|>
argument_list|(
name|value
argument_list|)
argument_list|)
return|;
block|}
block|}
comment|// Clamp 64-bit int values when casting to int
if|if
condition|(
name|nativeType
operator|==
name|GL_INT_64_ANGLEX
operator|&&
name|queryType
operator|==
name|GL_INT
condition|)
block|{
name|GLint64
name|minIntValue
init|=
cast|static_cast
argument_list|<
name|GLint64
argument_list|>
argument_list|(
name|std
operator|::
name|numeric_limits
argument_list|<
name|GLint
argument_list|>
operator|::
name|min
argument_list|()
argument_list|)
decl_stmt|;
name|GLint64
name|maxIntValue
init|=
cast|static_cast
argument_list|<
name|GLint64
argument_list|>
argument_list|(
name|std
operator|::
name|numeric_limits
argument_list|<
name|GLint
argument_list|>
operator|::
name|max
argument_list|()
argument_list|)
decl_stmt|;
name|GLint64
name|clampedValue
init|=
name|std
operator|::
name|max
argument_list|(
name|std
operator|::
name|min
argument_list|(
cast|static_cast
argument_list|<
name|GLint64
argument_list|>
argument_list|(
name|value
argument_list|)
argument_list|,
name|maxIntValue
argument_list|)
argument_list|,
name|minIntValue
argument_list|)
decl_stmt|;
return|return
cast|static_cast
argument_list|<
name|QueryT
argument_list|>
argument_list|(
name|clampedValue
argument_list|)
return|;
block|}
return|return
cast|static_cast
argument_list|<
name|QueryT
argument_list|>
argument_list|(
name|value
argument_list|)
return|;
block|}
template|template
parameter_list|<
name|typename
name|QueryT
parameter_list|,
name|typename
name|NativeT
parameter_list|>
DECL|function|CastStateValue
name|QueryT
name|CastStateValue
parameter_list|(
name|GLenum
name|pname
parameter_list|,
name|NativeT
name|value
parameter_list|)
block|{
name|GLenum
name|queryType
init|=
name|GLTypeToGLenum
argument_list|<
name|QueryT
argument_list|>
operator|::
name|value
decl_stmt|;
switch|switch
condition|(
name|queryType
condition|)
block|{
case|case
name|GL_INT
case|:
return|return
name|CastStateValueToInt
argument_list|<
name|QueryT
argument_list|,
name|NativeT
argument_list|>
argument_list|(
name|pname
argument_list|,
name|value
argument_list|)
return|;
case|case
name|GL_INT_64_ANGLEX
case|:
return|return
name|CastStateValueToInt
argument_list|<
name|QueryT
argument_list|,
name|NativeT
argument_list|>
argument_list|(
name|pname
argument_list|,
name|value
argument_list|)
return|;
case|case
name|GL_FLOAT
case|:
return|return
cast|static_cast
argument_list|<
name|QueryT
argument_list|>
argument_list|(
name|value
argument_list|)
return|;
case|case
name|GL_BOOL
case|:
return|return
cast|static_cast
argument_list|<
name|QueryT
argument_list|>
argument_list|(
name|value
operator|==
cast|static_cast
argument_list|<
name|NativeT
argument_list|>
argument_list|(
literal|0
argument_list|)
condition|?
name|GL_FALSE
else|:
name|GL_TRUE
argument_list|)
return|;
default|default:
name|UNREACHABLE
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
comment|// anonymous namespace
template|template
parameter_list|<>
name|GLenum
name|GLTypeToGLenum
argument_list|<
name|GLint
argument_list|>
operator|::
name|value
init|=
name|GL_INT
decl_stmt|;
template|template
parameter_list|<>
DECL|member|value
name|GLenum
name|GLTypeToGLenum
argument_list|<
name|GLuint
argument_list|>
operator|::
name|value
init|=
name|GL_UNSIGNED_INT
decl_stmt|;
template|template
parameter_list|<>
DECL|member|value
name|GLenum
name|GLTypeToGLenum
argument_list|<
name|GLboolean
argument_list|>
operator|::
name|value
init|=
name|GL_BOOL
decl_stmt|;
template|template
parameter_list|<>
DECL|member|value
name|GLenum
name|GLTypeToGLenum
argument_list|<
name|GLint64
argument_list|>
operator|::
name|value
init|=
name|GL_INT_64_ANGLEX
decl_stmt|;
template|template
parameter_list|<>
DECL|member|value
name|GLenum
name|GLTypeToGLenum
argument_list|<
name|GLfloat
argument_list|>
operator|::
name|value
init|=
name|GL_FLOAT
decl_stmt|;
template|template
parameter_list|<
name|typename
name|QueryT
parameter_list|>
DECL|function|CastStateValues
name|void
name|CastStateValues
parameter_list|(
name|Context
modifier|*
name|context
parameter_list|,
name|GLenum
name|nativeType
parameter_list|,
name|GLenum
name|pname
parameter_list|,
name|unsigned
name|int
name|numParams
parameter_list|,
name|QueryT
modifier|*
name|outParams
parameter_list|)
block|{
if|if
condition|(
name|nativeType
operator|==
name|GL_INT
condition|)
block|{
name|std
operator|::
name|vector
argument_list|<
name|GLint
argument_list|>
name|intParams
argument_list|(
name|numParams
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|context
operator|->
name|getIntegerv
argument_list|(
name|pname
argument_list|,
name|intParams
operator|.
name|data
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|unsigned
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numParams
condition|;
operator|++
name|i
control|)
block|{
name|outParams
index|[
name|i
index|]
operator|=
name|CastStateValue
argument_list|<
name|QueryT
argument_list|>
argument_list|(
name|pname
argument_list|,
name|intParams
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|nativeType
operator|==
name|GL_BOOL
condition|)
block|{
name|std
operator|::
name|vector
argument_list|<
name|GLboolean
argument_list|>
name|boolParams
argument_list|(
name|numParams
argument_list|,
name|GL_FALSE
argument_list|)
decl_stmt|;
name|context
operator|->
name|getBooleanv
argument_list|(
name|pname
argument_list|,
name|boolParams
operator|.
name|data
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|unsigned
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numParams
condition|;
operator|++
name|i
control|)
block|{
name|outParams
index|[
name|i
index|]
operator|=
operator|(
name|boolParams
index|[
name|i
index|]
operator|==
name|GL_FALSE
condition|?
cast|static_cast
argument_list|<
name|QueryT
argument_list|>
argument_list|(
literal|0
argument_list|)
else|:
cast|static_cast
argument_list|<
name|QueryT
argument_list|>
argument_list|(
literal|1
argument_list|)
operator|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|nativeType
operator|==
name|GL_FLOAT
condition|)
block|{
name|std
operator|::
name|vector
argument_list|<
name|GLfloat
argument_list|>
name|floatParams
argument_list|(
name|numParams
argument_list|,
literal|0.0f
argument_list|)
decl_stmt|;
name|context
operator|->
name|getFloatv
argument_list|(
name|pname
argument_list|,
name|floatParams
operator|.
name|data
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|unsigned
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numParams
condition|;
operator|++
name|i
control|)
block|{
name|outParams
index|[
name|i
index|]
operator|=
name|CastStateValue
argument_list|<
name|QueryT
argument_list|>
argument_list|(
name|pname
argument_list|,
name|floatParams
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|nativeType
operator|==
name|GL_INT_64_ANGLEX
condition|)
block|{
name|std
operator|::
name|vector
argument_list|<
name|GLint64
argument_list|>
name|int64Params
argument_list|(
name|numParams
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|context
operator|->
name|getInteger64v
argument_list|(
name|pname
argument_list|,
name|int64Params
operator|.
name|data
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|unsigned
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numParams
condition|;
operator|++
name|i
control|)
block|{
name|outParams
index|[
name|i
index|]
operator|=
name|CastStateValue
argument_list|<
name|QueryT
argument_list|>
argument_list|(
name|pname
argument_list|,
name|int64Params
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|UNREACHABLE
argument_list|()
expr_stmt|;
block|}
comment|// Explicit template instantiation (how we export template functions in different files)
comment|// The calls below will make CastStateValues successfully link with the GL state query types
comment|// The GL state query API types are: bool, int, uint, float, int64
specifier|template
name|void
name|CastStateValues
argument_list|<
name|GLboolean
argument_list|>
parameter_list|(
name|Context
modifier|*
parameter_list|,
name|GLenum
parameter_list|,
name|GLenum
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|GLboolean
modifier|*
parameter_list|)
function_decl|;
specifier|template
name|void
name|CastStateValues
argument_list|<
name|GLint
argument_list|>
parameter_list|(
name|Context
modifier|*
parameter_list|,
name|GLenum
parameter_list|,
name|GLenum
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|GLint
modifier|*
parameter_list|)
function_decl|;
specifier|template
name|void
name|CastStateValues
argument_list|<
name|GLuint
argument_list|>
parameter_list|(
name|Context
modifier|*
parameter_list|,
name|GLenum
parameter_list|,
name|GLenum
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|GLuint
modifier|*
parameter_list|)
function_decl|;
specifier|template
name|void
name|CastStateValues
argument_list|<
name|GLfloat
argument_list|>
parameter_list|(
name|Context
modifier|*
parameter_list|,
name|GLenum
parameter_list|,
name|GLenum
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|GLfloat
modifier|*
parameter_list|)
function_decl|;
specifier|template
name|void
name|CastStateValues
argument_list|<
name|GLint64
argument_list|>
parameter_list|(
name|Context
modifier|*
parameter_list|,
name|GLenum
parameter_list|,
name|GLenum
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|GLint64
modifier|*
parameter_list|)
function_decl|;
block|}
end_namespace
end_unit
