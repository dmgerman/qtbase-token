begin_unit
begin_comment
comment|//
end_comment
begin_comment
comment|// Copyright (c) 2002-2012 The ANGLE Project Authors. All rights reserved.
end_comment
begin_comment
comment|// Use of this source code is governed by a BSD-style license that can be
end_comment
begin_comment
comment|// found in the LICENSE file.
end_comment
begin_comment
comment|//
end_comment
begin_comment
comment|// Image9.cpp: Implements the rx::Image9 class, which acts as the interface to
end_comment
begin_comment
comment|// the actual underlying surfaces of a Texture.
end_comment
begin_include
include|#
directive|include
file|"libGLESv2/renderer/d3d/d3d9/Image9.h"
end_include
begin_include
include|#
directive|include
file|"libGLESv2/renderer/d3d/d3d9/renderer9_utils.h"
end_include
begin_include
include|#
directive|include
file|"libGLESv2/renderer/d3d/d3d9/formatutils9.h"
end_include
begin_include
include|#
directive|include
file|"libGLESv2/renderer/d3d/d3d9/Renderer9.h"
end_include
begin_include
include|#
directive|include
file|"libGLESv2/renderer/d3d/d3d9/RenderTarget9.h"
end_include
begin_include
include|#
directive|include
file|"libGLESv2/renderer/d3d/d3d9/TextureStorage9.h"
end_include
begin_include
include|#
directive|include
file|"libGLESv2/main.h"
end_include
begin_include
include|#
directive|include
file|"libGLESv2/Framebuffer.h"
end_include
begin_include
include|#
directive|include
file|"libGLESv2/FramebufferAttachment.h"
end_include
begin_include
include|#
directive|include
file|"libGLESv2/Renderbuffer.h"
end_include
begin_include
include|#
directive|include
file|"common/utilities.h"
end_include
begin_namespace
DECL|namespace|rx
namespace|namespace
name|rx
block|{
DECL|function|Image9
name|Image9
operator|::
name|Image9
parameter_list|()
block|{
name|mSurface
operator|=
name|NULL
expr_stmt|;
name|mRenderer
operator|=
name|NULL
expr_stmt|;
name|mD3DPool
operator|=
name|D3DPOOL_SYSTEMMEM
expr_stmt|;
name|mD3DFormat
operator|=
name|D3DFMT_UNKNOWN
expr_stmt|;
block|}
DECL|function|~Image9
name|Image9
operator|::
name|~
name|Image9
parameter_list|()
block|{
name|SafeRelease
argument_list|(
name|mSurface
argument_list|)
expr_stmt|;
block|}
DECL|function|generateMip
name|gl
operator|::
name|Error
name|Image9
operator|::
name|generateMip
parameter_list|(
name|IDirect3DSurface9
modifier|*
name|destSurface
parameter_list|,
name|IDirect3DSurface9
modifier|*
name|sourceSurface
parameter_list|)
block|{
name|D3DSURFACE_DESC
name|destDesc
decl_stmt|;
name|HRESULT
name|result
init|=
name|destSurface
operator|->
name|GetDesc
argument_list|(
operator|&
name|destDesc
argument_list|)
decl_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to query the source surface description for mipmap generation, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|D3DSURFACE_DESC
name|sourceDesc
decl_stmt|;
name|result
operator|=
name|sourceSurface
operator|->
name|GetDesc
argument_list|(
operator|&
name|sourceDesc
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to query the destination surface description for mipmap generation, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|sourceDesc
operator|.
name|Format
operator|==
name|destDesc
operator|.
name|Format
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|sourceDesc
operator|.
name|Width
operator|==
literal|1
operator|||
name|sourceDesc
operator|.
name|Width
operator|/
literal|2
operator|==
name|destDesc
operator|.
name|Width
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|sourceDesc
operator|.
name|Height
operator|==
literal|1
operator|||
name|sourceDesc
operator|.
name|Height
operator|/
literal|2
operator|==
name|destDesc
operator|.
name|Height
argument_list|)
expr_stmt|;
specifier|const
name|d3d9
operator|::
name|D3DFormat
modifier|&
name|d3dFormatInfo
init|=
name|d3d9
operator|::
name|GetD3DFormatInfo
argument_list|(
name|sourceDesc
operator|.
name|Format
argument_list|)
decl_stmt|;
name|ASSERT
argument_list|(
name|d3dFormatInfo
operator|.
name|mipGenerationFunction
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|D3DLOCKED_RECT
name|sourceLocked
init|=
block|{
literal|0
block|}
decl_stmt|;
name|result
operator|=
name|sourceSurface
operator|->
name|LockRect
argument_list|(
operator|&
name|sourceLocked
argument_list|,
name|NULL
argument_list|,
name|D3DLOCK_READONLY
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to lock the source surface for mipmap generation, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|D3DLOCKED_RECT
name|destLocked
init|=
block|{
literal|0
block|}
decl_stmt|;
name|result
operator|=
name|destSurface
operator|->
name|LockRect
argument_list|(
operator|&
name|destLocked
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
name|sourceSurface
operator|->
name|UnlockRect
argument_list|()
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to lock the destination surface for mipmap generation, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
specifier|const
name|uint8_t
modifier|*
name|sourceData
init|=
cast|reinterpret_cast
argument_list|<
specifier|const
name|uint8_t
operator|*
argument_list|>
argument_list|(
name|sourceLocked
operator|.
name|pBits
argument_list|)
decl_stmt|;
name|uint8_t
modifier|*
name|destData
init|=
cast|reinterpret_cast
argument_list|<
name|uint8_t
operator|*
argument_list|>
argument_list|(
name|destLocked
operator|.
name|pBits
argument_list|)
decl_stmt|;
name|ASSERT
argument_list|(
name|sourceData
operator|&&
name|destData
argument_list|)
expr_stmt|;
name|d3dFormatInfo
operator|.
name|mipGenerationFunction
argument_list|(
name|sourceDesc
operator|.
name|Width
argument_list|,
name|sourceDesc
operator|.
name|Height
argument_list|,
literal|1
argument_list|,
name|sourceData
argument_list|,
name|sourceLocked
operator|.
name|Pitch
argument_list|,
literal|0
argument_list|,
name|destData
argument_list|,
name|destLocked
operator|.
name|Pitch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|destSurface
operator|->
name|UnlockRect
argument_list|()
expr_stmt|;
name|sourceSurface
operator|->
name|UnlockRect
argument_list|()
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
DECL|function|makeImage9
name|Image9
modifier|*
name|Image9
operator|::
name|makeImage9
parameter_list|(
name|Image
modifier|*
name|img
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|HAS_DYNAMIC_TYPE
argument_list|(
name|Image9
operator|*
argument_list|,
name|img
argument_list|)
argument_list|)
expr_stmt|;
return|return
cast|static_cast
argument_list|<
name|Image9
operator|*
argument_list|>
argument_list|(
name|img
argument_list|)
return|;
block|}
DECL|function|generateMipmap
name|gl
operator|::
name|Error
name|Image9
operator|::
name|generateMipmap
parameter_list|(
name|Image9
modifier|*
name|dest
parameter_list|,
name|Image9
modifier|*
name|source
parameter_list|)
block|{
name|IDirect3DSurface9
modifier|*
name|sourceSurface
init|=
name|NULL
decl_stmt|;
name|gl
operator|::
name|Error
name|error
init|=
name|source
operator|->
name|getSurface
argument_list|(
operator|&
name|sourceSurface
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
name|IDirect3DSurface9
modifier|*
name|destSurface
init|=
name|NULL
decl_stmt|;
name|error
operator|=
name|dest
operator|->
name|getSurface
argument_list|(
operator|&
name|destSurface
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
name|error
operator|=
name|generateMip
argument_list|(
name|destSurface
argument_list|,
name|sourceSurface
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
name|dest
operator|->
name|markDirty
argument_list|()
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
DECL|function|copyLockableSurfaces
name|gl
operator|::
name|Error
name|Image9
operator|::
name|copyLockableSurfaces
parameter_list|(
name|IDirect3DSurface9
modifier|*
name|dest
parameter_list|,
name|IDirect3DSurface9
modifier|*
name|source
parameter_list|)
block|{
name|D3DLOCKED_RECT
name|sourceLock
init|=
block|{
literal|0
block|}
decl_stmt|;
name|D3DLOCKED_RECT
name|destLock
init|=
block|{
literal|0
block|}
decl_stmt|;
name|HRESULT
name|result
decl_stmt|;
name|result
operator|=
name|source
operator|->
name|LockRect
argument_list|(
operator|&
name|sourceLock
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to lock source surface for copy, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|result
operator|=
name|dest
operator|->
name|LockRect
argument_list|(
operator|&
name|destLock
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
name|source
operator|->
name|UnlockRect
argument_list|()
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to lock source surface for copy, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|ASSERT
argument_list|(
name|sourceLock
operator|.
name|pBits
operator|&&
name|destLock
operator|.
name|pBits
argument_list|)
expr_stmt|;
name|D3DSURFACE_DESC
name|desc
decl_stmt|;
name|source
operator|->
name|GetDesc
argument_list|(
operator|&
name|desc
argument_list|)
expr_stmt|;
specifier|const
name|d3d9
operator|::
name|D3DFormat
modifier|&
name|d3dFormatInfo
init|=
name|d3d9
operator|::
name|GetD3DFormatInfo
argument_list|(
name|desc
operator|.
name|Format
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|rows
init|=
name|desc
operator|.
name|Height
operator|/
name|d3dFormatInfo
operator|.
name|blockHeight
decl_stmt|;
name|unsigned
name|int
name|bytes
init|=
name|d3d9
operator|::
name|ComputeBlockSize
argument_list|(
name|desc
operator|.
name|Format
argument_list|,
name|desc
operator|.
name|Width
argument_list|,
name|d3dFormatInfo
operator|.
name|blockHeight
argument_list|)
decl_stmt|;
name|ASSERT
argument_list|(
name|bytes
operator|<=
cast|static_cast
argument_list|<
name|unsigned
name|int
argument_list|>
argument_list|(
name|sourceLock
operator|.
name|Pitch
argument_list|)
operator|&&
name|bytes
operator|<=
cast|static_cast
argument_list|<
name|unsigned
name|int
argument_list|>
argument_list|(
name|destLock
operator|.
name|Pitch
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|unsigned
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|rows
condition|;
name|i
operator|++
control|)
block|{
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|destLock
operator|.
name|pBits
operator|+
name|destLock
operator|.
name|Pitch
operator|*
name|i
argument_list|,
operator|(
name|char
operator|*
operator|)
name|sourceLock
operator|.
name|pBits
operator|+
name|sourceLock
operator|.
name|Pitch
operator|*
name|i
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
name|source
operator|->
name|UnlockRect
argument_list|()
expr_stmt|;
name|dest
operator|->
name|UnlockRect
argument_list|()
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
DECL|function|redefine
name|bool
name|Image9
operator|::
name|redefine
parameter_list|(
name|RendererD3D
modifier|*
name|renderer
parameter_list|,
name|GLenum
name|target
parameter_list|,
name|GLenum
name|internalformat
parameter_list|,
name|GLsizei
name|width
parameter_list|,
name|GLsizei
name|height
parameter_list|,
name|GLsizei
name|depth
parameter_list|,
name|bool
name|forceRelease
parameter_list|)
block|{
comment|// 3D textures are not supported by the D3D9 backend.
name|ASSERT
argument_list|(
name|depth
operator|<=
literal|1
argument_list|)
expr_stmt|;
comment|// Only 2D and cube texture are supported by the D3D9 backend.
name|ASSERT
argument_list|(
name|target
operator|==
name|GL_TEXTURE_2D
operator|||
name|target
operator|==
name|GL_TEXTURE_CUBE_MAP
argument_list|)
expr_stmt|;
if|if
condition|(
name|mWidth
operator|!=
name|width
operator|||
name|mHeight
operator|!=
name|height
operator|||
name|mDepth
operator|!=
name|depth
operator|||
name|mInternalFormat
operator|!=
name|internalformat
operator|||
name|forceRelease
condition|)
block|{
name|mRenderer
operator|=
name|Renderer9
operator|::
name|makeRenderer9
argument_list|(
name|renderer
argument_list|)
expr_stmt|;
name|mWidth
operator|=
name|width
expr_stmt|;
name|mHeight
operator|=
name|height
expr_stmt|;
name|mDepth
operator|=
name|depth
expr_stmt|;
name|mInternalFormat
operator|=
name|internalformat
expr_stmt|;
comment|// compute the d3d format that will be used
specifier|const
name|d3d9
operator|::
name|TextureFormat
modifier|&
name|d3d9FormatInfo
init|=
name|d3d9
operator|::
name|GetTextureFormatInfo
argument_list|(
name|internalformat
argument_list|)
decl_stmt|;
specifier|const
name|d3d9
operator|::
name|D3DFormat
modifier|&
name|d3dFormatInfo
init|=
name|d3d9
operator|::
name|GetD3DFormatInfo
argument_list|(
name|d3d9FormatInfo
operator|.
name|texFormat
argument_list|)
decl_stmt|;
name|mD3DFormat
operator|=
name|d3d9FormatInfo
operator|.
name|texFormat
expr_stmt|;
name|mActualFormat
operator|=
name|d3dFormatInfo
operator|.
name|internalFormat
expr_stmt|;
name|mRenderable
operator|=
operator|(
name|d3d9FormatInfo
operator|.
name|renderFormat
operator|!=
name|D3DFMT_UNKNOWN
operator|)
expr_stmt|;
name|SafeRelease
argument_list|(
name|mSurface
argument_list|)
expr_stmt|;
name|mDirty
operator|=
operator|(
name|d3d9FormatInfo
operator|.
name|dataInitializerFunction
operator|!=
name|NULL
operator|)
expr_stmt|;
return|return
literal|true
return|;
block|}
return|return
literal|false
return|;
block|}
DECL|function|createSurface
name|gl
operator|::
name|Error
name|Image9
operator|::
name|createSurface
parameter_list|()
block|{
if|if
condition|(
name|mSurface
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
name|IDirect3DTexture9
modifier|*
name|newTexture
init|=
name|NULL
decl_stmt|;
name|IDirect3DSurface9
modifier|*
name|newSurface
init|=
name|NULL
decl_stmt|;
specifier|const
name|D3DPOOL
name|poolToUse
init|=
name|D3DPOOL_SYSTEMMEM
decl_stmt|;
specifier|const
name|D3DFORMAT
name|d3dFormat
init|=
name|getD3DFormat
argument_list|()
decl_stmt|;
if|if
condition|(
name|mWidth
operator|!=
literal|0
operator|&&
name|mHeight
operator|!=
literal|0
condition|)
block|{
name|int
name|levelToFetch
init|=
literal|0
decl_stmt|;
name|GLsizei
name|requestWidth
init|=
name|mWidth
decl_stmt|;
name|GLsizei
name|requestHeight
init|=
name|mHeight
decl_stmt|;
name|d3d9
operator|::
name|MakeValidSize
argument_list|(
literal|true
argument_list|,
name|d3dFormat
argument_list|,
operator|&
name|requestWidth
argument_list|,
operator|&
name|requestHeight
argument_list|,
operator|&
name|levelToFetch
argument_list|)
expr_stmt|;
name|IDirect3DDevice9
modifier|*
name|device
init|=
name|mRenderer
operator|->
name|getDevice
argument_list|()
decl_stmt|;
name|HRESULT
name|result
init|=
name|device
operator|->
name|CreateTexture
argument_list|(
name|requestWidth
argument_list|,
name|requestHeight
argument_list|,
name|levelToFetch
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|d3dFormat
argument_list|,
name|poolToUse
argument_list|,
operator|&
name|newTexture
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
name|ASSERT
argument_list|(
name|result
operator|==
name|D3DERR_OUTOFVIDEOMEMORY
operator|||
name|result
operator|==
name|E_OUTOFMEMORY
argument_list|)
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to create image surface, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|newTexture
operator|->
name|GetSurfaceLevel
argument_list|(
name|levelToFetch
argument_list|,
operator|&
name|newSurface
argument_list|)
expr_stmt|;
name|SafeRelease
argument_list|(
name|newTexture
argument_list|)
expr_stmt|;
specifier|const
name|d3d9
operator|::
name|TextureFormat
modifier|&
name|d3dFormatInfo
init|=
name|d3d9
operator|::
name|GetTextureFormatInfo
argument_list|(
name|mInternalFormat
argument_list|)
decl_stmt|;
if|if
condition|(
name|d3dFormatInfo
operator|.
name|dataInitializerFunction
operator|!=
name|NULL
condition|)
block|{
name|RECT
name|entireRect
decl_stmt|;
name|entireRect
operator|.
name|left
operator|=
literal|0
expr_stmt|;
name|entireRect
operator|.
name|right
operator|=
name|mWidth
expr_stmt|;
name|entireRect
operator|.
name|top
operator|=
literal|0
expr_stmt|;
name|entireRect
operator|.
name|bottom
operator|=
name|mHeight
expr_stmt|;
name|D3DLOCKED_RECT
name|lockedRect
decl_stmt|;
name|result
operator|=
name|newSurface
operator|->
name|LockRect
argument_list|(
operator|&
name|lockedRect
argument_list|,
operator|&
name|entireRect
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to lock image surface, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|d3dFormatInfo
operator|.
name|dataInitializerFunction
argument_list|(
name|mWidth
argument_list|,
name|mHeight
argument_list|,
literal|1
argument_list|,
cast|reinterpret_cast
argument_list|<
name|uint8_t
operator|*
argument_list|>
argument_list|(
name|lockedRect
operator|.
name|pBits
argument_list|)
argument_list|,
name|lockedRect
operator|.
name|Pitch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|newSurface
operator|->
name|UnlockRect
argument_list|()
expr_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to unlock image surface, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
block|}
block|}
name|mSurface
operator|=
name|newSurface
expr_stmt|;
name|mDirty
operator|=
literal|false
expr_stmt|;
name|mD3DPool
operator|=
name|poolToUse
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
DECL|function|lock
name|gl
operator|::
name|Error
name|Image9
operator|::
name|lock
parameter_list|(
name|D3DLOCKED_RECT
modifier|*
name|lockedRect
parameter_list|,
specifier|const
name|RECT
modifier|&
name|rect
parameter_list|)
block|{
name|gl
operator|::
name|Error
name|error
init|=
name|createSurface
argument_list|()
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
if|if
condition|(
name|mSurface
condition|)
block|{
name|HRESULT
name|result
init|=
name|mSurface
operator|->
name|LockRect
argument_list|(
name|lockedRect
argument_list|,
operator|&
name|rect
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to lock image surface, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|mDirty
operator|=
literal|true
expr_stmt|;
block|}
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
DECL|function|unlock
name|void
name|Image9
operator|::
name|unlock
parameter_list|()
block|{
if|if
condition|(
name|mSurface
condition|)
block|{
name|HRESULT
name|result
init|=
name|mSurface
operator|->
name|UnlockRect
argument_list|()
decl_stmt|;
name|UNUSED_ASSERTION_VARIABLE
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|function|getD3DFormat
name|D3DFORMAT
name|Image9
operator|::
name|getD3DFormat
parameter_list|()
specifier|const
block|{
comment|// this should only happen if the image hasn't been redefined first
comment|// which would be a bug by the caller
name|ASSERT
argument_list|(
name|mD3DFormat
operator|!=
name|D3DFMT_UNKNOWN
argument_list|)
expr_stmt|;
return|return
name|mD3DFormat
return|;
block|}
DECL|function|isDirty
name|bool
name|Image9
operator|::
name|isDirty
parameter_list|()
specifier|const
block|{
comment|// Make sure to that this image is marked as dirty even if the staging texture hasn't been created yet
comment|// if initialization is required before use.
return|return
operator|(
name|mSurface
operator|||
name|d3d9
operator|::
name|GetTextureFormatInfo
argument_list|(
name|mInternalFormat
argument_list|)
operator|.
name|dataInitializerFunction
operator|!=
name|NULL
operator|)
operator|&&
name|mDirty
return|;
block|}
DECL|function|getSurface
name|gl
operator|::
name|Error
name|Image9
operator|::
name|getSurface
parameter_list|(
name|IDirect3DSurface9
modifier|*
modifier|*
name|outSurface
parameter_list|)
block|{
name|gl
operator|::
name|Error
name|error
init|=
name|createSurface
argument_list|()
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
operator|*
name|outSurface
operator|=
name|mSurface
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
DECL|function|setManagedSurface2D
name|gl
operator|::
name|Error
name|Image9
operator|::
name|setManagedSurface2D
parameter_list|(
name|TextureStorage
modifier|*
name|storage
parameter_list|,
name|int
name|level
parameter_list|)
block|{
name|IDirect3DSurface9
modifier|*
name|surface
init|=
name|NULL
decl_stmt|;
name|TextureStorage9_2D
modifier|*
name|storage9
init|=
name|TextureStorage9_2D
operator|::
name|makeTextureStorage9_2D
argument_list|(
name|storage
argument_list|)
decl_stmt|;
name|gl
operator|::
name|Error
name|error
init|=
name|storage9
operator|->
name|getSurfaceLevel
argument_list|(
name|level
argument_list|,
literal|false
argument_list|,
operator|&
name|surface
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
return|return
name|setManagedSurface
argument_list|(
name|surface
argument_list|)
return|;
block|}
DECL|function|setManagedSurfaceCube
name|gl
operator|::
name|Error
name|Image9
operator|::
name|setManagedSurfaceCube
parameter_list|(
name|TextureStorage
modifier|*
name|storage
parameter_list|,
name|int
name|face
parameter_list|,
name|int
name|level
parameter_list|)
block|{
name|IDirect3DSurface9
modifier|*
name|surface
init|=
name|NULL
decl_stmt|;
name|TextureStorage9_Cube
modifier|*
name|storage9
init|=
name|TextureStorage9_Cube
operator|::
name|makeTextureStorage9_Cube
argument_list|(
name|storage
argument_list|)
decl_stmt|;
name|gl
operator|::
name|Error
name|error
init|=
name|storage9
operator|->
name|getCubeMapSurface
argument_list|(
name|GL_TEXTURE_CUBE_MAP_POSITIVE_X
operator|+
name|face
argument_list|,
name|level
argument_list|,
literal|false
argument_list|,
operator|&
name|surface
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
return|return
name|setManagedSurface
argument_list|(
name|surface
argument_list|)
return|;
block|}
DECL|function|setManagedSurface
name|gl
operator|::
name|Error
name|Image9
operator|::
name|setManagedSurface
parameter_list|(
name|IDirect3DSurface9
modifier|*
name|surface
parameter_list|)
block|{
name|D3DSURFACE_DESC
name|desc
decl_stmt|;
name|surface
operator|->
name|GetDesc
argument_list|(
operator|&
name|desc
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|desc
operator|.
name|Pool
operator|==
name|D3DPOOL_MANAGED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|GLsizei
operator|)
name|desc
operator|.
name|Width
operator|==
name|mWidth
operator|&&
operator|(
name|GLsizei
operator|)
name|desc
operator|.
name|Height
operator|==
name|mHeight
condition|)
block|{
if|if
condition|(
name|mSurface
condition|)
block|{
name|gl
operator|::
name|Error
name|error
init|=
name|copyLockableSurfaces
argument_list|(
name|surface
argument_list|,
name|mSurface
argument_list|)
decl_stmt|;
name|SafeRelease
argument_list|(
name|mSurface
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
block|}
name|mSurface
operator|=
name|surface
expr_stmt|;
name|mD3DPool
operator|=
name|desc
operator|.
name|Pool
expr_stmt|;
block|}
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
DECL|function|copyToStorage
name|gl
operator|::
name|Error
name|Image9
operator|::
name|copyToStorage
parameter_list|(
name|TextureStorage
modifier|*
name|storage
parameter_list|,
specifier|const
name|gl
operator|::
name|ImageIndex
modifier|&
name|index
parameter_list|,
specifier|const
name|gl
operator|::
name|Box
modifier|&
name|region
parameter_list|)
block|{
name|gl
operator|::
name|Error
name|error
init|=
name|createSurface
argument_list|()
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
name|IDirect3DSurface9
modifier|*
name|destSurface
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|index
operator|.
name|type
operator|==
name|GL_TEXTURE_2D
condition|)
block|{
name|TextureStorage9_2D
modifier|*
name|storage9
init|=
name|TextureStorage9_2D
operator|::
name|makeTextureStorage9_2D
argument_list|(
name|storage
argument_list|)
decl_stmt|;
name|gl
operator|::
name|Error
name|error
init|=
name|storage9
operator|->
name|getSurfaceLevel
argument_list|(
name|index
operator|.
name|mipIndex
argument_list|,
literal|true
argument_list|,
operator|&
name|destSurface
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
block|}
else|else
block|{
name|ASSERT
argument_list|(
name|gl
operator|::
name|IsCubemapTextureTarget
argument_list|(
name|index
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|TextureStorage9_Cube
modifier|*
name|storage9
init|=
name|TextureStorage9_Cube
operator|::
name|makeTextureStorage9_Cube
argument_list|(
name|storage
argument_list|)
decl_stmt|;
name|gl
operator|::
name|Error
name|error
init|=
name|storage9
operator|->
name|getCubeMapSurface
argument_list|(
name|index
operator|.
name|type
argument_list|,
name|index
operator|.
name|mipIndex
argument_list|,
literal|true
argument_list|,
operator|&
name|destSurface
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
block|}
name|error
operator|=
name|copyToSurface
argument_list|(
name|destSurface
argument_list|,
name|region
operator|.
name|x
argument_list|,
name|region
operator|.
name|y
argument_list|,
name|region
operator|.
name|width
argument_list|,
name|region
operator|.
name|height
argument_list|)
expr_stmt|;
name|SafeRelease
argument_list|(
name|destSurface
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
DECL|function|copyToSurface
name|gl
operator|::
name|Error
name|Image9
operator|::
name|copyToSurface
parameter_list|(
name|IDirect3DSurface9
modifier|*
name|destSurface
parameter_list|,
name|GLint
name|xoffset
parameter_list|,
name|GLint
name|yoffset
parameter_list|,
name|GLsizei
name|width
parameter_list|,
name|GLsizei
name|height
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|width
operator|>
literal|0
operator|&&
name|height
operator|>
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|destSurface
argument_list|)
expr_stmt|;
name|IDirect3DSurface9
modifier|*
name|sourceSurface
init|=
name|NULL
decl_stmt|;
name|gl
operator|::
name|Error
name|error
init|=
name|getSurface
argument_list|(
operator|&
name|sourceSurface
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
name|ASSERT
argument_list|(
name|sourceSurface
operator|&&
name|sourceSurface
operator|!=
name|destSurface
argument_list|)
expr_stmt|;
name|RECT
name|rect
decl_stmt|;
name|rect
operator|.
name|left
operator|=
name|xoffset
expr_stmt|;
name|rect
operator|.
name|top
operator|=
name|yoffset
expr_stmt|;
name|rect
operator|.
name|right
operator|=
name|xoffset
operator|+
name|width
expr_stmt|;
name|rect
operator|.
name|bottom
operator|=
name|yoffset
operator|+
name|height
expr_stmt|;
name|POINT
name|point
init|=
block|{
name|rect
operator|.
name|left
block|,
name|rect
operator|.
name|top
block|}
decl_stmt|;
name|IDirect3DDevice9
modifier|*
name|device
init|=
name|mRenderer
operator|->
name|getDevice
argument_list|()
decl_stmt|;
if|if
condition|(
name|mD3DPool
operator|==
name|D3DPOOL_MANAGED
condition|)
block|{
name|D3DSURFACE_DESC
name|desc
decl_stmt|;
name|sourceSurface
operator|->
name|GetDesc
argument_list|(
operator|&
name|desc
argument_list|)
expr_stmt|;
name|IDirect3DSurface9
modifier|*
name|surf
init|=
literal|0
decl_stmt|;
name|HRESULT
name|result
init|=
name|device
operator|->
name|CreateOffscreenPlainSurface
argument_list|(
name|desc
operator|.
name|Width
argument_list|,
name|desc
operator|.
name|Height
argument_list|,
name|desc
operator|.
name|Format
argument_list|,
name|D3DPOOL_SYSTEMMEM
argument_list|,
operator|&
name|surf
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Internal CreateOffscreenPlainSurface call failed, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|copyLockableSurfaces
argument_list|(
name|surf
argument_list|,
name|sourceSurface
argument_list|)
expr_stmt|;
name|result
operator|=
name|device
operator|->
name|UpdateSurface
argument_list|(
name|surf
argument_list|,
operator|&
name|rect
argument_list|,
name|destSurface
argument_list|,
operator|&
name|point
argument_list|)
expr_stmt|;
name|SafeRelease
argument_list|(
name|surf
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Internal UpdateSurface call failed, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
block|}
else|else
block|{
comment|// UpdateSurface: source must be SYSTEMMEM, dest must be DEFAULT pools
name|HRESULT
name|result
init|=
name|device
operator|->
name|UpdateSurface
argument_list|(
name|sourceSurface
argument_list|,
operator|&
name|rect
argument_list|,
name|destSurface
argument_list|,
operator|&
name|point
argument_list|)
decl_stmt|;
name|ASSERT
argument_list|(
name|SUCCEEDED
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Internal UpdateSurface call failed, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
block|}
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
comment|// Store the pixel rectangle designated by xoffset,yoffset,width,height with pixels stored as format/type at input
comment|// into the target pixel rectangle.
DECL|function|loadData
name|gl
operator|::
name|Error
name|Image9
operator|::
name|loadData
parameter_list|(
name|GLint
name|xoffset
parameter_list|,
name|GLint
name|yoffset
parameter_list|,
name|GLint
name|zoffset
parameter_list|,
name|GLsizei
name|width
parameter_list|,
name|GLsizei
name|height
parameter_list|,
name|GLsizei
name|depth
parameter_list|,
name|GLint
name|unpackAlignment
parameter_list|,
name|GLenum
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|input
parameter_list|)
block|{
comment|// 3D textures are not supported by the D3D9 backend.
name|ASSERT
argument_list|(
name|zoffset
operator|==
literal|0
operator|&&
name|depth
operator|==
literal|1
argument_list|)
expr_stmt|;
specifier|const
name|gl
operator|::
name|InternalFormat
modifier|&
name|formatInfo
init|=
name|gl
operator|::
name|GetInternalFormatInfo
argument_list|(
name|mInternalFormat
argument_list|)
decl_stmt|;
name|GLsizei
name|inputRowPitch
init|=
name|formatInfo
operator|.
name|computeRowPitch
argument_list|(
name|type
argument_list|,
name|width
argument_list|,
name|unpackAlignment
argument_list|)
decl_stmt|;
specifier|const
name|d3d9
operator|::
name|TextureFormat
modifier|&
name|d3dFormatInfo
init|=
name|d3d9
operator|::
name|GetTextureFormatInfo
argument_list|(
name|mInternalFormat
argument_list|)
decl_stmt|;
name|ASSERT
argument_list|(
name|d3dFormatInfo
operator|.
name|loadFunction
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RECT
name|lockRect
init|=
block|{
name|xoffset
block|,
name|yoffset
block|,
name|xoffset
operator|+
name|width
block|,
name|yoffset
operator|+
name|height
block|}
decl_stmt|;
name|D3DLOCKED_RECT
name|locked
decl_stmt|;
name|gl
operator|::
name|Error
name|error
init|=
name|lock
argument_list|(
operator|&
name|locked
argument_list|,
name|lockRect
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
name|d3dFormatInfo
operator|.
name|loadFunction
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|depth
argument_list|,
cast|reinterpret_cast
argument_list|<
specifier|const
name|uint8_t
operator|*
argument_list|>
argument_list|(
name|input
argument_list|)
argument_list|,
name|inputRowPitch
argument_list|,
literal|0
argument_list|,
cast|reinterpret_cast
argument_list|<
name|uint8_t
operator|*
argument_list|>
argument_list|(
name|locked
operator|.
name|pBits
argument_list|)
argument_list|,
name|locked
operator|.
name|Pitch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|unlock
argument_list|()
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
DECL|function|loadCompressedData
name|gl
operator|::
name|Error
name|Image9
operator|::
name|loadCompressedData
parameter_list|(
name|GLint
name|xoffset
parameter_list|,
name|GLint
name|yoffset
parameter_list|,
name|GLint
name|zoffset
parameter_list|,
name|GLsizei
name|width
parameter_list|,
name|GLsizei
name|height
parameter_list|,
name|GLsizei
name|depth
parameter_list|,
specifier|const
name|void
modifier|*
name|input
parameter_list|)
block|{
comment|// 3D textures are not supported by the D3D9 backend.
name|ASSERT
argument_list|(
name|zoffset
operator|==
literal|0
operator|&&
name|depth
operator|==
literal|1
argument_list|)
expr_stmt|;
specifier|const
name|gl
operator|::
name|InternalFormat
modifier|&
name|formatInfo
init|=
name|gl
operator|::
name|GetInternalFormatInfo
argument_list|(
name|mInternalFormat
argument_list|)
decl_stmt|;
name|GLsizei
name|inputRowPitch
init|=
name|formatInfo
operator|.
name|computeRowPitch
argument_list|(
name|GL_UNSIGNED_BYTE
argument_list|,
name|width
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|GLsizei
name|inputDepthPitch
init|=
name|formatInfo
operator|.
name|computeDepthPitch
argument_list|(
name|GL_UNSIGNED_BYTE
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
literal|1
argument_list|)
decl_stmt|;
specifier|const
name|d3d9
operator|::
name|TextureFormat
modifier|&
name|d3d9FormatInfo
init|=
name|d3d9
operator|::
name|GetTextureFormatInfo
argument_list|(
name|mInternalFormat
argument_list|)
decl_stmt|;
name|ASSERT
argument_list|(
name|xoffset
operator|%
name|d3d9
operator|::
name|GetD3DFormatInfo
argument_list|(
name|d3d9FormatInfo
operator|.
name|texFormat
argument_list|)
operator|.
name|blockWidth
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|yoffset
operator|%
name|d3d9
operator|::
name|GetD3DFormatInfo
argument_list|(
name|d3d9FormatInfo
operator|.
name|texFormat
argument_list|)
operator|.
name|blockHeight
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|d3d9FormatInfo
operator|.
name|loadFunction
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RECT
name|lockRect
init|=
block|{
name|xoffset
block|,
name|yoffset
block|,
name|xoffset
operator|+
name|width
block|,
name|yoffset
operator|+
name|height
block|}
decl_stmt|;
name|D3DLOCKED_RECT
name|locked
decl_stmt|;
name|gl
operator|::
name|Error
name|error
init|=
name|lock
argument_list|(
operator|&
name|locked
argument_list|,
name|lockRect
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
return|return
name|error
return|;
block|}
name|d3d9FormatInfo
operator|.
name|loadFunction
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|depth
argument_list|,
cast|reinterpret_cast
argument_list|<
specifier|const
name|uint8_t
operator|*
argument_list|>
argument_list|(
name|input
argument_list|)
argument_list|,
name|inputRowPitch
argument_list|,
name|inputDepthPitch
argument_list|,
cast|reinterpret_cast
argument_list|<
name|uint8_t
operator|*
argument_list|>
argument_list|(
name|locked
operator|.
name|pBits
argument_list|)
argument_list|,
name|locked
operator|.
name|Pitch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|unlock
argument_list|()
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
comment|// This implements glCopyTex[Sub]Image2D for non-renderable internal texture formats and incomplete textures
DECL|function|copy
name|gl
operator|::
name|Error
name|Image9
operator|::
name|copy
parameter_list|(
name|GLint
name|xoffset
parameter_list|,
name|GLint
name|yoffset
parameter_list|,
name|GLint
name|zoffset
parameter_list|,
specifier|const
name|gl
operator|::
name|Rectangle
modifier|&
name|sourceArea
parameter_list|,
name|RenderTarget
modifier|*
name|source
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|source
argument_list|)
expr_stmt|;
comment|// ES3.0 only behaviour to copy into a 3d texture
name|ASSERT
argument_list|(
name|zoffset
operator|==
literal|0
argument_list|)
expr_stmt|;
name|RenderTarget9
modifier|*
name|renderTarget
init|=
name|RenderTarget9
operator|::
name|makeRenderTarget9
argument_list|(
name|source
argument_list|)
decl_stmt|;
name|IDirect3DSurface9
modifier|*
name|surface
init|=
name|renderTarget
operator|->
name|getSurface
argument_list|()
decl_stmt|;
name|ASSERT
argument_list|(
name|surface
argument_list|)
expr_stmt|;
name|IDirect3DDevice9
modifier|*
name|device
init|=
name|mRenderer
operator|->
name|getDevice
argument_list|()
decl_stmt|;
name|IDirect3DSurface9
modifier|*
name|renderTargetData
init|=
name|NULL
decl_stmt|;
name|D3DSURFACE_DESC
name|description
decl_stmt|;
name|surface
operator|->
name|GetDesc
argument_list|(
operator|&
name|description
argument_list|)
expr_stmt|;
name|HRESULT
name|result
init|=
name|device
operator|->
name|CreateOffscreenPlainSurface
argument_list|(
name|description
operator|.
name|Width
argument_list|,
name|description
operator|.
name|Height
argument_list|,
name|description
operator|.
name|Format
argument_list|,
name|D3DPOOL_SYSTEMMEM
argument_list|,
operator|&
name|renderTargetData
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
name|SafeRelease
argument_list|(
name|surface
argument_list|)
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Could not create matching destination surface, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|result
operator|=
name|device
operator|->
name|GetRenderTargetData
argument_list|(
name|surface
argument_list|,
name|renderTargetData
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
name|SafeRelease
argument_list|(
name|renderTargetData
argument_list|)
expr_stmt|;
name|SafeRelease
argument_list|(
name|surface
argument_list|)
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"GetRenderTargetData unexpectedly failed, result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|int
name|width
init|=
name|sourceArea
operator|.
name|width
decl_stmt|;
name|int
name|height
init|=
name|sourceArea
operator|.
name|height
decl_stmt|;
name|RECT
name|sourceRect
init|=
block|{
name|sourceArea
operator|.
name|x
block|,
name|sourceArea
operator|.
name|y
block|,
name|sourceArea
operator|.
name|x
operator|+
name|width
block|,
name|sourceArea
operator|.
name|y
operator|+
name|height
block|}
decl_stmt|;
name|RECT
name|destRect
init|=
block|{
name|xoffset
block|,
name|yoffset
block|,
name|xoffset
operator|+
name|width
block|,
name|yoffset
operator|+
name|height
block|}
decl_stmt|;
name|D3DLOCKED_RECT
name|sourceLock
init|=
block|{
literal|0
block|}
decl_stmt|;
name|result
operator|=
name|renderTargetData
operator|->
name|LockRect
argument_list|(
operator|&
name|sourceLock
argument_list|,
operator|&
name|sourceRect
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|result
argument_list|)
condition|)
block|{
name|SafeRelease
argument_list|(
name|renderTargetData
argument_list|)
expr_stmt|;
name|SafeRelease
argument_list|(
name|surface
argument_list|)
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_OUT_OF_MEMORY
argument_list|,
literal|"Failed to lock the source surface (rectangle might be invalid), result: 0x%X."
argument_list|,
name|result
argument_list|)
return|;
block|}
name|D3DLOCKED_RECT
name|destLock
init|=
block|{
literal|0
block|}
decl_stmt|;
name|gl
operator|::
name|Error
name|error
init|=
name|lock
argument_list|(
operator|&
name|destLock
argument_list|,
name|destRect
argument_list|)
decl_stmt|;
if|if
condition|(
name|error
operator|.
name|isError
argument_list|()
condition|)
block|{
name|renderTargetData
operator|->
name|UnlockRect
argument_list|()
expr_stmt|;
name|SafeRelease
argument_list|(
name|renderTargetData
argument_list|)
expr_stmt|;
name|SafeRelease
argument_list|(
name|surface
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|ASSERT
argument_list|(
name|destLock
operator|.
name|pBits
operator|&&
name|sourceLock
operator|.
name|pBits
argument_list|)
expr_stmt|;
name|unsigned
name|char
modifier|*
name|sourcePixels
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|sourceLock
operator|.
name|pBits
decl_stmt|;
name|unsigned
name|char
modifier|*
name|destPixels
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|destLock
operator|.
name|pBits
decl_stmt|;
switch|switch
condition|(
name|description
operator|.
name|Format
condition|)
block|{
case|case
name|D3DFMT_X8R8G8B8
case|:
case|case
name|D3DFMT_A8R8G8B8
case|:
switch|switch
condition|(
name|getD3DFormat
argument_list|()
condition|)
block|{
case|case
name|D3DFMT_X8R8G8B8
case|:
case|case
name|D3DFMT_A8R8G8B8
case|:
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
name|memcpy
argument_list|(
name|destPixels
argument_list|,
name|sourcePixels
argument_list|,
literal|4
operator|*
name|width
argument_list|)
expr_stmt|;
name|sourcePixels
operator|+=
name|sourceLock
operator|.
name|Pitch
expr_stmt|;
name|destPixels
operator|+=
name|destLock
operator|.
name|Pitch
expr_stmt|;
block|}
break|break;
case|case
name|D3DFMT_L8
case|:
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|++
control|)
block|{
name|destPixels
index|[
name|x
index|]
operator|=
name|sourcePixels
index|[
name|x
operator|*
literal|4
operator|+
literal|2
index|]
expr_stmt|;
block|}
name|sourcePixels
operator|+=
name|sourceLock
operator|.
name|Pitch
expr_stmt|;
name|destPixels
operator|+=
name|destLock
operator|.
name|Pitch
expr_stmt|;
block|}
break|break;
case|case
name|D3DFMT_A8L8
case|:
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|++
control|)
block|{
name|destPixels
index|[
name|x
operator|*
literal|2
operator|+
literal|0
index|]
operator|=
name|sourcePixels
index|[
name|x
operator|*
literal|4
operator|+
literal|2
index|]
expr_stmt|;
name|destPixels
index|[
name|x
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|sourcePixels
index|[
name|x
operator|*
literal|4
operator|+
literal|3
index|]
expr_stmt|;
block|}
name|sourcePixels
operator|+=
name|sourceLock
operator|.
name|Pitch
expr_stmt|;
name|destPixels
operator|+=
name|destLock
operator|.
name|Pitch
expr_stmt|;
block|}
break|break;
default|default:
name|UNREACHABLE
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|D3DFMT_R5G6B5
case|:
switch|switch
condition|(
name|getD3DFormat
argument_list|()
condition|)
block|{
case|case
name|D3DFMT_X8R8G8B8
case|:
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|++
control|)
block|{
name|unsigned
name|short
name|rgb
init|=
operator|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|sourcePixels
operator|)
index|[
name|x
index|]
decl_stmt|;
name|unsigned
name|char
name|red
init|=
operator|(
name|rgb
operator|&
literal|0xF800
operator|)
operator|>>
literal|8
decl_stmt|;
name|unsigned
name|char
name|green
init|=
operator|(
name|rgb
operator|&
literal|0x07E0
operator|)
operator|>>
literal|3
decl_stmt|;
name|unsigned
name|char
name|blue
init|=
operator|(
name|rgb
operator|&
literal|0x001F
operator|)
operator|<<
literal|3
decl_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|0
index|]
operator|=
name|blue
operator||
operator|(
name|blue
operator|>>
literal|5
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|1
index|]
operator|=
name|green
operator||
operator|(
name|green
operator|>>
literal|6
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|2
index|]
operator|=
name|red
operator||
operator|(
name|red
operator|>>
literal|5
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
block|}
name|sourcePixels
operator|+=
name|sourceLock
operator|.
name|Pitch
expr_stmt|;
name|destPixels
operator|+=
name|destLock
operator|.
name|Pitch
expr_stmt|;
block|}
break|break;
case|case
name|D3DFMT_L8
case|:
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|++
control|)
block|{
name|unsigned
name|char
name|red
init|=
name|sourcePixels
index|[
name|x
operator|*
literal|2
operator|+
literal|1
index|]
operator|&
literal|0xF8
decl_stmt|;
name|destPixels
index|[
name|x
index|]
operator|=
name|red
operator||
operator|(
name|red
operator|>>
literal|5
operator|)
expr_stmt|;
block|}
name|sourcePixels
operator|+=
name|sourceLock
operator|.
name|Pitch
expr_stmt|;
name|destPixels
operator|+=
name|destLock
operator|.
name|Pitch
expr_stmt|;
block|}
break|break;
default|default:
name|UNREACHABLE
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|D3DFMT_A1R5G5B5
case|:
switch|switch
condition|(
name|getD3DFormat
argument_list|()
condition|)
block|{
case|case
name|D3DFMT_X8R8G8B8
case|:
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|++
control|)
block|{
name|unsigned
name|short
name|argb
init|=
operator|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|sourcePixels
operator|)
index|[
name|x
index|]
decl_stmt|;
name|unsigned
name|char
name|red
init|=
operator|(
name|argb
operator|&
literal|0x7C00
operator|)
operator|>>
literal|7
decl_stmt|;
name|unsigned
name|char
name|green
init|=
operator|(
name|argb
operator|&
literal|0x03E0
operator|)
operator|>>
literal|2
decl_stmt|;
name|unsigned
name|char
name|blue
init|=
operator|(
name|argb
operator|&
literal|0x001F
operator|)
operator|<<
literal|3
decl_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|0
index|]
operator|=
name|blue
operator||
operator|(
name|blue
operator|>>
literal|5
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|1
index|]
operator|=
name|green
operator||
operator|(
name|green
operator|>>
literal|5
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|2
index|]
operator|=
name|red
operator||
operator|(
name|red
operator|>>
literal|5
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
block|}
name|sourcePixels
operator|+=
name|sourceLock
operator|.
name|Pitch
expr_stmt|;
name|destPixels
operator|+=
name|destLock
operator|.
name|Pitch
expr_stmt|;
block|}
break|break;
case|case
name|D3DFMT_A8R8G8B8
case|:
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|++
control|)
block|{
name|unsigned
name|short
name|argb
init|=
operator|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|sourcePixels
operator|)
index|[
name|x
index|]
decl_stmt|;
name|unsigned
name|char
name|red
init|=
operator|(
name|argb
operator|&
literal|0x7C00
operator|)
operator|>>
literal|7
decl_stmt|;
name|unsigned
name|char
name|green
init|=
operator|(
name|argb
operator|&
literal|0x03E0
operator|)
operator|>>
literal|2
decl_stmt|;
name|unsigned
name|char
name|blue
init|=
operator|(
name|argb
operator|&
literal|0x001F
operator|)
operator|<<
literal|3
decl_stmt|;
name|unsigned
name|char
name|alpha
init|=
operator|(
name|signed
name|short
operator|)
name|argb
operator|>>
literal|15
decl_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|0
index|]
operator|=
name|blue
operator||
operator|(
name|blue
operator|>>
literal|5
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|1
index|]
operator|=
name|green
operator||
operator|(
name|green
operator|>>
literal|5
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|2
index|]
operator|=
name|red
operator||
operator|(
name|red
operator|>>
literal|5
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|+
literal|3
index|]
operator|=
name|alpha
expr_stmt|;
block|}
name|sourcePixels
operator|+=
name|sourceLock
operator|.
name|Pitch
expr_stmt|;
name|destPixels
operator|+=
name|destLock
operator|.
name|Pitch
expr_stmt|;
block|}
break|break;
case|case
name|D3DFMT_L8
case|:
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|++
control|)
block|{
name|unsigned
name|char
name|red
init|=
name|sourcePixels
index|[
name|x
operator|*
literal|2
operator|+
literal|1
index|]
operator|&
literal|0x7C
decl_stmt|;
name|destPixels
index|[
name|x
index|]
operator|=
operator|(
name|red
operator|<<
literal|1
operator|)
operator||
operator|(
name|red
operator|>>
literal|4
operator|)
expr_stmt|;
block|}
name|sourcePixels
operator|+=
name|sourceLock
operator|.
name|Pitch
expr_stmt|;
name|destPixels
operator|+=
name|destLock
operator|.
name|Pitch
expr_stmt|;
block|}
break|break;
case|case
name|D3DFMT_A8L8
case|:
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|++
control|)
block|{
name|unsigned
name|char
name|red
init|=
name|sourcePixels
index|[
name|x
operator|*
literal|2
operator|+
literal|1
index|]
operator|&
literal|0x7C
decl_stmt|;
name|destPixels
index|[
name|x
operator|*
literal|2
operator|+
literal|0
index|]
operator|=
operator|(
name|red
operator|<<
literal|1
operator|)
operator||
operator|(
name|red
operator|>>
literal|4
operator|)
expr_stmt|;
name|destPixels
index|[
name|x
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
operator|(
name|signed
name|char
operator|)
name|sourcePixels
index|[
name|x
operator|*
literal|2
operator|+
literal|1
index|]
operator|>>
literal|7
expr_stmt|;
block|}
name|sourcePixels
operator|+=
name|sourceLock
operator|.
name|Pitch
expr_stmt|;
name|destPixels
operator|+=
name|destLock
operator|.
name|Pitch
expr_stmt|;
block|}
break|break;
default|default:
name|UNREACHABLE
argument_list|()
expr_stmt|;
block|}
break|break;
default|default:
name|UNREACHABLE
argument_list|()
expr_stmt|;
block|}
name|unlock
argument_list|()
expr_stmt|;
name|renderTargetData
operator|->
name|UnlockRect
argument_list|()
expr_stmt|;
name|SafeRelease
argument_list|(
name|renderTargetData
argument_list|)
expr_stmt|;
name|SafeRelease
argument_list|(
name|surface
argument_list|)
expr_stmt|;
name|mDirty
operator|=
literal|true
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_NO_ERROR
argument_list|)
return|;
block|}
DECL|function|copy
name|gl
operator|::
name|Error
name|Image9
operator|::
name|copy
parameter_list|(
name|GLint
name|xoffset
parameter_list|,
name|GLint
name|yoffset
parameter_list|,
name|GLint
name|zoffset
parameter_list|,
specifier|const
name|gl
operator|::
name|Rectangle
modifier|&
name|area
parameter_list|,
specifier|const
name|gl
operator|::
name|ImageIndex
modifier|&
name|srcIndex
parameter_list|,
name|TextureStorage
modifier|*
name|srcStorage
parameter_list|)
block|{
comment|// Currently unreachable, due to only being used in a D3D11-only workaround
name|UNIMPLEMENTED
argument_list|()
expr_stmt|;
return|return
name|gl
operator|::
name|Error
argument_list|(
name|GL_INVALID_OPERATION
argument_list|)
return|;
block|}
block|}
end_namespace
end_unit
