begin_unit
begin_comment
comment|//
end_comment
begin_comment
comment|// Copyright (c) 2002-2010 The ANGLE Project Authors. All rights reserved.
end_comment
begin_comment
comment|// Use of this source code is governed by a BSD-style license that can be
end_comment
begin_comment
comment|// found in the LICENSE file.
end_comment
begin_comment
comment|//
end_comment
begin_comment
comment|// debug.cpp: Debugging utilities.
end_comment
begin_include
include|#
directive|include
file|"common/debug.h"
end_include
begin_include
include|#
directive|include
file|"common/system.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|ANGLE_ENABLE_D3D11
end_ifdef
begin_typedef
DECL|typedef|D3DCOLOR
typedef|typedef
name|DWORD
name|D3DCOLOR
typedef|;
end_typedef
begin_else
else|#
directive|else
end_else
begin_include
include|#
directive|include
file|<d3d9.h>
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_namespace
DECL|namespace|gl
namespace|namespace
name|gl
block|{
DECL|typedef|PerfOutputFunction
typedef|typedef
name|void
function_decl|(
name|WINAPI
modifier|*
name|PerfOutputFunction
function_decl|)
parameter_list|(
name|D3DCOLOR
parameter_list|,
name|LPCWSTR
parameter_list|)
function_decl|;
DECL|function|output
specifier|static
name|void
name|output
parameter_list|(
name|bool
name|traceFileDebugOnly
parameter_list|,
name|PerfOutputFunction
name|perfFunc
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
name|va_list
name|vararg
parameter_list|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|ANGLE_DISABLE_PERF
argument_list|)
if|if
condition|(
name|perfActive
argument_list|()
condition|)
block|{
name|char
name|message
index|[
literal|32768
index|]
decl_stmt|;
name|int
name|len
init|=
name|vsprintf_s
argument_list|(
name|message
argument_list|,
name|format
argument_list|,
name|vararg
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
return|return;
block|}
comment|// There are no ASCII variants of these D3DPERF functions.
name|wchar_t
name|wideMessage
index|[
literal|32768
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
operator|++
name|i
control|)
block|{
name|wideMessage
index|[
name|i
index|]
operator|=
name|message
index|[
name|i
index|]
expr_stmt|;
block|}
name|wideMessage
index|[
name|len
index|]
operator|=
literal|0
expr_stmt|;
name|perfFunc
argument_list|(
literal|0
argument_list|,
name|wideMessage
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|ANGLE_DISABLE_TRACE
argument_list|)
if|#
directive|if
name|defined
argument_list|(
name|NDEBUG
argument_list|)
if|if
condition|(
name|traceFileDebugOnly
condition|)
block|{
return|return;
block|}
endif|#
directive|endif
name|FILE
modifier|*
name|file
init|=
name|fopen
argument_list|(
name|TRACE_OUTPUT_FILE
argument_list|,
literal|"a"
argument_list|)
decl_stmt|;
if|if
condition|(
name|file
condition|)
block|{
name|vfprintf
argument_list|(
name|file
argument_list|,
name|format
argument_list|,
name|vararg
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
DECL|function|trace
name|void
name|trace
parameter_list|(
name|bool
name|traceFileDebugOnly
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|vararg
decl_stmt|;
name|va_start
argument_list|(
name|vararg
argument_list|,
name|format
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|ANGLE_DISABLE_PERF
argument_list|)
name|output
argument_list|(
name|traceFileDebugOnly
argument_list|,
name|NULL
argument_list|,
name|format
argument_list|,
name|vararg
argument_list|)
expr_stmt|;
else|#
directive|else
name|output
argument_list|(
name|traceFileDebugOnly
argument_list|,
name|D3DPERF_SetMarker
argument_list|,
name|format
argument_list|,
name|vararg
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|va_end
argument_list|(
name|vararg
argument_list|)
expr_stmt|;
block|}
DECL|function|perfActive
name|bool
name|perfActive
parameter_list|()
block|{
if|#
directive|if
name|defined
argument_list|(
name|ANGLE_DISABLE_PERF
argument_list|)
return|return
literal|false
return|;
else|#
directive|else
specifier|static
name|bool
name|active
init|=
name|D3DPERF_GetStatus
argument_list|()
operator|!=
literal|0
decl_stmt|;
return|return
name|active
return|;
endif|#
directive|endif
block|}
DECL|function|ScopedPerfEventHelper
name|ScopedPerfEventHelper
operator|::
name|ScopedPerfEventHelper
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|ANGLE_DISABLE_PERF
argument_list|)
if|#
directive|if
name|defined
argument_list|(
name|ANGLE_DISABLE_TRACE
argument_list|)
if|if
condition|(
operator|!
name|perfActive
argument_list|()
condition|)
block|{
return|return;
block|}
endif|#
directive|endif
name|va_list
name|vararg
decl_stmt|;
name|va_start
argument_list|(
name|vararg
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|output
argument_list|(
literal|true
argument_list|,
cast|reinterpret_cast
argument_list|<
name|PerfOutputFunction
argument_list|>
argument_list|(
name|D3DPERF_BeginEvent
argument_list|)
argument_list|,
name|format
argument_list|,
name|vararg
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|vararg
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
DECL|function|~ScopedPerfEventHelper
name|ScopedPerfEventHelper
operator|::
name|~
name|ScopedPerfEventHelper
parameter_list|()
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|ANGLE_DISABLE_PERF
argument_list|)
if|if
condition|(
name|perfActive
argument_list|()
condition|)
block|{
name|D3DPERF_EndEvent
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
end_namespace
end_unit
