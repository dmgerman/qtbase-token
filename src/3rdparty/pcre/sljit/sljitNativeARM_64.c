begin_unit
begin_comment
comment|/*  *    Stack-less Just-In-Time compiler  *  *    Copyright 2009-2012 Zoltan Herczeg (hzmester@freemail.hu). All rights reserved.  *  * Redistribution and use in source and binary forms, with or without modification, are  * permitted provided that the following conditions are met:  *  *   1. Redistributions of source code must retain the above copyright notice, this list of  *      conditions and the following disclaimer.  *  *   2. Redistributions in binary form must reproduce the above copyright notice, this list  *      of conditions and the following disclaimer in the documentation and/or other materials  *      provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER(S) AND CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT  * SHALL THE COPYRIGHT HOLDER(S) OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED  * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment
begin_function
DECL|function|sljit_get_platform_name
name|SLJIT_API_FUNC_ATTRIBUTE
name|SLJIT_CONST
name|char
modifier|*
name|sljit_get_platform_name
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|"ARM-64"
name|SLJIT_CPUINFO
return|;
block|}
end_function
begin_comment
comment|/* Length of an instruction word */
end_comment
begin_typedef
DECL|typedef|sljit_ins
typedef|typedef
name|sljit_ui
name|sljit_ins
typedef|;
end_typedef
begin_define
DECL|macro|TMP_ZERO
define|#
directive|define
name|TMP_ZERO
value|0
end_define
begin_define
DECL|macro|TMP_REG1
define|#
directive|define
name|TMP_REG1
value|(SLJIT_NO_REGISTERS + 1)
end_define
begin_define
DECL|macro|TMP_REG2
define|#
directive|define
name|TMP_REG2
value|(SLJIT_NO_REGISTERS + 2)
end_define
begin_define
DECL|macro|TMP_REG3
define|#
directive|define
name|TMP_REG3
value|(SLJIT_NO_REGISTERS + 3)
end_define
begin_define
DECL|macro|TMP_REG4
define|#
directive|define
name|TMP_REG4
value|(SLJIT_NO_REGISTERS + 4)
end_define
begin_define
DECL|macro|TMP_LR
define|#
directive|define
name|TMP_LR
value|(SLJIT_NO_REGISTERS + 5)
end_define
begin_define
DECL|macro|TMP_SP
define|#
directive|define
name|TMP_SP
value|(SLJIT_NO_REGISTERS + 6)
end_define
begin_define
DECL|macro|TMP_FREG1
define|#
directive|define
name|TMP_FREG1
value|(0)
end_define
begin_define
DECL|macro|TMP_FREG2
define|#
directive|define
name|TMP_FREG2
value|(SLJIT_FLOAT_REG6 + 1)
end_define
begin_decl_stmt
DECL|variable|reg_map
specifier|static
name|SLJIT_CONST
name|sljit_ub
name|reg_map
index|[
name|SLJIT_NO_REGISTERS
operator|+
literal|7
index|]
init|=
block|{
literal|31
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|29
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|,
literal|30
block|,
literal|31
block|}
decl_stmt|;
end_decl_stmt
begin_define
DECL|macro|W_OP
define|#
directive|define
name|W_OP
value|(1<< 31)
end_define
begin_define
DECL|macro|RD
define|#
directive|define
name|RD
parameter_list|(
name|rd
parameter_list|)
value|(reg_map[rd])
end_define
begin_define
DECL|macro|RT
define|#
directive|define
name|RT
parameter_list|(
name|rt
parameter_list|)
value|(reg_map[rt])
end_define
begin_define
DECL|macro|RN
define|#
directive|define
name|RN
parameter_list|(
name|rn
parameter_list|)
value|(reg_map[rn]<< 5)
end_define
begin_define
DECL|macro|RT2
define|#
directive|define
name|RT2
parameter_list|(
name|rt2
parameter_list|)
value|(reg_map[rt2]<< 10)
end_define
begin_define
DECL|macro|RM
define|#
directive|define
name|RM
parameter_list|(
name|rm
parameter_list|)
value|(reg_map[rm]<< 16)
end_define
begin_define
DECL|macro|VD
define|#
directive|define
name|VD
parameter_list|(
name|vd
parameter_list|)
value|(vd)
end_define
begin_define
DECL|macro|VT
define|#
directive|define
name|VT
parameter_list|(
name|vt
parameter_list|)
value|(vt)
end_define
begin_define
DECL|macro|VN
define|#
directive|define
name|VN
parameter_list|(
name|vn
parameter_list|)
value|((vn)<< 5)
end_define
begin_define
DECL|macro|VM
define|#
directive|define
name|VM
parameter_list|(
name|vm
parameter_list|)
value|((vm)<< 16)
end_define
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_comment
comment|/*  Instrucion forms                                                     */
end_comment
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_define
DECL|macro|ADC
define|#
directive|define
name|ADC
value|0x9a000000
end_define
begin_define
DECL|macro|ADD
define|#
directive|define
name|ADD
value|0x8b000000
end_define
begin_define
DECL|macro|ADDI
define|#
directive|define
name|ADDI
value|0x91000000
end_define
begin_define
DECL|macro|AND
define|#
directive|define
name|AND
value|0x8a000000
end_define
begin_define
DECL|macro|ANDI
define|#
directive|define
name|ANDI
value|0x92000000
end_define
begin_define
DECL|macro|ASRV
define|#
directive|define
name|ASRV
value|0x9ac02800
end_define
begin_define
DECL|macro|B
define|#
directive|define
name|B
value|0x14000000
end_define
begin_define
DECL|macro|B_CC
define|#
directive|define
name|B_CC
value|0x54000000
end_define
begin_define
DECL|macro|BL
define|#
directive|define
name|BL
value|0x94000000
end_define
begin_define
DECL|macro|BLR
define|#
directive|define
name|BLR
value|0xd63f0000
end_define
begin_define
DECL|macro|BR
define|#
directive|define
name|BR
value|0xd61f0000
end_define
begin_define
DECL|macro|BRK
define|#
directive|define
name|BRK
value|0xd4200000
end_define
begin_define
DECL|macro|CBZ
define|#
directive|define
name|CBZ
value|0xb4000000
end_define
begin_define
DECL|macro|CLZ
define|#
directive|define
name|CLZ
value|0xdac01000
end_define
begin_define
DECL|macro|CSINC
define|#
directive|define
name|CSINC
value|0x9a800400
end_define
begin_define
DECL|macro|EOR
define|#
directive|define
name|EOR
value|0xca000000
end_define
begin_define
DECL|macro|EORI
define|#
directive|define
name|EORI
value|0xd2000000
end_define
begin_define
DECL|macro|FABS
define|#
directive|define
name|FABS
value|0x1e60c000
end_define
begin_define
DECL|macro|FADD
define|#
directive|define
name|FADD
value|0x1e602800
end_define
begin_define
DECL|macro|FCMP
define|#
directive|define
name|FCMP
value|0x1e602000
end_define
begin_define
DECL|macro|FDIV
define|#
directive|define
name|FDIV
value|0x1e601800
end_define
begin_define
DECL|macro|FMOV
define|#
directive|define
name|FMOV
value|0x1e604000
end_define
begin_define
DECL|macro|FMUL
define|#
directive|define
name|FMUL
value|0x1e600800
end_define
begin_define
DECL|macro|FNEG
define|#
directive|define
name|FNEG
value|0x1e614000
end_define
begin_define
DECL|macro|FSUB
define|#
directive|define
name|FSUB
value|0x1e603800
end_define
begin_define
DECL|macro|LDRI
define|#
directive|define
name|LDRI
value|0xf9400000
end_define
begin_define
DECL|macro|LDP
define|#
directive|define
name|LDP
value|0xa9400000
end_define
begin_define
DECL|macro|LDP_PST
define|#
directive|define
name|LDP_PST
value|0xa8c00000
end_define
begin_define
DECL|macro|LSLV
define|#
directive|define
name|LSLV
value|0x9ac02000
end_define
begin_define
DECL|macro|LSRV
define|#
directive|define
name|LSRV
value|0x9ac02400
end_define
begin_define
DECL|macro|MADD
define|#
directive|define
name|MADD
value|0x9b000000
end_define
begin_define
DECL|macro|MOVK
define|#
directive|define
name|MOVK
value|0xf2800000
end_define
begin_define
DECL|macro|MOVN
define|#
directive|define
name|MOVN
value|0x92800000
end_define
begin_define
DECL|macro|MOVZ
define|#
directive|define
name|MOVZ
value|0xd2800000
end_define
begin_define
DECL|macro|NOP
define|#
directive|define
name|NOP
value|0xd503201f
end_define
begin_define
DECL|macro|ORN
define|#
directive|define
name|ORN
value|0xaa200000
end_define
begin_define
DECL|macro|ORR
define|#
directive|define
name|ORR
value|0xaa000000
end_define
begin_define
DECL|macro|ORRI
define|#
directive|define
name|ORRI
value|0xb2000000
end_define
begin_define
DECL|macro|RET
define|#
directive|define
name|RET
value|0xd65f0000
end_define
begin_define
DECL|macro|SBC
define|#
directive|define
name|SBC
value|0xda000000
end_define
begin_define
DECL|macro|SBFM
define|#
directive|define
name|SBFM
value|0x93000000
end_define
begin_define
DECL|macro|SDIV
define|#
directive|define
name|SDIV
value|0x9ac00c00
end_define
begin_define
DECL|macro|SMADDL
define|#
directive|define
name|SMADDL
value|0x9b200000
end_define
begin_define
DECL|macro|SMULH
define|#
directive|define
name|SMULH
value|0x9b403c00
end_define
begin_define
DECL|macro|STP
define|#
directive|define
name|STP
value|0xa9000000
end_define
begin_define
DECL|macro|STP_PRE
define|#
directive|define
name|STP_PRE
value|0xa9800000
end_define
begin_define
DECL|macro|STRI
define|#
directive|define
name|STRI
value|0xf9000000
end_define
begin_define
DECL|macro|STR_FI
define|#
directive|define
name|STR_FI
value|0x3d000000
end_define
begin_define
DECL|macro|STR_FR
define|#
directive|define
name|STR_FR
value|0x3c206800
end_define
begin_define
DECL|macro|STUR_FI
define|#
directive|define
name|STUR_FI
value|0x3c000000
end_define
begin_define
DECL|macro|SUB
define|#
directive|define
name|SUB
value|0xcb000000
end_define
begin_define
DECL|macro|SUBI
define|#
directive|define
name|SUBI
value|0xd1000000
end_define
begin_define
DECL|macro|SUBS
define|#
directive|define
name|SUBS
value|0xeb000000
end_define
begin_define
DECL|macro|UBFM
define|#
directive|define
name|UBFM
value|0xd3000000
end_define
begin_define
DECL|macro|UDIV
define|#
directive|define
name|UDIV
value|0x9ac00800
end_define
begin_define
DECL|macro|UMULH
define|#
directive|define
name|UMULH
value|0x9bc03c00
end_define
begin_comment
comment|/* dest_reg is the absolute name of the register    Useful for reordering instructions in the delay slot. */
end_comment
begin_function
DECL|function|push_inst
specifier|static
name|sljit_si
name|push_inst
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_ins
name|ins
parameter_list|)
block|{
name|sljit_ins
modifier|*
name|ptr
init|=
operator|(
name|sljit_ins
operator|*
operator|)
name|ensure_buf
argument_list|(
name|compiler
argument_list|,
sizeof|sizeof
argument_list|(
name|sljit_ins
argument_list|)
argument_list|)
decl_stmt|;
name|FAIL_IF
argument_list|(
operator|!
name|ptr
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|=
name|ins
expr_stmt|;
name|compiler
operator|->
name|size
operator|++
expr_stmt|;
return|return
name|SLJIT_SUCCESS
return|;
block|}
end_function
begin_function
DECL|function|emit_imm64_const
specifier|static
name|SLJIT_INLINE
name|sljit_si
name|emit_imm64_const
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_uw
name|imm
parameter_list|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVZ
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|imm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVK
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
operator|(
name|imm
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|1
operator|<<
literal|21
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVK
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
operator|(
name|imm
operator|>>
literal|32
operator|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|2
operator|<<
literal|21
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVK
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|imm
operator|>>
literal|48
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|3
operator|<<
literal|21
operator|)
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|modify_imm64_const
specifier|static
name|SLJIT_INLINE
name|void
name|modify_imm64_const
parameter_list|(
name|sljit_ins
modifier|*
name|inst
parameter_list|,
name|sljit_uw
name|new_imm
parameter_list|)
block|{
name|sljit_si
name|dst
init|=
name|inst
index|[
literal|0
index|]
operator|&
literal|0x1f
decl_stmt|;
name|SLJIT_ASSERT
argument_list|(
operator|(
name|inst
index|[
literal|0
index|]
operator|&
literal|0xffe00000
operator|)
operator|==
name|MOVZ
operator|&&
operator|(
name|inst
index|[
literal|1
index|]
operator|&
literal|0xffe00000
operator|)
operator|==
operator|(
name|MOVK
operator||
operator|(
literal|1
operator|<<
literal|21
operator|)
operator|)
argument_list|)
expr_stmt|;
name|inst
index|[
literal|0
index|]
operator|=
name|MOVZ
operator||
name|dst
operator||
operator|(
operator|(
name|new_imm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
expr_stmt|;
name|inst
index|[
literal|1
index|]
operator|=
name|MOVK
operator||
name|dst
operator||
operator|(
operator|(
operator|(
name|new_imm
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|1
operator|<<
literal|21
operator|)
expr_stmt|;
name|inst
index|[
literal|2
index|]
operator|=
name|MOVK
operator||
name|dst
operator||
operator|(
operator|(
operator|(
name|new_imm
operator|>>
literal|32
operator|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|2
operator|<<
literal|21
operator|)
expr_stmt|;
name|inst
index|[
literal|3
index|]
operator|=
name|MOVK
operator||
name|dst
operator||
operator|(
operator|(
name|new_imm
operator|>>
literal|48
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|3
operator|<<
literal|21
operator|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|detect_jump_type
specifier|static
name|SLJIT_INLINE
name|sljit_si
name|detect_jump_type
parameter_list|(
name|struct
name|sljit_jump
modifier|*
name|jump
parameter_list|,
name|sljit_ins
modifier|*
name|code_ptr
parameter_list|,
name|sljit_ins
modifier|*
name|code
parameter_list|)
block|{
name|sljit_sw
name|diff
decl_stmt|;
name|sljit_uw
name|target_addr
decl_stmt|;
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
name|SLJIT_REWRITABLE_JUMP
condition|)
block|{
name|jump
operator|->
name|flags
operator||=
name|PATCH_ABS64
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
name|JUMP_ADDR
condition|)
name|target_addr
operator|=
name|jump
operator|->
name|u
operator|.
name|target
expr_stmt|;
else|else
block|{
name|SLJIT_ASSERT
argument_list|(
name|jump
operator|->
name|flags
operator|&
name|JUMP_LABEL
argument_list|)
expr_stmt|;
name|target_addr
operator|=
call|(
name|sljit_uw
call|)
argument_list|(
name|code
operator|+
name|jump
operator|->
name|u
operator|.
name|label
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
name|diff
operator|=
operator|(
name|sljit_sw
operator|)
name|target_addr
operator|-
call|(
name|sljit_sw
call|)
argument_list|(
name|code_ptr
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
name|IS_COND
condition|)
block|{
name|diff
operator|+=
sizeof|sizeof
argument_list|(
name|sljit_ins
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff
operator|<=
literal|0xfffff
operator|&&
name|diff
operator|>=
operator|-
literal|0x100000
condition|)
block|{
name|code_ptr
index|[
operator|-
literal|5
index|]
operator|^=
operator|(
name|jump
operator|->
name|flags
operator|&
name|IS_CBZ
operator|)
condition|?
operator|(
literal|0x1
operator|<<
literal|24
operator|)
else|:
literal|0x1
expr_stmt|;
name|jump
operator|->
name|addr
operator|-=
sizeof|sizeof
argument_list|(
name|sljit_ins
argument_list|)
expr_stmt|;
name|jump
operator|->
name|flags
operator||=
name|PATCH_COND
expr_stmt|;
return|return
literal|5
return|;
block|}
name|diff
operator|-=
sizeof|sizeof
argument_list|(
name|sljit_ins
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|diff
operator|<=
literal|0x7ffffff
operator|&&
name|diff
operator|>=
operator|-
literal|0x8000000
condition|)
block|{
name|jump
operator|->
name|flags
operator||=
name|PATCH_B
expr_stmt|;
return|return
literal|4
return|;
block|}
if|if
condition|(
name|target_addr
operator|<=
literal|0xffffffffl
condition|)
block|{
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
name|IS_COND
condition|)
name|code_ptr
index|[
operator|-
literal|5
index|]
operator|-=
operator|(
literal|2
operator|<<
literal|5
operator|)
expr_stmt|;
name|code_ptr
index|[
operator|-
literal|2
index|]
operator|=
name|code_ptr
index|[
literal|0
index|]
expr_stmt|;
return|return
literal|2
return|;
block|}
if|if
condition|(
name|target_addr
operator|<=
literal|0xffffffffffffl
condition|)
block|{
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
name|IS_COND
condition|)
name|code_ptr
index|[
operator|-
literal|5
index|]
operator|-=
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
name|jump
operator|->
name|flags
operator||=
name|PATCH_ABS48
expr_stmt|;
name|code_ptr
index|[
operator|-
literal|1
index|]
operator|=
name|code_ptr
index|[
literal|0
index|]
expr_stmt|;
return|return
literal|1
return|;
block|}
name|jump
operator|->
name|flags
operator||=
name|PATCH_ABS64
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|sljit_generate_code
name|SLJIT_API_FUNC_ATTRIBUTE
name|void
modifier|*
name|sljit_generate_code
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|)
block|{
name|struct
name|sljit_memory_fragment
modifier|*
name|buf
decl_stmt|;
name|sljit_ins
modifier|*
name|code
decl_stmt|;
name|sljit_ins
modifier|*
name|code_ptr
decl_stmt|;
name|sljit_ins
modifier|*
name|buf_ptr
decl_stmt|;
name|sljit_ins
modifier|*
name|buf_end
decl_stmt|;
name|sljit_uw
name|word_count
decl_stmt|;
name|sljit_uw
name|addr
decl_stmt|;
name|sljit_si
name|dst
decl_stmt|;
name|struct
name|sljit_label
modifier|*
name|label
decl_stmt|;
name|struct
name|sljit_jump
modifier|*
name|jump
decl_stmt|;
name|struct
name|sljit_const
modifier|*
name|const_
decl_stmt|;
name|CHECK_ERROR_PTR
argument_list|()
expr_stmt|;
name|check_sljit_generate_code
argument_list|(
name|compiler
argument_list|)
expr_stmt|;
name|reverse_buf
argument_list|(
name|compiler
argument_list|)
expr_stmt|;
name|code
operator|=
operator|(
name|sljit_ins
operator|*
operator|)
name|SLJIT_MALLOC_EXEC
argument_list|(
name|compiler
operator|->
name|size
operator|*
sizeof|sizeof
argument_list|(
name|sljit_ins
argument_list|)
argument_list|)
expr_stmt|;
name|PTR_FAIL_WITH_EXEC_IF
argument_list|(
name|code
argument_list|)
expr_stmt|;
name|buf
operator|=
name|compiler
operator|->
name|buf
expr_stmt|;
name|code_ptr
operator|=
name|code
expr_stmt|;
name|word_count
operator|=
literal|0
expr_stmt|;
name|label
operator|=
name|compiler
operator|->
name|labels
expr_stmt|;
name|jump
operator|=
name|compiler
operator|->
name|jumps
expr_stmt|;
name|const_
operator|=
name|compiler
operator|->
name|consts
expr_stmt|;
do|do
block|{
name|buf_ptr
operator|=
operator|(
name|sljit_ins
operator|*
operator|)
name|buf
operator|->
name|memory
expr_stmt|;
name|buf_end
operator|=
name|buf_ptr
operator|+
operator|(
name|buf
operator|->
name|used_size
operator|>>
literal|2
operator|)
expr_stmt|;
do|do
block|{
operator|*
name|code_ptr
operator|=
operator|*
name|buf_ptr
operator|++
expr_stmt|;
comment|/* These structures are ordered by their address. */
name|SLJIT_ASSERT
argument_list|(
operator|!
name|label
operator|||
name|label
operator|->
name|size
operator|>=
name|word_count
argument_list|)
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
operator|!
name|jump
operator|||
name|jump
operator|->
name|addr
operator|>=
name|word_count
argument_list|)
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
operator|!
name|const_
operator|||
name|const_
operator|->
name|addr
operator|>=
name|word_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|label
operator|&&
name|label
operator|->
name|size
operator|==
name|word_count
condition|)
block|{
name|label
operator|->
name|addr
operator|=
operator|(
name|sljit_uw
operator|)
name|code_ptr
expr_stmt|;
name|label
operator|->
name|size
operator|=
name|code_ptr
operator|-
name|code
expr_stmt|;
name|label
operator|=
name|label
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|jump
operator|&&
name|jump
operator|->
name|addr
operator|==
name|word_count
condition|)
block|{
name|jump
operator|->
name|addr
operator|=
call|(
name|sljit_uw
call|)
argument_list|(
name|code_ptr
operator|-
literal|4
argument_list|)
expr_stmt|;
name|code_ptr
operator|-=
name|detect_jump_type
argument_list|(
name|jump
argument_list|,
name|code_ptr
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|jump
operator|=
name|jump
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|const_
operator|&&
name|const_
operator|->
name|addr
operator|==
name|word_count
condition|)
block|{
name|const_
operator|->
name|addr
operator|=
operator|(
name|sljit_uw
operator|)
name|code_ptr
expr_stmt|;
name|const_
operator|=
name|const_
operator|->
name|next
expr_stmt|;
block|}
name|code_ptr
operator|++
expr_stmt|;
name|word_count
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|buf_ptr
operator|<
name|buf_end
condition|)
do|;
name|buf
operator|=
name|buf
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|buf
condition|)
do|;
if|if
condition|(
name|label
operator|&&
name|label
operator|->
name|size
operator|==
name|word_count
condition|)
block|{
name|label
operator|->
name|addr
operator|=
operator|(
name|sljit_uw
operator|)
name|code_ptr
expr_stmt|;
name|label
operator|->
name|size
operator|=
name|code_ptr
operator|-
name|code
expr_stmt|;
name|label
operator|=
name|label
operator|->
name|next
expr_stmt|;
block|}
name|SLJIT_ASSERT
argument_list|(
operator|!
name|label
argument_list|)
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
operator|!
name|jump
argument_list|)
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
operator|!
name|const_
argument_list|)
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
name|code_ptr
operator|-
name|code
operator|<=
operator|(
name|sljit_sw
operator|)
name|compiler
operator|->
name|size
argument_list|)
expr_stmt|;
name|jump
operator|=
name|compiler
operator|->
name|jumps
expr_stmt|;
while|while
condition|(
name|jump
condition|)
block|{
do|do
block|{
name|addr
operator|=
operator|(
name|jump
operator|->
name|flags
operator|&
name|JUMP_LABEL
operator|)
condition|?
name|jump
operator|->
name|u
operator|.
name|label
operator|->
name|addr
else|:
name|jump
operator|->
name|u
operator|.
name|target
expr_stmt|;
name|buf_ptr
operator|=
operator|(
name|sljit_ins
operator|*
operator|)
name|jump
operator|->
name|addr
expr_stmt|;
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
name|PATCH_B
condition|)
block|{
name|addr
operator|=
call|(
name|sljit_sw
call|)
argument_list|(
name|addr
operator|-
name|jump
operator|->
name|addr
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
operator|(
name|sljit_sw
operator|)
name|addr
operator|<=
literal|0x1ffffff
operator|&&
operator|(
name|sljit_sw
operator|)
name|addr
operator|>=
operator|-
literal|0x2000000
argument_list|)
expr_stmt|;
name|buf_ptr
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|jump
operator|->
name|flags
operator|&
name|IS_BL
operator|)
condition|?
name|BL
else|:
name|B
operator|)
operator||
operator|(
name|addr
operator|&
literal|0x3ffffff
operator|)
expr_stmt|;
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
name|IS_COND
condition|)
name|buf_ptr
index|[
operator|-
literal|1
index|]
operator|-=
operator|(
literal|4
operator|<<
literal|5
operator|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
name|PATCH_COND
condition|)
block|{
name|addr
operator|=
call|(
name|sljit_sw
call|)
argument_list|(
name|addr
operator|-
name|jump
operator|->
name|addr
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
operator|(
name|sljit_sw
operator|)
name|addr
operator|<=
literal|0x3ffff
operator|&&
operator|(
name|sljit_sw
operator|)
name|addr
operator|>=
operator|-
literal|0x40000
argument_list|)
expr_stmt|;
name|buf_ptr
index|[
literal|0
index|]
operator|=
operator|(
name|buf_ptr
index|[
literal|0
index|]
operator|&
operator|~
literal|0xffffe0
operator|)
operator||
operator|(
operator|(
name|addr
operator|&
literal|0x7ffff
operator|)
operator|<<
literal|5
operator|)
expr_stmt|;
break|break;
block|}
name|SLJIT_ASSERT
argument_list|(
operator|(
name|jump
operator|->
name|flags
operator|&
operator|(
name|PATCH_ABS48
operator||
name|PATCH_ABS64
operator|)
operator|)
operator|||
name|addr
operator|<=
literal|0xffffffffl
argument_list|)
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
operator|(
name|jump
operator|->
name|flags
operator|&
name|PATCH_ABS64
operator|)
operator|||
name|addr
operator|<=
literal|0xffffffffffffl
argument_list|)
expr_stmt|;
name|dst
operator|=
name|buf_ptr
index|[
literal|0
index|]
operator|&
literal|0x1f
expr_stmt|;
name|buf_ptr
index|[
literal|0
index|]
operator|=
name|MOVZ
operator||
name|dst
operator||
operator|(
operator|(
name|addr
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
expr_stmt|;
name|buf_ptr
index|[
literal|1
index|]
operator|=
name|MOVK
operator||
name|dst
operator||
operator|(
operator|(
operator|(
name|addr
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|1
operator|<<
literal|21
operator|)
expr_stmt|;
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
operator|(
name|PATCH_ABS48
operator||
name|PATCH_ABS64
operator|)
condition|)
name|buf_ptr
index|[
literal|2
index|]
operator|=
name|MOVK
operator||
name|dst
operator||
operator|(
operator|(
operator|(
name|addr
operator|>>
literal|32
operator|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|2
operator|<<
literal|21
operator|)
expr_stmt|;
if|if
condition|(
name|jump
operator|->
name|flags
operator|&
name|PATCH_ABS64
condition|)
name|buf_ptr
index|[
literal|3
index|]
operator|=
name|MOVK
operator||
name|dst
operator||
operator|(
operator|(
operator|(
name|addr
operator|>>
literal|48
operator|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|3
operator|<<
literal|21
operator|)
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|jump
operator|=
name|jump
operator|->
name|next
expr_stmt|;
block|}
name|compiler
operator|->
name|error
operator|=
name|SLJIT_ERR_COMPILED
expr_stmt|;
name|compiler
operator|->
name|executable_size
operator|=
operator|(
name|code_ptr
operator|-
name|code
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|sljit_ins
argument_list|)
expr_stmt|;
name|SLJIT_CACHE_FLUSH
argument_list|(
name|code
argument_list|,
name|code_ptr
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_comment
comment|/*  Core code generator functions.                                       */
end_comment
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_define
DECL|macro|COUNT_TRAILING_ZERO
define|#
directive|define
name|COUNT_TRAILING_ZERO
parameter_list|(
name|value
parameter_list|,
name|result
parameter_list|)
define|\
value|result = 0; \ 	if (!(value& 0xffffffff)) { \ 		result += 32; \ 		value>>= 32; \ 	} \ 	if (!(value& 0xffff)) { \ 		result += 16; \ 		value>>= 16; \ 	} \ 	if (!(value& 0xff)) { \ 		result += 8; \ 		value>>= 8; \ 	} \ 	if (!(value& 0xf)) { \ 		result += 4; \ 		value>>= 4; \ 	} \ 	if (!(value& 0x3)) { \ 		result += 2; \ 		value>>= 2; \ 	} \ 	if (!(value& 0x1)) { \ 		result += 1; \ 		value>>= 1; \ 	}
end_define
begin_define
DECL|macro|LOGICAL_IMM_CHECK
define|#
directive|define
name|LOGICAL_IMM_CHECK
value|0x100
end_define
begin_function
DECL|function|logical_imm
specifier|static
name|sljit_ins
name|logical_imm
parameter_list|(
name|sljit_sw
name|imm
parameter_list|,
name|sljit_si
name|len
parameter_list|)
block|{
name|sljit_si
name|negated
decl_stmt|,
name|ones
decl_stmt|,
name|right
decl_stmt|;
name|sljit_uw
name|mask
decl_stmt|,
name|uimm
decl_stmt|;
name|sljit_ins
name|ins
decl_stmt|;
if|if
condition|(
name|len
operator|&
name|LOGICAL_IMM_CHECK
condition|)
block|{
name|len
operator|&=
operator|~
name|LOGICAL_IMM_CHECK
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|32
operator|&&
operator|(
name|imm
operator|==
literal|0
operator|||
name|imm
operator|==
operator|-
literal|1
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|len
operator|==
literal|16
operator|&&
operator|(
operator|(
name|sljit_si
operator|)
name|imm
operator|==
literal|0
operator|||
operator|(
name|sljit_si
operator|)
name|imm
operator|==
operator|-
literal|1
operator|)
condition|)
return|return
literal|0
return|;
block|}
name|SLJIT_ASSERT
argument_list|(
operator|(
name|len
operator|==
literal|32
operator|&&
name|imm
operator|!=
literal|0
operator|&&
name|imm
operator|!=
operator|-
literal|1
operator|)
operator|||
operator|(
name|len
operator|==
literal|16
operator|&&
operator|(
name|sljit_si
operator|)
name|imm
operator|!=
literal|0
operator|&&
operator|(
name|sljit_si
operator|)
name|imm
operator|!=
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|uimm
operator|=
operator|(
name|sljit_uw
operator|)
name|imm
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
block|{
name|SLJIT_ASSERT_STOP
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
name|mask
operator|=
operator|(
operator|(
name|sljit_uw
operator|)
literal|1
operator|<<
name|len
operator|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|uimm
operator|&
name|mask
operator|)
operator|!=
operator|(
operator|(
name|uimm
operator|>>
name|len
operator|)
operator|&
name|mask
operator|)
condition|)
break|break;
name|len
operator|>>=
literal|1
expr_stmt|;
block|}
name|len
operator|<<=
literal|1
expr_stmt|;
name|negated
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|uimm
operator|&
literal|0x1
condition|)
block|{
name|negated
operator|=
literal|1
expr_stmt|;
name|uimm
operator|=
operator|~
name|uimm
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|<
literal|64
condition|)
name|uimm
operator|&=
operator|(
operator|(
name|sljit_uw
operator|)
literal|1
operator|<<
name|len
operator|)
operator|-
literal|1
expr_stmt|;
comment|/* Unsigned right shift. */
name|COUNT_TRAILING_ZERO
argument_list|(
name|uimm
argument_list|,
name|right
argument_list|)
expr_stmt|;
comment|/* Signed shift. We also know that the highest bit is set. */
name|imm
operator|=
operator|(
name|sljit_sw
operator|)
operator|~
name|uimm
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
name|imm
operator|<
literal|0
argument_list|)
expr_stmt|;
name|COUNT_TRAILING_ZERO
argument_list|(
name|imm
argument_list|,
name|ones
argument_list|)
expr_stmt|;
if|if
condition|(
operator|~
name|imm
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|len
operator|==
literal|64
condition|)
name|ins
operator|=
literal|1
operator|<<
literal|22
expr_stmt|;
else|else
name|ins
operator|=
operator|(
literal|0x3f
operator|-
operator|(
operator|(
name|len
operator|<<
literal|1
operator|)
operator|-
literal|1
operator|)
operator|)
operator|<<
literal|10
expr_stmt|;
if|if
condition|(
name|negated
condition|)
return|return
name|ins
operator||
operator|(
operator|(
name|len
operator|-
name|ones
operator|-
literal|1
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
operator|(
name|len
operator|-
name|ones
operator|-
name|right
operator|)
operator|<<
literal|16
operator|)
return|;
return|return
name|ins
operator||
operator|(
operator|(
name|ones
operator|-
literal|1
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
operator|(
name|len
operator|-
name|right
operator|)
operator|<<
literal|16
operator|)
return|;
block|}
end_function
begin_undef
DECL|macro|COUNT_TRAILING_ZERO
undef|#
directive|undef
name|COUNT_TRAILING_ZERO
end_undef
begin_function
DECL|function|load_immediate
specifier|static
name|sljit_si
name|load_immediate
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_sw
name|simm
parameter_list|)
block|{
name|sljit_uw
name|imm
init|=
operator|(
name|sljit_uw
operator|)
name|simm
decl_stmt|;
name|sljit_si
name|i
decl_stmt|,
name|zeros
decl_stmt|,
name|ones
decl_stmt|,
name|first
decl_stmt|;
name|sljit_ins
name|bitmask
decl_stmt|;
if|if
condition|(
name|imm
operator|<=
literal|0xffff
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVZ
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
name|imm
operator|<<
literal|5
operator|)
argument_list|)
return|;
if|if
condition|(
name|simm
operator|>=
operator|-
literal|0x10000
operator|&&
name|simm
operator|<
literal|0
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVN
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
operator|~
name|imm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
argument_list|)
return|;
if|if
condition|(
name|imm
operator|<=
literal|0xffffffffl
condition|)
block|{
if|if
condition|(
operator|(
name|imm
operator|&
literal|0xffff0000l
operator|)
operator|==
literal|0xffff0000
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|MOVN
operator|^
name|W_OP
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
operator|~
name|imm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
argument_list|)
return|;
if|if
condition|(
operator|(
name|imm
operator|&
literal|0xffff
operator|)
operator|==
literal|0xffff
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|MOVN
operator|^
name|W_OP
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
operator|~
name|imm
operator|&
literal|0xffff0000l
operator|)
operator|>>
operator|(
literal|16
operator|-
literal|5
operator|)
operator|)
operator||
operator|(
literal|1
operator|<<
literal|21
operator|)
argument_list|)
return|;
name|bitmask
operator|=
name|logical_imm
argument_list|(
name|simm
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitmask
operator|!=
literal|0
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ORRI
operator|^
name|W_OP
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|bitmask
argument_list|)
return|;
block|}
else|else
block|{
name|bitmask
operator|=
name|logical_imm
argument_list|(
name|simm
argument_list|,
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitmask
operator|!=
literal|0
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ORRI
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|bitmask
argument_list|)
return|;
block|}
if|if
condition|(
name|imm
operator|<=
literal|0xffffffffl
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVZ
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|imm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVK
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|imm
operator|&
literal|0xffff0000l
operator|)
operator|>>
operator|(
literal|16
operator|-
literal|5
operator|)
operator|)
operator||
operator|(
literal|1
operator|<<
literal|21
operator|)
argument_list|)
return|;
block|}
if|if
condition|(
name|simm
operator|>=
operator|-
literal|0x100000000l
operator|&&
name|simm
operator|<
literal|0
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVN
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
operator|~
name|imm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVK
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|imm
operator|&
literal|0xffff0000l
operator|)
operator|>>
operator|(
literal|16
operator|-
literal|5
operator|)
operator|)
operator||
operator|(
literal|1
operator|<<
literal|21
operator|)
argument_list|)
return|;
block|}
comment|/* A large amount of number can be constructed from ORR and MOVx, 	but computing them is costly. We don't  */
name|zeros
operator|=
literal|0
expr_stmt|;
name|ones
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|simm
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
name|zeros
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|simm
operator|&
literal|0xffff
operator|)
operator|==
literal|0xffff
condition|)
name|ones
operator|++
expr_stmt|;
name|simm
operator|>>=
literal|16
expr_stmt|;
block|}
name|simm
operator|=
operator|(
name|sljit_sw
operator|)
name|imm
expr_stmt|;
name|first
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ones
operator|>
name|zeros
condition|)
block|{
name|simm
operator|=
operator|~
name|simm
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|simm
operator|&
literal|0xffff
operator|)
condition|)
block|{
name|simm
operator|>>=
literal|16
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|0
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVN
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|simm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
name|i
operator|<<
literal|21
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVK
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
operator|~
name|simm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
name|i
operator|<<
literal|21
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|simm
operator|>>=
literal|16
expr_stmt|;
block|}
return|return
name|SLJIT_SUCCESS
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|simm
operator|&
literal|0xffff
operator|)
condition|)
block|{
name|simm
operator|>>=
literal|16
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|0
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVZ
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|simm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
name|i
operator|<<
literal|21
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MOVK
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|simm
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
name|i
operator|<<
literal|21
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|simm
operator|>>=
literal|16
expr_stmt|;
block|}
return|return
name|SLJIT_SUCCESS
return|;
block|}
end_function
begin_define
DECL|macro|ARG1_IMM
define|#
directive|define
name|ARG1_IMM
value|0x0010000
end_define
begin_define
DECL|macro|ARG2_IMM
define|#
directive|define
name|ARG2_IMM
value|0x0020000
end_define
begin_define
DECL|macro|INT_OP
define|#
directive|define
name|INT_OP
value|0x0040000
end_define
begin_define
DECL|macro|SET_FLAGS
define|#
directive|define
name|SET_FLAGS
value|0x0080000
end_define
begin_define
DECL|macro|UNUSED_RETURN
define|#
directive|define
name|UNUSED_RETURN
value|0x0100000
end_define
begin_define
DECL|macro|SLOW_DEST
define|#
directive|define
name|SLOW_DEST
value|0x0200000
end_define
begin_define
DECL|macro|SLOW_SRC1
define|#
directive|define
name|SLOW_SRC1
value|0x0400000
end_define
begin_define
DECL|macro|SLOW_SRC2
define|#
directive|define
name|SLOW_SRC2
value|0x0800000
end_define
begin_define
DECL|macro|CHECK_FLAGS
define|#
directive|define
name|CHECK_FLAGS
parameter_list|(
name|flag_bits
parameter_list|)
define|\
value|if (flags& SET_FLAGS) { \ 		inv_bits |= flag_bits; \ 		if (flags& UNUSED_RETURN) \ 			dst = TMP_ZERO; \ 	}
end_define
begin_function
DECL|function|emit_op_imm
specifier|static
name|sljit_si
name|emit_op_imm
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|flags
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_sw
name|arg1
parameter_list|,
name|sljit_sw
name|arg2
parameter_list|)
block|{
comment|/* dst must be register, TMP_REG1 	   arg1 must be register, TMP_REG1, imm 	   arg2 must be register, TMP_REG2, imm */
name|sljit_ins
name|inv_bits
init|=
operator|(
name|flags
operator|&
name|INT_OP
operator|)
condition|?
operator|(
literal|1
operator|<<
literal|31
operator|)
else|:
literal|0
decl_stmt|;
name|sljit_ins
name|inst_bits
decl_stmt|;
name|sljit_si
name|op
init|=
operator|(
name|flags
operator|&
literal|0xffff
operator|)
decl_stmt|;
name|sljit_si
name|reg
decl_stmt|;
name|sljit_sw
name|imm
decl_stmt|,
name|nimm
decl_stmt|;
if|if
condition|(
name|SLJIT_UNLIKELY
argument_list|(
operator|(
name|flags
operator|&
operator|(
name|ARG1_IMM
operator||
name|ARG2_IMM
operator|)
operator|)
operator|==
operator|(
name|ARG1_IMM
operator||
name|ARG2_IMM
operator|)
argument_list|)
condition|)
block|{
comment|/* Both are immediates. */
name|flags
operator|&=
operator|~
name|ARG1_IMM
expr_stmt|;
if|if
condition|(
name|arg1
operator|==
literal|0
operator|&&
name|op
operator|!=
name|SLJIT_ADD
operator|&&
name|op
operator|!=
name|SLJIT_SUB
condition|)
name|arg1
operator|=
name|TMP_ZERO
expr_stmt|;
else|else
block|{
name|FAIL_IF
argument_list|(
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|TMP_REG1
argument_list|,
name|arg1
argument_list|)
argument_list|)
expr_stmt|;
name|arg1
operator|=
name|TMP_REG1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|flags
operator|&
operator|(
name|ARG1_IMM
operator||
name|ARG2_IMM
operator|)
condition|)
block|{
name|reg
operator|=
operator|(
name|flags
operator|&
name|ARG2_IMM
operator|)
condition|?
name|arg1
else|:
name|arg2
expr_stmt|;
name|imm
operator|=
operator|(
name|flags
operator|&
name|ARG2_IMM
operator|)
condition|?
name|arg2
else|:
name|arg1
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SLJIT_MUL
case|:
case|case
name|SLJIT_NEG
case|:
case|case
name|SLJIT_CLZ
case|:
case|case
name|SLJIT_ADDC
case|:
case|case
name|SLJIT_SUBC
case|:
comment|/* No form with immediate operand (except imm 0, which 			is represented by a ZERO register). */
break|break;
case|case
name|SLJIT_MOV
case|:
name|SLJIT_ASSERT
argument_list|(
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
operator|&&
operator|(
name|flags
operator|&
name|ARG2_IMM
operator|)
operator|&&
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
return|return
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|dst
argument_list|,
name|imm
argument_list|)
return|;
case|case
name|SLJIT_NOT
case|:
name|SLJIT_ASSERT
argument_list|(
name|flags
operator|&
name|ARG2_IMM
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|dst
argument_list|,
operator|(
name|flags
operator|&
name|INT_OP
operator|)
condition|?
operator|(
operator|~
name|imm
operator|&
literal|0xffffffff
operator|)
else|:
operator|~
name|imm
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|set_flags
goto|;
case|case
name|SLJIT_SUB
case|:
if|if
condition|(
name|flags
operator|&
name|ARG1_IMM
condition|)
break|break;
name|imm
operator|=
operator|-
name|imm
expr_stmt|;
comment|/* Fall through. */
case|case
name|SLJIT_ADD
case|:
if|if
condition|(
name|imm
operator|==
literal|0
condition|)
block|{
name|CHECK_FLAGS
argument_list|(
literal|1
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
operator|(
name|op
operator|==
name|SLJIT_ADD
condition|?
name|ADDI
else|:
name|SUBI
operator|)
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|imm
operator|>
literal|0
operator|&&
name|imm
operator|<=
literal|0xfff
condition|)
block|{
name|CHECK_FLAGS
argument_list|(
literal|1
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ADDI
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
name|imm
operator|<<
literal|10
operator|)
argument_list|)
return|;
block|}
name|nimm
operator|=
operator|-
name|imm
expr_stmt|;
if|if
condition|(
name|nimm
operator|>
literal|0
operator|&&
name|nimm
operator|<=
literal|0xfff
condition|)
block|{
name|CHECK_FLAGS
argument_list|(
literal|1
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SUBI
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
name|nimm
operator|<<
literal|10
operator|)
argument_list|)
return|;
block|}
if|if
condition|(
name|imm
operator|>
literal|0
operator|&&
name|imm
operator|<=
literal|0xffffff
operator|&&
operator|!
operator|(
name|imm
operator|&
literal|0xfff
operator|)
condition|)
block|{
name|CHECK_FLAGS
argument_list|(
literal|1
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ADDI
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
operator|(
name|imm
operator|>>
literal|12
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
argument_list|)
return|;
block|}
if|if
condition|(
name|nimm
operator|>
literal|0
operator|&&
name|nimm
operator|<=
literal|0xffffff
operator|&&
operator|!
operator|(
name|nimm
operator|&
literal|0xfff
operator|)
condition|)
block|{
name|CHECK_FLAGS
argument_list|(
literal|1
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SUBI
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
operator|(
name|nimm
operator|>>
literal|12
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
argument_list|)
return|;
block|}
if|if
condition|(
name|imm
operator|>
literal|0
operator|&&
name|imm
operator|<=
literal|0xffffff
operator|&&
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ADDI
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
operator|(
name|imm
operator|>>
literal|12
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ADDI
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|imm
operator|&
literal|0xfff
operator|)
operator|<<
literal|10
operator|)
argument_list|)
return|;
block|}
if|if
condition|(
name|nimm
operator|>
literal|0
operator|&&
name|nimm
operator|<=
literal|0xffffff
operator|&&
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SUBI
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
operator|(
name|nimm
operator|>>
literal|12
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SUBI
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|dst
argument_list|)
operator||
operator|(
operator|(
name|nimm
operator|&
literal|0xfff
operator|)
operator|<<
literal|10
operator|)
argument_list|)
return|;
block|}
break|break;
case|case
name|SLJIT_AND
case|:
name|inst_bits
operator|=
name|logical_imm
argument_list|(
name|imm
argument_list|,
name|LOGICAL_IMM_CHECK
operator||
operator|(
operator|(
name|flags
operator|&
name|INT_OP
operator|)
condition|?
literal|16
else|:
literal|32
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|inst_bits
condition|)
break|break;
name|CHECK_FLAGS
argument_list|(
literal|3
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ANDI
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
name|inst_bits
argument_list|)
return|;
case|case
name|SLJIT_OR
case|:
case|case
name|SLJIT_XOR
case|:
name|inst_bits
operator|=
name|logical_imm
argument_list|(
name|imm
argument_list|,
name|LOGICAL_IMM_CHECK
operator||
operator|(
operator|(
name|flags
operator|&
name|INT_OP
operator|)
condition|?
literal|16
else|:
literal|32
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|inst_bits
condition|)
break|break;
if|if
condition|(
name|op
operator|==
name|SLJIT_OR
condition|)
name|inst_bits
operator||=
name|ORRI
expr_stmt|;
else|else
name|inst_bits
operator||=
name|EORI
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|inst_bits
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|set_flags
goto|;
case|case
name|SLJIT_SHL
case|:
if|if
condition|(
name|flags
operator|&
name|ARG1_IMM
condition|)
break|break;
if|if
condition|(
name|flags
operator|&
name|INT_OP
condition|)
block|{
name|imm
operator|&=
literal|0x1f
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|UBFM
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
operator|(
operator|(
operator|-
name|imm
operator|&
literal|0x1f
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
literal|31
operator|-
name|imm
operator|)
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|imm
operator|&=
literal|0x3f
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|UBFM
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
operator||
operator|(
operator|(
operator|-
name|imm
operator|&
literal|0x3f
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
literal|63
operator|-
name|imm
operator|)
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|set_flags
goto|;
case|case
name|SLJIT_LSHR
case|:
case|case
name|SLJIT_ASHR
case|:
if|if
condition|(
name|flags
operator|&
name|ARG1_IMM
condition|)
break|break;
if|if
condition|(
name|op
operator|==
name|SLJIT_ASHR
condition|)
name|inv_bits
operator||=
literal|1
operator|<<
literal|30
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|INT_OP
condition|)
block|{
name|imm
operator|&=
literal|0x1f
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|UBFM
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
operator|(
name|imm
operator|<<
literal|16
operator|)
operator||
operator|(
literal|31
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|imm
operator|&=
literal|0x3f
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|UBFM
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
operator||
operator|(
name|imm
operator|<<
literal|16
operator|)
operator||
operator|(
literal|63
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|set_flags
goto|;
default|default:
name|SLJIT_ASSERT_STOP
argument_list|()
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|flags
operator|&
name|ARG2_IMM
condition|)
block|{
if|if
condition|(
name|arg2
operator|==
literal|0
condition|)
name|arg2
operator|=
name|TMP_ZERO
expr_stmt|;
else|else
block|{
name|FAIL_IF
argument_list|(
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|TMP_REG2
argument_list|,
name|arg2
argument_list|)
argument_list|)
expr_stmt|;
name|arg2
operator|=
name|TMP_REG2
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|arg1
operator|==
literal|0
condition|)
name|arg1
operator|=
name|TMP_ZERO
expr_stmt|;
else|else
block|{
name|FAIL_IF
argument_list|(
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|TMP_REG1
argument_list|,
name|arg1
argument_list|)
argument_list|)
expr_stmt|;
name|arg1
operator|=
name|TMP_REG1
expr_stmt|;
block|}
block|}
block|}
comment|/* Both arguments are registers. */
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SLJIT_MOV
case|:
case|case
name|SLJIT_MOV_P
case|:
case|case
name|SLJIT_MOVU
case|:
case|case
name|SLJIT_MOVU_P
case|:
name|SLJIT_ASSERT
argument_list|(
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
operator|&&
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|==
name|arg2
condition|)
return|return
name|SLJIT_SUCCESS
return|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ORR
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
return|;
case|case
name|SLJIT_MOV_UB
case|:
case|case
name|SLJIT_MOVU_UB
case|:
name|SLJIT_ASSERT
argument_list|(
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
operator|&&
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|UBFM
operator|^
operator|(
literal|1
operator|<<
literal|31
operator|)
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg2
argument_list|)
operator||
operator|(
literal|7
operator|<<
literal|10
operator|)
argument_list|)
return|;
case|case
name|SLJIT_MOV_SB
case|:
case|case
name|SLJIT_MOVU_SB
case|:
name|SLJIT_ASSERT
argument_list|(
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
operator|&&
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|INT_OP
operator|)
condition|)
name|inv_bits
operator||=
literal|1
operator|<<
literal|22
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SBFM
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg2
argument_list|)
operator||
operator|(
literal|7
operator|<<
literal|10
operator|)
argument_list|)
return|;
case|case
name|SLJIT_MOV_UH
case|:
case|case
name|SLJIT_MOVU_UH
case|:
name|SLJIT_ASSERT
argument_list|(
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
operator|&&
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|UBFM
operator|^
operator|(
literal|1
operator|<<
literal|31
operator|)
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg2
argument_list|)
operator||
operator|(
literal|15
operator|<<
literal|10
operator|)
argument_list|)
return|;
case|case
name|SLJIT_MOV_SH
case|:
case|case
name|SLJIT_MOVU_SH
case|:
name|SLJIT_ASSERT
argument_list|(
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
operator|&&
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|INT_OP
operator|)
condition|)
name|inv_bits
operator||=
literal|1
operator|<<
literal|22
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SBFM
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg2
argument_list|)
operator||
operator|(
literal|15
operator|<<
literal|10
operator|)
argument_list|)
return|;
case|case
name|SLJIT_MOV_UI
case|:
case|case
name|SLJIT_MOVU_UI
case|:
name|SLJIT_ASSERT
argument_list|(
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
operator|&&
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|INT_OP
operator|)
operator|&&
name|dst
operator|==
name|arg2
condition|)
return|return
name|SLJIT_SUCCESS
return|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ORR
operator|^
operator|(
literal|1
operator|<<
literal|31
operator|)
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
return|;
case|case
name|SLJIT_MOV_SI
case|:
case|case
name|SLJIT_MOVU_SI
case|:
name|SLJIT_ASSERT
argument_list|(
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
operator|&&
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|INT_OP
operator|)
operator|&&
name|dst
operator|==
name|arg2
condition|)
return|return
name|SLJIT_SUCCESS
return|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SBFM
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg2
argument_list|)
operator||
operator|(
literal|31
operator|<<
literal|10
operator|)
argument_list|)
return|;
case|case
name|SLJIT_NOT
case|:
name|SLJIT_ASSERT
argument_list|(
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ORN
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|set_flags
goto|;
case|case
name|SLJIT_NEG
case|:
name|SLJIT_ASSERT
argument_list|(
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|SET_FLAGS
condition|)
name|inv_bits
operator||=
literal|1
operator|<<
literal|29
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SUB
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
return|;
case|case
name|SLJIT_CLZ
case|:
name|SLJIT_ASSERT
argument_list|(
name|arg1
operator|==
name|TMP_REG1
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|CLZ
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|set_flags
goto|;
case|case
name|SLJIT_ADD
case|:
name|CHECK_FLAGS
argument_list|(
literal|1
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ADD
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
return|;
case|case
name|SLJIT_ADDC
case|:
name|CHECK_FLAGS
argument_list|(
literal|1
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ADC
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
return|;
case|case
name|SLJIT_SUB
case|:
name|CHECK_FLAGS
argument_list|(
literal|1
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SUB
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
return|;
case|case
name|SLJIT_SUBC
case|:
name|CHECK_FLAGS
argument_list|(
literal|1
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SBC
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
return|;
case|case
name|SLJIT_MUL
case|:
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|SET_FLAGS
operator|)
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|MADD
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
operator||
name|RT2
argument_list|(
name|TMP_ZERO
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|flags
operator|&
name|INT_OP
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SMADDL
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
operator||
operator|(
literal|31
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADD
operator||
name|RD
argument_list|(
name|TMP_REG4
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|dst
argument_list|)
operator||
operator|(
literal|2
operator|<<
literal|22
operator|)
operator||
operator|(
literal|31
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SUBS
operator||
name|RD
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG4
argument_list|)
operator||
name|RM
argument_list|(
name|dst
argument_list|)
operator||
operator|(
literal|2
operator|<<
literal|22
operator|)
operator||
operator|(
literal|63
operator|<<
literal|10
operator|)
argument_list|)
return|;
block|}
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SMULH
operator||
name|RD
argument_list|(
name|TMP_REG4
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MADD
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
operator||
name|RT2
argument_list|(
name|TMP_ZERO
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SUBS
operator||
name|RD
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG4
argument_list|)
operator||
name|RM
argument_list|(
name|dst
argument_list|)
operator||
operator|(
literal|2
operator|<<
literal|22
operator|)
operator||
operator|(
literal|63
operator|<<
literal|10
operator|)
argument_list|)
return|;
case|case
name|SLJIT_AND
case|:
name|CHECK_FLAGS
argument_list|(
literal|3
operator|<<
literal|29
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|AND
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
return|;
case|case
name|SLJIT_OR
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ORR
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|set_flags
goto|;
case|case
name|SLJIT_XOR
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|EOR
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|set_flags
goto|;
case|case
name|SLJIT_SHL
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|LSLV
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|set_flags
goto|;
case|case
name|SLJIT_LSHR
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|LSRV
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|set_flags
goto|;
case|case
name|SLJIT_ASHR
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ASRV
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|arg1
argument_list|)
operator||
name|RM
argument_list|(
name|arg2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|set_flags
goto|;
block|}
name|SLJIT_ASSERT_STOP
argument_list|()
expr_stmt|;
return|return
name|SLJIT_SUCCESS
return|;
name|set_flags
label|:
if|if
condition|(
name|flags
operator|&
name|SET_FLAGS
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SUBS
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RN
argument_list|(
name|dst
argument_list|)
operator||
name|RM
argument_list|(
name|TMP_ZERO
argument_list|)
argument_list|)
return|;
return|return
name|SLJIT_SUCCESS
return|;
block|}
end_function
begin_define
DECL|macro|STORE
define|#
directive|define
name|STORE
value|0x01
end_define
begin_define
DECL|macro|SIGNED
define|#
directive|define
name|SIGNED
value|0x02
end_define
begin_define
DECL|macro|UPDATE
define|#
directive|define
name|UPDATE
value|0x04
end_define
begin_define
DECL|macro|ARG_TEST
define|#
directive|define
name|ARG_TEST
value|0x08
end_define
begin_define
DECL|macro|BYTE_SIZE
define|#
directive|define
name|BYTE_SIZE
value|0x000
end_define
begin_define
DECL|macro|HALF_SIZE
define|#
directive|define
name|HALF_SIZE
value|0x100
end_define
begin_define
DECL|macro|INT_SIZE
define|#
directive|define
name|INT_SIZE
value|0x200
end_define
begin_define
DECL|macro|WORD_SIZE
define|#
directive|define
name|WORD_SIZE
value|0x300
end_define
begin_define
DECL|macro|MEM_SIZE_SHIFT
define|#
directive|define
name|MEM_SIZE_SHIFT
parameter_list|(
name|flags
parameter_list|)
value|((flags)>> 8)
end_define
begin_decl_stmt
DECL|variable|sljit_mem_imm
specifier|static
name|SLJIT_CONST
name|sljit_ins
name|sljit_mem_imm
index|[
literal|4
index|]
init|=
block|{
comment|/* u l */
literal|0x39400000
comment|/* ldrb [reg,imm] */
block|,
comment|/* u s */
literal|0x39000000
comment|/* strb [reg,imm] */
block|,
comment|/* s l */
literal|0x39800000
comment|/* ldrsb [reg,imm] */
block|,
comment|/* s s */
literal|0x39000000
comment|/* strb [reg,imm] */
block|, }
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|sljit_mem_simm
specifier|static
name|SLJIT_CONST
name|sljit_ins
name|sljit_mem_simm
index|[
literal|4
index|]
init|=
block|{
comment|/* u l */
literal|0x38400000
comment|/* ldurb [reg,imm] */
block|,
comment|/* u s */
literal|0x38000000
comment|/* sturb [reg,imm] */
block|,
comment|/* s l */
literal|0x38800000
comment|/* ldursb [reg,imm] */
block|,
comment|/* s s */
literal|0x38000000
comment|/* sturb [reg,imm] */
block|, }
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|sljit_mem_pre_simm
specifier|static
name|SLJIT_CONST
name|sljit_ins
name|sljit_mem_pre_simm
index|[
literal|4
index|]
init|=
block|{
comment|/* u l */
literal|0x38400c00
comment|/* ldrb [reg,imm]! */
block|,
comment|/* u s */
literal|0x38000c00
comment|/* strb [reg,imm]! */
block|,
comment|/* s l */
literal|0x38800c00
comment|/* ldrsb [reg,imm]! */
block|,
comment|/* s s */
literal|0x38000c00
comment|/* strb [reg,imm]! */
block|, }
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|sljit_mem_reg
specifier|static
name|SLJIT_CONST
name|sljit_ins
name|sljit_mem_reg
index|[
literal|4
index|]
init|=
block|{
comment|/* u l */
literal|0x38606800
comment|/* ldrb [reg,reg] */
block|,
comment|/* u s */
literal|0x38206800
comment|/* strb [reg,reg] */
block|,
comment|/* s l */
literal|0x38a06800
comment|/* ldrsb [reg,reg] */
block|,
comment|/* s s */
literal|0x38206800
comment|/* strb [reg,reg] */
block|, }
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* Helper function. Dst should be reg + value, using at most 1 instruction, flags does not set. */
end_comment
begin_function
DECL|function|emit_set_delta
specifier|static
name|sljit_si
name|emit_set_delta
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_si
name|reg
parameter_list|,
name|sljit_sw
name|value
parameter_list|)
block|{
if|if
condition|(
name|value
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|value
operator|<=
literal|0xfff
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADDI
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
name|value
operator|<<
literal|10
operator|)
argument_list|)
return|;
if|if
condition|(
name|value
operator|<=
literal|0xffffff
operator|&&
operator|!
operator|(
name|value
operator|&
literal|0xfff
operator|)
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADDI
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
name|value
operator|>>
literal|2
operator|)
argument_list|)
return|;
block|}
else|else
block|{
name|value
operator|=
operator|-
name|value
expr_stmt|;
if|if
condition|(
name|value
operator|<=
literal|0xfff
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SUBI
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
name|value
operator|<<
literal|10
operator|)
argument_list|)
return|;
if|if
condition|(
name|value
operator|<=
literal|0xffffff
operator|&&
operator|!
operator|(
name|value
operator|&
literal|0xfff
operator|)
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SUBI
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|reg
argument_list|)
operator||
operator|(
name|value
operator|>>
literal|2
operator|)
argument_list|)
return|;
block|}
return|return
name|SLJIT_ERR_UNSUPPORTED
return|;
block|}
end_function
begin_comment
comment|/* Can perform an operation using at most 1 instruction. */
end_comment
begin_function
DECL|function|getput_arg_fast
specifier|static
name|sljit_si
name|getput_arg_fast
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|flags
parameter_list|,
name|sljit_si
name|reg
parameter_list|,
name|sljit_si
name|arg
parameter_list|,
name|sljit_sw
name|argw
parameter_list|)
block|{
name|sljit_ui
name|shift
init|=
name|MEM_SIZE_SHIFT
argument_list|(
name|flags
argument_list|)
decl_stmt|;
name|SLJIT_ASSERT
argument_list|(
name|arg
operator|&
name|SLJIT_MEM
argument_list|)
expr_stmt|;
if|if
condition|(
name|SLJIT_UNLIKELY
argument_list|(
name|flags
operator|&
name|UPDATE
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|arg
operator|&
name|REG_MASK
operator|)
operator|&&
operator|!
operator|(
name|arg
operator|&
name|OFFS_REG_MASK
operator|)
operator|&&
name|argw
operator|<=
literal|255
operator|&&
name|argw
operator|>=
operator|-
literal|256
condition|)
block|{
if|if
condition|(
name|SLJIT_UNLIKELY
argument_list|(
name|flags
operator|&
name|ARG_TEST
argument_list|)
condition|)
return|return
literal|1
return|;
name|arg
operator|&=
name|REG_MASK
expr_stmt|;
name|argw
operator|&=
literal|0x1ff
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_pre_simm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
operator|(
name|argw
operator|<<
literal|12
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|SLJIT_UNLIKELY
argument_list|(
name|arg
operator|&
name|OFFS_REG_MASK
argument_list|)
condition|)
block|{
name|argw
operator|&=
literal|0x3
expr_stmt|;
if|if
condition|(
name|argw
operator|&&
name|argw
operator|!=
name|shift
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|SLJIT_UNLIKELY
argument_list|(
name|flags
operator|&
name|ARG_TEST
argument_list|)
condition|)
return|return
literal|1
return|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_reg
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
operator|&
name|REG_MASK
argument_list|)
operator||
name|RM
argument_list|(
name|OFFS_REG
argument_list|(
name|arg
argument_list|)
argument_list|)
operator||
operator|(
name|argw
condition|?
operator|(
literal|1
operator|<<
literal|12
operator|)
else|:
literal|0
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|arg
operator|&=
name|REG_MASK
expr_stmt|;
if|if
condition|(
name|argw
operator|>=
literal|0
operator|&&
operator|(
name|argw
operator|>>
name|shift
operator|)
operator|<=
literal|0xfff
operator|&&
operator|(
name|argw
operator|&
operator|(
operator|(
literal|1
operator|<<
name|shift
operator|)
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|SLJIT_UNLIKELY
argument_list|(
name|flags
operator|&
name|ARG_TEST
argument_list|)
condition|)
return|return
literal|1
return|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_imm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
operator|(
name|argw
operator|<<
operator|(
literal|10
operator|-
name|shift
operator|)
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|argw
operator|>
literal|255
operator|||
name|argw
operator|<
operator|-
literal|256
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|SLJIT_UNLIKELY
argument_list|(
name|flags
operator|&
name|ARG_TEST
argument_list|)
condition|)
return|return
literal|1
return|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_simm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
operator|(
operator|(
name|argw
operator|&
literal|0x1ff
operator|)
operator|<<
literal|12
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function
begin_comment
comment|/* see getput_arg below.    Note: can_cache is called only for binary operators. Those    operators always uses word arguments without write back. */
end_comment
begin_function
DECL|function|can_cache
specifier|static
name|sljit_si
name|can_cache
parameter_list|(
name|sljit_si
name|arg
parameter_list|,
name|sljit_sw
name|argw
parameter_list|,
name|sljit_si
name|next_arg
parameter_list|,
name|sljit_sw
name|next_argw
parameter_list|)
block|{
name|sljit_sw
name|diff
decl_stmt|;
if|if
condition|(
operator|(
name|arg
operator|&
name|OFFS_REG_MASK
operator|)
operator|||
operator|!
operator|(
name|next_arg
operator|&
name|SLJIT_MEM
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|arg
operator|&
name|REG_MASK
operator|)
condition|)
block|{
name|diff
operator|=
name|argw
operator|-
name|next_argw
expr_stmt|;
if|if
condition|(
name|diff
operator|<=
literal|0xfff
operator|&&
name|diff
operator|>=
operator|-
literal|0xfff
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|argw
operator|==
name|next_argw
condition|)
return|return
literal|1
return|;
name|diff
operator|=
name|argw
operator|-
name|next_argw
expr_stmt|;
if|if
condition|(
name|arg
operator|==
name|next_arg
operator|&&
name|diff
operator|<=
literal|0xfff
operator|&&
name|diff
operator|>=
operator|-
literal|0xfff
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function
begin_comment
comment|/* Emit the necessary instructions. See can_cache above. */
end_comment
begin_function
DECL|function|getput_arg
specifier|static
name|sljit_si
name|getput_arg
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|flags
parameter_list|,
name|sljit_si
name|reg
parameter_list|,
name|sljit_si
name|arg
parameter_list|,
name|sljit_sw
name|argw
parameter_list|,
name|sljit_si
name|next_arg
parameter_list|,
name|sljit_sw
name|next_argw
parameter_list|)
block|{
name|sljit_ui
name|shift
init|=
name|MEM_SIZE_SHIFT
argument_list|(
name|flags
argument_list|)
decl_stmt|;
name|sljit_si
name|tmp_r
decl_stmt|,
name|other_r
decl_stmt|;
name|sljit_sw
name|diff
decl_stmt|;
name|SLJIT_ASSERT
argument_list|(
name|arg
operator|&
name|SLJIT_MEM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|next_arg
operator|&
name|SLJIT_MEM
operator|)
condition|)
block|{
name|next_arg
operator|=
literal|0
expr_stmt|;
name|next_argw
operator|=
literal|0
expr_stmt|;
block|}
name|tmp_r
operator|=
operator|(
name|flags
operator|&
name|STORE
operator|)
condition|?
name|TMP_REG3
else|:
name|reg
expr_stmt|;
if|if
condition|(
name|SLJIT_UNLIKELY
argument_list|(
operator|(
name|flags
operator|&
name|UPDATE
operator|)
operator|&&
operator|(
name|arg
operator|&
name|REG_MASK
operator|)
argument_list|)
condition|)
block|{
comment|/* Update only applies if a base register exists. */
name|other_r
operator|=
name|OFFS_REG
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|other_r
condition|)
block|{
name|other_r
operator|=
name|arg
operator|&
name|REG_MASK
expr_stmt|;
if|if
condition|(
name|other_r
operator|!=
name|reg
operator|&&
name|argw
operator|>=
literal|0
operator|&&
name|argw
operator|<=
literal|0xffffff
condition|)
block|{
if|if
condition|(
operator|(
name|argw
operator|&
literal|0xfff
operator|)
operator|!=
literal|0
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADDI
operator||
name|RD
argument_list|(
name|other_r
argument_list|)
operator||
name|RN
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
operator|(
name|argw
operator|&
literal|0xfff
operator|)
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|argw
operator|>>
literal|12
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADDI
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
operator||
name|RD
argument_list|(
name|other_r
argument_list|)
operator||
name|RN
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
operator|(
name|argw
operator|>>
literal|12
operator|)
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_imm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|other_r
argument_list|)
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|other_r
operator|!=
name|reg
operator|&&
name|argw
operator|<
literal|0
operator|&&
name|argw
operator|>=
operator|-
literal|0xffffff
condition|)
block|{
name|argw
operator|=
operator|-
name|argw
expr_stmt|;
if|if
condition|(
operator|(
name|argw
operator|&
literal|0xfff
operator|)
operator|!=
literal|0
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SUBI
operator||
name|RD
argument_list|(
name|other_r
argument_list|)
operator||
name|RN
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
operator|(
name|argw
operator|&
literal|0xfff
operator|)
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|argw
operator|>>
literal|12
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SUBI
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
operator||
name|RD
argument_list|(
name|other_r
argument_list|)
operator||
name|RN
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
operator|(
name|argw
operator|>>
literal|12
operator|)
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_imm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|other_r
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|compiler
operator|->
name|cache_arg
operator|==
name|SLJIT_MEM
condition|)
block|{
if|if
condition|(
name|argw
operator|==
name|compiler
operator|->
name|cache_argw
condition|)
block|{
name|other_r
operator|=
name|TMP_REG3
expr_stmt|;
name|argw
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|emit_set_delta
argument_list|(
name|compiler
argument_list|,
name|TMP_REG3
argument_list|,
name|TMP_REG3
argument_list|,
name|argw
operator|-
name|compiler
operator|->
name|cache_argw
argument_list|)
operator|!=
name|SLJIT_ERR_UNSUPPORTED
condition|)
block|{
name|FAIL_IF
argument_list|(
name|compiler
operator|->
name|error
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
name|argw
expr_stmt|;
name|other_r
operator|=
name|TMP_REG3
expr_stmt|;
name|argw
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|argw
condition|)
block|{
name|FAIL_IF
argument_list|(
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|TMP_REG3
argument_list|,
name|argw
argument_list|)
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_arg
operator|=
name|SLJIT_MEM
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
name|argw
expr_stmt|;
name|other_r
operator|=
name|TMP_REG3
expr_stmt|;
name|argw
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* No caching here. */
name|arg
operator|&=
name|REG_MASK
expr_stmt|;
name|argw
operator|&=
literal|0x3
expr_stmt|;
if|if
condition|(
operator|!
name|argw
operator|||
name|argw
operator|==
name|shift
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_reg
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
name|argw
condition|?
operator|(
literal|1
operator|<<
literal|12
operator|)
else|:
literal|0
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADD
operator||
name|RD
argument_list|(
name|arg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
name|argw
operator|<<
literal|10
operator|)
argument_list|)
return|;
block|}
if|if
condition|(
name|arg
operator|!=
name|reg
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADD
operator||
name|RD
argument_list|(
name|arg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
name|argw
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_imm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
argument_list|)
return|;
block|}
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADD
operator||
name|RD
argument_list|(
name|TMP_REG4
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
name|argw
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_imm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG4
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ORR
operator||
name|RD
argument_list|(
name|arg
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|TMP_REG4
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|arg
operator|&
name|OFFS_REG_MASK
condition|)
block|{
name|other_r
operator|=
name|OFFS_REG
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|arg
operator|&=
name|REG_MASK
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADD
operator||
name|RD
argument_list|(
name|tmp_r
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
operator|(
name|argw
operator|&
literal|0x3
operator|)
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_imm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|tmp_r
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|compiler
operator|->
name|cache_arg
operator|==
name|arg
condition|)
block|{
name|diff
operator|=
name|argw
operator|-
name|compiler
operator|->
name|cache_argw
expr_stmt|;
if|if
condition|(
name|diff
operator|<=
literal|255
operator|&&
name|diff
operator|>=
operator|-
literal|256
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_simm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG3
argument_list|)
operator||
operator|(
operator|(
name|diff
operator|&
literal|0x1ff
operator|)
operator|<<
literal|12
operator|)
argument_list|)
return|;
if|if
condition|(
name|emit_set_delta
argument_list|(
name|compiler
argument_list|,
name|TMP_REG3
argument_list|,
name|TMP_REG3
argument_list|,
name|diff
argument_list|)
operator|!=
name|SLJIT_ERR_UNSUPPORTED
condition|)
block|{
name|FAIL_IF
argument_list|(
name|compiler
operator|->
name|error
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_imm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|argw
operator|>=
literal|0
operator|&&
name|argw
operator|<=
literal|0xffffff
operator|&&
operator|(
name|argw
operator|&
operator|(
operator|(
literal|1
operator|<<
name|shift
operator|)
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADDI
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
operator||
name|RD
argument_list|(
name|tmp_r
argument_list|)
operator||
name|RN
argument_list|(
name|arg
operator|&
name|REG_MASK
argument_list|)
operator||
operator|(
operator|(
name|argw
operator|>>
literal|12
operator|)
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_imm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|tmp_r
argument_list|)
operator||
operator|(
operator|(
name|argw
operator|&
literal|0xfff
operator|)
operator|<<
operator|(
literal|10
operator|-
name|shift
operator|)
operator|)
argument_list|)
return|;
block|}
name|diff
operator|=
name|argw
operator|-
name|next_argw
expr_stmt|;
name|next_arg
operator|=
operator|(
name|arg
operator|&
name|REG_MASK
operator|)
operator|&&
operator|(
name|arg
operator|==
name|next_arg
operator|)
operator|&&
name|diff
operator|<=
literal|0xfff
operator|&&
name|diff
operator|>=
operator|-
literal|0xfff
operator|&&
name|diff
operator|!=
literal|0
expr_stmt|;
name|arg
operator|&=
name|REG_MASK
expr_stmt|;
if|if
condition|(
name|arg
operator|&&
name|compiler
operator|->
name|cache_arg
operator|==
name|SLJIT_MEM
condition|)
block|{
if|if
condition|(
name|compiler
operator|->
name|cache_argw
operator|==
name|argw
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_reg
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|TMP_REG3
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|emit_set_delta
argument_list|(
name|compiler
argument_list|,
name|TMP_REG3
argument_list|,
name|TMP_REG3
argument_list|,
name|argw
operator|-
name|compiler
operator|->
name|cache_argw
argument_list|)
operator|!=
name|SLJIT_ERR_UNSUPPORTED
condition|)
block|{
name|FAIL_IF
argument_list|(
name|compiler
operator|->
name|error
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
name|argw
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_reg
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|TMP_REG3
argument_list|)
argument_list|)
return|;
block|}
block|}
name|compiler
operator|->
name|cache_argw
operator|=
name|argw
expr_stmt|;
if|if
condition|(
name|next_arg
operator|&&
name|emit_set_delta
argument_list|(
name|compiler
argument_list|,
name|TMP_REG3
argument_list|,
name|arg
argument_list|,
name|argw
argument_list|)
operator|!=
name|SLJIT_ERR_UNSUPPORTED
condition|)
block|{
name|FAIL_IF
argument_list|(
name|compiler
operator|->
name|error
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_arg
operator|=
name|SLJIT_MEM
operator||
name|arg
expr_stmt|;
name|arg
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|FAIL_IF
argument_list|(
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|TMP_REG3
argument_list|,
name|argw
argument_list|)
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_arg
operator|=
name|SLJIT_MEM
expr_stmt|;
if|if
condition|(
name|next_arg
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADD
operator||
name|RD
argument_list|(
name|TMP_REG3
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG3
argument_list|)
operator||
name|RM
argument_list|(
name|arg
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_arg
operator|=
name|SLJIT_MEM
operator||
name|arg
expr_stmt|;
name|arg
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|arg
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_reg
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|TMP_REG3
argument_list|)
argument_list|)
return|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|sljit_mem_imm
index|[
name|flags
operator|&
literal|0x3
index|]
operator||
operator|(
name|shift
operator|<<
literal|30
operator|)
operator||
name|RT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG3
argument_list|)
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|emit_op_mem
specifier|static
name|SLJIT_INLINE
name|sljit_si
name|emit_op_mem
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|flags
parameter_list|,
name|sljit_si
name|reg
parameter_list|,
name|sljit_si
name|arg
parameter_list|,
name|sljit_sw
name|argw
parameter_list|)
block|{
if|if
condition|(
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|flags
argument_list|,
name|reg
argument_list|,
name|arg
argument_list|,
name|argw
argument_list|)
condition|)
return|return
name|compiler
operator|->
name|error
return|;
name|compiler
operator|->
name|cache_arg
operator|=
literal|0
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
literal|0
expr_stmt|;
return|return
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|flags
argument_list|,
name|reg
argument_list|,
name|arg
argument_list|,
name|argw
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|emit_op_mem2
specifier|static
name|SLJIT_INLINE
name|sljit_si
name|emit_op_mem2
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|flags
parameter_list|,
name|sljit_si
name|reg
parameter_list|,
name|sljit_si
name|arg1
parameter_list|,
name|sljit_sw
name|arg1w
parameter_list|,
name|sljit_si
name|arg2
parameter_list|,
name|sljit_sw
name|arg2w
parameter_list|)
block|{
if|if
condition|(
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|flags
argument_list|,
name|reg
argument_list|,
name|arg1
argument_list|,
name|arg1w
argument_list|)
condition|)
return|return
name|compiler
operator|->
name|error
return|;
return|return
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|flags
argument_list|,
name|reg
argument_list|,
name|arg1
argument_list|,
name|arg1w
argument_list|,
name|arg2
argument_list|,
name|arg2w
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_comment
comment|/*  Entry, exit                                                          */
end_comment
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_function
DECL|function|sljit_emit_enter
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_enter
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|args
parameter_list|,
name|sljit_si
name|scratches
parameter_list|,
name|sljit_si
name|saveds
parameter_list|,
name|sljit_si
name|local_size
parameter_list|)
block|{
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_enter
argument_list|(
name|compiler
argument_list|,
name|args
argument_list|,
name|scratches
argument_list|,
name|saveds
argument_list|,
name|local_size
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|scratches
operator|=
name|scratches
expr_stmt|;
name|compiler
operator|->
name|saveds
operator|=
name|saveds
expr_stmt|;
if|#
directive|if
operator|(
name|defined
name|SLJIT_DEBUG
operator|&&
name|SLJIT_DEBUG
operator|)
name|compiler
operator|->
name|logical_local_size
operator|=
name|local_size
expr_stmt|;
endif|#
directive|endif
name|compiler
operator|->
name|locals_offset
operator|=
operator|(
literal|2
operator|+
name|saveds
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|sljit_sw
argument_list|)
expr_stmt|;
name|local_size
operator|=
operator|(
name|compiler
operator|->
name|locals_offset
operator|+
name|local_size
operator|+
literal|15
operator|)
operator|&
operator|~
literal|15
expr_stmt|;
name|compiler
operator|->
name|local_size
operator|=
name|local_size
expr_stmt|;
if|if
condition|(
name|local_size
operator|<=
operator|(
literal|64
operator|<<
literal|3
operator|)
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STP_PRE
operator||
literal|29
operator||
name|RT2
argument_list|(
name|TMP_LR
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
operator|(
operator|-
operator|(
name|local_size
operator|>>
literal|3
operator|)
operator|&
literal|0x7f
operator|)
operator|<<
literal|15
operator|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|local_size
operator|-=
operator|(
literal|64
operator|<<
literal|3
operator|)
expr_stmt|;
if|if
condition|(
name|local_size
operator|>
literal|0xfff
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SUBI
operator||
name|RD
argument_list|(
name|TMP_SP
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
operator|(
name|local_size
operator|>>
literal|12
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|local_size
operator|&=
literal|0xfff
expr_stmt|;
block|}
if|if
condition|(
name|local_size
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|SUBI
operator||
name|RD
argument_list|(
name|TMP_SP
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
name|local_size
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STP_PRE
operator||
literal|29
operator||
name|RT2
argument_list|(
name|TMP_LR
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|0x40
operator|<<
literal|15
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADDI
operator||
name|RD
argument_list|(
name|SLJIT_LOCALS_REG
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saveds
operator|>=
literal|2
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STP
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_REG1
argument_list|)
operator||
name|RT2
argument_list|(
name|SLJIT_SAVED_REG2
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|2
operator|<<
literal|15
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saveds
operator|>=
literal|4
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STP
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_REG3
argument_list|)
operator||
name|RT2
argument_list|(
name|SLJIT_SAVED_EREG1
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|4
operator|<<
literal|15
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saveds
operator|==
literal|1
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STRI
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_REG1
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|2
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saveds
operator|==
literal|3
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STRI
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_REG3
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|4
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saveds
operator|==
literal|5
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STRI
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_EREG2
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|6
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|>=
literal|1
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ORR
operator||
name|RD
argument_list|(
name|SLJIT_SAVED_REG1
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|>=
literal|2
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ORR
operator||
name|RD
argument_list|(
name|SLJIT_SAVED_REG2
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|>=
literal|3
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ORR
operator||
name|RD
argument_list|(
name|SLJIT_SAVED_REG3
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG3
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SLJIT_SUCCESS
return|;
block|}
end_function
begin_function
DECL|function|sljit_set_context
name|SLJIT_API_FUNC_ATTRIBUTE
name|void
name|sljit_set_context
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|args
parameter_list|,
name|sljit_si
name|scratches
parameter_list|,
name|sljit_si
name|saveds
parameter_list|,
name|sljit_si
name|local_size
parameter_list|)
block|{
name|CHECK_ERROR_VOID
argument_list|()
expr_stmt|;
name|check_sljit_set_context
argument_list|(
name|compiler
argument_list|,
name|args
argument_list|,
name|scratches
argument_list|,
name|saveds
argument_list|,
name|local_size
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|scratches
operator|=
name|scratches
expr_stmt|;
name|compiler
operator|->
name|saveds
operator|=
name|saveds
expr_stmt|;
if|#
directive|if
operator|(
name|defined
name|SLJIT_DEBUG
operator|&&
name|SLJIT_DEBUG
operator|)
name|compiler
operator|->
name|logical_local_size
operator|=
name|local_size
expr_stmt|;
endif|#
directive|endif
name|compiler
operator|->
name|locals_offset
operator|=
operator|(
literal|2
operator|+
name|saveds
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|sljit_sw
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|local_size
operator|=
operator|(
name|compiler
operator|->
name|locals_offset
operator|+
name|local_size
operator|+
literal|15
operator|)
operator|&
operator|~
literal|15
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sljit_emit_return
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_return
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|op
parameter_list|,
name|sljit_si
name|src
parameter_list|,
name|sljit_sw
name|srcw
parameter_list|)
block|{
name|sljit_si
name|saveds
decl_stmt|,
name|local_size
decl_stmt|;
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_return
argument_list|(
name|compiler
argument_list|,
name|op
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|emit_mov_before_return
argument_list|(
name|compiler
argument_list|,
name|op
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
argument_list|)
expr_stmt|;
name|saveds
operator|=
name|compiler
operator|->
name|saveds
expr_stmt|;
if|if
condition|(
name|saveds
operator|>=
literal|2
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|LDP
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_REG1
argument_list|)
operator||
name|RT2
argument_list|(
name|SLJIT_SAVED_REG2
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|2
operator|<<
literal|15
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saveds
operator|>=
literal|4
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|LDP
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_REG3
argument_list|)
operator||
name|RT2
argument_list|(
name|SLJIT_SAVED_EREG1
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|4
operator|<<
literal|15
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saveds
operator|==
literal|1
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|LDRI
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_REG1
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|2
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saveds
operator|==
literal|3
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|LDRI
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_REG3
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|4
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saveds
operator|==
literal|5
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|LDRI
operator||
name|RT
argument_list|(
name|SLJIT_SAVED_EREG2
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|6
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|local_size
operator|=
name|compiler
operator|->
name|local_size
expr_stmt|;
if|if
condition|(
name|local_size
operator|<=
operator|(
literal|62
operator|<<
literal|3
operator|)
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|LDP_PST
operator||
literal|29
operator||
name|RT2
argument_list|(
name|TMP_LR
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
operator|(
operator|(
name|local_size
operator|>>
literal|3
operator|)
operator|&
literal|0x7f
operator|)
operator|<<
literal|15
operator|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|LDP_PST
operator||
literal|29
operator||
name|RT2
argument_list|(
name|TMP_LR
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
literal|0x3e
operator|<<
literal|15
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|local_size
operator|-=
operator|(
literal|62
operator|<<
literal|3
operator|)
expr_stmt|;
if|if
condition|(
name|local_size
operator|>
literal|0xfff
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADDI
operator||
name|RD
argument_list|(
name|TMP_SP
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
operator|(
name|local_size
operator|>>
literal|12
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|local_size
operator|&=
literal|0xfff
expr_stmt|;
block|}
if|if
condition|(
name|local_size
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADDI
operator||
name|RD
argument_list|(
name|TMP_SP
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_SP
argument_list|)
operator||
operator|(
name|local_size
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|RET
operator||
name|RN
argument_list|(
name|TMP_LR
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SLJIT_SUCCESS
return|;
block|}
end_function
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_comment
comment|/*  Operators                                                            */
end_comment
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_function
DECL|function|sljit_emit_op0
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_op0
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|op
parameter_list|)
block|{
name|sljit_ins
name|inv_bits
init|=
operator|(
name|op
operator|&
name|SLJIT_INT_OP
operator|)
condition|?
operator|(
literal|1
operator|<<
literal|31
operator|)
else|:
literal|0
decl_stmt|;
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_op0
argument_list|(
name|compiler
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|op
operator|=
name|GET_OPCODE
argument_list|(
name|op
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SLJIT_BREAKPOINT
case|:
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|BRK
argument_list|)
return|;
case|case
name|SLJIT_NOP
case|:
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|NOP
argument_list|)
return|;
case|case
name|SLJIT_UMUL
case|:
case|case
name|SLJIT_SMUL
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ORR
operator||
name|RD
argument_list|(
name|TMP_REG1
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|MADD
operator||
name|RD
argument_list|(
name|SLJIT_SCRATCH_REG1
argument_list|)
operator||
name|RN
argument_list|(
name|SLJIT_SCRATCH_REG1
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG2
argument_list|)
operator||
name|RT2
argument_list|(
name|TMP_ZERO
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|op
operator|==
name|SLJIT_SMUL
condition|?
name|SMULH
else|:
name|UMULH
operator|)
operator||
name|RD
argument_list|(
name|SLJIT_SCRATCH_REG2
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG1
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG2
argument_list|)
argument_list|)
return|;
case|case
name|SLJIT_UDIV
case|:
case|case
name|SLJIT_SDIV
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|ORR
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|TMP_REG1
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
operator|(
name|op
operator|==
name|SLJIT_SDIV
condition|?
name|SDIV
else|:
name|UDIV
operator|)
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|SLJIT_SCRATCH_REG1
argument_list|)
operator||
name|RN
argument_list|(
name|SLJIT_SCRATCH_REG1
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|MADD
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|SLJIT_SCRATCH_REG2
argument_list|)
operator||
name|RN
argument_list|(
name|SLJIT_SCRATCH_REG1
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG2
argument_list|)
operator||
name|RT2
argument_list|(
name|TMP_ZERO
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|SUB
operator|^
name|inv_bits
operator|)
operator||
name|RD
argument_list|(
name|SLJIT_SCRATCH_REG2
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG1
argument_list|)
operator||
name|RM
argument_list|(
name|SLJIT_SCRATCH_REG2
argument_list|)
argument_list|)
return|;
block|}
return|return
name|SLJIT_SUCCESS
return|;
block|}
end_function
begin_function
DECL|function|sljit_emit_op1
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_op1
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|op
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_sw
name|dstw
parameter_list|,
name|sljit_si
name|src
parameter_list|,
name|sljit_sw
name|srcw
parameter_list|)
block|{
name|sljit_si
name|dst_r
decl_stmt|,
name|flags
decl_stmt|,
name|mem_flags
decl_stmt|;
name|sljit_si
name|op_flags
init|=
name|GET_ALL_FLAGS
argument_list|(
name|op
argument_list|)
decl_stmt|;
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_op1
argument_list|(
name|compiler
argument_list|,
name|op
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|dst
argument_list|,
name|dstw
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_arg
operator|=
literal|0
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
literal|0
expr_stmt|;
name|dst_r
operator|=
name|SLOW_IS_REG
argument_list|(
name|dst
argument_list|)
condition|?
name|dst
else|:
name|TMP_REG1
expr_stmt|;
name|op
operator|=
name|GET_OPCODE
argument_list|(
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|>=
name|SLJIT_MOV
operator|&&
name|op
operator|<=
name|SLJIT_MOVU_P
condition|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SLJIT_MOV
case|:
case|case
name|SLJIT_MOV_P
case|:
name|flags
operator|=
name|WORD_SIZE
expr_stmt|;
break|break;
case|case
name|SLJIT_MOV_UB
case|:
name|flags
operator|=
name|BYTE_SIZE
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_ub
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOV_SB
case|:
name|flags
operator|=
name|BYTE_SIZE
operator||
name|SIGNED
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_sb
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOV_UH
case|:
name|flags
operator|=
name|HALF_SIZE
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_uh
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOV_SH
case|:
name|flags
operator|=
name|HALF_SIZE
operator||
name|SIGNED
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_sh
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOV_UI
case|:
name|flags
operator|=
name|INT_SIZE
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_ui
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOV_SI
case|:
name|flags
operator|=
name|INT_SIZE
operator||
name|SIGNED
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_si
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOVU
case|:
case|case
name|SLJIT_MOVU_P
case|:
name|flags
operator|=
name|WORD_SIZE
operator||
name|UPDATE
expr_stmt|;
break|break;
case|case
name|SLJIT_MOVU_UB
case|:
name|flags
operator|=
name|BYTE_SIZE
operator||
name|UPDATE
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_ub
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOVU_SB
case|:
name|flags
operator|=
name|BYTE_SIZE
operator||
name|SIGNED
operator||
name|UPDATE
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_sb
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOVU_UH
case|:
name|flags
operator|=
name|HALF_SIZE
operator||
name|UPDATE
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_uh
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOVU_SH
case|:
name|flags
operator|=
name|HALF_SIZE
operator||
name|SIGNED
operator||
name|UPDATE
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_sh
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOVU_UI
case|:
name|flags
operator|=
name|INT_SIZE
operator||
name|UPDATE
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_ui
operator|)
name|srcw
expr_stmt|;
break|break;
case|case
name|SLJIT_MOVU_SI
case|:
name|flags
operator|=
name|INT_SIZE
operator||
name|SIGNED
operator||
name|UPDATE
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|srcw
operator|=
operator|(
name|sljit_si
operator|)
name|srcw
expr_stmt|;
break|break;
default|default:
name|SLJIT_ASSERT_STOP
argument_list|()
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|FAIL_IF
argument_list|(
name|emit_op_imm
argument_list|(
name|compiler
argument_list|,
name|SLJIT_MOV
operator||
name|ARG2_IMM
argument_list|,
name|dst_r
argument_list|,
name|TMP_REG1
argument_list|,
name|srcw
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|src
operator|&
name|SLJIT_MEM
condition|)
block|{
if|if
condition|(
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|flags
argument_list|,
name|dst_r
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
condition|)
name|FAIL_IF
argument_list|(
name|compiler
operator|->
name|error
argument_list|)
expr_stmt|;
else|else
name|FAIL_IF
argument_list|(
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|flags
argument_list|,
name|dst_r
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dst_r
operator|!=
name|TMP_REG1
condition|)
return|return
name|emit_op_imm
argument_list|(
name|compiler
argument_list|,
name|op
operator||
operator|(
operator|(
name|op_flags
operator|&
name|SLJIT_INT_OP
operator|)
condition|?
name|INT_OP
else|:
literal|0
operator|)
argument_list|,
name|dst_r
argument_list|,
name|TMP_REG1
argument_list|,
name|src
argument_list|)
return|;
name|dst_r
operator|=
name|src
expr_stmt|;
block|}
if|if
condition|(
name|dst
operator|&
name|SLJIT_MEM
condition|)
block|{
if|if
condition|(
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|flags
operator||
name|STORE
argument_list|,
name|dst_r
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
condition|)
return|return
name|compiler
operator|->
name|error
return|;
else|else
return|return
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|flags
operator||
name|STORE
argument_list|,
name|dst_r
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
return|return
name|SLJIT_SUCCESS
return|;
block|}
name|flags
operator|=
name|GET_FLAGS
argument_list|(
name|op_flags
argument_list|)
condition|?
name|SET_FLAGS
else|:
literal|0
expr_stmt|;
name|mem_flags
operator|=
name|WORD_SIZE
expr_stmt|;
if|if
condition|(
name|op_flags
operator|&
name|SLJIT_INT_OP
condition|)
block|{
name|flags
operator||=
name|INT_OP
expr_stmt|;
name|mem_flags
operator|=
name|INT_SIZE
expr_stmt|;
block|}
if|if
condition|(
name|dst
operator|==
name|SLJIT_UNUSED
condition|)
name|flags
operator||=
name|UNUSED_RETURN
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_MEM
condition|)
block|{
if|if
condition|(
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG2
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
condition|)
name|FAIL_IF
argument_list|(
name|compiler
operator|->
name|error
argument_list|)
expr_stmt|;
else|else
name|FAIL_IF
argument_list|(
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG2
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
argument_list|)
expr_stmt|;
name|src
operator|=
name|TMP_REG2
expr_stmt|;
block|}
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
block|{
name|flags
operator||=
name|ARG2_IMM
expr_stmt|;
if|if
condition|(
name|op_flags
operator|&
name|SLJIT_INT_OP
condition|)
name|srcw
operator|=
operator|(
name|sljit_si
operator|)
name|srcw
expr_stmt|;
block|}
else|else
name|srcw
operator|=
name|src
expr_stmt|;
name|emit_op_imm
argument_list|(
name|compiler
argument_list|,
name|flags
operator||
name|op
argument_list|,
name|dst_r
argument_list|,
name|TMP_REG1
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|&
name|SLJIT_MEM
condition|)
block|{
if|if
condition|(
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|mem_flags
operator||
name|STORE
argument_list|,
name|dst_r
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
condition|)
return|return
name|compiler
operator|->
name|error
return|;
else|else
return|return
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|mem_flags
operator||
name|STORE
argument_list|,
name|dst_r
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
return|return
name|SLJIT_SUCCESS
return|;
block|}
end_function
begin_function
DECL|function|sljit_emit_op2
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_op2
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|op
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_sw
name|dstw
parameter_list|,
name|sljit_si
name|src1
parameter_list|,
name|sljit_sw
name|src1w
parameter_list|,
name|sljit_si
name|src2
parameter_list|,
name|sljit_sw
name|src2w
parameter_list|)
block|{
name|sljit_si
name|dst_r
decl_stmt|,
name|flags
decl_stmt|,
name|mem_flags
decl_stmt|;
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_op2
argument_list|(
name|compiler
argument_list|,
name|op
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
name|src1
argument_list|,
name|src1w
argument_list|,
name|src2
argument_list|,
name|src2w
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|dst
argument_list|,
name|dstw
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|src1
argument_list|,
name|src1w
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|src2
argument_list|,
name|src2w
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_arg
operator|=
literal|0
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
literal|0
expr_stmt|;
name|dst_r
operator|=
name|SLOW_IS_REG
argument_list|(
name|dst
argument_list|)
condition|?
name|dst
else|:
name|TMP_REG1
expr_stmt|;
name|flags
operator|=
name|GET_FLAGS
argument_list|(
name|op
argument_list|)
condition|?
name|SET_FLAGS
else|:
literal|0
expr_stmt|;
name|mem_flags
operator|=
name|WORD_SIZE
expr_stmt|;
if|if
condition|(
name|op
operator|&
name|SLJIT_INT_OP
condition|)
block|{
name|flags
operator||=
name|INT_OP
expr_stmt|;
name|mem_flags
operator|=
name|INT_SIZE
expr_stmt|;
block|}
if|if
condition|(
name|dst
operator|==
name|SLJIT_UNUSED
condition|)
name|flags
operator||=
name|UNUSED_RETURN
expr_stmt|;
if|if
condition|(
operator|(
name|dst
operator|&
name|SLJIT_MEM
operator|)
operator|&&
operator|!
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|mem_flags
operator||
name|STORE
operator||
name|ARG_TEST
argument_list|,
name|TMP_REG1
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
condition|)
name|flags
operator||=
name|SLOW_DEST
expr_stmt|;
if|if
condition|(
name|src1
operator|&
name|SLJIT_MEM
condition|)
block|{
if|if
condition|(
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG1
argument_list|,
name|src1
argument_list|,
name|src1w
argument_list|)
condition|)
name|FAIL_IF
argument_list|(
name|compiler
operator|->
name|error
argument_list|)
expr_stmt|;
else|else
name|flags
operator||=
name|SLOW_SRC1
expr_stmt|;
block|}
if|if
condition|(
name|src2
operator|&
name|SLJIT_MEM
condition|)
block|{
if|if
condition|(
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG2
argument_list|,
name|src2
argument_list|,
name|src2w
argument_list|)
condition|)
name|FAIL_IF
argument_list|(
name|compiler
operator|->
name|error
argument_list|)
expr_stmt|;
else|else
name|flags
operator||=
name|SLOW_SRC2
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|flags
operator|&
operator|(
name|SLOW_SRC1
operator||
name|SLOW_SRC2
operator|)
operator|)
operator|==
operator|(
name|SLOW_SRC1
operator||
name|SLOW_SRC2
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|can_cache
argument_list|(
name|src1
argument_list|,
name|src1w
argument_list|,
name|src2
argument_list|,
name|src2w
argument_list|)
operator|&&
name|can_cache
argument_list|(
name|src1
argument_list|,
name|src1w
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
condition|)
block|{
name|FAIL_IF
argument_list|(
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG2
argument_list|,
name|src2
argument_list|,
name|src2w
argument_list|,
name|src1
argument_list|,
name|src1w
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG1
argument_list|,
name|src1
argument_list|,
name|src1w
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|FAIL_IF
argument_list|(
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG1
argument_list|,
name|src1
argument_list|,
name|src1w
argument_list|,
name|src2
argument_list|,
name|src2w
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG2
argument_list|,
name|src2
argument_list|,
name|src2w
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|SLOW_SRC1
condition|)
name|FAIL_IF
argument_list|(
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG1
argument_list|,
name|src1
argument_list|,
name|src1w
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|SLOW_SRC2
condition|)
name|FAIL_IF
argument_list|(
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG2
argument_list|,
name|src2
argument_list|,
name|src2w
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|src1
operator|&
name|SLJIT_MEM
condition|)
name|src1
operator|=
name|TMP_REG1
expr_stmt|;
if|if
condition|(
name|src2
operator|&
name|SLJIT_MEM
condition|)
name|src2
operator|=
name|TMP_REG2
expr_stmt|;
if|if
condition|(
name|src1
operator|&
name|SLJIT_IMM
condition|)
name|flags
operator||=
name|ARG1_IMM
expr_stmt|;
else|else
name|src1w
operator|=
name|src1
expr_stmt|;
if|if
condition|(
name|src2
operator|&
name|SLJIT_IMM
condition|)
name|flags
operator||=
name|ARG2_IMM
expr_stmt|;
else|else
name|src2w
operator|=
name|src2
expr_stmt|;
name|emit_op_imm
argument_list|(
name|compiler
argument_list|,
name|flags
operator||
name|GET_OPCODE
argument_list|(
name|op
argument_list|)
argument_list|,
name|dst_r
argument_list|,
name|src1w
argument_list|,
name|src2w
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|&
name|SLJIT_MEM
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|SLOW_DEST
operator|)
condition|)
block|{
name|getput_arg_fast
argument_list|(
name|compiler
argument_list|,
name|mem_flags
operator||
name|STORE
argument_list|,
name|dst_r
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
expr_stmt|;
return|return
name|compiler
operator|->
name|error
return|;
block|}
return|return
name|getput_arg
argument_list|(
name|compiler
argument_list|,
name|mem_flags
operator||
name|STORE
argument_list|,
name|TMP_REG1
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
return|return
name|SLJIT_SUCCESS
return|;
block|}
end_function
begin_function
DECL|function|sljit_get_register_index
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_get_register_index
parameter_list|(
name|sljit_si
name|reg
parameter_list|)
block|{
name|check_sljit_get_register_index
argument_list|(
name|reg
argument_list|)
expr_stmt|;
return|return
name|reg_map
index|[
name|reg
index|]
return|;
block|}
end_function
begin_function
DECL|function|sljit_get_float_register_index
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_get_float_register_index
parameter_list|(
name|sljit_si
name|reg
parameter_list|)
block|{
name|check_sljit_get_float_register_index
argument_list|(
name|reg
argument_list|)
expr_stmt|;
return|return
name|reg
return|;
block|}
end_function
begin_function
DECL|function|sljit_emit_op_custom
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_op_custom
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|void
modifier|*
name|instruction
parameter_list|,
name|sljit_si
name|size
parameter_list|)
block|{
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_op_custom
argument_list|(
name|compiler
argument_list|,
name|instruction
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|SLJIT_ASSERT
argument_list|(
name|size
operator|==
literal|4
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|*
operator|(
name|sljit_ins
operator|*
operator|)
name|instruction
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_comment
comment|/*  Floating point operators                                             */
end_comment
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_function
DECL|function|sljit_is_fpu_available
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_is_fpu_available
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SLJIT_IS_FPU_AVAILABLE
return|return
name|SLJIT_IS_FPU_AVAILABLE
return|;
else|#
directive|else
comment|/* Available by default. */
return|return
literal|1
return|;
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|emit_fop_mem
specifier|static
name|sljit_si
name|emit_fop_mem
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|flags
parameter_list|,
name|sljit_si
name|reg
parameter_list|,
name|sljit_si
name|arg
parameter_list|,
name|sljit_sw
name|argw
parameter_list|)
block|{
name|sljit_ui
name|shift
init|=
name|MEM_SIZE_SHIFT
argument_list|(
name|flags
argument_list|)
decl_stmt|;
name|sljit_ins
name|ins_bits
init|=
operator|(
name|shift
operator|<<
literal|30
operator|)
decl_stmt|;
name|sljit_si
name|other_r
decl_stmt|;
name|sljit_sw
name|diff
decl_stmt|;
name|SLJIT_ASSERT
argument_list|(
name|arg
operator|&
name|SLJIT_MEM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|STORE
operator|)
condition|)
name|ins_bits
operator||=
literal|1
operator|<<
literal|22
expr_stmt|;
if|if
condition|(
name|arg
operator|&
name|OFFS_REG_MASK
condition|)
block|{
name|argw
operator|&=
literal|3
expr_stmt|;
if|if
condition|(
operator|!
name|argw
operator|||
name|argw
operator|==
name|shift
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STR_FR
operator||
name|ins_bits
operator||
name|VT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
operator|&
name|REG_MASK
argument_list|)
operator||
name|RM
argument_list|(
name|OFFS_REG
argument_list|(
name|arg
argument_list|)
argument_list|)
operator||
operator|(
name|argw
condition|?
operator|(
literal|1
operator|<<
literal|12
operator|)
else|:
literal|0
operator|)
argument_list|)
return|;
name|other_r
operator|=
name|OFFS_REG
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|arg
operator|&=
name|REG_MASK
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ADD
operator||
name|RD
argument_list|(
name|TMP_REG1
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|other_r
argument_list|)
operator||
operator|(
name|argw
operator|<<
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|arg
operator|=
name|TMP_REG1
expr_stmt|;
name|argw
operator|=
literal|0
expr_stmt|;
block|}
name|arg
operator|&=
name|REG_MASK
expr_stmt|;
if|if
condition|(
name|arg
operator|&&
name|argw
operator|>=
literal|0
operator|&&
operator|(
operator|(
name|argw
operator|>>
name|shift
operator|)
operator|<=
literal|0xfff
operator|)
operator|&&
operator|(
name|argw
operator|&
operator|(
operator|(
literal|1
operator|<<
name|shift
operator|)
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STR_FI
operator||
name|ins_bits
operator||
name|VT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
operator|(
name|argw
operator|<<
operator|(
literal|10
operator|-
name|shift
operator|)
operator|)
argument_list|)
return|;
if|if
condition|(
name|arg
operator|&&
name|argw
operator|<=
literal|255
operator|&&
name|argw
operator|>=
operator|-
literal|256
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STUR_FI
operator||
name|ins_bits
operator||
name|VT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
operator|(
operator|(
name|argw
operator|&
literal|0x1ff
operator|)
operator|<<
literal|12
operator|)
argument_list|)
return|;
comment|/* Slow cases */
if|if
condition|(
name|compiler
operator|->
name|cache_arg
operator|==
name|SLJIT_MEM
operator|&&
name|argw
operator|!=
name|compiler
operator|->
name|cache_argw
condition|)
block|{
name|diff
operator|=
name|argw
operator|-
name|compiler
operator|->
name|cache_argw
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|&&
name|diff
operator|<=
literal|255
operator|&&
name|diff
operator|>=
operator|-
literal|256
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STUR_FI
operator||
name|ins_bits
operator||
name|VT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG3
argument_list|)
operator||
operator|(
operator|(
name|diff
operator|&
literal|0x1ff
operator|)
operator|<<
literal|12
operator|)
argument_list|)
return|;
if|if
condition|(
name|emit_set_delta
argument_list|(
name|compiler
argument_list|,
name|TMP_REG3
argument_list|,
name|TMP_REG3
argument_list|,
name|argw
operator|-
name|compiler
operator|->
name|cache_argw
argument_list|)
operator|!=
name|SLJIT_ERR_UNSUPPORTED
condition|)
block|{
name|FAIL_IF
argument_list|(
name|compiler
operator|->
name|error
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
name|argw
expr_stmt|;
block|}
block|}
if|if
condition|(
name|compiler
operator|->
name|cache_arg
operator|!=
name|SLJIT_MEM
operator|||
name|argw
operator|!=
name|compiler
operator|->
name|cache_argw
condition|)
block|{
name|compiler
operator|->
name|cache_arg
operator|=
name|SLJIT_MEM
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
name|argw
expr_stmt|;
name|FAIL_IF
argument_list|(
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|TMP_REG3
argument_list|,
name|argw
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|arg
operator|&
name|REG_MASK
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STR_FR
operator||
name|ins_bits
operator||
name|VT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|arg
argument_list|)
operator||
name|RM
argument_list|(
name|TMP_REG3
argument_list|)
argument_list|)
return|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|STR_FI
operator||
name|ins_bits
operator||
name|VT
argument_list|(
name|reg
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_REG3
argument_list|)
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|sljit_emit_fop1
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_fop1
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|op
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_sw
name|dstw
parameter_list|,
name|sljit_si
name|src
parameter_list|,
name|sljit_sw
name|srcw
parameter_list|)
block|{
name|sljit_si
name|dst_r
decl_stmt|,
name|mem_flags
init|=
operator|(
name|op
operator|&
name|SLJIT_SINGLE_OP
operator|)
condition|?
name|INT_SIZE
else|:
name|WORD_SIZE
decl_stmt|;
name|sljit_ins
name|inv_bits
init|=
operator|(
name|op
operator|&
name|SLJIT_SINGLE_OP
operator|)
condition|?
operator|(
literal|1
operator|<<
literal|22
operator|)
else|:
literal|0
decl_stmt|;
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_fop1
argument_list|(
name|compiler
argument_list|,
name|op
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_arg
operator|=
literal|0
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|GET_OPCODE
argument_list|(
name|op
argument_list|)
operator|==
name|SLJIT_CMPD
condition|)
block|{
if|if
condition|(
name|dst
operator|&
name|SLJIT_MEM
condition|)
block|{
name|emit_fop_mem
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_FREG1
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
expr_stmt|;
name|dst
operator|=
name|TMP_FREG1
expr_stmt|;
block|}
if|if
condition|(
name|src
operator|&
name|SLJIT_MEM
condition|)
block|{
name|emit_fop_mem
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_FREG2
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
name|src
operator|=
name|TMP_FREG2
expr_stmt|;
block|}
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|FCMP
operator|^
name|inv_bits
operator|)
operator||
name|VN
argument_list|(
name|dst
argument_list|)
operator||
name|VM
argument_list|(
name|src
argument_list|)
argument_list|)
return|;
block|}
name|dst_r
operator|=
operator|(
name|dst
operator|<=
name|REG_MASK
operator|)
condition|?
name|dst
else|:
name|TMP_FREG1
expr_stmt|;
if|if
condition|(
name|src
operator|&
name|SLJIT_MEM
condition|)
block|{
name|emit_fop_mem
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|dst_r
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
name|src
operator|=
name|dst_r
expr_stmt|;
block|}
switch|switch
condition|(
name|GET_OPCODE
argument_list|(
name|op
argument_list|)
condition|)
block|{
case|case
name|SLJIT_MOVD
case|:
if|if
condition|(
name|src
operator|!=
name|dst_r
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|FMOV
operator|^
name|inv_bits
operator|)
operator||
name|VD
argument_list|(
name|dst_r
argument_list|)
operator||
name|VN
argument_list|(
name|src
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SLJIT_NEGD
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|FNEG
operator|^
name|inv_bits
operator|)
operator||
name|VD
argument_list|(
name|dst_r
argument_list|)
operator||
name|VN
argument_list|(
name|src
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SLJIT_ABSD
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|FABS
operator|^
name|inv_bits
operator|)
operator||
name|VD
argument_list|(
name|dst_r
argument_list|)
operator||
name|VN
argument_list|(
name|src
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|dst
operator|&
name|SLJIT_MEM
operator|)
condition|)
return|return
name|SLJIT_SUCCESS
return|;
return|return
name|emit_fop_mem
argument_list|(
name|compiler
argument_list|,
name|mem_flags
operator||
name|STORE
argument_list|,
name|TMP_FREG1
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|sljit_emit_fop2
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_fop2
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|op
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_sw
name|dstw
parameter_list|,
name|sljit_si
name|src1
parameter_list|,
name|sljit_sw
name|src1w
parameter_list|,
name|sljit_si
name|src2
parameter_list|,
name|sljit_sw
name|src2w
parameter_list|)
block|{
name|sljit_si
name|dst_r
decl_stmt|,
name|mem_flags
init|=
operator|(
name|op
operator|&
name|SLJIT_SINGLE_OP
operator|)
condition|?
name|INT_SIZE
else|:
name|WORD_SIZE
decl_stmt|;
name|sljit_ins
name|inv_bits
init|=
operator|(
name|op
operator|&
name|SLJIT_SINGLE_OP
operator|)
condition|?
operator|(
literal|1
operator|<<
literal|22
operator|)
else|:
literal|0
decl_stmt|;
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_fop2
argument_list|(
name|compiler
argument_list|,
name|op
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
name|src1
argument_list|,
name|src1w
argument_list|,
name|src2
argument_list|,
name|src2w
argument_list|)
expr_stmt|;
name|compiler
operator|->
name|cache_arg
operator|=
literal|0
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
literal|0
expr_stmt|;
name|dst_r
operator|=
operator|(
name|dst
operator|<=
name|REG_MASK
operator|)
condition|?
name|dst
else|:
name|TMP_FREG1
expr_stmt|;
if|if
condition|(
name|src1
operator|&
name|SLJIT_MEM
condition|)
block|{
name|emit_fop_mem
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_FREG1
argument_list|,
name|src1
argument_list|,
name|src1w
argument_list|)
expr_stmt|;
name|src1
operator|=
name|TMP_FREG1
expr_stmt|;
block|}
if|if
condition|(
name|src2
operator|&
name|SLJIT_MEM
condition|)
block|{
name|emit_fop_mem
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_FREG2
argument_list|,
name|src2
argument_list|,
name|src2w
argument_list|)
expr_stmt|;
name|src2
operator|=
name|TMP_FREG2
expr_stmt|;
block|}
switch|switch
condition|(
name|GET_OPCODE
argument_list|(
name|op
argument_list|)
condition|)
block|{
case|case
name|SLJIT_ADDD
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|FADD
operator|^
name|inv_bits
operator|)
operator||
name|VD
argument_list|(
name|dst_r
argument_list|)
operator||
name|VN
argument_list|(
name|src1
argument_list|)
operator||
name|VM
argument_list|(
name|src2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SLJIT_SUBD
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|FSUB
operator|^
name|inv_bits
operator|)
operator||
name|VD
argument_list|(
name|dst_r
argument_list|)
operator||
name|VN
argument_list|(
name|src1
argument_list|)
operator||
name|VM
argument_list|(
name|src2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SLJIT_MULD
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|FMUL
operator|^
name|inv_bits
operator|)
operator||
name|VD
argument_list|(
name|dst_r
argument_list|)
operator||
name|VN
argument_list|(
name|src1
argument_list|)
operator||
name|VM
argument_list|(
name|src2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SLJIT_DIVD
case|:
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|FDIV
operator|^
name|inv_bits
operator|)
operator||
name|VD
argument_list|(
name|dst_r
argument_list|)
operator||
name|VN
argument_list|(
name|src1
argument_list|)
operator||
name|VM
argument_list|(
name|src2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|dst
operator|&
name|SLJIT_MEM
operator|)
condition|)
return|return
name|SLJIT_SUCCESS
return|;
return|return
name|emit_fop_mem
argument_list|(
name|compiler
argument_list|,
name|mem_flags
operator||
name|STORE
argument_list|,
name|TMP_FREG1
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_comment
comment|/*  Other instructions                                                   */
end_comment
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_function
DECL|function|sljit_emit_fast_enter
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_fast_enter
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_sw
name|dstw
parameter_list|)
block|{
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_fast_enter
argument_list|(
name|compiler
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|dst
argument_list|,
name|dstw
argument_list|)
expr_stmt|;
comment|/* For UNUSED dst. Uncommon, but possible. */
if|if
condition|(
name|dst
operator|==
name|SLJIT_UNUSED
condition|)
return|return
name|SLJIT_SUCCESS
return|;
if|if
condition|(
name|dst
operator|<=
name|REG_MASK
condition|)
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ORR
operator||
name|RD
argument_list|(
name|dst
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|TMP_LR
argument_list|)
argument_list|)
return|;
comment|/* Memory. */
return|return
name|emit_op_mem
argument_list|(
name|compiler
argument_list|,
name|WORD_SIZE
operator||
name|STORE
argument_list|,
name|TMP_LR
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|sljit_emit_fast_return
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_fast_return
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|src
parameter_list|,
name|sljit_sw
name|srcw
parameter_list|)
block|{
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_fast_return
argument_list|(
name|compiler
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|<=
name|REG_MASK
condition|)
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|ORR
operator||
name|RD
argument_list|(
name|TMP_LR
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|src
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|src
operator|&
name|SLJIT_MEM
condition|)
name|FAIL_IF
argument_list|(
name|emit_op_mem
argument_list|(
name|compiler
argument_list|,
name|WORD_SIZE
argument_list|,
name|TMP_LR
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|FAIL_IF
argument_list|(
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|TMP_LR
argument_list|,
name|srcw
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|RET
operator||
name|RN
argument_list|(
name|TMP_LR
argument_list|)
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_comment
comment|/*  Conditional instructions                                             */
end_comment
begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment
begin_function
DECL|function|get_cc
specifier|static
name|sljit_uw
name|get_cc
parameter_list|(
name|sljit_si
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SLJIT_C_EQUAL
case|:
case|case
name|SLJIT_C_MUL_NOT_OVERFLOW
case|:
case|case
name|SLJIT_C_FLOAT_EQUAL
case|:
return|return
literal|0x1
return|;
case|case
name|SLJIT_C_NOT_EQUAL
case|:
case|case
name|SLJIT_C_MUL_OVERFLOW
case|:
case|case
name|SLJIT_C_FLOAT_NOT_EQUAL
case|:
return|return
literal|0x0
return|;
case|case
name|SLJIT_C_LESS
case|:
case|case
name|SLJIT_C_FLOAT_LESS
case|:
return|return
literal|0x2
return|;
case|case
name|SLJIT_C_GREATER_EQUAL
case|:
case|case
name|SLJIT_C_FLOAT_GREATER_EQUAL
case|:
return|return
literal|0x3
return|;
case|case
name|SLJIT_C_GREATER
case|:
case|case
name|SLJIT_C_FLOAT_GREATER
case|:
return|return
literal|0x9
return|;
case|case
name|SLJIT_C_LESS_EQUAL
case|:
case|case
name|SLJIT_C_FLOAT_LESS_EQUAL
case|:
return|return
literal|0x8
return|;
case|case
name|SLJIT_C_SIG_LESS
case|:
return|return
literal|0xa
return|;
case|case
name|SLJIT_C_SIG_GREATER_EQUAL
case|:
return|return
literal|0xb
return|;
case|case
name|SLJIT_C_SIG_GREATER
case|:
return|return
literal|0xd
return|;
case|case
name|SLJIT_C_SIG_LESS_EQUAL
case|:
return|return
literal|0xc
return|;
case|case
name|SLJIT_C_OVERFLOW
case|:
case|case
name|SLJIT_C_FLOAT_UNORDERED
case|:
return|return
literal|0x7
return|;
case|case
name|SLJIT_C_NOT_OVERFLOW
case|:
case|case
name|SLJIT_C_FLOAT_ORDERED
case|:
return|return
literal|0x6
return|;
default|default:
name|SLJIT_ASSERT_STOP
argument_list|()
expr_stmt|;
return|return
literal|0xe
return|;
block|}
block|}
end_function
begin_function
DECL|function|sljit_emit_label
name|SLJIT_API_FUNC_ATTRIBUTE
name|struct
name|sljit_label
modifier|*
name|sljit_emit_label
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|)
block|{
name|struct
name|sljit_label
modifier|*
name|label
decl_stmt|;
name|CHECK_ERROR_PTR
argument_list|()
expr_stmt|;
name|check_sljit_emit_label
argument_list|(
name|compiler
argument_list|)
expr_stmt|;
if|if
condition|(
name|compiler
operator|->
name|last_label
operator|&&
name|compiler
operator|->
name|last_label
operator|->
name|size
operator|==
name|compiler
operator|->
name|size
condition|)
return|return
name|compiler
operator|->
name|last_label
return|;
name|label
operator|=
operator|(
expr|struct
name|sljit_label
operator|*
operator|)
name|ensure_abuf
argument_list|(
name|compiler
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sljit_label
argument_list|)
argument_list|)
expr_stmt|;
name|PTR_FAIL_IF
argument_list|(
operator|!
name|label
argument_list|)
expr_stmt|;
name|set_label
argument_list|(
name|label
argument_list|,
name|compiler
argument_list|)
expr_stmt|;
return|return
name|label
return|;
block|}
end_function
begin_function
DECL|function|sljit_emit_jump
name|SLJIT_API_FUNC_ATTRIBUTE
name|struct
name|sljit_jump
modifier|*
name|sljit_emit_jump
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|type
parameter_list|)
block|{
name|struct
name|sljit_jump
modifier|*
name|jump
decl_stmt|;
name|CHECK_ERROR_PTR
argument_list|()
expr_stmt|;
name|check_sljit_emit_jump
argument_list|(
name|compiler
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|jump
operator|=
operator|(
expr|struct
name|sljit_jump
operator|*
operator|)
name|ensure_abuf
argument_list|(
name|compiler
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sljit_jump
argument_list|)
argument_list|)
expr_stmt|;
name|PTR_FAIL_IF
argument_list|(
operator|!
name|jump
argument_list|)
expr_stmt|;
name|set_jump
argument_list|(
name|jump
argument_list|,
name|compiler
argument_list|,
name|type
operator|&
name|SLJIT_REWRITABLE_JUMP
argument_list|)
expr_stmt|;
name|type
operator|&=
literal|0xff
expr_stmt|;
if|if
condition|(
name|type
operator|<
name|SLJIT_JUMP
condition|)
block|{
name|jump
operator|->
name|flags
operator||=
name|IS_COND
expr_stmt|;
name|PTR_FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|B_CC
operator||
operator|(
literal|6
operator|<<
literal|5
operator|)
operator||
name|get_cc
argument_list|(
name|type
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|>=
name|SLJIT_FAST_CALL
condition|)
name|jump
operator|->
name|flags
operator||=
name|IS_BL
expr_stmt|;
name|PTR_FAIL_IF
argument_list|(
name|emit_imm64_const
argument_list|(
name|compiler
argument_list|,
name|TMP_REG1
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|jump
operator|->
name|addr
operator|=
name|compiler
operator|->
name|size
expr_stmt|;
name|PTR_FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
operator|(
name|type
operator|>=
name|SLJIT_FAST_CALL
operator|)
condition|?
name|BLR
else|:
name|BR
operator|)
operator||
name|RN
argument_list|(
name|TMP_REG1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|jump
return|;
block|}
end_function
begin_expr_stmt
DECL|function|emit_cmp_to0
specifier|static
name|SLJIT_INLINE
expr|struct
name|sljit_jump
operator|*
name|emit_cmp_to0
argument_list|(
argument|struct sljit_compiler *compiler
argument_list|,
argument|sljit_si type
argument_list|,
argument|sljit_si src
argument_list|,
argument|sljit_sw srcw
argument_list|)
block|{ 	struct
name|sljit_jump
operator|*
name|jump
block|;
name|sljit_ins
name|inv_bits
operator|=
operator|(
name|type
operator|&
name|SLJIT_INT_OP
operator|)
condition|?
operator|(
literal|1
operator|<<
literal|31
operator|)
else|:
literal|0
block|;
name|SLJIT_ASSERT
argument_list|(
operator|(
name|type
operator|&
literal|0xff
operator|)
operator|==
name|SLJIT_C_EQUAL
operator|||
operator|(
name|type
operator|&
literal|0xff
operator|)
operator|==
name|SLJIT_C_NOT_EQUAL
argument_list|)
block|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|src
argument_list|,
name|srcw
argument_list|)
block|;
name|jump
operator|=
operator|(
expr|struct
name|sljit_jump
operator|*
operator|)
name|ensure_abuf
argument_list|(
name|compiler
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sljit_jump
argument_list|)
argument_list|)
block|;
name|PTR_FAIL_IF
argument_list|(
operator|!
name|jump
argument_list|)
block|;
name|set_jump
argument_list|(
name|jump
argument_list|,
name|compiler
argument_list|,
name|type
operator|&
name|SLJIT_REWRITABLE_JUMP
argument_list|)
block|;
name|jump
operator|->
name|flags
operator||=
name|IS_CBZ
operator||
name|IS_COND
block|;
if|if
condition|(
name|src
operator|&
name|SLJIT_MEM
condition|)
block|{
name|PTR_FAIL_IF
argument_list|(
name|emit_op_mem
argument_list|(
name|compiler
argument_list|,
name|inv_bits
condition|?
name|INT_SIZE
else|:
name|WORD_SIZE
argument_list|,
name|TMP_REG1
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
argument_list|)
expr_stmt|;
name|src
operator|=
name|TMP_REG1
expr_stmt|;
block|}
end_expr_stmt
begin_elseif
elseif|else
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
block|{
name|PTR_FAIL_IF
argument_list|(
name|load_immediate
argument_list|(
name|compiler
argument_list|,
name|TMP_REG1
argument_list|,
name|srcw
argument_list|)
argument_list|)
expr_stmt|;
name|src
operator|=
name|TMP_REG1
expr_stmt|;
block|}
end_elseif
begin_expr_stmt
name|SLJIT_ASSERT
argument_list|(
name|FAST_IS_REG
argument_list|(
name|src
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt
begin_if
if|if
condition|(
operator|(
name|type
operator|&
literal|0xff
operator|)
operator|==
name|SLJIT_C_EQUAL
condition|)
name|inv_bits
operator||=
literal|1
operator|<<
literal|24
expr_stmt|;
end_if
begin_expr_stmt
name|PTR_FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
name|CBZ
operator|^
name|inv_bits
operator|)
operator||
operator|(
literal|6
operator|<<
literal|5
operator|)
operator||
name|RT
argument_list|(
name|src
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|PTR_FAIL_IF
argument_list|(
name|emit_imm64_const
argument_list|(
name|compiler
argument_list|,
name|TMP_REG1
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|jump
operator|->
name|addr
operator|=
name|compiler
operator|->
name|size
expr_stmt|;
end_expr_stmt
begin_expr_stmt
name|PTR_FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|BR
operator||
name|RN
argument_list|(
name|TMP_REG1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt
begin_return
return|return
name|jump
return|;
end_return
begin_function
unit|}  SLJIT_API_FUNC_ATTRIBUTE
DECL|function|sljit_emit_ijump
name|sljit_si
name|sljit_emit_ijump
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|type
parameter_list|,
name|sljit_si
name|src
parameter_list|,
name|sljit_sw
name|srcw
parameter_list|)
block|{
name|struct
name|sljit_jump
modifier|*
name|jump
decl_stmt|;
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_ijump
argument_list|(
name|compiler
argument_list|,
name|type
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
comment|/* In ARM, we don't need to touch the arguments. */
if|if
condition|(
operator|!
operator|(
name|src
operator|&
name|SLJIT_IMM
operator|)
condition|)
block|{
if|if
condition|(
name|src
operator|&
name|SLJIT_MEM
condition|)
block|{
name|FAIL_IF
argument_list|(
name|emit_op_mem
argument_list|(
name|compiler
argument_list|,
name|WORD_SIZE
argument_list|,
name|TMP_REG1
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|)
argument_list|)
expr_stmt|;
name|src
operator|=
name|TMP_REG1
expr_stmt|;
block|}
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
operator|(
name|type
operator|>=
name|SLJIT_FAST_CALL
operator|)
condition|?
name|BLR
else|:
name|BR
operator|)
operator||
name|RN
argument_list|(
name|src
argument_list|)
argument_list|)
return|;
block|}
name|jump
operator|=
operator|(
expr|struct
name|sljit_jump
operator|*
operator|)
name|ensure_abuf
argument_list|(
name|compiler
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sljit_jump
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL_IF
argument_list|(
operator|!
name|jump
argument_list|)
expr_stmt|;
name|set_jump
argument_list|(
name|jump
argument_list|,
name|compiler
argument_list|,
name|JUMP_ADDR
operator||
operator|(
operator|(
name|type
operator|>=
name|SLJIT_FAST_CALL
operator|)
condition|?
name|IS_BL
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|jump
operator|->
name|u
operator|.
name|target
operator|=
name|srcw
expr_stmt|;
name|FAIL_IF
argument_list|(
name|emit_imm64_const
argument_list|(
name|compiler
argument_list|,
name|TMP_REG1
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|jump
operator|->
name|addr
operator|=
name|compiler
operator|->
name|size
expr_stmt|;
return|return
name|push_inst
argument_list|(
name|compiler
argument_list|,
operator|(
operator|(
name|type
operator|>=
name|SLJIT_FAST_CALL
operator|)
condition|?
name|BLR
else|:
name|BR
operator|)
operator||
name|RN
argument_list|(
name|TMP_REG1
argument_list|)
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|sljit_emit_op_flags
name|SLJIT_API_FUNC_ATTRIBUTE
name|sljit_si
name|sljit_emit_op_flags
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|op
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_sw
name|dstw
parameter_list|,
name|sljit_si
name|src
parameter_list|,
name|sljit_sw
name|srcw
parameter_list|,
name|sljit_si
name|type
parameter_list|)
block|{
name|sljit_si
name|dst_r
decl_stmt|,
name|flags
decl_stmt|,
name|mem_flags
decl_stmt|;
name|sljit_ins
name|cc
decl_stmt|;
name|CHECK_ERROR
argument_list|()
expr_stmt|;
name|check_sljit_emit_op_flags
argument_list|(
name|compiler
argument_list|,
name|op
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|dst
argument_list|,
name|dstw
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|src
argument_list|,
name|srcw
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|==
name|SLJIT_UNUSED
condition|)
return|return
name|SLJIT_SUCCESS
return|;
name|cc
operator|=
name|get_cc
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|dst_r
operator|=
operator|(
name|dst
operator|<=
name|REG_MASK
operator|)
condition|?
name|dst
else|:
name|TMP_REG1
expr_stmt|;
if|if
condition|(
name|GET_OPCODE
argument_list|(
name|op
argument_list|)
operator|<
name|SLJIT_ADD
condition|)
block|{
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|CSINC
operator||
operator|(
name|cc
operator|<<
literal|12
operator|)
operator||
name|RD
argument_list|(
name|dst_r
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|TMP_ZERO
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst_r
operator|!=
name|TMP_REG1
condition|)
return|return
name|SLJIT_SUCCESS
return|;
return|return
name|emit_op_mem
argument_list|(
name|compiler
argument_list|,
operator|(
name|GET_OPCODE
argument_list|(
name|op
argument_list|)
operator|==
name|SLJIT_MOV
condition|?
name|WORD_SIZE
else|:
name|INT_SIZE
operator|)
operator||
name|STORE
argument_list|,
name|TMP_REG1
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
return|;
block|}
name|compiler
operator|->
name|cache_arg
operator|=
literal|0
expr_stmt|;
name|compiler
operator|->
name|cache_argw
operator|=
literal|0
expr_stmt|;
name|flags
operator|=
name|GET_FLAGS
argument_list|(
name|op
argument_list|)
condition|?
name|SET_FLAGS
else|:
literal|0
expr_stmt|;
name|mem_flags
operator|=
name|WORD_SIZE
expr_stmt|;
if|if
condition|(
name|op
operator|&
name|SLJIT_INT_OP
condition|)
block|{
name|flags
operator||=
name|INT_OP
expr_stmt|;
name|mem_flags
operator|=
name|INT_SIZE
expr_stmt|;
block|}
if|if
condition|(
name|src
operator|&
name|SLJIT_MEM
condition|)
block|{
name|FAIL_IF
argument_list|(
name|emit_op_mem2
argument_list|(
name|compiler
argument_list|,
name|mem_flags
argument_list|,
name|TMP_REG1
argument_list|,
name|src
argument_list|,
name|srcw
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
argument_list|)
expr_stmt|;
name|src
operator|=
name|TMP_REG1
expr_stmt|;
name|srcw
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|src
operator|&
name|SLJIT_IMM
condition|)
name|flags
operator||=
name|ARG1_IMM
expr_stmt|;
name|FAIL_IF
argument_list|(
name|push_inst
argument_list|(
name|compiler
argument_list|,
name|CSINC
operator||
operator|(
name|cc
operator|<<
literal|12
operator|)
operator||
name|RD
argument_list|(
name|TMP_REG2
argument_list|)
operator||
name|RN
argument_list|(
name|TMP_ZERO
argument_list|)
operator||
name|RM
argument_list|(
name|TMP_ZERO
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|emit_op_imm
argument_list|(
name|compiler
argument_list|,
name|flags
operator||
name|GET_OPCODE
argument_list|(
name|op
argument_list|)
argument_list|,
name|dst_r
argument_list|,
name|src
argument_list|,
name|TMP_REG2
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst_r
operator|!=
name|TMP_REG1
condition|)
return|return
name|SLJIT_SUCCESS
return|;
return|return
name|emit_op_mem2
argument_list|(
name|compiler
argument_list|,
name|mem_flags
operator||
name|STORE
argument_list|,
name|TMP_REG1
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|sljit_emit_const
name|SLJIT_API_FUNC_ATTRIBUTE
name|struct
name|sljit_const
modifier|*
name|sljit_emit_const
parameter_list|(
name|struct
name|sljit_compiler
modifier|*
name|compiler
parameter_list|,
name|sljit_si
name|dst
parameter_list|,
name|sljit_sw
name|dstw
parameter_list|,
name|sljit_sw
name|init_value
parameter_list|)
block|{
name|struct
name|sljit_const
modifier|*
name|const_
decl_stmt|;
name|sljit_si
name|dst_r
decl_stmt|;
name|CHECK_ERROR_PTR
argument_list|()
expr_stmt|;
name|check_sljit_emit_const
argument_list|(
name|compiler
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|,
name|init_value
argument_list|)
expr_stmt|;
name|ADJUST_LOCAL_OFFSET
argument_list|(
name|dst
argument_list|,
name|dstw
argument_list|)
expr_stmt|;
name|const_
operator|=
operator|(
expr|struct
name|sljit_const
operator|*
operator|)
name|ensure_abuf
argument_list|(
name|compiler
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sljit_const
argument_list|)
argument_list|)
expr_stmt|;
name|PTR_FAIL_IF
argument_list|(
operator|!
name|const_
argument_list|)
expr_stmt|;
name|set_const
argument_list|(
name|const_
argument_list|,
name|compiler
argument_list|)
expr_stmt|;
name|dst_r
operator|=
name|SLOW_IS_REG
argument_list|(
name|dst
argument_list|)
condition|?
name|dst
else|:
name|TMP_REG1
expr_stmt|;
name|PTR_FAIL_IF
argument_list|(
name|emit_imm64_const
argument_list|(
name|compiler
argument_list|,
name|dst_r
argument_list|,
name|init_value
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|&
name|SLJIT_MEM
condition|)
name|PTR_FAIL_IF
argument_list|(
name|emit_op_mem
argument_list|(
name|compiler
argument_list|,
name|WORD_SIZE
operator||
name|STORE
argument_list|,
name|dst_r
argument_list|,
name|dst
argument_list|,
name|dstw
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|const_
return|;
block|}
end_function
begin_function
DECL|function|sljit_set_jump_addr
name|SLJIT_API_FUNC_ATTRIBUTE
name|void
name|sljit_set_jump_addr
parameter_list|(
name|sljit_uw
name|addr
parameter_list|,
name|sljit_uw
name|new_addr
parameter_list|)
block|{
name|sljit_ins
modifier|*
name|inst
init|=
operator|(
name|sljit_ins
operator|*
operator|)
name|addr
decl_stmt|;
name|modify_imm64_const
argument_list|(
name|inst
argument_list|,
name|new_addr
argument_list|)
expr_stmt|;
name|SLJIT_CACHE_FLUSH
argument_list|(
name|inst
argument_list|,
name|inst
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|sljit_set_const
name|SLJIT_API_FUNC_ATTRIBUTE
name|void
name|sljit_set_const
parameter_list|(
name|sljit_uw
name|addr
parameter_list|,
name|sljit_sw
name|new_constant
parameter_list|)
block|{
name|sljit_ins
modifier|*
name|inst
init|=
operator|(
name|sljit_ins
operator|*
operator|)
name|addr
decl_stmt|;
name|modify_imm64_const
argument_list|(
name|inst
argument_list|,
name|new_constant
argument_list|)
expr_stmt|;
name|SLJIT_CACHE_FLUSH
argument_list|(
name|inst
argument_list|,
name|inst
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
end_function
end_unit
