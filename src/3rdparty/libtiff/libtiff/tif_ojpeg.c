begin_unit
begin_comment
comment|/* $Id: tif_ojpeg.c,v 1.24.2.4 2009-09-03 20:45:10 bfriesen Exp $ */
end_comment
begin_comment
comment|/* WARNING: The type of JPEG encapsulation defined by the TIFF Version 6.0    specification is now totally obsolete and deprecated for new applications and    images. This file was was created solely in order to read unconverted images    still present on some users' computer systems. It will never be extended    to write such files. Writing new-style JPEG compressed TIFFs is implemented    in tif_jpeg.c.     The code is carefully crafted to robustly read all gathered JPEG-in-TIFF    testfiles, and anticipate as much as possible all other... But still, it may    fail on some. If you encounter problems, please report them on the TIFF    mailing list and/or to Joris Van Damme<info@awaresystems.be>.     Please read the file called "TIFF Technical Note #2" if you need to be    convinced this compression scheme is bad and breaks TIFF. That document    is linked to from the LibTiff site<http://www.remotesensing.org/libtiff/>    and from AWare Systems' TIFF section<http://www.awaresystems.be/imaging/tiff.html>. It is also absorbed    in Adobe's specification supplements, marked "draft" up to this day, but    supported by the TIFF community.     This file interfaces with Release 6B of the JPEG Library written by the    Independent JPEG Group. Previous versions of this file required a hack inside    the LibJpeg library. This version no longer requires that. Remember to    remove the hack if you update from the old version.     Copyright (c) Joris Van Damme<info@awaresystems.be>    Copyright (c) AWare Systems<http://www.awaresystems.be/>     The licence agreement for this file is the same as the rest of the LibTiff    library.     IN NO EVENT SHALL JORIS VAN DAMME OR AWARE SYSTEMS BE LIABLE FOR    ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,    OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,    WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF    LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE    OF THIS SOFTWARE.     Joris Van Damme and/or AWare Systems may be available for custom    developement. If you like what you see, and need anything similar or related,    contact<info@awaresystems.be>. */
end_comment
begin_comment
comment|/* What is what, and what is not?     This decoder starts with an input stream, that is essentially the JpegInterchangeFormat    stream, if any, followed by the strile data, if any. This stream is read in    OJPEGReadByte and related functions.     It analyzes the start of this stream, until it encounters non-marker data, i.e.    compressed image data. Some of the header markers it sees have no actual content,    like the SOI marker, and APP/COM markers that really shouldn't even be there. Some    other markers do have content, and the valuable bits and pieces of information    in these markers are saved, checking all to verify that the stream is more or    less within expected bounds. This happens inside the OJPEGReadHeaderInfoSecStreamXxx    functions.     Some OJPEG imagery contains no valid JPEG header markers. This situation is picked    up on if we've seen no SOF marker when we're at the start of the compressed image    data. In this case, the tables are read from JpegXxxTables tags, and the other    bits and pieces of information is initialized to its most basic value. This is    implemented in the OJPEGReadHeaderInfoSecTablesXxx functions.     When this is complete, a good and valid JPEG header can be assembled, and this is    passed through to LibJpeg. When that's done, the remainder of the input stream, i.e.    the compressed image data, can be passed through unchanged. This is done in    OJPEGWriteStream functions.     LibTiff rightly expects to know the subsampling values before decompression. Just like    in new-style JPEG-in-TIFF, though, or even more so, actually, the YCbCrsubsampling    tag is notoriously unreliable. To correct these tag values with the ones inside    the JPEG stream, the first part of the input stream is pre-scanned in    OJPEGSubsamplingCorrect, making no note of any other data, reporting no warnings    or errors, up to the point where either these values are read, or it's clear they    aren't there. This means that some of the data is read twice, but we feel speed    in correcting these values is important enough to warrant this sacrifice. Allthough    there is currently no define or other configuration mechanism to disable this behaviour,    the actual header scanning is build to robustly respond with error report if it    should encounter an uncorrected mismatch of subsampling values. See    OJPEGReadHeaderInfoSecStreamSof.     The restart interval and restart markers are the most tricky part... The restart    interval can be specified in a tag. It can also be set inside the input JPEG stream.    It can be used inside the input JPEG stream. If reading from strile data, we've    consistenly discovered the need to insert restart markers in between the different    striles, as is also probably the most likely interpretation of the original TIFF 6.0    specification. With all this setting of interval, and actual use of markers that is not    predictable at the time of valid JPEG header assembly, the restart thing may turn    out the Achilles heel of this implementation. Fortunately, most OJPEG writer vendors    succeed in reading back what they write, which may be the reason why we've been able    to discover ways that seem to work.     Some special provision is made for planarconfig separate OJPEG files. These seem    to consistently contain header info, a SOS marker, a plane, SOS marker, plane, SOS,    and plane. This may or may not be a valid JPEG configuration, we don't know and don't    care. We want LibTiff to be able to access the planes individually, without huge    buffering inside LibJpeg, anyway. So we compose headers to feed to LibJpeg, in this    case, that allow us to pass a single plane such that LibJpeg sees a valid    single-channel JPEG stream. Locating subsequent SOS markers, and thus subsequent    planes, is done inside OJPEGReadSecondarySos.     The benefit of the scheme is... that it works, basically. We know of no other that    does. It works without checking software tag, or otherwise going about things in an    OJPEG flavor specific manner. Instead, it is a single scheme, that covers the cases    with and without JpegInterchangeFormat, with and without striles, with part of    the header in JpegInterchangeFormat and remainder in first strile, etc. It is forgiving    and robust, may likely work with OJPEG flavors we've not seen yet, and makes most out    of the data.     Another nice side-effect is that a complete JPEG single valid stream is build if    planarconfig is not separate (vast majority). We may one day use that to build    converters to JPEG, and/or to new-style JPEG compression inside TIFF.     A dissadvantage is the lack of random access to the individual striles. This is the    reason for much of the complicated restart-and-position stuff inside OJPEGPreDecode.    Applications would do well accessing all striles in order, as this will result in    a single sequential scan of the input stream, and no restarting of LibJpeg decoding    session. */
end_comment
begin_include
include|#
directive|include
file|"tiffiop.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|OJPEG_SUPPORT
end_ifdef
begin_comment
comment|/* Configuration defines here are:  * JPEG_ENCAP_EXTERNAL: The normal way to call libjpeg, uses longjump. In some environments,  * 	like eg LibTiffDelphi, this is not possible. For this reason, the actual calls to  * 	libjpeg, with longjump stuff, are encapsulated in dedicated functions. When  * 	JPEG_ENCAP_EXTERNAL is defined, these encapsulating functions are declared external  * 	to this unit, and can be defined elsewhere to use stuff other then longjump.  * 	The default mode, without JPEG_ENCAP_EXTERNAL, implements the call encapsulators  * 	here, internally, with normal longjump.  * SETJMP, LONGJMP, JMP_BUF: On some machines/environments a longjump equivalent is  * 	conviniently available, but still it may be worthwhile to use _setjmp or sigsetjmp  * 	in place of plain setjmp. These macros will make it easier. It is useless  * 	to fiddle with these if you define JPEG_ENCAP_EXTERNAL.  * OJPEG_BUFFER: Define the size of the desired buffer here. Should be small enough so as to guarantee  * 	instant processing, optimal streaming and optimal use of processor cache, but also big  * 	enough so as to not result in significant call overhead. It should be at least a few  * 	bytes to accomodate some structures (this is verified in asserts), but it would not be  * 	sensible to make it this small anyway, and it should be at most 64K since it is indexed  * 	with uint16. We recommend 2K.  * EGYPTIANWALK: You could also define EGYPTIANWALK here, but it is not used anywhere and has  * 	absolutely no effect. That is why most people insist the EGYPTIANWALK is a bit silly.  */
end_comment
begin_comment
comment|/* #define LIBJPEG_ENCAP_EXTERNAL */
end_comment
begin_define
DECL|macro|SETJMP
define|#
directive|define
name|SETJMP
parameter_list|(
name|jbuf
parameter_list|)
value|setjmp(jbuf)
end_define
begin_define
DECL|macro|LONGJMP
define|#
directive|define
name|LONGJMP
parameter_list|(
name|jbuf
parameter_list|,
name|code
parameter_list|)
value|longjmp(jbuf,code)
end_define
begin_define
DECL|macro|JMP_BUF
define|#
directive|define
name|JMP_BUF
value|jmp_buf
end_define
begin_define
DECL|macro|OJPEG_BUFFER
define|#
directive|define
name|OJPEG_BUFFER
value|2048
end_define
begin_comment
comment|/* define EGYPTIANWALK */
end_comment
begin_define
DECL|macro|JPEG_MARKER_SOF0
define|#
directive|define
name|JPEG_MARKER_SOF0
value|0xC0
end_define
begin_define
DECL|macro|JPEG_MARKER_SOF1
define|#
directive|define
name|JPEG_MARKER_SOF1
value|0xC1
end_define
begin_define
DECL|macro|JPEG_MARKER_SOF3
define|#
directive|define
name|JPEG_MARKER_SOF3
value|0xC3
end_define
begin_define
DECL|macro|JPEG_MARKER_DHT
define|#
directive|define
name|JPEG_MARKER_DHT
value|0xC4
end_define
begin_define
DECL|macro|JPEG_MARKER_RST0
define|#
directive|define
name|JPEG_MARKER_RST0
value|0XD0
end_define
begin_define
DECL|macro|JPEG_MARKER_SOI
define|#
directive|define
name|JPEG_MARKER_SOI
value|0xD8
end_define
begin_define
DECL|macro|JPEG_MARKER_EOI
define|#
directive|define
name|JPEG_MARKER_EOI
value|0xD9
end_define
begin_define
DECL|macro|JPEG_MARKER_SOS
define|#
directive|define
name|JPEG_MARKER_SOS
value|0xDA
end_define
begin_define
DECL|macro|JPEG_MARKER_DQT
define|#
directive|define
name|JPEG_MARKER_DQT
value|0xDB
end_define
begin_define
DECL|macro|JPEG_MARKER_DRI
define|#
directive|define
name|JPEG_MARKER_DRI
value|0xDD
end_define
begin_define
DECL|macro|JPEG_MARKER_APP0
define|#
directive|define
name|JPEG_MARKER_APP0
value|0xE0
end_define
begin_define
DECL|macro|JPEG_MARKER_COM
define|#
directive|define
name|JPEG_MARKER_COM
value|0xFE
end_define
begin_define
DECL|macro|FIELD_OJPEG_JPEGINTERCHANGEFORMAT
define|#
directive|define
name|FIELD_OJPEG_JPEGINTERCHANGEFORMAT
value|(FIELD_CODEC+0)
end_define
begin_define
DECL|macro|FIELD_OJPEG_JPEGINTERCHANGEFORMATLENGTH
define|#
directive|define
name|FIELD_OJPEG_JPEGINTERCHANGEFORMATLENGTH
value|(FIELD_CODEC+1)
end_define
begin_define
DECL|macro|FIELD_OJPEG_JPEGQTABLES
define|#
directive|define
name|FIELD_OJPEG_JPEGQTABLES
value|(FIELD_CODEC+2)
end_define
begin_define
DECL|macro|FIELD_OJPEG_JPEGDCTABLES
define|#
directive|define
name|FIELD_OJPEG_JPEGDCTABLES
value|(FIELD_CODEC+3)
end_define
begin_define
DECL|macro|FIELD_OJPEG_JPEGACTABLES
define|#
directive|define
name|FIELD_OJPEG_JPEGACTABLES
value|(FIELD_CODEC+4)
end_define
begin_define
DECL|macro|FIELD_OJPEG_JPEGPROC
define|#
directive|define
name|FIELD_OJPEG_JPEGPROC
value|(FIELD_CODEC+5)
end_define
begin_define
DECL|macro|FIELD_OJPEG_JPEGRESTARTINTERVAL
define|#
directive|define
name|FIELD_OJPEG_JPEGRESTARTINTERVAL
value|(FIELD_CODEC+6)
end_define
begin_define
DECL|macro|FIELD_OJPEG_COUNT
define|#
directive|define
name|FIELD_OJPEG_COUNT
value|7
end_define
begin_decl_stmt
DECL|variable|ojpeg_field_info
specifier|static
specifier|const
name|TIFFFieldInfo
name|ojpeg_field_info
index|[]
init|=
block|{
block|{
name|TIFFTAG_JPEGIFOFFSET
block|,
literal|1
block|,
literal|1
block|,
name|TIFF_LONG
block|,
name|FIELD_OJPEG_JPEGINTERCHANGEFORMAT
block|,
name|TRUE
block|,
name|FALSE
block|,
literal|"JpegInterchangeFormat"
block|}
block|,
block|{
name|TIFFTAG_JPEGIFBYTECOUNT
block|,
literal|1
block|,
literal|1
block|,
name|TIFF_LONG
block|,
name|FIELD_OJPEG_JPEGINTERCHANGEFORMATLENGTH
block|,
name|TRUE
block|,
name|FALSE
block|,
literal|"JpegInterchangeFormatLength"
block|}
block|,
block|{
name|TIFFTAG_JPEGQTABLES
block|,
name|TIFF_VARIABLE
block|,
name|TIFF_VARIABLE
block|,
name|TIFF_LONG
block|,
name|FIELD_OJPEG_JPEGQTABLES
block|,
name|FALSE
block|,
name|TRUE
block|,
literal|"JpegQTables"
block|}
block|,
block|{
name|TIFFTAG_JPEGDCTABLES
block|,
name|TIFF_VARIABLE
block|,
name|TIFF_VARIABLE
block|,
name|TIFF_LONG
block|,
name|FIELD_OJPEG_JPEGDCTABLES
block|,
name|FALSE
block|,
name|TRUE
block|,
literal|"JpegDcTables"
block|}
block|,
block|{
name|TIFFTAG_JPEGACTABLES
block|,
name|TIFF_VARIABLE
block|,
name|TIFF_VARIABLE
block|,
name|TIFF_LONG
block|,
name|FIELD_OJPEG_JPEGACTABLES
block|,
name|FALSE
block|,
name|TRUE
block|,
literal|"JpegAcTables"
block|}
block|,
block|{
name|TIFFTAG_JPEGPROC
block|,
literal|1
block|,
literal|1
block|,
name|TIFF_SHORT
block|,
name|FIELD_OJPEG_JPEGPROC
block|,
name|FALSE
block|,
name|FALSE
block|,
literal|"JpegProc"
block|}
block|,
block|{
name|TIFFTAG_JPEGRESTARTINTERVAL
block|,
literal|1
block|,
literal|1
block|,
name|TIFF_SHORT
block|,
name|FIELD_OJPEG_JPEGRESTARTINTERVAL
block|,
name|FALSE
block|,
name|FALSE
block|,
literal|"JpegRestartInterval"
block|}
block|, }
decl_stmt|;
end_decl_stmt
begin_ifndef
ifndef|#
directive|ifndef
name|LIBJPEG_ENCAP_EXTERNAL
end_ifndef
begin_include
include|#
directive|include
file|<setjmp.h>
end_include
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"jpeglib.h"
end_include
begin_include
include|#
directive|include
file|"jerror.h"
end_include
begin_typedef
DECL|typedef|jpeg_error_mgr
typedef|typedef
name|struct
name|jpeg_error_mgr
name|jpeg_error_mgr
typedef|;
end_typedef
begin_typedef
DECL|typedef|jpeg_common_struct
typedef|typedef
name|struct
name|jpeg_common_struct
name|jpeg_common_struct
typedef|;
end_typedef
begin_typedef
DECL|typedef|jpeg_decompress_struct
typedef|typedef
name|struct
name|jpeg_decompress_struct
name|jpeg_decompress_struct
typedef|;
end_typedef
begin_typedef
DECL|typedef|jpeg_source_mgr
typedef|typedef
name|struct
name|jpeg_source_mgr
name|jpeg_source_mgr
typedef|;
end_typedef
begin_typedef
typedef|typedef
enum|enum
block|{
DECL|enumerator|osibsNotSetYet
name|osibsNotSetYet
block|,
DECL|enumerator|osibsJpegInterchangeFormat
name|osibsJpegInterchangeFormat
block|,
DECL|enumerator|osibsStrile
name|osibsStrile
block|,
DECL|enumerator|osibsEof
name|osibsEof
block|}
DECL|typedef|OJPEGStateInBufferSource
name|OJPEGStateInBufferSource
typedef|;
end_typedef
begin_typedef
typedef|typedef
enum|enum
block|{
DECL|enumerator|ososSoi
name|ososSoi
block|,
DECL|enumerator|ososQTable0
DECL|enumerator|ososQTable1
DECL|enumerator|ososQTable2
DECL|enumerator|ososQTable3
name|ososQTable0
block|,
name|ososQTable1
block|,
name|ososQTable2
block|,
name|ososQTable3
block|,
DECL|enumerator|ososDcTable0
DECL|enumerator|ososDcTable1
DECL|enumerator|ososDcTable2
DECL|enumerator|ososDcTable3
name|ososDcTable0
block|,
name|ososDcTable1
block|,
name|ososDcTable2
block|,
name|ososDcTable3
block|,
DECL|enumerator|ososAcTable0
DECL|enumerator|ososAcTable1
DECL|enumerator|ososAcTable2
DECL|enumerator|ososAcTable3
name|ososAcTable0
block|,
name|ososAcTable1
block|,
name|ososAcTable2
block|,
name|ososAcTable3
block|,
DECL|enumerator|ososDri
name|ososDri
block|,
DECL|enumerator|ososSof
name|ososSof
block|,
DECL|enumerator|ososSos
name|ososSos
block|,
DECL|enumerator|ososCompressed
name|ososCompressed
block|,
DECL|enumerator|ososRst
name|ososRst
block|,
DECL|enumerator|ososEoi
name|ososEoi
block|}
DECL|typedef|OJPEGStateOutState
name|OJPEGStateOutState
typedef|;
end_typedef
begin_typedef
typedef|typedef
struct|struct
block|{
DECL|member|tif
name|TIFF
modifier|*
name|tif
decl_stmt|;
ifndef|#
directive|ifndef
name|LIBJPEG_ENCAP_EXTERNAL
DECL|member|exit_jmpbuf
name|JMP_BUF
name|exit_jmpbuf
decl_stmt|;
endif|#
directive|endif
DECL|member|vgetparent
name|TIFFVGetMethod
name|vgetparent
decl_stmt|;
DECL|member|vsetparent
name|TIFFVSetMethod
name|vsetparent
decl_stmt|;
DECL|member|file_size
name|toff_t
name|file_size
decl_stmt|;
DECL|member|image_width
name|uint32
name|image_width
decl_stmt|;
DECL|member|image_length
name|uint32
name|image_length
decl_stmt|;
DECL|member|strile_width
name|uint32
name|strile_width
decl_stmt|;
DECL|member|strile_length
name|uint32
name|strile_length
decl_stmt|;
DECL|member|strile_length_total
name|uint32
name|strile_length_total
decl_stmt|;
DECL|member|samples_per_pixel
name|uint8
name|samples_per_pixel
decl_stmt|;
DECL|member|plane_sample_offset
name|uint8
name|plane_sample_offset
decl_stmt|;
DECL|member|samples_per_pixel_per_plane
name|uint8
name|samples_per_pixel_per_plane
decl_stmt|;
DECL|member|jpeg_interchange_format
name|toff_t
name|jpeg_interchange_format
decl_stmt|;
DECL|member|jpeg_interchange_format_length
name|toff_t
name|jpeg_interchange_format_length
decl_stmt|;
DECL|member|jpeg_proc
name|uint8
name|jpeg_proc
decl_stmt|;
DECL|member|subsamplingcorrect
name|uint8
name|subsamplingcorrect
decl_stmt|;
DECL|member|subsamplingcorrect_done
name|uint8
name|subsamplingcorrect_done
decl_stmt|;
DECL|member|subsampling_tag
name|uint8
name|subsampling_tag
decl_stmt|;
DECL|member|subsampling_hor
name|uint8
name|subsampling_hor
decl_stmt|;
DECL|member|subsampling_ver
name|uint8
name|subsampling_ver
decl_stmt|;
DECL|member|subsampling_force_desubsampling_inside_decompression
name|uint8
name|subsampling_force_desubsampling_inside_decompression
decl_stmt|;
DECL|member|qtable_offset_count
name|uint8
name|qtable_offset_count
decl_stmt|;
DECL|member|dctable_offset_count
name|uint8
name|dctable_offset_count
decl_stmt|;
DECL|member|actable_offset_count
name|uint8
name|actable_offset_count
decl_stmt|;
DECL|member|qtable_offset
name|toff_t
name|qtable_offset
index|[
literal|3
index|]
decl_stmt|;
DECL|member|dctable_offset
name|toff_t
name|dctable_offset
index|[
literal|3
index|]
decl_stmt|;
DECL|member|actable_offset
name|toff_t
name|actable_offset
index|[
literal|3
index|]
decl_stmt|;
DECL|member|qtable
name|uint8
modifier|*
name|qtable
index|[
literal|4
index|]
decl_stmt|;
DECL|member|dctable
name|uint8
modifier|*
name|dctable
index|[
literal|4
index|]
decl_stmt|;
DECL|member|actable
name|uint8
modifier|*
name|actable
index|[
literal|4
index|]
decl_stmt|;
DECL|member|restart_interval
name|uint16
name|restart_interval
decl_stmt|;
DECL|member|restart_index
name|uint8
name|restart_index
decl_stmt|;
DECL|member|sof_log
name|uint8
name|sof_log
decl_stmt|;
DECL|member|sof_marker_id
name|uint8
name|sof_marker_id
decl_stmt|;
DECL|member|sof_x
name|uint32
name|sof_x
decl_stmt|;
DECL|member|sof_y
name|uint32
name|sof_y
decl_stmt|;
DECL|member|sof_c
name|uint8
name|sof_c
index|[
literal|3
index|]
decl_stmt|;
DECL|member|sof_hv
name|uint8
name|sof_hv
index|[
literal|3
index|]
decl_stmt|;
DECL|member|sof_tq
name|uint8
name|sof_tq
index|[
literal|3
index|]
decl_stmt|;
DECL|member|sos_cs
name|uint8
name|sos_cs
index|[
literal|3
index|]
decl_stmt|;
DECL|member|sos_tda
name|uint8
name|sos_tda
index|[
literal|3
index|]
decl_stmt|;
struct|struct
block|{
DECL|member|log
name|uint8
name|log
decl_stmt|;
DECL|member|in_buffer_source
name|OJPEGStateInBufferSource
name|in_buffer_source
decl_stmt|;
DECL|member|in_buffer_next_strile
name|tstrile_t
name|in_buffer_next_strile
decl_stmt|;
DECL|member|in_buffer_file_pos
name|toff_t
name|in_buffer_file_pos
decl_stmt|;
DECL|member|in_buffer_file_togo
name|toff_t
name|in_buffer_file_togo
decl_stmt|;
block|}
DECL|member|sos_end
name|sos_end
index|[
literal|3
index|]
struct|;
DECL|member|readheader_done
name|uint8
name|readheader_done
decl_stmt|;
DECL|member|writeheader_done
name|uint8
name|writeheader_done
decl_stmt|;
DECL|member|write_cursample
name|tsample_t
name|write_cursample
decl_stmt|;
DECL|member|write_curstrile
name|tstrile_t
name|write_curstrile
decl_stmt|;
DECL|member|libjpeg_session_active
name|uint8
name|libjpeg_session_active
decl_stmt|;
DECL|member|libjpeg_jpeg_query_style
name|uint8
name|libjpeg_jpeg_query_style
decl_stmt|;
DECL|member|libjpeg_jpeg_error_mgr
name|jpeg_error_mgr
name|libjpeg_jpeg_error_mgr
decl_stmt|;
DECL|member|libjpeg_jpeg_decompress_struct
name|jpeg_decompress_struct
name|libjpeg_jpeg_decompress_struct
decl_stmt|;
DECL|member|libjpeg_jpeg_source_mgr
name|jpeg_source_mgr
name|libjpeg_jpeg_source_mgr
decl_stmt|;
DECL|member|subsampling_convert_log
name|uint8
name|subsampling_convert_log
decl_stmt|;
DECL|member|subsampling_convert_ylinelen
name|uint32
name|subsampling_convert_ylinelen
decl_stmt|;
DECL|member|subsampling_convert_ylines
name|uint32
name|subsampling_convert_ylines
decl_stmt|;
DECL|member|subsampling_convert_clinelen
name|uint32
name|subsampling_convert_clinelen
decl_stmt|;
DECL|member|subsampling_convert_clines
name|uint32
name|subsampling_convert_clines
decl_stmt|;
DECL|member|subsampling_convert_ybuflen
name|uint32
name|subsampling_convert_ybuflen
decl_stmt|;
DECL|member|subsampling_convert_cbuflen
name|uint32
name|subsampling_convert_cbuflen
decl_stmt|;
DECL|member|subsampling_convert_ycbcrbuflen
name|uint32
name|subsampling_convert_ycbcrbuflen
decl_stmt|;
DECL|member|subsampling_convert_ycbcrbuf
name|uint8
modifier|*
name|subsampling_convert_ycbcrbuf
decl_stmt|;
DECL|member|subsampling_convert_ybuf
name|uint8
modifier|*
name|subsampling_convert_ybuf
decl_stmt|;
DECL|member|subsampling_convert_cbbuf
name|uint8
modifier|*
name|subsampling_convert_cbbuf
decl_stmt|;
DECL|member|subsampling_convert_crbuf
name|uint8
modifier|*
name|subsampling_convert_crbuf
decl_stmt|;
DECL|member|subsampling_convert_ycbcrimagelen
name|uint32
name|subsampling_convert_ycbcrimagelen
decl_stmt|;
DECL|member|subsampling_convert_ycbcrimage
name|uint8
modifier|*
modifier|*
name|subsampling_convert_ycbcrimage
decl_stmt|;
DECL|member|subsampling_convert_clinelenout
name|uint32
name|subsampling_convert_clinelenout
decl_stmt|;
DECL|member|subsampling_convert_state
name|uint32
name|subsampling_convert_state
decl_stmt|;
DECL|member|bytes_per_line
name|uint32
name|bytes_per_line
decl_stmt|;
comment|/* if the codec outputs subsampled data, a 'line' in bytes_per_line */
DECL|member|lines_per_strile
name|uint32
name|lines_per_strile
decl_stmt|;
comment|/* and lines_per_strile means subsampling_ver desubsampled rows     */
DECL|member|in_buffer_source
name|OJPEGStateInBufferSource
name|in_buffer_source
decl_stmt|;
DECL|member|in_buffer_next_strile
name|tstrile_t
name|in_buffer_next_strile
decl_stmt|;
DECL|member|in_buffer_strile_count
name|tstrile_t
name|in_buffer_strile_count
decl_stmt|;
DECL|member|in_buffer_file_pos
name|toff_t
name|in_buffer_file_pos
decl_stmt|;
DECL|member|in_buffer_file_pos_log
name|uint8
name|in_buffer_file_pos_log
decl_stmt|;
DECL|member|in_buffer_file_togo
name|toff_t
name|in_buffer_file_togo
decl_stmt|;
DECL|member|in_buffer_togo
name|uint16
name|in_buffer_togo
decl_stmt|;
DECL|member|in_buffer_cur
name|uint8
modifier|*
name|in_buffer_cur
decl_stmt|;
DECL|member|in_buffer
name|uint8
name|in_buffer
index|[
name|OJPEG_BUFFER
index|]
decl_stmt|;
DECL|member|out_state
name|OJPEGStateOutState
name|out_state
decl_stmt|;
DECL|member|out_buffer
name|uint8
name|out_buffer
index|[
name|OJPEG_BUFFER
index|]
decl_stmt|;
DECL|member|skip_buffer
name|uint8
modifier|*
name|skip_buffer
decl_stmt|;
block|}
DECL|typedef|OJPEGState
name|OJPEGState
typedef|;
end_typedef
begin_function_decl
specifier|static
name|int
name|OJPEGVGetField
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|ttag_t
name|tag
parameter_list|,
name|va_list
name|ap
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGVSetField
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|ttag_t
name|tag
parameter_list|,
name|va_list
name|ap
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGPrintDir
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|FILE
modifier|*
name|fd
parameter_list|,
name|long
name|flags
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGSetupDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGPreDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tsample_t
name|s
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGPreDecodeSkipRaw
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGPreDecodeSkipScanlines
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGDecodeRaw
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGDecodeScanlines
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGPostDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGSetupEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGPreEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tsample_t
name|s
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGPostEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGCleanup
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGSubsamplingCorrect
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfo
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadSecondarySos
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tsample_t
name|s
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGWriteHeaderInfo
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGLibjpegSessionAbort
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfoSec
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfoSecStreamDri
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfoSecStreamDqt
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfoSecStreamDht
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfoSecStreamSof
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|uint8
name|marker_id
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfoSecStreamSos
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfoSecTablesQTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfoSecTablesDcTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadHeaderInfoSecTablesAcTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadBufferFill
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadByte
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint8
modifier|*
name|byte
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadBytePeek
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint8
modifier|*
name|byte
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGReadByteAdvance
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadWord
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint16
modifier|*
name|word
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGReadBlock
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint16
name|len
parameter_list|,
name|void
modifier|*
name|mem
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGReadSkip
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint16
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGWriteStream
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGWriteStreamSoi
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGWriteStreamQTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|uint8
name|table_index
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGWriteStreamDcTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|uint8
name|table_index
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGWriteStreamAcTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|uint8
name|table_index
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGWriteStreamDri
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGWriteStreamSof
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGWriteStreamSos
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|OJPEGWriteStreamCompressed
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGWriteStreamRst
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGWriteStreamEoi
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl
begin_ifdef
ifdef|#
directive|ifdef
name|LIBJPEG_ENCAP_EXTERNAL
end_ifdef
begin_function_decl
specifier|extern
name|int
name|jpeg_create_decompress_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|extern
name|int
name|jpeg_read_header_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|uint8
name|require_image
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|extern
name|int
name|jpeg_start_decompress_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|extern
name|int
name|jpeg_read_scanlines_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|void
modifier|*
name|scanlines
parameter_list|,
name|uint32
name|max_lines
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|extern
name|int
name|jpeg_read_raw_data_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|uint32
name|max_lines
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|extern
name|void
name|jpeg_encap_unwind
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_else
else|#
directive|else
end_else
begin_function_decl
specifier|static
name|int
name|jpeg_create_decompress_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|j
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|jpeg_read_header_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|uint8
name|require_image
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|jpeg_start_decompress_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|jpeg_read_scanlines_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|void
modifier|*
name|scanlines
parameter_list|,
name|uint32
name|max_lines
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|jpeg_read_raw_data_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|uint32
name|max_lines
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|jpeg_encap_unwind
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
function_decl|;
end_function_decl
begin_endif
endif|#
directive|endif
end_endif
begin_function_decl
specifier|static
name|void
name|OJPEGLibjpegJpegErrorMgrOutputMessage
parameter_list|(
name|jpeg_common_struct
modifier|*
name|cinfo
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGLibjpegJpegErrorMgrErrorExit
parameter_list|(
name|jpeg_common_struct
modifier|*
name|cinfo
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGLibjpegJpegSourceMgrInitSource
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|boolean
name|OJPEGLibjpegJpegSourceMgrFillInputBuffer
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGLibjpegJpegSourceMgrSkipInputData
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|long
name|num_bytes
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|boolean
name|OJPEGLibjpegJpegSourceMgrResyncToRestart
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|int
name|desired
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|void
name|OJPEGLibjpegJpegSourceMgrTermSource
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
function_decl|;
end_function_decl
begin_function
name|int
DECL|function|TIFFInitOJPEG
name|TIFFInitOJPEG
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|int
name|scheme
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"TIFFInitOJPEG"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
decl_stmt|;
name|assert
argument_list|(
name|scheme
operator|==
name|COMPRESSION_OJPEG
argument_list|)
expr_stmt|;
comment|/* 	 * Merge codec-specific tag information. 	 */
if|if
condition|(
operator|!
name|_TIFFMergeFieldInfo
argument_list|(
name|tif
argument_list|,
name|ojpeg_field_info
argument_list|,
name|FIELD_OJPEG_COUNT
argument_list|)
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Merging Old JPEG codec-specific tags failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* state block */
name|sp
operator|=
name|_TIFFmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|OJPEGState
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"No space for OJPEG state block"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|_TIFFmemset
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|OJPEGState
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|->
name|tif
operator|=
name|tif
expr_stmt|;
name|sp
operator|->
name|jpeg_proc
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|subsampling_hor
operator|=
literal|2
expr_stmt|;
name|sp
operator|->
name|subsampling_ver
operator|=
literal|2
expr_stmt|;
name|TIFFSetField
argument_list|(
name|tif
argument_list|,
name|TIFFTAG_YCBCRSUBSAMPLING
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* tif codec methods */
name|tif
operator|->
name|tif_setupdecode
operator|=
name|OJPEGSetupDecode
expr_stmt|;
name|tif
operator|->
name|tif_predecode
operator|=
name|OJPEGPreDecode
expr_stmt|;
name|tif
operator|->
name|tif_postdecode
operator|=
name|OJPEGPostDecode
expr_stmt|;
name|tif
operator|->
name|tif_decoderow
operator|=
name|OJPEGDecode
expr_stmt|;
name|tif
operator|->
name|tif_decodestrip
operator|=
name|OJPEGDecode
expr_stmt|;
name|tif
operator|->
name|tif_decodetile
operator|=
name|OJPEGDecode
expr_stmt|;
name|tif
operator|->
name|tif_setupencode
operator|=
name|OJPEGSetupEncode
expr_stmt|;
name|tif
operator|->
name|tif_preencode
operator|=
name|OJPEGPreEncode
expr_stmt|;
name|tif
operator|->
name|tif_postencode
operator|=
name|OJPEGPostEncode
expr_stmt|;
name|tif
operator|->
name|tif_encoderow
operator|=
name|OJPEGEncode
expr_stmt|;
name|tif
operator|->
name|tif_encodestrip
operator|=
name|OJPEGEncode
expr_stmt|;
name|tif
operator|->
name|tif_encodetile
operator|=
name|OJPEGEncode
expr_stmt|;
name|tif
operator|->
name|tif_cleanup
operator|=
name|OJPEGCleanup
expr_stmt|;
name|tif
operator|->
name|tif_data
operator|=
operator|(
name|tidata_t
operator|)
name|sp
expr_stmt|;
comment|/* tif tag methods */
name|sp
operator|->
name|vgetparent
operator|=
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vgetfield
expr_stmt|;
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vgetfield
operator|=
name|OJPEGVGetField
expr_stmt|;
name|sp
operator|->
name|vsetparent
operator|=
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vsetfield
expr_stmt|;
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vsetfield
operator|=
name|OJPEGVSetField
expr_stmt|;
name|tif
operator|->
name|tif_tagmethods
operator|.
name|printdir
operator|=
name|OJPEGPrintDir
expr_stmt|;
comment|/* Some OJPEG files don't have strip or tile offsets or bytecounts tags. 	   Some others do, but have totally meaningless or corrupt values 	   in these tags. In these cases, the JpegInterchangeFormat stream is 	   reliable. In any case, this decoder reads the compressed data itself, 	   from the most reliable locations, and we need to notify encapsulating 	   LibTiff not to read raw strips or tiles for us. */
name|tif
operator|->
name|tif_flags
operator||=
name|TIFF_NOREADRAW
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGVGetField
name|OJPEGVGetField
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|ttag_t
name|tag
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
switch|switch
condition|(
name|tag
condition|)
block|{
case|case
name|TIFFTAG_JPEGIFOFFSET
case|:
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
operator|*
argument_list|)
operator|=
operator|(
name|uint32
operator|)
name|sp
operator|->
name|jpeg_interchange_format
expr_stmt|;
break|break;
case|case
name|TIFFTAG_JPEGIFBYTECOUNT
case|:
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
operator|*
argument_list|)
operator|=
operator|(
name|uint32
operator|)
name|sp
operator|->
name|jpeg_interchange_format_length
expr_stmt|;
break|break;
case|case
name|TIFFTAG_YCBCRSUBSAMPLING
case|:
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect_done
operator|==
literal|0
condition|)
name|OJPEGSubsamplingCorrect
argument_list|(
name|tif
argument_list|)
expr_stmt|;
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint16
operator|*
argument_list|)
operator|=
operator|(
name|uint16
operator|)
name|sp
operator|->
name|subsampling_hor
expr_stmt|;
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint16
operator|*
argument_list|)
operator|=
operator|(
name|uint16
operator|)
name|sp
operator|->
name|subsampling_ver
expr_stmt|;
break|break;
case|case
name|TIFFTAG_JPEGQTABLES
case|:
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
operator|*
argument_list|)
operator|=
operator|(
name|uint32
operator|)
name|sp
operator|->
name|qtable_offset_count
expr_stmt|;
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|void
operator|*
operator|*
argument_list|)
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|qtable_offset
expr_stmt|;
break|break;
case|case
name|TIFFTAG_JPEGDCTABLES
case|:
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
operator|*
argument_list|)
operator|=
operator|(
name|uint32
operator|)
name|sp
operator|->
name|dctable_offset_count
expr_stmt|;
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|void
operator|*
operator|*
argument_list|)
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|dctable_offset
expr_stmt|;
break|break;
case|case
name|TIFFTAG_JPEGACTABLES
case|:
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
operator|*
argument_list|)
operator|=
operator|(
name|uint32
operator|)
name|sp
operator|->
name|actable_offset_count
expr_stmt|;
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|void
operator|*
operator|*
argument_list|)
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|actable_offset
expr_stmt|;
break|break;
case|case
name|TIFFTAG_JPEGPROC
case|:
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint16
operator|*
argument_list|)
operator|=
operator|(
name|uint16
operator|)
name|sp
operator|->
name|jpeg_proc
expr_stmt|;
break|break;
case|case
name|TIFFTAG_JPEGRESTARTINTERVAL
case|:
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint16
operator|*
argument_list|)
operator|=
name|sp
operator|->
name|restart_interval
expr_stmt|;
break|break;
default|default:
return|return
call|(
modifier|*
name|sp
operator|->
name|vgetparent
call|)
argument_list|(
name|tif
argument_list|,
name|tag
argument_list|,
name|ap
argument_list|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGVSetField
name|OJPEGVSetField
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|ttag_t
name|tag
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGVSetField"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint32
name|ma
decl_stmt|;
name|uint32
modifier|*
name|mb
decl_stmt|;
name|uint32
name|n
decl_stmt|;
switch|switch
condition|(
name|tag
condition|)
block|{
case|case
name|TIFFTAG_JPEGIFOFFSET
case|:
name|sp
operator|->
name|jpeg_interchange_format
operator|=
operator|(
name|toff_t
operator|)
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIFFTAG_JPEGIFBYTECOUNT
case|:
name|sp
operator|->
name|jpeg_interchange_format_length
operator|=
operator|(
name|toff_t
operator|)
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIFFTAG_YCBCRSUBSAMPLING
case|:
name|sp
operator|->
name|subsampling_tag
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|subsampling_hor
operator|=
operator|(
name|uint8
operator|)
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|sp
operator|->
name|subsampling_ver
operator|=
operator|(
name|uint8
operator|)
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|tif
operator|->
name|tif_dir
operator|.
name|td_ycbcrsubsampling
index|[
literal|0
index|]
operator|=
name|sp
operator|->
name|subsampling_hor
expr_stmt|;
name|tif
operator|->
name|tif_dir
operator|.
name|td_ycbcrsubsampling
index|[
literal|1
index|]
operator|=
name|sp
operator|->
name|subsampling_ver
expr_stmt|;
break|break;
case|case
name|TIFFTAG_JPEGQTABLES
case|:
name|ma
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
argument_list|)
expr_stmt|;
if|if
condition|(
name|ma
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ma
operator|>
literal|3
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"JpegQTables tag has incorrect count"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|qtable_offset_count
operator|=
operator|(
name|uint8
operator|)
name|ma
expr_stmt|;
name|mb
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
operator|*
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|ma
condition|;
name|n
operator|++
control|)
name|sp
operator|->
name|qtable_offset
index|[
name|n
index|]
operator|=
operator|(
name|toff_t
operator|)
name|mb
index|[
name|n
index|]
expr_stmt|;
block|}
break|break;
case|case
name|TIFFTAG_JPEGDCTABLES
case|:
name|ma
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
argument_list|)
expr_stmt|;
if|if
condition|(
name|ma
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ma
operator|>
literal|3
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"JpegDcTables tag has incorrect count"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|dctable_offset_count
operator|=
operator|(
name|uint8
operator|)
name|ma
expr_stmt|;
name|mb
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
operator|*
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|ma
condition|;
name|n
operator|++
control|)
name|sp
operator|->
name|dctable_offset
index|[
name|n
index|]
operator|=
operator|(
name|toff_t
operator|)
name|mb
index|[
name|n
index|]
expr_stmt|;
block|}
break|break;
case|case
name|TIFFTAG_JPEGACTABLES
case|:
name|ma
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
argument_list|)
expr_stmt|;
if|if
condition|(
name|ma
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ma
operator|>
literal|3
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"JpegAcTables tag has incorrect count"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|actable_offset_count
operator|=
operator|(
name|uint8
operator|)
name|ma
expr_stmt|;
name|mb
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
operator|*
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|ma
condition|;
name|n
operator|++
control|)
name|sp
operator|->
name|actable_offset
index|[
name|n
index|]
operator|=
operator|(
name|toff_t
operator|)
name|mb
index|[
name|n
index|]
expr_stmt|;
block|}
break|break;
case|case
name|TIFFTAG_JPEGPROC
case|:
name|sp
operator|->
name|jpeg_proc
operator|=
operator|(
name|uint8
operator|)
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIFFTAG_JPEGRESTARTINTERVAL
case|:
name|sp
operator|->
name|restart_interval
operator|=
operator|(
name|uint16
operator|)
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
call|(
modifier|*
name|sp
operator|->
name|vsetparent
call|)
argument_list|(
name|tif
argument_list|,
name|tag
argument_list|,
name|ap
argument_list|)
return|;
block|}
name|TIFFSetFieldBit
argument_list|(
name|tif
argument_list|,
name|_TIFFFieldWithTag
argument_list|(
name|tif
argument_list|,
name|tag
argument_list|)
operator|->
name|field_bit
argument_list|)
expr_stmt|;
name|tif
operator|->
name|tif_flags
operator||=
name|TIFF_DIRTYDIRECT
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGPrintDir
name|OJPEGPrintDir
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|FILE
modifier|*
name|fd
parameter_list|,
name|long
name|flags
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
name|m
decl_stmt|;
operator|(
name|void
operator|)
name|flags
expr_stmt|;
name|assert
argument_list|(
name|sp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|TIFFFieldSet
argument_list|(
name|tif
argument_list|,
name|FIELD_OJPEG_JPEGINTERCHANGEFORMAT
argument_list|)
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"  JpegInterchangeFormat: %lu\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|sp
operator|->
name|jpeg_interchange_format
argument_list|)
expr_stmt|;
if|if
condition|(
name|TIFFFieldSet
argument_list|(
name|tif
argument_list|,
name|FIELD_OJPEG_JPEGINTERCHANGEFORMATLENGTH
argument_list|)
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"  JpegInterchangeFormatLength: %lu\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|sp
operator|->
name|jpeg_interchange_format_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|TIFFFieldSet
argument_list|(
name|tif
argument_list|,
name|FIELD_OJPEG_JPEGQTABLES
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"  JpegQTables:"
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|sp
operator|->
name|qtable_offset_count
condition|;
name|m
operator|++
control|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|" %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|sp
operator|->
name|qtable_offset
index|[
name|m
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|TIFFFieldSet
argument_list|(
name|tif
argument_list|,
name|FIELD_OJPEG_JPEGDCTABLES
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"  JpegDcTables:"
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|sp
operator|->
name|dctable_offset_count
condition|;
name|m
operator|++
control|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|" %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|sp
operator|->
name|dctable_offset
index|[
name|m
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|TIFFFieldSet
argument_list|(
name|tif
argument_list|,
name|FIELD_OJPEG_JPEGACTABLES
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"  JpegAcTables:"
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|sp
operator|->
name|actable_offset_count
condition|;
name|m
operator|++
control|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|" %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|sp
operator|->
name|actable_offset
index|[
name|m
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|TIFFFieldSet
argument_list|(
name|tif
argument_list|,
name|FIELD_OJPEG_JPEGPROC
argument_list|)
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"  JpegProc: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|sp
operator|->
name|jpeg_proc
argument_list|)
expr_stmt|;
if|if
condition|(
name|TIFFFieldSet
argument_list|(
name|tif
argument_list|,
name|FIELD_OJPEG_JPEGRESTARTINTERVAL
argument_list|)
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"  JpegRestartInterval: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|sp
operator|->
name|restart_interval
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGSetupDecode
name|OJPEGSetupDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGSetupDecode"
decl_stmt|;
name|TIFFWarningExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Depreciated and troublesome old-style JPEG compression mode, please convert to new-style JPEG compression and notify vendor of writing software"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGPreDecode
name|OJPEGPreDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|tstrile_t
name|m
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect_done
operator|==
literal|0
condition|)
name|OJPEGSubsamplingCorrect
argument_list|(
name|tif
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|readheader_done
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|OJPEGReadHeaderInfo
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sp
operator|->
name|sos_end
index|[
name|s
index|]
operator|.
name|log
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|OJPEGReadSecondarySos
argument_list|(
name|tif
argument_list|,
name|s
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if isTiled
condition|(
name|tif
condition|)
name|m
operator|=
operator|(
name|tstrile_t
operator|)
name|tif
operator|->
name|tif_curtile
expr_stmt|;
else|else
name|m
operator|=
operator|(
name|tstrile_t
operator|)
name|tif
operator|->
name|tif_curstrip
expr_stmt|;
if|if
condition|(
operator|(
name|sp
operator|->
name|writeheader_done
operator|!=
literal|0
operator|)
operator|&&
operator|(
operator|(
name|sp
operator|->
name|write_cursample
operator|!=
name|s
operator|)
operator|||
operator|(
name|sp
operator|->
name|write_curstrile
operator|>
name|m
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|libjpeg_session_active
operator|!=
literal|0
condition|)
name|OJPEGLibjpegSessionAbort
argument_list|(
name|tif
argument_list|)
expr_stmt|;
name|sp
operator|->
name|writeheader_done
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|writeheader_done
operator|==
literal|0
condition|)
block|{
name|sp
operator|->
name|plane_sample_offset
operator|=
name|s
expr_stmt|;
name|sp
operator|->
name|write_cursample
operator|=
name|s
expr_stmt|;
name|sp
operator|->
name|write_curstrile
operator|=
name|s
operator|*
name|tif
operator|->
name|tif_dir
operator|.
name|td_stripsperimage
expr_stmt|;
if|if
condition|(
operator|(
name|sp
operator|->
name|in_buffer_file_pos_log
operator|==
literal|0
operator|)
operator|||
operator|(
name|sp
operator|->
name|in_buffer_file_pos
operator|-
name|sp
operator|->
name|in_buffer_togo
operator|!=
name|sp
operator|->
name|sos_end
index|[
name|s
index|]
operator|.
name|in_buffer_file_pos
operator|)
condition|)
block|{
name|sp
operator|->
name|in_buffer_source
operator|=
name|sp
operator|->
name|sos_end
index|[
name|s
index|]
operator|.
name|in_buffer_source
expr_stmt|;
name|sp
operator|->
name|in_buffer_next_strile
operator|=
name|sp
operator|->
name|sos_end
index|[
name|s
index|]
operator|.
name|in_buffer_next_strile
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_pos
operator|=
name|sp
operator|->
name|sos_end
index|[
name|s
index|]
operator|.
name|in_buffer_file_pos
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_pos_log
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_togo
operator|=
name|sp
operator|->
name|sos_end
index|[
name|s
index|]
operator|.
name|in_buffer_file_togo
expr_stmt|;
name|sp
operator|->
name|in_buffer_togo
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|in_buffer_cur
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|OJPEGWriteHeaderInfo
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
while|while
condition|(
name|sp
operator|->
name|write_curstrile
operator|<
name|m
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|libjpeg_jpeg_query_style
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|OJPEGPreDecodeSkipRaw
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|OJPEGPreDecodeSkipScanlines
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|write_curstrile
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGPreDecodeSkipRaw
name|OJPEGPreDecodeSkipRaw
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint32
name|m
decl_stmt|;
name|m
operator|=
name|sp
operator|->
name|lines_per_strile
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_state
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_clines
operator|-
name|sp
operator|->
name|subsampling_convert_state
operator|>=
name|m
condition|)
block|{
name|sp
operator|->
name|subsampling_convert_state
operator|+=
name|m
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_state
operator|==
name|sp
operator|->
name|subsampling_convert_clines
condition|)
name|sp
operator|->
name|subsampling_convert_state
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|m
operator|-=
name|sp
operator|->
name|subsampling_convert_clines
operator|-
name|sp
operator|->
name|subsampling_convert_state
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_state
operator|=
literal|0
expr_stmt|;
block|}
while|while
condition|(
name|m
operator|>=
name|sp
operator|->
name|subsampling_convert_clines
condition|)
block|{
if|if
condition|(
name|jpeg_read_raw_data_encap
argument_list|(
name|sp
argument_list|,
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|)
argument_list|,
name|sp
operator|->
name|subsampling_convert_ycbcrimage
argument_list|,
name|sp
operator|->
name|subsampling_ver
operator|*
literal|8
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|m
operator|-=
name|sp
operator|->
name|subsampling_convert_clines
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|jpeg_read_raw_data_encap
argument_list|(
name|sp
argument_list|,
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|)
argument_list|,
name|sp
operator|->
name|subsampling_convert_ycbcrimage
argument_list|,
name|sp
operator|->
name|subsampling_ver
operator|*
literal|8
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|subsampling_convert_state
operator|=
name|m
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGPreDecodeSkipScanlines
name|OJPEGPreDecodeSkipScanlines
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGPreDecodeSkipScanlines"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint32
name|m
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|skip_buffer
operator|==
name|NULL
condition|)
block|{
name|sp
operator|->
name|skip_buffer
operator|=
name|_TIFFmalloc
argument_list|(
name|sp
operator|->
name|bytes_per_line
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|skip_buffer
operator|==
name|NULL
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|sp
operator|->
name|lines_per_strile
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
name|jpeg_read_scanlines_encap
argument_list|(
name|sp
argument_list|,
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|)
argument_list|,
operator|&
name|sp
operator|->
name|skip_buffer
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGDecode
name|OJPEGDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|libjpeg_jpeg_query_style
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|OJPEGDecodeRaw
argument_list|(
name|tif
argument_list|,
name|buf
argument_list|,
name|cc
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|OJPEGDecodeScanlines
argument_list|(
name|tif
argument_list|,
name|buf
argument_list|,
name|cc
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGDecodeRaw
name|OJPEGDecodeRaw
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGDecodeRaw"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
modifier|*
name|m
decl_stmt|;
name|uint32
name|n
decl_stmt|;
name|uint8
modifier|*
name|oy
decl_stmt|;
name|uint8
modifier|*
name|ocb
decl_stmt|;
name|uint8
modifier|*
name|ocr
decl_stmt|;
name|uint8
modifier|*
name|p
decl_stmt|;
name|uint32
name|q
decl_stmt|;
name|uint8
modifier|*
name|r
decl_stmt|;
name|uint8
name|sx
decl_stmt|,
name|sy
decl_stmt|;
if|if
condition|(
name|cc
operator|%
name|sp
operator|->
name|bytes_per_line
operator|!=
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Fractional scanline not read"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|assert
argument_list|(
name|cc
operator|>
literal|0
argument_list|)
expr_stmt|;
name|m
operator|=
name|buf
expr_stmt|;
name|n
operator|=
name|cc
expr_stmt|;
do|do
block|{
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_state
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|jpeg_read_raw_data_encap
argument_list|(
name|sp
argument_list|,
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|)
argument_list|,
name|sp
operator|->
name|subsampling_convert_ycbcrimage
argument_list|,
name|sp
operator|->
name|subsampling_ver
operator|*
literal|8
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|oy
operator|=
name|sp
operator|->
name|subsampling_convert_ybuf
operator|+
name|sp
operator|->
name|subsampling_convert_state
operator|*
name|sp
operator|->
name|subsampling_ver
operator|*
name|sp
operator|->
name|subsampling_convert_ylinelen
expr_stmt|;
name|ocb
operator|=
name|sp
operator|->
name|subsampling_convert_cbbuf
operator|+
name|sp
operator|->
name|subsampling_convert_state
operator|*
name|sp
operator|->
name|subsampling_convert_clinelen
expr_stmt|;
name|ocr
operator|=
name|sp
operator|->
name|subsampling_convert_crbuf
operator|+
name|sp
operator|->
name|subsampling_convert_state
operator|*
name|sp
operator|->
name|subsampling_convert_clinelen
expr_stmt|;
name|p
operator|=
name|m
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sp
operator|->
name|subsampling_convert_clinelenout
condition|;
name|q
operator|++
control|)
block|{
name|r
operator|=
name|oy
expr_stmt|;
for|for
control|(
name|sy
operator|=
literal|0
init|;
name|sy
operator|<
name|sp
operator|->
name|subsampling_ver
condition|;
name|sy
operator|++
control|)
block|{
for|for
control|(
name|sx
operator|=
literal|0
init|;
name|sx
operator|<
name|sp
operator|->
name|subsampling_hor
condition|;
name|sx
operator|++
control|)
operator|*
name|p
operator|++
operator|=
operator|*
name|r
operator|++
expr_stmt|;
name|r
operator|+=
name|sp
operator|->
name|subsampling_convert_ylinelen
operator|-
name|sp
operator|->
name|subsampling_hor
expr_stmt|;
block|}
name|oy
operator|+=
name|sp
operator|->
name|subsampling_hor
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|*
name|ocb
operator|++
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|*
name|ocr
operator|++
expr_stmt|;
block|}
name|sp
operator|->
name|subsampling_convert_state
operator|++
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_state
operator|==
name|sp
operator|->
name|subsampling_convert_clines
condition|)
name|sp
operator|->
name|subsampling_convert_state
operator|=
literal|0
expr_stmt|;
name|m
operator|+=
name|sp
operator|->
name|bytes_per_line
expr_stmt|;
name|n
operator|-=
name|sp
operator|->
name|bytes_per_line
expr_stmt|;
block|}
do|while
condition|(
name|n
operator|>
literal|0
condition|)
do|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGDecodeScanlines
name|OJPEGDecodeScanlines
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGDecodeScanlines"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
modifier|*
name|m
decl_stmt|;
name|uint32
name|n
decl_stmt|;
if|if
condition|(
name|cc
operator|%
name|sp
operator|->
name|bytes_per_line
operator|!=
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Fractional scanline not read"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|assert
argument_list|(
name|cc
operator|>
literal|0
argument_list|)
expr_stmt|;
name|m
operator|=
name|buf
expr_stmt|;
name|n
operator|=
name|cc
expr_stmt|;
do|do
block|{
if|if
condition|(
name|jpeg_read_scanlines_encap
argument_list|(
name|sp
argument_list|,
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|)
argument_list|,
operator|&
name|m
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|m
operator|+=
name|sp
operator|->
name|bytes_per_line
expr_stmt|;
name|n
operator|-=
name|sp
operator|->
name|bytes_per_line
expr_stmt|;
block|}
do|while
condition|(
name|n
operator|>
literal|0
condition|)
do|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGPostDecode
name|OJPEGPostDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
operator|(
name|void
operator|)
name|buf
expr_stmt|;
operator|(
name|void
operator|)
name|cc
expr_stmt|;
name|sp
operator|->
name|write_curstrile
operator|++
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|write_curstrile
operator|%
name|tif
operator|->
name|tif_dir
operator|.
name|td_stripsperimage
operator|==
literal|0
condition|)
block|{
name|assert
argument_list|(
name|sp
operator|->
name|libjpeg_session_active
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|OJPEGLibjpegSessionAbort
argument_list|(
name|tif
argument_list|)
expr_stmt|;
name|sp
operator|->
name|writeheader_done
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGSetupEncode
name|OJPEGSetupEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGSetupEncode"
decl_stmt|;
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"OJPEG encoding not supported; use new-style JPEG compression instead"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGPreEncode
name|OJPEGPreEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGPreEncode"
decl_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"OJPEG encoding not supported; use new-style JPEG compression instead"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGEncode
name|OJPEGEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|buf
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGEncode"
decl_stmt|;
operator|(
name|void
operator|)
name|buf
expr_stmt|;
operator|(
name|void
operator|)
name|cc
expr_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"OJPEG encoding not supported; use new-style JPEG compression instead"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGPostEncode
name|OJPEGPostEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGPostEncode"
decl_stmt|;
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"OJPEG encoding not supported; use new-style JPEG compression instead"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGCleanup
name|OJPEGCleanup
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
if|if
condition|(
name|sp
operator|!=
literal|0
condition|)
block|{
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vgetfield
operator|=
name|sp
operator|->
name|vgetparent
expr_stmt|;
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vsetfield
operator|=
name|sp
operator|->
name|vsetparent
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|qtable
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|qtable
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|qtable
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|qtable
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|qtable
index|[
literal|2
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|qtable
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|qtable
index|[
literal|3
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|qtable
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|dctable
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|dctable
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|dctable
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|dctable
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|dctable
index|[
literal|2
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|dctable
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|dctable
index|[
literal|3
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|dctable
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|actable
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|actable
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|actable
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|actable
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|actable
index|[
literal|2
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|actable
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|actable
index|[
literal|3
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|actable
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|libjpeg_session_active
operator|!=
literal|0
condition|)
name|OJPEGLibjpegSessionAbort
argument_list|(
name|tif
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_ycbcrbuf
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|subsampling_convert_ycbcrbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_ycbcrimage
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|subsampling_convert_ycbcrimage
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|skip_buffer
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|skip_buffer
argument_list|)
expr_stmt|;
name|_TIFFfree
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|tif
operator|->
name|tif_data
operator|=
name|NULL
expr_stmt|;
name|_TIFFSetDefaultCompressionState
argument_list|(
name|tif
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGSubsamplingCorrect
name|OJPEGSubsamplingCorrect
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGSubsamplingCorrect"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
name|mh
decl_stmt|;
name|uint8
name|mv
decl_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|subsamplingcorrect_done
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tif
operator|->
name|tif_dir
operator|.
name|td_samplesperpixel
operator|!=
literal|3
operator|)
operator|||
operator|(
operator|(
name|tif
operator|->
name|tif_dir
operator|.
name|td_photometric
operator|!=
name|PHOTOMETRIC_YCBCR
operator|)
operator|&&
operator|(
name|tif
operator|->
name|tif_dir
operator|.
name|td_photometric
operator|!=
name|PHOTOMETRIC_ITULAB
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsampling_tag
operator|!=
literal|0
condition|)
name|TIFFWarningExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Subsampling tag not appropriate for this Photometric and/or SamplesPerPixel"
argument_list|)
expr_stmt|;
name|sp
operator|->
name|subsampling_hor
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|subsampling_ver
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|subsampling_force_desubsampling_inside_decompression
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|sp
operator|->
name|subsamplingcorrect_done
operator|=
literal|1
expr_stmt|;
name|mh
operator|=
name|sp
operator|->
name|subsampling_hor
expr_stmt|;
name|mv
operator|=
name|sp
operator|->
name|subsampling_ver
expr_stmt|;
name|sp
operator|->
name|subsamplingcorrect
operator|=
literal|1
expr_stmt|;
name|OJPEGReadHeaderInfoSec
argument_list|(
name|tif
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_force_desubsampling_inside_decompression
operator|!=
literal|0
condition|)
block|{
name|sp
operator|->
name|subsampling_hor
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|subsampling_ver
operator|=
literal|1
expr_stmt|;
block|}
name|sp
operator|->
name|subsamplingcorrect
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|sp
operator|->
name|subsampling_hor
operator|!=
name|mh
operator|)
operator|||
operator|(
name|sp
operator|->
name|subsampling_ver
operator|!=
name|mv
operator|)
operator|)
operator|&&
operator|(
name|sp
operator|->
name|subsampling_force_desubsampling_inside_decompression
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsampling_tag
operator|==
literal|0
condition|)
name|TIFFWarningExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Subsampling tag is not set, yet subsampling inside JPEG data [%d,%d] does not match default values [2,2]; assuming subsampling inside JPEG data is correct"
argument_list|,
name|sp
operator|->
name|subsampling_hor
argument_list|,
name|sp
operator|->
name|subsampling_ver
argument_list|)
expr_stmt|;
else|else
name|TIFFWarningExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Subsampling inside JPEG data [%d,%d] does not match subsampling tag values [%d,%d]; assuming subsampling inside JPEG data is correct"
argument_list|,
name|sp
operator|->
name|subsampling_hor
argument_list|,
name|sp
operator|->
name|subsampling_ver
argument_list|,
name|mh
argument_list|,
name|mv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|subsampling_force_desubsampling_inside_decompression
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsampling_tag
operator|==
literal|0
condition|)
name|TIFFWarningExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Subsampling tag is not set, yet subsampling inside JPEG data does not match default values [2,2] (nor any other values allowed in TIFF); assuming subsampling inside JPEG data is correct and desubsampling inside JPEG decompression"
argument_list|)
expr_stmt|;
else|else
name|TIFFWarningExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Subsampling inside JPEG data does not match subsampling tag values [%d,%d] (nor any other values allowed in TIFF); assuming subsampling inside JPEG data is correct and desubsampling inside JPEG decompression"
argument_list|,
name|mh
argument_list|,
name|mv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|subsampling_force_desubsampling_inside_decompression
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsampling_hor
operator|<
name|sp
operator|->
name|subsampling_ver
condition|)
name|TIFFWarningExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Subsampling values [%d,%d] are not allowed in TIFF"
argument_list|,
name|sp
operator|->
name|subsampling_hor
argument_list|,
name|sp
operator|->
name|subsampling_ver
argument_list|)
expr_stmt|;
block|}
block|}
name|sp
operator|->
name|subsamplingcorrect_done
operator|=
literal|1
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfo
name|OJPEGReadHeaderInfo
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfo"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|readheader_done
operator|==
literal|0
argument_list|)
expr_stmt|;
name|sp
operator|->
name|image_width
operator|=
name|tif
operator|->
name|tif_dir
operator|.
name|td_imagewidth
expr_stmt|;
name|sp
operator|->
name|image_length
operator|=
name|tif
operator|->
name|tif_dir
operator|.
name|td_imagelength
expr_stmt|;
if|if isTiled
condition|(
name|tif
condition|)
block|{
name|sp
operator|->
name|strile_width
operator|=
name|tif
operator|->
name|tif_dir
operator|.
name|td_tilewidth
expr_stmt|;
name|sp
operator|->
name|strile_length
operator|=
name|tif
operator|->
name|tif_dir
operator|.
name|td_tilelength
expr_stmt|;
name|sp
operator|->
name|strile_length_total
operator|=
operator|(
operator|(
name|sp
operator|->
name|image_length
operator|+
name|sp
operator|->
name|strile_length
operator|-
literal|1
operator|)
operator|/
name|sp
operator|->
name|strile_length
operator|)
operator|*
name|sp
operator|->
name|strile_length
expr_stmt|;
block|}
else|else
block|{
name|sp
operator|->
name|strile_width
operator|=
name|sp
operator|->
name|image_width
expr_stmt|;
name|sp
operator|->
name|strile_length
operator|=
name|tif
operator|->
name|tif_dir
operator|.
name|td_rowsperstrip
expr_stmt|;
name|sp
operator|->
name|strile_length_total
operator|=
name|sp
operator|->
name|image_length
expr_stmt|;
block|}
name|sp
operator|->
name|samples_per_pixel
operator|=
name|tif
operator|->
name|tif_dir
operator|.
name|td_samplesperpixel
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|samples_per_pixel
operator|==
literal|1
condition|)
block|{
name|sp
operator|->
name|plane_sample_offset
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|=
name|sp
operator|->
name|samples_per_pixel
expr_stmt|;
name|sp
operator|->
name|subsampling_hor
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|subsampling_ver
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sp
operator|->
name|samples_per_pixel
operator|!=
literal|3
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"SamplesPerPixel %d not supported for this compression scheme"
argument_list|,
name|sp
operator|->
name|samples_per_pixel
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|plane_sample_offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tif
operator|->
name|tif_dir
operator|.
name|td_planarconfig
operator|==
name|PLANARCONFIG_CONTIG
condition|)
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|=
literal|3
expr_stmt|;
else|else
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|strile_length
operator|<
name|sp
operator|->
name|image_length
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|strile_length
operator|%
operator|(
name|sp
operator|->
name|subsampling_ver
operator|*
literal|8
operator|)
operator|!=
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Incompatible vertical subsampling and image strip/tile length"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|restart_interval
operator|=
operator|(
operator|(
name|sp
operator|->
name|strile_width
operator|+
name|sp
operator|->
name|subsampling_hor
operator|*
literal|8
operator|-
literal|1
operator|)
operator|/
operator|(
name|sp
operator|->
name|subsampling_hor
operator|*
literal|8
operator|)
operator|)
operator|*
operator|(
name|sp
operator|->
name|strile_length
operator|/
operator|(
name|sp
operator|->
name|subsampling_ver
operator|*
literal|8
operator|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|OJPEGReadHeaderInfoSec
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|sos_end
index|[
literal|0
index|]
operator|.
name|log
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|sos_end
index|[
literal|0
index|]
operator|.
name|in_buffer_source
operator|=
name|sp
operator|->
name|in_buffer_source
expr_stmt|;
name|sp
operator|->
name|sos_end
index|[
literal|0
index|]
operator|.
name|in_buffer_next_strile
operator|=
name|sp
operator|->
name|in_buffer_next_strile
expr_stmt|;
name|sp
operator|->
name|sos_end
index|[
literal|0
index|]
operator|.
name|in_buffer_file_pos
operator|=
name|sp
operator|->
name|in_buffer_file_pos
operator|-
name|sp
operator|->
name|in_buffer_togo
expr_stmt|;
name|sp
operator|->
name|sos_end
index|[
literal|0
index|]
operator|.
name|in_buffer_file_togo
operator|=
name|sp
operator|->
name|in_buffer_file_togo
operator|+
name|sp
operator|->
name|in_buffer_togo
expr_stmt|;
name|sp
operator|->
name|readheader_done
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadSecondarySos
name|OJPEGReadSecondarySos
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
name|m
decl_stmt|;
name|assert
argument_list|(
name|s
operator|>
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|s
operator|<
literal|3
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|sos_end
index|[
literal|0
index|]
operator|.
name|log
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|sos_end
index|[
name|s
index|]
operator|.
name|log
operator|==
literal|0
argument_list|)
expr_stmt|;
name|sp
operator|->
name|plane_sample_offset
operator|=
name|s
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|log
operator|==
literal|0
condition|)
name|sp
operator|->
name|plane_sample_offset
operator|--
expr_stmt|;
name|sp
operator|->
name|in_buffer_source
operator|=
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|in_buffer_source
expr_stmt|;
name|sp
operator|->
name|in_buffer_next_strile
operator|=
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|in_buffer_next_strile
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_pos
operator|=
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|in_buffer_file_pos
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_pos_log
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_togo
operator|=
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|in_buffer_file_togo
expr_stmt|;
name|sp
operator|->
name|in_buffer_togo
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|in_buffer_cur
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|sp
operator|->
name|plane_sample_offset
operator|<
name|s
condition|)
block|{
do|do
block|{
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|m
operator|==
literal|255
condition|)
block|{
do|do
block|{
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|m
operator|!=
literal|255
condition|)
break|break;
block|}
do|while
condition|(
literal|1
condition|)
do|;
if|if
condition|(
name|m
operator|==
name|JPEG_MARKER_SOS
condition|)
break|break;
block|}
block|}
do|while
condition|(
literal|1
condition|)
do|;
name|sp
operator|->
name|plane_sample_offset
operator|++
expr_stmt|;
if|if
condition|(
name|OJPEGReadHeaderInfoSecStreamSos
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|log
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|in_buffer_source
operator|=
name|sp
operator|->
name|in_buffer_source
expr_stmt|;
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|in_buffer_next_strile
operator|=
name|sp
operator|->
name|in_buffer_next_strile
expr_stmt|;
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|in_buffer_file_pos
operator|=
name|sp
operator|->
name|in_buffer_file_pos
operator|-
name|sp
operator|->
name|in_buffer_togo
expr_stmt|;
name|sp
operator|->
name|sos_end
index|[
name|sp
operator|->
name|plane_sample_offset
index|]
operator|.
name|in_buffer_file_togo
operator|=
name|sp
operator|->
name|in_buffer_file_togo
operator|+
name|sp
operator|->
name|in_buffer_togo
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGWriteHeaderInfo
name|OJPEGWriteHeaderInfo
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGWriteHeaderInfo"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
modifier|*
modifier|*
name|m
decl_stmt|;
name|uint32
name|n
decl_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|libjpeg_session_active
operator|==
literal|0
argument_list|)
expr_stmt|;
name|sp
operator|->
name|out_state
operator|=
name|ososSoi
expr_stmt|;
name|sp
operator|->
name|restart_index
operator|=
literal|0
expr_stmt|;
name|jpeg_std_error
argument_list|(
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_error_mgr
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_error_mgr
operator|.
name|output_message
operator|=
name|OJPEGLibjpegJpegErrorMgrOutputMessage
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_error_mgr
operator|.
name|error_exit
operator|=
name|OJPEGLibjpegJpegErrorMgrErrorExit
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|.
name|err
operator|=
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_error_mgr
operator|)
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|.
name|client_data
operator|=
operator|(
name|void
operator|*
operator|)
name|tif
expr_stmt|;
if|if
condition|(
name|jpeg_create_decompress_encap
argument_list|(
name|sp
argument_list|,
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|)
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|libjpeg_session_active
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_source_mgr
operator|.
name|bytes_in_buffer
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_source_mgr
operator|.
name|init_source
operator|=
name|OJPEGLibjpegJpegSourceMgrInitSource
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_source_mgr
operator|.
name|fill_input_buffer
operator|=
name|OJPEGLibjpegJpegSourceMgrFillInputBuffer
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_source_mgr
operator|.
name|skip_input_data
operator|=
name|OJPEGLibjpegJpegSourceMgrSkipInputData
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_source_mgr
operator|.
name|resync_to_restart
operator|=
name|OJPEGLibjpegJpegSourceMgrResyncToRestart
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_source_mgr
operator|.
name|term_source
operator|=
name|OJPEGLibjpegJpegSourceMgrTermSource
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|.
name|src
operator|=
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_source_mgr
operator|)
expr_stmt|;
if|if
condition|(
name|jpeg_read_header_encap
argument_list|(
name|sp
argument_list|,
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|)
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|sp
operator|->
name|subsampling_force_desubsampling_inside_decompression
operator|==
literal|0
operator|)
operator|&&
operator|(
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|>
literal|1
operator|)
condition|)
block|{
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|.
name|raw_data_out
operator|=
literal|1
expr_stmt|;
if|#
directive|if
name|JPEG_LIB_VERSION
operator|>=
literal|70
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|.
name|do_fancy_upsampling
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
name|sp
operator|->
name|libjpeg_jpeg_query_style
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_log
operator|==
literal|0
condition|)
block|{
name|assert
argument_list|(
name|sp
operator|->
name|subsampling_convert_ycbcrbuf
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|subsampling_convert_ycbcrimage
operator|==
literal|0
argument_list|)
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_ylinelen
operator|=
operator|(
operator|(
name|sp
operator|->
name|strile_width
operator|+
name|sp
operator|->
name|subsampling_hor
operator|*
literal|8
operator|-
literal|1
operator|)
operator|/
operator|(
name|sp
operator|->
name|subsampling_hor
operator|*
literal|8
operator|)
operator|*
name|sp
operator|->
name|subsampling_hor
operator|*
literal|8
operator|)
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_ylines
operator|=
name|sp
operator|->
name|subsampling_ver
operator|*
literal|8
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_clinelen
operator|=
name|sp
operator|->
name|subsampling_convert_ylinelen
operator|/
name|sp
operator|->
name|subsampling_hor
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_clines
operator|=
literal|8
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_ybuflen
operator|=
name|sp
operator|->
name|subsampling_convert_ylinelen
operator|*
name|sp
operator|->
name|subsampling_convert_ylines
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_cbuflen
operator|=
name|sp
operator|->
name|subsampling_convert_clinelen
operator|*
name|sp
operator|->
name|subsampling_convert_clines
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_ycbcrbuflen
operator|=
name|sp
operator|->
name|subsampling_convert_ybuflen
operator|+
literal|2
operator|*
name|sp
operator|->
name|subsampling_convert_cbuflen
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_ycbcrbuf
operator|=
name|_TIFFmalloc
argument_list|(
name|sp
operator|->
name|subsampling_convert_ycbcrbuflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_ycbcrbuf
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|subsampling_convert_ybuf
operator|=
name|sp
operator|->
name|subsampling_convert_ycbcrbuf
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_cbbuf
operator|=
name|sp
operator|->
name|subsampling_convert_ybuf
operator|+
name|sp
operator|->
name|subsampling_convert_ybuflen
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_crbuf
operator|=
name|sp
operator|->
name|subsampling_convert_cbbuf
operator|+
name|sp
operator|->
name|subsampling_convert_cbuflen
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_ycbcrimagelen
operator|=
literal|3
operator|+
name|sp
operator|->
name|subsampling_convert_ylines
operator|+
literal|2
operator|*
name|sp
operator|->
name|subsampling_convert_clines
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_ycbcrimage
operator|=
name|_TIFFmalloc
argument_list|(
name|sp
operator|->
name|subsampling_convert_ycbcrimagelen
operator|*
sizeof|sizeof
argument_list|(
name|uint8
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_convert_ycbcrimage
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|m
operator|=
name|sp
operator|->
name|subsampling_convert_ycbcrimage
expr_stmt|;
operator|*
name|m
operator|++
operator|=
operator|(
name|uint8
operator|*
operator|)
operator|(
name|sp
operator|->
name|subsampling_convert_ycbcrimage
operator|+
literal|3
operator|)
expr_stmt|;
operator|*
name|m
operator|++
operator|=
operator|(
name|uint8
operator|*
operator|)
operator|(
name|sp
operator|->
name|subsampling_convert_ycbcrimage
operator|+
literal|3
operator|+
name|sp
operator|->
name|subsampling_convert_ylines
operator|)
expr_stmt|;
operator|*
name|m
operator|++
operator|=
operator|(
name|uint8
operator|*
operator|)
operator|(
name|sp
operator|->
name|subsampling_convert_ycbcrimage
operator|+
literal|3
operator|+
name|sp
operator|->
name|subsampling_convert_ylines
operator|+
name|sp
operator|->
name|subsampling_convert_clines
operator|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|sp
operator|->
name|subsampling_convert_ylines
condition|;
name|n
operator|++
control|)
operator|*
name|m
operator|++
operator|=
name|sp
operator|->
name|subsampling_convert_ybuf
operator|+
name|n
operator|*
name|sp
operator|->
name|subsampling_convert_ylinelen
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|sp
operator|->
name|subsampling_convert_clines
condition|;
name|n
operator|++
control|)
operator|*
name|m
operator|++
operator|=
name|sp
operator|->
name|subsampling_convert_cbbuf
operator|+
name|n
operator|*
name|sp
operator|->
name|subsampling_convert_clinelen
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|sp
operator|->
name|subsampling_convert_clines
condition|;
name|n
operator|++
control|)
operator|*
name|m
operator|++
operator|=
name|sp
operator|->
name|subsampling_convert_crbuf
operator|+
name|n
operator|*
name|sp
operator|->
name|subsampling_convert_clinelen
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_clinelenout
operator|=
operator|(
operator|(
name|sp
operator|->
name|strile_width
operator|+
name|sp
operator|->
name|subsampling_hor
operator|-
literal|1
operator|)
operator|/
name|sp
operator|->
name|subsampling_hor
operator|)
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_state
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|bytes_per_line
operator|=
name|sp
operator|->
name|subsampling_convert_clinelenout
operator|*
operator|(
name|sp
operator|->
name|subsampling_ver
operator|*
name|sp
operator|->
name|subsampling_hor
operator|+
literal|2
operator|)
expr_stmt|;
name|sp
operator|->
name|lines_per_strile
operator|=
operator|(
operator|(
name|sp
operator|->
name|strile_length
operator|+
name|sp
operator|->
name|subsampling_ver
operator|-
literal|1
operator|)
operator|/
name|sp
operator|->
name|subsampling_ver
operator|)
expr_stmt|;
name|sp
operator|->
name|subsampling_convert_log
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|.
name|jpeg_color_space
operator|=
name|JCS_UNKNOWN
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|.
name|out_color_space
operator|=
name|JCS_UNKNOWN
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_query_style
operator|=
literal|1
expr_stmt|;
name|sp
operator|->
name|bytes_per_line
operator|=
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
name|sp
operator|->
name|strile_width
expr_stmt|;
name|sp
operator|->
name|lines_per_strile
operator|=
name|sp
operator|->
name|strile_length
expr_stmt|;
block|}
if|if
condition|(
name|jpeg_start_decompress_encap
argument_list|(
name|sp
argument_list|,
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|)
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|writeheader_done
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGLibjpegSessionAbort
name|OJPEGLibjpegSessionAbort
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|libjpeg_session_active
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|jpeg_destroy
argument_list|(
operator|(
name|jpeg_common_struct
operator|*
operator|)
operator|(
operator|&
operator|(
name|sp
operator|->
name|libjpeg_jpeg_decompress_struct
operator|)
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|->
name|libjpeg_session_active
operator|=
literal|0
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfoSec
name|OJPEGReadHeaderInfoSec
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfoSec"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
name|m
decl_stmt|;
name|uint16
name|n
decl_stmt|;
name|uint8
name|o
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|file_size
operator|==
literal|0
condition|)
name|sp
operator|->
name|file_size
operator|=
name|TIFFGetFileSize
argument_list|(
name|tif
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|jpeg_interchange_format
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|jpeg_interchange_format
operator|>=
name|sp
operator|->
name|file_size
condition|)
block|{
name|sp
operator|->
name|jpeg_interchange_format
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|jpeg_interchange_format_length
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|sp
operator|->
name|jpeg_interchange_format_length
operator|==
literal|0
operator|)
operator|||
operator|(
name|sp
operator|->
name|jpeg_interchange_format
operator|+
name|sp
operator|->
name|jpeg_interchange_format_length
operator|>
name|sp
operator|->
name|file_size
operator|)
condition|)
name|sp
operator|->
name|jpeg_interchange_format_length
operator|=
name|sp
operator|->
name|file_size
operator|-
name|sp
operator|->
name|jpeg_interchange_format
expr_stmt|;
block|}
block|}
name|sp
operator|->
name|in_buffer_source
operator|=
name|osibsNotSetYet
expr_stmt|;
name|sp
operator|->
name|in_buffer_next_strile
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|in_buffer_strile_count
operator|=
name|tif
operator|->
name|tif_dir
operator|.
name|td_nstrips
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_togo
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|in_buffer_togo
operator|=
literal|0
expr_stmt|;
do|do
block|{
if|if
condition|(
name|OJPEGReadBytePeek
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|m
operator|!=
literal|255
condition|)
break|break;
name|OJPEGReadByteAdvance
argument_list|(
name|sp
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
do|while
condition|(
name|m
operator|==
literal|255
condition|)
do|;
switch|switch
condition|(
name|m
condition|)
block|{
case|case
name|JPEG_MARKER_SOI
case|:
comment|/* this type of marker has no data, and should be skipped */
break|break;
case|case
name|JPEG_MARKER_COM
case|:
case|case
name|JPEG_MARKER_APP0
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|1
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|2
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|3
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|4
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|5
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|6
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|7
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|8
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|9
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|10
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|11
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|12
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|13
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|14
case|:
case|case
name|JPEG_MARKER_APP0
operator|+
literal|15
case|:
comment|/* this type of marker has data, but it has no use to us (and no place here) and should be skipped */
if|if
condition|(
name|OJPEGReadWord
argument_list|(
name|sp
argument_list|,
operator|&
name|n
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|n
operator|<
literal|2
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|n
operator|>
literal|2
condition|)
name|OJPEGReadSkip
argument_list|(
name|sp
argument_list|,
name|n
operator|-
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
name|JPEG_MARKER_DRI
case|:
if|if
condition|(
name|OJPEGReadHeaderInfoSecStreamDri
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|JPEG_MARKER_DQT
case|:
if|if
condition|(
name|OJPEGReadHeaderInfoSecStreamDqt
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|JPEG_MARKER_DHT
case|:
if|if
condition|(
name|OJPEGReadHeaderInfoSecStreamDht
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|JPEG_MARKER_SOF0
case|:
case|case
name|JPEG_MARKER_SOF1
case|:
case|case
name|JPEG_MARKER_SOF3
case|:
if|if
condition|(
name|OJPEGReadHeaderInfoSecStreamSof
argument_list|(
name|tif
argument_list|,
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|!=
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
break|break;
case|case
name|JPEG_MARKER_SOS
case|:
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|!=
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|assert
argument_list|(
name|sp
operator|->
name|plane_sample_offset
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|OJPEGReadHeaderInfoSecStreamSos
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
default|default:
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Unknown marker type %d in JPEG data"
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
do|while
condition|(
name|m
operator|!=
name|JPEG_MARKER_SOS
condition|)
do|;
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|sp
operator|->
name|sof_log
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|OJPEGReadHeaderInfoSecTablesQTable
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|sof_marker_id
operator|=
name|JPEG_MARKER_SOF0
expr_stmt|;
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|sp
operator|->
name|samples_per_pixel
condition|;
name|o
operator|++
control|)
name|sp
operator|->
name|sof_c
index|[
name|o
index|]
operator|=
name|o
expr_stmt|;
name|sp
operator|->
name|sof_hv
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|sp
operator|->
name|subsampling_hor
operator|<<
literal|4
operator|)
operator||
name|sp
operator|->
name|subsampling_ver
operator|)
expr_stmt|;
for|for
control|(
name|o
operator|=
literal|1
init|;
name|o
operator|<
name|sp
operator|->
name|samples_per_pixel
condition|;
name|o
operator|++
control|)
name|sp
operator|->
name|sof_hv
index|[
name|o
index|]
operator|=
literal|17
expr_stmt|;
name|sp
operator|->
name|sof_x
operator|=
name|sp
operator|->
name|strile_width
expr_stmt|;
name|sp
operator|->
name|sof_y
operator|=
name|sp
operator|->
name|strile_length_total
expr_stmt|;
name|sp
operator|->
name|sof_log
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|OJPEGReadHeaderInfoSecTablesDcTable
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|OJPEGReadHeaderInfoSecTablesAcTable
argument_list|(
name|tif
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|o
operator|=
literal|1
init|;
name|o
operator|<
name|sp
operator|->
name|samples_per_pixel
condition|;
name|o
operator|++
control|)
name|sp
operator|->
name|sos_cs
index|[
name|o
index|]
operator|=
name|o
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfoSecStreamDri
name|OJPEGReadHeaderInfoSecStreamDri
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
comment|/* this could easilly cause trouble in some cases... but no such cases have occured sofar */
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfoSecStreamDri"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint16
name|m
decl_stmt|;
if|if
condition|(
name|OJPEGReadWord
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|m
operator|!=
literal|4
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt DRI marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|OJPEGReadWord
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|restart_interval
operator|=
name|m
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfoSecStreamDqt
name|OJPEGReadHeaderInfoSecStreamDqt
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
comment|/* this is a table marker, and it is to be saved as a whole for exact pushing on the jpeg stream later on */
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfoSecStreamDqt"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint16
name|m
decl_stmt|;
name|uint32
name|na
decl_stmt|;
name|uint8
modifier|*
name|nb
decl_stmt|;
name|uint8
name|o
decl_stmt|;
if|if
condition|(
name|OJPEGReadWord
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|m
operator|<=
literal|2
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt DQT marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|!=
literal|0
condition|)
name|OJPEGReadSkip
argument_list|(
name|sp
argument_list|,
name|m
operator|-
literal|2
argument_list|)
expr_stmt|;
else|else
block|{
name|m
operator|-=
literal|2
expr_stmt|;
do|do
block|{
if|if
condition|(
name|m
operator|<
literal|65
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt DQT marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|na
operator|=
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|69
expr_stmt|;
name|nb
operator|=
name|_TIFFmalloc
argument_list|(
name|na
argument_list|)
expr_stmt|;
if|if
condition|(
name|nb
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
operator|(
name|uint32
operator|*
operator|)
name|nb
operator|=
name|na
expr_stmt|;
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
index|]
operator|=
literal|255
expr_stmt|;
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|1
index|]
operator|=
name|JPEG_MARKER_DQT
expr_stmt|;
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|3
index|]
operator|=
literal|67
expr_stmt|;
if|if
condition|(
name|OJPEGReadBlock
argument_list|(
name|sp
argument_list|,
literal|65
argument_list|,
operator|&
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|4
index|]
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|o
operator|=
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|4
index|]
operator|&
literal|15
expr_stmt|;
if|if
condition|(
literal|3
operator|<
name|o
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt DQT marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sp
operator|->
name|qtable
index|[
name|o
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|qtable
index|[
name|o
index|]
argument_list|)
expr_stmt|;
name|sp
operator|->
name|qtable
index|[
name|o
index|]
operator|=
name|nb
expr_stmt|;
name|m
operator|-=
literal|65
expr_stmt|;
block|}
do|while
condition|(
name|m
operator|>
literal|0
condition|)
do|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfoSecStreamDht
name|OJPEGReadHeaderInfoSecStreamDht
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
comment|/* this is a table marker, and it is to be saved as a whole for exact pushing on the jpeg stream later on */
comment|/* TODO: the following assumes there is only one table in this marker... but i'm not quite sure that assumption is guaranteed correct */
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfoSecStreamDht"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint16
name|m
decl_stmt|;
name|uint32
name|na
decl_stmt|;
name|uint8
modifier|*
name|nb
decl_stmt|;
name|uint8
name|o
decl_stmt|;
if|if
condition|(
name|OJPEGReadWord
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|m
operator|<=
literal|2
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt DHT marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|!=
literal|0
condition|)
block|{
name|OJPEGReadSkip
argument_list|(
name|sp
argument_list|,
name|m
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|na
operator|=
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|2
operator|+
name|m
expr_stmt|;
name|nb
operator|=
name|_TIFFmalloc
argument_list|(
name|na
argument_list|)
expr_stmt|;
if|if
condition|(
name|nb
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
operator|(
name|uint32
operator|*
operator|)
name|nb
operator|=
name|na
expr_stmt|;
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
index|]
operator|=
literal|255
expr_stmt|;
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|1
index|]
operator|=
name|JPEG_MARKER_DHT
expr_stmt|;
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|2
index|]
operator|=
operator|(
name|m
operator|>>
literal|8
operator|)
expr_stmt|;
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|3
index|]
operator|=
operator|(
name|m
operator|&
literal|255
operator|)
expr_stmt|;
if|if
condition|(
name|OJPEGReadBlock
argument_list|(
name|sp
argument_list|,
name|m
operator|-
literal|2
argument_list|,
operator|&
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|4
index|]
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|o
operator|=
name|nb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|4
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|o
operator|&
literal|240
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
literal|3
operator|<
name|o
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt DHT marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sp
operator|->
name|dctable
index|[
name|o
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|dctable
index|[
name|o
index|]
argument_list|)
expr_stmt|;
name|sp
operator|->
name|dctable
index|[
name|o
index|]
operator|=
name|nb
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|o
operator|&
literal|240
operator|)
operator|!=
literal|16
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt DHT marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|o
operator|&=
literal|15
expr_stmt|;
if|if
condition|(
literal|3
operator|<
name|o
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt DHT marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sp
operator|->
name|actable
index|[
name|o
index|]
operator|!=
literal|0
condition|)
name|_TIFFfree
argument_list|(
name|sp
operator|->
name|actable
index|[
name|o
index|]
argument_list|)
expr_stmt|;
name|sp
operator|->
name|actable
index|[
name|o
index|]
operator|=
name|nb
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfoSecStreamSof
name|OJPEGReadHeaderInfoSecStreamSof
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|uint8
name|marker_id
parameter_list|)
block|{
comment|/* this marker needs to be checked, and part of its data needs to be saved for regeneration later on */
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfoSecStreamSof"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint16
name|m
decl_stmt|;
name|uint16
name|n
decl_stmt|;
name|uint8
name|o
decl_stmt|;
name|uint16
name|p
decl_stmt|;
name|uint16
name|q
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|sof_log
operator|!=
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|sp
operator|->
name|sof_marker_id
operator|=
name|marker_id
expr_stmt|;
comment|/* Lf: data length */
if|if
condition|(
name|OJPEGReadWord
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|m
operator|<
literal|11
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt SOF marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|m
operator|-=
literal|8
expr_stmt|;
if|if
condition|(
name|m
operator|%
literal|3
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt SOF marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|n
operator|=
name|m
operator|/
literal|3
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|n
operator|!=
name|sp
operator|->
name|samples_per_pixel
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"JPEG compressed data indicates unexpected number of samples"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
comment|/* P: Sample precision */
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|o
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|o
operator|!=
literal|8
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"JPEG compressed data indicates unexpected number of bits per sample"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Y: Number of lines, X: Number of samples per line */
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
condition|)
name|OJPEGReadSkip
argument_list|(
name|sp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* TODO: probably best to also add check on allowed upper bound, especially x, may cause buffer overflow otherwise i think */
comment|/* Y: Number of lines */
if|if
condition|(
name|OJPEGReadWord
argument_list|(
name|sp
argument_list|,
operator|&
name|p
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|<
name|sp
operator|->
name|image_length
operator|)
operator|&&
operator|(
name|p
operator|<
name|sp
operator|->
name|strile_length_total
operator|)
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"JPEG compressed data indicates unexpected height"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|sof_y
operator|=
name|p
expr_stmt|;
comment|/* X: Number of samples per line */
if|if
condition|(
name|OJPEGReadWord
argument_list|(
name|sp
argument_list|,
operator|&
name|p
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|<
name|sp
operator|->
name|image_width
operator|)
operator|&&
operator|(
name|p
operator|<
name|sp
operator|->
name|strile_width
operator|)
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"JPEG compressed data indicates unexpected width"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|sof_x
operator|=
name|p
expr_stmt|;
block|}
comment|/* Nf: Number of image components in frame */
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|o
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|o
operator|!=
name|n
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt SOF marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* per component stuff */
comment|/* TODO: double-check that flow implies that n cannot be as big as to make us overflow sof_c, sof_hv and sof_tq arrays */
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|n
condition|;
name|q
operator|++
control|)
block|{
comment|/* C: Component identifier */
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|o
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|sp
operator|->
name|sof_c
index|[
name|q
index|]
operator|=
name|o
expr_stmt|;
comment|/* H: Horizontal sampling factor, and V: Vertical sampling factor */
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|o
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|q
operator|==
literal|0
condition|)
block|{
name|sp
operator|->
name|subsampling_hor
operator|=
operator|(
name|o
operator|>>
literal|4
operator|)
expr_stmt|;
name|sp
operator|->
name|subsampling_ver
operator|=
operator|(
name|o
operator|&
literal|15
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|sp
operator|->
name|subsampling_hor
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|sp
operator|->
name|subsampling_hor
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|sp
operator|->
name|subsampling_hor
operator|!=
literal|4
operator|)
operator|)
operator|||
operator|(
operator|(
name|sp
operator|->
name|subsampling_ver
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|sp
operator|->
name|subsampling_ver
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|sp
operator|->
name|subsampling_ver
operator|!=
literal|4
operator|)
operator|)
condition|)
name|sp
operator|->
name|subsampling_force_desubsampling_inside_decompression
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|o
operator|!=
literal|17
condition|)
name|sp
operator|->
name|subsampling_force_desubsampling_inside_decompression
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|sp
operator|->
name|sof_hv
index|[
name|q
index|]
operator|=
name|o
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|subsampling_force_desubsampling_inside_decompression
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|q
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|o
operator|!=
operator|(
operator|(
name|sp
operator|->
name|subsampling_hor
operator|<<
literal|4
operator|)
operator||
name|sp
operator|->
name|subsampling_ver
operator|)
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"JPEG compressed data indicates unexpected subsampling values"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|o
operator|!=
literal|17
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"JPEG compressed data indicates unexpected subsampling values"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
block|}
comment|/* Tq: Quantization table destination selector */
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|o
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|sp
operator|->
name|sof_tq
index|[
name|q
index|]
operator|=
name|o
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
condition|)
name|sp
operator|->
name|sof_log
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfoSecStreamSos
name|OJPEGReadHeaderInfoSecStreamSos
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
comment|/* this marker needs to be checked, and part of its data needs to be saved for regeneration later on */
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfoSecStreamSos"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint16
name|m
decl_stmt|;
name|uint8
name|n
decl_stmt|;
name|uint8
name|o
decl_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|subsamplingcorrect
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|sof_log
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt SOS marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Ls */
if|if
condition|(
name|OJPEGReadWord
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|m
operator|!=
literal|6
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|2
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt SOS marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Ns */
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|n
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|n
operator|!=
name|sp
operator|->
name|samples_per_pixel_per_plane
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt SOS marker in JPEG data"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Cs, Td, and Ta */
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|sp
operator|->
name|samples_per_pixel_per_plane
condition|;
name|o
operator|++
control|)
block|{
comment|/* Cs */
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|n
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|sos_cs
index|[
name|sp
operator|->
name|plane_sample_offset
operator|+
name|o
index|]
operator|=
name|n
expr_stmt|;
comment|/* Td and Ta */
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|n
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|sos_tda
index|[
name|sp
operator|->
name|plane_sample_offset
operator|+
name|o
index|]
operator|=
name|n
expr_stmt|;
block|}
comment|/* skip Ss, Se, Ah, en Al -> no check, as per Tom Lane recommendation, as per LibJpeg source */
name|OJPEGReadSkip
argument_list|(
name|sp
argument_list|,
literal|3
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfoSecTablesQTable
name|OJPEGReadHeaderInfoSecTablesQTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfoSecTablesQTable"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
name|m
decl_stmt|;
name|uint8
name|n
decl_stmt|;
name|uint32
name|oa
decl_stmt|;
name|uint8
modifier|*
name|ob
decl_stmt|;
name|uint32
name|p
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|qtable_offset
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Missing JPEG tables"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|in_buffer_file_pos_log
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|sp
operator|->
name|samples_per_pixel
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|sp
operator|->
name|qtable_offset
index|[
name|m
index|]
operator|!=
literal|0
operator|)
operator|&&
operator|(
operator|(
name|m
operator|==
literal|0
operator|)
operator|||
operator|(
name|sp
operator|->
name|qtable_offset
index|[
name|m
index|]
operator|!=
name|sp
operator|->
name|qtable_offset
index|[
name|m
operator|-
literal|1
index|]
operator|)
operator|)
condition|)
block|{
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|m
operator|-
literal|1
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|qtable_offset
index|[
name|m
index|]
operator|==
name|sp
operator|->
name|qtable_offset
index|[
name|n
index|]
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt JpegQTables tag value"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|oa
operator|=
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|69
expr_stmt|;
name|ob
operator|=
name|_TIFFmalloc
argument_list|(
name|oa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ob
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
operator|(
name|uint32
operator|*
operator|)
name|ob
operator|=
name|oa
expr_stmt|;
name|ob
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
index|]
operator|=
literal|255
expr_stmt|;
name|ob
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|1
index|]
operator|=
name|JPEG_MARKER_DQT
expr_stmt|;
name|ob
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ob
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|3
index|]
operator|=
literal|67
expr_stmt|;
name|ob
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|4
index|]
operator|=
name|m
expr_stmt|;
name|TIFFSeekFile
argument_list|(
name|tif
argument_list|,
name|sp
operator|->
name|qtable_offset
index|[
name|m
index|]
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|p
operator|=
name|TIFFReadFile
argument_list|(
name|tif
argument_list|,
operator|&
name|ob
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|5
index|]
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
literal|64
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|qtable
index|[
name|m
index|]
operator|=
name|ob
expr_stmt|;
name|sp
operator|->
name|sof_tq
index|[
name|m
index|]
operator|=
name|m
expr_stmt|;
block|}
else|else
name|sp
operator|->
name|sof_tq
index|[
name|m
index|]
operator|=
name|sp
operator|->
name|sof_tq
index|[
name|m
operator|-
literal|1
index|]
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfoSecTablesDcTable
name|OJPEGReadHeaderInfoSecTablesDcTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfoSecTablesDcTable"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
name|m
decl_stmt|;
name|uint8
name|n
decl_stmt|;
name|uint8
name|o
index|[
literal|16
index|]
decl_stmt|;
name|uint32
name|p
decl_stmt|;
name|uint32
name|q
decl_stmt|;
name|uint32
name|ra
decl_stmt|;
name|uint8
modifier|*
name|rb
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|dctable_offset
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Missing JPEG tables"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|in_buffer_file_pos_log
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|sp
operator|->
name|samples_per_pixel
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|sp
operator|->
name|dctable_offset
index|[
name|m
index|]
operator|!=
literal|0
operator|)
operator|&&
operator|(
operator|(
name|m
operator|==
literal|0
operator|)
operator|||
operator|(
name|sp
operator|->
name|dctable_offset
index|[
name|m
index|]
operator|!=
name|sp
operator|->
name|dctable_offset
index|[
name|m
operator|-
literal|1
index|]
operator|)
operator|)
condition|)
block|{
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|m
operator|-
literal|1
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|dctable_offset
index|[
name|m
index|]
operator|==
name|sp
operator|->
name|dctable_offset
index|[
name|n
index|]
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt JpegDcTables tag value"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|TIFFSeekFile
argument_list|(
name|tif
argument_list|,
name|sp
operator|->
name|dctable_offset
index|[
name|m
index|]
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|p
operator|=
name|TIFFReadFile
argument_list|(
name|tif
argument_list|,
name|o
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
literal|16
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|q
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|16
condition|;
name|n
operator|++
control|)
name|q
operator|+=
name|o
index|[
name|n
index|]
expr_stmt|;
name|ra
operator|=
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|21
operator|+
name|q
expr_stmt|;
name|rb
operator|=
name|_TIFFmalloc
argument_list|(
name|ra
argument_list|)
expr_stmt|;
if|if
condition|(
name|rb
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
operator|(
name|uint32
operator|*
operator|)
name|rb
operator|=
name|ra
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
index|]
operator|=
literal|255
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|1
index|]
operator|=
name|JPEG_MARKER_DHT
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|2
index|]
operator|=
operator|(
operator|(
literal|19
operator|+
name|q
operator|)
operator|>>
literal|8
operator|)
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|3
index|]
operator|=
operator|(
operator|(
literal|19
operator|+
name|q
operator|)
operator|&
literal|255
operator|)
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|4
index|]
operator|=
name|m
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|16
condition|;
name|n
operator|++
control|)
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|5
operator|+
name|n
index|]
operator|=
name|o
index|[
name|n
index|]
expr_stmt|;
name|p
operator|=
name|TIFFReadFile
argument_list|(
name|tif
argument_list|,
operator|&
operator|(
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|21
index|]
operator|)
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|q
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|dctable
index|[
name|m
index|]
operator|=
name|rb
expr_stmt|;
name|sp
operator|->
name|sos_tda
index|[
name|m
index|]
operator|=
operator|(
name|m
operator|<<
literal|4
operator|)
expr_stmt|;
block|}
else|else
name|sp
operator|->
name|sos_tda
index|[
name|m
index|]
operator|=
name|sp
operator|->
name|sos_tda
index|[
name|m
operator|-
literal|1
index|]
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadHeaderInfoSecTablesAcTable
name|OJPEGReadHeaderInfoSecTablesAcTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"OJPEGReadHeaderInfoSecTablesAcTable"
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
name|m
decl_stmt|;
name|uint8
name|n
decl_stmt|;
name|uint8
name|o
index|[
literal|16
index|]
decl_stmt|;
name|uint32
name|p
decl_stmt|;
name|uint32
name|q
decl_stmt|;
name|uint32
name|ra
decl_stmt|;
name|uint8
modifier|*
name|rb
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|actable_offset
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Missing JPEG tables"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sp
operator|->
name|in_buffer_file_pos_log
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|sp
operator|->
name|samples_per_pixel
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|sp
operator|->
name|actable_offset
index|[
name|m
index|]
operator|!=
literal|0
operator|)
operator|&&
operator|(
operator|(
name|m
operator|==
literal|0
operator|)
operator|||
operator|(
name|sp
operator|->
name|actable_offset
index|[
name|m
index|]
operator|!=
name|sp
operator|->
name|actable_offset
index|[
name|m
operator|-
literal|1
index|]
operator|)
operator|)
condition|)
block|{
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|m
operator|-
literal|1
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|actable_offset
index|[
name|m
index|]
operator|==
name|sp
operator|->
name|actable_offset
index|[
name|n
index|]
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Corrupt JpegAcTables tag value"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|TIFFSeekFile
argument_list|(
name|tif
argument_list|,
name|sp
operator|->
name|actable_offset
index|[
name|m
index|]
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|p
operator|=
name|TIFFReadFile
argument_list|(
name|tif
argument_list|,
name|o
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
literal|16
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|q
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|16
condition|;
name|n
operator|++
control|)
name|q
operator|+=
name|o
index|[
name|n
index|]
expr_stmt|;
name|ra
operator|=
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|21
operator|+
name|q
expr_stmt|;
name|rb
operator|=
name|_TIFFmalloc
argument_list|(
name|ra
argument_list|)
expr_stmt|;
if|if
condition|(
name|rb
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
operator|(
name|uint32
operator|*
operator|)
name|rb
operator|=
name|ra
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
index|]
operator|=
literal|255
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|1
index|]
operator|=
name|JPEG_MARKER_DHT
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|2
index|]
operator|=
operator|(
operator|(
literal|19
operator|+
name|q
operator|)
operator|>>
literal|8
operator|)
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|3
index|]
operator|=
operator|(
operator|(
literal|19
operator|+
name|q
operator|)
operator|&
literal|255
operator|)
expr_stmt|;
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|4
index|]
operator|=
operator|(
literal|16
operator||
name|m
operator|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|16
condition|;
name|n
operator|++
control|)
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|5
operator|+
name|n
index|]
operator|=
name|o
index|[
name|n
index|]
expr_stmt|;
name|p
operator|=
name|TIFFReadFile
argument_list|(
name|tif
argument_list|,
operator|&
operator|(
name|rb
index|[
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|+
literal|21
index|]
operator|)
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|q
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sp
operator|->
name|actable
index|[
name|m
index|]
operator|=
name|rb
expr_stmt|;
name|sp
operator|->
name|sos_tda
index|[
name|m
index|]
operator|=
operator|(
name|sp
operator|->
name|sos_tda
index|[
name|m
index|]
operator||
name|m
operator|)
expr_stmt|;
block|}
else|else
name|sp
operator|->
name|sos_tda
index|[
name|m
index|]
operator|=
operator|(
name|sp
operator|->
name|sos_tda
index|[
name|m
index|]
operator||
operator|(
name|sp
operator|->
name|sos_tda
index|[
name|m
operator|-
literal|1
index|]
operator|&
literal|15
operator|)
operator|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadBufferFill
name|OJPEGReadBufferFill
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|)
block|{
name|uint16
name|m
decl_stmt|;
name|tsize_t
name|n
decl_stmt|;
comment|/* TODO: double-check: when subsamplingcorrect is set, no call to TIFFErrorExt or TIFFWarningExt should be made 	 * in any other case, seek or read errors should be passed through */
do|do
block|{
if|if
condition|(
name|sp
operator|->
name|in_buffer_file_togo
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|in_buffer_file_pos_log
operator|==
literal|0
condition|)
block|{
name|TIFFSeekFile
argument_list|(
name|sp
operator|->
name|tif
argument_list|,
name|sp
operator|->
name|in_buffer_file_pos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_pos_log
operator|=
literal|1
expr_stmt|;
block|}
name|m
operator|=
name|OJPEG_BUFFER
expr_stmt|;
if|if
condition|(
name|m
operator|>
name|sp
operator|->
name|in_buffer_file_togo
condition|)
name|m
operator|=
operator|(
name|uint16
operator|)
name|sp
operator|->
name|in_buffer_file_togo
expr_stmt|;
name|n
operator|=
name|TIFFReadFile
argument_list|(
name|sp
operator|->
name|tif
argument_list|,
name|sp
operator|->
name|in_buffer
argument_list|,
operator|(
name|tsize_t
operator|)
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|assert
argument_list|(
name|n
operator|>
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|n
operator|<=
name|OJPEG_BUFFER
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|n
operator|<
literal|65536
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|uint16
operator|)
name|n
operator|<=
name|sp
operator|->
name|in_buffer_file_togo
argument_list|)
expr_stmt|;
name|m
operator|=
operator|(
name|uint16
operator|)
name|n
expr_stmt|;
name|sp
operator|->
name|in_buffer_togo
operator|=
name|m
expr_stmt|;
name|sp
operator|->
name|in_buffer_cur
operator|=
name|sp
operator|->
name|in_buffer
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_togo
operator|-=
name|m
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_pos
operator|+=
name|m
expr_stmt|;
break|break;
block|}
name|sp
operator|->
name|in_buffer_file_pos_log
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|sp
operator|->
name|in_buffer_source
condition|)
block|{
case|case
name|osibsNotSetYet
case|:
if|if
condition|(
name|sp
operator|->
name|jpeg_interchange_format
operator|!=
literal|0
condition|)
block|{
name|sp
operator|->
name|in_buffer_file_pos
operator|=
name|sp
operator|->
name|jpeg_interchange_format
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_togo
operator|=
name|sp
operator|->
name|jpeg_interchange_format_length
expr_stmt|;
block|}
name|sp
operator|->
name|in_buffer_source
operator|=
name|osibsJpegInterchangeFormat
expr_stmt|;
break|break;
case|case
name|osibsJpegInterchangeFormat
case|:
name|sp
operator|->
name|in_buffer_source
operator|=
name|osibsStrile
expr_stmt|;
case|case
name|osibsStrile
case|:
if|if
condition|(
name|sp
operator|->
name|in_buffer_next_strile
operator|==
name|sp
operator|->
name|in_buffer_strile_count
condition|)
name|sp
operator|->
name|in_buffer_source
operator|=
name|osibsEof
expr_stmt|;
else|else
block|{
name|sp
operator|->
name|in_buffer_file_pos
operator|=
name|sp
operator|->
name|tif
operator|->
name|tif_dir
operator|.
name|td_stripoffset
index|[
name|sp
operator|->
name|in_buffer_next_strile
index|]
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|in_buffer_file_pos
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|in_buffer_file_pos
operator|>=
name|sp
operator|->
name|file_size
condition|)
name|sp
operator|->
name|in_buffer_file_pos
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|sp
operator|->
name|in_buffer_file_togo
operator|=
name|sp
operator|->
name|tif
operator|->
name|tif_dir
operator|.
name|td_stripbytecount
index|[
name|sp
operator|->
name|in_buffer_next_strile
index|]
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|in_buffer_file_togo
operator|==
literal|0
condition|)
name|sp
operator|->
name|in_buffer_file_pos
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|sp
operator|->
name|in_buffer_file_pos
operator|+
name|sp
operator|->
name|in_buffer_file_togo
operator|>
name|sp
operator|->
name|file_size
condition|)
name|sp
operator|->
name|in_buffer_file_togo
operator|=
name|sp
operator|->
name|file_size
operator|-
name|sp
operator|->
name|in_buffer_file_pos
expr_stmt|;
block|}
block|}
name|sp
operator|->
name|in_buffer_next_strile
operator|++
expr_stmt|;
block|}
break|break;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
do|while
condition|(
literal|1
condition|)
do|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadByte
name|OJPEGReadByte
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint8
modifier|*
name|byte
parameter_list|)
block|{
if|if
condition|(
name|sp
operator|->
name|in_buffer_togo
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|OJPEGReadBufferFill
argument_list|(
name|sp
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|assert
argument_list|(
name|sp
operator|->
name|in_buffer_togo
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
operator|*
name|byte
operator|=
operator|*
operator|(
name|sp
operator|->
name|in_buffer_cur
operator|)
expr_stmt|;
name|sp
operator|->
name|in_buffer_cur
operator|++
expr_stmt|;
name|sp
operator|->
name|in_buffer_togo
operator|--
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadBytePeek
name|OJPEGReadBytePeek
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint8
modifier|*
name|byte
parameter_list|)
block|{
if|if
condition|(
name|sp
operator|->
name|in_buffer_togo
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|OJPEGReadBufferFill
argument_list|(
name|sp
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|assert
argument_list|(
name|sp
operator|->
name|in_buffer_togo
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
operator|*
name|byte
operator|=
operator|*
operator|(
name|sp
operator|->
name|in_buffer_cur
operator|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGReadByteAdvance
name|OJPEGReadByteAdvance
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|)
block|{
name|assert
argument_list|(
name|sp
operator|->
name|in_buffer_togo
operator|>
literal|0
argument_list|)
expr_stmt|;
name|sp
operator|->
name|in_buffer_cur
operator|++
expr_stmt|;
name|sp
operator|->
name|in_buffer_togo
operator|--
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadWord
name|OJPEGReadWord
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint16
modifier|*
name|word
parameter_list|)
block|{
name|uint8
name|m
decl_stmt|;
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|*
name|word
operator|=
operator|(
name|m
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|OJPEGReadByte
argument_list|(
name|sp
argument_list|,
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|*
name|word
operator||=
name|m
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGReadBlock
name|OJPEGReadBlock
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint16
name|len
parameter_list|,
name|void
modifier|*
name|mem
parameter_list|)
block|{
name|uint16
name|mlen
decl_stmt|;
name|uint8
modifier|*
name|mmem
decl_stmt|;
name|uint16
name|n
decl_stmt|;
name|assert
argument_list|(
name|len
operator|>
literal|0
argument_list|)
expr_stmt|;
name|mlen
operator|=
name|len
expr_stmt|;
name|mmem
operator|=
name|mem
expr_stmt|;
do|do
block|{
if|if
condition|(
name|sp
operator|->
name|in_buffer_togo
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|OJPEGReadBufferFill
argument_list|(
name|sp
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|assert
argument_list|(
name|sp
operator|->
name|in_buffer_togo
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
name|n
operator|=
name|mlen
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|sp
operator|->
name|in_buffer_togo
condition|)
name|n
operator|=
name|sp
operator|->
name|in_buffer_togo
expr_stmt|;
name|_TIFFmemcpy
argument_list|(
name|mmem
argument_list|,
name|sp
operator|->
name|in_buffer_cur
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|sp
operator|->
name|in_buffer_cur
operator|+=
name|n
expr_stmt|;
name|sp
operator|->
name|in_buffer_togo
operator|-=
name|n
expr_stmt|;
name|mlen
operator|-=
name|n
expr_stmt|;
name|mmem
operator|+=
name|n
expr_stmt|;
block|}
do|while
condition|(
name|mlen
operator|>
literal|0
condition|)
do|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGReadSkip
name|OJPEGReadSkip
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|uint16
name|len
parameter_list|)
block|{
name|uint16
name|m
decl_stmt|;
name|uint16
name|n
decl_stmt|;
name|m
operator|=
name|len
expr_stmt|;
name|n
operator|=
name|m
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|sp
operator|->
name|in_buffer_togo
condition|)
name|n
operator|=
name|sp
operator|->
name|in_buffer_togo
expr_stmt|;
name|sp
operator|->
name|in_buffer_cur
operator|+=
name|n
expr_stmt|;
name|sp
operator|->
name|in_buffer_togo
operator|-=
name|n
expr_stmt|;
name|m
operator|-=
name|n
expr_stmt|;
if|if
condition|(
name|m
operator|>
literal|0
condition|)
block|{
name|assert
argument_list|(
name|sp
operator|->
name|in_buffer_togo
operator|==
literal|0
argument_list|)
expr_stmt|;
name|n
operator|=
name|m
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|sp
operator|->
name|in_buffer_file_togo
condition|)
name|n
operator|=
name|sp
operator|->
name|in_buffer_file_togo
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_pos
operator|+=
name|n
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_togo
operator|-=
name|n
expr_stmt|;
name|sp
operator|->
name|in_buffer_file_pos_log
operator|=
literal|0
expr_stmt|;
comment|/* we don't skip past jpeginterchangeformat/strile block... 		 * if that is asked from us, we're dealing with totally bazurk 		 * data anyway, and we've not seen this happening on any 		 * testfile, so we might as well likely cause some other 		 * meaningless error to be passed at some later time 		 */
block|}
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGWriteStream
name|OJPEGWriteStream
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
operator|*
name|len
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|assert
argument_list|(
name|sp
operator|->
name|out_state
operator|<=
name|ososEoi
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sp
operator|->
name|out_state
condition|)
block|{
case|case
name|ososSoi
case|:
name|OJPEGWriteStreamSoi
argument_list|(
name|tif
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososQTable0
case|:
name|OJPEGWriteStreamQTable
argument_list|(
name|tif
argument_list|,
literal|0
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososQTable1
case|:
name|OJPEGWriteStreamQTable
argument_list|(
name|tif
argument_list|,
literal|1
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososQTable2
case|:
name|OJPEGWriteStreamQTable
argument_list|(
name|tif
argument_list|,
literal|2
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososQTable3
case|:
name|OJPEGWriteStreamQTable
argument_list|(
name|tif
argument_list|,
literal|3
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososDcTable0
case|:
name|OJPEGWriteStreamDcTable
argument_list|(
name|tif
argument_list|,
literal|0
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososDcTable1
case|:
name|OJPEGWriteStreamDcTable
argument_list|(
name|tif
argument_list|,
literal|1
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososDcTable2
case|:
name|OJPEGWriteStreamDcTable
argument_list|(
name|tif
argument_list|,
literal|2
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososDcTable3
case|:
name|OJPEGWriteStreamDcTable
argument_list|(
name|tif
argument_list|,
literal|3
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososAcTable0
case|:
name|OJPEGWriteStreamAcTable
argument_list|(
name|tif
argument_list|,
literal|0
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososAcTable1
case|:
name|OJPEGWriteStreamAcTable
argument_list|(
name|tif
argument_list|,
literal|1
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososAcTable2
case|:
name|OJPEGWriteStreamAcTable
argument_list|(
name|tif
argument_list|,
literal|2
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososAcTable3
case|:
name|OJPEGWriteStreamAcTable
argument_list|(
name|tif
argument_list|,
literal|3
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososDri
case|:
name|OJPEGWriteStreamDri
argument_list|(
name|tif
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososSof
case|:
name|OJPEGWriteStreamSof
argument_list|(
name|tif
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososSos
case|:
name|OJPEGWriteStreamSos
argument_list|(
name|tif
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososCompressed
case|:
if|if
condition|(
name|OJPEGWriteStreamCompressed
argument_list|(
name|tif
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|ososRst
case|:
name|OJPEGWriteStreamRst
argument_list|(
name|tif
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ososEoi
case|:
name|OJPEGWriteStreamEoi
argument_list|(
name|tif
argument_list|,
name|mem
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
operator|*
name|len
operator|==
literal|0
condition|)
do|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGWriteStreamSoi
name|OJPEGWriteStreamSoi
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|assert
argument_list|(
name|OJPEG_BUFFER
operator|>=
literal|2
argument_list|)
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|0
index|]
operator|=
literal|255
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|1
index|]
operator|=
name|JPEG_MARKER_SOI
expr_stmt|;
operator|*
name|len
operator|=
literal|2
expr_stmt|;
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|out_buffer
expr_stmt|;
name|sp
operator|->
name|out_state
operator|++
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGWriteStreamQTable
name|OJPEGWriteStreamQTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|uint8
name|table_index
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|qtable
index|[
name|table_index
index|]
operator|!=
literal|0
condition|)
block|{
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|sp
operator|->
name|qtable
index|[
name|table_index
index|]
operator|+
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|)
expr_stmt|;
operator|*
name|len
operator|=
operator|*
operator|(
operator|(
name|uint32
operator|*
operator|)
name|sp
operator|->
name|qtable
index|[
name|table_index
index|]
operator|)
operator|-
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
expr_stmt|;
block|}
name|sp
operator|->
name|out_state
operator|++
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGWriteStreamDcTable
name|OJPEGWriteStreamDcTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|uint8
name|table_index
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|dctable
index|[
name|table_index
index|]
operator|!=
literal|0
condition|)
block|{
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|sp
operator|->
name|dctable
index|[
name|table_index
index|]
operator|+
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|)
expr_stmt|;
operator|*
name|len
operator|=
operator|*
operator|(
operator|(
name|uint32
operator|*
operator|)
name|sp
operator|->
name|dctable
index|[
name|table_index
index|]
operator|)
operator|-
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
expr_stmt|;
block|}
name|sp
operator|->
name|out_state
operator|++
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGWriteStreamAcTable
name|OJPEGWriteStreamAcTable
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|uint8
name|table_index
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|actable
index|[
name|table_index
index|]
operator|!=
literal|0
condition|)
block|{
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|sp
operator|->
name|actable
index|[
name|table_index
index|]
operator|+
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
operator|)
expr_stmt|;
operator|*
name|len
operator|=
operator|*
operator|(
operator|(
name|uint32
operator|*
operator|)
name|sp
operator|->
name|actable
index|[
name|table_index
index|]
operator|)
operator|-
sizeof|sizeof
argument_list|(
name|uint32
argument_list|)
expr_stmt|;
block|}
name|sp
operator|->
name|out_state
operator|++
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGWriteStreamDri
name|OJPEGWriteStreamDri
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|assert
argument_list|(
name|OJPEG_BUFFER
operator|>=
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|restart_interval
operator|!=
literal|0
condition|)
block|{
name|sp
operator|->
name|out_buffer
index|[
literal|0
index|]
operator|=
literal|255
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|1
index|]
operator|=
name|JPEG_MARKER_DRI
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|3
index|]
operator|=
literal|4
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|4
index|]
operator|=
operator|(
name|sp
operator|->
name|restart_interval
operator|>>
literal|8
operator|)
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|5
index|]
operator|=
operator|(
name|sp
operator|->
name|restart_interval
operator|&
literal|255
operator|)
expr_stmt|;
operator|*
name|len
operator|=
literal|6
expr_stmt|;
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|out_buffer
expr_stmt|;
block|}
name|sp
operator|->
name|out_state
operator|++
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGWriteStreamSof
name|OJPEGWriteStreamSof
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
name|m
decl_stmt|;
name|assert
argument_list|(
name|OJPEG_BUFFER
operator|>=
literal|2
operator|+
literal|8
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|3
argument_list|)
expr_stmt|;
name|assert
argument_list|(
literal|255
operator|>=
literal|8
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|3
argument_list|)
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|0
index|]
operator|=
literal|255
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|1
index|]
operator|=
name|sp
operator|->
name|sof_marker_id
expr_stmt|;
comment|/* Lf */
name|sp
operator|->
name|out_buffer
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|3
index|]
operator|=
literal|8
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|3
expr_stmt|;
comment|/* P */
name|sp
operator|->
name|out_buffer
index|[
literal|4
index|]
operator|=
literal|8
expr_stmt|;
comment|/* Y */
name|sp
operator|->
name|out_buffer
index|[
literal|5
index|]
operator|=
operator|(
name|sp
operator|->
name|sof_y
operator|>>
literal|8
operator|)
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|6
index|]
operator|=
operator|(
name|sp
operator|->
name|sof_y
operator|&
literal|255
operator|)
expr_stmt|;
comment|/* X */
name|sp
operator|->
name|out_buffer
index|[
literal|7
index|]
operator|=
operator|(
name|sp
operator|->
name|sof_x
operator|>>
literal|8
operator|)
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|8
index|]
operator|=
operator|(
name|sp
operator|->
name|sof_x
operator|&
literal|255
operator|)
expr_stmt|;
comment|/* Nf */
name|sp
operator|->
name|out_buffer
index|[
literal|9
index|]
operator|=
name|sp
operator|->
name|samples_per_pixel_per_plane
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|sp
operator|->
name|samples_per_pixel_per_plane
condition|;
name|m
operator|++
control|)
block|{
comment|/* C */
name|sp
operator|->
name|out_buffer
index|[
literal|10
operator|+
name|m
operator|*
literal|3
index|]
operator|=
name|sp
operator|->
name|sof_c
index|[
name|sp
operator|->
name|plane_sample_offset
operator|+
name|m
index|]
expr_stmt|;
comment|/* H and V */
name|sp
operator|->
name|out_buffer
index|[
literal|10
operator|+
name|m
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|sp
operator|->
name|sof_hv
index|[
name|sp
operator|->
name|plane_sample_offset
operator|+
name|m
index|]
expr_stmt|;
comment|/* Tq */
name|sp
operator|->
name|out_buffer
index|[
literal|10
operator|+
name|m
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|sp
operator|->
name|sof_tq
index|[
name|sp
operator|->
name|plane_sample_offset
operator|+
name|m
index|]
expr_stmt|;
block|}
operator|*
name|len
operator|=
literal|10
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|3
expr_stmt|;
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|out_buffer
expr_stmt|;
name|sp
operator|->
name|out_state
operator|++
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGWriteStreamSos
name|OJPEGWriteStreamSos
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|uint8
name|m
decl_stmt|;
name|assert
argument_list|(
name|OJPEG_BUFFER
operator|>=
literal|2
operator|+
literal|6
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|2
argument_list|)
expr_stmt|;
name|assert
argument_list|(
literal|255
operator|>=
literal|6
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|2
argument_list|)
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|0
index|]
operator|=
literal|255
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|1
index|]
operator|=
name|JPEG_MARKER_SOS
expr_stmt|;
comment|/* Ls */
name|sp
operator|->
name|out_buffer
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|3
index|]
operator|=
literal|6
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|2
expr_stmt|;
comment|/* Ns */
name|sp
operator|->
name|out_buffer
index|[
literal|4
index|]
operator|=
name|sp
operator|->
name|samples_per_pixel_per_plane
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|sp
operator|->
name|samples_per_pixel_per_plane
condition|;
name|m
operator|++
control|)
block|{
comment|/* Cs */
name|sp
operator|->
name|out_buffer
index|[
literal|5
operator|+
name|m
operator|*
literal|2
index|]
operator|=
name|sp
operator|->
name|sos_cs
index|[
name|sp
operator|->
name|plane_sample_offset
operator|+
name|m
index|]
expr_stmt|;
comment|/* Td and Ta */
name|sp
operator|->
name|out_buffer
index|[
literal|5
operator|+
name|m
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|sp
operator|->
name|sos_tda
index|[
name|sp
operator|->
name|plane_sample_offset
operator|+
name|m
index|]
expr_stmt|;
block|}
comment|/* Ss */
name|sp
operator|->
name|out_buffer
index|[
literal|5
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Se */
name|sp
operator|->
name|out_buffer
index|[
literal|5
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
literal|63
expr_stmt|;
comment|/* Ah and Al */
name|sp
operator|->
name|out_buffer
index|[
literal|5
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|2
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
operator|*
name|len
operator|=
literal|8
operator|+
name|sp
operator|->
name|samples_per_pixel_per_plane
operator|*
literal|2
expr_stmt|;
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|out_buffer
expr_stmt|;
name|sp
operator|->
name|out_state
operator|++
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|OJPEGWriteStreamCompressed
name|OJPEGWriteStreamCompressed
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|in_buffer_togo
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|OJPEGReadBufferFill
argument_list|(
name|sp
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|assert
argument_list|(
name|sp
operator|->
name|in_buffer_togo
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
operator|*
name|len
operator|=
name|sp
operator|->
name|in_buffer_togo
expr_stmt|;
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|in_buffer_cur
expr_stmt|;
name|sp
operator|->
name|in_buffer_togo
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|in_buffer_file_togo
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|sp
operator|->
name|in_buffer_source
condition|)
block|{
case|case
name|osibsStrile
case|:
if|if
condition|(
name|sp
operator|->
name|in_buffer_next_strile
operator|<
name|sp
operator|->
name|in_buffer_strile_count
condition|)
name|sp
operator|->
name|out_state
operator|=
name|ososRst
expr_stmt|;
else|else
name|sp
operator|->
name|out_state
operator|=
name|ososEoi
expr_stmt|;
break|break;
case|case
name|osibsEof
case|:
name|sp
operator|->
name|out_state
operator|=
name|ososEoi
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGWriteStreamRst
name|OJPEGWriteStreamRst
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|assert
argument_list|(
name|OJPEG_BUFFER
operator|>=
literal|2
argument_list|)
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|0
index|]
operator|=
literal|255
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|1
index|]
operator|=
name|JPEG_MARKER_RST0
operator|+
name|sp
operator|->
name|restart_index
expr_stmt|;
name|sp
operator|->
name|restart_index
operator|++
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|restart_index
operator|==
literal|8
condition|)
name|sp
operator|->
name|restart_index
operator|=
literal|0
expr_stmt|;
operator|*
name|len
operator|=
literal|2
expr_stmt|;
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|out_buffer
expr_stmt|;
name|sp
operator|->
name|out_state
operator|=
name|ososCompressed
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGWriteStreamEoi
name|OJPEGWriteStreamEoi
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|void
modifier|*
modifier|*
name|mem
parameter_list|,
name|uint32
modifier|*
name|len
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|assert
argument_list|(
name|OJPEG_BUFFER
operator|>=
literal|2
argument_list|)
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|0
index|]
operator|=
literal|255
expr_stmt|;
name|sp
operator|->
name|out_buffer
index|[
literal|1
index|]
operator|=
name|JPEG_MARKER_EOI
expr_stmt|;
operator|*
name|len
operator|=
literal|2
expr_stmt|;
operator|*
name|mem
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
operator|->
name|out_buffer
expr_stmt|;
block|}
end_function
begin_ifndef
ifndef|#
directive|ifndef
name|LIBJPEG_ENCAP_EXTERNAL
end_ifndef
begin_function
specifier|static
name|int
DECL|function|jpeg_create_decompress_encap
name|jpeg_create_decompress_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
block|{
return|return
operator|(
name|SETJMP
argument_list|(
name|sp
operator|->
name|exit_jmpbuf
argument_list|)
condition|?
literal|0
else|:
operator|(
name|jpeg_create_decompress
argument_list|(
name|cinfo
argument_list|)
operator|,
literal|1
operator|)
operator|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|LIBJPEG_ENCAP_EXTERNAL
end_ifndef
begin_function
specifier|static
name|int
DECL|function|jpeg_read_header_encap
name|jpeg_read_header_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|uint8
name|require_image
parameter_list|)
block|{
return|return
operator|(
name|SETJMP
argument_list|(
name|sp
operator|->
name|exit_jmpbuf
argument_list|)
condition|?
literal|0
else|:
operator|(
name|jpeg_read_header
argument_list|(
name|cinfo
argument_list|,
name|require_image
argument_list|)
operator|,
literal|1
operator|)
operator|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|LIBJPEG_ENCAP_EXTERNAL
end_ifndef
begin_function
specifier|static
name|int
DECL|function|jpeg_start_decompress_encap
name|jpeg_start_decompress_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
block|{
return|return
operator|(
name|SETJMP
argument_list|(
name|sp
operator|->
name|exit_jmpbuf
argument_list|)
condition|?
literal|0
else|:
operator|(
name|jpeg_start_decompress
argument_list|(
name|cinfo
argument_list|)
operator|,
literal|1
operator|)
operator|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|LIBJPEG_ENCAP_EXTERNAL
end_ifndef
begin_function
specifier|static
name|int
DECL|function|jpeg_read_scanlines_encap
name|jpeg_read_scanlines_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|void
modifier|*
name|scanlines
parameter_list|,
name|uint32
name|max_lines
parameter_list|)
block|{
return|return
operator|(
name|SETJMP
argument_list|(
name|sp
operator|->
name|exit_jmpbuf
argument_list|)
condition|?
literal|0
else|:
operator|(
name|jpeg_read_scanlines
argument_list|(
name|cinfo
argument_list|,
name|scanlines
argument_list|,
name|max_lines
argument_list|)
operator|,
literal|1
operator|)
operator|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|LIBJPEG_ENCAP_EXTERNAL
end_ifndef
begin_function
specifier|static
name|int
DECL|function|jpeg_read_raw_data_encap
name|jpeg_read_raw_data_encap
parameter_list|(
name|OJPEGState
modifier|*
name|sp
parameter_list|,
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|uint32
name|max_lines
parameter_list|)
block|{
return|return
operator|(
name|SETJMP
argument_list|(
name|sp
operator|->
name|exit_jmpbuf
argument_list|)
condition|?
literal|0
else|:
operator|(
name|jpeg_read_raw_data
argument_list|(
name|cinfo
argument_list|,
name|data
argument_list|,
name|max_lines
argument_list|)
operator|,
literal|1
operator|)
operator|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|LIBJPEG_ENCAP_EXTERNAL
end_ifndef
begin_function
specifier|static
name|void
DECL|function|jpeg_encap_unwind
name|jpeg_encap_unwind
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|LONGJMP
argument_list|(
name|sp
operator|->
name|exit_jmpbuf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_function
specifier|static
name|void
DECL|function|OJPEGLibjpegJpegErrorMgrOutputMessage
name|OJPEGLibjpegJpegErrorMgrOutputMessage
parameter_list|(
name|jpeg_common_struct
modifier|*
name|cinfo
parameter_list|)
block|{
name|char
name|buffer
index|[
name|JMSG_LENGTH_MAX
index|]
decl_stmt|;
call|(
modifier|*
name|cinfo
operator|->
name|err
operator|->
name|format_message
call|)
argument_list|(
name|cinfo
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|TIFFWarningExt
argument_list|(
operator|(
operator|(
name|TIFF
operator|*
operator|)
operator|(
name|cinfo
operator|->
name|client_data
operator|)
operator|)
operator|->
name|tif_clientdata
argument_list|,
literal|"LibJpeg"
argument_list|,
literal|"%s"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGLibjpegJpegErrorMgrErrorExit
name|OJPEGLibjpegJpegErrorMgrErrorExit
parameter_list|(
name|jpeg_common_struct
modifier|*
name|cinfo
parameter_list|)
block|{
name|char
name|buffer
index|[
name|JMSG_LENGTH_MAX
index|]
decl_stmt|;
call|(
modifier|*
name|cinfo
operator|->
name|err
operator|->
name|format_message
call|)
argument_list|(
name|cinfo
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|TIFFErrorExt
argument_list|(
operator|(
operator|(
name|TIFF
operator|*
operator|)
operator|(
name|cinfo
operator|->
name|client_data
operator|)
operator|)
operator|->
name|tif_clientdata
argument_list|,
literal|"LibJpeg"
argument_list|,
literal|"%s"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|jpeg_encap_unwind
argument_list|(
operator|(
name|TIFF
operator|*
operator|)
operator|(
name|cinfo
operator|->
name|client_data
operator|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGLibjpegJpegSourceMgrInitSource
name|OJPEGLibjpegJpegSourceMgrInitSource
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
block|{
operator|(
name|void
operator|)
name|cinfo
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|boolean
DECL|function|OJPEGLibjpegJpegSourceMgrFillInputBuffer
name|OJPEGLibjpegJpegSourceMgrFillInputBuffer
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
block|{
name|TIFF
modifier|*
name|tif
init|=
operator|(
name|TIFF
operator|*
operator|)
name|cinfo
operator|->
name|client_data
decl_stmt|;
name|OJPEGState
modifier|*
name|sp
init|=
operator|(
name|OJPEGState
operator|*
operator|)
name|tif
operator|->
name|tif_data
decl_stmt|;
name|void
modifier|*
name|mem
init|=
literal|0
decl_stmt|;
name|uint32
name|len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|OJPEGWriteStream
argument_list|(
name|tif
argument_list|,
operator|&
name|mem
argument_list|,
operator|&
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
literal|"LibJpeg"
argument_list|,
literal|"Premature end of JPEG data"
argument_list|)
expr_stmt|;
name|jpeg_encap_unwind
argument_list|(
name|tif
argument_list|)
expr_stmt|;
block|}
name|sp
operator|->
name|libjpeg_jpeg_source_mgr
operator|.
name|bytes_in_buffer
operator|=
name|len
expr_stmt|;
name|sp
operator|->
name|libjpeg_jpeg_source_mgr
operator|.
name|next_input_byte
operator|=
name|mem
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGLibjpegJpegSourceMgrSkipInputData
name|OJPEGLibjpegJpegSourceMgrSkipInputData
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|long
name|num_bytes
parameter_list|)
block|{
name|TIFF
modifier|*
name|tif
init|=
operator|(
name|TIFF
operator|*
operator|)
name|cinfo
operator|->
name|client_data
decl_stmt|;
operator|(
name|void
operator|)
name|num_bytes
expr_stmt|;
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
literal|"LibJpeg"
argument_list|,
literal|"Unexpected error"
argument_list|)
expr_stmt|;
name|jpeg_encap_unwind
argument_list|(
name|tif
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|boolean
DECL|function|OJPEGLibjpegJpegSourceMgrResyncToRestart
name|OJPEGLibjpegJpegSourceMgrResyncToRestart
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|,
name|int
name|desired
parameter_list|)
block|{
name|TIFF
modifier|*
name|tif
init|=
operator|(
name|TIFF
operator|*
operator|)
name|cinfo
operator|->
name|client_data
decl_stmt|;
operator|(
name|void
operator|)
name|desired
expr_stmt|;
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
literal|"LibJpeg"
argument_list|,
literal|"Unexpected error"
argument_list|)
expr_stmt|;
name|jpeg_encap_unwind
argument_list|(
name|tif
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|OJPEGLibjpegJpegSourceMgrTermSource
name|OJPEGLibjpegJpegSourceMgrTermSource
parameter_list|(
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
block|{
operator|(
name|void
operator|)
name|cinfo
expr_stmt|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
end_unit
