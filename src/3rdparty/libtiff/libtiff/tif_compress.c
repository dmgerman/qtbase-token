begin_unit
begin_comment
comment|/* $Id: tif_compress.c,v 1.13 2007/02/24 15:03:50 dron Exp $ */
end_comment
begin_comment
comment|/*  * Copyright (c) 1988-1997 Sam Leffler  * Copyright (c) 1991-1997 Silicon Graphics, Inc.  *  * Permission to use, copy, modify, distribute, and sell this software and   * its documentation for any purpose is hereby granted without fee, provided  * that (i) the above copyright notices and this permission notice appear in  * all copies of the software and related documentation, and (ii) the names of  * Sam Leffler and Silicon Graphics may not be used in any advertising or  * publicity relating to the software without the specific, prior written  * permission of Sam Leffler and Silicon Graphics.  *   * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND,   * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY   * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.    *   * IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR  * ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,  * OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,  * WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF   * LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE   * OF THIS SOFTWARE.  */
end_comment
begin_comment
comment|/*  * TIFF Library  *  * Compression Scheme Configuration Support.  */
end_comment
begin_include
include|#
directive|include
file|"tiffiop.h"
end_include
begin_function
specifier|static
name|int
DECL|function|TIFFNoEncode
name|TIFFNoEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
specifier|const
name|char
modifier|*
name|method
parameter_list|)
block|{
specifier|const
name|TIFFCodec
modifier|*
name|c
init|=
name|TIFFFindCODEC
argument_list|(
name|tif
operator|->
name|tif_dir
operator|.
name|td_compression
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
literal|"%s %s encoding is not implemented"
argument_list|,
name|c
operator|->
name|name
argument_list|,
name|method
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
literal|"Compression scheme %u %s encoding is not implemented"
argument_list|,
name|tif
operator|->
name|tif_dir
operator|.
name|td_compression
argument_list|,
name|method
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function
begin_function
name|int
DECL|function|_TIFFNoRowEncode
name|_TIFFNoRowEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|pp
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
operator|(
name|void
operator|)
name|pp
expr_stmt|;
operator|(
name|void
operator|)
name|cc
expr_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
return|return
operator|(
name|TIFFNoEncode
argument_list|(
name|tif
argument_list|,
literal|"scanline"
argument_list|)
operator|)
return|;
block|}
end_function
begin_function
name|int
DECL|function|_TIFFNoStripEncode
name|_TIFFNoStripEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|pp
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
operator|(
name|void
operator|)
name|pp
expr_stmt|;
operator|(
name|void
operator|)
name|cc
expr_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
return|return
operator|(
name|TIFFNoEncode
argument_list|(
name|tif
argument_list|,
literal|"strip"
argument_list|)
operator|)
return|;
block|}
end_function
begin_function
name|int
DECL|function|_TIFFNoTileEncode
name|_TIFFNoTileEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|pp
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
operator|(
name|void
operator|)
name|pp
expr_stmt|;
operator|(
name|void
operator|)
name|cc
expr_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
return|return
operator|(
name|TIFFNoEncode
argument_list|(
name|tif
argument_list|,
literal|"tile"
argument_list|)
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|TIFFNoDecode
name|TIFFNoDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
specifier|const
name|char
modifier|*
name|method
parameter_list|)
block|{
specifier|const
name|TIFFCodec
modifier|*
name|c
init|=
name|TIFFFindCODEC
argument_list|(
name|tif
operator|->
name|tif_dir
operator|.
name|td_compression
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
condition|)
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
literal|"%s %s decoding is not implemented"
argument_list|,
name|c
operator|->
name|name
argument_list|,
name|method
argument_list|)
expr_stmt|;
else|else
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
literal|"Compression scheme %u %s decoding is not implemented"
argument_list|,
name|tif
operator|->
name|tif_dir
operator|.
name|td_compression
argument_list|,
name|method
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function
begin_function
name|int
DECL|function|_TIFFNoRowDecode
name|_TIFFNoRowDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|pp
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
operator|(
name|void
operator|)
name|pp
expr_stmt|;
operator|(
name|void
operator|)
name|cc
expr_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
return|return
operator|(
name|TIFFNoDecode
argument_list|(
name|tif
argument_list|,
literal|"scanline"
argument_list|)
operator|)
return|;
block|}
end_function
begin_function
name|int
DECL|function|_TIFFNoStripDecode
name|_TIFFNoStripDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|pp
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
operator|(
name|void
operator|)
name|pp
expr_stmt|;
operator|(
name|void
operator|)
name|cc
expr_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
return|return
operator|(
name|TIFFNoDecode
argument_list|(
name|tif
argument_list|,
literal|"strip"
argument_list|)
operator|)
return|;
block|}
end_function
begin_function
name|int
DECL|function|_TIFFNoTileDecode
name|_TIFFNoTileDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|pp
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
operator|(
name|void
operator|)
name|pp
expr_stmt|;
operator|(
name|void
operator|)
name|cc
expr_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
return|return
operator|(
name|TIFFNoDecode
argument_list|(
name|tif
argument_list|,
literal|"tile"
argument_list|)
operator|)
return|;
block|}
end_function
begin_function
name|int
DECL|function|_TIFFNoSeek
name|_TIFFNoSeek
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|uint32
name|off
parameter_list|)
block|{
operator|(
name|void
operator|)
name|off
expr_stmt|;
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
literal|"Compression algorithm does not support random access"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function
begin_function
name|int
DECL|function|_TIFFNoPreCode
name|_TIFFNoPreCode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
operator|(
name|void
operator|)
name|tif
expr_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
DECL|function|_TIFFtrue
specifier|static
name|int
name|_TIFFtrue
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
operator|(
name|void
operator|)
name|tif
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
DECL|function|_TIFFvoid
specifier|static
name|void
name|_TIFFvoid
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
operator|(
name|void
operator|)
name|tif
expr_stmt|;
block|}
end_function
begin_function
name|void
DECL|function|_TIFFSetDefaultCompressionState
name|_TIFFSetDefaultCompressionState
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|tif
operator|->
name|tif_decodestatus
operator|=
name|TRUE
expr_stmt|;
name|tif
operator|->
name|tif_setupdecode
operator|=
name|_TIFFtrue
expr_stmt|;
name|tif
operator|->
name|tif_predecode
operator|=
name|_TIFFNoPreCode
expr_stmt|;
name|tif
operator|->
name|tif_decoderow
operator|=
name|_TIFFNoRowDecode
expr_stmt|;
name|tif
operator|->
name|tif_decodestrip
operator|=
name|_TIFFNoStripDecode
expr_stmt|;
name|tif
operator|->
name|tif_decodetile
operator|=
name|_TIFFNoTileDecode
expr_stmt|;
name|tif
operator|->
name|tif_encodestatus
operator|=
name|TRUE
expr_stmt|;
name|tif
operator|->
name|tif_setupencode
operator|=
name|_TIFFtrue
expr_stmt|;
name|tif
operator|->
name|tif_preencode
operator|=
name|_TIFFNoPreCode
expr_stmt|;
name|tif
operator|->
name|tif_postencode
operator|=
name|_TIFFtrue
expr_stmt|;
name|tif
operator|->
name|tif_encoderow
operator|=
name|_TIFFNoRowEncode
expr_stmt|;
name|tif
operator|->
name|tif_encodestrip
operator|=
name|_TIFFNoStripEncode
expr_stmt|;
name|tif
operator|->
name|tif_encodetile
operator|=
name|_TIFFNoTileEncode
expr_stmt|;
name|tif
operator|->
name|tif_close
operator|=
name|_TIFFvoid
expr_stmt|;
name|tif
operator|->
name|tif_seek
operator|=
name|_TIFFNoSeek
expr_stmt|;
name|tif
operator|->
name|tif_cleanup
operator|=
name|_TIFFvoid
expr_stmt|;
name|tif
operator|->
name|tif_defstripsize
operator|=
name|_TIFFDefaultStripSize
expr_stmt|;
name|tif
operator|->
name|tif_deftilesize
operator|=
name|_TIFFDefaultTileSize
expr_stmt|;
name|tif
operator|->
name|tif_flags
operator|&=
operator|~
operator|(
name|TIFF_NOBITREV
operator||
name|TIFF_NOREADRAW
operator|)
expr_stmt|;
block|}
end_function
begin_function
name|int
DECL|function|TIFFSetCompressionScheme
name|TIFFSetCompressionScheme
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|int
name|scheme
parameter_list|)
block|{
specifier|const
name|TIFFCodec
modifier|*
name|c
init|=
name|TIFFFindCODEC
argument_list|(
operator|(
name|uint16
operator|)
name|scheme
argument_list|)
decl_stmt|;
name|_TIFFSetDefaultCompressionState
argument_list|(
name|tif
argument_list|)
expr_stmt|;
comment|/* 	 * Don't treat an unknown compression scheme as an error. 	 * This permits applications to open files with data that 	 * the library does not have builtin support for, but which 	 * may still be meaningful. 	 */
return|return
operator|(
name|c
condition|?
call|(
modifier|*
name|c
operator|->
name|init
call|)
argument_list|(
name|tif
argument_list|,
name|scheme
argument_list|)
else|:
literal|1
operator|)
return|;
block|}
end_function
begin_comment
comment|/*  * Other compression schemes may be registered.  Registered  * schemes can also override the builtin versions provided  * by this library.  */
end_comment
begin_typedef
DECL|struct|_codec
typedef|typedef
struct|struct
name|_codec
block|{
DECL|member|next
name|struct
name|_codec
modifier|*
name|next
decl_stmt|;
DECL|member|info
name|TIFFCodec
modifier|*
name|info
decl_stmt|;
block|}
DECL|typedef|codec_t
name|codec_t
typedef|;
end_typedef
begin_decl_stmt
DECL|variable|registeredCODECS
specifier|static
name|codec_t
modifier|*
name|registeredCODECS
init|=
name|NULL
decl_stmt|;
end_decl_stmt
begin_function
specifier|const
name|TIFFCodec
modifier|*
DECL|function|TIFFFindCODEC
name|TIFFFindCODEC
parameter_list|(
name|uint16
name|scheme
parameter_list|)
block|{
specifier|const
name|TIFFCodec
modifier|*
name|c
decl_stmt|;
name|codec_t
modifier|*
name|cd
decl_stmt|;
for|for
control|(
name|cd
operator|=
name|registeredCODECS
init|;
name|cd
condition|;
name|cd
operator|=
name|cd
operator|->
name|next
control|)
if|if
condition|(
name|cd
operator|->
name|info
operator|->
name|scheme
operator|==
name|scheme
condition|)
return|return
operator|(
operator|(
specifier|const
name|TIFFCodec
operator|*
operator|)
name|cd
operator|->
name|info
operator|)
return|;
for|for
control|(
name|c
operator|=
name|_TIFFBuiltinCODECS
init|;
name|c
operator|->
name|name
condition|;
name|c
operator|++
control|)
if|if
condition|(
name|c
operator|->
name|scheme
operator|==
name|scheme
condition|)
return|return
operator|(
name|c
operator|)
return|;
return|return
operator|(
operator|(
specifier|const
name|TIFFCodec
operator|*
operator|)
literal|0
operator|)
return|;
block|}
end_function
begin_function
name|TIFFCodec
modifier|*
DECL|function|TIFFRegisterCODEC
name|TIFFRegisterCODEC
parameter_list|(
name|uint16
name|scheme
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|TIFFInitMethod
name|init
parameter_list|)
block|{
name|codec_t
modifier|*
name|cd
init|=
operator|(
name|codec_t
operator|*
operator|)
name|_TIFFmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|codec_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|TIFFCodec
argument_list|)
operator|+
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|cd
operator|!=
name|NULL
condition|)
block|{
name|cd
operator|->
name|info
operator|=
operator|(
name|TIFFCodec
operator|*
operator|)
operator|(
operator|(
name|tidata_t
operator|)
name|cd
operator|+
sizeof|sizeof
argument_list|(
name|codec_t
argument_list|)
operator|)
expr_stmt|;
name|cd
operator|->
name|info
operator|->
name|name
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|(
name|tidata_t
operator|)
name|cd
operator|->
name|info
operator|+
sizeof|sizeof
argument_list|(
name|TIFFCodec
argument_list|)
operator|)
expr_stmt|;
name|strcpy
argument_list|(
name|cd
operator|->
name|info
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|cd
operator|->
name|info
operator|->
name|scheme
operator|=
name|scheme
expr_stmt|;
name|cd
operator|->
name|info
operator|->
name|init
operator|=
name|init
expr_stmt|;
name|cd
operator|->
name|next
operator|=
name|registeredCODECS
expr_stmt|;
name|registeredCODECS
operator|=
name|cd
expr_stmt|;
block|}
else|else
block|{
name|TIFFErrorExt
argument_list|(
literal|0
argument_list|,
literal|"TIFFRegisterCODEC"
argument_list|,
literal|"No space to register compression scheme %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
operator|(
name|cd
operator|->
name|info
operator|)
return|;
block|}
end_function
begin_function
name|void
DECL|function|TIFFUnRegisterCODEC
name|TIFFUnRegisterCODEC
parameter_list|(
name|TIFFCodec
modifier|*
name|c
parameter_list|)
block|{
name|codec_t
modifier|*
name|cd
decl_stmt|;
name|codec_t
modifier|*
modifier|*
name|pcd
decl_stmt|;
for|for
control|(
name|pcd
operator|=
operator|&
name|registeredCODECS
init|;
operator|(
name|cd
operator|=
operator|*
name|pcd
operator|)
condition|;
name|pcd
operator|=
operator|&
name|cd
operator|->
name|next
control|)
if|if
condition|(
name|cd
operator|->
name|info
operator|==
name|c
condition|)
block|{
operator|*
name|pcd
operator|=
name|cd
operator|->
name|next
expr_stmt|;
name|_TIFFfree
argument_list|(
name|cd
argument_list|)
expr_stmt|;
return|return;
block|}
name|TIFFErrorExt
argument_list|(
literal|0
argument_list|,
literal|"TIFFUnRegisterCODEC"
argument_list|,
literal|"Cannot remove compression scheme %s; not registered"
argument_list|,
name|c
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|/************************************************************************/
end_comment
begin_comment
comment|/*                       TIFFGetConfisuredCODECs()                      */
end_comment
begin_comment
comment|/************************************************************************/
end_comment
begin_comment
comment|/**  * Get list of configured codecs, both built-in and registered by user.  * Caller is responsible to free this structure.  *   * @return returns array of TIFFCodec records (the last record should be NULL)  * or NULL if function failed.  */
end_comment
begin_function
name|TIFFCodec
modifier|*
DECL|function|TIFFGetConfiguredCODECs
name|TIFFGetConfiguredCODECs
parameter_list|()
block|{
name|int
name|i
init|=
literal|1
decl_stmt|;
name|codec_t
modifier|*
name|cd
decl_stmt|;
specifier|const
name|TIFFCodec
modifier|*
name|c
decl_stmt|;
name|TIFFCodec
modifier|*
name|codecs
init|=
name|NULL
decl_stmt|,
modifier|*
name|new_codecs
decl_stmt|;
for|for
control|(
name|cd
operator|=
name|registeredCODECS
init|;
name|cd
condition|;
name|cd
operator|=
name|cd
operator|->
name|next
control|)
block|{
name|new_codecs
operator|=
operator|(
name|TIFFCodec
operator|*
operator|)
name|_TIFFrealloc
argument_list|(
name|codecs
argument_list|,
name|i
operator|*
sizeof|sizeof
argument_list|(
name|TIFFCodec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_codecs
condition|)
block|{
name|_TIFFfree
argument_list|(
name|codecs
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|codecs
operator|=
name|new_codecs
expr_stmt|;
name|_TIFFmemcpy
argument_list|(
name|codecs
operator|+
name|i
operator|-
literal|1
argument_list|,
name|cd
argument_list|,
sizeof|sizeof
argument_list|(
name|TIFFCodec
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
for|for
control|(
name|c
operator|=
name|_TIFFBuiltinCODECS
init|;
name|c
operator|->
name|name
condition|;
name|c
operator|++
control|)
block|{
if|if
condition|(
name|TIFFIsCODECConfigured
argument_list|(
name|c
operator|->
name|scheme
argument_list|)
condition|)
block|{
name|new_codecs
operator|=
operator|(
name|TIFFCodec
operator|*
operator|)
name|_TIFFrealloc
argument_list|(
name|codecs
argument_list|,
name|i
operator|*
sizeof|sizeof
argument_list|(
name|TIFFCodec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_codecs
condition|)
block|{
name|_TIFFfree
argument_list|(
name|codecs
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|codecs
operator|=
name|new_codecs
expr_stmt|;
name|_TIFFmemcpy
argument_list|(
name|codecs
operator|+
name|i
operator|-
literal|1
argument_list|,
operator|(
specifier|const
name|tdata_t
operator|)
name|c
argument_list|,
sizeof|sizeof
argument_list|(
name|TIFFCodec
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
name|new_codecs
operator|=
operator|(
name|TIFFCodec
operator|*
operator|)
name|_TIFFrealloc
argument_list|(
name|codecs
argument_list|,
name|i
operator|*
sizeof|sizeof
argument_list|(
name|TIFFCodec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_codecs
condition|)
block|{
name|_TIFFfree
argument_list|(
name|codecs
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|codecs
operator|=
name|new_codecs
expr_stmt|;
name|_TIFFmemset
argument_list|(
name|codecs
operator|+
name|i
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TIFFCodec
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|codecs
return|;
block|}
end_function
begin_comment
comment|/* vim: set ts=8 sts=8 sw=8 noet: */
end_comment
end_unit
