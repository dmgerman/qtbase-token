begin_unit
begin_comment
comment|/* $Id: tif_zip.c,v 1.11.2.3 2007/11/22 21:24:51 fwarmerdam Exp $ */
end_comment
begin_comment
comment|/*  * Copyright (c) 1995-1997 Sam Leffler  * Copyright (c) 1995-1997 Silicon Graphics, Inc.  *  * Permission to use, copy, modify, distribute, and sell this software and   * its documentation for any purpose is hereby granted without fee, provided  * that (i) the above copyright notices and this permission notice appear in  * all copies of the software and related documentation, and (ii) the names of  * Sam Leffler and Silicon Graphics may not be used in any advertising or  * publicity relating to the software without the specific, prior written  * permission of Sam Leffler and Silicon Graphics.  *   * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND,   * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY   * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.    *   * IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR  * ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,  * OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,  * WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF   * LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE   * OF THIS SOFTWARE.  */
end_comment
begin_include
include|#
directive|include
file|"tiffiop.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|ZIP_SUPPORT
end_ifdef
begin_comment
comment|/*  * TIFF Library.  *  * ZIP (aka Deflate) Compression Support  *  * This file is simply an interface to the zlib library written by  * Jean-loup Gailly and Mark Adler.  You must use version 1.0 or later  * of the library: this code assumes the 1.0 API and also depends on  * the ability to write the zlib header multiple times (one per strip)  * which was not possible with versions prior to 0.95.  Note also that  * older versions of this codec avoided this bug by supressing the header  * entirely.  This means that files written with the old library cannot  * be read; they should be converted to a different compression scheme  * and then reconverted.  *  * The data format used by the zlib library is described in the files  * zlib-3.1.doc, deflate-1.1.doc and gzip-4.1.doc, available in the  * directory ftp://ftp.uu.net/pub/archiving/zip/doc.  The library was  * last found at ftp://ftp.uu.net/pub/archiving/zip/zlib/zlib-0.99.tar.gz.  */
end_comment
begin_include
include|#
directive|include
file|"tif_predict.h"
end_include
begin_include
include|#
directive|include
file|"zlib.h"
end_include
begin_include
include|#
directive|include
file|<stdio.h>
end_include
begin_comment
comment|/*  * Sigh, ZLIB_VERSION is defined as a string so there's no  * way to do a proper check here.  Instead we guess based  * on the presence of #defines that were added between the  * 0.95 and 1.0 distributions.  */
end_comment
begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Z_NO_COMPRESSION
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|Z_DEFLATED
argument_list|)
end_if
begin_error
error|#
directive|error
literal|"Antiquated ZLIB software; you must use version 1.0 or later"
end_error
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/*  * State block for each open TIFF  * file using ZIP compression/decompression.  */
end_comment
begin_typedef
typedef|typedef
struct|struct
block|{
DECL|member|predict
name|TIFFPredictorState
name|predict
decl_stmt|;
DECL|member|stream
name|z_stream
name|stream
decl_stmt|;
DECL|member|zipquality
name|int
name|zipquality
decl_stmt|;
comment|/* compression level */
DECL|member|state
name|int
name|state
decl_stmt|;
comment|/* state flags */
DECL|macro|ZSTATE_INIT_DECODE
define|#
directive|define
name|ZSTATE_INIT_DECODE
value|0x01
DECL|macro|ZSTATE_INIT_ENCODE
define|#
directive|define
name|ZSTATE_INIT_ENCODE
value|0x02
DECL|member|vgetparent
name|TIFFVGetMethod
name|vgetparent
decl_stmt|;
comment|/* super-class method */
DECL|member|vsetparent
name|TIFFVSetMethod
name|vsetparent
decl_stmt|;
comment|/* super-class method */
block|}
DECL|typedef|ZIPState
name|ZIPState
typedef|;
end_typedef
begin_define
DECL|macro|ZState
define|#
directive|define
name|ZState
parameter_list|(
name|tif
parameter_list|)
value|((ZIPState*) (tif)->tif_data)
end_define
begin_define
DECL|macro|DecoderState
define|#
directive|define
name|DecoderState
parameter_list|(
name|tif
parameter_list|)
value|ZState(tif)
end_define
begin_define
DECL|macro|EncoderState
define|#
directive|define
name|EncoderState
parameter_list|(
name|tif
parameter_list|)
value|ZState(tif)
end_define
begin_function_decl
specifier|static
name|int
name|ZIPEncode
parameter_list|(
name|TIFF
modifier|*
parameter_list|,
name|tidata_t
parameter_list|,
name|tsize_t
parameter_list|,
name|tsample_t
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|static
name|int
name|ZIPDecode
parameter_list|(
name|TIFF
modifier|*
parameter_list|,
name|tidata_t
parameter_list|,
name|tsize_t
parameter_list|,
name|tsample_t
parameter_list|)
function_decl|;
end_function_decl
begin_function
specifier|static
name|int
DECL|function|ZIPSetupDecode
name|ZIPSetupDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|DecoderState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"ZIPSetupDecode"
decl_stmt|;
name|assert
argument_list|(
name|sp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* if we were last encoding, terminate this mode */
if|if
condition|(
name|sp
operator|->
name|state
operator|&
name|ZSTATE_INIT_ENCODE
condition|)
block|{
name|deflateEnd
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|)
expr_stmt|;
name|sp
operator|->
name|state
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|inflateInit
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|)
operator|!=
name|Z_OK
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"%s: %s"
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
name|sp
operator|->
name|stream
operator|.
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|sp
operator|->
name|state
operator||=
name|ZSTATE_INIT_DECODE
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
end_function
begin_comment
comment|/*  * Setup state for decoding a strip.  */
end_comment
begin_function
specifier|static
name|int
DECL|function|ZIPPreDecode
name|ZIPPreDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|DecoderState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
name|assert
argument_list|(
name|sp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sp
operator|->
name|state
operator|&
name|ZSTATE_INIT_DECODE
operator|)
operator|==
literal|0
condition|)
name|tif
operator|->
name|tif_setupdecode
argument_list|(
name|tif
argument_list|)
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|next_in
operator|=
name|tif
operator|->
name|tif_rawdata
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|avail_in
operator|=
name|tif
operator|->
name|tif_rawcc
expr_stmt|;
return|return
operator|(
name|inflateReset
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|)
operator|==
name|Z_OK
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|ZIPDecode
name|ZIPDecode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|op
parameter_list|,
name|tsize_t
name|occ
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|DecoderState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"ZIPDecode"
decl_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
name|assert
argument_list|(
name|sp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|state
operator|==
name|ZSTATE_INIT_DECODE
argument_list|)
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|next_out
operator|=
name|op
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|avail_out
operator|=
name|occ
expr_stmt|;
do|do
block|{
name|int
name|state
init|=
name|inflate
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|,
name|Z_PARTIAL_FLUSH
argument_list|)
decl_stmt|;
if|if
condition|(
name|state
operator|==
name|Z_STREAM_END
condition|)
break|break;
if|if
condition|(
name|state
operator|==
name|Z_DATA_ERROR
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"%s: Decoding error at scanline %d, %s"
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
name|tif
operator|->
name|tif_row
argument_list|,
name|sp
operator|->
name|stream
operator|.
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|inflateSync
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|)
operator|!=
name|Z_OK
condition|)
return|return
operator|(
literal|0
operator|)
return|;
continue|continue;
block|}
if|if
condition|(
name|state
operator|!=
name|Z_OK
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"%s: zlib error: %s"
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
name|sp
operator|->
name|stream
operator|.
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
do|while
condition|(
name|sp
operator|->
name|stream
operator|.
name|avail_out
operator|>
literal|0
condition|)
do|;
if|if
condition|(
name|sp
operator|->
name|stream
operator|.
name|avail_out
operator|!=
literal|0
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"%s: Not enough data at scanline %d (short %d bytes)"
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
name|tif
operator|->
name|tif_row
argument_list|,
name|sp
operator|->
name|stream
operator|.
name|avail_out
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|ZIPSetupEncode
name|ZIPSetupEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|EncoderState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"ZIPSetupEncode"
decl_stmt|;
name|assert
argument_list|(
name|sp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|state
operator|&
name|ZSTATE_INIT_DECODE
condition|)
block|{
name|inflateEnd
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|)
expr_stmt|;
name|sp
operator|->
name|state
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|deflateInit
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|,
name|sp
operator|->
name|zipquality
argument_list|)
operator|!=
name|Z_OK
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"%s: %s"
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
name|sp
operator|->
name|stream
operator|.
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|sp
operator|->
name|state
operator||=
name|ZSTATE_INIT_ENCODE
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
end_function
begin_comment
comment|/*  * Reset encoding state at the start of a strip.  */
end_comment
begin_function
specifier|static
name|int
DECL|function|ZIPPreEncode
name|ZIPPreEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|EncoderState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
name|assert
argument_list|(
name|sp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|state
operator|!=
name|ZSTATE_INIT_ENCODE
condition|)
name|tif
operator|->
name|tif_setupencode
argument_list|(
name|tif
argument_list|)
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|next_out
operator|=
name|tif
operator|->
name|tif_rawdata
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|avail_out
operator|=
name|tif
operator|->
name|tif_rawdatasize
expr_stmt|;
return|return
operator|(
name|deflateReset
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|)
operator|==
name|Z_OK
operator|)
return|;
block|}
end_function
begin_comment
comment|/*  * Encode a chunk of pixels.  */
end_comment
begin_function
specifier|static
name|int
DECL|function|ZIPEncode
name|ZIPEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|tidata_t
name|bp
parameter_list|,
name|tsize_t
name|cc
parameter_list|,
name|tsample_t
name|s
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|EncoderState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"ZIPEncode"
decl_stmt|;
name|assert
argument_list|(
name|sp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|sp
operator|->
name|state
operator|==
name|ZSTATE_INIT_ENCODE
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|s
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|next_in
operator|=
name|bp
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|avail_in
operator|=
name|cc
expr_stmt|;
do|do
block|{
if|if
condition|(
name|deflate
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|,
name|Z_NO_FLUSH
argument_list|)
operator|!=
name|Z_OK
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"%s: Encoder error: %s"
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
name|sp
operator|->
name|stream
operator|.
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sp
operator|->
name|stream
operator|.
name|avail_out
operator|==
literal|0
condition|)
block|{
name|tif
operator|->
name|tif_rawcc
operator|=
name|tif
operator|->
name|tif_rawdatasize
expr_stmt|;
name|TIFFFlushData1
argument_list|(
name|tif
argument_list|)
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|next_out
operator|=
name|tif
operator|->
name|tif_rawdata
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|avail_out
operator|=
name|tif
operator|->
name|tif_rawdatasize
expr_stmt|;
block|}
block|}
do|while
condition|(
name|sp
operator|->
name|stream
operator|.
name|avail_in
operator|>
literal|0
condition|)
do|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_comment
comment|/*  * Finish off an encoded strip by flushing the last  * string and tacking on an End Of Information code.  */
end_comment
begin_function
specifier|static
name|int
DECL|function|ZIPPostEncode
name|ZIPPostEncode
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|EncoderState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"ZIPPostEncode"
decl_stmt|;
name|int
name|state
decl_stmt|;
name|sp
operator|->
name|stream
operator|.
name|avail_in
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|state
operator|=
name|deflate
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|,
name|Z_FINISH
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|Z_STREAM_END
case|:
case|case
name|Z_OK
case|:
if|if
condition|(
operator|(
name|int
operator|)
name|sp
operator|->
name|stream
operator|.
name|avail_out
operator|!=
operator|(
name|int
operator|)
name|tif
operator|->
name|tif_rawdatasize
condition|)
block|{
name|tif
operator|->
name|tif_rawcc
operator|=
name|tif
operator|->
name|tif_rawdatasize
operator|-
name|sp
operator|->
name|stream
operator|.
name|avail_out
expr_stmt|;
name|TIFFFlushData1
argument_list|(
name|tif
argument_list|)
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|next_out
operator|=
name|tif
operator|->
name|tif_rawdata
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|avail_out
operator|=
name|tif
operator|->
name|tif_rawdatasize
expr_stmt|;
block|}
break|break;
default|default:
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"%s: zlib error: %s"
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
name|sp
operator|->
name|stream
operator|.
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
do|while
condition|(
name|state
operator|!=
name|Z_STREAM_END
condition|)
do|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|ZIPCleanup
name|ZIPCleanup
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|ZState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|sp
operator|!=
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|TIFFPredictorCleanup
argument_list|(
name|tif
argument_list|)
expr_stmt|;
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vgetfield
operator|=
name|sp
operator|->
name|vgetparent
expr_stmt|;
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vsetfield
operator|=
name|sp
operator|->
name|vsetparent
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|state
operator|&
name|ZSTATE_INIT_ENCODE
condition|)
block|{
name|deflateEnd
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|)
expr_stmt|;
name|sp
operator|->
name|state
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sp
operator|->
name|state
operator|&
name|ZSTATE_INIT_DECODE
condition|)
block|{
name|inflateEnd
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|)
expr_stmt|;
name|sp
operator|->
name|state
operator|=
literal|0
expr_stmt|;
block|}
name|_TIFFfree
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|tif
operator|->
name|tif_data
operator|=
name|NULL
expr_stmt|;
name|_TIFFSetDefaultCompressionState
argument_list|(
name|tif
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|ZIPVSetField
name|ZIPVSetField
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|ttag_t
name|tag
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|ZState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"ZIPVSetField"
decl_stmt|;
switch|switch
condition|(
name|tag
condition|)
block|{
case|case
name|TIFFTAG_ZIPQUALITY
case|:
name|sp
operator|->
name|zipquality
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|state
operator|&
name|ZSTATE_INIT_ENCODE
condition|)
block|{
if|if
condition|(
name|deflateParams
argument_list|(
operator|&
name|sp
operator|->
name|stream
argument_list|,
name|sp
operator|->
name|zipquality
argument_list|,
name|Z_DEFAULT_STRATEGY
argument_list|)
operator|!=
name|Z_OK
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"%s: zlib error: %s"
argument_list|,
name|tif
operator|->
name|tif_name
argument_list|,
name|sp
operator|->
name|stream
operator|.
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
default|default:
return|return
call|(
modifier|*
name|sp
operator|->
name|vsetparent
call|)
argument_list|(
name|tif
argument_list|,
name|tag
argument_list|,
name|ap
argument_list|)
return|;
block|}
comment|/*NOTREACHED*/
block|}
end_function
begin_function
specifier|static
name|int
DECL|function|ZIPVGetField
name|ZIPVGetField
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|ttag_t
name|tag
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|ZIPState
modifier|*
name|sp
init|=
name|ZState
argument_list|(
name|tif
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|tag
condition|)
block|{
case|case
name|TIFFTAG_ZIPQUALITY
case|:
operator|*
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
operator|*
argument_list|)
operator|=
name|sp
operator|->
name|zipquality
expr_stmt|;
break|break;
default|default:
return|return
call|(
modifier|*
name|sp
operator|->
name|vgetparent
call|)
argument_list|(
name|tif
argument_list|,
name|tag
argument_list|,
name|ap
argument_list|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function
begin_decl_stmt
DECL|variable|zipFieldInfo
specifier|static
specifier|const
name|TIFFFieldInfo
name|zipFieldInfo
index|[]
init|=
block|{
block|{
name|TIFFTAG_ZIPQUALITY
block|,
literal|0
block|,
literal|0
block|,
name|TIFF_ANY
block|,
name|FIELD_PSEUDO
block|,
name|TRUE
block|,
name|FALSE
block|,
literal|""
block|}
block|, }
decl_stmt|;
end_decl_stmt
begin_function
name|int
DECL|function|TIFFInitZIP
name|TIFFInitZIP
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|,
name|int
name|scheme
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"TIFFInitZIP"
decl_stmt|;
name|ZIPState
modifier|*
name|sp
decl_stmt|;
name|assert
argument_list|(
operator|(
name|scheme
operator|==
name|COMPRESSION_DEFLATE
operator|)
operator|||
operator|(
name|scheme
operator|==
name|COMPRESSION_ADOBE_DEFLATE
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Merge codec-specific tag information. 	 */
if|if
condition|(
operator|!
name|_TIFFMergeFieldInfo
argument_list|(
name|tif
argument_list|,
name|zipFieldInfo
argument_list|,
name|TIFFArrayCount
argument_list|(
name|zipFieldInfo
argument_list|)
argument_list|)
condition|)
block|{
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"Merging Deflate codec-specific tags failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	 * Allocate state block so tag methods have storage to record values. 	 */
name|tif
operator|->
name|tif_data
operator|=
operator|(
name|tidata_t
operator|)
name|_TIFFmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ZIPState
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tif
operator|->
name|tif_data
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
name|sp
operator|=
name|ZState
argument_list|(
name|tif
argument_list|)
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|zalloc
operator|=
name|NULL
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|zfree
operator|=
name|NULL
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|opaque
operator|=
name|NULL
expr_stmt|;
name|sp
operator|->
name|stream
operator|.
name|data_type
operator|=
name|Z_BINARY
expr_stmt|;
comment|/* 	 * Override parent get/set field methods. 	 */
name|sp
operator|->
name|vgetparent
operator|=
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vgetfield
expr_stmt|;
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vgetfield
operator|=
name|ZIPVGetField
expr_stmt|;
comment|/* hook for codec tags */
name|sp
operator|->
name|vsetparent
operator|=
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vsetfield
expr_stmt|;
name|tif
operator|->
name|tif_tagmethods
operator|.
name|vsetfield
operator|=
name|ZIPVSetField
expr_stmt|;
comment|/* hook for codec tags */
comment|/* Default values for codec-specific fields */
name|sp
operator|->
name|zipquality
operator|=
name|Z_DEFAULT_COMPRESSION
expr_stmt|;
comment|/* default comp. level */
name|sp
operator|->
name|state
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Install codec methods. 	 */
name|tif
operator|->
name|tif_setupdecode
operator|=
name|ZIPSetupDecode
expr_stmt|;
name|tif
operator|->
name|tif_predecode
operator|=
name|ZIPPreDecode
expr_stmt|;
name|tif
operator|->
name|tif_decoderow
operator|=
name|ZIPDecode
expr_stmt|;
name|tif
operator|->
name|tif_decodestrip
operator|=
name|ZIPDecode
expr_stmt|;
name|tif
operator|->
name|tif_decodetile
operator|=
name|ZIPDecode
expr_stmt|;
name|tif
operator|->
name|tif_setupencode
operator|=
name|ZIPSetupEncode
expr_stmt|;
name|tif
operator|->
name|tif_preencode
operator|=
name|ZIPPreEncode
expr_stmt|;
name|tif
operator|->
name|tif_postencode
operator|=
name|ZIPPostEncode
expr_stmt|;
name|tif
operator|->
name|tif_encoderow
operator|=
name|ZIPEncode
expr_stmt|;
name|tif
operator|->
name|tif_encodestrip
operator|=
name|ZIPEncode
expr_stmt|;
name|tif
operator|->
name|tif_encodetile
operator|=
name|ZIPEncode
expr_stmt|;
name|tif
operator|->
name|tif_cleanup
operator|=
name|ZIPCleanup
expr_stmt|;
comment|/* 	 * Setup predictor setup. 	 */
operator|(
name|void
operator|)
name|TIFFPredictorInit
argument_list|(
name|tif
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
name|bad
label|:
name|TIFFErrorExt
argument_list|(
name|tif
operator|->
name|tif_clientdata
argument_list|,
name|module
argument_list|,
literal|"No space for ZIP state block"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* ZIP_SUPORT */
end_comment
begin_comment
comment|/* vim: set ts=8 sts=8 sw=8 noet: */
end_comment
end_unit
