begin_unit
begin_comment
comment|/* $Id: tif_close.c,v 1.10 2006/03/25 03:09:24 joris Exp $ */
end_comment
begin_comment
comment|/*  * Copyright (c) 1988-1997 Sam Leffler  * Copyright (c) 1991-1997 Silicon Graphics, Inc.  *  * Permission to use, copy, modify, distribute, and sell this software and   * its documentation for any purpose is hereby granted without fee, provided  * that (i) the above copyright notices and this permission notice appear in  * all copies of the software and related documentation, and (ii) the names of  * Sam Leffler and Silicon Graphics may not be used in any advertising or  * publicity relating to the software without the specific, prior written  * permission of Sam Leffler and Silicon Graphics.  *   * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND,   * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY   * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.    *   * IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR  * ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,  * OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,  * WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF   * LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE   * OF THIS SOFTWARE.  */
end_comment
begin_comment
comment|/*  * TIFF Library.  */
end_comment
begin_include
include|#
directive|include
file|"tiffiop.h"
end_include
begin_comment
comment|/************************************************************************/
end_comment
begin_comment
comment|/*                            TIFFCleanup()                             */
end_comment
begin_comment
comment|/************************************************************************/
end_comment
begin_comment
comment|/**  * Auxiliary function to free the TIFF structure. Given structure will be  * completetly freed, so you should save opened file handle and pointer  * to the close procedure in external variables before calling  * _TIFFCleanup(), if you will need these ones to close the file.  *   * @param tif A TIFF pointer.  */
end_comment
begin_function
name|void
DECL|function|TIFFCleanup
name|TIFFCleanup
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
if|if
condition|(
name|tif
operator|->
name|tif_mode
operator|!=
name|O_RDONLY
condition|)
comment|/* 	     * Flush buffered data and directory (if dirty). 	     */
name|TIFFFlush
argument_list|(
name|tif
argument_list|)
expr_stmt|;
call|(
modifier|*
name|tif
operator|->
name|tif_cleanup
call|)
argument_list|(
name|tif
argument_list|)
expr_stmt|;
name|TIFFFreeDirectory
argument_list|(
name|tif
argument_list|)
expr_stmt|;
if|if
condition|(
name|tif
operator|->
name|tif_dirlist
condition|)
name|_TIFFfree
argument_list|(
name|tif
operator|->
name|tif_dirlist
argument_list|)
expr_stmt|;
comment|/* Clean up client info links */
while|while
condition|(
name|tif
operator|->
name|tif_clientinfo
condition|)
block|{
name|TIFFClientInfoLink
modifier|*
name|link
init|=
name|tif
operator|->
name|tif_clientinfo
decl_stmt|;
name|tif
operator|->
name|tif_clientinfo
operator|=
name|link
operator|->
name|next
expr_stmt|;
name|_TIFFfree
argument_list|(
name|link
operator|->
name|name
argument_list|)
expr_stmt|;
name|_TIFFfree
argument_list|(
name|link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tif
operator|->
name|tif_rawdata
operator|&&
operator|(
name|tif
operator|->
name|tif_flags
operator|&
name|TIFF_MYBUFFER
operator|)
condition|)
name|_TIFFfree
argument_list|(
name|tif
operator|->
name|tif_rawdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|isMapped
argument_list|(
name|tif
argument_list|)
condition|)
name|TIFFUnmapFileContents
argument_list|(
name|tif
argument_list|,
name|tif
operator|->
name|tif_base
argument_list|,
name|tif
operator|->
name|tif_size
argument_list|)
expr_stmt|;
comment|/* Clean up custom fields */
if|if
condition|(
name|tif
operator|->
name|tif_nfields
operator|>
literal|0
condition|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tif
operator|->
name|tif_nfields
condition|;
name|i
operator|++
control|)
block|{
name|TIFFFieldInfo
modifier|*
name|fld
init|=
name|tif
operator|->
name|tif_fieldinfo
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|fld
operator|->
name|field_bit
operator|==
name|FIELD_CUSTOM
operator|&&
name|strncmp
argument_list|(
literal|"Tag "
argument_list|,
name|fld
operator|->
name|field_name
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|_TIFFfree
argument_list|(
name|fld
operator|->
name|field_name
argument_list|)
expr_stmt|;
name|_TIFFfree
argument_list|(
name|fld
argument_list|)
expr_stmt|;
block|}
block|}
name|_TIFFfree
argument_list|(
name|tif
operator|->
name|tif_fieldinfo
argument_list|)
expr_stmt|;
block|}
name|_TIFFfree
argument_list|(
name|tif
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|/************************************************************************/
end_comment
begin_comment
comment|/*                            TIFFClose()                               */
end_comment
begin_comment
comment|/************************************************************************/
end_comment
begin_comment
comment|/**  * Close a previously opened TIFF file.  *  * TIFFClose closes a file that was previously opened with TIFFOpen().  * Any buffered data are flushed to the file, including the contents of  * the current directory (if modified); and all resources are reclaimed.  *   * @param tif A TIFF pointer.  */
end_comment
begin_function
name|void
DECL|function|TIFFClose
name|TIFFClose
parameter_list|(
name|TIFF
modifier|*
name|tif
parameter_list|)
block|{
name|TIFFCloseProc
name|closeproc
init|=
name|tif
operator|->
name|tif_closeproc
decl_stmt|;
name|thandle_t
name|fd
init|=
name|tif
operator|->
name|tif_clientdata
decl_stmt|;
name|TIFFCleanup
argument_list|(
name|tif
argument_list|)
expr_stmt|;
call|(
name|void
call|)
argument_list|(
operator|*
name|closeproc
argument_list|)
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function
end_unit
