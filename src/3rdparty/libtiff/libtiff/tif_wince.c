begin_unit
begin_comment
comment|/* $Id: tif_wince.c,v 1.1 2007-01-15 18:40:39 mloskot Exp $ */
end_comment
begin_comment
comment|/*  * Copyright (c) 1988-1997 Sam Leffler  * Copyright (c) 1991-1997 Silicon Graphics, Inc.  *  * Permission to use, copy, modify, distribute, and sell this software and   * its documentation for any purpose is hereby granted without fee, provided  * that (i) the above copyright notices and this permission notice appear in  * all copies of the software and related documentation, and (ii) the names of  * Sam Leffler and Silicon Graphics may not be used in any advertising or  * publicity relating to the software without the specific, prior written  * permission of Sam Leffler and Silicon Graphics.  *   * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND,   * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY   * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.    *   * IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR  * ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,  * OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,  * WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF   * LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE   * OF THIS SOFTWARE.  */
end_comment
begin_comment
comment|/*  * Windows CE-specific routines for TIFF Library.  * Adapted from tif_win32.c 01/10/2006 by Mateusz Loskot (mateusz@loskot.net)  */
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|_WIN32_WCE
end_ifndef
begin_error
error|#
directive|error
literal|"Only Windows CE target is supported!"
end_error
begin_endif
endif|#
directive|endif
end_endif
begin_include
include|#
directive|include
file|"tiffiop.h"
end_include
begin_include
include|#
directive|include
file|<windows.h>
end_include
begin_comment
comment|/* Turn off console support on Windows CE. */
end_comment
begin_undef
DECL|macro|TIF_PLATFORM_CONSOLE
undef|#
directive|undef
name|TIF_PLATFORM_CONSOLE
end_undef
begin_comment
comment|/*  * Open a TIFF file for read/writing.  */
end_comment
begin_function
name|TIFF
modifier|*
DECL|function|TIFFOpen
name|TIFFOpen
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|mode
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"TIFFOpen"
decl_stmt|;
name|thandle_t
name|fd
decl_stmt|;
name|int
name|m
decl_stmt|;
name|DWORD
name|dwMode
decl_stmt|;
name|TIFF
modifier|*
name|tif
decl_stmt|;
name|size_t
name|nLen
decl_stmt|;
name|size_t
name|nWideLen
decl_stmt|;
name|wchar_t
modifier|*
name|wchName
decl_stmt|;
name|m
operator|=
name|_TIFFgetMode
argument_list|(
name|mode
argument_list|,
name|module
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|m
condition|)
block|{
case|case
name|O_RDONLY
case|:
name|dwMode
operator|=
name|OPEN_EXISTING
expr_stmt|;
break|break;
case|case
name|O_RDWR
case|:
name|dwMode
operator|=
name|OPEN_ALWAYS
expr_stmt|;
break|break;
case|case
name|O_RDWR
operator||
name|O_CREAT
case|:
name|dwMode
operator|=
name|OPEN_ALWAYS
expr_stmt|;
break|break;
case|case
name|O_RDWR
operator||
name|O_TRUNC
case|:
name|dwMode
operator|=
name|CREATE_ALWAYS
expr_stmt|;
break|break;
case|case
name|O_RDWR
operator||
name|O_CREAT
operator||
name|O_TRUNC
case|:
name|dwMode
operator|=
name|CREATE_ALWAYS
expr_stmt|;
break|break;
default|default:
return|return
operator|(
operator|(
name|TIFF
operator|*
operator|)
literal|0
operator|)
return|;
block|}
comment|/* On Windows CE, CreateFile is mapped to CreateFileW,      * but file path is passed as char-based string,      * so the path has to be converted to wchar_t.      */
name|nWideLen
operator|=
literal|0
expr_stmt|;
name|wchName
operator|=
name|NULL
expr_stmt|;
name|nLen
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
expr_stmt|;
name|nWideLen
operator|=
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|name
argument_list|,
name|nLen
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wchName
operator|=
operator|(
name|wchar_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|wchar_t
argument_list|)
operator|*
name|nWideLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|wchName
condition|)
block|{
name|TIFFErrorExt
argument_list|(
literal|0
argument_list|,
name|module
argument_list|,
literal|"Memory allocation error!"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|TIFF
operator|*
operator|)
literal|0
operator|)
return|;
block|}
name|memset
argument_list|(
name|wchName
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wchar_t
argument_list|)
operator|*
name|nWideLen
argument_list|)
expr_stmt|;
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|name
argument_list|,
name|nLen
argument_list|,
name|wchName
argument_list|,
name|nWideLen
argument_list|)
expr_stmt|;
name|fd
operator|=
operator|(
name|thandle_t
operator|)
name|CreateFile
argument_list|(
name|wchName
argument_list|,
operator|(
name|m
operator|==
name|O_RDONLY
operator|)
condition|?
name|GENERIC_READ
else|:
operator|(
name|GENERIC_READ
operator||
name|GENERIC_WRITE
operator|)
argument_list|,
name|FILE_SHARE_READ
operator||
name|FILE_SHARE_WRITE
argument_list|,
name|NULL
argument_list|,
name|dwMode
argument_list|,
operator|(
name|m
operator|==
name|O_RDONLY
operator|)
condition|?
name|FILE_ATTRIBUTE_READONLY
else|:
name|FILE_ATTRIBUTE_NORMAL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|wchName
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
name|TIFFErrorExt
argument_list|(
literal|0
argument_list|,
name|module
argument_list|,
literal|"%s: Cannot open"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|TIFF
operator|*
operator|)
literal|0
operator|)
return|;
block|}
comment|/* TODO - mloskot: change to TIFFdOpenW and pass wchar path */
name|tif
operator|=
name|TIFFFdOpen
argument_list|(
operator|(
name|int
operator|)
name|fd
argument_list|,
name|name
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tif
condition|)
name|CloseHandle
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|tif
return|;
block|}
end_function
begin_comment
comment|/*  * Open a TIFF file with a Unicode filename, for read/writing.  */
end_comment
begin_function
name|TIFF
modifier|*
DECL|function|TIFFOpenW
name|TIFFOpenW
parameter_list|(
specifier|const
name|wchar_t
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|mode
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|module
index|[]
init|=
literal|"TIFFOpenW"
decl_stmt|;
name|thandle_t
name|fd
decl_stmt|;
name|int
name|m
decl_stmt|;
name|DWORD
name|dwMode
decl_stmt|;
name|int
name|mbsize
decl_stmt|;
name|char
modifier|*
name|mbname
decl_stmt|;
name|TIFF
modifier|*
name|tif
decl_stmt|;
name|m
operator|=
name|_TIFFgetMode
argument_list|(
name|mode
argument_list|,
name|module
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|m
condition|)
block|{
case|case
name|O_RDONLY
case|:
name|dwMode
operator|=
name|OPEN_EXISTING
expr_stmt|;
break|break;
case|case
name|O_RDWR
case|:
name|dwMode
operator|=
name|OPEN_ALWAYS
expr_stmt|;
break|break;
case|case
name|O_RDWR
operator||
name|O_CREAT
case|:
name|dwMode
operator|=
name|OPEN_ALWAYS
expr_stmt|;
break|break;
case|case
name|O_RDWR
operator||
name|O_TRUNC
case|:
name|dwMode
operator|=
name|CREATE_ALWAYS
expr_stmt|;
break|break;
case|case
name|O_RDWR
operator||
name|O_CREAT
operator||
name|O_TRUNC
case|:
name|dwMode
operator|=
name|CREATE_ALWAYS
expr_stmt|;
break|break;
default|default:
return|return
operator|(
operator|(
name|TIFF
operator|*
operator|)
literal|0
operator|)
return|;
block|}
comment|/* On Windows CE, CreateFile is mapped to CreateFileW,      * so no conversion of wchar_t to char is required.      */
name|fd
operator|=
operator|(
name|thandle_t
operator|)
name|CreateFile
argument_list|(
name|name
argument_list|,
operator|(
name|m
operator|==
name|O_RDONLY
operator|)
condition|?
name|GENERIC_READ
else|:
operator|(
name|GENERIC_READ
operator||
name|GENERIC_WRITE
operator|)
argument_list|,
name|FILE_SHARE_READ
argument_list|,
name|NULL
argument_list|,
name|dwMode
argument_list|,
operator|(
name|m
operator|==
name|O_RDONLY
operator|)
condition|?
name|FILE_ATTRIBUTE_READONLY
else|:
name|FILE_ATTRIBUTE_NORMAL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
name|TIFFErrorExt
argument_list|(
literal|0
argument_list|,
name|module
argument_list|,
literal|"%S: Cannot open"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|TIFF
operator|*
operator|)
literal|0
operator|)
return|;
block|}
name|mbname
operator|=
name|NULL
expr_stmt|;
name|mbsize
operator|=
name|WideCharToMultiByte
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|name
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbsize
operator|>
literal|0
condition|)
block|{
name|mbname
operator|=
operator|(
name|char
operator|*
operator|)
name|_TIFFmalloc
argument_list|(
name|mbsize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mbname
condition|)
block|{
name|TIFFErrorExt
argument_list|(
literal|0
argument_list|,
name|module
argument_list|,
literal|"Can't allocate space for filename conversion buffer"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|TIFF
operator|*
operator|)
literal|0
operator|)
return|;
block|}
name|WideCharToMultiByte
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|name
argument_list|,
operator|-
literal|1
argument_list|,
name|mbname
argument_list|,
name|mbsize
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|tif
operator|=
name|TIFFFdOpen
argument_list|(
operator|(
name|int
operator|)
name|fd
argument_list|,
operator|(
name|mbname
operator|!=
name|NULL
operator|)
condition|?
name|mbname
else|:
literal|"<unknown>"
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tif
condition|)
name|CloseHandle
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|_TIFFfree
argument_list|(
name|mbname
argument_list|)
expr_stmt|;
return|return
name|tif
return|;
block|}
end_function
begin_function
specifier|static
name|void
DECL|function|Win32WarningHandler
name|Win32WarningHandler
parameter_list|(
specifier|const
name|char
modifier|*
name|module
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
comment|/* On Windows CE, MessageBox is mapped to wide-char based MessageBoxW. */
name|size_t
name|nWideLen
init|=
literal|0
decl_stmt|;
name|LPTSTR
name|szWideTitle
init|=
name|NULL
decl_stmt|;
name|LPTSTR
name|szWideMsg
init|=
name|NULL
decl_stmt|;
name|LPSTR
name|szTitle
decl_stmt|;
name|LPSTR
name|szTmp
decl_stmt|;
name|LPCSTR
name|szTitleText
init|=
literal|"%s Warning"
decl_stmt|;
name|LPCSTR
name|szDefaultModule
init|=
literal|"LIBTIFF"
decl_stmt|;
name|LPCSTR
name|szTmpModule
decl_stmt|;
name|szTmpModule
operator|=
operator|(
name|module
operator|==
name|NULL
operator|)
condition|?
name|szDefaultModule
else|:
name|module
expr_stmt|;
if|if
condition|(
operator|(
name|szTitle
operator|=
operator|(
name|LPSTR
operator|)
name|LocalAlloc
argument_list|(
name|LMEM_FIXED
argument_list|,
operator|(
name|strlen
argument_list|(
name|szTmpModule
argument_list|)
operator|+
name|strlen
argument_list|(
name|szTitleText
argument_list|)
operator|+
name|strlen
argument_list|(
name|fmt
argument_list|)
operator|+
literal|128
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|sprintf
argument_list|(
name|szTitle
argument_list|,
name|szTitleText
argument_list|,
name|szTmpModule
argument_list|)
expr_stmt|;
name|szTmp
operator|=
name|szTitle
operator|+
operator|(
name|strlen
argument_list|(
name|szTitle
argument_list|)
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
expr_stmt|;
name|vsprintf
argument_list|(
name|szTmp
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
comment|/* Convert error message to Unicode. */
name|nWideLen
operator|=
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|szTitle
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|szWideTitle
operator|=
operator|(
name|wchar_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|wchar_t
argument_list|)
operator|*
name|nWideLen
argument_list|)
expr_stmt|;
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|szTitle
argument_list|,
operator|-
literal|1
argument_list|,
name|szWideTitle
argument_list|,
name|nWideLen
argument_list|)
expr_stmt|;
name|nWideLen
operator|=
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|szTmp
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|szWideMsg
operator|=
operator|(
name|wchar_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|wchar_t
argument_list|)
operator|*
name|nWideLen
argument_list|)
expr_stmt|;
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|szTmp
argument_list|,
operator|-
literal|1
argument_list|,
name|szWideMsg
argument_list|,
name|nWideLen
argument_list|)
expr_stmt|;
comment|/* Display message */
name|MessageBox
argument_list|(
name|GetFocus
argument_list|()
argument_list|,
name|szWideMsg
argument_list|,
name|szWideTitle
argument_list|,
name|MB_OK
operator||
name|MB_ICONEXCLAMATION
argument_list|)
expr_stmt|;
comment|/* Free resources */
name|LocalFree
argument_list|(
name|szTitle
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|szWideMsg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|szWideTitle
argument_list|)
expr_stmt|;
block|}
end_function
begin_decl_stmt
DECL|variable|_TIFFwarningHandler
name|TIFFErrorHandler
name|_TIFFwarningHandler
init|=
name|Win32WarningHandler
decl_stmt|;
end_decl_stmt
begin_function
specifier|static
name|void
DECL|function|Win32ErrorHandler
name|Win32ErrorHandler
parameter_list|(
specifier|const
name|char
modifier|*
name|module
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
comment|/* On Windows CE, MessageBox is mapped to wide-char based MessageBoxW. */
name|size_t
name|nWideLen
init|=
literal|0
decl_stmt|;
name|LPTSTR
name|szWideTitle
init|=
name|NULL
decl_stmt|;
name|LPTSTR
name|szWideMsg
init|=
name|NULL
decl_stmt|;
name|LPSTR
name|szTitle
decl_stmt|;
name|LPSTR
name|szTmp
decl_stmt|;
name|LPCSTR
name|szTitleText
init|=
literal|"%s Error"
decl_stmt|;
name|LPCSTR
name|szDefaultModule
init|=
literal|"LIBTIFF"
decl_stmt|;
name|LPCSTR
name|szTmpModule
decl_stmt|;
name|szTmpModule
operator|=
operator|(
name|module
operator|==
name|NULL
operator|)
condition|?
name|szDefaultModule
else|:
name|module
expr_stmt|;
if|if
condition|(
operator|(
name|szTitle
operator|=
operator|(
name|LPSTR
operator|)
name|LocalAlloc
argument_list|(
name|LMEM_FIXED
argument_list|,
operator|(
name|strlen
argument_list|(
name|szTmpModule
argument_list|)
operator|+
name|strlen
argument_list|(
name|szTitleText
argument_list|)
operator|+
name|strlen
argument_list|(
name|fmt
argument_list|)
operator|+
literal|128
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|sprintf
argument_list|(
name|szTitle
argument_list|,
name|szTitleText
argument_list|,
name|szTmpModule
argument_list|)
expr_stmt|;
name|szTmp
operator|=
name|szTitle
operator|+
operator|(
name|strlen
argument_list|(
name|szTitle
argument_list|)
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
expr_stmt|;
name|vsprintf
argument_list|(
name|szTmp
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
comment|/* Convert error message to Unicode. */
name|nWideLen
operator|=
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|szTitle
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|szWideTitle
operator|=
operator|(
name|wchar_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|wchar_t
argument_list|)
operator|*
name|nWideLen
argument_list|)
expr_stmt|;
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|szTitle
argument_list|,
operator|-
literal|1
argument_list|,
name|szWideTitle
argument_list|,
name|nWideLen
argument_list|)
expr_stmt|;
name|nWideLen
operator|=
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|szTmp
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|szWideMsg
operator|=
operator|(
name|wchar_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|wchar_t
argument_list|)
operator|*
name|nWideLen
argument_list|)
expr_stmt|;
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|szTmp
argument_list|,
operator|-
literal|1
argument_list|,
name|szWideMsg
argument_list|,
name|nWideLen
argument_list|)
expr_stmt|;
comment|/* Display message */
name|MessageBox
argument_list|(
name|GetFocus
argument_list|()
argument_list|,
name|szWideMsg
argument_list|,
name|szWideTitle
argument_list|,
name|MB_OK
operator||
name|MB_ICONEXCLAMATION
argument_list|)
expr_stmt|;
comment|/* Free resources */
name|LocalFree
argument_list|(
name|szTitle
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|szWideMsg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|szWideTitle
argument_list|)
expr_stmt|;
block|}
end_function
begin_decl_stmt
DECL|variable|_TIFFerrorHandler
name|TIFFErrorHandler
name|_TIFFerrorHandler
init|=
name|Win32ErrorHandler
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* vim: set ts=8 sts=8 sw=8 noet: */
end_comment
end_unit
