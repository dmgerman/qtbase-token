begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2013 Digia Plc and/or its subsidiary(-ies). ** Contact: http://www.qt-project.org/legal ** ** This file is part of the QtGui module of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** Commercial License Usage ** Licensees holding valid commercial Qt licenses may use this file in ** accordance with the commercial license agreement provided with the ** Software or, alternatively, in accordance with the terms contained in ** a written agreement between you and Digia.  For licensing terms and ** conditions see http://qt.digia.com/licensing.  For further information ** use the contact form at http://qt.digia.com/contact-us. ** ** GNU Lesser General Public License Usage ** Alternatively, this file may be used under the terms of the GNU Lesser ** General Public License version 2.1 as published by the Free Software ** Foundation and appearing in the file LICENSE.LGPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU Lesser General Public License version 2.1 requirements ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Digia gives you certain additional ** rights.  These rights are described in the Digia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU ** General Public License version 3.0 as published by the Free Software ** Foundation and appearing in the file LICENSE.GPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU General Public License version 3.0 requirements will be ** met: http://www.gnu.org/copyleft/gpl.html. ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_ifndef
ifndef|#
directive|ifndef
name|QT_NO_PRINTER
end_ifndef
begin_include
include|#
directive|include
file|"qprintengine_win_p.h"
end_include
begin_include
include|#
directive|include
file|<limits.h>
end_include
begin_include
include|#
directive|include
file|<private/qprinter_p.h>
end_include
begin_include
include|#
directive|include
file|<private/qfont_p.h>
end_include
begin_include
include|#
directive|include
file|<private/qfontengine_p.h>
end_include
begin_include
include|#
directive|include
file|<private/qpainter_p.h>
end_include
begin_include
include|#
directive|include
file|<qpa/qplatformprintplugin.h>
end_include
begin_include
include|#
directive|include
file|<qpa/qplatformprintersupport.h>
end_include
begin_include
include|#
directive|include
file|<qbitmap.h>
end_include
begin_include
include|#
directive|include
file|<qdebug.h>
end_include
begin_include
include|#
directive|include
file|<qvector.h>
end_include
begin_include
include|#
directive|include
file|<qpicture.h>
end_include
begin_include
include|#
directive|include
file|<qpa/qplatformpixmap.h>
end_include
begin_include
include|#
directive|include
file|<private/qpicture_p.h>
end_include
begin_include
include|#
directive|include
file|<private/qpixmap_raster_p.h>
end_include
begin_include
include|#
directive|include
file|<QtCore/QMetaType>
end_include
begin_include
include|#
directive|include
file|<QtCore/qt_windows.h>
end_include
begin_include
include|#
directive|include
file|<QtGui/qpagelayout.h>
end_include
begin_macro
name|Q_DECLARE_METATYPE
argument_list|(
argument|HFONT
argument_list|)
end_macro
begin_macro
name|Q_DECLARE_METATYPE
argument_list|(
argument|LOGFONT
argument_list|)
end_macro
begin_function_decl
name|QT_BEGIN_NAMESPACE
name|Q_GUI_EXPORT
name|HBITMAP
name|qt_pixmapToWinHBITMAP
parameter_list|(
specifier|const
name|QPixmap
modifier|&
name|p
parameter_list|,
name|int
name|hbitmapFormat
init|=
literal|0
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|extern
name|QPainterPath
name|qt_regionToPath
parameter_list|(
specifier|const
name|QRegion
modifier|&
name|region
parameter_list|)
function_decl|;
end_function_decl
begin_function_decl
specifier|extern
name|QMarginsF
name|qt_convertMargins
parameter_list|(
specifier|const
name|QMarginsF
modifier|&
name|margins
parameter_list|,
name|QPageLayout
operator|::
name|Unit
name|fromUnits
parameter_list|,
name|QPageLayout
operator|::
name|Unit
name|toUnits
parameter_list|)
function_decl|;
end_function_decl
begin_comment
comment|// #define QT_DEBUG_DRAW
end_comment
begin_comment
comment|// #define QT_DEBUG_METRICS
end_comment
begin_function_decl
specifier|static
name|void
name|draw_text_item_win
parameter_list|(
specifier|const
name|QPointF
modifier|&
name|_pos
parameter_list|,
specifier|const
name|QTextItemInt
modifier|&
name|ti
parameter_list|,
name|HDC
name|hdc
parameter_list|,
name|bool
name|convertToText
parameter_list|,
specifier|const
name|QTransform
modifier|&
name|xform
parameter_list|,
specifier|const
name|QPointF
modifier|&
name|topLeft
parameter_list|)
function_decl|;
end_function_decl
begin_constructor
DECL|function|QWin32PrintEngine
name|QWin32PrintEngine
operator|::
name|QWin32PrintEngine
parameter_list|(
name|QPrinter
operator|::
name|PrinterMode
name|mode
parameter_list|)
member_init_list|:
name|QAlphaPaintEngine
argument_list|(
operator|*
operator|(
operator|new
name|QWin32PrintEnginePrivate
operator|)
argument_list|,
name|PaintEngineFeatures
argument_list|(
name|PrimitiveTransform
operator||
name|PixmapTransform
operator||
name|PerspectiveTransform
operator||
name|PainterPaths
operator||
name|Antialiasing
operator||
name|PaintOutsidePaintEvent
argument_list|)
argument_list|)
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|d
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
name|QPlatformPrinterSupport
modifier|*
name|ps
init|=
name|QPlatformPrinterSupportPlugin
operator|::
name|get
argument_list|()
decl_stmt|;
if|if
condition|(
name|ps
condition|)
name|d
operator|->
name|m_printDevice
operator|=
name|ps
operator|->
name|createDefaultPrintDevice
argument_list|()
expr_stmt|;
name|d
operator|->
name|m_pageLayout
operator|.
name|setPageSize
argument_list|(
name|d
operator|->
name|m_printDevice
operator|.
name|defaultPageSize
argument_list|()
argument_list|)
expr_stmt|;
name|d
operator|->
name|initialize
argument_list|()
expr_stmt|;
block|}
end_constructor
begin_function
DECL|function|begin
name|bool
name|QWin32PrintEngine
operator|::
name|begin
parameter_list|(
name|QPaintDevice
modifier|*
name|pdev
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|QAlphaPaintEngine
operator|::
name|begin
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|continueCall
argument_list|()
condition|)
return|return
literal|true
return|;
if|if
condition|(
name|d
operator|->
name|reinit
condition|)
block|{
name|d
operator|->
name|resetDC
argument_list|()
expr_stmt|;
name|d
operator|->
name|reinit
operator|=
literal|false
expr_stmt|;
block|}
comment|// ### set default colors and stuff...
name|bool
name|ok
init|=
name|d
operator|->
name|state
operator|==
name|QPrinter
operator|::
name|Idle
decl_stmt|;
if|if
condition|(
operator|!
name|d
operator|->
name|hdc
condition|)
return|return
literal|false
return|;
name|d
operator|->
name|devMode
operator|->
name|dmCopies
operator|=
name|d
operator|->
name|num_copies
expr_stmt|;
name|DOCINFO
name|di
decl_stmt|;
name|memset
argument_list|(
operator|&
name|di
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|DOCINFO
argument_list|)
argument_list|)
expr_stmt|;
name|di
operator|.
name|cbSize
operator|=
sizeof|sizeof
argument_list|(
name|DOCINFO
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|docName
operator|.
name|isEmpty
argument_list|()
condition|)
name|di
operator|.
name|lpszDocName
operator|=
literal|L"document1"
expr_stmt|;
else|else
name|di
operator|.
name|lpszDocName
operator|=
cast|reinterpret_cast
argument_list|<
specifier|const
name|wchar_t
operator|*
argument_list|>
argument_list|(
name|d
operator|->
name|docName
operator|.
name|utf16
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|printToFile
operator|&&
operator|!
name|d
operator|->
name|fileName
operator|.
name|isEmpty
argument_list|()
condition|)
name|di
operator|.
name|lpszOutput
operator|=
cast|reinterpret_cast
argument_list|<
specifier|const
name|wchar_t
operator|*
argument_list|>
argument_list|(
name|d
operator|->
name|fileName
operator|.
name|utf16
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|printToFile
condition|)
name|di
operator|.
name|lpszOutput
operator|=
name|d
operator|->
name|fileName
operator|.
name|isEmpty
argument_list|()
condition|?
literal|L"FILE:"
else|:
cast|reinterpret_cast
argument_list|<
specifier|const
name|wchar_t
operator|*
argument_list|>
argument_list|(
name|d
operator|->
name|fileName
operator|.
name|utf16
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ok
operator|&&
name|StartDoc
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
operator|&
name|di
argument_list|)
operator|==
name|SP_ERROR
condition|)
block|{
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEngine::begin: StartDoc failed"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
name|StartPage
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEngine::begin: StartPage failed"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|d
operator|->
name|state
operator|=
name|QPrinter
operator|::
name|Idle
expr_stmt|;
block|}
else|else
block|{
name|d
operator|->
name|state
operator|=
name|QPrinter
operator|::
name|Active
expr_stmt|;
block|}
name|d
operator|->
name|matrix
operator|=
name|QTransform
argument_list|()
expr_stmt|;
name|d
operator|->
name|has_pen
operator|=
literal|true
expr_stmt|;
name|d
operator|->
name|pen
operator|=
name|QColor
argument_list|(
name|Qt
operator|::
name|black
argument_list|)
expr_stmt|;
name|d
operator|->
name|has_brush
operator|=
literal|false
expr_stmt|;
name|d
operator|->
name|complex_xform
operator|=
literal|false
expr_stmt|;
name|updateMatrix
argument_list|(
name|d
operator|->
name|matrix
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ok
condition|)
name|cleanUp
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::begin()"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
return|return
name|ok
return|;
block|}
end_function
begin_function
DECL|function|end
name|bool
name|QWin32PrintEngine
operator|::
name|end
parameter_list|()
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|hdc
condition|)
block|{
if|if
condition|(
name|d
operator|->
name|state
operator|==
name|QPrinter
operator|::
name|Aborted
condition|)
block|{
name|cleanUp
argument_list|()
expr_stmt|;
name|AbortDoc
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
block|}
name|QAlphaPaintEngine
operator|::
name|end
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|continueCall
argument_list|()
condition|)
return|return
literal|true
return|;
if|if
condition|(
name|d
operator|->
name|hdc
condition|)
block|{
name|EndPage
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
expr_stmt|;
comment|// end; printing done
name|EndDoc
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
expr_stmt|;
block|}
name|d
operator|->
name|state
operator|=
name|QPrinter
operator|::
name|Idle
expr_stmt|;
name|d
operator|->
name|reinit
operator|=
literal|true
expr_stmt|;
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|newPage
name|bool
name|QWin32PrintEngine
operator|::
name|newPage
parameter_list|()
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|Q_ASSERT
argument_list|(
name|isActive
argument_list|()
argument_list|)
expr_stmt|;
name|Q_ASSERT
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
expr_stmt|;
name|flushAndInit
argument_list|()
expr_stmt|;
name|bool
name|transparent
init|=
name|GetBkMode
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
operator|==
name|TRANSPARENT
decl_stmt|;
if|if
condition|(
operator|!
name|EndPage
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
condition|)
block|{
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEngine::newPage: EndPage failed"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
if|if
condition|(
name|d
operator|->
name|reinit
condition|)
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|resetDC
argument_list|()
condition|)
block|{
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEngine::newPage: ResetDC failed"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|d
operator|->
name|reinit
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|StartPage
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
condition|)
block|{
name|qErrnoWarning
argument_list|(
literal|"Win32PrintEngine::newPage: StartPage failed"
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|SetTextAlign
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|TA_BASELINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|transparent
condition|)
name|SetBkMode
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|TRANSPARENT
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::newPage()"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
comment|// ###
return|return
literal|true
return|;
name|bool
name|success
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|d
operator|->
name|hdc
operator|&&
name|d
operator|->
name|state
operator|==
name|QPrinter
operator|::
name|Active
condition|)
block|{
if|if
condition|(
name|EndPage
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
operator|!=
name|SP_ERROR
condition|)
block|{
comment|// reinitialize the DC before StartPage if needed,
comment|// because resetdc is disabled between calls to the StartPage and EndPage functions
comment|// (see StartPage documentation in the Platform SDK:Windows GDI)
comment|//          state = PST_ACTIVEDOC;
comment|//          reinit();
comment|//          state = PST_ACTIVE;
comment|// start the new page now
if|if
condition|(
name|d
operator|->
name|reinit
condition|)
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|resetDC
argument_list|()
condition|)
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEngine::newPage(), ResetDC failed (2)"
argument_list|)
expr_stmt|;
name|d
operator|->
name|reinit
operator|=
literal|false
expr_stmt|;
block|}
name|success
operator|=
operator|(
name|StartPage
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
operator|!=
name|SP_ERROR
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|success
condition|)
block|{
name|d
operator|->
name|state
operator|=
name|QPrinter
operator|::
name|Aborted
expr_stmt|;
return|return
literal|false
return|;
block|}
block|}
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|abort
name|bool
name|QWin32PrintEngine
operator|::
name|abort
parameter_list|()
block|{
comment|// do nothing loop.
return|return
literal|false
return|;
block|}
end_function
begin_function
DECL|function|drawTextItem
name|void
name|QWin32PrintEngine
operator|::
name|drawTextItem
parameter_list|(
specifier|const
name|QPointF
modifier|&
name|p
parameter_list|,
specifier|const
name|QTextItem
modifier|&
name|textItem
parameter_list|)
block|{
name|Q_D
argument_list|(
specifier|const
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|QAlphaPaintEngine
operator|::
name|drawTextItem
argument_list|(
name|p
argument_list|,
name|textItem
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|continueCall
argument_list|()
condition|)
return|return;
specifier|const
name|QTextItemInt
modifier|&
name|ti
init|=
cast|static_cast
argument_list|<
specifier|const
name|QTextItemInt
operator|&
argument_list|>
argument_list|(
name|textItem
argument_list|)
decl_stmt|;
name|QRgb
name|brushColor
init|=
name|state
operator|->
name|pen
argument_list|()
operator|.
name|brush
argument_list|()
operator|.
name|color
argument_list|()
operator|.
name|rgb
argument_list|()
decl_stmt|;
name|bool
name|fallBack
init|=
name|state
operator|->
name|pen
argument_list|()
operator|.
name|brush
argument_list|()
operator|.
name|style
argument_list|()
operator|!=
name|Qt
operator|::
name|SolidPattern
operator|||
name|qAlpha
argument_list|(
name|brushColor
argument_list|)
operator|!=
literal|0xff
operator|||
name|d
operator|->
name|txop
operator|>=
name|QTransform
operator|::
name|TxProject
operator|||
name|ti
operator|.
name|fontEngine
operator|->
name|type
argument_list|()
operator|!=
name|QFontEngine
operator|::
name|Win
decl_stmt|;
if|if
condition|(
operator|!
name|fallBack
condition|)
block|{
specifier|const
name|QVariantMap
name|userData
init|=
name|ti
operator|.
name|fontEngine
operator|->
name|userData
argument_list|()
operator|.
name|toMap
argument_list|()
decl_stmt|;
specifier|const
name|QVariant
name|hFontV
init|=
name|userData
operator|.
name|value
argument_list|(
name|QStringLiteral
argument_list|(
literal|"hFont"
argument_list|)
argument_list|)
decl_stmt|;
specifier|const
name|QVariant
name|logFontV
init|=
name|userData
operator|.
name|value
argument_list|(
name|QStringLiteral
argument_list|(
literal|"logFont"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|hFontV
operator|.
name|canConvert
argument_list|<
name|HFONT
argument_list|>
argument_list|()
operator|&&
name|logFontV
operator|.
name|canConvert
argument_list|<
name|LOGFONT
argument_list|>
argument_list|()
condition|)
block|{
specifier|const
name|HFONT
name|hfont
init|=
name|hFontV
operator|.
name|value
argument_list|<
name|HFONT
argument_list|>
argument_list|()
decl_stmt|;
specifier|const
name|LOGFONT
name|logFont
init|=
name|logFontV
operator|.
name|value
argument_list|<
name|LOGFONT
argument_list|>
argument_list|()
decl_stmt|;
comment|// Try selecting the font to see if we get a substitution font
name|SelectObject
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|hfont
argument_list|)
expr_stmt|;
if|if
condition|(
name|GetDeviceCaps
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|TECHNOLOGY
argument_list|)
operator|!=
name|DT_CHARSTREAM
condition|)
block|{
name|wchar_t
name|n
index|[
literal|64
index|]
decl_stmt|;
name|GetTextFace
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
literal|64
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|fallBack
operator|=
name|QString
operator|::
name|fromWCharArray
argument_list|(
name|n
argument_list|)
operator|!=
name|QString
operator|::
name|fromWCharArray
argument_list|(
name|logFont
operator|.
name|lfFaceName
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|fallBack
condition|)
block|{
name|QPaintEngine
operator|::
name|drawTextItem
argument_list|(
name|p
argument_list|,
name|textItem
argument_list|)
expr_stmt|;
return|return ;
block|}
comment|// We only want to convert the glyphs to text if the entire string is compatible with ASCII
comment|// and if we actually have access to the chars.
name|bool
name|convertToText
init|=
name|ti
operator|.
name|chars
operator|!=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|ti
operator|.
name|num_chars
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|ti
operator|.
name|chars
index|[
name|i
index|]
operator|.
name|unicode
argument_list|()
operator|>=
literal|0x80
condition|)
block|{
name|convertToText
operator|=
literal|false
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ti
operator|.
name|logClusters
index|[
name|i
index|]
operator|!=
name|i
condition|)
block|{
name|convertToText
operator|=
literal|false
expr_stmt|;
break|break;
block|}
block|}
name|COLORREF
name|cf
init|=
name|RGB
argument_list|(
name|qRed
argument_list|(
name|brushColor
argument_list|)
argument_list|,
name|qGreen
argument_list|(
name|brushColor
argument_list|)
argument_list|,
name|qBlue
argument_list|(
name|brushColor
argument_list|)
argument_list|)
decl_stmt|;
name|SelectObject
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|CreateSolidBrush
argument_list|(
name|cf
argument_list|)
argument_list|)
expr_stmt|;
name|SelectObject
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|CreatePen
argument_list|(
name|PS_SOLID
argument_list|,
literal|1
argument_list|,
name|cf
argument_list|)
argument_list|)
expr_stmt|;
name|SetTextColor
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|cf
argument_list|)
expr_stmt|;
name|draw_text_item_win
argument_list|(
name|p
argument_list|,
name|ti
argument_list|,
name|d
operator|->
name|hdc
argument_list|,
name|convertToText
argument_list|,
name|d
operator|->
name|matrix
argument_list|,
name|QPointF
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|)
argument_list|)
expr_stmt|;
name|DeleteObject
argument_list|(
name|SelectObject
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|GetStockObject
argument_list|(
name|HOLLOW_BRUSH
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|DeleteObject
argument_list|(
name|SelectObject
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|GetStockObject
argument_list|(
name|BLACK_PEN
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|metric
name|int
name|QWin32PrintEngine
operator|::
name|metric
parameter_list|(
name|QPaintDevice
operator|::
name|PaintDeviceMetric
name|m
parameter_list|)
specifier|const
block|{
name|Q_D
argument_list|(
specifier|const
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|d
operator|->
name|hdc
condition|)
return|return
literal|0
return|;
name|int
name|val
decl_stmt|;
name|int
name|res
init|=
name|d
operator|->
name|resolution
decl_stmt|;
switch|switch
condition|(
name|m
condition|)
block|{
case|case
name|QPaintDevice
operator|::
name|PdmWidth
case|:
name|val
operator|=
name|d
operator|->
name|m_paintRectPixels
operator|.
name|width
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::metric(PdmWidth) = "
operator|<<
name|val
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
case|case
name|QPaintDevice
operator|::
name|PdmHeight
case|:
name|val
operator|=
name|d
operator|->
name|m_paintRectPixels
operator|.
name|height
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::metric(PdmHeight) = "
operator|<<
name|val
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
case|case
name|QPaintDevice
operator|::
name|PdmDpiX
case|:
name|val
operator|=
name|res
expr_stmt|;
break|break;
case|case
name|QPaintDevice
operator|::
name|PdmDpiY
case|:
name|val
operator|=
name|res
expr_stmt|;
break|break;
case|case
name|QPaintDevice
operator|::
name|PdmPhysicalDpiX
case|:
name|val
operator|=
name|GetDeviceCaps
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|LOGPIXELSX
argument_list|)
expr_stmt|;
break|break;
case|case
name|QPaintDevice
operator|::
name|PdmPhysicalDpiY
case|:
name|val
operator|=
name|GetDeviceCaps
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|LOGPIXELSY
argument_list|)
expr_stmt|;
break|break;
case|case
name|QPaintDevice
operator|::
name|PdmWidthMM
case|:
name|val
operator|=
name|d
operator|->
name|m_paintSizeMM
operator|.
name|width
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::metric(PdmWidthMM) = "
operator|<<
name|val
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
case|case
name|QPaintDevice
operator|::
name|PdmHeightMM
case|:
name|val
operator|=
name|d
operator|->
name|m_paintSizeMM
operator|.
name|height
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::metric(PdmHeightMM) = "
operator|<<
name|val
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
case|case
name|QPaintDevice
operator|::
name|PdmNumColors
case|:
block|{
name|int
name|bpp
init|=
name|GetDeviceCaps
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|BITSPIXEL
argument_list|)
decl_stmt|;
if|if
condition|(
name|bpp
operator|==
literal|32
condition|)
name|val
operator|=
name|INT_MAX
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|<=
literal|8
condition|)
name|val
operator|=
name|GetDeviceCaps
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|NUMCOLORS
argument_list|)
expr_stmt|;
else|else
name|val
operator|=
literal|1
operator|<<
operator|(
name|bpp
operator|*
name|GetDeviceCaps
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|PLANES
argument_list|)
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|QPaintDevice
operator|::
name|PdmDepth
case|:
name|val
operator|=
name|GetDeviceCaps
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|PLANES
argument_list|)
expr_stmt|;
break|break;
default|default:
name|qWarning
argument_list|(
literal|"QPrinter::metric: Invalid metric command"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|val
return|;
block|}
end_function
begin_function
DECL|function|updateState
name|void
name|QWin32PrintEngine
operator|::
name|updateState
parameter_list|(
specifier|const
name|QPaintEngineState
modifier|&
name|state
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|QAlphaPaintEngine
operator|::
name|updateState
argument_list|(
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|continueCall
argument_list|()
condition|)
return|return;
if|if
condition|(
name|state
operator|.
name|state
argument_list|()
operator|&
name|DirtyTransform
condition|)
block|{
name|updateMatrix
argument_list|(
name|state
operator|.
name|transform
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|.
name|state
argument_list|()
operator|&
name|DirtyPen
condition|)
block|{
name|d
operator|->
name|pen
operator|=
name|state
operator|.
name|pen
argument_list|()
expr_stmt|;
name|d
operator|->
name|has_pen
operator|=
name|d
operator|->
name|pen
operator|.
name|style
argument_list|()
operator|!=
name|Qt
operator|::
name|NoPen
operator|&&
name|d
operator|->
name|pen
operator|.
name|isSolid
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|.
name|state
argument_list|()
operator|&
name|DirtyBrush
condition|)
block|{
name|QBrush
name|brush
init|=
name|state
operator|.
name|brush
argument_list|()
decl_stmt|;
name|d
operator|->
name|has_brush
operator|=
name|brush
operator|.
name|style
argument_list|()
operator|==
name|Qt
operator|::
name|SolidPattern
expr_stmt|;
name|d
operator|->
name|brush_color
operator|=
name|brush
operator|.
name|color
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|.
name|state
argument_list|()
operator|&
name|DirtyClipEnabled
condition|)
block|{
if|if
condition|(
name|state
operator|.
name|isClipEnabled
argument_list|()
condition|)
name|updateClipPath
argument_list|(
name|painter
argument_list|()
operator|->
name|clipPath
argument_list|()
argument_list|,
name|Qt
operator|::
name|ReplaceClip
argument_list|)
expr_stmt|;
else|else
name|updateClipPath
argument_list|(
name|QPainterPath
argument_list|()
argument_list|,
name|Qt
operator|::
name|NoClip
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|.
name|state
argument_list|()
operator|&
name|DirtyClipPath
condition|)
block|{
name|updateClipPath
argument_list|(
name|state
operator|.
name|clipPath
argument_list|()
argument_list|,
name|state
operator|.
name|clipOperation
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|.
name|state
argument_list|()
operator|&
name|DirtyClipRegion
condition|)
block|{
name|QRegion
name|clipRegion
init|=
name|state
operator|.
name|clipRegion
argument_list|()
decl_stmt|;
name|QPainterPath
name|clipPath
init|=
name|qt_regionToPath
argument_list|(
name|clipRegion
argument_list|)
decl_stmt|;
name|updateClipPath
argument_list|(
name|clipPath
argument_list|,
name|state
operator|.
name|clipOperation
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|updateClipPath
name|void
name|QWin32PrintEngine
operator|::
name|updateClipPath
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|clipPath
parameter_list|,
name|Qt
operator|::
name|ClipOperation
name|op
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|bool
name|doclip
init|=
literal|true
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|Qt
operator|::
name|NoClip
condition|)
block|{
name|SelectClipRgn
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|doclip
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
name|doclip
condition|)
block|{
name|QPainterPath
name|xformed
init|=
name|clipPath
operator|*
name|d
operator|->
name|matrix
decl_stmt|;
if|if
condition|(
name|xformed
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|//            QRegion empty(-0x1000000, -0x1000000, 1, 1);
name|HRGN
name|empty
init|=
name|CreateRectRgn
argument_list|(
operator|-
literal|0x1000000
argument_list|,
operator|-
literal|0x1000000
argument_list|,
operator|-
literal|0x0fffffff
argument_list|,
operator|-
literal|0x0ffffff
argument_list|)
decl_stmt|;
name|SelectClipRgn
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|empty
argument_list|)
expr_stmt|;
name|DeleteObject
argument_list|(
name|empty
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|d
operator|->
name|composeGdiPath
argument_list|(
name|xformed
argument_list|)
expr_stmt|;
specifier|const
name|int
name|ops
index|[]
init|=
block|{
operator|-
literal|1
block|,
comment|// Qt::NoClip, covered above
name|RGN_COPY
block|,
comment|// Qt::ReplaceClip
name|RGN_AND
block|,
comment|// Qt::IntersectClip
name|RGN_OR
comment|// Qt::UniteClip
block|}
decl_stmt|;
name|Q_ASSERT
argument_list|(
name|op
operator|>
literal|0
operator|&&
name|unsigned
argument_list|(
name|op
argument_list|)
operator|<=
sizeof|sizeof
argument_list|(
name|ops
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|SelectClipPath
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|ops
index|[
name|op
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|QPainterPath
name|aclip
init|=
name|qt_regionToPath
argument_list|(
name|alphaClipping
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|aclip
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|QTransform
name|tx
argument_list|(
name|d
operator|->
name|stretch_x
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|d
operator|->
name|stretch_y
argument_list|,
name|d
operator|->
name|origin_x
argument_list|,
name|d
operator|->
name|origin_y
argument_list|)
decl_stmt|;
name|d
operator|->
name|composeGdiPath
argument_list|(
name|tx
operator|.
name|map
argument_list|(
name|aclip
argument_list|)
argument_list|)
expr_stmt|;
name|SelectClipPath
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|RGN_DIFF
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|updateMatrix
name|void
name|QWin32PrintEngine
operator|::
name|updateMatrix
parameter_list|(
specifier|const
name|QTransform
modifier|&
name|m
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|QTransform
name|stretch
argument_list|(
name|d
operator|->
name|stretch_x
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|d
operator|->
name|stretch_y
argument_list|,
name|d
operator|->
name|origin_x
argument_list|,
name|d
operator|->
name|origin_y
argument_list|)
decl_stmt|;
name|d
operator|->
name|painterMatrix
operator|=
name|m
expr_stmt|;
name|d
operator|->
name|matrix
operator|=
name|d
operator|->
name|painterMatrix
operator|*
name|stretch
expr_stmt|;
name|d
operator|->
name|txop
operator|=
name|d
operator|->
name|matrix
operator|.
name|type
argument_list|()
expr_stmt|;
name|d
operator|->
name|complex_xform
operator|=
operator|(
name|d
operator|->
name|txop
operator|>
name|QTransform
operator|::
name|TxScale
operator|)
expr_stmt|;
block|}
end_function
begin_enum
DECL|enum|HBitmapFormat
enum|enum
name|HBitmapFormat
block|{
DECL|enumerator|HBitmapNoAlpha
name|HBitmapNoAlpha
block|,
DECL|enumerator|HBitmapPremultipliedAlpha
name|HBitmapPremultipliedAlpha
block|,
DECL|enumerator|HBitmapAlpha
name|HBitmapAlpha
block|}
enum|;
end_enum
begin_function
DECL|function|drawPixmap
name|void
name|QWin32PrintEngine
operator|::
name|drawPixmap
parameter_list|(
specifier|const
name|QRectF
modifier|&
name|targetRect
parameter_list|,
specifier|const
name|QPixmap
modifier|&
name|originalPixmap
parameter_list|,
specifier|const
name|QRectF
modifier|&
name|sourceRect
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|QAlphaPaintEngine
operator|::
name|drawPixmap
argument_list|(
name|targetRect
argument_list|,
name|originalPixmap
argument_list|,
name|sourceRect
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|continueCall
argument_list|()
condition|)
return|return;
specifier|const
name|int
name|tileSize
init|=
literal|2048
decl_stmt|;
name|QRectF
name|r
init|=
name|targetRect
decl_stmt|;
name|QRectF
name|sr
init|=
name|sourceRect
decl_stmt|;
name|QPixmap
name|pixmap
init|=
name|originalPixmap
decl_stmt|;
if|if
condition|(
name|sr
operator|.
name|size
argument_list|()
operator|!=
name|pixmap
operator|.
name|size
argument_list|()
condition|)
block|{
name|pixmap
operator|=
name|pixmap
operator|.
name|copy
argument_list|(
name|sr
operator|.
name|toRect
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|qreal
name|scaleX
init|=
literal|1.0f
decl_stmt|;
name|qreal
name|scaleY
init|=
literal|1.0f
decl_stmt|;
name|QTransform
name|scaleMatrix
init|=
name|QTransform
operator|::
name|fromScale
argument_list|(
name|r
operator|.
name|width
argument_list|()
operator|/
name|pixmap
operator|.
name|width
argument_list|()
argument_list|,
name|r
operator|.
name|height
argument_list|()
operator|/
name|pixmap
operator|.
name|height
argument_list|()
argument_list|)
decl_stmt|;
name|QTransform
name|adapted
init|=
name|QPixmap
operator|::
name|trueMatrix
argument_list|(
name|d
operator|->
name|painterMatrix
operator|*
name|scaleMatrix
argument_list|,
name|pixmap
operator|.
name|width
argument_list|()
argument_list|,
name|pixmap
operator|.
name|height
argument_list|()
argument_list|)
decl_stmt|;
name|qreal
name|xform_offset_x
init|=
name|adapted
operator|.
name|dx
argument_list|()
decl_stmt|;
name|qreal
name|xform_offset_y
init|=
name|adapted
operator|.
name|dy
argument_list|()
decl_stmt|;
if|if
condition|(
name|d
operator|->
name|complex_xform
condition|)
block|{
name|pixmap
operator|=
name|pixmap
operator|.
name|transformed
argument_list|(
name|adapted
argument_list|)
expr_stmt|;
name|scaleX
operator|=
name|d
operator|->
name|stretch_x
expr_stmt|;
name|scaleY
operator|=
name|d
operator|->
name|stretch_y
expr_stmt|;
block|}
else|else
block|{
name|scaleX
operator|=
name|d
operator|->
name|stretch_x
operator|*
operator|(
name|r
operator|.
name|width
argument_list|()
operator|/
name|pixmap
operator|.
name|width
argument_list|()
operator|)
operator|*
name|d
operator|->
name|painterMatrix
operator|.
name|m11
argument_list|()
expr_stmt|;
name|scaleY
operator|=
name|d
operator|->
name|stretch_y
operator|*
operator|(
name|r
operator|.
name|height
argument_list|()
operator|/
name|pixmap
operator|.
name|height
argument_list|()
operator|)
operator|*
name|d
operator|->
name|painterMatrix
operator|.
name|m22
argument_list|()
expr_stmt|;
block|}
name|QPointF
name|topLeft
init|=
name|r
operator|.
name|topLeft
argument_list|()
operator|*
name|d
operator|->
name|painterMatrix
decl_stmt|;
name|int
name|tx
init|=
name|int
argument_list|(
name|topLeft
operator|.
name|x
argument_list|()
operator|*
name|d
operator|->
name|stretch_x
operator|+
name|d
operator|->
name|origin_x
argument_list|)
decl_stmt|;
name|int
name|ty
init|=
name|int
argument_list|(
name|topLeft
operator|.
name|y
argument_list|()
operator|*
name|d
operator|->
name|stretch_y
operator|+
name|d
operator|->
name|origin_y
argument_list|)
decl_stmt|;
name|int
name|tw
init|=
name|qAbs
argument_list|(
name|int
argument_list|(
name|pixmap
operator|.
name|width
argument_list|()
operator|*
name|scaleX
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|th
init|=
name|qAbs
argument_list|(
name|int
argument_list|(
name|pixmap
operator|.
name|height
argument_list|()
operator|*
name|scaleY
argument_list|)
argument_list|)
decl_stmt|;
name|xform_offset_x
operator|*=
name|d
operator|->
name|stretch_x
expr_stmt|;
name|xform_offset_y
operator|*=
name|d
operator|->
name|stretch_y
expr_stmt|;
name|int
name|dc_state
init|=
name|SaveDC
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
decl_stmt|;
name|int
name|tilesw
init|=
name|pixmap
operator|.
name|width
argument_list|()
operator|/
name|tileSize
decl_stmt|;
name|int
name|tilesh
init|=
name|pixmap
operator|.
name|height
argument_list|()
operator|/
name|tileSize
decl_stmt|;
operator|++
name|tilesw
expr_stmt|;
operator|++
name|tilesh
expr_stmt|;
name|int
name|txinc
init|=
name|tileSize
operator|*
name|scaleX
decl_stmt|;
name|int
name|tyinc
init|=
name|tileSize
operator|*
name|scaleY
decl_stmt|;
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|tilesh
condition|;
operator|++
name|y
control|)
block|{
name|int
name|tposy
init|=
name|ty
operator|+
operator|(
name|y
operator|*
name|tyinc
operator|)
decl_stmt|;
name|int
name|imgh
init|=
name|tileSize
decl_stmt|;
name|int
name|height
init|=
name|tyinc
decl_stmt|;
if|if
condition|(
name|y
operator|==
operator|(
name|tilesh
operator|-
literal|1
operator|)
condition|)
block|{
name|imgh
operator|=
name|pixmap
operator|.
name|height
argument_list|()
operator|-
operator|(
name|y
operator|*
name|tileSize
operator|)
expr_stmt|;
name|height
operator|=
operator|(
name|th
operator|-
operator|(
name|y
operator|*
name|tyinc
operator|)
operator|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|tilesw
condition|;
operator|++
name|x
control|)
block|{
name|int
name|tposx
init|=
name|tx
operator|+
operator|(
name|x
operator|*
name|txinc
operator|)
decl_stmt|;
name|int
name|imgw
init|=
name|tileSize
decl_stmt|;
name|int
name|width
init|=
name|txinc
decl_stmt|;
if|if
condition|(
name|x
operator|==
operator|(
name|tilesw
operator|-
literal|1
operator|)
condition|)
block|{
name|imgw
operator|=
name|pixmap
operator|.
name|width
argument_list|()
operator|-
operator|(
name|x
operator|*
name|tileSize
operator|)
expr_stmt|;
name|width
operator|=
operator|(
name|tw
operator|-
operator|(
name|x
operator|*
name|txinc
operator|)
operator|)
expr_stmt|;
block|}
name|QImage
name|img
argument_list|(
name|QSize
argument_list|(
name|imgw
argument_list|,
name|imgh
argument_list|)
argument_list|,
name|QImage
operator|::
name|Format_RGB32
argument_list|)
decl_stmt|;
name|img
operator|.
name|fill
argument_list|(
name|Qt
operator|::
name|white
argument_list|)
expr_stmt|;
name|QPainter
name|painter
argument_list|(
operator|&
name|img
argument_list|)
decl_stmt|;
name|painter
operator|.
name|drawPixmap
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|pixmap
argument_list|,
name|tileSize
operator|*
name|x
argument_list|,
name|tileSize
operator|*
name|y
argument_list|,
name|imgw
argument_list|,
name|imgh
argument_list|)
expr_stmt|;
name|QPixmap
name|p
init|=
name|QPixmap
operator|::
name|fromImage
argument_list|(
name|img
argument_list|)
decl_stmt|;
name|HBITMAP
name|hbitmap
init|=
name|qt_pixmapToWinHBITMAP
argument_list|(
name|p
argument_list|,
name|HBitmapNoAlpha
argument_list|)
decl_stmt|;
name|HDC
name|display_dc
init|=
name|GetDC
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|HDC
name|hbitmap_hdc
init|=
name|CreateCompatibleDC
argument_list|(
name|display_dc
argument_list|)
decl_stmt|;
name|HGDIOBJ
name|null_bitmap
init|=
name|SelectObject
argument_list|(
name|hbitmap_hdc
argument_list|,
name|hbitmap
argument_list|)
decl_stmt|;
name|ReleaseDC
argument_list|(
literal|0
argument_list|,
name|display_dc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|StretchBlt
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|qRound
argument_list|(
name|tposx
operator|-
name|xform_offset_x
argument_list|)
argument_list|,
name|qRound
argument_list|(
name|tposy
operator|-
name|xform_offset_y
argument_list|)
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|hbitmap_hdc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|p
operator|.
name|width
argument_list|()
argument_list|,
name|p
operator|.
name|height
argument_list|()
argument_list|,
name|SRCCOPY
argument_list|)
condition|)
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEngine::drawPixmap, StretchBlt failed"
argument_list|)
expr_stmt|;
name|SelectObject
argument_list|(
name|hbitmap_hdc
argument_list|,
name|null_bitmap
argument_list|)
expr_stmt|;
name|DeleteObject
argument_list|(
name|hbitmap
argument_list|)
expr_stmt|;
name|DeleteDC
argument_list|(
name|hbitmap_hdc
argument_list|)
expr_stmt|;
block|}
block|}
name|RestoreDC
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|dc_state
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawTiledPixmap
name|void
name|QWin32PrintEngine
operator|::
name|drawTiledPixmap
parameter_list|(
specifier|const
name|QRectF
modifier|&
name|r
parameter_list|,
specifier|const
name|QPixmap
modifier|&
name|pm
parameter_list|,
specifier|const
name|QPointF
modifier|&
name|pos
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|QAlphaPaintEngine
operator|::
name|drawTiledPixmap
argument_list|(
name|r
argument_list|,
name|pm
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|continueCall
argument_list|()
condition|)
return|return;
if|if
condition|(
name|d
operator|->
name|complex_xform
operator|||
operator|!
name|pos
operator|.
name|isNull
argument_list|()
condition|)
block|{
name|QPaintEngine
operator|::
name|drawTiledPixmap
argument_list|(
name|r
argument_list|,
name|pm
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|dc_state
init|=
name|SaveDC
argument_list|(
name|d
operator|->
name|hdc
argument_list|)
decl_stmt|;
name|HDC
name|display_dc
init|=
name|GetDC
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|HBITMAP
name|hbitmap
init|=
name|qt_pixmapToWinHBITMAP
argument_list|(
name|pm
argument_list|,
name|HBitmapNoAlpha
argument_list|)
decl_stmt|;
name|HDC
name|hbitmap_hdc
init|=
name|CreateCompatibleDC
argument_list|(
name|display_dc
argument_list|)
decl_stmt|;
name|HGDIOBJ
name|null_bitmap
init|=
name|SelectObject
argument_list|(
name|hbitmap_hdc
argument_list|,
name|hbitmap
argument_list|)
decl_stmt|;
name|ReleaseDC
argument_list|(
literal|0
argument_list|,
name|display_dc
argument_list|)
expr_stmt|;
name|QRectF
name|trect
init|=
name|d
operator|->
name|painterMatrix
operator|.
name|mapRect
argument_list|(
name|r
argument_list|)
decl_stmt|;
name|int
name|tx
init|=
name|int
argument_list|(
name|trect
operator|.
name|left
argument_list|()
operator|*
name|d
operator|->
name|stretch_x
operator|+
name|d
operator|->
name|origin_x
argument_list|)
decl_stmt|;
name|int
name|ty
init|=
name|int
argument_list|(
name|trect
operator|.
name|top
argument_list|()
operator|*
name|d
operator|->
name|stretch_y
operator|+
name|d
operator|->
name|origin_y
argument_list|)
decl_stmt|;
name|int
name|xtiles
init|=
name|int
argument_list|(
name|trect
operator|.
name|width
argument_list|()
operator|/
name|pm
operator|.
name|width
argument_list|()
argument_list|)
operator|+
literal|1
decl_stmt|;
name|int
name|ytiles
init|=
name|int
argument_list|(
name|trect
operator|.
name|height
argument_list|()
operator|/
name|pm
operator|.
name|height
argument_list|()
argument_list|)
operator|+
literal|1
decl_stmt|;
name|int
name|xinc
init|=
name|int
argument_list|(
name|pm
operator|.
name|width
argument_list|()
operator|*
name|d
operator|->
name|stretch_x
argument_list|)
decl_stmt|;
name|int
name|yinc
init|=
name|int
argument_list|(
name|pm
operator|.
name|height
argument_list|()
operator|*
name|d
operator|->
name|stretch_y
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|ytiles
condition|;
operator|++
name|y
control|)
block|{
name|int
name|ity
init|=
name|ty
operator|+
operator|(
name|yinc
operator|*
name|y
operator|)
decl_stmt|;
name|int
name|ith
init|=
name|pm
operator|.
name|height
argument_list|()
decl_stmt|;
if|if
condition|(
name|y
operator|==
operator|(
name|ytiles
operator|-
literal|1
operator|)
condition|)
block|{
name|ith
operator|=
name|int
argument_list|(
name|trect
operator|.
name|height
argument_list|()
operator|-
operator|(
name|pm
operator|.
name|height
argument_list|()
operator|*
name|y
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|xtiles
condition|;
operator|++
name|x
control|)
block|{
name|int
name|itx
init|=
name|tx
operator|+
operator|(
name|xinc
operator|*
name|x
operator|)
decl_stmt|;
name|int
name|itw
init|=
name|pm
operator|.
name|width
argument_list|()
decl_stmt|;
if|if
condition|(
name|x
operator|==
operator|(
name|xtiles
operator|-
literal|1
operator|)
condition|)
block|{
name|itw
operator|=
name|int
argument_list|(
name|trect
operator|.
name|width
argument_list|()
operator|-
operator|(
name|pm
operator|.
name|width
argument_list|()
operator|*
name|x
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|StretchBlt
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|itx
argument_list|,
name|ity
argument_list|,
name|int
argument_list|(
name|itw
operator|*
name|d
operator|->
name|stretch_x
argument_list|)
argument_list|,
name|int
argument_list|(
name|ith
operator|*
name|d
operator|->
name|stretch_y
argument_list|)
argument_list|,
name|hbitmap_hdc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|itw
argument_list|,
name|ith
argument_list|,
name|SRCCOPY
argument_list|)
condition|)
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEngine::drawPixmap, StretchBlt failed"
argument_list|)
expr_stmt|;
block|}
block|}
name|SelectObject
argument_list|(
name|hbitmap_hdc
argument_list|,
name|null_bitmap
argument_list|)
expr_stmt|;
name|DeleteObject
argument_list|(
name|hbitmap
argument_list|)
expr_stmt|;
name|DeleteDC
argument_list|(
name|hbitmap_hdc
argument_list|)
expr_stmt|;
name|RestoreDC
argument_list|(
name|d
operator|->
name|hdc
argument_list|,
name|dc_state
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|composeGdiPath
name|void
name|QWin32PrintEnginePrivate
operator|::
name|composeGdiPath
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|path
parameter_list|)
block|{
if|if
condition|(
operator|!
name|BeginPath
argument_list|(
name|hdc
argument_list|)
condition|)
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEnginePrivate::drawPath: BeginPath failed"
argument_list|)
expr_stmt|;
comment|// Drawing the subpaths
name|int
name|start
init|=
operator|-
literal|1
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|path
operator|.
name|elementCount
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|QPainterPath
operator|::
name|Element
modifier|&
name|elm
init|=
name|path
operator|.
name|elementAt
argument_list|(
name|i
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|elm
operator|.
name|type
condition|)
block|{
case|case
name|QPainterPath
operator|::
name|MoveToElement
case|:
if|if
condition|(
name|start
operator|>=
literal|0
operator|&&
name|path
operator|.
name|elementAt
argument_list|(
name|start
argument_list|)
operator|.
name|x
operator|==
name|path
operator|.
name|elementAt
argument_list|(
name|i
operator|-
literal|1
argument_list|)
operator|.
name|x
operator|&&
name|path
operator|.
name|elementAt
argument_list|(
name|start
argument_list|)
operator|.
name|y
operator|==
name|path
operator|.
name|elementAt
argument_list|(
name|i
operator|-
literal|1
argument_list|)
operator|.
name|y
condition|)
name|CloseFigure
argument_list|(
name|hdc
argument_list|)
expr_stmt|;
name|start
operator|=
name|i
expr_stmt|;
name|MoveToEx
argument_list|(
name|hdc
argument_list|,
name|qRound
argument_list|(
name|elm
operator|.
name|x
argument_list|)
argument_list|,
name|qRound
argument_list|(
name|elm
operator|.
name|y
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|QPainterPath
operator|::
name|LineToElement
case|:
name|LineTo
argument_list|(
name|hdc
argument_list|,
name|qRound
argument_list|(
name|elm
operator|.
name|x
argument_list|)
argument_list|,
name|qRound
argument_list|(
name|elm
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|QPainterPath
operator|::
name|CurveToElement
case|:
block|{
name|POINT
name|pts
index|[
literal|3
index|]
init|=
block|{
block|{
name|qRound
argument_list|(
name|elm
operator|.
name|x
argument_list|)
block|,
name|qRound
argument_list|(
argument|elm.y
argument_list|)
block|}
block|,
block|{
name|qRound
argument_list|(
name|path
operator|.
name|elementAt
argument_list|(
name|i
operator|+
literal|1
argument_list|)
operator|.
name|x
argument_list|)
block|,
name|qRound
argument_list|(
argument|path.elementAt(i+
literal|1
argument|).y
argument_list|)
block|}
block|,
block|{
name|qRound
argument_list|(
name|path
operator|.
name|elementAt
argument_list|(
name|i
operator|+
literal|2
argument_list|)
operator|.
name|x
argument_list|)
block|,
name|qRound
argument_list|(
argument|path.elementAt(i+
literal|2
argument|).y
argument_list|)
block|}
block|}
decl_stmt|;
name|i
operator|+=
literal|2
expr_stmt|;
name|PolyBezierTo
argument_list|(
name|hdc
argument_list|,
name|pts
argument_list|,
literal|3
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|qFatal
argument_list|(
literal|"QWin32PaintEngine::drawPath: Unhandled type: %d"
argument_list|,
name|elm
operator|.
name|type
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|start
operator|>=
literal|0
operator|&&
name|path
operator|.
name|elementAt
argument_list|(
name|start
argument_list|)
operator|.
name|x
operator|==
name|path
operator|.
name|elementAt
argument_list|(
name|path
operator|.
name|elementCount
argument_list|()
operator|-
literal|1
argument_list|)
operator|.
name|x
operator|&&
name|path
operator|.
name|elementAt
argument_list|(
name|start
argument_list|)
operator|.
name|y
operator|==
name|path
operator|.
name|elementAt
argument_list|(
name|path
operator|.
name|elementCount
argument_list|()
operator|-
literal|1
argument_list|)
operator|.
name|y
condition|)
name|CloseFigure
argument_list|(
name|hdc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EndPath
argument_list|(
name|hdc
argument_list|)
condition|)
name|qErrnoWarning
argument_list|(
literal|"QWin32PaintEngine::drawPath: EndPath failed"
argument_list|)
expr_stmt|;
name|SetPolyFillMode
argument_list|(
name|hdc
argument_list|,
name|path
operator|.
name|fillRule
argument_list|()
operator|==
name|Qt
operator|::
name|WindingFill
condition|?
name|WINDING
else|:
name|ALTERNATE
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|fillPath_dev
name|void
name|QWin32PrintEnginePrivate
operator|::
name|fillPath_dev
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|path
parameter_list|,
specifier|const
name|QColor
modifier|&
name|color
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|QT_DEBUG_DRAW
name|qDebug
argument_list|()
operator|<<
literal|" --- QWin32PrintEnginePrivate::fillPath() bound:"
operator|<<
name|path
operator|.
name|boundingRect
argument_list|()
operator|<<
name|color
expr_stmt|;
endif|#
directive|endif
name|composeGdiPath
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|HBRUSH
name|brush
init|=
name|CreateSolidBrush
argument_list|(
name|RGB
argument_list|(
name|color
operator|.
name|red
argument_list|()
argument_list|,
name|color
operator|.
name|green
argument_list|()
argument_list|,
name|color
operator|.
name|blue
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|HGDIOBJ
name|old_brush
init|=
name|SelectObject
argument_list|(
name|hdc
argument_list|,
name|brush
argument_list|)
decl_stmt|;
name|FillPath
argument_list|(
name|hdc
argument_list|)
expr_stmt|;
name|DeleteObject
argument_list|(
name|SelectObject
argument_list|(
name|hdc
argument_list|,
name|old_brush
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|strokePath_dev
name|void
name|QWin32PrintEnginePrivate
operator|::
name|strokePath_dev
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|path
parameter_list|,
specifier|const
name|QColor
modifier|&
name|color
parameter_list|,
name|qreal
name|penWidth
parameter_list|)
block|{
name|Q_Q
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|composeGdiPath
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|LOGBRUSH
name|brush
decl_stmt|;
name|brush
operator|.
name|lbStyle
operator|=
name|BS_SOLID
expr_stmt|;
name|brush
operator|.
name|lbColor
operator|=
name|RGB
argument_list|(
name|color
operator|.
name|red
argument_list|()
argument_list|,
name|color
operator|.
name|green
argument_list|()
argument_list|,
name|color
operator|.
name|blue
argument_list|()
argument_list|)
expr_stmt|;
name|DWORD
name|capStyle
init|=
name|PS_ENDCAP_SQUARE
decl_stmt|;
name|DWORD
name|joinStyle
init|=
name|PS_JOIN_BEVEL
decl_stmt|;
if|if
condition|(
name|pen
operator|.
name|capStyle
argument_list|()
operator|==
name|Qt
operator|::
name|FlatCap
condition|)
name|capStyle
operator|=
name|PS_ENDCAP_FLAT
expr_stmt|;
elseif|else
if|if
condition|(
name|pen
operator|.
name|capStyle
argument_list|()
operator|==
name|Qt
operator|::
name|RoundCap
condition|)
name|capStyle
operator|=
name|PS_ENDCAP_ROUND
expr_stmt|;
if|if
condition|(
name|pen
operator|.
name|joinStyle
argument_list|()
operator|==
name|Qt
operator|::
name|MiterJoin
condition|)
name|joinStyle
operator|=
name|PS_JOIN_MITER
expr_stmt|;
elseif|else
if|if
condition|(
name|pen
operator|.
name|joinStyle
argument_list|()
operator|==
name|Qt
operator|::
name|RoundJoin
condition|)
name|joinStyle
operator|=
name|PS_JOIN_ROUND
expr_stmt|;
name|bool
name|cosmetic
init|=
name|qt_pen_is_cosmetic
argument_list|(
name|pen
argument_list|,
name|q
operator|->
name|state
operator|->
name|renderHints
argument_list|()
argument_list|)
decl_stmt|;
name|HPEN
name|pen
init|=
name|ExtCreatePen
argument_list|(
operator|(
name|cosmetic
condition|?
name|PS_COSMETIC
else|:
name|PS_GEOMETRIC
operator|)
operator||
name|PS_SOLID
operator||
name|capStyle
operator||
name|joinStyle
argument_list|,
operator|(
name|penWidth
operator|==
literal|0
operator|)
condition|?
literal|1
else|:
name|penWidth
argument_list|,
operator|&
name|brush
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|HGDIOBJ
name|old_pen
init|=
name|SelectObject
argument_list|(
name|hdc
argument_list|,
name|pen
argument_list|)
decl_stmt|;
name|StrokePath
argument_list|(
name|hdc
argument_list|)
expr_stmt|;
name|DeleteObject
argument_list|(
name|SelectObject
argument_list|(
name|hdc
argument_list|,
name|old_pen
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|fillPath
name|void
name|QWin32PrintEnginePrivate
operator|::
name|fillPath
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|path
parameter_list|,
specifier|const
name|QColor
modifier|&
name|color
parameter_list|)
block|{
name|fillPath_dev
argument_list|(
name|path
operator|*
name|matrix
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|strokePath
name|void
name|QWin32PrintEnginePrivate
operator|::
name|strokePath
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|path
parameter_list|,
specifier|const
name|QColor
modifier|&
name|color
parameter_list|)
block|{
name|Q_Q
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|QPainterPathStroker
name|stroker
decl_stmt|;
if|if
condition|(
name|pen
operator|.
name|style
argument_list|()
operator|==
name|Qt
operator|::
name|CustomDashLine
condition|)
block|{
name|stroker
operator|.
name|setDashPattern
argument_list|(
name|pen
operator|.
name|dashPattern
argument_list|()
argument_list|)
expr_stmt|;
name|stroker
operator|.
name|setDashOffset
argument_list|(
name|pen
operator|.
name|dashOffset
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stroker
operator|.
name|setDashPattern
argument_list|(
name|pen
operator|.
name|style
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|stroker
operator|.
name|setCapStyle
argument_list|(
name|pen
operator|.
name|capStyle
argument_list|()
argument_list|)
expr_stmt|;
name|stroker
operator|.
name|setJoinStyle
argument_list|(
name|pen
operator|.
name|joinStyle
argument_list|()
argument_list|)
expr_stmt|;
name|stroker
operator|.
name|setMiterLimit
argument_list|(
name|pen
operator|.
name|miterLimit
argument_list|()
argument_list|)
expr_stmt|;
name|QPainterPath
name|stroke
decl_stmt|;
name|qreal
name|width
init|=
name|pen
operator|.
name|widthF
argument_list|()
decl_stmt|;
name|bool
name|cosmetic
init|=
name|qt_pen_is_cosmetic
argument_list|(
name|pen
argument_list|,
name|q
operator|->
name|state
operator|->
name|renderHints
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|pen
operator|.
name|style
argument_list|()
operator|==
name|Qt
operator|::
name|SolidLine
operator|&&
operator|(
name|cosmetic
operator|||
name|matrix
operator|.
name|type
argument_list|()
operator|<
name|QTransform
operator|::
name|TxScale
operator|)
condition|)
block|{
name|strokePath_dev
argument_list|(
name|path
operator|*
name|matrix
argument_list|,
name|color
argument_list|,
name|width
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stroker
operator|.
name|setWidth
argument_list|(
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
name|cosmetic
condition|)
block|{
name|stroke
operator|=
name|stroker
operator|.
name|createStroke
argument_list|(
name|path
operator|*
name|matrix
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stroke
operator|=
name|stroker
operator|.
name|createStroke
argument_list|(
name|path
argument_list|)
operator|*
name|painterMatrix
expr_stmt|;
name|QTransform
name|stretch
argument_list|(
name|stretch_x
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|stretch_y
argument_list|,
name|origin_x
argument_list|,
name|origin_y
argument_list|)
decl_stmt|;
name|stroke
operator|=
name|stroke
operator|*
name|stretch
expr_stmt|;
block|}
if|if
condition|(
name|stroke
operator|.
name|isEmpty
argument_list|()
condition|)
return|return;
name|fillPath_dev
argument_list|(
name|stroke
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|drawPath
name|void
name|QWin32PrintEngine
operator|::
name|drawPath
parameter_list|(
specifier|const
name|QPainterPath
modifier|&
name|path
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|QT_DEBUG_DRAW
name|qDebug
argument_list|()
operator|<<
literal|" - QWin32PrintEngine::drawPath(), bounds: "
operator|<<
name|path
operator|.
name|boundingRect
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|QAlphaPaintEngine
operator|::
name|drawPath
argument_list|(
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|continueCall
argument_list|()
condition|)
return|return;
if|if
condition|(
name|d
operator|->
name|has_brush
condition|)
name|d
operator|->
name|fillPath
argument_list|(
name|path
argument_list|,
name|d
operator|->
name|brush_color
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|has_pen
condition|)
name|d
operator|->
name|strokePath
argument_list|(
name|path
argument_list|,
name|d
operator|->
name|pen
operator|.
name|color
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|drawPolygon
name|void
name|QWin32PrintEngine
operator|::
name|drawPolygon
parameter_list|(
specifier|const
name|QPointF
modifier|*
name|points
parameter_list|,
name|int
name|pointCount
parameter_list|,
name|PolygonDrawMode
name|mode
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|QT_DEBUG_DRAW
name|qDebug
argument_list|()
operator|<<
literal|" - QWin32PrintEngine::drawPolygon(), pointCount: "
operator|<<
name|pointCount
expr_stmt|;
endif|#
directive|endif
name|QAlphaPaintEngine
operator|::
name|drawPolygon
argument_list|(
name|points
argument_list|,
name|pointCount
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|continueCall
argument_list|()
condition|)
return|return;
name|Q_ASSERT
argument_list|(
name|pointCount
operator|>
literal|1
argument_list|)
expr_stmt|;
name|QPainterPath
name|path
argument_list|(
name|points
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|pointCount
condition|;
operator|++
name|i
control|)
block|{
name|path
operator|.
name|lineTo
argument_list|(
name|points
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|bool
name|has_brush
init|=
name|d
operator|->
name|has_brush
decl_stmt|;
if|if
condition|(
name|mode
operator|==
name|PolylineMode
condition|)
name|d
operator|->
name|has_brush
operator|=
literal|false
expr_stmt|;
comment|// No brush for polylines
else|else
name|path
operator|.
name|closeSubpath
argument_list|()
expr_stmt|;
comment|// polygons are should always be closed.
name|drawPath
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|d
operator|->
name|has_brush
operator|=
name|has_brush
expr_stmt|;
block|}
end_function
begin_destructor
DECL|function|~QWin32PrintEnginePrivate
name|QWin32PrintEnginePrivate
operator|::
name|~
name|QWin32PrintEnginePrivate
parameter_list|()
block|{
if|if
condition|(
name|hdc
condition|)
name|release
argument_list|()
expr_stmt|;
block|}
end_destructor
begin_function
DECL|function|initialize
name|void
name|QWin32PrintEnginePrivate
operator|::
name|initialize
parameter_list|()
block|{
if|if
condition|(
name|hdc
condition|)
name|release
argument_list|()
expr_stmt|;
name|Q_ASSERT
argument_list|(
operator|!
name|hPrinter
argument_list|)
expr_stmt|;
name|Q_ASSERT
argument_list|(
operator|!
name|hdc
argument_list|)
expr_stmt|;
name|Q_ASSERT
argument_list|(
operator|!
name|devMode
argument_list|)
expr_stmt|;
name|Q_ASSERT
argument_list|(
operator|!
name|pInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m_printDevice
operator|.
name|isValid
argument_list|()
condition|)
return|return;
name|txop
operator|=
name|QTransform
operator|::
name|TxNone
expr_stmt|;
name|bool
name|ok
init|=
name|OpenPrinter
argument_list|(
operator|(
name|LPWSTR
operator|)
name|m_printDevice
operator|.
name|id
argument_list|()
operator|.
name|utf16
argument_list|()
argument_list|,
operator|(
name|LPHANDLE
operator|)
operator|&
name|hPrinter
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEngine::initialize: OpenPrinter failed"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// Fetch the PRINTER_INFO_2 with DEVMODE data containing the
comment|// printer settings.
name|DWORD
name|infoSize
decl_stmt|,
name|numBytes
decl_stmt|;
name|GetPrinter
argument_list|(
name|hPrinter
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|infoSize
argument_list|)
expr_stmt|;
name|hMem
operator|=
name|GlobalAlloc
argument_list|(
name|GHND
argument_list|,
name|infoSize
argument_list|)
expr_stmt|;
name|pInfo
operator|=
operator|(
name|PRINTER_INFO_2
operator|*
operator|)
name|GlobalLock
argument_list|(
name|hMem
argument_list|)
expr_stmt|;
name|ok
operator|=
name|GetPrinter
argument_list|(
name|hPrinter
argument_list|,
literal|2
argument_list|,
operator|(
name|LPBYTE
operator|)
name|pInfo
argument_list|,
name|infoSize
argument_list|,
operator|&
name|numBytes
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|qErrnoWarning
argument_list|(
literal|"QWin32PrintEngine::initialize: GetPrinter failed"
argument_list|)
expr_stmt|;
name|GlobalUnlock
argument_list|(
name|pInfo
argument_list|)
expr_stmt|;
name|GlobalFree
argument_list|(
name|hMem
argument_list|)
expr_stmt|;
name|ClosePrinter
argument_list|(
name|hPrinter
argument_list|)
expr_stmt|;
name|pInfo
operator|=
literal|0
expr_stmt|;
name|hMem
operator|=
literal|0
expr_stmt|;
name|hPrinter
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|devMode
operator|=
name|pInfo
operator|->
name|pDevMode
expr_stmt|;
name|hdc
operator|=
name|CreateDC
argument_list|(
name|NULL
argument_list|,
cast|reinterpret_cast
argument_list|<
specifier|const
name|wchar_t
operator|*
argument_list|>
argument_list|(
name|m_printDevice
operator|.
name|id
argument_list|()
operator|.
name|utf16
argument_list|()
argument_list|)
argument_list|,
literal|0
argument_list|,
name|devMode
argument_list|)
expr_stmt|;
name|Q_ASSERT
argument_list|(
name|hPrinter
argument_list|)
expr_stmt|;
name|Q_ASSERT
argument_list|(
name|pInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|devMode
condition|)
block|{
name|num_copies
operator|=
name|devMode
operator|->
name|dmCopies
expr_stmt|;
name|devMode
operator|->
name|dmCollate
operator|=
name|DMCOLLATE_TRUE
expr_stmt|;
name|updatePageLayout
argument_list|()
expr_stmt|;
block|}
name|initHDC
argument_list|()
expr_stmt|;
if|#
directive|if
name|defined
name|QT_DEBUG_DRAW
operator|||
name|defined
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::initialize()"
expr_stmt|;
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_DRAW || QT_DEBUG_METRICS
block|}
end_function
begin_function
DECL|function|initHDC
name|void
name|QWin32PrintEnginePrivate
operator|::
name|initHDC
parameter_list|()
block|{
name|Q_ASSERT
argument_list|(
name|hdc
argument_list|)
expr_stmt|;
name|HDC
name|display_dc
init|=
name|GetDC
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|dpi_x
operator|=
name|GetDeviceCaps
argument_list|(
name|hdc
argument_list|,
name|LOGPIXELSX
argument_list|)
expr_stmt|;
name|dpi_y
operator|=
name|GetDeviceCaps
argument_list|(
name|hdc
argument_list|,
name|LOGPIXELSY
argument_list|)
expr_stmt|;
name|dpi_display
operator|=
name|GetDeviceCaps
argument_list|(
name|display_dc
argument_list|,
name|LOGPIXELSY
argument_list|)
expr_stmt|;
name|ReleaseDC
argument_list|(
literal|0
argument_list|,
name|display_dc
argument_list|)
expr_stmt|;
if|if
condition|(
name|dpi_display
operator|==
literal|0
condition|)
block|{
name|qWarning
argument_list|(
literal|"QWin32PrintEngine::metric: GetDeviceCaps() failed, "
literal|"might be a driver problem"
argument_list|)
expr_stmt|;
name|dpi_display
operator|=
literal|96
expr_stmt|;
comment|// Reasonable default
block|}
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|QPrinter
operator|::
name|ScreenResolution
case|:
name|resolution
operator|=
name|dpi_display
expr_stmt|;
name|stretch_x
operator|=
name|dpi_x
operator|/
name|double
argument_list|(
name|dpi_display
argument_list|)
expr_stmt|;
name|stretch_y
operator|=
name|dpi_y
operator|/
name|double
argument_list|(
name|dpi_display
argument_list|)
expr_stmt|;
break|break;
case|case
name|QPrinter
operator|::
name|PrinterResolution
case|:
case|case
name|QPrinter
operator|::
name|HighResolution
case|:
name|resolution
operator|=
name|dpi_y
expr_stmt|;
name|stretch_x
operator|=
literal|1
expr_stmt|;
name|stretch_y
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function
begin_function
DECL|function|release
name|void
name|QWin32PrintEnginePrivate
operator|::
name|release
parameter_list|()
block|{
if|if
condition|(
name|hdc
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|globalDevMode
condition|)
block|{
comment|// Devmode comes from print dialog
name|GlobalUnlock
argument_list|(
name|globalDevMode
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Devmode comes from initialize...
comment|// devMode is a part of the same memory block as pInfo so one free is enough...
name|GlobalUnlock
argument_list|(
name|hMem
argument_list|)
expr_stmt|;
name|GlobalFree
argument_list|(
name|hMem
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hPrinter
condition|)
name|ClosePrinter
argument_list|(
name|hPrinter
argument_list|)
expr_stmt|;
name|DeleteDC
argument_list|(
name|hdc
argument_list|)
expr_stmt|;
name|hdc
operator|=
literal|0
expr_stmt|;
name|hPrinter
operator|=
literal|0
expr_stmt|;
name|pInfo
operator|=
literal|0
expr_stmt|;
name|hMem
operator|=
literal|0
expr_stmt|;
name|devMode
operator|=
literal|0
expr_stmt|;
block|}
end_function
begin_function
DECL|function|doReinit
name|void
name|QWin32PrintEnginePrivate
operator|::
name|doReinit
parameter_list|()
block|{
if|if
condition|(
name|state
operator|==
name|QPrinter
operator|::
name|Active
condition|)
block|{
name|reinit
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|resetDC
argument_list|()
expr_stmt|;
name|reinit
operator|=
literal|false
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|setProperty
name|void
name|QWin32PrintEngine
operator|::
name|setProperty
parameter_list|(
name|PrintEnginePropertyKey
name|key
parameter_list|,
specifier|const
name|QVariant
modifier|&
name|value
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|key
condition|)
block|{
comment|// The following keys are properties or derived values and so cannot be set
case|case
name|PPK_PageRect
case|:
break|break;
case|case
name|PPK_PaperRect
case|:
break|break;
case|case
name|PPK_PaperSources
case|:
break|break;
case|case
name|PPK_SupportsMultipleCopies
case|:
break|break;
case|case
name|PPK_SupportedResolutions
case|:
break|break;
comment|// The following keys are settings that are unsupported by the Windows PrintEngine
case|case
name|PPK_CustomBase
case|:
break|break;
case|case
name|PPK_Duplex
case|:
comment|// TODO Add support using DEVMODE.dmDuplex
break|break;
case|case
name|PPK_FontEmbedding
case|:
break|break;
case|case
name|PPK_PageOrder
case|:
break|break;
case|case
name|PPK_PrinterProgram
case|:
break|break;
case|case
name|PPK_SelectionOption
case|:
break|break;
comment|// The following keys are properties and settings that are supported by the Windows PrintEngine
case|case
name|PPK_CollateCopies
case|:
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
break|break;
name|d
operator|->
name|devMode
operator|->
name|dmCollate
operator|=
name|value
operator|.
name|toBool
argument_list|()
condition|?
name|DMCOLLATE_TRUE
else|:
name|DMCOLLATE_FALSE
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|PPK_ColorMode
case|:
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
break|break;
name|d
operator|->
name|devMode
operator|->
name|dmColor
operator|=
operator|(
name|value
operator|.
name|toInt
argument_list|()
operator|==
name|QPrinter
operator|::
name|Color
operator|)
condition|?
name|DMCOLOR_COLOR
else|:
name|DMCOLOR_MONOCHROME
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|PPK_Creator
case|:
name|d
operator|->
name|m_creator
operator|=
name|value
operator|.
name|toString
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_DocumentName
case|:
if|if
condition|(
name|isActive
argument_list|()
condition|)
block|{
name|qWarning
argument_list|(
literal|"QWin32PrintEngine: Cannot change document name while printing is active"
argument_list|)
expr_stmt|;
return|return;
block|}
name|d
operator|->
name|docName
operator|=
name|value
operator|.
name|toString
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_FullPage
case|:
if|if
condition|(
name|value
operator|.
name|toBool
argument_list|()
condition|)
name|d
operator|->
name|m_pageLayout
operator|.
name|setMode
argument_list|(
name|QPageLayout
operator|::
name|FullPageMode
argument_list|)
expr_stmt|;
else|else
name|d
operator|->
name|m_pageLayout
operator|.
name|setMode
argument_list|(
name|QPageLayout
operator|::
name|StandardMode
argument_list|)
expr_stmt|;
name|d
operator|->
name|updateMetrics
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_FullPage,"
operator|<<
name|value
operator|.
name|toBool
argument_list|()
operator|<<
operator|+
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
case|case
name|PPK_CopyCount
case|:
comment|// fallthrough
case|case
name|PPK_NumberOfCopies
case|:
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
break|break;
name|d
operator|->
name|num_copies
operator|=
name|value
operator|.
name|toInt
argument_list|()
expr_stmt|;
name|d
operator|->
name|devMode
operator|->
name|dmCopies
operator|=
name|d
operator|->
name|num_copies
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_Orientation
case|:
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
break|break;
name|QPageLayout
operator|::
name|Orientation
name|orientation
init|=
name|QPageLayout
operator|::
name|Orientation
argument_list|(
name|value
operator|.
name|toInt
argument_list|()
argument_list|)
decl_stmt|;
name|d
operator|->
name|devMode
operator|->
name|dmOrientation
operator|=
name|orientation
operator|==
name|QPageLayout
operator|::
name|Landscape
condition|?
name|DMORIENT_LANDSCAPE
else|:
name|DMORIENT_PORTRAIT
expr_stmt|;
name|d
operator|->
name|m_pageLayout
operator|.
name|setOrientation
argument_list|(
name|orientation
argument_list|)
expr_stmt|;
name|d
operator|->
name|updateMetrics
argument_list|()
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_Orientation,"
operator|<<
name|orientation
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
block|}
case|case
name|PPK_OutputFileName
case|:
if|if
condition|(
name|isActive
argument_list|()
condition|)
block|{
name|qWarning
argument_list|(
literal|"QWin32PrintEngine: Cannot change filename while printing"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|d
operator|->
name|fileName
operator|=
name|value
operator|.
name|toString
argument_list|()
expr_stmt|;
name|d
operator|->
name|printToFile
operator|=
operator|!
name|value
operator|.
name|toString
argument_list|()
operator|.
name|isEmpty
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|PPK_PageSize
case|:
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
break|break;
specifier|const
name|QPageSize
name|pageSize
init|=
name|QPageSize
argument_list|(
name|QPageSize
operator|::
name|PageSizeId
argument_list|(
name|value
operator|.
name|toInt
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|pageSize
operator|.
name|isValid
argument_list|()
condition|)
block|{
name|d
operator|->
name|setPageSize
argument_list|(
name|pageSize
argument_list|)
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_PageSize,"
operator|<<
name|value
operator|.
name|toInt
argument_list|()
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
block|}
break|break;
block|}
case|case
name|PPK_PaperName
case|:
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
break|break;
comment|// Get the named page size from the printer if supported
specifier|const
name|QPageSize
name|pageSize
init|=
name|d
operator|->
name|m_printDevice
operator|.
name|supportedPageSize
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|pageSize
operator|.
name|isValid
argument_list|()
condition|)
block|{
name|d
operator|->
name|setPageSize
argument_list|(
name|pageSize
argument_list|)
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_PaperName,"
operator|<<
name|value
operator|.
name|toString
argument_list|()
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
block|}
break|break;
block|}
case|case
name|PPK_PaperSource
case|:
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
break|break;
name|QPrint
operator|::
name|InputSlotId
name|inputSlotId
init|=
name|QPrint
operator|::
name|InputSlotId
argument_list|(
name|value
operator|.
name|toInt
argument_list|()
argument_list|)
decl_stmt|;
foreach|foreach
control|(
specifier|const
name|QPrint
operator|::
name|InputSlot
modifier|&
name|inputSlot
decl|,
name|d
operator|->
name|m_printDevice
operator|.
name|supportedInputSlots
argument_list|()
control|)
block|{
if|if
condition|(
name|inputSlot
operator|.
name|id
operator|==
name|inputSlotId
condition|)
block|{
name|d
operator|->
name|devMode
operator|->
name|dmDefaultSource
operator|=
name|inputSlot
operator|.
name|windowsId
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
case|case
name|PPK_PrinterName
case|:
block|{
name|QString
name|id
init|=
name|value
operator|.
name|toString
argument_list|()
decl_stmt|;
name|QPlatformPrinterSupport
modifier|*
name|ps
init|=
name|QPlatformPrinterSupportPlugin
operator|::
name|get
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|ps
condition|)
return|return;
name|QPrintDevice
name|printDevice
init|=
name|ps
operator|->
name|createPrintDevice
argument_list|(
name|id
operator|.
name|isEmpty
argument_list|()
condition|?
name|ps
operator|->
name|defaultPrintDeviceId
argument_list|()
else|:
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|printDevice
operator|.
name|isValid
argument_list|()
condition|)
block|{
name|d
operator|->
name|m_printDevice
operator|=
name|printDevice
expr_stmt|;
comment|// TODO Do we need to check if the page size is valid on new printer?
name|d
operator|->
name|initialize
argument_list|()
expr_stmt|;
block|}
break|break;
block|}
case|case
name|PPK_Resolution
case|:
block|{
name|d
operator|->
name|resolution
operator|=
name|value
operator|.
name|toInt
argument_list|()
expr_stmt|;
name|d
operator|->
name|stretch_x
operator|=
name|d
operator|->
name|dpi_x
operator|/
name|double
argument_list|(
name|d
operator|->
name|resolution
argument_list|)
expr_stmt|;
name|d
operator|->
name|stretch_y
operator|=
name|d
operator|->
name|dpi_y
operator|/
name|double
argument_list|(
name|d
operator|->
name|resolution
argument_list|)
expr_stmt|;
name|d
operator|->
name|updateMetrics
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_Resolution,"
operator|<<
name|value
operator|.
name|toInt
argument_list|()
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
block|}
case|case
name|PPK_WindowsPageSize
case|:
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
break|break;
specifier|const
name|QPageSize
name|pageSize
init|=
name|QPageSize
argument_list|(
name|QPageSize
operator|::
name|id
argument_list|(
name|value
operator|.
name|toInt
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|pageSize
operator|.
name|isValid
argument_list|()
condition|)
block|{
name|d
operator|->
name|setPageSize
argument_list|(
name|pageSize
argument_list|)
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_WindowsPageSize,"
operator|<<
name|value
operator|.
name|toInt
argument_list|()
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
block|}
break|break;
block|}
case|case
name|PPK_CustomPaperSize
case|:
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
break|break;
specifier|const
name|QPageSize
name|pageSize
init|=
name|QPageSize
argument_list|(
name|value
operator|.
name|toSizeF
argument_list|()
argument_list|,
name|QPageSize
operator|::
name|Point
argument_list|)
decl_stmt|;
if|if
condition|(
name|pageSize
operator|.
name|isValid
argument_list|()
condition|)
block|{
name|d
operator|->
name|setPageSize
argument_list|(
name|pageSize
argument_list|)
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_CustomPaperSize,"
operator|<<
name|value
operator|.
name|toSizeF
argument_list|()
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
block|}
break|break;
block|}
case|case
name|PPK_PageMargins
case|:
block|{
name|QList
argument_list|<
name|QVariant
argument_list|>
name|margins
argument_list|(
name|value
operator|.
name|toList
argument_list|()
argument_list|)
decl_stmt|;
name|Q_ASSERT
argument_list|(
name|margins
operator|.
name|size
argument_list|()
operator|==
literal|4
argument_list|)
expr_stmt|;
name|d
operator|->
name|m_pageLayout
operator|.
name|setUnits
argument_list|(
name|QPageLayout
operator|::
name|Point
argument_list|)
expr_stmt|;
name|d
operator|->
name|m_pageLayout
operator|.
name|setMargins
argument_list|(
name|QMarginsF
argument_list|(
name|margins
operator|.
name|at
argument_list|(
literal|0
argument_list|)
operator|.
name|toReal
argument_list|()
argument_list|,
name|margins
operator|.
name|at
argument_list|(
literal|1
argument_list|)
operator|.
name|toReal
argument_list|()
argument_list|,
name|margins
operator|.
name|at
argument_list|(
literal|2
argument_list|)
operator|.
name|toReal
argument_list|()
argument_list|,
name|margins
operator|.
name|at
argument_list|(
literal|3
argument_list|)
operator|.
name|toReal
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|updateMetrics
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_PageMargins,"
operator|<<
name|margins
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
block|}
case|case
name|PPK_QPageSize
case|:
block|{
comment|// Get the page size from the printer if supported
specifier|const
name|QPageSize
name|pageSize
init|=
name|value
operator|.
name|value
argument_list|<
name|QPageSize
argument_list|>
argument_list|()
decl_stmt|;
if|if
condition|(
name|pageSize
operator|.
name|isValid
argument_list|()
condition|)
block|{
name|d
operator|->
name|setPageSize
argument_list|(
name|pageSize
argument_list|)
expr_stmt|;
name|d
operator|->
name|doReinit
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_QPageSize,"
operator|<<
name|pageSize
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
block|}
break|break;
block|}
case|case
name|PPK_QPageMargins
case|:
block|{
name|QPair
argument_list|<
name|QMarginsF
argument_list|,
name|QPageLayout
operator|::
name|Unit
argument_list|>
name|pair
init|=
name|value
operator|.
name|value
argument_list|<
name|QPair
argument_list|<
name|QMarginsF
argument_list|,
name|QPageLayout
operator|::
name|Unit
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
name|d
operator|->
name|m_pageLayout
operator|.
name|setUnits
argument_list|(
name|pair
operator|.
name|second
argument_list|)
expr_stmt|;
name|d
operator|->
name|m_pageLayout
operator|.
name|setMargins
argument_list|(
name|pair
operator|.
name|first
argument_list|)
expr_stmt|;
name|d
operator|->
name|updateMetrics
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_QPageMargins,"
operator|<<
name|pair
operator|.
name|first
operator|<<
name|pair
operator|.
name|second
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
break|break;
block|}
case|case
name|PPK_QPageLayout
case|:
block|{
name|QPageLayout
name|pageLayout
init|=
name|value
operator|.
name|value
argument_list|<
name|QPageLayout
argument_list|>
argument_list|()
decl_stmt|;
if|if
condition|(
name|pageLayout
operator|.
name|isValid
argument_list|()
operator|&&
name|d
operator|->
name|m_printDevice
operator|.
name|isValidPageLayout
argument_list|(
name|pageLayout
argument_list|,
name|d
operator|->
name|resolution
argument_list|)
condition|)
block|{
name|setProperty
argument_list|(
name|PPK_QPageSize
argument_list|,
name|QVariant
operator|::
name|fromValue
argument_list|(
name|pageLayout
operator|.
name|pageSize
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|setProperty
argument_list|(
name|PPK_FullPage
argument_list|,
name|pageLayout
operator|.
name|mode
argument_list|()
operator|==
name|QPageLayout
operator|::
name|FullPageMode
argument_list|)
expr_stmt|;
name|setProperty
argument_list|(
name|PPK_Orientation
argument_list|,
name|QVariant
operator|::
name|fromValue
argument_list|(
name|pageLayout
operator|.
name|orientation
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|m_pageLayout
operator|.
name|setUnits
argument_list|(
name|pageLayout
operator|.
name|units
argument_list|()
argument_list|)
expr_stmt|;
name|d
operator|->
name|m_pageLayout
operator|.
name|setMargins
argument_list|(
name|pageLayout
operator|.
name|margins
argument_list|()
argument_list|)
expr_stmt|;
name|d
operator|->
name|updateMetrics
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setProperty(PPK_QPageLayout,"
operator|<<
name|pageLayout
operator|<<
literal|")"
expr_stmt|;
name|d
operator|->
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_METRICS
block|}
break|break;
block|}
comment|// No default so that compiler will complain if new keys added and not handled in this engine
block|}
block|}
end_function
begin_function
DECL|function|property
name|QVariant
name|QWin32PrintEngine
operator|::
name|property
parameter_list|(
name|PrintEnginePropertyKey
name|key
parameter_list|)
specifier|const
block|{
name|Q_D
argument_list|(
specifier|const
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|QVariant
name|value
decl_stmt|;
switch|switch
condition|(
name|key
condition|)
block|{
comment|// The following keys are settings that are unsupported by the Windows PrintEngine
comment|// Return sensible default values to ensure consistent behavior across platforms
case|case
name|PPK_Duplex
case|:
comment|// TODO Add support using DEVMODE.dmDuplex
name|value
operator|=
name|QPrinter
operator|::
name|DuplexNone
expr_stmt|;
break|break;
case|case
name|PPK_FontEmbedding
case|:
name|value
operator|=
literal|false
expr_stmt|;
break|break;
case|case
name|PPK_PageOrder
case|:
name|value
operator|=
name|QPrinter
operator|::
name|FirstPageFirst
expr_stmt|;
break|break;
case|case
name|PPK_PrinterProgram
case|:
name|value
operator|=
name|QString
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_SelectionOption
case|:
name|value
operator|=
name|QString
argument_list|()
expr_stmt|;
break|break;
comment|// The following keys are properties and settings that are supported by the Windows PrintEngine
case|case
name|PPK_CollateCopies
case|:
name|value
operator|=
name|d
operator|->
name|devMode
operator|->
name|dmCollate
operator|==
name|DMCOLLATE_TRUE
expr_stmt|;
break|break;
case|case
name|PPK_ColorMode
case|:
block|{
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
block|{
name|value
operator|=
name|QPrinter
operator|::
name|Color
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
operator|(
name|d
operator|->
name|devMode
operator|->
name|dmColor
operator|==
name|DMCOLOR_COLOR
operator|)
condition|?
name|QPrinter
operator|::
name|Color
else|:
name|QPrinter
operator|::
name|GrayScale
expr_stmt|;
block|}
block|}
break|break;
case|case
name|PPK_Creator
case|:
name|value
operator|=
name|d
operator|->
name|m_creator
expr_stmt|;
break|break;
case|case
name|PPK_DocumentName
case|:
name|value
operator|=
name|d
operator|->
name|docName
expr_stmt|;
break|break;
case|case
name|PPK_FullPage
case|:
name|value
operator|=
name|d
operator|->
name|m_pageLayout
operator|.
name|mode
argument_list|()
operator|==
name|QPageLayout
operator|::
name|FullPageMode
expr_stmt|;
break|break;
case|case
name|PPK_CopyCount
case|:
name|value
operator|=
name|d
operator|->
name|num_copies
expr_stmt|;
break|break;
case|case
name|PPK_SupportsMultipleCopies
case|:
name|value
operator|=
literal|true
expr_stmt|;
break|break;
case|case
name|PPK_NumberOfCopies
case|:
name|value
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|PPK_Orientation
case|:
name|value
operator|=
name|d
operator|->
name|m_pageLayout
operator|.
name|orientation
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_OutputFileName
case|:
name|value
operator|=
name|d
operator|->
name|fileName
expr_stmt|;
break|break;
case|case
name|PPK_PageRect
case|:
comment|// PageRect is returned in device pixels
name|value
operator|=
name|d
operator|->
name|m_pageLayout
operator|.
name|paintRectPixels
argument_list|(
name|d
operator|->
name|resolution
argument_list|)
expr_stmt|;
break|break;
case|case
name|PPK_PageSize
case|:
name|value
operator|=
name|d
operator|->
name|m_pageLayout
operator|.
name|pageSize
argument_list|()
operator|.
name|id
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_PaperRect
case|:
comment|// PaperRect is returned in device pixels
name|value
operator|=
name|d
operator|->
name|m_pageLayout
operator|.
name|fullRectPixels
argument_list|(
name|d
operator|->
name|resolution
argument_list|)
expr_stmt|;
break|break;
case|case
name|PPK_PaperName
case|:
name|value
operator|=
name|d
operator|->
name|m_pageLayout
operator|.
name|pageSize
argument_list|()
operator|.
name|name
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_PaperSource
case|:
if|if
condition|(
operator|!
name|d
operator|->
name|devMode
condition|)
block|{
name|value
operator|=
name|d
operator|->
name|m_printDevice
operator|.
name|defaultInputSlot
argument_list|()
operator|.
name|id
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
name|QPrint
operator|::
name|Auto
expr_stmt|;
foreach|foreach
control|(
specifier|const
name|QPrint
operator|::
name|InputSlot
name|inputSlot
decl|,
name|d
operator|->
name|m_printDevice
operator|.
name|supportedInputSlots
argument_list|()
control|)
block|{
if|if
condition|(
name|inputSlot
operator|.
name|windowsId
operator|==
name|d
operator|->
name|devMode
operator|->
name|dmDefaultSource
condition|)
block|{
name|value
operator|=
name|inputSlot
operator|.
name|id
expr_stmt|;
break|break;
block|}
block|}
block|}
break|break;
case|case
name|PPK_PrinterName
case|:
name|value
operator|=
name|d
operator|->
name|m_printDevice
operator|.
name|id
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_Resolution
case|:
if|if
condition|(
name|d
operator|->
name|resolution
operator|||
name|d
operator|->
name|m_printDevice
operator|.
name|isValid
argument_list|()
condition|)
name|value
operator|=
name|d
operator|->
name|resolution
expr_stmt|;
break|break;
case|case
name|PPK_SupportedResolutions
case|:
block|{
name|QList
argument_list|<
name|QVariant
argument_list|>
name|list
decl_stmt|;
foreach|foreach
control|(
name|int
name|resolution
decl|,
name|d
operator|->
name|m_printDevice
operator|.
name|supportedResolutions
argument_list|()
control|)
name|list
operator|<<
name|resolution
expr_stmt|;
name|value
operator|=
name|list
expr_stmt|;
break|break;
block|}
case|case
name|PPK_WindowsPageSize
case|:
name|value
operator|=
name|d
operator|->
name|m_pageLayout
operator|.
name|pageSize
argument_list|()
operator|.
name|windowsId
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_PaperSources
case|:
block|{
name|QList
argument_list|<
name|QVariant
argument_list|>
name|out
decl_stmt|;
foreach|foreach
control|(
specifier|const
name|QPrint
operator|::
name|InputSlot
name|inputSlot
decl|,
name|d
operator|->
name|m_printDevice
operator|.
name|supportedInputSlots
argument_list|()
control|)
name|out
operator|<<
name|inputSlot
operator|.
name|id
expr_stmt|;
name|value
operator|=
name|out
expr_stmt|;
break|break;
block|}
case|case
name|PPK_CustomPaperSize
case|:
name|value
operator|=
name|d
operator|->
name|m_pageLayout
operator|.
name|fullRectPoints
argument_list|()
operator|.
name|size
argument_list|()
expr_stmt|;
break|break;
case|case
name|PPK_PageMargins
case|:
block|{
name|QList
argument_list|<
name|QVariant
argument_list|>
name|list
decl_stmt|;
name|QMarginsF
name|margins
init|=
name|d
operator|->
name|m_pageLayout
operator|.
name|margins
argument_list|(
name|QPageLayout
operator|::
name|Point
argument_list|)
decl_stmt|;
name|list
operator|<<
name|margins
operator|.
name|left
argument_list|()
operator|<<
name|margins
operator|.
name|top
argument_list|()
operator|<<
name|margins
operator|.
name|right
argument_list|()
operator|<<
name|margins
operator|.
name|bottom
argument_list|()
expr_stmt|;
name|value
operator|=
name|list
expr_stmt|;
break|break;
block|}
case|case
name|PPK_QPageSize
case|:
name|value
operator|.
name|setValue
argument_list|(
name|d
operator|->
name|m_pageLayout
operator|.
name|pageSize
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|PPK_QPageMargins
case|:
block|{
name|QPair
argument_list|<
name|QMarginsF
argument_list|,
name|QPageLayout
operator|::
name|Unit
argument_list|>
name|pair
init|=
name|qMakePair
argument_list|(
name|d
operator|->
name|m_pageLayout
operator|.
name|margins
argument_list|()
argument_list|,
name|d
operator|->
name|m_pageLayout
operator|.
name|units
argument_list|()
argument_list|)
decl_stmt|;
name|value
operator|.
name|setValue
argument_list|(
name|pair
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|PPK_QPageLayout
case|:
name|value
operator|.
name|setValue
argument_list|(
name|d
operator|->
name|m_pageLayout
argument_list|)
expr_stmt|;
break|break;
comment|// No default so that compiler will complain if new keys added and not handled in this engine
block|}
return|return
name|value
return|;
block|}
end_function
begin_function
DECL|function|printerState
name|QPrinter
operator|::
name|PrinterState
name|QWin32PrintEngine
operator|::
name|printerState
parameter_list|()
specifier|const
block|{
return|return
name|d_func
argument_list|()
operator|->
name|state
return|;
block|}
end_function
begin_function
DECL|function|getDC
name|HDC
name|QWin32PrintEngine
operator|::
name|getDC
parameter_list|()
specifier|const
block|{
return|return
name|d_func
argument_list|()
operator|->
name|hdc
return|;
block|}
end_function
begin_function
DECL|function|releaseDC
name|void
name|QWin32PrintEngine
operator|::
name|releaseDC
parameter_list|(
name|HDC
parameter_list|)
specifier|const
block|{  }
end_function
begin_function
DECL|function|createGlobalDevNames
name|HGLOBAL
modifier|*
name|QWin32PrintEngine
operator|::
name|createGlobalDevNames
parameter_list|()
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
name|int
name|size
init|=
sizeof|sizeof
argument_list|(
name|DEVNAMES
argument_list|)
operator|+
name|d
operator|->
name|m_printDevice
operator|.
name|id
argument_list|()
operator|.
name|length
argument_list|()
operator|*
literal|2
operator|+
literal|2
decl_stmt|;
name|HGLOBAL
modifier|*
name|hGlobal
init|=
operator|(
name|HGLOBAL
operator|*
operator|)
name|GlobalAlloc
argument_list|(
name|GMEM_MOVEABLE
argument_list|,
name|size
argument_list|)
decl_stmt|;
name|DEVNAMES
modifier|*
name|dn
init|=
operator|(
name|DEVNAMES
operator|*
operator|)
name|GlobalLock
argument_list|(
name|hGlobal
argument_list|)
decl_stmt|;
name|dn
operator|->
name|wDriverOffset
operator|=
literal|0
expr_stmt|;
name|dn
operator|->
name|wDeviceOffset
operator|=
sizeof|sizeof
argument_list|(
name|DEVNAMES
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|wchar_t
argument_list|)
expr_stmt|;
name|dn
operator|->
name|wOutputOffset
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|ushort
operator|*
operator|)
name|dn
operator|+
name|dn
operator|->
name|wDeviceOffset
argument_list|,
name|d
operator|->
name|m_printDevice
operator|.
name|id
argument_list|()
operator|.
name|utf16
argument_list|()
argument_list|,
name|d
operator|->
name|m_printDevice
operator|.
name|id
argument_list|()
operator|.
name|length
argument_list|()
operator|*
literal|2
operator|+
literal|2
argument_list|)
expr_stmt|;
name|dn
operator|->
name|wDefault
operator|=
literal|0
expr_stmt|;
name|GlobalUnlock
argument_list|(
name|hGlobal
argument_list|)
expr_stmt|;
return|return
name|hGlobal
return|;
block|}
end_function
begin_function
DECL|function|setGlobalDevMode
name|void
name|QWin32PrintEngine
operator|::
name|setGlobalDevMode
parameter_list|(
name|HGLOBAL
name|globalDevNames
parameter_list|,
name|HGLOBAL
name|globalDevMode
parameter_list|)
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
if|if
condition|(
name|globalDevNames
condition|)
block|{
name|DEVNAMES
modifier|*
name|dn
init|=
operator|(
name|DEVNAMES
operator|*
operator|)
name|GlobalLock
argument_list|(
name|globalDevNames
argument_list|)
decl_stmt|;
name|QString
name|id
init|=
name|QString
operator|::
name|fromWCharArray
argument_list|(
operator|(
name|wchar_t
operator|*
operator|)
operator|(
name|dn
operator|)
operator|+
name|dn
operator|->
name|wDeviceOffset
argument_list|)
decl_stmt|;
name|QPlatformPrinterSupport
modifier|*
name|ps
init|=
name|QPlatformPrinterSupportPlugin
operator|::
name|get
argument_list|()
decl_stmt|;
if|if
condition|(
name|ps
condition|)
name|d
operator|->
name|m_printDevice
operator|=
name|ps
operator|->
name|createPrintDevice
argument_list|(
name|id
operator|.
name|isEmpty
argument_list|()
condition|?
name|ps
operator|->
name|defaultPrintDeviceId
argument_list|()
else|:
name|id
argument_list|)
expr_stmt|;
name|GlobalUnlock
argument_list|(
name|globalDevNames
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|globalDevMode
condition|)
block|{
name|DEVMODE
modifier|*
name|dm
init|=
operator|(
name|DEVMODE
operator|*
operator|)
name|GlobalLock
argument_list|(
name|globalDevMode
argument_list|)
decl_stmt|;
name|d
operator|->
name|release
argument_list|()
expr_stmt|;
name|d
operator|->
name|globalDevMode
operator|=
name|globalDevMode
expr_stmt|;
name|d
operator|->
name|devMode
operator|=
name|dm
expr_stmt|;
name|d
operator|->
name|hdc
operator|=
name|CreateDC
argument_list|(
name|NULL
argument_list|,
cast|reinterpret_cast
argument_list|<
specifier|const
name|wchar_t
operator|*
argument_list|>
argument_list|(
name|d
operator|->
name|m_printDevice
operator|.
name|id
argument_list|()
operator|.
name|utf16
argument_list|()
argument_list|)
argument_list|,
literal|0
argument_list|,
name|dm
argument_list|)
expr_stmt|;
name|d
operator|->
name|num_copies
operator|=
name|d
operator|->
name|devMode
operator|->
name|dmCopies
expr_stmt|;
name|d
operator|->
name|updatePageLayout
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|OpenPrinter
argument_list|(
operator|(
name|wchar_t
operator|*
operator|)
name|d
operator|->
name|m_printDevice
operator|.
name|id
argument_list|()
operator|.
name|utf16
argument_list|()
argument_list|,
operator|&
name|d
operator|->
name|hPrinter
argument_list|,
literal|0
argument_list|)
condition|)
name|qWarning
argument_list|(
literal|"QPrinter: OpenPrinter() failed after reading DEVMODE."
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|d
operator|->
name|hdc
condition|)
name|d
operator|->
name|initHDC
argument_list|()
expr_stmt|;
if|#
directive|if
name|defined
name|QT_DEBUG_DRAW
operator|||
name|defined
name|QT_DEBUG_METRICS
name|qDebug
argument_list|()
operator|<<
literal|"QWin32PrintEngine::setGlobalDevMode()"
expr_stmt|;
name|debugMetrics
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|// QT_DEBUG_DRAW || QT_DEBUG_METRICS
block|}
end_function
begin_function
DECL|function|globalDevMode
name|HGLOBAL
name|QWin32PrintEngine
operator|::
name|globalDevMode
parameter_list|()
block|{
name|Q_D
argument_list|(
name|QWin32PrintEngine
argument_list|)
expr_stmt|;
return|return
name|d
operator|->
name|globalDevMode
return|;
block|}
end_function
begin_function
DECL|function|setPageSize
name|void
name|QWin32PrintEnginePrivate
operator|::
name|setPageSize
parameter_list|(
specifier|const
name|QPageSize
modifier|&
name|pageSize
parameter_list|)
block|{
if|if
condition|(
operator|!
name|pageSize
operator|.
name|isValid
argument_list|()
condition|)
return|return;
comment|// Use the printer page size if supported
specifier|const
name|QPageSize
name|printerPageSize
init|=
name|m_printDevice
operator|.
name|supportedPageSize
argument_list|(
name|pageSize
argument_list|)
decl_stmt|;
specifier|const
name|QPageSize
name|usePageSize
init|=
name|printerPageSize
operator|.
name|isValid
argument_list|()
condition|?
name|printerPageSize
else|:
name|pageSize
decl_stmt|;
specifier|const
name|QMarginsF
name|printable
init|=
name|m_printDevice
operator|.
name|printableMargins
argument_list|(
name|usePageSize
argument_list|,
name|m_pageLayout
operator|.
name|orientation
argument_list|()
argument_list|,
name|resolution
argument_list|)
decl_stmt|;
name|m_pageLayout
operator|.
name|setPageSize
argument_list|(
name|usePageSize
argument_list|,
name|qt_convertMargins
argument_list|(
name|printable
argument_list|,
name|QPageLayout
operator|::
name|Point
argument_list|,
name|m_pageLayout
operator|.
name|units
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// Setup if Windows custom size, i.e. not a known Windows ID
if|if
condition|(
name|printerPageSize
operator|.
name|isValid
argument_list|()
condition|)
block|{
name|has_custom_paper_size
operator|=
literal|false
expr_stmt|;
name|devMode
operator|->
name|dmPaperSize
operator|=
name|m_pageLayout
operator|.
name|pageSize
argument_list|()
operator|.
name|windowsId
argument_list|()
expr_stmt|;
name|devMode
operator|->
name|dmFields
operator|&=
operator|~
operator|(
name|DM_PAPERLENGTH
operator||
name|DM_PAPERWIDTH
operator|)
expr_stmt|;
name|devMode
operator|->
name|dmPaperWidth
operator|=
literal|0
expr_stmt|;
name|devMode
operator|->
name|dmPaperLength
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|devMode
operator|->
name|dmPaperSize
operator|=
name|DMPAPER_USER
expr_stmt|;
name|devMode
operator|->
name|dmFields
operator||=
name|DM_PAPERLENGTH
operator||
name|DM_PAPERWIDTH
expr_stmt|;
comment|// Size in tenths of a millimeter
specifier|const
name|QSizeF
name|sizeMM
init|=
name|m_pageLayout
operator|.
name|pageSize
argument_list|()
operator|.
name|size
argument_list|(
name|QPageSize
operator|::
name|Millimeter
argument_list|)
decl_stmt|;
name|devMode
operator|->
name|dmPaperWidth
operator|=
name|qRound
argument_list|(
name|sizeMM
operator|.
name|width
argument_list|()
operator|*
literal|10.0
argument_list|)
expr_stmt|;
name|devMode
operator|->
name|dmPaperLength
operator|=
name|qRound
argument_list|(
name|sizeMM
operator|.
name|height
argument_list|()
operator|*
literal|10.0
argument_list|)
expr_stmt|;
block|}
name|updateMetrics
argument_list|()
expr_stmt|;
block|}
end_function
begin_comment
comment|// Update the page layout after any changes made to devMode
end_comment
begin_function
DECL|function|updatePageLayout
name|void
name|QWin32PrintEnginePrivate
operator|::
name|updatePageLayout
parameter_list|()
block|{
comment|// Update orientation first as is needed to obtain printable margins when changing page size
name|m_pageLayout
operator|.
name|setOrientation
argument_list|(
name|devMode
operator|->
name|dmOrientation
operator|==
name|DMORIENT_LANDSCAPE
condition|?
name|QPageLayout
operator|::
name|Landscape
else|:
name|QPageLayout
operator|::
name|Portrait
argument_list|)
expr_stmt|;
if|if
condition|(
name|devMode
operator|->
name|dmPaperSize
operator|>=
name|DMPAPER_USER
condition|)
block|{
comment|// Is a custom size
name|QPageSize
name|pageSize
init|=
name|QPageSize
argument_list|(
name|QSizeF
argument_list|(
name|devMode
operator|->
name|dmPaperWidth
operator|/
literal|10.0f
argument_list|,
name|devMode
operator|->
name|dmPaperLength
operator|/
literal|10.0f
argument_list|)
argument_list|,
name|QPageSize
operator|::
name|Millimeter
argument_list|)
decl_stmt|;
name|setPageSize
argument_list|(
name|pageSize
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Is a supported size
name|setPageSize
argument_list|(
name|QPageSize
argument_list|(
name|QPageSize
operator|::
name|id
argument_list|(
name|devMode
operator|->
name|dmPaperSize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|updateMetrics
argument_list|()
expr_stmt|;
block|}
end_function
begin_comment
comment|// Update the cached page paint metrics whenever page layout is changed
end_comment
begin_function
DECL|function|updateMetrics
name|void
name|QWin32PrintEnginePrivate
operator|::
name|updateMetrics
parameter_list|()
block|{
name|m_paintRectPixels
operator|=
name|m_pageLayout
operator|.
name|paintRectPixels
argument_list|(
name|resolution
argument_list|)
expr_stmt|;
name|QSizeF
name|sizeMM
init|=
name|m_pageLayout
operator|.
name|paintRect
argument_list|(
name|QPageLayout
operator|::
name|Millimeter
argument_list|)
operator|.
name|size
argument_list|()
decl_stmt|;
name|m_paintSizeMM
operator|=
name|QSize
argument_list|(
name|qRound
argument_list|(
name|sizeMM
operator|.
name|width
argument_list|()
argument_list|)
argument_list|,
name|qRound
argument_list|(
name|sizeMM
operator|.
name|height
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// Calculate the origin using the physical device pixels, not our paint pixels
comment|// Origin is defined as User Margins - Device Margins
name|QMarginsF
name|margins
init|=
name|m_pageLayout
operator|.
name|margins
argument_list|(
name|QPageLayout
operator|::
name|Millimeter
argument_list|)
operator|/
literal|25.4
decl_stmt|;
name|origin_x
operator|=
name|qRound
argument_list|(
name|margins
operator|.
name|left
argument_list|()
operator|*
name|dpi_x
argument_list|)
operator|-
name|GetDeviceCaps
argument_list|(
name|hdc
argument_list|,
name|PHYSICALOFFSETX
argument_list|)
expr_stmt|;
name|origin_y
operator|=
name|qRound
argument_list|(
name|margins
operator|.
name|top
argument_list|()
operator|*
name|dpi_y
argument_list|)
operator|-
name|GetDeviceCaps
argument_list|(
name|hdc
argument_list|,
name|PHYSICALOFFSETY
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|debugMetrics
name|void
name|QWin32PrintEnginePrivate
operator|::
name|debugMetrics
parameter_list|()
specifier|const
block|{
name|qDebug
argument_list|()
operator|<<
literal|"    "
operator|<<
literal|"m_pageLayout      = "
operator|<<
name|m_pageLayout
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"    "
operator|<<
literal|"m_paintRectPixels = "
operator|<<
name|m_paintRectPixels
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"    "
operator|<<
literal|"m_paintSizeMM     = "
operator|<<
name|m_paintSizeMM
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"    "
operator|<<
literal|"resolution        = "
operator|<<
name|resolution
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"    "
operator|<<
literal|"stretch           = "
operator|<<
name|stretch_x
operator|<<
name|stretch_y
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"    "
operator|<<
literal|"origin            = "
operator|<<
name|origin_x
operator|<<
name|origin_y
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|"    "
operator|<<
literal|"dpi               = "
operator|<<
name|dpi_x
operator|<<
name|dpi_y
expr_stmt|;
name|qDebug
argument_list|()
operator|<<
literal|""
expr_stmt|;
block|}
end_function
begin_function
DECL|function|draw_text_item_win
specifier|static
name|void
name|draw_text_item_win
parameter_list|(
specifier|const
name|QPointF
modifier|&
name|pos
parameter_list|,
specifier|const
name|QTextItemInt
modifier|&
name|ti
parameter_list|,
name|HDC
name|hdc
parameter_list|,
name|bool
name|convertToText
parameter_list|,
specifier|const
name|QTransform
modifier|&
name|xform
parameter_list|,
specifier|const
name|QPointF
modifier|&
name|topLeft
parameter_list|)
block|{
name|QPointF
name|baseline_pos
init|=
name|xform
operator|.
name|inverted
argument_list|()
operator|.
name|map
argument_list|(
name|xform
operator|.
name|map
argument_list|(
name|pos
argument_list|)
operator|-
name|topLeft
argument_list|)
decl_stmt|;
name|SetTextAlign
argument_list|(
name|hdc
argument_list|,
name|TA_BASELINE
argument_list|)
expr_stmt|;
name|SetBkMode
argument_list|(
name|hdc
argument_list|,
name|TRANSPARENT
argument_list|)
expr_stmt|;
specifier|const
name|bool
name|has_kerning
init|=
name|ti
operator|.
name|f
operator|&&
name|ti
operator|.
name|f
operator|->
name|kerning
argument_list|()
decl_stmt|;
name|HFONT
name|hfont
init|=
literal|0
decl_stmt|;
name|bool
name|ttf
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|ti
operator|.
name|fontEngine
operator|->
name|type
argument_list|()
operator|==
name|QFontEngine
operator|::
name|Win
condition|)
block|{
specifier|const
name|QVariantMap
name|userData
init|=
name|ti
operator|.
name|fontEngine
operator|->
name|userData
argument_list|()
operator|.
name|toMap
argument_list|()
decl_stmt|;
specifier|const
name|QVariant
name|hfontV
init|=
name|userData
operator|.
name|value
argument_list|(
name|QStringLiteral
argument_list|(
literal|"hFont"
argument_list|)
argument_list|)
decl_stmt|;
specifier|const
name|QVariant
name|ttfV
init|=
name|userData
operator|.
name|value
argument_list|(
name|QStringLiteral
argument_list|(
literal|"trueType"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|ttfV
operator|.
name|type
argument_list|()
operator|==
name|QVariant
operator|::
name|Bool
operator|&&
name|hfontV
operator|.
name|canConvert
argument_list|<
name|HFONT
argument_list|>
argument_list|()
condition|)
block|{
name|hfont
operator|=
name|hfontV
operator|.
name|value
argument_list|<
name|HFONT
argument_list|>
argument_list|()
expr_stmt|;
name|ttf
operator|=
name|ttfV
operator|.
name|toBool
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|hfont
condition|)
name|hfont
operator|=
operator|(
name|HFONT
operator|)
name|GetStockObject
argument_list|(
name|ANSI_VAR_FONT
argument_list|)
expr_stmt|;
name|HGDIOBJ
name|old_font
init|=
name|SelectObject
argument_list|(
name|hdc
argument_list|,
name|hfont
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|options
init|=
operator|(
name|ttf
operator|&&
operator|!
name|convertToText
operator|)
condition|?
name|ETO_GLYPH_INDEX
else|:
literal|0
decl_stmt|;
name|wchar_t
modifier|*
name|convertedGlyphs
init|=
operator|(
name|wchar_t
operator|*
operator|)
name|ti
operator|.
name|chars
decl_stmt|;
name|QGlyphLayout
name|glyphs
init|=
name|ti
operator|.
name|glyphs
decl_stmt|;
name|bool
name|fast
init|=
operator|!
name|has_kerning
operator|&&
operator|!
operator|(
name|ti
operator|.
name|flags
operator|&
name|QTextItem
operator|::
name|RightToLeft
operator|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|fast
operator|&&
name|i
operator|<
name|glyphs
operator|.
name|numGlyphs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|glyphs
operator|.
name|offsets
index|[
name|i
index|]
operator|.
name|x
operator|!=
literal|0
operator|||
name|glyphs
operator|.
name|offsets
index|[
name|i
index|]
operator|.
name|y
operator|!=
literal|0
operator|||
name|glyphs
operator|.
name|justifications
index|[
name|i
index|]
operator|.
name|space_18d6
operator|!=
literal|0
operator|||
name|glyphs
operator|.
name|attributes
index|[
name|i
index|]
operator|.
name|dontPrint
condition|)
block|{
name|fast
operator|=
literal|false
expr_stmt|;
break|break;
block|}
block|}
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
comment|// Scale, rotate and translate here.
name|XFORM
name|win_xform
decl_stmt|;
name|win_xform
operator|.
name|eM11
operator|=
name|xform
operator|.
name|m11
argument_list|()
expr_stmt|;
name|win_xform
operator|.
name|eM12
operator|=
name|xform
operator|.
name|m12
argument_list|()
expr_stmt|;
name|win_xform
operator|.
name|eM21
operator|=
name|xform
operator|.
name|m21
argument_list|()
expr_stmt|;
name|win_xform
operator|.
name|eM22
operator|=
name|xform
operator|.
name|m22
argument_list|()
expr_stmt|;
name|win_xform
operator|.
name|eDx
operator|=
name|xform
operator|.
name|dx
argument_list|()
expr_stmt|;
name|win_xform
operator|.
name|eDy
operator|=
name|xform
operator|.
name|dy
argument_list|()
expr_stmt|;
name|SetGraphicsMode
argument_list|(
name|hdc
argument_list|,
name|GM_ADVANCED
argument_list|)
expr_stmt|;
name|SetWorldTransform
argument_list|(
name|hdc
argument_list|,
operator|&
name|win_xform
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|fast
condition|)
block|{
comment|// fast path
name|QVarLengthArray
argument_list|<
name|wchar_t
argument_list|>
name|g
argument_list|(
name|glyphs
operator|.
name|numGlyphs
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|glyphs
operator|.
name|numGlyphs
condition|;
operator|++
name|i
control|)
name|g
index|[
name|i
index|]
operator|=
name|glyphs
operator|.
name|glyphs
index|[
name|i
index|]
expr_stmt|;
name|ExtTextOut
argument_list|(
name|hdc
argument_list|,
name|qRound
argument_list|(
name|baseline_pos
operator|.
name|x
argument_list|()
operator|+
name|glyphs
operator|.
name|offsets
index|[
literal|0
index|]
operator|.
name|x
operator|.
name|toReal
argument_list|()
argument_list|)
argument_list|,
name|qRound
argument_list|(
name|baseline_pos
operator|.
name|y
argument_list|()
operator|+
name|glyphs
operator|.
name|offsets
index|[
literal|0
index|]
operator|.
name|y
operator|.
name|toReal
argument_list|()
argument_list|)
argument_list|,
name|options
argument_list|,
literal|0
argument_list|,
name|convertToText
condition|?
name|convertedGlyphs
else|:
name|g
operator|.
name|data
argument_list|()
argument_list|,
name|glyphs
operator|.
name|numGlyphs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QVarLengthArray
argument_list|<
name|QFixedPoint
argument_list|>
name|positions
decl_stmt|;
name|QVarLengthArray
argument_list|<
name|glyph_t
argument_list|>
name|_glyphs
decl_stmt|;
name|QTransform
name|matrix
init|=
name|QTransform
operator|::
name|fromTranslate
argument_list|(
name|baseline_pos
operator|.
name|x
argument_list|()
argument_list|,
name|baseline_pos
operator|.
name|y
argument_list|()
argument_list|)
decl_stmt|;
name|ti
operator|.
name|fontEngine
operator|->
name|getGlyphPositions
argument_list|(
name|ti
operator|.
name|glyphs
argument_list|,
name|matrix
argument_list|,
name|ti
operator|.
name|flags
argument_list|,
name|_glyphs
argument_list|,
name|positions
argument_list|)
expr_stmt|;
if|if
condition|(
name|_glyphs
operator|.
name|size
argument_list|()
operator|==
literal|0
condition|)
block|{
name|SelectObject
argument_list|(
name|hdc
argument_list|,
name|old_font
argument_list|)
expr_stmt|;
return|return;
block|}
name|convertToText
operator|=
name|convertToText
operator|&&
name|glyphs
operator|.
name|numGlyphs
operator|==
name|_glyphs
operator|.
name|size
argument_list|()
expr_stmt|;
name|bool
name|outputEntireItem
init|=
name|_glyphs
operator|.
name|size
argument_list|()
operator|>
literal|0
decl_stmt|;
if|if
condition|(
name|outputEntireItem
condition|)
block|{
name|options
operator||=
name|ETO_PDY
expr_stmt|;
name|QVarLengthArray
argument_list|<
name|INT
argument_list|>
name|glyphDistances
argument_list|(
name|_glyphs
operator|.
name|size
argument_list|()
operator|*
literal|2
argument_list|)
decl_stmt|;
name|QVarLengthArray
argument_list|<
name|wchar_t
argument_list|>
name|g
argument_list|(
name|_glyphs
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|_glyphs
operator|.
name|size
argument_list|()
operator|-
literal|1
condition|;
operator|++
name|i
control|)
block|{
name|glyphDistances
index|[
name|i
operator|*
literal|2
index|]
operator|=
name|qRound
argument_list|(
name|positions
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|x
argument_list|)
operator|-
name|qRound
argument_list|(
name|positions
index|[
name|i
index|]
operator|.
name|x
argument_list|)
expr_stmt|;
name|glyphDistances
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|qRound
argument_list|(
name|positions
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|y
argument_list|)
operator|-
name|qRound
argument_list|(
name|positions
index|[
name|i
index|]
operator|.
name|y
argument_list|)
expr_stmt|;
name|g
index|[
name|i
index|]
operator|=
name|_glyphs
index|[
name|i
index|]
expr_stmt|;
block|}
name|glyphDistances
index|[
operator|(
name|_glyphs
operator|.
name|size
argument_list|()
operator|-
literal|1
operator|)
operator|*
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|glyphDistances
index|[
operator|(
name|_glyphs
operator|.
name|size
argument_list|()
operator|-
literal|1
operator|)
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|g
index|[
name|_glyphs
operator|.
name|size
argument_list|()
operator|-
literal|1
index|]
operator|=
name|_glyphs
index|[
name|_glyphs
operator|.
name|size
argument_list|()
operator|-
literal|1
index|]
expr_stmt|;
name|ExtTextOut
argument_list|(
name|hdc
argument_list|,
name|qRound
argument_list|(
name|positions
index|[
literal|0
index|]
operator|.
name|x
argument_list|)
argument_list|,
name|qRound
argument_list|(
name|positions
index|[
literal|0
index|]
operator|.
name|y
argument_list|)
argument_list|,
name|options
argument_list|,
literal|0
argument_list|,
name|convertToText
condition|?
name|convertedGlyphs
else|:
name|g
operator|.
name|data
argument_list|()
argument_list|,
name|_glyphs
operator|.
name|size
argument_list|()
argument_list|,
name|glyphDistances
operator|.
name|data
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|i
operator|<
name|_glyphs
operator|.
name|size
argument_list|()
condition|)
block|{
name|wchar_t
name|g
init|=
name|_glyphs
index|[
name|i
index|]
decl_stmt|;
name|ExtTextOut
argument_list|(
name|hdc
argument_list|,
name|qRound
argument_list|(
name|positions
index|[
name|i
index|]
operator|.
name|x
argument_list|)
argument_list|,
name|qRound
argument_list|(
name|positions
index|[
name|i
index|]
operator|.
name|y
argument_list|)
argument_list|,
name|options
argument_list|,
literal|0
argument_list|,
name|convertToText
condition|?
name|convertedGlyphs
operator|+
name|i
else|:
operator|&
name|g
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|++
name|i
expr_stmt|;
block|}
block|}
block|}
if|#
directive|if
operator|!
name|defined
argument_list|(
name|Q_OS_WINCE
argument_list|)
name|win_xform
operator|.
name|eM11
operator|=
name|win_xform
operator|.
name|eM22
operator|=
literal|1.0
expr_stmt|;
name|win_xform
operator|.
name|eM12
operator|=
name|win_xform
operator|.
name|eM21
operator|=
name|win_xform
operator|.
name|eDx
operator|=
name|win_xform
operator|.
name|eDy
operator|=
literal|0.0
expr_stmt|;
name|SetWorldTransform
argument_list|(
name|hdc
argument_list|,
operator|&
name|win_xform
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SelectObject
argument_list|(
name|hdc
argument_list|,
name|old_font
argument_list|)
expr_stmt|;
block|}
end_function
begin_macro
name|QT_END_NAMESPACE
end_macro
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|// QT_NO_PRINTER
end_comment
end_unit
