begin_unit
begin_comment
comment|/**************************************************************************** ** ** Copyright (C) 2013 Intel Corporation. ** Contact: http://www.qt-project.org/legal ** ** This file is part of the QtCore module of the Qt Toolkit. ** ** $QT_BEGIN_LICENSE:LGPL$ ** Commercial License Usage ** Licensees holding valid commercial Qt licenses may use this file in ** accordance with the commercial license agreement provided with the ** Software or, alternatively, in accordance with the terms contained in ** a written agreement between you and Digia.  For licensing terms and ** conditions see http://qt.digia.com/licensing.  For further information ** use the contact form at http://qt.digia.com/contact-us. ** ** GNU Lesser General Public License Usage ** Alternatively, this file may be used under the terms of the GNU Lesser ** General Public License version 2.1 as published by the Free Software ** Foundation and appearing in the file LICENSE.LGPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU Lesser General Public License version 2.1 requirements ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html. ** ** In addition, as a special exception, Digia gives you certain additional ** rights.  These rights are described in the Digia Qt LGPL Exception ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package. ** ** GNU General Public License Usage ** Alternatively, this file may be used under the terms of the GNU ** General Public License version 3.0 as published by the Free Software ** Foundation and appearing in the file LICENSE.GPL included in the ** packaging of this file.  Please review the following information to ** ensure the GNU General Public License version 3.0 requirements will be ** met: http://www.gnu.org/copyleft/gpl.html. ** ** ** $QT_END_LICENSE$ ** ****************************************************************************/
end_comment
begin_include
include|#
directive|include
file|"qbenchmarkperfevents_p.h"
end_include
begin_include
include|#
directive|include
file|"qbenchmarkmetric.h"
end_include
begin_include
include|#
directive|include
file|"qbenchmark_p.h"
end_include
begin_ifdef
ifdef|#
directive|ifdef
name|QTESTLIB_USE_PERF_EVENTS
end_ifdef
begin_comment
comment|// include the qcore_unix_p.h without core-private
end_comment
begin_comment
comment|// we only use inline functions anyway
end_comment
begin_include
include|#
directive|include
file|"../corelib/kernel/qcore_unix_p.h"
end_include
begin_include
include|#
directive|include
file|<sys/types.h>
end_include
begin_include
include|#
directive|include
file|<errno.h>
end_include
begin_include
include|#
directive|include
file|<fcntl.h>
end_include
begin_include
include|#
directive|include
file|<string.h>
end_include
begin_include
include|#
directive|include
file|<stdio.h>
end_include
begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include
begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include
begin_include
include|#
directive|include
file|"3rdparty/linux_perf_event_p.h"
end_include
begin_comment
comment|// for PERF_TYPE_HW_CACHE, the config is a bitmask
end_comment
begin_comment
comment|// lowest 8 bits: cache type
end_comment
begin_comment
comment|// bits 8 to 15: cache operation
end_comment
begin_comment
comment|// bits 16 to 23: cache result
end_comment
begin_define
DECL|macro|CACHE_L1D_READ
define|#
directive|define
name|CACHE_L1D_READ
value|(PERF_COUNT_HW_CACHE_L1D | PERF_COUNT_HW_CACHE_OP_READ<< 8 | PERF_COUNT_HW_CACHE_RESULT_ACCESS<< 16)
end_define
begin_define
DECL|macro|CACHE_L1D_WRITE
define|#
directive|define
name|CACHE_L1D_WRITE
value|(PERF_COUNT_HW_CACHE_L1D | PERF_COUNT_HW_CACHE_OP_WRITE<< 8 | PERF_COUNT_HW_CACHE_RESULT_ACCESS<< 16)
end_define
begin_define
DECL|macro|CACHE_L1D_PREFETCH
define|#
directive|define
name|CACHE_L1D_PREFETCH
value|(PERF_COUNT_HW_CACHE_L1D | PERF_COUNT_HW_CACHE_OP_PREFETCH<< 8 | PERF_COUNT_HW_CACHE_RESULT_ACCESS<< 16)
end_define
begin_define
DECL|macro|CACHE_L1I_READ
define|#
directive|define
name|CACHE_L1I_READ
value|(PERF_COUNT_HW_CACHE_L1I | PERF_COUNT_HW_CACHE_OP_READ<< 8 | PERF_COUNT_HW_CACHE_RESULT_ACCESS<< 16)
end_define
begin_define
DECL|macro|CACHE_L1I_PREFETCH
define|#
directive|define
name|CACHE_L1I_PREFETCH
value|(PERF_COUNT_HW_CACHE_L1I | PERF_COUNT_HW_CACHE_OP_PREFETCH<< 8 | PERF_COUNT_HW_CACHE_RESULT_ACCESS<< 16)
end_define
begin_define
DECL|macro|CACHE_LLC_READ
define|#
directive|define
name|CACHE_LLC_READ
value|(PERF_COUNT_HW_CACHE_LL  | PERF_COUNT_HW_CACHE_OP_READ<< 8 | PERF_COUNT_HW_CACHE_RESULT_ACCESS<< 16)
end_define
begin_define
DECL|macro|CACHE_LLC_WRITE
define|#
directive|define
name|CACHE_LLC_WRITE
value|(PERF_COUNT_HW_CACHE_LL  | PERF_COUNT_HW_CACHE_OP_WRITE<< 8| PERF_COUNT_HW_CACHE_RESULT_ACCESS<< 16)
end_define
begin_define
DECL|macro|CACHE_LLC_PREFETCH
define|#
directive|define
name|CACHE_LLC_PREFETCH
value|(PERF_COUNT_HW_CACHE_LL  | PERF_COUNT_HW_CACHE_OP_PREFETCH<< 8 | PERF_COUNT_HW_CACHE_RESULT_ACCESS<< 16)
end_define
begin_define
DECL|macro|CACHE_L1D_READ_MISS
define|#
directive|define
name|CACHE_L1D_READ_MISS
value|(PERF_COUNT_HW_CACHE_L1D | PERF_COUNT_HW_CACHE_OP_READ<< 8 | PERF_COUNT_HW_CACHE_RESULT_MISS<< 16)
end_define
begin_define
DECL|macro|CACHE_L1D_WRITE_MISS
define|#
directive|define
name|CACHE_L1D_WRITE_MISS
value|(PERF_COUNT_HW_CACHE_L1D | PERF_COUNT_HW_CACHE_OP_WRITE<< 8 | PERF_COUNT_HW_CACHE_RESULT_MISS<< 16)
end_define
begin_define
DECL|macro|CACHE_L1D_PREFETCH_MISS
define|#
directive|define
name|CACHE_L1D_PREFETCH_MISS
value|(PERF_COUNT_HW_CACHE_L1D | PERF_COUNT_HW_CACHE_OP_PREFETCH<< 8 | PERF_COUNT_HW_CACHE_RESULT_MISS<< 16)
end_define
begin_define
DECL|macro|CACHE_L1I_READ_MISS
define|#
directive|define
name|CACHE_L1I_READ_MISS
value|(PERF_COUNT_HW_CACHE_L1I | PERF_COUNT_HW_CACHE_OP_READ<< 8 | PERF_COUNT_HW_CACHE_RESULT_MISS<< 16)
end_define
begin_define
DECL|macro|CACHE_L1I_PREFETCH_MISS
define|#
directive|define
name|CACHE_L1I_PREFETCH_MISS
value|(PERF_COUNT_HW_CACHE_L1I | PERF_COUNT_HW_CACHE_OP_PREFETCH<< 8 | PERF_COUNT_HW_CACHE_RESULT_MISS<< 16)
end_define
begin_define
DECL|macro|CACHE_LLC_READ_MISS
define|#
directive|define
name|CACHE_LLC_READ_MISS
value|(PERF_COUNT_HW_CACHE_LL  | PERF_COUNT_HW_CACHE_OP_READ<< 8 | PERF_COUNT_HW_CACHE_RESULT_MISS<< 16)
end_define
begin_define
DECL|macro|CACHE_LLC_WRITE_MISS
define|#
directive|define
name|CACHE_LLC_WRITE_MISS
value|(PERF_COUNT_HW_CACHE_LL  | PERF_COUNT_HW_CACHE_OP_WRITE<< 8 | PERF_COUNT_HW_CACHE_RESULT_MISS<< 16)
end_define
begin_define
DECL|macro|CACHE_LLC_PREFETCH_MISS
define|#
directive|define
name|CACHE_LLC_PREFETCH_MISS
value|(PERF_COUNT_HW_CACHE_LL  | PERF_COUNT_HW_CACHE_OP_PREFETCH<< 8 | PERF_COUNT_HW_CACHE_RESULT_MISS<< 16)
end_define
begin_define
DECL|macro|CACHE_BRANCH_READ
define|#
directive|define
name|CACHE_BRANCH_READ
value|(PERF_COUNT_HW_CACHE_BPU | PERF_COUNT_HW_CACHE_OP_READ<< 8 | PERF_COUNT_HW_CACHE_RESULT_ACCESS<< 16)
end_define
begin_define
DECL|macro|CACHE_BRANCH_READ_MISS
define|#
directive|define
name|CACHE_BRANCH_READ_MISS
value|(PERF_COUNT_HW_CACHE_BPU | PERF_COUNT_HW_CACHE_OP_READ<< 8 | PERF_COUNT_HW_CACHE_RESULT_MISS<< 16)
end_define
begin_decl_stmt
name|QT_BEGIN_NAMESPACE
DECL|variable|attr
specifier|static
name|perf_event_attr
name|attr
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|initPerf
specifier|static
name|void
name|initPerf
parameter_list|()
block|{
specifier|static
name|bool
name|done
decl_stmt|;
if|if
condition|(
operator|!
name|done
condition|)
block|{
name|memset
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|attr
argument_list|)
expr_stmt|;
name|attr
operator|.
name|size
operator|=
sizeof|sizeof
name|attr
expr_stmt|;
name|attr
operator|.
name|read_format
operator|=
name|PERF_FORMAT_TOTAL_TIME_ENABLED
operator||
name|PERF_FORMAT_TOTAL_TIME_RUNNING
expr_stmt|;
name|attr
operator|.
name|disabled
operator|=
literal|true
expr_stmt|;
comment|// we'll enable later
name|attr
operator|.
name|inherit
operator|=
literal|true
expr_stmt|;
comment|// let children processes inherit the monitoring
name|attr
operator|.
name|pinned
operator|=
literal|true
expr_stmt|;
comment|// keep it running in the hardware
name|attr
operator|.
name|inherit_stat
operator|=
literal|true
expr_stmt|;
comment|// aggregate all the info from child processes
name|attr
operator|.
name|task
operator|=
literal|true
expr_stmt|;
comment|// trace fork/exits
comment|// set a default performance counter: CPU cycles
name|attr
operator|.
name|type
operator|=
name|PERF_TYPE_HARDWARE
expr_stmt|;
name|attr
operator|.
name|config
operator|=
name|PERF_COUNT_HW_CPU_CYCLES
expr_stmt|;
comment|// default
name|done
operator|=
literal|true
expr_stmt|;
block|}
block|}
end_function
begin_comment
comment|/*!     \class QBenchmarkPerfEvents     \brief The Linux perf events benchmark backend      This benchmark backend uses the Linux Performance Counters interface,     introduced with the Linux kernel v2.6.31. The interface is done by one     system call (perf_event_open) which takes an attribute structure and     returns a file descriptor.      More information:      \li design docs: tools/perf/design.txt<http://lxr.linux.no/linux/tools/perf/design.txt>      \li sample tool: tools/perf/builtin-stat.c<http://lxr.linux.no/linux/tools/perf/builtin-stat.c>     (note: as of v3.3.1, the documentation is out-of-date with the kernel     interface, so reading the source code of existing tools is necessary)      This benchlib backend monitors the current process as well as child process     launched. We do not try to benchmark in kernel or hypervisor mode, as that     usually requires elevated privileges.  */
end_comment
begin_function
DECL|function|perf_event_open
specifier|static
name|int
name|perf_event_open
parameter_list|(
name|perf_event_attr
modifier|*
name|attr
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|int
name|cpu
parameter_list|,
name|int
name|group_fd
parameter_list|,
name|unsigned
name|long
name|flags
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SYS_perf_event_open
return|return
name|syscall
argument_list|(
name|SYS_perf_event_open
argument_list|,
name|attr
argument_list|,
name|pid
argument_list|,
name|cpu
argument_list|,
name|group_fd
argument_list|,
name|flags
argument_list|)
return|;
else|#
directive|else
name|Q_UNUSED
argument_list|(
name|attr
argument_list|)
expr_stmt|;
name|Q_UNUSED
argument_list|(
name|pid
argument_list|)
expr_stmt|;
name|Q_UNUSED
argument_list|(
name|cpu
argument_list|)
expr_stmt|;
name|Q_UNUSED
argument_list|(
name|group_fd
argument_list|)
expr_stmt|;
name|Q_UNUSED
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOSYS
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
block|}
end_function
begin_function
DECL|function|isAvailable
name|bool
name|QBenchmarkPerfEventsMeasurer
operator|::
name|isAvailable
parameter_list|()
block|{
comment|// this generates an EFAULT because attr == NULL if perf_event_open is available
comment|// if the kernel is too old, it generates ENOSYS
return|return
name|perf_event_open
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|!=
name|ENOSYS
return|;
block|}
end_function
begin_comment
comment|/* Event list structure    The following table provides the list of supported events     Event type   Event counter           Unit            Name and aliases    HARDWARE     CPU_CYCLES              CPUCycles       cycles  cpu-cycles    HARDWARE     INSTRUCTIONS            Instructions    instructions    HARDWARE     CACHE_REFERENCES        CacheReferences cache-references    HARDWARE     CACHE_MISSES            CacheMisses     cache-misses    HARDWARE     BRANCH_INSTRUCTIONS     BranchInstructions branch-instructions branches    HARDWARE     BRANCH_MISSES           BranchMisses    branch-misses    HARDWARE     BUS_CYCLES              BusCycles       bus-cycles    HARDWARE     STALLED_CYCLES_FRONTEND StalledCycles   stalled-cycles-frontend idle-cycles-frontend    HARDWARE     STALLED_CYCLES_BACKEND  StalledCycles   stalled-cycles-backend idle-cycles-backend    SOFTWARE     CPU_CLOCK               WalltimeMilliseconds cpu-clock    SOFTWARE     TASK_CLOCK              WalltimeMilliseconds task-clock    SOFTWARE     PAGE_FAULTS             PageFaults      page-faults faults    SOFTWARE     PAGE_FAULTS_MAJ         MajorPageFaults major-faults    SOFTWARE     PAGE_FAULTS_MIN         MinorPageFaults minor-faults    SOFTWARE     CONTEXT_SWITCHES        ContextSwitches context-switches cs    SOFTWARE     CPU_MIGRATIONS          CPUMigrations   cpu-migrations migrations    SOFTWARE     ALIGNMENT_FAULTS        AlignmentFaults alignment-faults    SOFTWARE     EMULATION_FAULTS        EmulationFaults emulation-faults    HW_CACHE     L1D_READ                CacheReads      l1d-cache-reads l1d-cache-loads l1d-reads l1d-loads    HW_CACHE     L1D_WRITE               CacheWrites     l1d-cache-writes l1d-cache-stores l1d-writes l1d-stores    HW_CACHE     L1D_PREFETCH            CachePrefetches l1d-cache-prefetches l1d-prefetches    HW_CACHE     L1I_READ                CacheReads      l1i-cache-reads l1i-cache-loads l1i-reads l1i-loads    HW_CACHE     L1I_PREFETCH            CachePrefetches l1i-cache-prefetches l1i-prefetches    HW_CACHE     LLC_READ                CacheReads      llc-cache-reads llc-cache-loads llc-loads llc-reads    HW_CACHE     LLC_WRITE               CacheWrites     llc-cache-writes llc-cache-stores llc-writes llc-stores    HW_CACHE     LLC_PREFETCH            CachePrefetches llc-cache-prefetches llc-prefetches    HW_CACHE     L1D_READ_MISS           CacheReads      l1d-cache-read-misses l1d-cache-load-misses l1d-read-misses l1d-load-misses    HW_CACHE     L1D_WRITE_MISS          CacheWrites     l1d-cache-write-misses l1d-cache-store-misses l1d-write-misses l1d-store-misses    HW_CACHE     L1D_PREFETCH_MISS       CachePrefetches l1d-cache-prefetch-misses l1d-prefetch-misses    HW_CACHE     L1I_READ_MISS           CacheReads      l1i-cache-read-misses l1i-cache-load-misses l1i-read-misses l1i-load-misses    HW_CACHE     L1I_PREFETCH_MISS       CachePrefetches l1i-cache-prefetch-misses l1i-prefetch-misses    HW_CACHE     LLC_READ_MISS           CacheReads      llc-cache-read-misses llc-cache-load-misses llc-read-misses llc-load-misses    HW_CACHE     LLC_WRITE_MISS          CacheWrites     llc-cache-write-misses llc-cache-store-misses llc-write-misses llc-store-misses    HW_CACHE     LLC_PREFETCH_MISS       CachePrefetches llc-cache-prefetch-misses llc-prefetch-misses    HW_CACHE     BRANCH_READ             BranchInstructions branch-reads branch-loads branch-predicts    HW_CACHE     BRANCH_READ_MISS        BranchMisses    branch-mispredicts branch-read-misses branch-load-misses     Use the following Perl script to re-generate the list === cut perl === #!/usr/bin/env perl # Load all entries into %map while (<STDIN>) {     m/^\s*(.*)\s*$/;     @_ = split /\s+/, $1;     $type = shift @_;     $id = ($type eq "HARDWARE" ? "PERF_COUNT_HW_" :        $type eq "SOFTWARE" ? "PERF_COUNT_SW_" :        $type eq "HW_CACHE" ? "CACHE_" : "") . shift @_;     $unit = shift @_;      for $string (@_) {     die "$string was already seen!" if defined($map{$string});     $map{$string} = [-1, $type, $id, $unit];     push @strings, $string;     } }  # sort the map and print the string list @strings = sort @strings; print "static const char eventlist_strings[] = \n"; $counter = 0; for $entry (@strings) {     print "    \"$entry\\0\"\n";     $map{$entry}[0] = $counter;     $counter += 1 + length $entry; }  # print the table print "    \"\\0\";\n\nstatic const Events eventlist[] = {\n"; for $entry (sort @strings) {     printf "    { %3d, PERF_TYPE_%s, %s, QTest::%s },\n",         $map{$entry}[0],     $map{$entry}[1],         $map{$entry}[2],         $map{$entry}[3]; } print "    {   0, PERF_TYPE_MAX, 0, QTest::Events }\n};\n"; === cut perl === */
end_comment
begin_struct
DECL|struct|Events
struct|struct
name|Events
block|{
DECL|member|offset
name|unsigned
name|offset
decl_stmt|;
DECL|member|type
name|quint32
name|type
decl_stmt|;
DECL|member|event_id
name|quint64
name|event_id
decl_stmt|;
DECL|member|metric
name|QTest
operator|::
name|QBenchmarkMetric
name|metric
decl_stmt|;
block|}
struct|;
end_struct
begin_comment
comment|/* -- BEGIN GENERATED CODE -- */
end_comment
begin_decl_stmt
DECL|variable|eventlist_strings
specifier|static
specifier|const
name|char
name|eventlist_strings
index|[]
init|=
literal|"alignment-faults\0"
literal|"branch-instructions\0"
literal|"branch-load-misses\0"
literal|"branch-loads\0"
literal|"branch-mispredicts\0"
literal|"branch-misses\0"
literal|"branch-predicts\0"
literal|"branch-read-misses\0"
literal|"branch-reads\0"
literal|"branches\0"
literal|"bus-cycles\0"
literal|"cache-misses\0"
literal|"cache-references\0"
literal|"context-switches\0"
literal|"cpu-clock\0"
literal|"cpu-cycles\0"
literal|"cpu-migrations\0"
literal|"cs\0"
literal|"cycles\0"
literal|"emulation-faults\0"
literal|"faults\0"
literal|"idle-cycles-backend\0"
literal|"idle-cycles-frontend\0"
literal|"instructions\0"
literal|"l1d-cache-load-misses\0"
literal|"l1d-cache-loads\0"
literal|"l1d-cache-prefetch-misses\0"
literal|"l1d-cache-prefetches\0"
literal|"l1d-cache-read-misses\0"
literal|"l1d-cache-reads\0"
literal|"l1d-cache-store-misses\0"
literal|"l1d-cache-stores\0"
literal|"l1d-cache-write-misses\0"
literal|"l1d-cache-writes\0"
literal|"l1d-load-misses\0"
literal|"l1d-loads\0"
literal|"l1d-prefetch-misses\0"
literal|"l1d-prefetches\0"
literal|"l1d-read-misses\0"
literal|"l1d-reads\0"
literal|"l1d-store-misses\0"
literal|"l1d-stores\0"
literal|"l1d-write-misses\0"
literal|"l1d-writes\0"
literal|"l1i-cache-load-misses\0"
literal|"l1i-cache-loads\0"
literal|"l1i-cache-prefetch-misses\0"
literal|"l1i-cache-prefetches\0"
literal|"l1i-cache-read-misses\0"
literal|"l1i-cache-reads\0"
literal|"l1i-load-misses\0"
literal|"l1i-loads\0"
literal|"l1i-prefetch-misses\0"
literal|"l1i-prefetches\0"
literal|"l1i-read-misses\0"
literal|"l1i-reads\0"
literal|"llc-cache-load-misses\0"
literal|"llc-cache-loads\0"
literal|"llc-cache-prefetch-misses\0"
literal|"llc-cache-prefetches\0"
literal|"llc-cache-read-misses\0"
literal|"llc-cache-reads\0"
literal|"llc-cache-store-misses\0"
literal|"llc-cache-stores\0"
literal|"llc-cache-write-misses\0"
literal|"llc-cache-writes\0"
literal|"llc-load-misses\0"
literal|"llc-loads\0"
literal|"llc-prefetch-misses\0"
literal|"llc-prefetches\0"
literal|"llc-read-misses\0"
literal|"llc-reads\0"
literal|"llc-store-misses\0"
literal|"llc-stores\0"
literal|"llc-write-misses\0"
literal|"llc-writes\0"
literal|"major-faults\0"
literal|"migrations\0"
literal|"minor-faults\0"
literal|"page-faults\0"
literal|"stalled-cycles-backend\0"
literal|"stalled-cycles-frontend\0"
literal|"task-clock\0"
literal|"\0"
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|eventlist
specifier|static
specifier|const
name|Events
name|eventlist
index|[]
init|=
block|{
block|{
literal|0
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_ALIGNMENT_FAULTS
block|,
name|QTest
operator|::
name|AlignmentFaults
block|}
block|,
block|{
literal|17
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_BRANCH_INSTRUCTIONS
block|,
name|QTest
operator|::
name|BranchInstructions
block|}
block|,
block|{
literal|37
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_BRANCH_READ_MISS
block|,
name|QTest
operator|::
name|BranchMisses
block|}
block|,
block|{
literal|56
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_BRANCH_READ
block|,
name|QTest
operator|::
name|BranchInstructions
block|}
block|,
block|{
literal|69
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_BRANCH_READ_MISS
block|,
name|QTest
operator|::
name|BranchMisses
block|}
block|,
block|{
literal|88
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_BRANCH_MISSES
block|,
name|QTest
operator|::
name|BranchMisses
block|}
block|,
block|{
literal|102
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_BRANCH_READ
block|,
name|QTest
operator|::
name|BranchInstructions
block|}
block|,
block|{
literal|118
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_BRANCH_READ_MISS
block|,
name|QTest
operator|::
name|BranchMisses
block|}
block|,
block|{
literal|137
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_BRANCH_READ
block|,
name|QTest
operator|::
name|BranchInstructions
block|}
block|,
block|{
literal|150
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_BRANCH_INSTRUCTIONS
block|,
name|QTest
operator|::
name|BranchInstructions
block|}
block|,
block|{
literal|159
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_BUS_CYCLES
block|,
name|QTest
operator|::
name|BusCycles
block|}
block|,
block|{
literal|170
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_CACHE_MISSES
block|,
name|QTest
operator|::
name|CacheMisses
block|}
block|,
block|{
literal|183
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_CACHE_REFERENCES
block|,
name|QTest
operator|::
name|CacheReferences
block|}
block|,
block|{
literal|200
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_CONTEXT_SWITCHES
block|,
name|QTest
operator|::
name|ContextSwitches
block|}
block|,
block|{
literal|217
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_CPU_CLOCK
block|,
name|QTest
operator|::
name|WalltimeMilliseconds
block|}
block|,
block|{
literal|227
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_CPU_CYCLES
block|,
name|QTest
operator|::
name|CPUCycles
block|}
block|,
block|{
literal|238
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_CPU_MIGRATIONS
block|,
name|QTest
operator|::
name|CPUMigrations
block|}
block|,
block|{
literal|253
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_CONTEXT_SWITCHES
block|,
name|QTest
operator|::
name|ContextSwitches
block|}
block|,
block|{
literal|256
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_CPU_CYCLES
block|,
name|QTest
operator|::
name|CPUCycles
block|}
block|,
block|{
literal|263
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_EMULATION_FAULTS
block|,
name|QTest
operator|::
name|EmulationFaults
block|}
block|,
block|{
literal|280
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_PAGE_FAULTS
block|,
name|QTest
operator|::
name|PageFaults
block|}
block|,
block|{
literal|287
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_STALLED_CYCLES_BACKEND
block|,
name|QTest
operator|::
name|StalledCycles
block|}
block|,
block|{
literal|307
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_STALLED_CYCLES_FRONTEND
block|,
name|QTest
operator|::
name|StalledCycles
block|}
block|,
block|{
literal|328
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_INSTRUCTIONS
block|,
name|QTest
operator|::
name|Instructions
block|}
block|,
block|{
literal|341
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|363
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|379
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_PREFETCH_MISS
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|405
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_PREFETCH
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|426
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|448
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|464
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_WRITE_MISS
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|487
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_WRITE
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|504
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_WRITE_MISS
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|527
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_WRITE
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|544
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|560
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|570
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_PREFETCH_MISS
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|590
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_PREFETCH
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|605
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|621
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|631
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_WRITE_MISS
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|648
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_WRITE
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|659
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_WRITE_MISS
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|676
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1D_WRITE
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|687
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|709
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|725
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_PREFETCH_MISS
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|751
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_PREFETCH
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|772
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|794
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|810
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|826
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|836
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_PREFETCH_MISS
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|856
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_PREFETCH
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|871
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|887
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_L1I_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|897
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|919
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|935
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_PREFETCH_MISS
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|961
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_PREFETCH
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|982
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|1004
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|1020
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_WRITE_MISS
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|1043
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_WRITE
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|1060
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_WRITE_MISS
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|1083
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_WRITE
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|1100
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|1116
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|1126
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_PREFETCH_MISS
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|1146
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_PREFETCH
block|,
name|QTest
operator|::
name|CachePrefetches
block|}
block|,
block|{
literal|1161
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_READ_MISS
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|1177
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_READ
block|,
name|QTest
operator|::
name|CacheReads
block|}
block|,
block|{
literal|1187
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_WRITE_MISS
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|1204
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_WRITE
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|1215
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_WRITE_MISS
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|1232
block|,
name|PERF_TYPE_HW_CACHE
block|,
name|CACHE_LLC_WRITE
block|,
name|QTest
operator|::
name|CacheWrites
block|}
block|,
block|{
literal|1243
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_PAGE_FAULTS_MAJ
block|,
name|QTest
operator|::
name|MajorPageFaults
block|}
block|,
block|{
literal|1256
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_CPU_MIGRATIONS
block|,
name|QTest
operator|::
name|CPUMigrations
block|}
block|,
block|{
literal|1267
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_PAGE_FAULTS_MIN
block|,
name|QTest
operator|::
name|MinorPageFaults
block|}
block|,
block|{
literal|1280
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_PAGE_FAULTS
block|,
name|QTest
operator|::
name|PageFaults
block|}
block|,
block|{
literal|1292
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_STALLED_CYCLES_BACKEND
block|,
name|QTest
operator|::
name|StalledCycles
block|}
block|,
block|{
literal|1315
block|,
name|PERF_TYPE_HARDWARE
block|,
name|PERF_COUNT_HW_STALLED_CYCLES_FRONTEND
block|,
name|QTest
operator|::
name|StalledCycles
block|}
block|,
block|{
literal|1339
block|,
name|PERF_TYPE_SOFTWARE
block|,
name|PERF_COUNT_SW_TASK_CLOCK
block|,
name|QTest
operator|::
name|WalltimeMilliseconds
block|}
block|,
block|{
literal|0
block|,
name|PERF_TYPE_MAX
block|,
literal|0
block|,
name|QTest
operator|::
name|Events
block|}
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/* -- END GENERATED CODE -- */
end_comment
begin_function
DECL|function|metricForEvent
name|QTest
operator|::
name|QBenchmarkMetric
name|QBenchmarkPerfEventsMeasurer
operator|::
name|metricForEvent
parameter_list|(
name|quint32
name|type
parameter_list|,
name|quint64
name|event_id
parameter_list|)
block|{
specifier|const
name|Events
modifier|*
name|ptr
init|=
name|eventlist
decl_stmt|;
for|for
control|(
init|;
name|ptr
operator|->
name|type
operator|!=
name|PERF_TYPE_MAX
condition|;
operator|++
name|ptr
control|)
block|{
if|if
condition|(
name|ptr
operator|->
name|type
operator|==
name|type
operator|&&
name|ptr
operator|->
name|event_id
operator|==
name|event_id
condition|)
return|return
name|ptr
operator|->
name|metric
return|;
block|}
return|return
name|QTest
operator|::
name|Events
return|;
block|}
end_function
begin_function
DECL|function|setCounter
name|void
name|QBenchmarkPerfEventsMeasurer
operator|::
name|setCounter
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|initPerf
argument_list|()
expr_stmt|;
specifier|const
name|char
modifier|*
name|colon
init|=
name|strchr
argument_list|(
name|name
argument_list|,
literal|':'
argument_list|)
decl_stmt|;
name|int
name|n
init|=
name|colon
condition|?
name|colon
operator|-
name|name
else|:
name|strlen
argument_list|(
name|name
argument_list|)
decl_stmt|;
specifier|const
name|Events
modifier|*
name|ptr
init|=
name|eventlist
decl_stmt|;
for|for
control|(
init|;
name|ptr
operator|->
name|type
operator|!=
name|PERF_TYPE_MAX
condition|;
operator|++
name|ptr
control|)
block|{
name|int
name|c
init|=
name|strncmp
argument_list|(
name|name
argument_list|,
name|eventlist_strings
operator|+
name|ptr
operator|->
name|offset
argument_list|,
name|n
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|c
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Performance counter type '%s' is unknown\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|attr
operator|.
name|type
operator|=
name|ptr
operator|->
name|type
expr_stmt|;
name|attr
operator|.
name|config
operator|=
name|ptr
operator|->
name|event_id
expr_stmt|;
comment|// now parse the attributes
if|if
condition|(
operator|!
name|colon
condition|)
return|return;
while|while
condition|(
operator|*
operator|++
name|colon
condition|)
block|{
switch|switch
condition|(
operator|*
name|colon
condition|)
block|{
case|case
literal|'u'
case|:
name|attr
operator|.
name|exclude_user
operator|=
literal|true
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|attr
operator|.
name|exclude_kernel
operator|=
literal|true
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|attr
operator|.
name|exclude_hv
operator|=
literal|true
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
name|attr
operator|.
name|exclude_guest
operator|=
literal|true
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|attr
operator|.
name|exclude_host
operator|=
literal|true
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Unknown attribute '%c'\n"
argument_list|,
operator|*
name|colon
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function
begin_function
DECL|function|listCounters
name|void
name|QBenchmarkPerfEventsMeasurer
operator|::
name|listCounters
parameter_list|()
block|{
if|if
condition|(
operator|!
name|isAvailable
argument_list|()
condition|)
block|{
name|printf
argument_list|(
literal|"Performance counters are not available on this system\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"The following performance counters are available:\n"
argument_list|)
expr_stmt|;
specifier|const
name|Events
modifier|*
name|ptr
init|=
name|eventlist
decl_stmt|;
for|for
control|(
init|;
name|ptr
operator|->
name|type
operator|!=
name|PERF_TYPE_MAX
condition|;
operator|++
name|ptr
control|)
block|{
name|printf
argument_list|(
literal|"  %-30s [%s]\n"
argument_list|,
name|eventlist_strings
operator|+
name|ptr
operator|->
name|offset
argument_list|,
name|ptr
operator|->
name|type
operator|==
name|PERF_TYPE_HARDWARE
condition|?
literal|"hardware"
else|:
name|ptr
operator|->
name|type
operator|==
name|PERF_TYPE_SOFTWARE
condition|?
literal|"software"
else|:
name|ptr
operator|->
name|type
operator|==
name|PERF_TYPE_HW_CACHE
condition|?
literal|"cache"
else|:
literal|"other"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\nAttributes can be specified by adding a colon and the following:\n"
literal|"  u - exclude measuring in the userspace\n"
literal|"  k - exclude measuring in kernel mode\n"
literal|"  h - exclude measuring in the hypervisor\n"
literal|"  G - exclude measuring when running virtualized (guest VM)\n"
literal|"  H - exclude measuring when running non-virtualized (host system)\n"
literal|"Attributes can be combined, for example: -perfcounter branch-mispredicts:kh\n"
argument_list|)
expr_stmt|;
block|}
end_function
begin_constructor
DECL|function|QBenchmarkPerfEventsMeasurer
name|QBenchmarkPerfEventsMeasurer
operator|::
name|QBenchmarkPerfEventsMeasurer
parameter_list|()
member_init_list|:
name|fd
argument_list|(
operator|-
literal|1
argument_list|)
block|{ }
end_constructor
begin_destructor
DECL|function|~QBenchmarkPerfEventsMeasurer
name|QBenchmarkPerfEventsMeasurer
operator|::
name|~
name|QBenchmarkPerfEventsMeasurer
parameter_list|()
block|{
name|qt_safe_close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_destructor
begin_function
DECL|function|init
name|void
name|QBenchmarkPerfEventsMeasurer
operator|::
name|init
parameter_list|()
block|{ }
end_function
begin_function
DECL|function|start
name|void
name|QBenchmarkPerfEventsMeasurer
operator|::
name|start
parameter_list|()
block|{
name|initPerf
argument_list|()
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
comment|// pid == 0 -> attach to the current process
comment|// cpu == -1 -> monitor on all CPUs
comment|// group_fd == -1 -> this is the group leader
comment|// flags == 0 -> reserved, must be zero
name|fd
operator|=
name|perf_event_open
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"QBenchmarkPerfEventsMeasurer::start: perf_event_open"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|::
name|fcntl
argument_list|(
name|fd
argument_list|,
name|F_SETFD
argument_list|,
name|FD_CLOEXEC
argument_list|)
expr_stmt|;
block|}
block|}
comment|// enable the counter
operator|::
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PERF_EVENT_IOC_RESET
argument_list|)
expr_stmt|;
operator|::
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PERF_EVENT_IOC_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|checkpoint
name|qint64
name|QBenchmarkPerfEventsMeasurer
operator|::
name|checkpoint
parameter_list|()
block|{
operator|::
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PERF_EVENT_IOC_DISABLE
argument_list|)
expr_stmt|;
name|qint64
name|value
init|=
name|readValue
argument_list|()
decl_stmt|;
operator|::
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PERF_EVENT_IOC_ENABLE
argument_list|)
expr_stmt|;
return|return
name|value
return|;
block|}
end_function
begin_function
DECL|function|stop
name|qint64
name|QBenchmarkPerfEventsMeasurer
operator|::
name|stop
parameter_list|()
block|{
comment|// disable the counter
operator|::
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PERF_EVENT_IOC_DISABLE
argument_list|)
expr_stmt|;
return|return
name|readValue
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|isMeasurementAccepted
name|bool
name|QBenchmarkPerfEventsMeasurer
operator|::
name|isMeasurementAccepted
parameter_list|(
name|qint64
parameter_list|)
block|{
return|return
literal|true
return|;
block|}
end_function
begin_function
DECL|function|adjustIterationCount
name|int
name|QBenchmarkPerfEventsMeasurer
operator|::
name|adjustIterationCount
parameter_list|(
name|int
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|adjustMedianCount
name|int
name|QBenchmarkPerfEventsMeasurer
operator|::
name|adjustMedianCount
parameter_list|(
name|int
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|metricType
name|QTest
operator|::
name|QBenchmarkMetric
name|QBenchmarkPerfEventsMeasurer
operator|::
name|metricType
parameter_list|()
block|{
return|return
name|metricForEvent
argument_list|(
name|attr
operator|.
name|type
argument_list|,
name|attr
operator|.
name|config
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|rawReadValue
specifier|static
name|quint64
name|rawReadValue
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
comment|/* from the kernel docs:      * struct read_format {      *  { u64           value;      *    { u64         time_enabled; }&& PERF_FORMAT_TOTAL_TIME_ENABLED      *    { u64         time_running; }&& PERF_FORMAT_TOTAL_TIME_RUNNING      *    { u64         id;           }&& PERF_FORMAT_ID      *  }&& !PERF_FORMAT_GROUP      */
struct|struct
name|read_format
block|{
name|quint64
name|value
decl_stmt|;
name|quint64
name|time_enabled
decl_stmt|;
name|quint64
name|time_running
decl_stmt|;
block|}
name|results
struct|;
name|size_t
name|nread
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|nread
operator|<
sizeof|sizeof
name|results
condition|)
block|{
name|char
modifier|*
name|ptr
init|=
cast|reinterpret_cast
argument_list|<
name|char
operator|*
argument_list|>
argument_list|(
operator|&
name|results
argument_list|)
decl_stmt|;
name|qint64
name|r
init|=
name|qt_safe_read
argument_list|(
name|fd
argument_list|,
name|ptr
operator|+
name|nread
argument_list|,
sizeof|sizeof
name|results
operator|-
name|nread
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"QBenchmarkPerfEventsMeasurer::readValue: reading the results"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|nread
operator|+=
name|quint64
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|results
operator|.
name|time_running
operator|==
name|results
operator|.
name|time_enabled
condition|)
return|return
name|results
operator|.
name|value
return|;
comment|// scale the results, though this shouldn't happen!
return|return
name|results
operator|.
name|value
operator|*
operator|(
name|double
argument_list|(
name|results
operator|.
name|time_running
argument_list|)
operator|/
name|double
argument_list|(
name|results
operator|.
name|time_enabled
argument_list|)
operator|)
return|;
block|}
end_function
begin_function
DECL|function|readValue
name|qint64
name|QBenchmarkPerfEventsMeasurer
operator|::
name|readValue
parameter_list|()
block|{
name|quint64
name|raw
init|=
name|rawReadValue
argument_list|(
name|fd
argument_list|)
decl_stmt|;
if|if
condition|(
name|metricType
argument_list|()
operator|==
name|QTest
operator|::
name|WalltimeMilliseconds
condition|)
block|{
comment|// perf returns nanoseconds
return|return
name|raw
operator|/
literal|1000000
return|;
block|}
return|return
name|raw
return|;
block|}
end_function
begin_macro
name|QT_END_NAMESPACE
end_macro
begin_endif
endif|#
directive|endif
end_endif
end_unit
